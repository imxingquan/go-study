var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=n===null?Object.create(n):(r.prototype=n.prototype,new r)}}(),M3D;(function(e){var t=function(){function t(){this.renderContext=null}return t.prototype.Apply=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];this.OnExecute(e[0])},t.prototype.IsFinish=function(){return this.bKeepingFinished},t.prototype.SetFinish=function(e){this.bKeepingFinished=e},t.prototype.OnExecute=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];t[0]instanceof e.SceneNode||t[0]instanceof e.Model},t.prototype.GetRenderContext=function(){return this.renderContext},t.prototype.SetRenderContext=function(e){this.renderContext=e},t}();e.Action=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){this.compareName=null}return e.prototype.onExecute=function(e){e!==null,this.compareName!==null},e}();e.CompareByName=t;var n=function(t){function n(e){var n=t.call(this)||this;return n.result=[],n.resultModel=[],n.scene=null,n.compare=null,n.compareModel=null,n.scene=e,n}return __extends(n,t),n.prototype.SetCompare=function(e){this.compare=e},n.prototype.SetCompareModel=function(e){this.compareModel=e},n.prototype.Restart=function(){this.result=[],this.resultModel=[]},n.prototype.OnExecute=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];var r=t[0];r instanceof e.SceneNode?this.compare!==null&&this.compare(r,this)&&(this.result.push(r),this.SetFinish(!0)):r instanceof e.Model&&this.compareModel!==null&&this.compareModel(r,this)&&(this.resultModel.push(r),this.SetFinish(!0))},n}(e.Action);e.SearchAction=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.SetActionFun=function(e){this.callback=e},n.prototype.SetActionFunModel=function(e){this.callbackModel=e},n.prototype.SetActionData=function(e){this.pData=e},n.prototype.OnExecute=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];var r=t[0];r instanceof e.SceneNode?this.callback!==null&&this.callback!==undefined&&this.callback(this.pData,t[0]):r instanceof e.Model&&this.callbackModel!==null&&this.callbackModel!==undefined&&this.callbackModel(this.pData,t[0])},n}(e.Action);e.CallBackAction=t})(M3D||(M3D={}));var M3D;(function(e){function n(t,n){return t+e.EPSILON>=n&&t-e.EPSILON<=n}function r(e,t,n){return e<t?t:e>n?n:e}function i(t){return e.RADTODEG*Math.acos(r(t,-1,1))}function s(e,t){return e<t?e:t}function o(e,t){return e>t?e:t}function u(e){return e>=0?e:-e}function a(t){return Math.tan(t*e.DEGTORAD)}function f(t){return e.RADTODEG*Math.asin(r(t,-1,1))}function l(t,n){return e.RADTODEG*Math.atan2(t,n)}function c(t){return Math.sin(t*e.DEGTORAD)}function h(t){return Math.cos(t*e.DEGTORAD)}var t;(function(e){e[e.OUTSIDE=0]="OUTSIDE",e[e.INTERSECTS=1]="INTERSECTS",e[e.INSIDE=2]="INSIDE"})(t=e.Intersection||(e.Intersection={})),e.INT_MAX=2147483647,e.PI=3.141592653589793,e.EPSILON=1e-6,e.DEGTORAD=e.PI/180,e.RADTODEG=1/e.DEGTORAD,e.DEGTORAD_2=e.PI/360,e.MIN_NEARCLIP=.01,e.MAX_FOV=160,e.CONVERSION_BUFFER_LENGTH=256,e.MATRIX_CONVERSION_BUFFER_LENGTH=256,e.HALF_PI=e.PI*.5,e.MIN_INT=2147483648,e.MAX_INT=2147483647,e.MIN_UNSIGNED=0,e.MAX_UNSIGNED=4294967295,e.LARGE_EPSILON=5e-5,e.LARGE_VALUE=1e8,e.INFINITY=e.LARGE_VALUE,e.HPOINT_EPSILON=1e-5,e.Equals=n,e.Clamp=r,e.Acos=i,e.Min=s,e.Max=o,e.Abs=u,e.Tan=a,e.Asin=f,e.Atan2=l,e.Sin=c,e.Cos=h})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){this.cameraRay=new e.Ray,this.modelRay=new e.Ray,this.modelMatrix=new e.Matrix3x4,this.intersectPnts=[],this.framePickFrustum=new e.Frustum}return t.prototype.GetCameraRay=function(){return this.cameraRay},t.prototype.GetModelRay=function(){return this.modelRay},t.prototype.SetModelMatrix=function(e){this.modelMatrix=e},t.prototype.GetFramePickFrustum=function(){return this.framePickFrustum},t}();e.RayPickActionData=t;var n=function(){function t(){this.currentShapeType=-1,this.currentGeoType=-1,this.currentColorType=-1,this.pickShapeTyeArray=[],this.pickGeoTyeArray=[];for(var e=0;e<t.PICKTYPENUM;e++)this.pickGeoTyeArray.push(!1);for(var e=0;e<t.PICKTYPENUM;e++)this.pickShapeTyeArray.push(!1)}return t.prototype.GetPickShapeType=function(){return this.currentShapeType},t.prototype.GetPickGeoType=function(){return this.currentGeoType},t.prototype.SetPickShapeType=function(n){if(n===this.currentShapeType)return;this.pickShapeTyeArray.length=0;for(var r=0;r<t.PICKTYPENUM;r++)this.pickShapeTyeArray.push(!1);this.pickGeoTyeArray.length=0;for(var r=0;r<t.PICKTYPENUM;r++)this.pickGeoTyeArray.push(!0);n===e.ShapeType.SHAPE_MODEL?(this.pickShapeTyeArray[e.ShapeType.SHAPE_MODEL]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_BODY]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_FACE]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_TRIMESH]=!0):n===e.ShapeType.SHAPE_BODY?(this.pickShapeTyeArray[e.ShapeType.SHAPE_MODEL]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_BODY]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_FACE]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_TRIMESH]=!0):n===e.ShapeType.SHAPE_FACE?(this.pickShapeTyeArray[e.ShapeType.SHAPE_MODEL]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_BODY]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_FACE]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_TRIMESH]=!0):n===e.ShapeType.SHAPE_EDGE?(this.pickShapeTyeArray[e.ShapeType.SHAPE_MODEL]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_BODY]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_FACE]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_EDGE]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_TRIMESH]=!0):n===e.ShapeType.SHAPE_POINT?(this.pickShapeTyeArray[e.ShapeType.SHAPE_MODEL]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_BODY]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_FACE]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_EDGE]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_POINT]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_TRIMESH]=!0):n===e.ShapeType.SHAPE_HANDLE?(this.pickShapeTyeArray[e.ShapeType.SHAPE_AXIS_HANDLE]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_ROTATE_HANDLE]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_SCALE_HANDLE]=!0):n===e.ShapeType.SHAPE_MEASURE_BASE?(this.pickShapeTyeArray[e.ShapeType.SHAPE_MEASURE_BASE]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_MEASURE_DISTANCE]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_MEASURE_ANGLE]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_MEASURE_PROPERTY]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_TEXT_NOTE]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_VOICE_NOTE]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE]=!0):this.pickShapeTyeArray[n]=!0,this.currentShapeType=n},t.prototype.SetPickGeoType=function(n){if(n===this.currentGeoType)return;this.pickGeoTyeArray.length=0;for(var r=0;r<t.PICKTYPENUM;r++)this.pickGeoTyeArray.push(!1);if(n===e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE)this.pickShapeTyeArray[e.ShapeType.SHAPE_MODEL]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_BODY]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_FACE]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_EDGE]=!0,this.pickGeoTyeArray[e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE]=!0;else if(n===e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE)this.pickShapeTyeArray[e.ShapeType.SHAPE_MODEL]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_BODY]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_FACE]=!0,this.pickShapeTyeArray[e.ShapeType.SHAPE_EDGE]=!0,this.pickGeoTyeArray[e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE]=!0;else{this.pickGeoTyeArray.length=0;for(var r=0;r<t.PICKTYPENUM;r++)this.pickGeoTyeArray.push(!0)}},t.prototype.CanPickShape=function(e){return this.pickShapeTyeArray[e]},t.prototype.CanPickGeo=function(e){return this.pickGeoTyeArray[e]},t.prototype.CanPickColor=function(e){return!0},t.PICKTYPENUM=600,t}();e.PickTypeFilter=n;var r=function(r){function i(e){var t=r.call(this)||this;return t.isPickAll=!1,t.framePickType=1,t.framePickShapesArrary=[],t.pickShapesMap=[],t.multiPickShapesMap=[],t.fRadius=900,t.sceneManager=null,t.state=null,t.pickTypeFilter=new n,t.camera=null,t.m_pickAsGroupIntersectPnts=[],t.SetScene(e),t.Init(),t}return __extends(i,r),i.prototype.AddIntersectPnt=function(e){this.state.intersectPnts.push(e)},i.prototype.UpdataIntersecPnts=function(e){for(var t=0;t<this.state.intersectPnts.length;t++){var n=e.Multiply(this.state.intersectPnts[t]);this.state.intersectPnts[t]=n}},i.prototype.UpdateGroupPickPnts=function(){this.m_pickAsGroupIntersectPnts=this.state.intersectPnts},i.prototype.UpdataModelRay=function(e){this.state.SetModelMatrix(e);var t=this.state.modelMatrix.Inverse();this.state.modelRay=this.state.cameraRay.Transformed(t)},i.prototype.GetNearPickShape=function(){var t=this.pickShapesMap.length,n=i.MAXVALUE,r=0,s=0;for(var o=0;o<this.pickShapesMap.length;o++){var u=this.pickShapesMap[o][0];u&&console.log("shape Type"+u.GetType()),u.GetType()===e.ShapeType.IMAGEMODEL_SHAPE?s=1:s=0;var a=this.pickShapesMap[o][1],f=a.length;for(var l=0;l<f;l++)this.PointVisiable(a[l])&&(r=this.state.cameraRay.origin.Sub(a[l]).Length()-s*1e6,r<n&&(n=r,t=o,this.SetNearestPickPoint(a[l])))}if(t!==this.pickShapesMap.length){var u=this.pickShapesMap[t][0],c=null;if(u===null)return c;var h=this.pickTypeFilter.GetPickShapeType();if(u.GetType()===e.ShapeType.SHAPE_FACE)if(h===e.ShapeType.SHAPE_FACE)c=u;else if(h===e.ShapeType.SHAPE_BODY){var p=u;c=p.GetBody()}else if(h===e.ShapeType.SHAPE_MODEL||h==e.ShapeType.IMAGEMODEL_SHAPE){var p=u;c=p.GetBody().GetModel()}else c=null;else if(u.GetType()==e.ShapeType.SHAPE_EDGE)if(h==e.ShapeType.SHAPE_EDGE)c=u;else if(h==e.ShapeType.SHAPE_FACE){var d=u;c=d.GetFace().GetBody()}else if(h==e.ShapeType.SHAPE_BODY){var d=u;c=d.GetFace().GetBody()}else if(h==e.ShapeType.SHAPE_MODEL||h==e.ShapeType.IMAGEMODEL_SHAPE){var d=u;c=d.GetFace().GetBody().GetModel()}else c=null;else c=u;return c}return null},i.prototype.GetNearPickPoint=function(t){var n=0,r=this.pickShapesMap.length,s=i.MAXVALUE,o=0,u=0;for(var a=0;a<this.pickShapesMap.length;a++){var f=this.pickShapesMap[a][1],l=f.length;for(var c=0;c<l;c++)this.PointVisiable(f[c])&&(o=this.state.cameraRay.origin.Sub(f[c]).Length(),o<s&&(s=o,r=a,u=c))}var h=new e.Vector3;return r!==this.pickShapesMap.length?(h=this.pickShapesMap[r][1][u],t.copyFrom(h),!0):!1},i.prototype.BeginPickAsGroup=function(e){this.state.intersectPnts=[],this.m_pickAsGroupIntersectPnts=[],this.m_pickAsGrroup=!0},i.prototype.EndPickAsGroup=function(e,t){this.m_pickAsGrroup=!1;if(this.m_pickAsGroupIntersectPnts.length>0){var n=[];n.push(e),n.push(this.m_pickAsGroupIntersectPnts),this.pickShapesMap.push(n)}},i.prototype.PointVisiable=function(e){var t=!0,n=this.sceneManager.GetSection(),r=n.GetPlaneList();for(var i=0,s=r;i<s.length;i++){var o=s[i],u=o.GetEquation();if(u[0]*e.x+u[1]*e.y+u[2]*e.z+u[3]<0)return t=!1,t}return t},i.prototype.SetRay=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];switch(t.length){case 1:this.SetPoint(t[0]);break;case 2:this.SetPoint(new e.Vector2(t[0],t[1]))}},i.prototype.SetPoint=function(e){var t=this.GetCamera();this.state.cameraRay=t.GetViewPort().GetScreenRay(e.x,e.y)},i.prototype.Intersect=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];switch(t.length){case 1:if(t[0]instanceof e.BoundingBox)return this.state.modelRay.HitDistance(t[0])!==e.INFINITY;if(t[0]instanceof e.Vector3){var r=this.state.modelRay.Project(t[0]),i=this.GetCamera().GetViewPort(),s=t[0].Clone();r=this.state.modelMatrix.Multiply(r),s=this.state.modelMatrix.Multiply(s);var o=i.WorldToScreenPoint(r),u=i.WorldToScreenPoint(s),a=o.Sub(u).LengthSquared();return this.fRadius>=a}break;case 3:if(t[0].Equals(t[1]))return t[2].copyFrom(t[0]),this.Intersect(t[2]);var f=new e.Ray(t[0],t[1].Sub(t[0])),l=f.ClosestPoint(this.state.modelRay);l.Sub(t[0]).DotProduct(f.direction)<0?l.copyFrom(t[0]):t[1].Sub(l).DotProduct(f.direction)<0&&l.copyFrom(t[1]);var r=this.state.modelRay.Project(l),i=this.GetCamera().GetViewPort(),s=l.Clone();r=this.state.modelMatrix.Multiply(r),s=this.state.modelMatrix.Multiply(l);var o=i.WorldToScreenPoint(r),u=i.WorldToScreenPoint(s);if(!i.rect.IsInside(u))return!1;var a=o.Sub(u).LengthSquared();return this.fRadius>=a?(t[2].copyFrom(l.Add(this.state.modelRay.direction.Multiply(-0.01))),!0):!1}},i.prototype.IsintersectRayAndTriangle=function(e,t,n,r){return i.ISintersectRayAndTriangle(e,t,n,this.state.modelRay,r)},i.ISintersectRayAndTriangle=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];if(e.length===3){var n=0,r=0,s=0,o=i.v0,u=i.v1,a=i.v2;o.copyFromXYZ(e[0][0],e[0][1],e[0][2]),u.copyFromXYZ(e[0][3],e[0][4],e[0][5]),a.copyFromXYZ(e[0][6],e[0][7],e[0][8]);var f=i.dir;f.copyFrom(e[1].direction);var l=i.E1;u.SubFill(o,l);var c=i.E2;a.SubFill(o,c);var h=i.P;f.CrossProductFill(c,h);var p=l.DotProduct(h),d=i.T;p>0?e[1].origin.SubFill(o,d):(o.SubFill(e[1].origin,d),p=-p);if(p<i.MINVALUE)return e[2].copyFrom(o.AddED(u).AddED(a).MultiplyED(1/3)),!1;n=d.DotProduct(h);if(n<0||n>p)return!1;var v=i.Q;d.CrossProductFill(l,v),r=f.DotProduct(v);if(r<0||n+r>p)return!1;s=c.DotProduct(v);var m=1/p;return s*=m,n*=m,r*=m,e[2].copyFrom(o.MultiplyED(1-n-r).AddED(u.MultiplyED(n)).AddED(a.MultiplyED(r))),!0}if(e.length===5){var n=void 0,r=void 0,s=void 0,f=i.dir;f.copyFrom(e[3].direction);var o=e[0],u=e[1],a=e[2],l=i.E1;u.SubFill(o,l);var c=i.E2;a.SubFill(o,c);var h=i.P;f.CrossProductFill(c,h);var p=l.DotProduct(h),d=i.T;p>0?e[3].origin.SubFill(e[0],d):(e[0].SubFill(e[3].origin,d),p=-p);if(p<i.MINVALUE)return e[4].copyFrom(e[0].Add(e[1]).AddED(e[2]).MultiplyED(1/3)),!1;d=i.T,n=d.DotProduct(h);if(n<0||n>p)return!1;var v=i.Q;d.CrossProductFill(l,v),r=f.DotProduct(v);if(r<0||n+r>p)return!1;s=c.DotProduct(v);var m=1/p;return s*=m,n*=m,r*=m,e[4].copyFrom(e[0].Multiply(1-n-r).AddED(e[1].Multiply(n).AddED(e[2].Multiply(r)))),!0}},i.IsRayHitBox=function(t,n){return t.HitDistance(n)!==e.INFINITY},i.RayIntersectBoxPnt=function(t,n,r){var s=[],o=n.max,u=n.min,a=[];a[0]=o.x,a[1]=o.y,a[2]=o.z,a[3]=u.x,a[4]=o.y,a[5]=o.z,a[6]=u.x,a[7]=u.y,a[8]=o.z,a[9]=o.x,a[10]=u.y,a[11]=o.z,a[12]=o.x,a[13]=u.y,a[14]=u.z,a[15]=o.x,a[16]=o.y,a[17]=u.z,a[18]=u.x,a[19]=o.y,a[20]=u.z,a[21]=u.x,a[22]=u.y,a[23]=u.z;var f=[],l=new e.Vector3;for(var c=0;c<12;c++)for(var h=0;h<3;h++){var p=e.BoundingBox.triIndex()[c][h]*3;l.x=a[p],l.y=a[p+1],l.z=a[p+2],s.push(l)}r.length=0;for(var c=0;c<s.length/3;c++){var d=new e.Vector3;i.ISintersectRayAndTriangle(s[c*3],s[c*3+1],s[c*3+2],t,d)&&r.push(d)}return r.length>0?!0:!1},i.GetScreenDis=function(e,t,n){var r=-1;if(n){var i=n.GetCamera().GetViewPort(),s=i.WorldToScreenPoint(e),o=i.WorldToScreenPoint(t);r=s.Sub(o).Length()}return r},i.PickFeaturePnt=function(e,t,n){var r=5,i=10,s=!1;return s},i.prototype.RayPick=function(e){this.state.intersectPnts.length=0,e.RayPick(this)},i.prototype.SetRadius=function(e){},i.prototype.AddShape=function(e){if(this.state.intersectPnts.length>0){var t=[],n=this.state.intersectPnts.length;for(var r=0;r<n;r++){var i=this.state.modelMatrix.Multiply(this.state.intersectPnts[r]);t.push(i)}var s=null,o=!0;o&&(s=[],s.push(e),s.push(t),this.pickShapesMap.push(s)),this.state.intersectPnts.length=0}},i.prototype.GetPickShapeType=function(){return this.pickTypeFilter.GetPickShapeType()},i.prototype.GetPickGeoType=function(){return this.pickTypeFilter.GetPickGeoType()},i.prototype.SetPickShapeType=function(e){this.pickTypeFilter.SetPickShapeType(e)},i.prototype.SetPickGeoType=function(e){this.pickTypeFilter.SetPickGeoType(e)},i.prototype.CanPickShape=function(e){return this.pickTypeFilter.CanPickShape(e)},i.prototype.CanPickGeo=function(e){return this.pickTypeFilter.CanPickGeo(e)},i.prototype.CanPickColor=function(e){return this.pickTypeFilter.CanPickColor(e)},i.prototype.SetCamera=function(e){this.camera=e},i.prototype.GetCamera=function(){return this.camera},i.prototype.GetData=function(){return this.state},i.prototype.SetPickRadius=function(e){this.fRadius=e*e},i.prototype.GetScreenDis=function(e,t){var n=this.GetCamera().GetViewPort(),r=n.WorldToScreenPoint(e),i=n.WorldToScreenPoint(t);return r.Sub(i).Length()},i.prototype.OnExecute=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];var r=t[0];r instanceof e.SceneNode?r.RayPick(this):r instanceof e.Model&&r.RayPick(this)},i.prototype.SetScene=function(e){e!==null&&(this.sceneManager=e,this.SetCamera(this.sceneManager.GetCamera()))},i.prototype.Init=function(){this.state=new t,this.fRadius=900;if(this.sceneManager){var n=this.GetCamera().GetViewPort().rect.Width(),r=this.GetCamera().GetViewPort().rect.Height(),s=e.Parameters.Instance().screenPPI;this.fRadius=s*.1*s*.1,this.fRadius>600&&(this.fRadius=600)}i.v0=new e.Vector3,i.v1=new e.Vector3,i.v2=new e.Vector3,i.u,i.v,i.t,i.dir=new e.Vector3,i.E1=new e.Vector3,i.E2=new e.Vector3,i.P=new e.Vector3,i.det=new e.Vector3,i.Q=new e.Vector3,i.T=new e.Vector3},i.prototype.SetFramePickType=function(e){this.framePickType=e},i.prototype.SetPickAll=function(e){this.isPickAll=e,this.isPickAll&&this.SetFramePickType(1)},i.prototype.IsPickAll=function(){return this.isPickAll},i.prototype.SetFramePickSection=function(t,n){this.SetPickAll(!0);var r=new e.Vector2(t.x,n.y),i=new e.Vector2(n.x,t.y),s=this.GetCamera(),o=s.GetViewPort(),u=s.GetNearClip(),a=s.GetFarClip(),f=o.ScreenToWorldPoint(i.x,i.y,u),l=o.ScreenToWorldPoint(n.x,n.y,u),c=o.ScreenToWorldPoint(r.x,r.y,u),h=o.ScreenToWorldPoint(t.x,t.y,u),p=o.ScreenToWorldPoint(i.x,i.y,a),d=o.ScreenToWorldPoint(n.x,n.y,a),v=o.ScreenToWorldPoint(r.x,r.y,a),m=o.ScreenToWorldPoint(t.x,t.y,a);this.GetData().GetFramePickFrustum().Define(f,l,c,h,p,d,v,m)},i.prototype.FramePick=function(e){e.FramePick(this)},i.prototype.FrustumIntersetWithWorldBox=function(t){var n=!1;return t.Defined()&&(this.framePickType==1?this.GetData().framePickFrustum.IsInside(t.Center())===e.INSIDE&&(n=!0):this.framePickType===2&&this.GetData().framePickFrustum.IsInsideFast(t)===e.INSIDE&&(n=!0)),n},i.prototype.AddToFramePickCollection=function(e){e&&this.framePickShapesArrary.push(e)},i.prototype.GetFramePickShapes=function(){return this.framePickShapesArrary},i.prototype.SetInterctType=function(e){this.interctType=e},i.prototype.GetInterctType=function(){return this.interctType},i.prototype.GetUseclipPlane=function(){return this.useclipPlane},i.prototype.SetUseclipPlane=function(e){this.useclipPlane=e},i.prototype.SetNearestPickPoint=function(e){this.nearShapePoint=e},i.prototype.GetNearestPickPoint=function(){return this.nearShapePoint},i.v0=null,i.v1=null,i.v2=null,i.dir=null,i.E1=null,i.E2=null,i.P=null,i.det=null,i.Q=null,i.T=null,i.MINVALUE=Number.MIN_VALUE,i.MAXVALUE=e.MAX_INT,i}(e.Action);e.RayPickAction=r})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){this.bColorMask=!1,this.bDepthMask=!0}return e.prototype.IsColorMask=function(){return this.bColorMask},e.prototype.SetColorMask=function(e){this.bColorMask=e},e.prototype.SetRenderGroupType=function(e){this.renderGroupType=e},e.prototype.GetRenderGroupType=function(){return this.renderGroupType},e}();e.RenderTech=t;var n=function(){function e(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];t.length===0?this.type=e.RGT_SOLID:t.length===1&&(this.type=t[0])}return e.prototype.RenderableType=function(e){this.type=e},e.prototype.GetType=function(){return this.type},e.RGT_EDGELINE=8,e.RGT_TRILINE=2,e.RGT_SOLID=1,e.RGT_BOX=4,e.RGT_TRANSPARENT=16,e.RGT_TRANSLATEEDGE=32,e.RGT_EDGELINEINTOP=64,e.RGT_INTOP=128,e.RGT_PMI=256,e.RGT_POINT=512,e.RGT_NOTE=1024,e.RGT_MEASURE=2048,e.RGT_HANDLER=4096,e.RGT_SOLID_TRAN=e.RGT_SOLID|e.RGT_TRANSPARENT,e.RGT_SHADOW=4608,e}();e.RenderableType=n;var r=function(){function e(){this.renderTypes=e.RENDERDATA_NORMALEFFCT}return e.prototype.Contain=function(e){return(this.renderTypes&e)===e},e.prototype.GetRenderTypes=function(){return this.renderTypes},e.prototype.SetRenderTypes=function(e){this.renderTypes=e},e.prototype.Open=function(e){var t=this.GetRenderTypes();this.SetRenderTypes(t|e)},e.prototype.Close=function(e){var t=this.GetRenderTypes();this.SetRenderTypes(t&(e&65535^65535))},e.RENDERDATA_NORMALEFFCT=n.RGT_POINT|n.RGT_SOLID|n.RGT_INTOP|n.RGT_TRANSPARENT|n.RGT_NOTE|n.RGT_MEASURE|n.RGT_HANDLER|n.RGT_EDGELINE,e.RENDERDATA_OPACITYEDGE=n.RGT_SOLID|n.RGT_INTOP|n.RGT_TRANSPARENT|n.RGT_EDGELINE,e.RENDERDATA_SECTION=n.RGT_SOLID|n.RGT_INTOP|n.RGT_TRANSPARENT,e.RENDERDATA_SOLIDEDGE=n.RGT_POINT|n.RGT_SOLID|n.RGT_INTOP|n.RGT_TRANSPARENT|n.RGT_TRILINE,e.RENDERDATA_LINE=n.RGT_POINT|n.RGT_INTOP|n.RGT_TRANSPARENT|n.RGT_TRILINE,e.RENDERDATA_TRIANDSOLID=n.RGT_POINT|n.RGT_SOLID|n.RGT_INTOP|n.RGT_TRANSPARENT|n.RGT_TRILINE,e.RENDERDATA_RENDERTRISOLIDBOX=n.RGT_POINT|n.RGT_SOLID|n.RGT_INTOP|n.RGT_TRANSPARENT|n.RGT_TRILINE|n.RGT_BOX,e}();e.RenderableTypeGroup=r;var i=function(){function e(){this.renderQueueTechs=[]}return e.prototype.GetData=function(){return this.renderQueueTechs},e.prototype.InitialOpacityLineEffect=function(){var e=new t,r=new n(n.RGT_EDGELINE);e.SetRenderGroupType(r);var i=new t,s=new n(n.RGT_TRILINE);i.SetRenderGroupType(s);var o=new t,u=new n(n.RGT_SOLID);o.SetRenderGroupType(u),o.SetColorMask(!0);var a=new t,f=new n(n.RGT_TRANSPARENT);a.SetRenderGroupType(f),o.SetColorMask(!0);var l=new t,c=new n(n.RGT_INTOP);l.SetRenderGroupType(c),o.SetColorMask(!0),this.renderQueueTechs.push(o),this.renderQueueTechs.push(a),this.renderQueueTechs.push(l),this.renderQueueTechs.push(e),this.renderQueueTechs.push(i)},e.prototype.InitialNormalEffect=function(){var e=new t,r=new n(n.RGT_SHADOW);e.SetRenderGroupType(r);var i=new t,s=new n(n.RGT_EDGELINE);i.SetRenderGroupType(s);var o=new t,u=new n(n.RGT_TRILINE);o.SetRenderGroupType(u);var a=new t,f=new n(n.RGT_SOLID);a.SetRenderGroupType(f);var l=new t,c=new n(n.RGT_TRANSPARENT);l.SetRenderGroupType(c);var h=new t,p=new n(n.RGT_INTOP);h.SetRenderGroupType(p);var d=new t,v=new n(n.RGT_EDGELINEINTOP);d.SetRenderGroupType(v);var m=new t,g=new n(n.RGT_PMI);m.SetRenderGroupType(g);var y=new t,b=new n(n.RGT_BOX);y.SetRenderGroupType(b);var w=new t,E=new n(n.RGT_NOTE);w.SetRenderGroupType(E);var S=new t,x=new n(n.RGT_MEASURE);S.SetRenderGroupType(x);var T=new t,N=new n(n.RGT_HANDLER);T.SetRenderGroupType(N);var C=new t,k=new n(n.RGT_POINT);C.SetRenderGroupType(k),this.renderQueueTechs.push(e),this.renderQueueTechs.push(i),this.renderQueueTechs.push(d),this.renderQueueTechs.push(o),this.renderQueueTechs.push(a),this.renderQueueTechs.push(m),this.renderQueueTechs.push(y),this.renderQueueTechs.push(l),this.renderQueueTechs.push(C),this.renderQueueTechs.push(h),this.renderQueueTechs.push(w),this.renderQueueTechs.push(S),this.renderQueueTechs.push(T)},e.prototype.InitialSectionEffect=function(){},e}();e.RenderQueuePriority=i;var s=function(){function e(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];this.renderQueuePriority=new i,this.renderableTypeFilter=new r,t.length===0?this.effectType=e.RENDER_NORMALEFFCT:t.length===1&&(this.effectType=t[0])}return e.prototype.GetRenderQueuePriority=function(){return this.renderQueuePriority},e.prototype.SetRenderQueuePriority=function(e){this.renderQueuePriority=e},e.prototype.GetRenderableTypeFilter=function(){return this.renderableTypeFilter},e.prototype.SetRenderableTypeFilter=function(e){this.renderableTypeFilter=e},e.RENDER_NORMALEFFCT=0,e.RENDER_OPACITYEDGE=256,e.RENDER_SECTION=512,e}();e.RenderEffect=s;var o=function(){function e(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];this.renderTech=null,this.rednerType=null,this.renderableArray=[],e.length!==0&&e.length===1&&(this.rednerType=e[0])}return e.prototype.Push=function(e){this.renderableArray.push(e)},e.prototype.Clear=function(){this.renderableArray.length=0},e.prototype.Concat=function(e){this.renderableArray=this.renderableArray.concat(e)},e.prototype.GetType=function(){return this.rednerType},e.prototype.setType=function(e){this.rednerType=e},e.prototype.GetRenderableArray=function(){return this.renderableArray},e.prototype.SetRenderableArray=function(e){this.renderableArray=e},e.prototype.SetRenderTech=function(e){this.renderTech=e},e.prototype.GetRenderTech=function(){return this.renderTech},e}();e.RenderQueue=o;var u=function(t){function r(n){var r=t.call(this)||this;r.clipPlane=new Array(5),r.enableClip=new Array(5),r.pCamera=null,r.renderMgr=null,r.glworldMatrix=new e.Matrix4,r.worldMatrix=new e.Matrix3x4,r.renderEffect=null,r.backgroundColor=null,r.axisNode=null,r.section=null,r.priTypePassGroup=new o,r.delaySolidPassGroup=new o,r.delayTranPassGroup=new o,r.renderQueueGroup=new e.Dictionary,r.draggerRenderQueueGroup=new e.Dictionary,r.workingRenderQueueGroup=new e.Dictionary,r.scene=null,r.delayOnceDrawList=new o,r.delayDrawOnceCount=0,r.selectBox=new e.BoundingBox,r._currentRenderImageQueueIndex=0,r._renderImageboards=[],r.m_delayDrawFlag=!1,r.m_delayDrawList=[],r.mergeEdgeCache=null,r.m_mergeFaceCache=null,r.InitRenderQueueGroup(r.renderQueueGroup),r.InitRenderQueueGroup(r.draggerRenderQueueGroup),r.SetWorkingRenderQueueGroup(r.renderQueueGroup),r.renderMgr=n,r.shaderManager=null,r.m_bReverseClip=!1;for(var i=0;i<5;i++)r.clipPlane[i]=new e.Vector4,r.enableClip[i]=0;return r.InitRenderEffects(),r.Reset(),r}return __extends(r,t),r.prototype.InitRenderQueueGroup=function(e){var t=null,r=null;t=new n(n.RGT_SHADOW),r=new o(t),e.add(n.RGT_SHADOW,r),t=new n(n.RGT_TRANSPARENT),r=new o(t),e.add(n.RGT_TRANSPARENT,r),t=new n(n.RGT_SOLID),r=new o(t),e.add(n.RGT_SOLID,r),t=new n(n.RGT_INTOP),r=new o(t),e.add(n.RGT_INTOP,r),t=new n(n.RGT_EDGELINE),r=new o(t),e.add(n.RGT_EDGELINE,r),t=new n(n.RGT_TRILINE),r=new o(t),e.add(n.RGT_TRILINE,r),t=new n(n.RGT_EDGELINEINTOP),r=new o(t),e.add(n.RGT_EDGELINEINTOP,r),t=new n(n.RGT_PMI),r=new o(t),e.add(n.RGT_PMI,r),t=new n(n.RGT_BOX),r=new o(t),e.add(n.RGT_BOX,r),t=new n(n.RGT_NOTE),r=new o(t),e.add(n.RGT_NOTE,r),t=new n(n.RGT_MEASURE),r=new o(t),e.add(n.RGT_MEASURE,r),t=new n(n.RGT_HANDLER),r=new o(t),e.add(n.RGT_HANDLER,r),t=new n(n.RGT_POINT),r=new o(t),e.add(n.RGT_POINT,r)},r.prototype.Reset=function(){this.priTypeCache=-1,this.minfps=15,this.fps=this.minfps,this.delayDrawFlag=!1,this.delayDrawOnceCount=0},r.prototype.Apply=function(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];e.length==1&&t.prototype.OnExecute.call(this,e[0])},r.prototype.GetRenderManager=function(){return this.renderMgr},r.prototype.Begin=function(){this.GetRenderImageBoards().length=0,this.renderQueueGroup.forEach(function(e,t){t.Clear()}),this.draggerRenderQueueGroup.forEach(function(e,t){t.Clear()}),this.SetAxisNode(null),this.SetBackGroundNode(null),this.ClearRenderBox(),this.SetHandlerGroupNode(null),this.SetWorkingRenderQueueGroup(this.renderQueueGroup),this.BeginPrepareDelayDraw()},r.prototype.Execute=function(){e.GLShapeDrawer.InitialGL(this),e.GLShapeDrawer.DrawBackGround(this.GetBackGroundNode(),this),e.GLShapeDrawer.DrawRenderPassGroup(this),this.ProcessDelayDraw(),e.GLShapeDrawer.DrawAxis(this.GetAxisNode(),this)},r.prototype.AddFaceToDrawQueue=function(e){var t=this.GetRenderEffect(),r=t.GetRenderableTypeFilter();e.SetRenderWorldMatrix(this.GetGLWorldMatrix()),r.Contain(n.RGT_SOLID)&&(this.delayDrawFlag?this.AddToDelayDraw(e):this.PrepareFaceMesh(e))},r.prototype.AddToDelayDraw=function(e){this.m_delayDrawList.push(e)},r.prototype.End=function(){this.SetSceneBoxChanged(!1)},r.prototype.UpdataRenderPara=function(e){},r.prototype.PushRenderable=function(e,t){if(this.priTypeCache===t){this.priTypePassGroup.Push(e);return}var n=this.workingRenderQueueGroup.get(t);n!==undefined&&(n.Push(e),this.priTypeCache=t,this.priTypePassGroup=n)},r.prototype.ShowRotationCenter=function(){return!0},r.prototype.GetRenderEffect=function(){return this.renderEffect},r.prototype.SetRenderEffect=function(e){this.renderEffect=e},r.prototype.SetWorldMatrix=function(e){this.worldMatrix=e},r.prototype.GetWorldMatrix=function(){return this.worldMatrix},r.prototype.SetGLWorldMatrix=function(e){this.glworldMatrix=e},r.prototype.GetGLWorldMatrix=function(){return this.glworldMatrix},r.prototype.Merge=function(e){var t=!1,n=e.GetDrawColor();return e.IsVisible()?(this.mergeEdgeCache===null||!n.Equals(this.mergeEdgeCache.GetDrawColor())?(this.mergeEdgeCache=e,this.mergeEdgeCache.SetRenderPolyLine(e)):(this.mergeEdgeCache.MergeRenderPolyLine(e),t=!0),t):(this.mergeEdgeCache=null,t=!0)},r.prototype.MergeFace=function(e){var t=!1,n=e.GetDrawColor();if(!e.IsVisible())return this.m_mergeFaceCache=null,t=!0,t;if(this.m_mergeFaceCache===null||!n.Equals(this.m_mergeFaceCache.GetRenderColor())||e.IsSelected()!==this.m_mergeFaceCache.IsSelected()||e.GetBody().GetFaces().lastIndexOf(e)<=e.GetBody().GetFaces().length-1){if(e.GetRenderMeshData()){this.m_mergeFaceCache=e;var r=e.GetRenderMeshData().GetRefMesh();r.IsDirty()&&r.UpdateHardWareBuffer(this),this.m_mergeFaceCache.SetRenderMesh(e.GetRenderMeshData())}}else this.m_mergeFaceCache.MergeRenderMesh(e.GetMesh()),t=!0;return t},r.prototype.PrepareRenderEdges=function(){var t=[];for(var r=0;r<arguments.length;r++)t[r]=arguments[r];if(t[0]instanceof e.Body)var i=t[0];else if(t[0]instanceof e.Face)var s=t[0];else if(t[0]instanceof e.Edge){var o=t[0];if(this.Merge(o))return;o.SetRenderWorldMatrix(this.GetGLWorldMatrix()),this.PushRenderable(o,n.RGT_EDGELINE)}},r.prototype.PrepareRenderFace=function(e){if(!this.ISFaceHasDrawData(e)){e.SetRenderMeshData(null);return}if(this.MergeFace(e)){e.SetRenderMeshData(null);return}},r.prototype.PrepareRenderPMIS=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(!(t[0]instanceof e.Model)&&t[0]instanceof e.Map){var r=t[0];for(var i=0,s=r.Values();i<s.length;i++){var o=s[i];o.FindVisiableObject(this)}}},r.prototype.PrepareRenderBox=function(e){e.GetWorldBoundingBox().Defined()&&this.MergeRenderBox(e.GetWorldBoundingBox())},r.prototype.PushSolidToDelayRenderQueue=function(e){this.delaySolidPassGroup.Push(e)},r.prototype.PushTranToDelayRenderQueue=function(e){this.delayTranPassGroup.Push(e)},r.prototype.ProcessOnceDelayDraw=function(t){var n=!1,r=t.GetRenderableArray();if(r.length>0){this.delayDrawOnceCount==0&&(this.delayDrawOnceCount=r.length),this.delayOnceDrawList.Clear();if(r.length>this.delayDrawOnceCount){this.delayOnceDrawList.Clear();var i=r.splice(r.length-this.delayDrawOnceCount);this.delayOnceDrawList.Concat(i)}else{this.delayOnceDrawList.Clear();var i=r.splice(0);this.delayOnceDrawList.Concat(i)}e.GLShapeDrawer.ApplyCamera(this),e.GLShapeDrawer.DrawSolidRenderPassGroup(this,this.delayOnceDrawList),n=!0}return n},r.prototype.PrepareRenderNote=function(e){this.PushRenderable(e,n.RGT_NOTE)},r.prototype.PrepareRenderImage=function(e){var t=this.currentRenderImageQueueIndex;t===0&&this._renderImageboards.push(e)},r.prototype.PreapareRenderPoint=function(e){this.PushRenderable(e,n.RGT_POINT)},r.prototype.PrepareRenderMeasure=function(e){},r.prototype.StartMergeFace=function(){this.m_mergeFaceCache=null},r.prototype.FinishMergeFace=function(){},r.prototype.StartMergeEdge=function(){this.mergeEdgeCache=null},r.prototype.FinishMergeEdge=function(){},r.prototype.GetSceneBoxChanged=function(){return this.isSceneBoxChanged},r.prototype.GetCamera=function(){return this.pCamera},r.prototype.SetCamera=function(e){this.pCamera=e},r.prototype.GetLights=function(){return null},r.prototype.AddLight=function(e){},r.prototype.Optimize=function(){var e=this.GetRenderManager().GetEventFPS();e<10?this.GetRenderManager().GetCullerHelper().AddCullerRatio(e):e>20&&this.GetRenderManager().GetCullerHelper().ReduceCullerRatio(e)},r.prototype.SetLights=function(e){},r.prototype.ClearRenderBox=function(){this.selectBox.Clear()},r.prototype.MergeRenderBox=function(e){e.Defined()&&this.selectBox.Merge(e)},r.prototype.GetRenderBox=function(){return this.selectBox},r.prototype.SetBackGroundNode=function(e){this.backgroundColor=e},r.prototype.GetBackGroundNode=function(){return this.backgroundColor},r.prototype.SetFPSNode=function(e){},r.prototype.SetAxisNode=function(e){this.axisNode=e},r.prototype.GetAxisNode=function(){return this.axisNode},r.prototype.GetCullerHelper=function(){return this.renderMgr.GetCullerHelper()},r.prototype.GetRenderQueueGroup=function(){return this.renderQueueGroup},r.prototype.SetFPS=function(e){this.fps=e},r.prototype.GetFPS=function(){return this.fps},r.prototype.SetScene=function(e){this.scene=e},r.prototype.GetScene=function(){return this.scene},r.prototype.GetShaderMananger=function(){return this.shaderManager===null?(this.shaderManager=new e.ShaderManager(this.GetRenderContext().GetGLRenderContext()),this.shaderManager.SetCurrentAction(this),this.shaderManager):
this.shaderManager},r.prototype.ClearGLResource=function(){},r.prototype.ResizeFBOs=function(e,t){},r.prototype.ClearDelayDraw=function(){this.delaySolidPassGroup.Clear(),this.delayTranPassGroup.Clear()},r.prototype.SetDelayDraw=function(e){this.delayDrawFlag=e},r.prototype.IsDelayDraw=function(){return this.delayDrawFlag},r.prototype.ProcessDelayDraw=function(){var e=!1;return e=e||this.ProcessOnceDelayDraw(this.delaySolidPassGroup),e=e||this.ProcessOnceDelayDraw(this.delayTranPassGroup),e},r.prototype.BeginPrepareDelayDraw=function(){this.delaySolidPassGroup.Clear(),this.delayTranPassGroup.Clear(),this.delayDrawOnceCount=0},r.prototype.ISFaceHasDrawData=function(e){var t=e.GetMesh();return t!==null?(e.SetRenderMeshData(t),!0):!1},r.prototype.PrepareFaceMesh=function(t){t.RecesiveShadow()&&this.PushRenderable(t,n.RGT_SHADOW);var r=!1;if(t.GetMaterial()){var i=t.GetMaterial();if(i.GetMaterialType()===e.MaterialType.MaterialType_Phong||i.GetMaterialType()===e.MaterialType.MaterialType_MatCap){var s=i;t.GetColorAlpha()<1&&(this.PushRenderable(t,n.RGT_TRANSPARENT),r=!0)}else if(i.GetMaterialType()===e.MaterialType.MaterialType_Pbr){var s=i;t.GetColorAlpha()<1&&(this.PushRenderable(t,n.RGT_TRANSPARENT),r=!0)}}else t.GetDrawColor().IsTransparent()&&(this.PushRenderable(t,n.RGT_TRANSPARENT),r=!0);r||this.PushRenderable(t,n.RGT_SOLID),!e.Parameters.Instance().IsShowBox&&t.IsHightlight()&&this.PushRenderable(t,n.RGT_INTOP)},r.prototype.PrepareFaceDelayDraw=function(e){e.GetDrawColor().IsTransparent()?this.delayTranPassGroup.Push(e):this.delaySolidPassGroup.Push(e)},r.prototype.FacePrepareLineMesh=function(e){this.PushRenderable(e,n.RGT_TRILINE)},r.prototype.FacePrepareEdgeLine=function(e){},r.prototype.PrepareRenderInTop=function(e){},r.prototype.GetSection=function(){return this.section},r.prototype.SetSection=function(e){this.section=e},r.prototype.GetWorkingRenderQueueGroup=function(){return this.workingRenderQueueGroup},r.prototype.SetWorkingRenderQueueGroup=function(e){this.priTypeCache=0,this.workingRenderQueueGroup=e},r.prototype.GetDraggerRenderQueueGroup=function(){return this.draggerRenderQueueGroup},r.prototype.SetHandlerGroupNode=function(e){this.handlerGroupNode=e},r.prototype.PrepareRenderSection=function(e){this.SetSection(e)},r.prototype.InitRenderEffects=function(){r.light=new e.Light;var t=r.light,n=new e.Color(1,1,1,1),i=new e.Color(1,1,1,1),s=new e.Color(0,0,0,1),o=new e.Vector4(0,0,10,0),u=new e.Vector3(0,0,-1),a=new e.Color(.01,.1,.01,1),f=100,l=60,c=.5,h=1,p=5e-4,d=1e-4,v=1;t.SetAmbient(n),t.SetDiffuse(i),t.SetSpecular(s),t.SetPosition(o),t.SetLightModelAmbient(a),t.SetSpecularIntensity(v),t.TurnOn()},r.prototype.SetSceneBoxChanged=function(e){this.isSceneBoxChanged=e},r.prototype.ReleaseRenderEffects=function(){},r.prototype.GetRenderImageBoards=function(){return this._renderImageboards},Object.defineProperty(r.prototype,"currentRenderImageQueueIndex",{get:function(){return this._currentRenderImageQueueIndex},set:function(e){this._currentRenderImageQueueIndex=e},enumerable:!0,configurable:!0}),r}(e.Action);e.RenderAction=u})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){}return e}();e.function_buffer=t;var n=function(e){function t(){var t=e!==null&&e.apply(this,arguments)||this;return t.callback=null,t}return __extends(t,e),t.prototype.SetActionFun=function(e){this.callback=e},t.prototype.OnExecute=function(e,t,n,r,i){e===void 0&&(e=null),t===void 0&&(t=null),n===void 0&&(n=null),r===void 0&&(r=null),i===void 0&&(i=null)},t}(e.Action);e.AniCallbackFun=n})(M3D||(M3D={}));var M3D;(function(e){e.INTERPOLATOR_PIVOT="Pivot",e.INTERPOLATOR_POS="Pos",e.INTERPOLATOR_QUATROT="QuatRot",e.INTERPOLATOR_SCALE="Scale",e.INTERPOLATOR_VISIBLE="Visible",e.INTERPOLATOR_COLOR="Color",e.INTERPOLATOR_ATTSWITCH="AttSwitch",e.INTERPOLATOR_SOUND="Sound",e.INTERPOLATOR_IMAGE="Image",e.INTERPOLATOR_NORMAL="Normal",e.TARGETOBJECTTYPE_INS="PLCID",e.TARGETOBJECTTYPE_CAM="CAMERA",e.TARGETOBJECTTYPE_PMI="PMI",e.TARGETOBJECTTYPE_CLIP="CLIP",e.TARGETOBJECTTYPE_SOUND="SOUND",e.TARGETOBJECTTYPE_IMAGE="IMAGE",e.TARGETOBJECTTYPE_FOLDER="FOLDER",e.TARGETOBJECTTYPE_ZOOM="ZOOM",e.TARGETOBJECTTYPE_GROUP="GROUPID",e.TARGETOBJECTTYPE_ARROW="ARROW",e.ANIMATION_D_TOL=.9,e.ANIMATION_D_TOL2=1e-5;var t;(function(e){e[e.HANIAxisRotation=0]="HANIAxisRotation",e[e.HANIQuatSlerpRotation=1]="HANIQuatSlerpRotation",e[e.HANIQuatSquadRotation=2]="HANIQuatSquadRotation",e[e.HANIEulerRotation=3]="HANIEulerRotation"})(t=e.HANIRotationType||(e.HANIRotationType={}));var n;(function(e){e[e.HANIChannel=0]="HANIChannel",e[e.HANIRotation=1]="HANIRotation",e[e.HANIString=2]="HANIString",e[e.HANI3String=3]="HANI3String"})(n=e.HANIKeyframeType||(e.HANIKeyframeType={}));var r;(function(e){e[e.TARGETOBJECT_TYPE_INS=0]="TARGETOBJECT_TYPE_INS",e[e.TARGETOBJECT_TYPE_CAM=1]="TARGETOBJECT_TYPE_CAM",e[e.TARGETOBJECT_TYPE_PMI=2]="TARGETOBJECT_TYPE_PMI",e[e.TARGETOBJECT_TYPE_CLIP=3]="TARGETOBJECT_TYPE_CLIP",e[e.TARGETOBJECT_TYPE_SOUND=4]="TARGETOBJECT_TYPE_SOUND",e[e.TARGETOBJECT_TYPE_IMAGE=5]="TARGETOBJECT_TYPE_IMAGE"})(r=e.TargetObjectType||(e.TargetObjectType={}))})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){}return t.GetNode=function(e,n){var r=t.AniDecPathToM3DHexPath(e),i=n.GetSceneManager();return i.GetNode(r)},t.GetModel=function(n,r){var i=null,s=t.AniDecPathToM3DHexPath(n),o=r.GetSceneManager(),u=o.GetNode(s);return u&&u instanceof e.Model&&(i=u),i},t.SetModelColor=function(e,t){t&&(e.r>=0?t.SetColor(e):t.ResetColor());return},t.SetModelColorAlpha=function(e,t){t!==null&&t.SetAlpha(e,!0)},t.SetModelTransform=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n[0]instanceof Float32Array){var i=new e.Matrix4(n[0]);i.TransposeED();var s=new e.Matrix3x4(i);t.SetModelTransform(s,n[1])}else n[0]instanceof e.Matrix3x4&&n[1]instanceof e.Model&&n[1].SetPlaceMatrix(n[0])},t.SetModelRotate=function(e,n){var r=t.GetModelNode(n);r&&r.SetRotation(e)},t.SetModelPosition=function(e,n){var r=t.GetModelNode(n);r&&r.SetPosition(e)},t.SetModelScale=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(typeof n[0]=="number"){var i=t.GetModelNode(n[1]);i&&i.SetScale(new e.Vector3(n[0],n[0],n[0]))}else if(n[0]instanceof e.Vector3){var i=t.GetModelNode(n[1]);i&&i.SetScale(n[0])}},t.SetModelVisible=function(e,t){t&&t.SetVisible(e)},t.GetModelPlcMatrix=function(e){var t=null;return e&&(t=e.GetPlaceMatrix().ToMatrix3x4()),t},t.prototype.GetCamera=function(e){return e.GetSceneManager().GetCamera()},t.SetCameraTransform=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n[0]instanceof Float32Array){var i=new e.Matrix4(n[0]);i.TransposeED();var s=new e.Matrix3x4(i);t.SetCameraTransform(s,n[1])}else if(n[0]instanceof e.Matrix3x4)n[1]!==null&&n[1].SetTransform(n[0].Translation(),n[0].Rotation());else{var o=new Float32Array(16);for(var u=0;u<4;u++)for(var a=0;a<4;a++)o[u*4+a]=n[0][u][a];t.SetCameraTransform(o,n[1])}},t.GetCameraTransform=function(e){var t=e.GetView().Clone();return t.Inverse()},t.GetCameraZoom=function(e){var t=1;return e&&(t=e.GetZoom()),t},t.AdjustCameraZoom=function(e,t,n,r,i){var s=null;t!==null&&(s=t.GetOrthoSize());var o=n/s.x,u=r/s.y,a=this.IsPC();o>u?i/=o:i/=u;if(!a){var f=e.GetSceneManager().GetRenderManager().GetWindowWidth()*2,l=e.GetSceneManager().GetRenderManager().GetWindowHeight()*2;o>u?i=i*f/s.x:i=i*l/s.y}return i<=0&&(i=1),i},t.IsPC=function(){var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=!0;for(var r=0;r<t.length;r++)if(e.indexOf(t[r])>0){n=!1;break}return n},t.prototype.GetViewSize=function(t){var n=t.GetSceneManager().GetCamera(),r=new e.Vector2;return n!==null&&(r=n.GetOrthoSize().Clone()),r},t.SetCameraRotate=function(e,t){t&&t.SetRotation(e)},t.SetCameraPosition=function(e,t){t&&t.SetPosition(e)},t.SetCameraZoom=function(e,t){t&&t.SetZoom(e)},t.GetCameraTarget=function(t){var n=t.GetSceneManager().GetCamera();if(n!==null){var r=n.GetZoom(),i=1,s=1,o=t.GetSceneManager().GetSceneBox(),u=o.Center().Clone(),a=new e.Plane(n.GetWorldDirection(),u);a.Project(n.GetWorldPosition());var f=a.Project(n.GetWorldPosition());return f}},t.GetCameraFocal=function(e){var t=1;return e&&(t=e.GetSceneManager().GetSceneBox().Length()*.8),t},t.AniDecPathToM3DHexPath=function(t){if(!t)return"";var n=t.indexOf("PATH|");n>=0&&n<t.length&&(t=t.substr(n+5));var r=t.split("\\"),i=r.length,s=[],o=!1;t.indexOf("\\")!==-1&&(o=!0,r[0]==="0"?s=[]:s=["0"]);for(var u=0;u<i;u++)s.push(r[u]);var a=s.join("|").split("|"),f=[];a[0]==="0"?f=[]:f=["0"];for(var l=0;l<a.length;l++){var c=void 0;o?c=parseInt(a[l],10).toString(16):c=a[l],f.push(c)}return e.MAINGROUP+"|PATH|"+f.join("|")},t.GetModelNode=function(t){var n=null;if(t){var r=t.GetSceneNode().GetParent();r&&r instanceof e.ModelNode&&(n=r)}return n},t.GetPlaceMatrix=function(n){if(n){var r=t.GetModelNode(n);if(r)return r.GetPlcMatrix()}return e.Matrix3x4.IDENTITY()},t.AddTrochoid=function(t,n,r){var i=new e.Model;i.SetName(n),i.AddLineData(t),i.SetFaceMaterial(r.GetSceneManager().GetResourceManager().GetOrCreateMaterial("m3d_default_material",e.MaterialType.MaterialType_Base)),r.GetSceneManager().GetHandlerGroup().AddSVLTool(i,n)},t.RemoveTrochoid=function(e,t){var n=t.GetSceneManager(),r=n.GetHandlerGroup(),i=r.GetSVLTool(e);i&&(r.RemoveSVLTool(e),i=null)},t.UniTanslationToMtxTanslation=function(t,n,r){var i=e.ArrayMaker.MakeNumArray(4,4);n.ToMatrix(i);var s=[r.x,r.y,r.z],o=[t.x,t.y,t.z];e.MatrixOperation.UniTanslationToMtxTanslation(o,i,s);var u=new e.Vector3(s[0],s[1],s[2]);return u},t}();e.AnimationHelper=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){this.CamaraMtx=e.ArrayMaker.MakeNumArray(4,4),this.ClipPos=e.ArrayMaker.MakeNumArray(3),this.pAnimationPlayCBList=new e.AnimationPlayCBList}return t.prototype.PlayEnd=function(){this.pAnimationPlayCBList&&this.pAnimationPlayCBList.InvokePlayEndCB()},t.prototype.CameraTranslation=function(e,t,n){this.CamaraMtx[3][0]=n[3][0],this.CamaraMtx[3][1]=n[3][1],this.CamaraMtx[3][2]=n[3][2]},t.prototype.CameraRotation=function(e,t,n){for(var r=0;r<3;r++)for(var i=0;i<3;i++)this.CamaraMtx[r][i]=n[r][i];this.CamaraMtx[0][3]=this.CamaraMtx[1][3]=this.CamaraMtx[2][3]=0,this.CamaraMtx[3][3]=1},t.prototype.GetCamera=function(e,t,n){},t.prototype.GetCameraTargetPnt=function(e,t){},t.prototype.GetFocalDistance=function(e,t){var n=1;if(t){var r=t.GetSceneManager().GetSceneBox();n=t.GetSceneManager().GetSceneBox().Length()*.8}return n},t.prototype.CamaraTargetPntToPosition=function(t,n,r,i,s){var o=this.GetFocalDistance(t,s),u=e.ArrayMaker.MakeNumArray(3);u[0]=-r[2][0],u[1]=-r[2][1],u[2]=-r[2][2],i[0]=n[0]-u[0]*o,i[1]=n[1]-u[1]*o,i[2]=n[2]-u[2]*o},t.prototype.CameraScale=function(t,n,r,i,s){var o=e.ArrayMaker.MakeNumArray(3);o[0]=r[3][0],o[1]=r[3][1],o[2]=r[3][2],e.MatrixOperation.MatrixInversion(this.CamaraMtx);if(i===e.HBhvCameraType.CameraTarget){var u=e.ArrayMaker.MakeNumArray(3),a=e.ArrayMaker.MakeNumArray(3);u[0]=this.CamaraMtx[3][0],u[1]=this.CamaraMtx[3][1],u[2]=this.CamaraMtx[3][2],this.CamaraTargetPntToPosition(t,u,this.CamaraMtx,a,s),this.CamaraMtx[3][0]=a[0],this.CamaraMtx[3][1]=a[1],this.CamaraMtx[3][2]=a[2]}this.SetCamera(t,o,this.CamaraMtx,s)},t.prototype.PlayCamera=function(e,t,n,r,i,s){switch(t){case 0:this.CameraTranslation(e,n,r);break;case 1:this.CameraRotation(e,n,r);break;case 2:this.CameraScale(e,n,r,i,s)}return!0},t.prototype.ModelTanslation=function(t,n,r){var i=e.ArrayMaker.MakeNumArray(4,4);for(var s=0;s<4;s++)for(var o=0;o<4;o++)i[s][o]=r[s][o];this.CalculatelTanslationMtx(t,n,i),this.SetModelPlcMtx(t,i)},t.prototype.GetModelPlcMtx=function(e,n){var r;r=t.SAPlcPathToDispPlcPath(e),this.pAnimationPlayCBList&&this.pAnimationPlayCBList.InvokeGetModelPlcMtxCB(r,n)},t.prototype.CalculatelTanslationMtx=function(t,n,r){var i=e.ArrayMaker.MakeNumArray(4,4);this.GetModelPlcMtx(t,i);var s=e.ArrayMaker.MakeNumArray(4,4);for(var o=0;o<4;o++)for(var u=0;u<4;u++)s[o][u]=i[o][u];s[3][0]=s[3][1]=s[3][2]=0;var a=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[n[0],n[1],n[2],1]],f=e.ArrayMaker.MakeNumArray(4,4);for(var o=0;o<4;o++)for(var u=0;u<4;u++)f[o][u]=a[o][u];e.MatrixOperation.MatrixInversion(f,4);var l=e.ArrayMaker.MakeNumArray(4,4),c=e.ArrayMaker.MakeNumArray(4,4);e.MatrixOperation.Multiply(f,s,l),e.MatrixOperation.Multiply(l,a,c),e.MatrixOperation.Multiply(c,r,l);for(var o=0;o<4;o++)for(var u=0;u<4;u++)r[o][u]=l[o][u]},t.prototype.CalculatelRotationMtx=function(t,n,r){var i=e.ArrayMaker.MakeNumArray(4,4);this.GetModelPlcMtx(t,i);var s=e.ArrayMaker.MakeNumArray(3);s[0]=n[0]*i[0][0]+n[1]*i[1][0]+n[2]*i[2][0]+i[3][0],s[1]=n[0]*i[0][1]+n[1]*i[1][1]+n[2]*i[2][1]+i[3][1],s[2]=n[0]*i[0][2]+n[1]*i[1][2]+n[2]*i[2][2]+i[3][2],s[0]=s[0]-n[0],s[1]=s[1]-n[1],s[2]=s[2]-n[2];var o=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[s[0],s[1],s[2],1]],u=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[n[0],n[1],n[2],1]],a=e.ArrayMaker.MakeNumArray(4,4);for(var f=0;f<4;f++)for(var l=0;l<4;l++)a[f][l]=u[f][l];e.MatrixOperation.MatrixInversion(a);var c=e.ArrayMaker.MakeNumArray(4,4),h=e.ArrayMaker.MakeNumArray(4,4);e.MatrixOperation.Multiply(a,r,c),e.MatrixOperation.Multiply(c,u,h),e.MatrixOperation.Multiply(h,o,c);for(var f=0;f<4;f++)for(var l=0;l<4;l++)r[f][l]=c[f][l]},t.prototype.SetModelPlcMtx=function(e,n){var r;r=t.SAPlcPathToDispPlcPath(e),this.pAnimationPlayCBList&&this.pAnimationPlayCBList.InvokeSetModelPlcMtxCB(r,n)},t.prototype.UpdateView=function(e){},t.prototype.PlayBegin=function(){this.pAnimationPlayCBList&&this.pAnimationPlayCBList.InvokePlayBeginCB()},t.SAPlcPathToDispPlcPath=function(e,t){t===void 0&&(t=!0);var n,r,i,s=0,o,u="";if(!e||e.length>=256)return null;r=e;var a=r.split("\\");for(var f=0;f<a.length;++f)n=a[f],s=parseInt(n),s&=16777215,u==""?i=s.toString(16):i=u+"|"+s.toString(16),u=i;return u.length>0&&u[0]=="0"?t?i="PATH"+u:i="":t?i="PATH|0|"+u:i=u,u=i,u},t.prototype.SetTargetState=function(n){for(var r=0;r<n.length;r++){var i;if(n[r].Type==e.TargetObjectType.TARGETOBJECT_TYPE_INS||n[r].Type==e.TargetObjectType.TARGETOBJECT_TYPE_PMI)i=t.SAPlcPathToDispPlcPath(n[r].InsPath),n[r].InsPath=i}this.pAnimationPlayCBList&&this.pAnimationPlayCBList.InvokeSetTargetStateCB(n)},t.prototype.ModelRotation=function(t,n,r){var i=e.ArrayMaker.MakeNumArray(4,4);for(var s=0;s<4;s++)for(var o=0;o<4;o++)i[s][o]=r[s][o];this.CalculatelRotationMtx(t,n,i),this.SetModelPlcMtx(t,i)},t.prototype.Play=function(e,t,n,r){switch(e){case 0:this.ModelTanslation(t,n,r);break;case 1:this.ModelRotation(t,n,r)}return!0},t.prototype.SetCamera=function(t,n,r,i){if(i.AnimationGetPlayCamera()){var s=i.GetSimulationMgr(),o=void 0;s!==null&&(o=s.Version);var u=n[0],a=n[1],f=n[2],l=1,c=i.GetSceneManager().GetCamera();parseFloat(o)>=1.15&&n[1]>0&&n[2]>0?l=e.AnimationHelper.AdjustCameraZoom(i,c,a,f,u):l=1/u,e.AnimationHelper.SetCameraTransform(r,c),e.AnimationHelper.SetCameraZoom(l,c)}},t.prototype.PlayVisible=function(t,n,r,i,s){if(t.indexOf("ZOOM")===-1&&t.indexOf("PMI")===-1&&n.length===0){var o=e.AnimationHelper.GetModel(t,s);o&&(e.AnimationHelper.SetModelVisible(r,o),e.AnimationHelper.SetModelColorAlpha(1-i,o))}return!0},t.prototype.PlayColor=function(t,n,r,i){var s="",o="";n!=="";var u=e.AnimationHelper.GetModel(t,i);if(u){var a=new e.Color;a.r=r.x,a.g=r.y,a.b=r.z,a.a=1,e.AnimationHelper.SetModelColor(a,u)}return!0},t}();e.AnimationPlayApi=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){this.vecUpdateViewCB=[],this.vecPlayBeginCB=[],this.vecPlayEndCB=[],this.vecGetModelPlcMtxCB=[],this.vecSetModelPlcMtxCB=[],this.vecGetCameraCB=[],this.vecSetCameraCB=[],this.vecGetCameraTargetPntCB=[],this.vecPlayVisibleCB=[],this.vecPlayColorCB=[],this.vecPlayImageCB=[],this.vecPlayClipPlaneCB=[],this.vecSetTargetStateCB=[]}return e.prototype.SetCBTran=function(e,t,n,r,i,s,o,u,a,f,l,c,h){this.AddUpdateViewCB(e),this.AddPlayBeginCB(t),this.AddPlayEndCB(n),this.AddGetModelPlcMtxCB(r),this.AddSetModelPlcMtxCB(i),this.AddGetCameraCB(s),this.AddSetCameraCB(o),this.AddGetCameraTargetPntCB(u),this.AddPlayVisibleCB(a),this.AddPlayColorCB(f),this.AddPlayImageCB(l),this.AddPlayClipPlaneCB(c),this.AddSetTargetStateCB(h)},e.prototype.AddUpdateViewCB=function(e){for(var t=0;t!=this.vecUpdateViewCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecUpdateViewCB.push(e)},e.prototype.RemoveUpdateViewCB=function(e){for(var t=0;t!=this.vecUpdateViewCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecUpdateViewCB.splice(t,1);break}},e.prototype.InvokeUpdateViewCB=function(e){for(var t=0;t<this.vecUpdateViewCB.length;t++)this.vecUpdateViewCB[t]&&this.vecUpdateViewCB[t].onExecute(e)},e.prototype.AddPlayBeginCB=function(e){for(var t=0;t!=this.vecPlayBeginCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecPlayBeginCB.push(e)},e.prototype.RemovePlayBeginCB=function(e){for(var t=0;t!=this.vecPlayBeginCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecPlayBeginCB.splice(t,1);break}},e.prototype.InvokePlayBeginCB=function(){for(var e=0;e<this.vecPlayBeginCB.length;e++)this.vecPlayBeginCB[e]&&this.vecPlayBeginCB[e].onExecute()},e.prototype.AddPlayEndCB=function(e){for(var t=0;t!=this.vecPlayEndCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecPlayEndCB.push(e)},e.prototype.RemovePlayEndCB=function(e){for(var t=0;t!=this.vecPlayEndCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecPlayEndCB.splice(t,1);break}},e.prototype.InvokePlayEndCB=function(){for(var e=0;e<this.vecPlayEndCB.length;e++)this.vecPlayEndCB[e]&&this.vecPlayEndCB[e].onExecute()},e.prototype.AddGetModelPlcMtxCB=function(e){for(var t=0;t!=this.vecGetModelPlcMtxCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecGetModelPlcMtxCB.push(e)},e.prototype.RemoveGetModelPlcMtxCB=function(e){for(var t=0;t!=this.vecGetModelPlcMtxCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecGetModelPlcMtxCB.splice(t,1);break}},e.prototype.InvokeGetModelPlcMtxCB=function(e,t){for(var n=0;n<this.vecGetModelPlcMtxCB.length;n++)this.vecGetModelPlcMtxCB[n]&&this.vecGetModelPlcMtxCB[n].onExecute(e,t)},e.prototype.AddSetModelPlcMtxCB=function(e){for(var t=0;t!=this.vecSetModelPlcMtxCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecSetModelPlcMtxCB.push(e)},e.prototype.RemoveSetModelPlcMtxCB=function(e){for(var t=0;t!=this.vecSetModelPlcMtxCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecSetModelPlcMtxCB.splice(t,1);break}},e.prototype.InvokeSetModelPlcMtxCB=function(e,t){for(var n=0;n<this.vecSetModelPlcMtxCB.length;n++)this.vecSetModelPlcMtxCB[n]&&this.vecSetModelPlcMtxCB[n].onExecute(e,t)},e.prototype.AddGetCameraCB=function(e){for(var t=0;t!=this.vecGetCameraCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecGetCameraCB.push(e)},e.prototype.RemoveGetCameraCB=function(e){for(var t=0;t!=this.vecGetCameraCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecGetCameraCB.splice(t,1);break}},e.prototype.InvokeGetCameraCB=function(e,t,n){for(var r=0;r<this.vecGetCameraCB.length;r++)this.vecGetCameraCB[r]&&this.vecGetCameraCB[r].onExecute(e,t,n)},e.prototype.AddSetCameraCB=function(e){for(var t=0;t!=this.vecSetCameraCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecSetCameraCB.push(e)},e.prototype.RemoveSetCameraCB=function(e){for(var t=0;t!=this.vecSetCameraCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecSetCameraCB.splice(t,1);break}},e.prototype.InvokeSetCameraCB=function(e,t,n){for(var r=0;r<this.vecSetCameraCB.length;r++)this.vecSetCameraCB[r]&&this.vecSetCameraCB[r].onExecute(e,t,n)},e.prototype.AddGetCameraTargetPntCB=function(e){for(var t=0;t!=this.vecGetCameraTargetPntCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecGetCameraTargetPntCB.push(e)},e.prototype.RemoveGetCameraTargetPntCB=function(e){for(var t=0;t!=this.vecGetCameraTargetPntCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecGetCameraTargetPntCB.splice(t,1);break}},e.prototype.InvokeGetCameraTargetPntCB=function(e,t){for(var n=0;n<this.vecGetCameraTargetPntCB.length;n++)this.vecGetCameraTargetPntCB[n]&&this.vecGetCameraTargetPntCB[n].onExecute(e,t)},e.prototype.AddPlayVisibleCB=function(e){for(var t=0;t!=this.vecPlayVisibleCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecPlayVisibleCB.push(e)},e.prototype.RemovePlayVisibleCB=function(e){for(var t=0;t!=this.vecPlayVisibleCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecPlayVisibleCB.splice(t,1);break}},e.prototype.InvokePlayVisibleCB=function(e,t,n,r){for(var i=0;i<this.vecPlayVisibleCB.length;i++)this.vecPlayVisibleCB[i]&&this.vecPlayVisibleCB[i].onExecute(e,t,n,r)},e.prototype.AddPlayColorCB=function(e){for(var t=0;t!=this.vecPlayColorCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecPlayColorCB.push(e)},e.prototype.RemovePlayColorCB=function(e){for(var t=0;t!=this.vecPlayColorCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecPlayColorCB.splice(t,1);break}},e.prototype.InvokePlayColorCB=function(e,t,n){for(var r=0;r<this.vecPlayColorCB.length;r++)this.vecPlayColorCB[r]&&this.vecPlayColorCB[r].onExecute(e,t,n)},e.prototype.AddPlayImageCB=function(e){for(var t=0;t!=this.vecPlayImageCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecPlayImageCB.push(e)},e.prototype.RemovePlayImageCB=function(e){for(var t=0;t!=this.vecPlayImageCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecPlayImageCB.splice(t,1);break}},e.prototype.InvokePlayImageCB=function(e,t,n,r,i){for(var s=0;s<this.vecPlayImageCB.length;s++)this.vecPlayImageCB[s]&&this.vecPlayImageCB[s].onExecute(e,t,n,r,i)},e.prototype.AddPlayClipPlaneCB=function(e){for(var t=0;t!=this.vecPlayClipPlaneCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecPlayClipPlaneCB.push(e)},e.prototype.RemovePlayClipPlaneCB=function(e){for(var t=0;t!=this.vecPlayClipPlaneCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecPlayClipPlaneCB.splice(t,1);break}},e.prototype.InvokePlayClipPlaneCB=function(e,t,n,r,i){for(var s=0;s<this.vecPlayClipPlaneCB.length;s++)this.vecPlayClipPlaneCB[s]&&this.vecPlayClipPlaneCB[s].onExecute(e,t,n,r,i)},e.prototype.AddSetTargetStateCB=function(e){for(var t=0;t!=this.vecSetTargetStateCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr)return;this.vecSetTargetStateCB.push(e)},e.prototype.RemoveSetTargetStateCB=function(e){for(var t=0;t!=this.vecSetTargetStateCB.length;++t)if(this.vecUpdateViewCB[t].functor.obj_ptr==e.functor.obj_ptr){this.vecSetTargetStateCB.splice(t,1);break}},e.prototype.InvokeSetTargetStateCB=function(e){for(var t=0;t<this.vecSetTargetStateCB.length;t++)this.vecSetTargetStateCB[t]&&this.vecSetTargetStateCB[t].onExecute(e)},e}();e.AnimationPlayCBList=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){}return e}();e.AnimationPlayFun=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.onExecute=function(e,t,n,r,i){e===void 0&&(e=null),t===void 0&&(t=null),n===void 0&&(n=null),r===void 0&&(r=null),i===void 0&&(i=null)},t}(e.AniCallbackFun);e.UpdateViewCB=t;var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.onExecute=function(t,n,r,i,s){t===void 0&&(t=null),n===void 0&&(n=null),r===void 0&&(r=null),i===void 0&&(i=null),s===void 0&&(s=null),e.Parameters.Instance().isShowAniTrochoid&&this.ShowAniTrochoid()},n.prototype.ShowAniTrochoid=function(){var t=e.SimulationAnimationManager.Instance(),n=t.view;if(!n)return;var r=t.GetCurrentSA();if(r==null)return;var i=n.GetSceneManager();if(i==null)return;var s=i.GetHandlerGroup();if(s==null)return;var o="AnimationTrochoid",u=s.GetSVLTool(o);u&&(s.RemoveSVLTool(o),u=null),u=new e.Model,u.SetName(o),u.SetFaceMaterial(i.GetResourceManager().GetOrCreateMaterial("m3d_default_material",e.MaterialType.MaterialType_Base));var a=r.AnimationList;for(var f=0,l=a;f<l.length;f++){var c=l[f],h=c.GetName(),p="位置";if(h===p){var d=[],v=[];this.GetLineVertexAndIndex(c,d,v),d.length>0&&u.AddLineData(d),d.splice(0,d.length),v.splice(0,v.length)}}s.AddSVLTool(u,o)},n.prototype.GetModelBoundingBoxCenter=function(t){var n=new e.BoundingBox;if(t){var r=t.GetModelShape();if(r){var i=r.GetBodys();for(var s=0;s<i.length;s++){var o=i[s].GetFaces();for(var u=0;u<o.length;u++){var a=o[u],f=new e.BoundingBox,l=a.GetMesh();l!=null&&l.GetBoundingBox().Defined()&&f.copyFrom(l.GetBoundingBox()),n.Merge(f)}}}return n.Center().Clone()}return e.BoundingBox.NO_BOX().Center().Clone()},n.prototype.GetLineVertexAndIndex=function(t,n,r){var i=t.GetTimeline(),s=[],o=i.GetTimelineArrayLength();o>0&&(s=i.GetTimelineArray());var u=e.SimulationAnimationManager.Instance();if(!u)return;var a=t.GetTarget();if(!a||a.GetType()!=="PLCID")return;var f=a.GetResolvedPath(),l=new e.Vector3(0,0,0),c=e.AnimationPlayApi.SAPlcPathToDispPlcPath(f),h=u.view.GetModelBySVLPath(c);h!=null&&(l=this.GetModelBoundingBoxCenter(h).Clone());var p=t.GetInterpolatorList();for(var d=0;d<o;d++){var v=new e.Vector3(0,0,0),m=new e.Vector3(0,0,0),g=new e.Quaternion(0,0,0,1);for(var y=0,b=p;y<b.length;y++){var w=b[y],E=w.GetArrayLength();E>0&&d<E&&(w.GetType()==="Pivot"?v=w.GetAt(d).cp.Clone():w.GetType()==="QuatRot"?g=w.GetAt(d).quat.Clone():w.GetType()==="Pos"&&(m=w.GetAt(d).cp.Clone()))}m=e.AnimationHelper.UniTanslationToMtxTanslation(v,g,m);var S=new e.Vector3(m.x,m.y,m.z),x=new e.Quaternion(g.w,g.x,g.y,g.z),T=new e.Matrix3x4(S,x,1);S=T.Multiply(l);var N=f,C=N.lastIndexOf("\\");if(C>-1){N=N.substr(0,C);var k=e.AnimationPlayApi.SAPlcPathToDispPlcPath(N),L=u.view.GetModelBySVLPath(k);if(L!=null){var A=L.GetWorldTransform().ToMatrix3x4();S=A.Multiply(S)}}n.push(S)}for(var O=0;O<n.length-1;O++)r.push(O),r.push(O+1)},n}(e.AniCallbackFun);e.PlayBeginCB=n;var r=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.onExecute=function(t,n,r,i,s){t===void 0&&(t=null),n===void 0&&(n=null),r===void 0&&(r=null),i===void 0&&(i=null),s===void 0&&(s=null),e.Parameters.Instance().isShowAniTrochoid&&this.PlayEndCallBack()},n.prototype.PlayEndCallBack=function(){var t=e.SimulationAnimationManager.Instance().view,n="AnimationTrochoid";e.AnimationHelper.RemoveTrochoid(n,t)},n}(e.AniCallbackFun);e.PlayEndCB=r;var i=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.onExecute=function(t,n,r,i,s){t===void 0&&(t=null),n===void 0&&(n=null),r===void 0&&(r=null),i===void 0&&(i=null),s===void 0&&(s=null);var o=e.AnimationHelper.GetModel(t,e.SimulationAnimationManager.Instance().view);if(!o)return;var u=e.AnimationHelper.GetModelPlcMatrix(o),a=u.Data();for(var f=0;f<3;++f)for(var l=0;l<4;++l)n[l][f]=a[f*4+l];n[0][3]=0,n[1][3]=0,n[2][3]=0,n[3][3]=1},n}(e.AniCallbackFun);e.GetModelPlcMtxCB=i;var s=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.onExecute=function(t,n,r,i,s){t===void 0&&(t=null),n===void 0&&(n=null),r===void 0&&(r=null),i===void 0&&(i=null),s===void 0&&(s=null);var o=t;if(!o)return;var u=o.indexOf("|");o=o.substr(u+1);var a=e.AnimationHelper.GetNode(o,e.SimulationAnimationManager.Instance().view),f=new e.Matrix3x4(n[0][0],n[1][0],n[2][0],n[3][0],n[0][1],n[1][1],n[2][1],n[3][1],n[0][2],n[1][2],n[2][2],n[3][2]);if(!a)return;a.SetPlaceMatrix(f.ToMatrix4());var l=e.SimulationAnimationManager.Instance(),c=l.view,h=c.GetSceneManager();h.UpdateSceneByModel(a)},n}(e.AniCallbackFun);e.SetModelPlcMtxCB=s;var o=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.onExecute=function(e,t,n,r,i){e===void 0&&(e=null),t===void 0&&(t=null),n===void 0&&(n=null),r===void 0&&(r=null),i===void 0&&(i=null)},t}(e.AniCallbackFun);e.GetCameraCB=o;var u=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.onExecute=function(e,t,n,r,i){e===void 0&&(e=null),t===void 0&&(t=null),n===void 0&&(n=null),r===void 0&&(r=null),i===void 0&&(i=null)},t}(e.AniCallbackFun);e.SetCameraCB=u;var a=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.onExecute=function(e,t,n,r,i){e===void 0&&(e=null),t===void 0&&(t=null),n===void 0&&(n=null),r===void 0&&(r=null),i===void 0&&(i=null)},t}(e.AniCallbackFun);e.GetCameraTargetPntCB=a;var f=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.onExecute=function(e,t,n,r,i){e===void 0&&(e=null),t===void 0&&(t=null),n===void 0&&(n=null),r===void 0&&(r=null),i===void 0&&(i=null)},t}(e.AniCallbackFun);e.PlayVisibleCB=f;var l=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.onExecute=function(e,t,n,r,i){e===void 0&&(e=null),t===void 0&&(t=null),n===void 0&&(n=null),r===void 0&&(r=null),i===void 0&&(i=null)},t}(e.AniCallbackFun);e.PlayColorCB=l;var c=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.onExecute=function(e,t,n,r,i){e===void 0&&(e=null),t===void 0&&(t=null),n===void 0&&(n=null),r===void 0&&(r=null),i===void 0&&(i=null)},t}(e.AniCallbackFun);e.PlayImageCB=c;var h=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.onExecute=function(e,t,n,r,i){e===void 0&&(e=null),t===void 0&&(t=null),n===void 0&&(n=null),r===void 0&&(r=null),i===void 0&&(i=null)},t}(e.AniCallbackFun);e.PlayClipPlaneCB=h;var p=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.onExecute=function(t,n,r,i,s){t===void 0&&(t=null),n===void 0&&(n=null),r===void 0&&(r=null),i===void 0&&(i=null),s===void 0&&(s=null);var o=t,u=[];for(var a=0;a<o.length;++a)o[a].Type==e.TargetObjectType.TARGETOBJECT_TYPE_INS&&o[a].bVisible==0&&u.push(o[a]);for(var a=0;a<o.length;++a){var f=o[a].InsPath;if(!f)continue;var l=e.SimulationAnimationManager.Instance().view.GetModelBySVLPath(f);if(l instanceof e.Model){var c=new e.Vector3(o[a].Pos[0],o[a].Pos[1],o[a].Pos[2]),h=new e.Quaternion(o[a].Quat[3],o[a].Quat[0],o[a].Quat[1],o[a].Quat[2]),p=new e.Vector3(o[a].Scale[0],o[a].Scale[1],o[a].Scale[2]),d=new e.Matrix4(c,h,p);l.SetPlaceMatrix(d);var v=o[a].bVisible,m=!1;m||(l.GetParent().IsVisible()?e.AnimationHelper.SetModelVisible(v,l):e.AnimationHelper.SetModelVisible(!1,l)),l.ResetAlpha()}}},n}(e.AniCallbackFun);e.SetTargetStateCB=p;var d=function(){function d(){}return d.prototype.SetAnimationPlayCB=function(){this.SetAniPlayCB(new t,new n,new r,new i,new s,new o,new u,new a,new f,new l,new c,new h,new p)},d.prototype.SetAniPlayCB=function(t,n,r,i,s,o,u,a,f,l,c,h,p){var d=e.SimulationAnimationManager.Instance();if(!d)return;if(!this.pAnimationPlayCBList){this.pAnimationPlayCBList=d.GetAnimationPlayCBList();if(this.pAnimationPlayCBList==null)return;this.pAnimationPlayCBList.SetCBTran(t,n,r,i,s,o,u,a,f,l,c,h,p)}},d.prototype.ReSetCBTran=function(){this.SetAnimationPlayCB()},d}();e.AnimationRelated=d})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.PLAY_MODE_NONE=0]="PLAY_MODE_NONE",e[e.PLAY_MODE_PROCESS=1]="PLAY_MODE_PROCESS",e[e.PLAY_MODE_FROCURPROCESS=2]="PLAY_MODE_FROCURPROCESS",e[e.PLAY_MODE_PROCESSMANAGER=3]="PLAY_MODE_PROCESSMANAGER",e[e.PLAY_MODE_FROCURPROCESSMANAGER=4]="PLAY_MODE_FROCURPROCESSMANAGER",e[e.PLAY_MODE_ALL=5]="PLAY_MODE_ALL",e[e.PLAY_MODE_RANDOM=6]="PLAY_MODE_RANDOM"})(t=e.AnimationPlayMode||(e.AnimationPlayMode={}));var n=function(){function n(e){this.ProcessManagerList=[],this.CurProcessManagerID=-1,e?this.Name=e:this.Name="动画过程管理器",this.pSA=null,this.PlayMode=t.PLAY_MODE_NONE,this.pBehaviorManagerChgCam=null,this.nChgCamTickNum=10,this.bIsPause=!1,this.TickCount=0}return n.prototype.GetTickCount=function(){return this.TickCount},n.prototype.CaculateTickCount=function(){this.TickCount=0;for(var e=0;e<this.ProcessManagerList.length;++e)this.ProcessManagerList[e].SetPreTickCount(this.TickCount),console.log(e+" PreTick:"+this.TickCount),this.ProcessManagerList[e].CaculateTickCount(),this.TickCount+=this.ProcessManagerList[e].GetTickCount
(),console.log(" TickCount:"+this.TickCount)},n.prototype.GetCurPercentage=function(){if(this.TickCount!=0){var e=this.GetCurrentProcess();if(e){var t=e.GetBehaviorManager();if(t)return(t.GetCurrentTick()-t.GetFirstTick()+e.GetPreTickCount())/this.TickCount}}return 0},n.ProcessXMLData=function(t,r){var i;r?i=r.CreateAnimationStepManager():i=new n("");var s=t.getAttribute("Name");if(!s||s==="")s="DefaultName";i.Name=s;var o=t.getAttribute("CurProcessManagerID");o||(o=0);for(var u=0;u<t.childNodes.length;++u){var a=t.childNodes[u];if(a.nodeType===1){var f=a.nodeName;switch(f){case"ProcessManager":e.ProcessManager.ProcessXMLData(a,i)}}}i.CurProcessManagerID=o,i.SetCurProcessManagerByID(o,!1)},n.prototype.PlayFinishCB=function(e){if(this.PlayMode==t.PLAY_MODE_RANDOM)return;var n=this.GetCurrentProcessManager();if(n){var r=n.GetCurrentProcess();if(r)if(this.PlayMode==t.PLAY_MODE_FROCURPROCESS||this.PlayMode==t.PLAY_MODE_PROCESSMANAGER||this.PlayMode==t.PLAY_MODE_FROCURPROCESSMANAGER||this.PlayMode==t.PLAY_MODE_ALL){this.pSA.GetReversePlay()?r=n.GetPreProcess(r):r=n.GetNextProcess(r);if(r)n.SetCurProcessByID(r.GetID());else{r=null;if(this.PlayMode==t.PLAY_MODE_FROCURPROCESSMANAGER||this.PlayMode==t.PLAY_MODE_ALL)this.pSA.GetReversePlay()?n=this.GetPreProcessManager(n):n=this.GetNextProcessManager(n),n?(this.pSA.GetReversePlay()?n.SetCurProcessByIdx(n.GetProcessCount()-1):n.SetCurProcessByIdx(0),r=n.GetCurrentProcess()):n=null,r||(this.pSA.GetReversePlay()?r=this.GetPreProcess(r):r=this.GetNextProcess(r),r&&(n=r.GetProcessManager(),n.SetCurProcessByID(r.GetID())))}if(r){var i=r.GetBehaviorManager();i&&(this.pSA.GetReversePlay()?(i.RewindReverse(),i.ContinueReverse()):(i.Rewind(),i.Continue()),this.bIsPause=!1)}else this.pSA.GetContinuousPlay()?this.PlayMode==t.PLAY_MODE_FROCURPROCESS||this.PlayMode==t.PLAY_MODE_PROCESSMANAGER?this.Play(t.PLAY_MODE_PROCESSMANAGER,this.pSA.GetReversePlay()):this.Play(t.PLAY_MODE_ALL,this.pSA.GetReversePlay()):this.Stop()}else this.pSA.GetContinuousPlay()?this.Play(this.PlayMode,this.pSA.GetReversePlay()):this.Stop()}},n.prototype.AddProcessManager=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length==2){var r;return(r=this.FindProcessManagerByID(t[0]))&&t[0]>0?(r.SetName(t[1]),r.DeleteAllProcess()):(t[0]==-1?r=new e.ProcessManager(this.RegisterProcessManagerID(),t[1]):r=new e.ProcessManager(t[0],t[1]),this.AddProcessManager(r)),r}if(t.length!=1)return this.AddProcessManager(-1,"");null!=t[0]&&(this.ProcessManagerList.push(t[0]),this.CurProcessManagerID=t[0].GetID(),t[0].SetAnimationStepManager(this))},n.prototype.RegisterProcessManagerID=function(){var e=0;for(var t=0;t<this.ProcessManagerList.length;++t)this.ProcessManagerList[t].GetID()>=e&&(e=this.ProcessManagerList[t].GetID()+1);return e},n.prototype.EndChangeCamera=function(){if(this.pBehaviorManagerChgCam){var e=this.pBehaviorManagerChgCam.GetSimulationAnimationManager();e&&(this.pBehaviorManagerChgCam.DeleteAllAnimations(),this.GetCurrentProcess()&&this.GetCurrentProcess().GetBehaviorManager()&&e.SetCurSAByID(this.GetCurrentProcess().GetBehaviorManager().GetID()))}},n.prototype.Stop=function(){this.PlayMode=t.PLAY_MODE_NONE,this.pSA.IsPlaying()&&this.pSA.StopAll(),this.pSA.SetReversePlay(!1),this.EndChangeCamera()},n.prototype.GetCurrentProcessManager=function(){return-1!=this.CurProcessManagerID?this.FindProcessManagerByID(this.CurProcessManagerID):null},n.prototype.GetPreProcessManager=function(e){var t=null,n=this.GetProcessManagerIdxByID(e.GetID());return n>0&&(t=this.GetProcessManagerByIdx(n-1)),t},n.prototype.IsAtPlayFirst=function(){var e=!1,n=this.GetCurrentProcessManager(),r=this.GetCurrentProcess();if(!n||!r)return!1;var i=r.GetBehaviorManager();return i?(i.ScheduleAllAnimations(!0),i.GetCurrentTick()<=i.GetFirstTick()?e=!0:e=!1,e&&this.GetPlayMode()!=t.PLAY_MODE_PROCESS&&(n.GetPreProcess(r)?e=!1:e=!0),e&&(this.GetPlayMode()==t.PLAY_MODE_FROCURPROCESSMANAGER||this.GetPlayMode()==t.PLAY_MODE_ALL)&&(this.GetPreProcessManager(n)?e=!1:e=!0),e):!1},n.prototype.IsAtPlayEnd=function(){var e=!1,n=this.GetCurrentProcessManager(),r=this.GetCurrentProcess();if(!n||!r)return!1;var i=r.GetBehaviorManager();return i?(i.ScheduleAllAnimations(!0),i.GetCurrentTick()>=i.GetLastTick()?e=!0:e=!1,e&&this.GetPlayMode()!=t.PLAY_MODE_PROCESS&&(n.GetNextProcess(r)?e=!1:e=!0),e&&(this.GetPlayMode()==t.PLAY_MODE_FROCURPROCESSMANAGER||this.GetPlayMode()==t.PLAY_MODE_ALL)&&(this.GetNextProcessManager(n)?e=!1:e=!0),e):!1},n.prototype.GetNextProcessManager=function(e){var t=null,n=this.GetProcessManagerIdxByID(e.GetID());return n<this.GetProcessManagerCount()-1&&(t=this.GetProcessManagerByIdx(n+1)),t},n.prototype.GetCurProcessManagerID=function(){return this.CurProcessManagerID},n.prototype.SetCurProcessManagerByIdx=function(e,t,n,r){t===void 0&&(t=!0),n===void 0&&(n=!1),r===void 0&&(r=!1);var i=this.GetProcessManagerByIdx(e);if(i&&this.CurProcessManagerID!=i.GetID()){this.CurProcessManagerID=i.GetID();var s=this.GetCurrentProcess();s&&s.UpdateView(t,n,r),t&&this.UpdateViewWithProcessManager(e)}this.pSA&&this.GetCurrentProcess()&&this.pSA.SetCurSAByID(this.GetCurrentProcess().GetBehaviorManagerID())},n.prototype.StartChangeCamera=function(t,n){var r=!1;if(!t)return r;var i=this.pSA.RegisterBehaviorManagerID();this.pBehaviorManagerChgCam?this.pBehaviorManagerChgCam.DeleteAllAnimations():this.pBehaviorManagerChgCam=this.pSA.AddSimAni(i);var s,o,u,a=new e.Vector3(0,0,0);s="CAMERA",s=":SCENE/TARGET",o="Camera",u=e.HBhvUtility.AddAnimation(this.pBehaviorManagerChgCam,o,s,a,null);if(u==null)return!1;var f=this.pSA.GetAnimationPlayApi();if(f){var l,c,h,p,d,v,m=t.GetCamera(p,d,v);if(!m){s=e.TARGETOBJECTTYPE_CAM,s+=":SCENE/TARGET";var g=this.pSA.FindInitTargetObjectByPath(s);g&&(p=g.GetPos(),d=g.GetQuat(),v=g.GetScale(),m=!0)}if(m){var y=[1,1,1],b=e.ArrayMaker.MakeNumArray(4,4),w=e.ArrayMaker.MakeNumArray(3);f.GetCamera(s,y,b),f.GetCameraTargetPnt(s,w),b[3][0]=w[0],b[3][1]=w[1],b[3][2]=w[2];var E=e.ArrayMaker.MakeNumArray(4,4);for(var S=0;S<4;++S)for(var x=0;x<4;++x)E[S][x]=b[S][x];e.MatrixOperation.MatrixInversion(E),l=new e.Vector3(E[3][0],E[3][1],E[3][2]),c=e.Quaternion.MatrixToQuaternion(E),h=new e.Vector3(y[0],y[1],y[2]),e.HBhvUtility.AddCameraKeyframe(this.pBehaviorManagerChgCam,u,0,new e.Vector3(0,0,0),l,c,h,!0);var T=v.x;if(v.y>0&&v.z>0){var N=v.y/y[1],C=v.z/y[2];N>C?T/=N:T/=C}v=new e.Vector3(T,y[1],y[2]);var k=e.ArrayMaker.MakeNumArray(4,4),L=e.ArrayMaker.MakeNumArray(4,4);d.ToMatrix(k),k[3][0]=p.x,k[3][1]=p.y,k[3][2]=p.z;for(var S=0;S<4;++S)for(var x=0;x<4;++x)L[S][x]=k[S][x];e.MatrixOperation.MatrixInversion(L),p=new e.Vector3(L[3][0],L[3][1],L[3][2]),d=e.Quaternion.MatrixToQuaternion(L),e.HBhvUtility.AddCameraKeyframe(this.pBehaviorManagerChgCam,u,this.nChgCamTickNum,new e.Vector3(0,0,0),p,d,v,!0),n?(this.pBehaviorManagerChgCam.SetCurrentTick(0),this.pBehaviorManagerChgCam.Continue(),r=!0,this.bIsPause=!1):(this.pBehaviorManagerChgCam.RewindReverse(),this.EndChangeCamera(),r=!1)}else this.EndChangeCamera(),r=!1}return r},n.prototype.Rewind=function(e,n){this.IsPlaying()&&this.Stop(),this.pSA.SetReversePlay(n);if(e==t.PLAY_MODE_ALL)if(this.pSA.GetReversePlay()){var r=this.GetCurrentProcessManager();while(r)r.SetCurProcessByIdx(r.GetProcessCount()-1),r=this.GetNextProcessManager(r);this.SetCurProcessManagerByIdx(this.GetProcessManagerCount()-1)}else{var r=this.GetCurrentProcessManager();while(r)r.SetCurProcessByIdx(0),r=this.GetPreProcessManager(r);this.SetCurProcessManagerByIdx(0)}else if(e==t.PLAY_MODE_PROCESSMANAGER||e==t.PLAY_MODE_FROCURPROCESSMANAGER||e==t.PLAY_MODE_FROCURPROCESS){var i=this.GetCurrentProcessManager();i&&(n?i.SetCurProcessByIdx(i.GetProcessCount()-1):i.SetCurProcessByIdx(0))}else if(e==t.PLAY_MODE_PROCESS){var i=this.GetCurrentProcessManager(),s=null,o=null;i&&(s=i.GetCurrentProcess(),s&&(o=s.GetBehaviorManager())),o&&(n?o.RewindReverse():o.Rewind())}var u=this.GetCurrentProcess();u&&u.UpdateView(!0,!0)},n.prototype.Pause=function(){this.bIsPause=!0;if(this.pSA.IsPlaying()){var e=this.pSA.GetCurrentSA();e&&e.Stop(),this.EndChangeCamera()}},n.prototype.PlayNextProcess=function(){var e=this.GetCurrentProcessManager();if(!e)return;var n=e.GetNextProcess(e.GetCurrentProcess());n||(e=this.GetNextProcessManager(e),e&&(this.pSA.GetReversePlay()?e.SetCurProcessByIdx(e.GetProcessCount()-1):e.SetCurProcessByIdx(0),n=e.GetCurrentProcess()));if(n){e.SetCurProcessByID(n.GetID());var r=n.GetBehaviorManager();r&&(this.pSA.GetReversePlay()?(r.RewindReverse(),r.ContinueReverse()):(r.Rewind(),r.Continue()),this.bIsPause=!1)}else this.pSA.GetContinuousPlay()&&(this.PlayMode==t.PLAY_MODE_FROCURPROCESS||this.PlayMode==t.PLAY_MODE_PROCESSMANAGER?this.Play(t.PLAY_MODE_PROCESSMANAGER,this.pSA.GetReversePlay()):this.Play(t.PLAY_MODE_ALL,this.pSA.GetReversePlay()))},n.prototype.PlayPreProcess=function(){var e=this.GetCurrentProcessManager();if(!e)return;var n=e.GetPreProcess(e.GetCurrentProcess());n||(e=this.GetPreProcessManager(e),e&&(this.pSA.GetReversePlay()?e.SetCurProcessByIdx(0):e.SetCurProcessByIdx(e.GetProcessCount()-1),n=e.GetCurrentProcess()));if(n){e.SetCurProcessByID(n.GetID());var r=n.GetBehaviorManager();r&&(this.pSA.GetReversePlay()?(r.RewindReverse(),r.ContinueReverse()):(r.Rewind(),r.Continue()),this.bIsPause=!1)}else this.pSA.GetContinuousPlay()&&(this.PlayMode==t.PLAY_MODE_FROCURPROCESS||this.PlayMode==t.PLAY_MODE_PROCESSMANAGER?this.Play(t.PLAY_MODE_PROCESSMANAGER,this.pSA.GetReversePlay()):this.Play(t.PLAY_MODE_ALL,this.pSA.GetReversePlay()))},n.prototype.Play=function(e,n,r){n===void 0&&(n=!1),r===void 0&&(r=!1);if(!this.pSA||!this.pSA.HasAnimations())return;this.IsPlaying()&&this.Stop(),this.pSA.SetReversePlay(n),this.PlayMode=e;if(this.bIsPause){var i=this.pSA.GetCurrentSA();i&&(n?i.ContinueReverse():i.Continue()),this.bIsPause=!1}else{var s=!1;n?s=this.IsAtPlayFirst():s=this.IsAtPlayEnd();if(s&&!r)this.Rewind(e,n),this.pSA.SetReversePlay(n),this.PlayMode=e;else if(this.PlayMode==t.PLAY_MODE_ALL)if(this.pSA.GetReversePlay()){var o=this.GetCurrentProcessManager();while(o)o.SetCurProcessByIdx(o.GetProcessCount()-1),o=this.GetNextProcessManager(o);this.SetCurProcessManagerByIdx(this.GetProcessManagerCount()-1)}else{var o=this.GetCurrentProcessManager();while(o)o.SetCurProcessByIdx(0),o=this.GetPreProcessManager(o);this.SetCurProcessManagerByIdx(0)}else if(this.PlayMode==t.PLAY_MODE_PROCESSMANAGER||this.PlayMode==t.PLAY_MODE_FROCURPROCESSMANAGER){var u=this.GetCurrentProcessManager();u&&(this.pSA.GetReversePlay()?u.SetCurProcessByIdx(u.GetProcessCount()-1):u.SetCurProcessByIdx(0))}var u=this.GetCurrentProcessManager(),a,f;if(u){a=u.GetCurrentProcess();if(!a){if(this.PlayMode==t.PLAY_MODE_PROCESSMANAGER||this.PlayMode==t.PLAY_MODE_FROCURPROCESSMANAGER||this.PlayMode==t.PLAY_MODE_ALL)this.pSA.GetReversePlay()?a=this.GetPreProcess(a):a=this.GetNextProcess(a);a&&(u=a.GetProcessManager(),u.SetCurProcessByID(a.GetID(),!1))}a&&(f=a.GetBehaviorManager())}f?(a.UpdateView(!0,!1,!1),this.StartChangeCamera(a,!0)||(this.pSA.GetReversePlay()?f.ContinueReverse():f.Continue())):this.PlayMode=t.PLAY_MODE_NONE}},n.prototype.GetPreProcess=function(e){var t,n=this.GetCurrentProcessManager();if(n){e&&(t=n.GetPreProcess(e));while(!t&&(n=this.GetPreProcessManager(n)))n.GetProcessCount()>0&&(t=n.GetProcessByIdx(n.GetProcessCount()-1))}return t},n.prototype.GetNextProcess=function(e){var t,n=this.GetCurrentProcessManager();if(n){e&&(t=n.GetNextProcess(e));while(!t&&(n=this.GetNextProcessManager(n)))n.GetProcessCount()>0&&(t=n.GetProcessByIdx(0))}return t},n.prototype.IsPlaying=function(){var e=!1;return this.PlayMode!=t.PLAY_MODE_NONE&&!this.bIsPause&&(e=!0),e},n.prototype.SetCurProcessManagerByID=function(e,t,n,r){t===void 0&&(t=!0),n===void 0&&(n=!1),r===void 0&&(r=!1);if(this.CurProcessManagerID!=e){this.CurProcessManagerID=e;var i=this.GetCurrentProcess();i&&i.UpdateView(t,n,r)}this.pSA&&this.GetCurrentProcess()&&this.pSA.SetCurSAByID(this.GetCurrentProcess().GetBehaviorManagerID())},n.prototype.GetCurrentProcess=function(){if(-1!=this.CurProcessManagerID){var e=this.FindProcessManagerByID(this.CurProcessManagerID);if(e)return e.GetCurrentProcess()}return null},n.prototype.FindProcessManagerByID=function(e){for(var t=0;t<this.ProcessManagerList.length;++t)if(this.ProcessManagerList[t].GetID()==e)return this.ProcessManagerList[t];return null},n.prototype.GetProcessManagerIdxByID=function(e){for(var t=0;t<this.ProcessManagerList.length;++t)if(e==this.ProcessManagerList[t].GetID())return t;return-1},n.prototype.GetProcessManagerByIdx=function(e){var t;return this.ProcessManagerList.length>0&&e<this.ProcessManagerList.length&&(t=this.ProcessManagerList[e]),t},n.prototype.UpdateViewWithProcessManager=function(e){var t=this.GetSimulationAnimationManager(),n=t.IsCameraPlay();t.SetCameraPlay(!1);if(!t.IsPlaying()){for(var r=0;r<e;r++){var i=this.GetProcessManagerByIdx(r);if(i)for(var s=0;s<i.GetProcessCount();s++){var o=i.GetProcessByIdx(s);if(o){var u=o.GetBehaviorManager();u&&u.RewindReverse()}}}for(var r=this.GetProcessManagerCount()-1;r>e;r--){var i=this.GetProcessManagerByIdx(r);if(i)for(var s=i.GetProcessCount()-1;s>=0;s--){var o=i.GetProcessByIdx(s);if(o){var u=o.GetBehaviorManager();u&&u.Rewind()}}}var i=this.GetProcessManagerByIdx(e);if(i){var a=i.GetProcessIdxByID(i.GetCurProcessID());i.UpdateViewWithProcess(a)}}t.SetCameraPlay(n)},n.prototype.GetBehaviorActionChgCam=function(){return this.pBehaviorManagerChgCam},n.prototype.GetSimulationAnimationManager=function(){return this.pSA},n.prototype.SetSimulationAnimationManager=function(e){this.pSA=e},n.prototype.GetName=function(){return this.Name},n.prototype.SetName=function(e){null!=e&&(this.Name=e)},n.prototype.DeleteAllProcessManager=function(){this.ProcessManagerList=[],this.CurProcessManagerID=-1},n.prototype.GetProcessManagerCount=function(){return this.ProcessManagerList.length},n.prototype.GetPlayMode=function(){return this.PlayMode},n.prototype.SetPlayMode=function(e){this.PlayMode=e},n.prototype.GetProcessManagerList=function(){return this.ProcessManagerList},n}();e.AnimationStepManager=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){}return e.MakeNumArray=function(e,t){t===void 0&&(t=1);if(e<=0||t<=0)return null;var n=[];for(var r=0;r<t;++r){var i=[];for(var s=0;s<e;++s)i.push(0);n.push(i)}return n},e}();e.ArrayMaker=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(e,t){e===void 0&&(e=null),t===void 0&&(t=null),this.pTarget=0,this.pAnimation=e,t?this.Name=t:this.Name="",this.pArray=[]}return t.prototype.GetArrayLength=function(){return this.pArray.length},t.prototype.GetArray=function(){return this.pArray},t.prototype.GetAt=function(e){return this.pArray[e]},t.prototype.SetAnimation=function(e){this.pAnimation=e},t.prototype.GetAnimation=function(){return this.pAnimation},t.prototype.Interpolate=function(e,t){},t.prototype.GetType=function(){return""},t.prototype.Evaluate=function(e,t,n){},t.prototype.GetTranslationFromMatrix=function(){var t;t=this.GetAnimation().GetTarget().GetPivot();var n;return n=new e.Vector3(-t.x,-t.y,-t.z),new e.Vector3(n.x+t.x,n.y+t.y,n.z+t.z)},t.prototype.Reset=function(){},t.prototype.SetInstancedInterpolator=function(e){this.pInterpolatorInstance=e},t}();e.HBhvInterpolator=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(e,n){e===void 0&&(e=null),n===void 0&&(n=null);var r=t.call(this,e,n)||this;return r.ColorComponent="",r.GeomType="",r.SetGeomType("everything"),r.SetColorComponent("diffuse"),r}return __extends(n,t),n.prototype.SetGeomType=function(e){this.GeomType=e},n.prototype.GetGeomType=function(){return this.GeomType},n.prototype.SetColorComponent=function(e){this.ColorComponent=e},n.prototype.GetColorComponent=function(){return this.ColorComponent},n.prototype.GetType=function(){return"Color"},n.ProcessXMLData=function(t,r){var i=t.getAttribute("Name");i||(i="");var s=/([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+(\])+/,o=new n(r,i),u=t.getAttribute("GeomType");u?o.SetGeomType(u):o.SetGeomType("everything");var a=t.getAttribute("Type");a?o.SetGeomType(a):o.SetGeomType("diffuse");var f=t.textContent;f+=" ";var l=0,c=0;for(;;){c=f.indexOf("]");if(c<=0||c>=f.length)break;var h=f.substr(0,c+1);f=f.substr(c+1),h=h.trim();var p;if(h){var d=s.exec(h);d&&(p=new e.Vector3(parseFloat(d[1]),parseFloat(d[3]),parseFloat(d[5])),o.Insert(p,l++))}}r.AddInterpolator(o)},n.prototype.Insert=function(t,n){n===void 0&&(n=0);var r=new e.HKeyframeChannelLinear;r.cp=t;var i=this.pArray.splice(n,this.pArray.length-n,r);this.pArray=this.pArray.concat(i)},n.prototype.CalculatePos=function(t,n){var r=new e.Vector3,i=this.GetArray(),s=this.GetArrayLength();return t>=s-1?r.copyFrom(this.pArray[s-1].cp):r.copyFrom(this.pArray[t].Interpolate(i,t,n,s)),r},n.prototype.Interpolate=function(t,n){var r=new e.Vector3;r=this.CalculatePos(t,n);var i="";i=this.GetAnimation().GetTarget().GetResolvedPath();var s="",o=new e.Vector3;o.copyFrom(r),this.GetAnimation().GetTarget().GetType()===e.TARGETOBJECTTYPE_PMI,(o.x!==-1||o.y!==-1||o.z!==-1)&&(o[0]<0||o[1]<0||o[2]<0)&&(o.x+=1,o.y+=1,o.z+=1),i=e.AnimationPlayApi.SAPlcPathToDispPlcPath(i),this.GetAnimation().GetBehaviorManager().TransferColor(i,name,o)},n}(e.HBhvInterpolator);e.HBhvInterpolatorColor=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(e,n){return e===void 0&&(e=null),n===void 0&&(n=null),t.call(this,e,n)||this}return __extends(n,t),n.prototype.GetType=function(){return e.INTERPOLATOR_PIVOT},n.ProcessXMLData=function(t,r){var i=t.getAttribute("Name");i||(i="");var s=/(\[d)+[\s]+([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+(\])+/,o=new n(r,i),u=t.textContent;u+=" ";var a=0,f=0;for(;;){f=u.indexOf("]");if(f<=0||f>=u.length)break;var l=u.substr(0,f+1);u=u.substr(f+1),l=l.trim();var c;if(l){var h=s.exec(l);h&&(c=new e.Vector3(parseFloat(h[2]),parseFloat(h[4]),parseFloat(h[6])),o.Insert(c,a++))}}r.AddInterpolator(o),r.GetTimeline()&&r.GetInterpolator(e.INTERPOLATOR_PIVOT)&&r.GetTimeline().AddTLRange()},n.prototype.Insert=function(t,n){var r=new e.HKeyframeChannelDiscrete;r.cp=t;var i=this.pArray.splice(n,this.pArray.length-n,r);this.pArray=this.pArray.concat(i)},n.prototype.CalculatePos=function(t,n){var r=new e.Vector3,i=this.GetArray(),s=this.GetArrayLength();return t>=s-1?r.copyFrom(i[s-1].cp):n==0||n==1?r.copyFrom(i[t].cp):r.copyFrom(i[t+1].cp),r},n.prototype.Interpolate=function(e,t){var n;n=this.CalculatePos(e,t),this.GetAnimation().GetTarget().SetPivot(n.x,n.y,n.z)},n.prototype.Replace=function(t,n){var r=new e.HKeyframeChannelDiscrete;r.cp=t,this.pArray.length>n&&(this.pArray[n]=r)},n}(e.HBhvInterpolator);e.HBhvInterpolatorPivot=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(e,n){return e===void 0&&(e=null),n===void 0&&(n=null),t.call(this,e,n)||this}return __extends(n,t),n.prototype.GetType=function(){return"Pos"},n.ProcessXMLData=function(t,r){var i=t.getAttribute("Name");i||(i="");var s=/([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+(\])+/,o=new n(r,i),u=t.textContent;u+=" ";var a=0,f=0;for(;;){f=u.indexOf("]");if(f<=0||f>=u.length)break;var l=u.substr(0,f+1);u=u.substr(f+1),l=l.trim();var c=l.split(""),h=new e.Vector3,p=e.HANIChannelType.HANILinear,d=!1,v=!1,m=!1;if(l){var g=c.indexOf("[");g>=0&&g<c.length&&(c=c.slice(g+1));for(var y=0;y<c.length;++y){if(c[y]>="0"&&c[y]<="9"||c[y]=="-"){if(d)break;c=c.join("").trim().split("");var b=s.exec(c.join(""));b&&(h=new e.Vector3(parseFloat(b[1]),parseFloat(b[3]),parseFloat(b[5])));break}switch(c[y]){case"l":p=e.HANIChannelType.HANILinear;continue;case"b":p=e.HANIChannelType.HANIHermiteSpline;continue;case"d":p=e.HANIChannelType.HANIDiscrete;continue;case"e":v=!0;continue;case"f":p=e.HANIChannelType.HANIFollowPath,c[y+1]=="l"&&(m=!0,c[y+1]=" ");continue;case"*":d=!0,p=e.HANIChannelType.HANIHermiteSpline;continue}c[y]=" "}if(p==e.HANIChannelType.HANIFollowPath){var w=new e.HKeyframeChannelFollowPath;w.bLinear=m,w.cp=h;var E=o.pArray.splice(a,o.pArray.length-a,w);o.pArray=o.pArray.concat(E)}else p==e.HANIChannelType.HANILinear?o.InsertLinear(h,a):p==e.HANIChannelType.HANIHermiteSpline?o.InsertCurve(h,a):p==e.HANIChannelType.HANIDiscrete&&o.InsertDiscrete(h,a);o.pArray[a].SetConstant(d),o.pArray[a].SetEaseInOut(v),a++}}r.AddInterpolator(o),r.GetTimeline()&&r.GetInterpolator(e.INTERPOLATOR_POS)&&r.GetTimeline().AddTLRange()},n.prototype.InsertLinear=function(t,n){n===void 0&&(n=0);var r=new e.HKeyframeChannelLinear;r.cp=t;var i=this.pArray.splice(n,this.pArray.length-n,r);this.pArray=this.pArray.concat(i)},n.prototype.InsertCurve=function(t,n){n===void 0&&(n=0);var r=new e.HKeyframeChannelCurve;r.cp=t;var i=this.pArray.splice(n,this.pArray.length-n,r);this.pArray=this.pArray.concat(i)},n.prototype.InsertDiscrete=function(t,n){n===void 0&&(n=0);var r=new e.HKeyframeChannelDiscrete;r.cp=t;var i=this.pArray.splice(n,this.pArray.length-n,r);this.pArray=this.pArray.concat(i)},n.prototype.Reset=function(){this.CalculateAllTangents()},n.prototype.CalculateAllTangents=function(){var t=this.GetArray(),n=this.GetArrayLength();for(var r=0;r<n-1;r++)if(t[r].channeltype==e.HANIChannelType.HANIFollowPath||t[r].channeltype==e.HANIChannelType.HANIHermiteSpline){var i=void 0,s=void 0,o=void 0,u=void 0;s=t[r].cp,o=t[r+1].cp,r>0?t[r-1].channeltype==e.HANIChannelType.HANILinear?i=s:i=t[r-1].cp:i=s,r<n-2?t[r+1].channeltype==e.HANIChannelType.HANILinear?u=o:u=t[r+2].cp:u=o,t[r].CalculateCurveFactor(this.GetAnimation().GetTimeline(),r),t[r].CalculateHermiteTangents(i,o,u)}},n.prototype.SetTarget=function(){this.pTarget=this.GetAnimation().GetTarget().GetTargetKey()},n.prototype.CalculatePos=function(t,n){var r,i=this.GetArray(),s=this.GetArrayLength();!this.GetAnimation().GetCurrentlyRunning()&&i[0].bConstant&&(i[0].cp=this.GetTranslationFromMatrix());if(t>=s-1)r=this.pArray[s-1].cp;else{var o=this.pArray[t];(o===null||o===undefined)&&console.log("NOT CORRECT"),this.pArray[t].bEaseInOut&&(n=e.HUtility.EaseInEaseOut(n,.49,.02,.49));var u=this.pAnimation.GetTarget().GetPrePivot(),a=this.pAnimation.GetTarget().GetPivot();if(u.Equal(a))this.pArray[t].cp.Equal(this.pArray[t+1].cp)?r=this.pArray[t].cp:r=this.pArray[t].Interpolate(i,t,n,s);else{var f=null,l=null;t<s-1?n<1?(f=i[t],l=i[t+1]):f=l=i[t+1]:f=l=i[s-1];var c=e.ArrayMaker.MakeNumArray(4,4),h=e.ArrayMaker.MakeNumArray(3),p=e.ArrayMaker.MakeNumArray(3);p[0]=u.x,p[1]=u.y,p[2]=u.z,h[0]=f.cp.x,h[1]=f.cp.y,h[2]=f.cp.z,this.GetAnimation().GetTarget().GetPreQuat().ToMatrix(c),e.MatrixOperation.UniTanslationToMtxTanslation(p,c,h);var d=e.ArrayMaker.MakeNumArray(3);d[0]=a.x,d[1]=a.y,d[2]=a.z,c[3][0]=h[0],c[3][1]=h[1],c[3][2]=h[2],h[0]=d[0]*c[0][0]+d[1]*c[1][0]+d[2]*c[2][0]+c[3][0],h[1]=d[0]*c[0][1]+d[1]*c[1][1]+d[2]*c[2][1]+c[3][1],h[2]=d[0]*c[0][2]+d[1]*c[1][2]+d[2]*c[2][2]+c[3][2],h[0]=h[0]-d[0],h[1]=h[1]-d[1],h[2]=h[2]-d[2];var v=new e.Vector3(f.cp);f.cp.x=h[0],f.cp.y=h[1],f.cp.z=h[2],r=this.pArray[t].Interpolate(i,t,n,s),f.cp.copyFrom(v)}}return r},n.prototype.Evaluate=function(e,t,n){n[0]=!0,n[1]=this.CalculatePos(e,t)},n.prototype.CalculatePosCamera=function(t,n){var r=this.GetArray(),i=this.GetArrayLength(),s=!1,o=new e.Vector3,u=!1,a=new e.Quaternion,f=!1,l=new e.Vector3;if(t<i-1){var c=this.GetAnimation().GetTimeline().GetTimelineArray(),h=this.pAnimation.GetTarget().GetPrePivot(),p=this.pAnimation.GetTarget().GetPivot();if(t<i-1)if(n<1){var d=null,v=null;d=r[t],v=r[t+1];var m=new e.Vector3(d.cp),g=new e.Vector3(v.cp);d.cp=e.HBhvUtility.MtxTanslationToUniTanslation(new e.Vector3(h),this.GetAnimation().GetTarget().GetPreQuat(),d.cp),v.cp=e.HBhvUtility.MtxTanslationToUniTanslation(new e.Vector3(p),this.GetAnimation().GetTarget().GetQuat(),v.cp);var y=[s,o,u,a,f,l];this.GetAnimation().Evaluate(this.GetAnimation().GetCurrentTick(),y),s=y[0],o=y[1],u=y[2],a=y[3],f=y[4],l=y[5];var b=!1,w=new e.Vector3,E=!1,S=new e.Quaternion,x=!1,T=new e.Vector3,N=!1,C=new e.Vector3,k=!1,L=new e.Quaternion,A=!1,O=new e.Vector3,M=c[t];y=[b,w,E,S,x,T],this.GetAnimation().Evaluate(M,y),b=y[0],w=y[1],E=y[2],S=y[3],x=y[4],T=y[5],M=c[t+1],y=[N,C,k,L,A,O],this.GetAnimation().Evaluate(M,y),N=y[0],C=y[1],k=y[2],L=y[3],A=y[4],O=y[5];if(!T.Equal(O)){var _=O.x/l.x;o.x=w.x+(o.x-w.x)*_,o.y=w.y+(o.y-w.y)*_,o.z=w.z+(o.z-w.z)*_}d.cp=new e.Vector3(m),v.cp=new e.Vector3(g),o=e.HBhvUtility.UniTanslationToMtxTanslation(new e.Vector3(p),a,o)}else o=r[t+1].cp}else o=r[i-1].cp;return o},n.prototype.InterpolateCamera=function(t,n){n===void 0&&(n=!1);var r=e.ArrayMaker.MakeNumArray(4,4);for(var i=0;i<4;i++)for(var s=0;s<4;s++)r[i][s]=0;r[0][0]=1,r[1][1]=1,r[2][2]=1,r[3][3]=1,r[3][0]=t.x,r[3][1]=t.y,r[3][2]=t.z;var o;o=this.pAnimation.GetTarget().GetResolvedPath();var u=this.pAnimation.GetTarget().GetPivot(),a=e.ArrayMaker.MakeNumArray(3);a[0]=u.x,a[1]=u.y,a[2]=u.z,this.GetAnimation().GetBehaviorManager().TransferCamera(o,0,a,r,this.GetAnimation().GetTarget().GetCameraType()),n||this.GetAnimation().GetBehaviorManager().CameraUpdated()},n.prototype.InterpolateCamera2=function(e,t){t===void 0&&(t=!1),t||this.GetAnimation().GetBehaviorManager().CameraUpdated()},n.prototype.Interpolate=function(t,n){var r;this.pTarget==-1&&this.SetTarget();var i=this.GetAnimation();if(i==null)return;r=this.CalculatePos(t,n);var s;s=this.pAnimation.GetTarget().GetResolvedPath();if(i.GetTarget().GetCameraType()!==e.HBhvCameraType.NoCamera){r=this.CalculatePosCamera(t,n);if(!i.GetBehaviorManager().IsCameraPlay())return;i.GetTarget().GetCameraType()===e.HBhvCameraType.CameraTargetFree||i.GetTarget().GetCameraType()===e.HBhvCameraType.CameraPositionFree||i.GetTarget().GetCameraType()===e.HBhvCameraType.CameraPositionTarget?this.InterpolateCamera2(r):this.InterpolateCamera(r)}else if(i.GetTarget().GetType()==="CLIP"){var o=e.ArrayMaker.MakeNumArray(3),u=e.ArrayMaker.MakeNumArray(3);o[0]=r.x,o[1]=r.y,o[2]=r.z;var a=void 0;a=this.pAnimation.GetName()}else if(i.GetTarget().GetType()!=="IMAGE"){var f=e.ArrayMaker.MakeNumArray(3),l=e.ArrayMaker.MakeNumArray(4,4);l[0][0]=1,l[1][1]=1,l[2][2]=1,l[3][3]=1,l[3][0]=r.x,l[3][1]=r.y,l[3][2]=r.z;var c=this.pAnimation.GetTarget().GetPivot();f[0]=c.x,f[1]=c.y,f[2]=c.z,i.GetBehaviorManager().Transfer(0,s,f,l),i.GetTarget().FlagForCollision()}},n.prototype.ReplaceLinear=function(t,n){var r=new e.HKeyframeChannelLinear;r.cp=t,this.pArray.length>n&&(this.pArray[n]=r)},n.prototype.ReplaceCurve=function(t,n){var r=new e.HKeyframeChannelCurve;r.cp=t,this.pArray.length>n&&(this.pArray[n]=r)},n}(e.HBhvInterpolator);e.HBhvInterpolatorPosition=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(e,n){return e===void 0&&(e=null),n===void 0&&(n=null),t.call(this,e,n)||this}return __extends(n,t),n.prototype.GetType=function(){return"QuatRot"},n.ProcessXMLData=function(t,r){var i=t.getAttribute("Name");i||(i="");var s=/([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+(\])+/,o=new n(r,i),u=t.textContent;u+=" ";var a=0,f=0;for(;;){f=u.indexOf("]");if(f<=0||f>=u.length)break;var l=u.substr(0,f+1);u=u.substr(f+1),l=l.trim();var c=l.split(""),h=new e.Quaternion,p=e.HANIChannelType.HANILinear,d=!1,v=!1,m=!1,g=!1,y=0,b=!1;if(l){var w=c.indexOf("[");w>=0&&w<c.length&&(c=c.splice(w+1),l=l.substr(w+1));for(var E=0;E<c.length;++E){if(c[E]>="0"&&c[E]<="9"||c[E]=="-"){if(d)break;c=c.join("").trim().split("");var S=s.exec(c.join(""));S&&(h=new e.Quaternion(parseFloat(S[7]),parseFloat(S[1]),parseFloat(S[3]),parseFloat(S[5])));break}switch(c[E]){case"l":g=!0;continue;case"r":m=!0;continue;case"*":d=!0;continue}c[E]=" "}o.Insert(h,a),o.pArray[a].SetRelative(m),o.pArray[a].bLinear=g,o.pArray[a].ExtraSpins=y,o.pArray[a].SetConstant(d),a++}}r.AddInterpolator(o),r.GetTimeline()&&r.GetInterpolator(e.INTERPOLATOR_QUATROT)&&r.GetTimeline().AddTLRange()},n.prototype.Insert=function(t,n){n===void 0&&(n=0);var r=new e.HKeyframeQuatSquad;r.quat=t;var i=this.pArray.splice(n,this.pArray.length-n,r);this.pArray=this.pArray.concat(i)},n.prototype.Evaluate=function(e,t,n){n[2]=!0,n[3]=this.CalculateQuat(e,t)},n.prototype.SetTarget=function(){this.pTarget=this.GetAnimation().GetTarget().GetTargetKey()},n.prototype.InterpolateCamera=function(t,n){n===void 0&&(n=!1);var r=e.ArrayMaker.MakeNumArray(4,4);t.ToMatrix(r);var i=e.ArrayMaker.MakeNumArray(4,4);for(var s=0;s<4;s++)for(var o=0;o<4;o++)i[s][o]=r[s][o];var u=this.pAnimation.GetTarget().GetPivot(),a=e.ArrayMaker.MakeNumArray(3);a[0]=u.x,a[1]=u.y,a[2]=u.z;var f;f=this.pAnimation.GetTarget().GetResolvedPath(),this.GetAnimation().GetBehaviorManager().TransferCamera(f,1,a,i,this.GetAnimation().GetTarget().GetCameraType())},n.prototype.Interpolate=function(t,n){var r;this.pTarget==-1&&this.SetTarget(),r=this.CalculateQuat(t,n);if(this.GetAnimation().GetTarget().GetCameraType()!=e.HBhvCameraType.NoCamera){if(!this.GetAnimation().GetBehaviorManager().IsCameraPlay())return;this.GetAnimation().GetTarget().GetCameraType()==e.HBhvCameraType.CameraTargetFree||this.GetAnimation().GetTarget().GetCameraType()==e.HBhvCameraType.CameraPositionFree||this.GetAnimation().GetTarget().GetCameraType()==e.HBhvCameraType.CameraPositionTarget?this.InterpolateCamera2(r):this.InterpolateCamera(r)}else{var i=e.ArrayMaker.MakeNumArray(4,4);r.ToMatrix(i);var s=this.GetAnimation().GetTarget(),o=s.GetPivot(),u=e.ArrayMaker.MakeNumArray(3);u[0]=o.x,u[1]=o.y,u[2]=o.z;var a=void 0;a=this.pAnimation.GetTarget().GetResolvedPath(),this.GetAnimation().GetBehaviorManager().Transfer(1,a,u,i)}this.GetAnimation().GetTarget().FlagForCollision()},n.prototype.CalculateQuat=function(t,n){var r=new e.Quaternion,i=this.GetArray(),s=this.GetArrayLength(),o,u,a,f,l,c;if(t>=s-1)r=i[s-1].quat;else{u=i[t].quat,a=i[t+1].quat,t>0?o=i[t-1].quat:o=u,t<s-2?f=i[t+2].quat:f=a;if(i[t].ExtraSpins)r=e.Quaternion.QslerpNoInvertExtraSpins(u,a,n,i[t].ExtraSpins);else if(i[t].bLinear){var h=e.ArrayMaker.MakeNumArray(4),p=e.ArrayMaker.MakeNumArray(4),d=e.ArrayMaker.MakeNumArray(4);h[0]=u.x,h[1]=u.y,h[2]=u.z,h[3]=u.w,p[0]=a.x,p[1]=a.y,p[2]=a.z,p[3]=a.w,e.HUtility.TransitionQuaternion(h,p,n,d),r.x=d[0],r.y=d[1],r.z=d[2],r.w=d[3]}else l=e.Quaternion.Qspline(o,u,a),c=e.Quaternion.Qspline(u,a,f),r=e.Quaternion.Qsquad(u,a,l,c,n)}return r},n.prototype.Replace=function(t,n){var r=new e.HKeyframeQuatSquad;r.quat=t,this.pArray.length>n&&(this.pArray[n]=r)},n.prototype.ReplaceLinear=function(t,n){var r=new e.HKeyframeQuatSquad;r.quat=t,r.bLinear=!0,this.pArray.length>n&&(this.pArray[n]=r)},n.prototype.InsertLinear=function(t,n){n===void 0&&(n=0);var r=new e.HKeyframeQuatSquad;r.quat=t,r.bLinear=!0;if(n>=this.pArray.length)this.pArray.push(r);else{var i=this.pArray.splice(n,this.pArray.length-n,r);this.pArray=this.pArray.concat(i)}},n.prototype.InterpolateCamera2=function(e,t){t===void 0&&(t=!1)},n.prototype.AdjustQuaternions=function(){var t=this.GetArray(),n=this.GetArrayLength(),r=e.ArrayMaker.MakeNumArray(4),i=e.ArrayMaker.MakeNumArray(4),s;for(var o=0;o<n-1;o++){r[0]=t[o].quat.x,r[1]=t[o].quat.y,r[2]=t[o].quat.z,r[3]=t[o].quat.w,i[0]=t[o+1].quat.x,i[1]=t[o+1].quat.y,i[2]=t[o+1].quat.z,i[3]=t[o+1].quat.w;var u=void 0,a=void 0;u=(r[0]-i[0])*(r[0]-i[0])+(r[1]-i[1])*(r[1]-i[1])+(r[2]-i[2])*(r[2]-i[2])+(r[3]-i[3])*(r[3]-i[3]),a=(r[0]+i[0])*(r[0]+i[0])+(r[1]+i[1])*(r[1]+i[1])+(r[2]+i[2])*(r[2]+i[2])+(r[3]+i[3])*(r[3]+i[3]),a<u&&(s=new e.Quaternion(-i[3],-i[0],-i[1],-i[2]),t[o+1].bLinear?this.ReplaceLinear(s,o+1):this.Replace(s,o+1))}},n}(e.HBhvInterpolator);e.HBhvInterpolatorQuatSquad=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(e,n){return e===void 0&&(e=null),n===void 0&&(n=null),t.call(this,e,n)||this}return __extends(n,t),n.prototype.GetType=function(){return"Scale"},n.ProcessXMLData=function(t,r){var i=t.getAttribute("Name");i||(i="");var s=/([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+(\])+/,o=new n(r,i),u=t.textContent;u+=" ";var a=0,f=0;for(;;){f=u.indexOf("]");if(f<=0||f>=u.length)break;var l=u.substr(0,f+1);u=u.substr(f+1),l=l.trim();var c;if(l){var h=s.exec(l);h&&(c=new e.Vector3(parseFloat(h[1]),parseFloat(h[3]),parseFloat(h[5])),o.Insert(c,a++))}}r.AddInterpolator(o),r.GetTimeline()&&r.GetInterpolator(e.INTERPOLATOR_SCALE)&&r.GetTimeline().AddTLRange()},n.prototype.Insert=function(t,n){n===void 0&&(n=0);var r=new e.HKeyframeChannelLinear;r.cp=t;var i=this.pArray.splice(n,this.pArray.length-n,r);this.pArray=this.pArray.concat
(i)},n.prototype.CalculatePos=function(t,n){var r=new e.Vector3,i=this.GetArray(),s=this.GetArrayLength();return!this.GetAnimation().GetCurrentlyRunning()&&i[0].bConstant&&(i[0].cp=this.GetTranslationFromMatrix()),t>=s-1?r.copyFrom(this.pArray[s-1].cp):(r.copyFrom(this.pArray[t].Interpolate(i,t,n,s)),r.y=this.pArray[t].cp.y,r.z=this.pArray[t].cp.z),r},n.prototype.Interpolate=function(t,n){var r;this.pTarget===-1&&this.SetTarget();var i=this.GetAnimation();if(i===null)return;r=this.CalculatePos(t,n);if(this.GetAnimation().GetTarget().GetCameraType()!==0){if(!this.GetAnimation().GetBehaviorManager().IsCameraPlay())return;i.GetTarget().GetCameraType()===e.HBhvCameraType.CameraTargetFree||i.GetTarget().GetCameraType()===e.HBhvCameraType.CameraPositionFree||i.GetTarget().GetCameraType()===e.HBhvCameraType.CameraPositionTarget?this.InterpolateCamera2(r):this.InterpolateCamera(r)}else if(i.GetTarget().GetType()!=="IMAGE")return;this.GetAnimation().GetTarget().FlagForCollision()},n.prototype.SetTarget=function(){this.pTarget=this.GetAnimation().GetTarget().GetTargetKey()},n.prototype.InterpolateCamera=function(t,n){n===void 0&&(n=!1);var r=e.ArrayMaker.MakeNumArray(4,4);for(var i=0;i<4;i++)for(var s=0;s<4;s++)r[i][s]=0;r[3][0]=t.x,r[3][1]=t.y,r[3][2]=t.z;var o=this.pAnimation.GetTarget().GetPivot(),u=[o.x,o.y,o.z],a=this.pAnimation.GetTarget().GetResolvedPath();this.GetAnimation().GetBehaviorManager().TransferCamera(a,2,u,r,this.GetAnimation().GetTarget().GetCameraType()),n||this.GetAnimation().GetBehaviorManager().CameraUpdated()},n.prototype.InterpolateCamera2=function(e,t){t===void 0&&(t=!1)},n.prototype.Evaluate=function(e,t,n){n[4]=!0,n[5]=this.CalculatePos(e,t)},n}(e.HBhvInterpolator);e.HBhvInterpolatorScale=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(e,n){return e===void 0&&(e=null),n===void 0&&(n=null),t.call(this,e,n)||this}return __extends(n,t),n.prototype.GetType=function(){return"Visible"},n.ProcessXMLData=function(e,t){var r=e.getAttribute("Name");r||(r="");var i=new n(t,r),s=0,o=e.textContent;o=o.trim();var u=o.split(" ");for(var a=0;a<u.length;a++){var f=u[a];i.Insert(f,s++)}t.AddInterpolator(i)},n.prototype.Insert=function(t,n){n===void 0&&(n=0);var r=new e.HKeyframeString;r.target=t;var i=this.pArray.splice(n,this.pArray.length-n,r);this.pArray=this.pArray.concat(i)},n.prototype.Interpolate=function(t,n){n>.99999&&(t++,n=0);var r=this.GetArray(),i=this.GetArrayLength(),s="";s=this.GetAnimation().GetTarget().GetResolvedPath();var o=!0,u="";this.pTarget===-1&&this.SetTarget();var a="",f=0;if(this.GetAnimation().GetTarget().GetType()===e.TARGETOBJECTTYPE_CLIP){if(t<i-1){var l="";l=r[t+1].GetTarget(),a=r[t].GetTarget(),a==="on"||l==="on"?o=!0:o=!1}else o=!1;var c=this.pAnimation.GetCurrentTick(),h=this.pAnimation.GetFirstTick();c<h&&(o=!1);var p=[],d=[];return}this.GetAnimation().GetTarget().GetType()===e.TARGETOBJECTTYPE_ZOOM&&(u=this.pAnimation.GetName(),t===0&&Math.abs(n)<1e-5?a="off":t<i?a=r[t].GetTarget():a=r[i-1].GetTarget(),a==="off"?o=!1:a==="on"&&(o=!0),s=e.AnimationPlayApi.SAPlcPathToDispPlcPath(s),this.GetAnimation().GetBehaviorManager().TransferVisible(s,u,o,f));if(this.pAnimation.GetTarget().GetType()===e.TARGETOBJECTTYPE_IMAGE)return;if(t>=i-1)a=r[i-1].GetTarget(),a==="off"?o=!1:a==="on"&&(o=!0);else{var l="";a=r[t].GetTarget(),l=r[t+1].GetTarget();if(a===l){if(this.GetAnimation().GetBehaviorManager().IsPlaying())return;a==="off"?o=!1:o=!0}else a==="off"?n===0?o=!1:(o=!0,f=1-n):a==="on"&&(n===1?o=!1:(o=!0,f=n))}this.GetAnimation().GetTarget().GetType()===e.TARGETOBJECTTYPE_PMI,s=e.AnimationPlayApi.SAPlcPathToDispPlcPath(s),this.GetAnimation().GetBehaviorManager().TransferVisible(s,u,o,f)},n.prototype.SetTarget=function(){this.pTarget=this.GetAnimation().GetTarget().GetTargetKey()},n}(e.HBhvInterpolator);e.HBhvInterpolatorVisible=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){}return t.MtxTanslationToUniTanslation=function(t,n,r){var i=new e.Vector3(0,0,0),s=e.ArrayMaker.MakeNumArray(4,4);n.ToMatrix(s);var o=e.ArrayMaker.MakeNumArray(3);o[0]=r.x,o[1]=r.y,o[2]=r.z;var u=e.ArrayMaker.MakeNumArray(3);return u[0]=t.x,u[1]=t.y,u[2]=t.z,e.MatrixOperation.MtxTanslationToUniTanslation(u,s,o),i=new e.Vector3(o[0],o[1],o[2]),i},t.UniTanslationToMtxTanslation=function(t,n,r){var i=new e.Vector3(0,0,0),s=e.ArrayMaker.MakeNumArray(4,4);n.ToMatrix(s);var o=e.ArrayMaker.MakeNumArray(3);o[0]=r.x,o[1]=r.y,o[2]=r.z;var u=e.ArrayMaker.MakeNumArray(3);return u[0]=t.x,u[1]=t.y,u[2]=t.z,e.MatrixOperation.UniTanslationToMtxTanslation(u,s,o),i=new e.Vector3(o[0],o[1],o[2]),i},t.AddAnimation=function(t,n,r,i,s){if(null==t)return null;var o=new e.HBhvAnimation(n,t,s);return r&&(r==e.TARGETOBJECTTYPE_FOLDER?o.SetTargetByPath("",r):o.SetTargetByPath(n,r),i&&o.GetTarget().SetPivot(i.x,i.y,i.z)),s&&s.AddChildAnimation(o),t.AddAnimation(o),o},t.AddCameraKeyframe=function(t,n,r,i,s,o,u,a){var f,l,c;if(!n.GetTimeline()){var h=new e.HBhvTimeline;n.SetTimeline(h)}var p=n.GetInterpolatorList();for(var d=0;d<p.length;++d)p[d].GetType()==e.INTERPOLATOR_PIVOT&&(f=p[d]),p[d].GetType()==e.INTERPOLATOR_POS&&(l=p[d]),p[d].GetType()==e.INTERPOLATOR_QUATROT&&(c=p[d]),p[d].GetType()==e.INTERPOLATOR_SCALE;f||(f=new e.HBhvInterpolatorPivot,n.AddInterpolator(f)),l||(l=new e.HBhvInterpolatorPosition,n.AddInterpolator(l)),c||(c=new e.HBhvInterpolatorQuatSquad,n.AddInterpolator(c));var v,m=n.GetTimeline().AddKeyframe(r),g=m[0];v=m[1],g<=0&&(g=0),v?(f.Replace(i,g),a?(l.ReplaceLinear(s,g),c.ReplaceLinear(o,g)):(l.ReplaceCurve(s,g),c.Replace(o,g))):(f.Insert(i,g),a?(l.InsertLinear(s,g),c.InsertLinear(o,g)):(l.InsertCurve(s,g),c.Insert(o,g)))},t}();e.HBhvUtility=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){}return e.prototype.SetConstant=function(e){this.bConstant=e},e.prototype.SetEaseInOut=function(e){this.bEaseInOut=e},e.prototype.SetRelative=function(e){this.bRelative=e},e}();e.HKeyframe=t})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.HANILinear=0]="HANILinear",e[e.HANIHermiteSpline=1]="HANIHermiteSpline",e[e.HANIBezierSpline=2]="HANIBezierSpline",e[e.HANIFollowPath=3]="HANIFollowPath",e[e.HANIDiscrete=4]="HANIDiscrete"})(t=e.HANIChannelType||(e.HANIChannelType={}));var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.Interpolate=function(t,n,r,i){return new e.Vector3},n}(e.HKeyframe);e.HKeyframeChannel=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(n,r,i){n===void 0&&(n=0),r===void 0&&(r=0),i===void 0&&(i=0);var s=t.call(this)||this;return s.channeltype=e.HANIChannelType.HANIHermiteSpline,s.cp=new e.Vector3(n,r,i),s.tangent1=new e.Vector3,s.tangent2=new e.Vector3,s}return __extends(n,t),n.prototype.CalculateCurveFactor=function(e,t){var n,r,i,s=e.GetTimelineArray(),o=e.GetTimelineArrayLength();t>0&&t<o?n=s[t]-s[t-1]:n=0,t<o-1?r=s[t+1]-s[t]:r=0,t<o-2?i=s[t+2]-s[t+1]:i=0,this.factor1=2*r/(n+r),this.factor2=2*r/(r+i)},n.prototype.CalculateHermiteTangents=function(t,n,r,i){i===void 0&&(i=.5);var s=this.cp;i=.5,this.tangent1=new e.Vector3(i*(n.x-t.x),i*(n.y-t.y),i*(n.z-t.z)),this.tangent2=new e.Vector3(i*(r.x-s.x),i*(r.y-s.y),i*(r.z-s.z)),this.tangent1=new e.Vector3(this.factor1*this.tangent1.x,this.factor1*this.tangent1.y,this.factor1*this.tangent1.z),this.tangent2=new e.Vector3(this.factor2*this.tangent2.x,this.factor2*this.tangent2.y,this.factor2*this.tangent2.z)},n.prototype.Interpolate=function(e,t,n,r){var i,s,o,u;return s=e[t].cp,o=e[t+1].cp,t>0?i=e[t-1].cp:i=s,t<r-2?u=e[t+2].cp:u=o,this.InterpolateHermiteSpline(n,s,o)},n.prototype.InterpolateHermiteSpline=function(t,n,r){var i=new e.Vector3,s=t,o=t*t,u=t*t*t,a=2*u-3*o+1,f=-2*u+3*o,l=u-2*o+s,c=u-o;return i.x=a*n.x+f*r.x+l*this.tangent1.x+c*this.tangent2.x,i.y=a*n.y+f*r.y+l*this.tangent1.y+c*this.tangent2.y,i.z=a*n.z+f*r.z+l*this.tangent1.z+c*this.tangent2.z,i},n}(e.HKeyframeChannel);e.HKeyframeChannelCurve=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(n,r,i){n===void 0&&(n=0),r===void 0&&(r=0),i===void 0&&(i=0);var s=t.call(this)||this;return s.channeltype=e.HANIChannelType.HANIDiscrete,s.cp=new e.Vector3(n,r,i),s}return __extends(n,t),n}(e.HKeyframeChannel);e.HKeyframeChannelDiscrete=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n.channeltype=e.HANIChannelType.HANIFollowPath,n.bLinear=!1,n.tmatrix=e.ArrayMaker.MakeNumArray(16),n.tmatrix2=e.ArrayMaker.MakeNumArray(16),n}return __extends(n,t),n}(e.HKeyframeChannelCurve);e.HKeyframeChannelFollowPath=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(n,r,i){n===void 0&&(n=0),r===void 0&&(r=0),i===void 0&&(i=0);var s=t.call(this)||this;return s.channeltype=e.HANIChannelType.HANILinear,s.cp=new e.Vector3(n,r,i),s}return __extends(n,t),n.prototype.Interpolate=function(t,n,r,i){var s;return s=new e.Vector3(t[n+1].cp.x-t[n].cp.x,t[n+1].cp.y-t[n].cp.y,t[n+1].cp.z-t[n].cp.z),new e.Vector3(t[n].cp.x+s.x*r,t[n].cp.y+s.y*r,t[n].cp.z+s.z*r)},n}(e.HKeyframeChannel);e.HKeyframeChannelLinear=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t}(e.HKeyframe);e.HKeyframeRotation=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t}(e.HKeyframeRotation);e.HKeyframeQuatSquad=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.SetTarget=function(e){this.target=e},t.prototype.GetTarget=function(){return this.target},t}(e.HKeyframe);e.HKeyframeString=t})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.HTCS_Invalid=0]="HTCS_Invalid",e[e.HTCS_Once=1]="HTCS_Once",e[e.HTCS_Periodic=2]="HTCS_Periodic",e[e.HTCS_PeriodicSkip=3]="HTCS_PeriodicSkip"})(t=e.HTCStyle||(e.HTCStyle={}));var n=function(){function e(e,n,r,i){e===void 0&&(e=.1),n===void 0&&(n=t.HTCS_Invalid),r===void 0&&(r=null),i===void 0&&(i=null),this.mt_interval=e,this.mt_style=n,this.mt_next_request=0,this.mt_priority=0}return e.prototype.SetInterval=function(e){this.mt_interval=e},e.prototype.SetStyle=function(e){this.mt_style=e},e.prototype.SetNextRequest=function(e){this.mt_next_request=e},e.prototype.GetNextRequest=function(){return this.mt_next_request},e.prototype.GetPriority=function(){return this.mt_priority},e.prototype.GetInterval=function(){return this.mt_interval},e.prototype.GetStyle=function(){return this.mt_style},e.prototype.Tick=function(e,t){return!0},e}();e.HTClient=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(e){this.output_hz=e,this.interval=1/e,this.current_bucket=0}return t.GetHTManager=function(){return t.pHTManager||(t.pHTManager=new t(100)),t.pHTManager},t.prototype.UnRegisterClient=function(e){var t;if(!this.active_clients)return;for(var n=0;n<this.active_clients.length;++n)if(this.active_clients[n]==e){this.active_clients.splice(n,1);break}for(var n=0;n<this.spillover.length;++n)if(this.spillover[n]==e){this.spillover.splice(n,1);break}t=this.actual_time+2,this.recently_deleted_clients.push(e),this.recently_deleted_expirations.push(t)},t.prototype.Tick=function(t){var n=!0,r,i,s;this.buckets==null&&this.Init(t),this.actual_time=t;while(this.request_time+this.interval<this.actual_time){while(this.buckets[this.current_bucket].length!=0){var o=this.buckets[this.current_bucket][0];this.buckets[this.current_bucket].splice(0,1);var u=!1;for(var a=0;a<this.active_clients.length;++a)if(this.active_clients[a]==o){u=!0;break}if(u){r=o.GetInterval();switch(o.GetStyle()){case e.HTCStyle.HTCS_PeriodicSkip:n=o.Tick(this.request_time,this.actual_time),n&&this.ScheduleNextTick(o,this.actual_time+r)}}}this.current_bucket++,this.request_time+=this.interval;if(this.current_bucket==this.output_hz){while(this.spillover.length>0){o=this.spillover[0],i=o.GetNextRequest();if(i-this.request_time>=1)break;this.spillover.splice(0,1),this.ScheduleNextTick(o,i)}this.current_bucket=0;for(;this.recently_deleted_expirations.length>0;){s=this.recently_deleted_expirations[0];if(!(s&&s!=0&&s<this.actual_time))break;this.recently_deleted_clients.splice(0,1),this.recently_deleted_expirations.splice(0,1)}}}},t.prototype.RegisterClient=function(e){var t;this.buckets==null&&this.Init(e.GetNextRequest());for(t=0;t<this.active_clients.length;++t)if(this.active_clients[t]===e)return;for(t=0;t<this.recently_deleted_clients.length;++t)if(this.recently_deleted_clients[t]===e){for(var n=0;n<this.output_hz;n++)for(var r=0;r<this.buckets[n].length;++r)if(this.buckets[n][r]==e){this.buckets[n].splice(r,1);break}for(var r=0;r<this.spillover.length;++r)if(this.spillover[r]===e){this.spillover.splice(r,1);break}break}this.active_clients.push(e),this.ScheduleNextTick(e,e.GetNextRequest())},t.prototype.ScheduleNextTick=function(e,t){var n,r,i;t<this.request_time&&(t=this.request_time+this.interval),e.SetNextRequest(t);if(t-this.request_time>=1){this.spillover.length>0&&(n=this.spillover[0]);if(n==null||t<n.GetNextRequest()){var s=new Array;s.push(e);for(var o=0;o<this.spillover.length;++o)s.push(this.spillover[o]);this.spillover=s}else for(var o=0;o<this.spillover.length;++o){if(o+1==this.spillover.length){this.spillover.push(e);break}if(t<this.spillover[o+1].GetNextRequest()){var s=this.spillover.splice(o+1,this.spillover.length-o-1,e);this.spillover=this.spillover.concat(s);break}}return}i=(t-this.request_time)*this.output_hz,i<=0&&(i=1),r=(this.current_bucket+i)%this.output_hz,r-=r%1;if(e.GetPriority()==0){var s=new Array;s.push(e),s=s.concat(this.buckets[r]),this.buckets[r]=s}else this.buckets[r].push(e)},t.prototype.Init=function(e){var t;if(this.buckets==null){this.buckets=new Array;for(t=0;t<this.output_hz;t++)this.buckets.push(new Array)}this.spillover==null&&(this.spillover=Array()),this.active_clients==null&&(this.active_clients=Array()),this.recently_deleted_clients==null&&(this.recently_deleted_clients=Array()),this.recently_deleted_expirations==null&&(this.recently_deleted_expirations=Array()),this.request_time=this.actual_time=e},t}();e.HTManager=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){}return e.PA=function(e,t,n){return e*e*.5*t/n},e.PB=function(t,n,r){return e.PA(r,n,r)+(t-r)*n},e.PC=function(t,n,r,i,s){return e.PB(r+i,n,r)+(t-(r+i))*n*(1-.5*(t-(r+i))/s)},e.EaseInEaseOut=function(t,n,r,i){var s,o=2/(n+2*r+i);return t<=n?s=e.PA(t,o,n):t>=n&&t<=n+r?s=e.PB(t,o,n):s=e.PC(t,o,n,r,i),s>1&&(s=1),s},e.ComputeDoublePrecisionVectorLength=function(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])},e.TransitionQuaternion=function(e,t,n,r){var i,s,o,u,a,f=0,l=1,c=2,h=3,p=1e-5,d=3.1415926;s=e[f]*t[f]+e[l]*t[l]+e[c]*t[c]+e[h]*t[h];if(1+s>p){1-s>p?(i=Math.acos(s),o=Math.sin(i),u=Math.sin((1-n)*i)/o,a=Math.sin(n*i)/o):(u=1-n,a=n);for(var v=0;v<4;v++)r[v]=u*e[v]+a*t[v]}else{r[f]=-e[l],r[l]=e[f],r[c]=-e[h],r[h]=e[c],u=Math.sin((1-n)*d/2),a=Math.sin(n*d/2);for(var v=0;v<3;v++)r[v]=u*e[v]+a*r[v]}},e}();e.HUtility=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){}return t.MtxTanslationToUniTanslation=function(e,t,n){t[3][0]=n[0],t[3][1]=n[1],t[3][2]=n[2],n[0]=e[0]*t[0][0]+e[1]*t[1][0]+e[2]*t[2][0]+t[3][0],n[1]=e[0]*t[0][1]+e[1]*t[1][1]+e[2]*t[2][1]+t[3][1],n[2]=e[0]*t[0][2]+e[1]*t[1][2]+e[2]*t[2][2]+t[3][2],n[0]=n[0]-e[0],n[1]=n[1]-e[1],n[2]=n[2]-e[2]},t.MatrixInversion=function(t,n){n===void 0&&(n=4);var r,i,s,o,u=e.ArrayMaker.MakeNumArray(4,4),a=e.ArrayMaker.MakeNumArray(4,4),f=e.ArrayMaker.MakeNumArray(4),l,c,h,p,d;l=n*4;for(var v=0;v<4;++v)for(var m=0;m<4;++m)a[v][m]=t[v][m];for(h=0;h<n;h++)for(p=0;p<n;p++)u[h][p]=0;for(h=0;h<n;h++)u[h][h]=1;for(p=0;p<n;p++){c=p,r=a[p][p];for(h=p+1;h<n;h++)Math.abs(r)<Math.abs(a[h][p])&&(c=h,r=a[h][p]);if(Math.abs(r)<1e-6)return;if(c!=p){var g=a[p];a[p]=a[c],a[c]=g,g=u[p],u[p]=u[c],u[c]=g}s=a[p];for(h=p+1;h<n;h++)s[h]/=r;s=u[p];for(h=0;h<n;h++)s[h]/=r;for(h=0;h<n;h++)if(h!=p){i=a[h][p];for(d=p+1;d<n;d++)a[h][d]-=a[p][d]*i;for(d=0;d<n;d++)u[h][d]-=u[p][d]*i}}for(h=0;h<n;h++)for(p=0;p<n;p++)t[h][p]=u[h][p];return},t.Multiply=function(e,t,n,r,i,s){r===void 0&&(r=4),i===void 0&&(i=4),s===void 0&&(s=4);var o,u,a;for(o=0;o<r;o++)for(u=0;u<s;u++){n[o][u]=0;for(a=0;a<i;a++)n[o][u]+=e[o][a]*t[a][u]}},t.UniTanslationToMtxTanslation=function(n,r,i){r[3][0]=r[3][1]=r[3][2]=0;var s=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[i[0],i[1],i[2],1]],o=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[n[0],n[1],n[2],1]],u=e.ArrayMaker.MakeNumArray(4,4);for(var a=0;a<4;a++)for(var f=0;f<4;f++)u[a][f]=o[a][f];t.MatrixInversion(u,4);var l=e.ArrayMaker.MakeNumArray(4,4),c=e.ArrayMaker.MakeNumArray(4,4);t.Multiply(u,r,l),t.Multiply(l,o,c),t.Multiply(c,s,l),i[0]=l[3][0],i[1]=l[3][1],i[2]=l[3][2]},t.FromQuat=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d;n=2/(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]+e[3]*e[3]),r=e[0]*n,i=e[1]*n,s=e[2]*n,o=e[3]*r,u=e[3]*i,a=e[3]*s,f=e[0]*r,l=e[0]*i,c=e[0]*s,h=e[1]*i,p=e[1]*s,d=e[2]*s,t=[[1-(h+d),l+a,c-u,0],[l-a,1-(f+d),p+o,0],[c+u,p-o,1-(f+h),0],[0,0,0,1]]},t}();e.MatrixOperation=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(e,t,n){this.TargetObjectList=new Array,this.ID=e,n?this.Name=n:this.Name="Step "+(e+1).toString(),this.Desc="",this.nBehaviorManagerID=t,this.TickCount=0,this.PreTickCount=0}return t.prototype.SetPreTickCount=function(e){this.PreTickCount=e},t.prototype.GetPreTickCount=function(){return this.PreTickCount},t.prototype.GetTickCount=function(){return this.TickCount},t.prototype.CaculateTickCount=function(){var e=this.GetBehaviorManager();e?this.TickCount=e.GetTickCount():this.TickCount=0},t.prototype.SetBehaviorManagerID=function(e){this.nBehaviorManagerID=e},t.ProcessXMLData=function(t,n){var r=t.getAttribute("ID");r||(r=0);var i=t.getAttribute("Name");i||(i="Step"+(r+1));var s=t.getAttribute("Desc");s||(s="");var o=t.getAttribute("BehavivorManagerID");o||(o=0);var u=n.AddProcess(r,i,!1);u.SetBehaviorManagerID(o),u.GetBehaviorManager()&&(i=u.GetBehaviorManager().GetName(),i&&i!=""&&u.SetName(i)),u.SetDesc(s);for(var a=0;a<t.childNodes.length;++a){var f=t.childNodes[a];if(f.nodeType===1){var l=f.nodeName;switch(l){case"ProcessTargetObject":e.ProcessTargetObject.ProcessXMLData(f,u)}}}return u},t.prototype.GetID=function(){return this.ID},t.prototype.SetID=function(e){this.ID=e},t.prototype.GetBehaviorManagerID=function(){return this.nBehaviorManagerID},t.prototype.GetBehaviorManager=function(){var e;return this.pProcessManager&&this.pProcessManager.GetAnimationStepManager()&&this.pProcessManager.GetAnimationStepManager().GetSimulationAnimationManager()&&(e=this.pProcessManager.GetAnimationStepManager().GetSimulationAnimationManager().FindSimAniByID(this.nBehaviorManagerID)),e},t.prototype.FindTargetObjectByID=function(e){for(var t=0;t<this.TargetObjectList.length;++t)if(e==this.TargetObjectList[t].GetTargetKey())return this.TargetObjectList[t];return null},t.prototype.SetProcessManager=function(e){this.pProcessManager=e},t.prototype.GetName=function(){return this.Name},t.prototype.GetProcessManager=function(){return this.pProcessManager},t.prototype.TargetObject2StructInfo=function(t,n){if(t){n.Name=t.GetName(),n.ID=t.GetTargetKey(),n.Path=t.GetPath();if(t.GetType()=="PLCID")n.InsPath=t.GetResolvedPath(),n.EntId=0;else if(t.GetType()=="PMI"){var r=t.GetInsPathAndPMIIdByResolvedPath(n.InsPath);n.EntId=parseFloat(r)}n.Pos[0]=t.GetPos().x,n.Pos[1]=t.GetPos().y,n.Pos[2]=t.GetPos().z,n.Quat[0]=t.GetQuat().x,n.Quat[1]=t.GetQuat().y,n.Quat[2]=t.GetQuat().z,n.Quat[3]=t.GetQuat().w,n.Scale[0]=t.GetScale().x,n.Scale[1]=t.GetScale().y,n.Scale[2]=t.GetScale().z,n.bVisible=t.GetVisible(),n.Trans=t.GetTrans(),t.GetType()=="PLCID"?n.Type=e.TargetObjectType.TARGETOBJECT_TYPE_INS:t.GetType()=="CAMERA"?n.Type=e.TargetObjectType.TARGETOBJECT_TYPE_CAM:t.GetType()=="PMI"?n.Type=e.TargetObjectType.TARGETOBJECT_TYPE_PMI:t.GetType()=="IMAGE"&&(n.Type=e.TargetObjectType.TARGETOBJECT_TYPE_IMAGE)}},t.prototype.UpdateView=function(t,n,r){t===void 0&&(t=!0),n===void 0&&(n=!1),r===void 0&&(r=!1);var i=this.GetProcessManager().GetAnimationStepManager();if(!i)return;var s=this.GetProcessManager().GetAnimationStepManager().GetSimulationAnimationManager(),o=s.IsCameraPlay();s.SetCameraPlay(!1),s.IsPlaying()&&s.StopAll();var u=new Array,a=s.GetInitTargetObjectList(),f;for(var l=0;l<a.length;l++){f=a[l];var c=f.GetCameraType();if(c==e.HBhvCameraType.NoCamera&&!t||c!=e.HBhvCameraType.NoCamera&&!n||c!=e.HBhvCameraType.NoCamera&&n&&r)continue;var h;if(h=this.FindTargetObjectByID(f.GetTargetKey())){var p=new e.TargetObjectInfo;this.TargetObject2StructInfo(h,p),u.push(p)}else{var p=new e.TargetObjectInfo;this.TargetObject2StructInfo(f,p),u.push(p)}}s.GetAnimationPlayApi()&&u.length>0&&s.GetAnimationPlayApi().SetTargetState(u);for(var l=0;l<u.length;l++)delete u[l];u=[];if(t||n){n&&!r&&s.SetCameraPlay(!0);var d=this.GetBehaviorManager();d&&(s.GetReversePlay()&&i.GetPlayMode()!=e.AnimationPlayMode.PLAY_MODE_NONE?d.RewindReverse():d.Rewind())}s.SetCameraPlay(o),n&&r&&i.StartChangeCamera(this,!0)},t.prototype.GetSimulationAnimationManager=function(){var e;return this.GetProcessManager()&&(e=this.GetProcessManager().GetAnimationStepManager()),e?e.GetSimulationAnimationManager():null},t.prototype.GetCamera=function(t,n,r){var i=!1;t=new e.Vector3(0,0,0),n=new e.Quaternion(0,0,0,0),r=new e.Vector3(0,0,0);var s=this.GetBehaviorManager();if(s){var o;o=e.TARGETOBJECTTYPE_CAM,o+=":SCENE/TARGET";var u=s.FindAnimation(o,e.INTERPOLATOR_POS);if(u&&u.GetTimeline()&&u.GetTimeline().GetTimelineArrayLength()>0){var a=0;this.GetSimulationAnimationManager().GetReversePlay()&&(a=u.GetTimeline().GetTimelineArrayLength()-1);var f=u.GetInterpolatorList();for(var l=0;l<f.length;++l)f[l].GetType()==e.INTERPOLATOR_POS?t=f[l].GetAt(a).cp:f[l].GetType()==e.INTERPOLATOR_QUATROT?n=f[l].GetAt(a).quat:f[l].GetType()==e.INTERPOLATOR_SCALE&&(r=f[l].GetAt(a).cp);var c=e.ArrayMaker.MakeNumArray(4,4);n.ToMatrix(c),c[3][0]=t.x,c[3][1]=t.y,c[3][2]=t.z,e.MatrixOperation.MatrixInversion(c),n=e.Quaternion.MatrixToQuaternion(c),t.x=c[3][0],t.y=c[3][1],t.z=c[3][2],i=!0}}if(!i){var h=this.GetCameraTargetObject(!1);h&&(t=h.GetPos(),n=h.GetQuat(),r=h.GetScale(),i=!0)}return i},t.prototype.GetCameraTargetObject=function(t){var n;n=e.TARGETOBJECTTYPE_CAM,n=":SCENE/TARGET";var r=this.FindTargetObjectByPath(n);return!r&&t&&(r=this.CreateTargetObjectByPath("Camera",n)),r},t.prototype.FindTargetObjectByPath=function(e){for(var t=0;t<this.TargetObjectList.length;++t){var n=this.TargetObjectList[t];if(n.IsEqual(e))return n}return null},t.prototype.CreateTargetObjectByPath=function(t,n){var r;return(r=this.FindTargetObjectByPath(n))||(r=new e.ProcessTargetObject(this,t,n),this.AddTargetObject(r)),r},t.prototype.AddTargetObject=function(e){this.TargetObjectList.push(e)},t.prototype.SetName=function(e){if(!e)return;this.Name=e,this.GetBehaviorManager()&&this.GetBehaviorManager().SetName(e)},t.prototype.DeleteAllTargetObject=function(){this.TargetObjectList=[]},t.prototype.SetDesc=function(e){this.Desc=e},t.prototype.GetDesc=function(){return this.Desc},t}();e.Process=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(e,t){e===void 0&&(e=0),t===void 0&&(t=null),this.ID=e,this.ProcessList=[],this.CurProcessID=-1,t?this.Name=t:this.Name="过程"+(e+1).toString(),this.Desc="",this.pAnimationStepManager=null,this.TickCount=0,this.PreTickCount=0}return t.prototype.SetPreTickCount=function(e){this.PreTickCount=e},t.prototype.GetPreTickCount=function(){return this.PreTickCount},t.prototype.GetTickCount=function(){return this.TickCount},t.prototype.CaculateTickCount=function(){this.TickCount=0;for(var e=0;e<this.ProcessList.length;++e)this.ProcessList[e].SetPreTickCount(this.PreTickCount+this.TickCount),this.ProcessList[e].CaculateTickCount(),this.TickCount+=this.ProcessList[e].GetTickCount()},t.prototype.GetType=function(){return"CProcessManager"},t.prototype.GetID=function(){return this.ID},t.prototype.GetCurrentProcess=function(){return-1!=this.CurProcessID?this.FindProcessByID(this.CurProcessID):null},t.prototype.GetProcessCount=function(){return this.ProcessList.length},t.prototype.GetAnimationStepManager=function(){return this.pAnimationStepManager},t.prototype.FindProcessByID=function(e){for(var t=0;t<this.ProcessList.length;++t)if(this.ProcessList[t].GetID()==e)return this.ProcessList[t];return null},t.prototype.GetProcessByIdx=function(e){var t;return this.ProcessList.length>0&&this.ProcessList.length>e&&(t=this.ProcessList[e]),t},t.prototype.GetProcessIdxByID=function(e){for(var t=0;t<this.ProcessList.length;++t)if(this.ProcessList[t].GetID()==e)return t;return-1},t.prototype.GetCurProcessID=function(){return this.CurProcessID},t.prototype.UpdateViewWithProcess=function(t){var n=this.pAnimationStepManager.GetSimulationAnimationManager(),r=n.IsCameraPlay();n.SetCameraPlay(!1);if(!n.IsPlaying()){for(var i=0;i<t;i++){var s=this.GetProcessByIdx(i);if(s){var o=s.GetBehaviorManager();o&&o.RewindReverse()}}for(var i=this.GetProcessCount()-1;i>t;i--){var s=this.GetProcessByIdx(i);if(s){var o=s.GetBehaviorManager();o&&o.Rewind()}}var s=this.GetProcessByIdx(t);if(s){var o=s.GetBehaviorManager();o&&(n.GetReversePlay()&&this.pAnimationStepManager.GetPlayMode()!=e.AnimationPlayMode.PLAY_MODE_NONE?o.RewindReverse():o.Rewind())}}n.SetCameraPlay(r)},t.prototype.GetPreProcess=function(e){var t=null,n=this.GetProcessIdxByID(e.GetID());return n>0&&(t=this.GetProcessByIdx(n-1)),t},t.prototype.GetNextProcess=function(e){if(!e)return null;var t=null,n=this.GetProcessIdxByID(e.GetID());return n<this.GetProcessCount()-1&&(t=this.GetProcessByIdx(n+1)),t},t.prototype.SetCurProcessByIdx=function(e,t,n,r){t===void 0&&(t=!0),n===void 0&&(n=!1),r===void 0&&(r=!1);var i=this.pAnimationStepManager.GetSimulationAnimationManager(),s=this.GetProcessByIdx(e);if(s){if(this.CurProcessID!=s.GetID()){this.CurProcessID=s.GetID();if(this.GetAnimationStepManager())if(this.GetAnimationStepManager().GetCurProcessManagerID()!=this.ID)this.GetAnimationStepManager().SetCurProcessManagerByID(this.ID,t,n,r);else{var o=this.GetCurrentProcess();o&&o.UpdateView(t,n,r);if(t){var u=this.GetAnimationStepManager().GetProcessManagerIdxByID(this.ID);this.GetAnimationStepManager().UpdateViewWithProcessManager(u)}n&&this.GetAnimationStepManager().StartChangeCamera(s,r)}}else this.GetAnimationStepManager().GetCurProcessManagerID()!=this.ID&&this.GetAnimationStepManager().SetCurProcessManagerByID(this.ID,t,n,r);i.SetCurSAByID(s.GetBehaviorManagerID())}},t.prototype.SetCurProcessByID=function(e,t,n,r){t===void 0&&(t=!0),n===void 0&&(n=!1),r===void 0&&(r=!1);var i=this.pAnimationStepManager.GetSimulationAnimationManager();if(this.CurProcessID!=e){this.CurProcessID=e;if(this.GetAnimationStepManager())if(this.GetAnimationStepManager().GetCurProcessManagerID()!=this.ID)this.GetAnimationStepManager().SetCurProcessManagerByID(this.ID,t,n,r);else{var s=this.GetCurrentProcess();s&&s.UpdateView(t,n,r)}}else this.GetAnimationStepManager().GetCurProcessManagerID()!=this.ID&&this.GetAnimationStepManager().SetCurProcessManagerByID(this.ID,t,n,r);var o=this.GetCurrentProcess();o&&i.SetCurSAByID(o.GetBehaviorManagerID())},t.prototype.SetName=function(e){if(!e)return;this.Name=e},t.prototype.DeleteAllProcess=function(){this.ProcessList=[],this.CurProcessID=-1},t.prototype.SetAnimationStepManager=function(e){this.pAnimationStepManager=e},t.ProcessXMLData=function(t,n){var r=t.getAttribute("ID");r||(r=0);var i=t.getAttribute("Name");i||(i="Process"+(r+1));var s=t.getAttribute("Desc");s||(s="");var o=t.getAttribute("CurProcessID");o||(o=0);var u=n.AddProcessManager(r,i);for(var a=0;a<t.childNodes.length;++a){var f=t.childNodes[a];if(f.nodeType===1){var l=f.nodeName;switch(l){case"Process":e.Process.ProcessXMLData(f,u)}}}return u.SetCurProcessByID(o,!1),u.SetDesc(s),u},t.prototype.AddProcess=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length!=1){var i=t[0],s=t[1],o=t[2],r;if((r=this.FindProcessByID(i))&&i>0)r.SetName(s),r.DeleteAllTargetObject(),this.pAnimationStepManager&&this.pAnimationStepManager.GetSimulationAnimationManager()&&this.pAnimationStepManager.GetSimulationAnimationManager().FindSimAniByID(r.GetBehaviorManagerID())&&this.pAnimationStepManager.GetSimulationAnimationManager().FindSimAniByID(r.GetBehaviorManagerID()).DeleteAllAnimations();else{var u,a=0;this.pAnimationStepManager&&this.pAnimationStepManager.GetSimulationAnimationManager()&&(o?(a=this.pAnimationStepManager.GetSimulationAnimationManager().RegisterBehaviorManagerID(),u=this.pAnimationStepManager.GetSimulationAnimationManager().AddSimAni(a)):a=this.pAnimationStepManager.GetSimulationAnimationManager().GetCurSAID()),i==-1?r=new e.Process(this.RegisterProcessID(),a,s):r=new e.Process(i,a,s),u&&u.SetName(r.GetName()),this.AddProcess(r)}return r}var r=t[0];null!=r&&(this.ProcessList.push(r),this.CurProcessID=r.GetID(),r.SetProcessManager(this))},t.prototype.RegisterProcessID=function(){var e=0;for(var t=0;t<this.ProcessList.length;++t)this.ProcessList[t].GetID()>=e&&(e=this.ProcessList[t].GetID()+1);return e},t.prototype.GetProcessList=function(){return this.ProcessList},t.prototype.GetName=function(){return this.Name},t.prototype.SetDesc=function(e){this.Desc=e},t.prototype.GetDesc=function(){return this.Desc},t}();e.ProcessManager=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(e,t,n){n===void 0&&(n=null),e?this.Name=e:this.Name="",this.InstanceOf="",this.Loop=0,this.pParentAnimation=n,this.pTimeline=null,this.pInstancedAnimation=null,this.pBehaviorManager=t,this.Delay=0,this.InterpolatorList=[],this.ChildAnimationList=[],this.bCurrentlyRunning=!1,this.bDefaultActive=!0,this.Target=null,this.bExecuteOnce=!1,this.bExpanded=!1,this.bLocked=!1,this.pGroupAnimation=null}return t.prototype.SetTimeline=function(e){this.pTimeline=e,this.pTimeline&&this.pTimeline.SetAnimation(this)},t.prototype.AddChildAnimation=function(e){this.ChildAnimationList.push(e),e.pParentAnimation=this},t.ProcessXMLData=function(n,r){var i=n.getAttribute("Delay"),s=n.getAttribute("Target"),o=n.getAttribute("TargetID"),u=n.getAttribute("Name"),a=n.getAttribute("Expand"),f=n.getAttribute("InstanceOf"),l=0,c;if(!f||f===""){(l=n.getAttribute("Loop"))||(l=0);if(!r)return null;if(r instanceof t){var h=r;c=new t(u,h.pBehaviorManager,h),c.Loop=l,c.Delay=i,c.bExpanded=a!=0,h.AddChildAnimation(c),h.pBehaviorManager.AddAnimation(c)}else if(r instanceof e.HBhvBehaviorManager){var p=r;c=new t(u,p,null),c.Loop=l,c.Delay=i,c.bExpanded=a!=0,p.AddAnimation(c)}if(c){var d=!1;n.getAttribute("Active")||(d=!0),c.bDefaultActive=d,s&&s!=""?c.SetTargetByPath("",s):c.SetTargetByKey(o)}}for(var v=0;v<n.childNodes.length;++v){var m=n.childNodes[v];if(m.nodeType===1){var g=m.nodeName;switch(g){case"Animation":t.ProcessXMLData(m,c);break;case"Timeline":e.HBhvTimeline.ProcessXMLData(m,c);break;case"PivotInterpolator":e.HBhvInterpolatorPivot.ProcessXMLData(m,c);break;case"PosInterpolator":e.HBhvInterpolatorPosition.ProcessXMLData(m,c);break;case"QuatRotInterpolator":e.HBhvInterpolatorQuatSquad.ProcessXMLData(m,c);break;case"ScaleInterpolator":e.HBhvInterpolatorScale.ProcessXMLData(m,c);break;case"VisibleInterpolator":e.HBhvInterpolatorVisible.ProcessXMLData(m,c);break;case"ColorInterpolator":e.HBhvInterpolatorColor.ProcessXMLData(m,c)}}}return c},t.prototype.SetDefaultActive=function(e){this.bDefaultActive=e},t.prototype.GetDefaultActive=function(){return this.bDefaultActive},t.prototype.GetLoop=function(){return this.Loop},t.prototype.GetLastTick=function(){return this.GetTimeline()&&this.GetTimeline().GetTimelineArrayLength()>0?this.GetTimeline().GetTimelineArray()[this.GetTimeline().GetTimelineArrayLength()-1]:0},t.prototype.AddInterpolator=function(e){this.InterpolatorList.push(e),e&&e.SetAnimation(this)},t.prototype.ExecuteOnce=function(){return this.bExecuteOnce},t.prototype.SetExecuteOnce=function(e){this.bExecuteOnce=e},t.prototype.GetDelay=function(){return this.Delay},t.prototype.Reset=function(){for(var e=0;e<this.InterpolatorList.length;++e){if(this.InterpolatorList[e].GetType()=="QuatRot"){var t=this.InterpolatorList[e];t.AdjustQuaternions()}this.InterpolatorList[e].Reset()}this.bCurrentlyRunning=!1},t.prototype.GetFirstTick=function(){return this.GetTimeline()&&this.GetTimeline().GetTimelineArrayLength()>0?this.GetTimeline().GetTimelineArray()[0]:0},t.prototype.Animate=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];if(e.length==1){this.pTimeline.SetCheckRelativeFrame(!0);var n=this.AnimateInternal(e[0]);for(var r=0;r<this.ChildAnimationList.length;++r)this.ChildAnimationList[r].GetDefaultActive()&&this.ChildAnimationList[r].Animate(e[0],this.GetTimeline().GetStartTick())
;return n}if(e.length==2){this.pTimeline.SetStartTick(e[1]),this.pTimeline.SetCheckRelativeFrame(!1);var n=this.AnimateInternal(e[0]);for(var r=0;r<this.ChildAnimationList.length;++r)this.ChildAnimationList[r].GetDefaultActive()&&this.ChildAnimationList[r].Animate(e[0],e[1]);return n}return!1},t.prototype.GetTarget=function(){return this.Target},t.prototype.GetBehaviorManager=function(){return this.pBehaviorManager},t.prototype.SetBehaviorManager=function(e){this.pBehaviorManager=e},t.prototype.GetTimeline=function(){return this.pTimeline},t.prototype.GetParentAnimation=function(){return this.pParentAnimation},t.prototype.Evaluate=function(e,t){var n,r,i=this.pTimeline.Evaluate(e,n,r);n=i[1],r=i[2];if(i[0]){0>r&&(r=0);for(var s=0;s<this.InterpolatorList.length;++s)this.InterpolatorList[s].Evaluate(n,r,t)}},t.prototype.GetName=function(){return this.Name},t.prototype.GetCurrentTick=function(){return this.pBehaviorManager.GetCurrentTick()},t.prototype.GetCurrentlyRunning=function(){return this.bCurrentlyRunning},t.prototype.AnimateInternal=function(t){var n,r;if(this.GetTarget()&&this.GetTarget().GetType()=="GROUPID")return!1;if(this.GetBehaviorManager()&&this.GetBehaviorManager().IsPlaying()&&this.GetLoop()==0){var i=this.GetBehaviorManager().GetCurrentTick(),s=this.GetBehaviorManager().GetPreTick();if(i>this.GetLastTick()&&s>this.GetLastTick()||i<this.GetFirstTick()&&s<this.GetFirstTick())return!1}var o=this.pTimeline.Evaluate(t,n,r);n=o[1],r=o[2];if(o[0]){0>r&&(r=0);var u=this.GetTimeline(),a=u.GetTimelineArrayLength(),f=0,l=0;n>=a-1?f=l=a-1:r<1?(f=n,l=n+1):f=l=n+1;for(var c=0;c<this.InterpolatorList.length;++c)if(this.InterpolatorList[c].GetType()=="Pivot"){var h=new e.Vector3(this.InterpolatorList[c].GetAt(f).cp);this.GetTarget().SetPrePivot(h),h=new e.Vector3(this.InterpolatorList[c].GetAt(l).cp),this.GetTarget().SetPivot(h)}else if(this.InterpolatorList[c].GetType()=="QuatRot"){var p=this.InterpolatorList[c].GetAt(f).quat;this.GetTarget().SetPreQuat(p.x,p.y,p.z,p.w),p=this.InterpolatorList[c].GetAt(l).quat,this.GetTarget().SetQuat(p.x,p.y,p.z,p.w)}for(var c=0;c<this.InterpolatorList.length;++c)this.InterpolatorList[c].Interpolate(n,r);this.SetCurrentlyRunning(!0);if(!this.GetBehaviorManager().IsReversePlay()&&n==a)return!0}return!1},t.prototype.SetCurrentlyRunning=function(e){this.bCurrentlyRunning=e},t.prototype.GetInterpolator=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];if(e.length==1){for(var n=0;n<this.InterpolatorList.length;++n)if(this.InterpolatorList[n].GetType()===e[0])return this.InterpolatorList[n];return null}return this.InterpolatorList.length>0?this.InterpolatorList[0]:null},t.prototype.GetInterpolatorList=function(){return this.InterpolatorList},t.prototype.SetTargetByPath=function(e,t){t?this.Target=this.pBehaviorManager.CreateTargetObjectByPath(e,t):this.Target=null},t.prototype.SetTargetByKey=function(e){e!=-1?this.Target=this.pBehaviorManager.GetTargetObjectByKey(e):this.Target=null},t.prototype.SetParentAnimation=function(e){this.pParentAnimation=e},t.prototype.IsAnimationInterval=function(e,t){var n=!0;if(this.pTimeline==null)return n;if(e<this.pTimeline.GetTimelineArrayLength()&&t<this.pTimeline.GetTimelineArrayLength()){var r=this.GetTimeline(),i=r.GetTimelineArrayLength();if(e>=i||t>=i)return!1;var s=!0;for(var o=0;o<this.InterpolatorList.length;++o)e<this.InterpolatorList[o].GetArrayLength()&&(s=this.IsAniIntervalByHKeyFrame(this.InterpolatorList[o],e,t),n=n&&s);return this.InterpolatorList.length<=0&&(n=!1),n}return n},t.prototype.IsAniIntervalByHKeyFrame=function(t,n,r){var i=!1,s=null,o=null;if(!t)return!1;var u=t.GetArray();n>=0&&n<t.GetArrayLength()&&(s=u[n]);if(r>=0&&r<t.GetArrayLength()){o=u[r];var a=s.type,f=-1,l=!1;a==e.HANIKeyframeType.HANIChannel&&(f=s.channeltype),a==e.HANIKeyframeType.HANIRotation&&(f=s.rotationtype,l=s.bLinear);if(a!=e.HANIKeyframeType.HANIChannel||f!=e.HANIChannelType.HANILinear&&f!=e.HANIChannelType.HANIHermiteSpline&&f!=e.HANIChannelType.HANIDiscrete&&f!=e.HANIChannelType.HANIFollowPath){if(a==e.HANIKeyframeType.HANIRotation&&f==e.HANIRotationType.HANIQuatSquadRotation){var p=t.GetAt(n).quat,d=t.GetAt(r).quat;p.Equal(d,e.ANIMATION_D_TOL2)&&(i=!0)}else if(a==e.HANIKeyframeType.HANIString&&t.GetType()==e.INTERPOLATOR_VISIBLE){var v=t.GetAt(n).target,m=t.GetAt(r).target;v==m&&(i=!0)}}else{var c=s.cp,h=o.cp;t.GetType()===e.INTERPOLATOR_POS||t.GetType()===e.INTERPOLATOR_PIVOT?c.Equal(h,e.ANIMATION_D_TOL)&&(i=!0):(t.GetType()==e.INTERPOLATOR_COLOR||t.GetType()==e.INTERPOLATOR_NORMAL||t.GetType()==e.INTERPOLATOR_SCALE)&&c.Equal(h,e.ANIMATION_D_TOL2)&&(i=!0)}return i}return i},t.prototype.ResetFirstLastTickByChild=function(){var e=0,t=0;if(!this.GetTimeline())return;var n=!1;for(var r=0;r<this.ChildAnimationList.length;++r)this.ChildAnimationList[r].GetTimeline()&&this.ChildAnimationList[r].GetTimeline().GetTimelineArrayLength()>0&&(n=!0,r==0?(e=this.ChildAnimationList[r].GetFirstTick(),t=this.ChildAnimationList[r].GetLastTick()):(e>this.ChildAnimationList[r].GetFirstTick()&&(e=this.ChildAnimationList[r].GetFirstTick()),t<this.ChildAnimationList[r].GetLastTick()&&(t=this.ChildAnimationList[r].GetLastTick())));var i=this.GetTimeline().GetTimelineArrayLength();if(e!=t)if(i>=2){for(var r=2;r<i;r++)this.GetTimeline().DeleteKeyframe(this.GetTimeline().GetTimelineArray()[r]);this.GetTimeline().GetTimelineArray()[0]=e,this.GetTimeline().GetTimelineArray()[1]=t,this.pParentAnimation&&this.pParentAnimation.ResetFirstLastTickByChild()}else i==1?this.GetTimeline().GetTimelineArray()[0]=e:this.GetTimeline().AddKeyframe(e),this.GetTimeline().AddKeyframe(t);else if(!n)this.GetTimeline().DeleteAllKeyframe(),this.pParentAnimation&&this.pParentAnimation.ResetFirstLastTickByChild();else if(i<=0)this.GetTimeline().AddKeyframe(e);else{for(var r=1;r<i;r++)this.GetTimeline().DeleteKeyframe(this.GetTimeline().GetTimelineArray()[r]);this.GetTimeline().GetTimelineArray()[0]=e}},t}();e.HBhvAnimation=t})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.AT_PART=0]="AT_PART",e[e.AT_GROUP=1]="AT_GROUP"})(t=e.AnimationType||(e.AnimationType={}));var n=function(t){function n(e,n,r,i,s,o){n===void 0&&(n=10),r===void 0&&(r=0),i===void 0&&(i=""),s===void 0&&(s=""),o===void 0&&(o="");var u=t.call(this)||this;return i&&(u.Name=i),n>0?u.Tps=n:u.Tps=10,u.AnimationList=[],u.ScheduledAnimationList=[],u.TargetObjectList=[],u.Delay=r,u.StartTime=0,u.CurrentTick=0,u.PreTick=0,u.bPlaying=!1,u.LastTick=0,u.FirstTick=0,u.bRenderEveryFrame=!1,u.bUpdateCamera=!0,u.bContinuousPlay=!1,u.bCameraUpdated=!1,u.bInfinitePlay=!1,u.bMerge=!1,u.bShellSelectionActive=!1,u.bReversePlay=!1,u.ID=e,u.ReferenceCount=0,u.bPlaybackIsInterrupted=!1,u.bPlayRangeSign=!1,u.fPlayBeginTick=0,u.fPlayEndTick=0,u.fCollisionTime=0,u.Company=o,u.Version=s,u}return __extends(n,t),n.ProcessXMLData=function(t,n){var r=t.getAttribute("ID"),i=t.getAttribute("Name"),s=t.getAttribute("TicksPerSecond"),o=t.getAttribute("Delay"),u=t.getAttribute("Version"),a=t.getAttribute("Company"),f=n.AddSimAni(r,s,o,i,u,a);for(var l=0;l<t.childNodes.length;++l){var c=t.childNodes[l];if(c.nodeType===1){var h=c.nodeName;switch(h){case"TargetObject":e.HBhvTargetObject.ProcessXMLData(c,f);break;case"Animation":e.HBhvAnimation.ProcessXMLData(c,f)}}}return f},n.prototype.AddAnimation=function(e){this.AnimationList.push(e)},n.prototype.GetTickCount=function(){var e,t;for(var n=0;n<this.AnimationList.length;++n)if(n==0)e=this.AnimationList[n].GetFirstTick(),t=this.AnimationList[n].GetLastTick();else{var r=this.AnimationList[n].GetFirstTick(),i=t=this.AnimationList[n].GetLastTick();r<e&&(e=r),i>t&&(t=i)}return t-e},n.prototype.GetID=function(){return this.ID},n.prototype.SetName=function(e){this.Name=e},n.prototype.GetName=function(){return this.Name},n.prototype.SetTicksPerSecond=function(e){this.Tps=e},n.prototype.DeleteAllAnimations=function(){},n.prototype.CreateTargetObjectByPath=function(t,n){var r;return(r=this.FindTargetObjectByPath(n))||(r=new e.HBhvTargetObject(this,t,n),this.AddTargetObject(r)),r},n.prototype.GetTargetObjectByKey=function(e){for(var t=0;t<this.TargetObjectList.length;++t)if(this.TargetObjectList[t].GetTargetKey()==e)return this.TargetObjectList[t];return null},n.prototype.IsReversePlay=function(){return this.bReversePlay},n.prototype.FindTargetObjectByPath=function(e){for(var t=0;t<this.TargetObjectList.length;++t)if(this.TargetObjectList[t].IsEqual(e))return this.TargetObjectList[t];return null},n.prototype.AddTargetObject=function(e){this.TargetObjectList.push(e)},n.prototype.RegisterTargetObjectKey=function(){var e=0;for(var t=0;t<this.TargetObjectList.length;++t)this.TargetObjectList[t].GetTargetKey()>=e&&(e=this.TargetObjectList[t].GetTargetKey()+1);return e},n.prototype.GetSimulationAnimationManager=function(){return this.pSimulationAnimationManager},n.prototype.SetSimulationAnimationManager=function(e){this.pSimulationAnimationManager=e},n.prototype.IsPlaying=function(){return this.bPlaying},n.prototype.HasAnimations=function(){return this.AnimationList.length!=0},n.prototype.ContinueReverse=function(){this.pSimulationAnimationManager.SetCurSAByID(this.ID),this.GetAnimationPlayApi()&&this.GetAnimationPlayApi().PlayBegin(),this.bPlaybackIsInterrupted=!1,this.bReversePlay=!0,this.IsAtStartTick()||this.GetLastTick()<this.GetCurrentTick()?this.RewindReverse():this.IsAtFinalTick()&&(this.IsPlaying()&&this.Stop(),this.ScheduleAllAnimations(!0),this.ExecuteAnimations(this.GetCurrentTick(),0)),this.Play(),this.StartTime-=(this.GetLastTick()-this.GetCurrentTick())/this.GetTicksPerSecond()},n.prototype.SetCurrentTickByTime=function(e){this.bReversePlay?this.CurrentTick=this.GetLastTick()-(e-this.StartTime)*this.GetTicksPerSecond():this.CurrentTick=(e-this.StartTime)*this.GetTicksPerSecond()},n.prototype.SetCurrentTickByPercentage=function(e){this.ScheduledAnimationList.length<0&&this.ScheduleAllAnimations(!0);var t=this.GetLastTick()-this.GetFirstTick();t===0&&(t=1),this.CurrentTick=e/100*t+this.GetFirstTick()},n.prototype.GetCurrentTickByPercentage=function(){if(this.LastTick>0&&this.CurrentTick>0&&this.CurrentTick>=this.LastTick)return 100;this.ScheduledAnimationList.length<=0&&(this.ScheduleAllAnimations(!0),this.FirstTick=this.GetFirstTick()),this.LastTick=this.GetLastTick();var e=this.LastTick-this.FirstTick;return e<=0?0:(this.CurrentTick-this.FirstTick)/e*100},n.prototype.Tick=function(e,t){this.PreTick=this.CurrentTick;if(!this.bReversePlay)if(this.CurrentTick>=this.LastTick&&!this.bInfinitePlay){if(!this.bContinuousPlay)return this.CurrentTick=this.LastTick,this.Stop(),this.pSimulationAnimationManager.GetAnimationStepManager()&&this.pSimulationAnimationManager.GetAnimationStepManager().PlayFinishCB(this),!0;this.ScheduleAllAnimations(),this.CurrentTick=this.GetFirstTick(),this.ExecuteAnimations(this.CurrentTick,0);var n=new Date;this.StartTime=n.getTime()/1e3,this.StartTime-=this.GetCurrentTick()/this.GetTicksPerSecond()}else this.bRenderEveryFrame?this.CurrentTick++:this.SetCurrentTickByTime(t);else if(this.CurrentTick<=this.FirstTick&&!this.bInfinitePlay){if(!this.bContinuousPlay)return this.CurrentTick=this.FirstTick,this.Stop(),this.pSimulationAnimationManager.GetAnimationStepManager(),!0;this.ScheduleAllAnimations(),this.CurrentTick=this.GetLastTick(),this.ExecuteAnimations(this.CurrentTick,0);var n=new Date;this.StartTime=n.getTime()/1e3,this.StartTime-=(this.GetLastTick()-this.GetCurrentTick())/this.GetTicksPerSecond()}else this.bRenderEveryFrame?this.CurrentTick--:this.SetCurrentTickByTime(t);return this.ExecuteAnimations(this.GetCurrentTick(),-1),!0},n.prototype.FindAnimation=function(e,t,n){n===void 0&&(n=!1);for(var r=0;r<this.AnimationList.length;++r)if(t==null){if(!this.AnimationList[r].GetInterpolator()&&this.AnimationList[r].GetTarget().IsEqual(e))return this.AnimationList[r]}else if(this.AnimationList[r].GetTarget().IsEqual(e)){var i=!1;if(!n&&this.AnimationList[r].GetInterpolator(t))i=!0;else if(n){var s=this.AnimationList[r].GetInterpolator();s&&s.GetType()==t&&(i=!0)}if(i)return this.AnimationList[r]}return null},n.prototype.Stop=function(t){t===void 0&&(t=!1),this.bPlaybackIsInterrupted=t,this.IsPlaying()&&this.GetAnimationPlayApi()&&(e.HTManager.GetHTManager().UnRegisterClient(this),this.bPlaying=!1,this.bCameraUpdated=!1,this.GetAnimationPlayApi().PlayEnd(),this.SetReversePlay(!1))},n.prototype.GetAnimationPlayApi=function(){return this.pSimulationAnimationManager.GetAnimationPlayApi()},n.prototype.SetReversePlay=function(e){this.bReversePlay=e},n.prototype.ScheduleAllAnimations=function(e){e===void 0&&(e=!1),this.ScheduledAnimationList=[];for(var t=0;t<this.AnimationList.length;++t)e&&this.AnimationList[t].GetTimeline().SetCurrentRelativeTick(0),this.AnimationList[t].GetDefaultActive()&&this.ScheduleAnimation(this.AnimationList[t],0)},n.prototype.GetCurrentTick=function(){return this.CurrentTick},n.prototype.ScheduleAnimation=function(e,t){var n=e.GetTimeline();e.GetLoop()!=0?n.SetStartTick(t+e.GetDelay()-n.GetCurrentRelativeTick()):n.SetStartTick(t+e.GetDelay()),e.Reset(),e.SetDefaultActive(!0),e.SetExecuteOnce(!1);for(var r=0;r<this.ScheduledAnimationList.length;++r)this.ScheduledAnimationList[r]===e&&this.ScheduledAnimationList.splice(r,1);this.ScheduledAnimationList.push(e)},n.prototype.Reset=function(){},n.prototype.GetPreTick=function(){return this.PreTick},n.prototype.CameraUpdated=function(){this.bCameraUpdated=!0},n.prototype.IsCameraPlay=function(){return this.pSimulationAnimationManager.IsCameraPlay()},n.prototype.TransferCamera=function(e,t,n,r,i){return this.IsCameraPlay()&&this.GetAnimationPlayApi()&&this.GetAnimationPlayApi().PlayCamera(e,t,n,r,i,this.GetView()),!0},n.prototype.IsPlayPosRot=function(){return this.pSimulationAnimationManager.IsPlayPosRot()},n.prototype.Transfer=function(e,t,n,r){return this.IsPlayPosRot()&&this.GetAnimationPlayApi()&&this.GetAnimationPlayApi().Play(e,t,n,r),!0},n.prototype.Continue=function(){this.pSimulationAnimationManager.SetCurSAByID(this.ID),this.GetAnimationPlayApi()&&this.GetAnimationPlayApi().PlayBegin(),this.bPlaybackIsInterrupted=!1,this.bReversePlay=!1,this.IsAtFinalTick()||this.GetFirstTick()>this.GetCurrentTick()?this.Rewind():this.IsAtStartTick()&&(this.IsPlaying()&&this.Stop(),this.ScheduleAllAnimations(!0),this.ExecuteAnimations(this.GetCurrentTick(),0)),this.Play(),this.StartTime-=this.GetCurrentTick()/this.GetTicksPerSecond()},n.prototype.Play=function(){this.pSimulationAnimationManager.SetCurSAByID(this.ID),this.bPlaybackIsInterrupted=!1;if(!this.IsPlaying()){this.ScheduleAllAnimations(!0);var t=new Date;this.StartTime=t.getTime()/1e3,this.SetInterval(.01),this.SetStyle(e.HTCStyle.HTCS_PeriodicSkip),this.SetNextRequest(this.StartTime+.01),this.bPlaying=!0,this.LastTick=this.GetLastTick(),this.FirstTick=this.GetFirstTick(),e.HTManager.GetHTManager().RegisterClient(this),this.PreTick=this.CurrentTick,this.fCollisionTime=this.CurrentTick*this.GetTicksPerSecond()}},n.prototype.IsAtStartTick=function(){return this.GetFirstTick()>=this.GetCurrentTick()?!0:!1},n.prototype.Rewind=function(){this.IsPlaying()&&this.Stop(),this.ScheduleAllAnimations(!0),this.SetCurrentTick(this.GetFirstTick()),this.ExecuteAnimations(this.GetCurrentTick(),0)},n.prototype.SetCurrentTick=function(e){this.IsPlaying()&&(this.StartTime+=(this.CurrentTick-e)/this.GetTicksPerSecond()),this.CurrentTick=e},n.prototype.GetTicksPerSecond=function(){return this.pSimulationAnimationManager?this.Tps*this.pSimulationAnimationManager.GetPlaySpeed():this.Tps},n.prototype.IsAtFinalTick=function(){return this.GetLastTick()<=this.GetCurrentTick()&&this.GetCurrentTick()>0?!0:!1},n.prototype.GetFirstTick=function(){var t=e.INT_MAX;if(0==this.ScheduledAnimationList.length)return 0;for(var n=0;n<this.ScheduledAnimationList.length;++n)if(!this.ScheduledAnimationList[n].GetParentAnimation()){var r=this.ScheduledAnimationList[n].GetFirstTick();r!=-1&&r<t&&(t=r)}return this.bPlayRangeSign&&(t=this.GetPlayBeginTick()),t},n.prototype.GetPlayBeginTick=function(){return this.fPlayBeginTick},n.prototype.GetLastTick=function(){var e=0;for(var t=0;t<this.ScheduledAnimationList.length;++t)if(!this.ScheduledAnimationList[t].GetParentAnimation()){var n=this.ScheduledAnimationList[t].GetTimeline(),r=n.GetLastTick();r!=-1&&r>e&&(e=r)}return this.bPlayRangeSign&&(e=this.GetPlayEndTick()),e},n.prototype.GetPlayEndTick=function(){return this.fPlayEndTick},n.prototype.ExecuteAnimations=function(e,t){var n=[];this.Reset(),this.bCameraUpdated=!1;for(var r=0;r<this.ScheduledAnimationList.length;++r){var i=!1;if(!this.ScheduledAnimationList[r].GetParentAnimation()){t>-1?this.ScheduledAnimationList[r].Animate(e,t):i=this.ScheduledAnimationList[r].Animate(e);if(i&&!this.ScheduledAnimationList[r].GetLoop()||this.ScheduledAnimationList[r].ExecuteOnce())this.ScheduledAnimationList[r].SetExecuteOnce(!1),n.push(this.ScheduledAnimationList[r]),this.ScheduledAnimationList[r].SetCurrentlyRunning(!1)}}n=[],this.GetAnimationPlayApi()&&this.GetAnimationPlayApi().UpdateView(this)},n.prototype.RewindReverse=function(){this.IsPlaying()&&this.Stop(),this.ScheduleAllAnimations(!0),this.SetCurrentTick(this.GetLastTick()),this.ExecuteAnimations(this.GetCurrentTick(),0)},n.prototype.IsPlayVisiable=function(){return this.pSimulationAnimationManager.IsPlayVisible()},n.prototype.IsPlayColor=function(){return this.pSimulationAnimationManager.IsPlayColor()},n.prototype.GetVersion=function(){return this.Version},n.prototype.GetView=function(){return this.GetSimulationAnimationManager()?this.GetSimulationAnimationManager().GetView():null},n.prototype.DeleteAllAnimation=function(){this.IsPlaying()&&this.Stop(),this.CurrentTick=0,this.LastTick=0,this.FirstTick=0,this.fPlayBeginTick=0,this.fPlayEndTick=0},n.prototype.TransferVisible=function(e,t,n,r){(this.GetAnimationPlayApi()&&e.indexOf("ZOOM")===-1&&this.IsPlayVisiable()||(e.indexOf("ZOOM")===-1?!1:!0)&&this.IsCameraPlay())&&this.GetAnimationPlayApi().PlayVisible(e,t,n,r,this.GetView())},n.prototype.TransferColor=function(e,t,n){this.IsPlayColor()&&this.GetAnimationPlayApi()&&this.GetAnimationPlayApi().PlayColor(e,t,n,this.GetView())},n}(e.HTClient);e.HBhvBehaviorManager=n})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.NoCamera=0]="NoCamera",e[e.CameraTarget=1]="CameraTarget",e[e.CameraPosition=2]="CameraPosition",e[e.CameraTargetFree=3]="CameraTargetFree",e[e.CameraPositionFree=4]="CameraPositionFree",e[e.CameraPositionTarget=5]="CameraPositionTarget"})(t=e.HBhvCameraType||(e.HBhvCameraType={}));var n=function(){function n(r,i,s,o){o===void 0&&(o=null),this.pBehaviorManager=r,this.bSerializeFromKey=!0,i?this.Name=i:this.Name="",s?this.Path=s:this.Path="",this.Pivot=new e.Vector3,o&&this.Pivot.copyFrom(o),this.Quat=new e.Quaternion(1,0,0,0),this.PrePivot=new e.Vector3(0,0,0),this.PreQuat=new e.Quaternion(1,0,0,0),this.CameraType=t.NoCamera,this.Path=s;var u=[this.ResolvedPath,this.Type,this.CameraType];n.ResolveTarget(this.Path,u),this.ResolvedPath=u[0],this.Type=u[1],this.CameraType=u[2],this.bHasMoved=!1,this.bCollision=!1,this.key=0,this.pBehaviorManager&&(this.key=this.pBehaviorManager.RegisterTargetObjectKey()),this.eTargetType=e.AnimationType.AT_PART}return n.ResolveTarget=function(n,r){var i,s,o,u,a;n&&(u=n),o=t.NoCamera;var f=":",l,c=u.indexOf(f);s=u.substr(0,c),l=u.substr(c+1),l?u=l:u="";if(s==e.TARGETOBJECTTYPE_INS||s==e.TARGETOBJECTTYPE_PMI||s==e.TARGETOBJECTTYPE_CLIP||s==e.TARGETOBJECTTYPE_FOLDER||s==e.TARGETOBJECTTYPE_SOUND||s==e.TARGETOBJECTTYPE_IMAGE||s=="TID"||s=="ANIM"||s=="SSR"){i=u,r[0]=i,r[1]=s,r[2]=o;return}var h="",p="",d="/",l,v=l.indexOf(d);h=l.substr(0,c-1),p=l.substr(c);if(p==="CAMERA"||p==="TARGET"||p==="POSITION"||p==="TARGETFREE"||p==="POSITIONFREE"||p==="POSITIONTARGET")p==="POSITION"?o=t.CameraPosition:p==="TARGET"?o=t.CameraTarget:p==="TARGETFREE"?o=t.CameraTargetFree:p==="POSITIONFREE"?o=t.CameraPositionFree:p==="POSITIONTARGET"?o=t.CameraPositionTarget:o=t.NoCamera,i=u,r[0]=i,r[1]=s,r[2]=o},n.prototype.GetType=function(){return this.Type},n.prototype.GetTargetKey=function(){return this.key===-1&&this.CameraType!==t.NoCamera&&(this.key=0),this.key},n.prototype.IsEqual=function(e){return this.Path===e?!0:!1},n.prototype.SetPivot=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];t.length==1?this.Pivot.copyFrom(t[0]):t.length==3&&(this.Pivot=new e.Vector3(t[0],t[1],t[2]))},n.prototype.SetPreQuat=function(t,n,r,i){this.PreQuat=new e.Quaternion(i,t,n,r)},n.prototype.SetQuat=function(t,n,r,i){this.Quat=new e.Quaternion(i,t,n,r)},n.prototype.SetPrePivot=function(e){this.PrePivot=e},n.ProcessXMLData=function(t,n){var r=/(\[)+([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+(\])+/,i=/(\[)+([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+(\])+/,s=t.getAttribute("ID"),o=t.getAttribute("Name"),u=t.getAttribute("Path"),a=t.getAttribute("Pivot"),f;if(a){var l=r.exec(a);l?f=new e.Vector3(parseFloat(l[2]),parseFloat(l[4]),parseFloat(l[6])):f=new e.Vector3}else f=new e.Vector3;var c=!1;c=t.getAttribute("Collision");var h=n.CreateTargetObjectByPath(o,u);h.Pivot=f,h.bCollision=c,h.Quat=new e.Quaternion(1,0,0,0),h.PrePivot=new e.Vector3(0,0,0),h.PreQuat=new e.Quaternion(1,0,0,0),h.key=s},n.prototype.GetPivot=function(){return this.Pivot},n.prototype.GetPrePivot=function(){return this.PrePivot},n.prototype.GetPreQuat=function(){return this.PreQuat},n.prototype.GetResolvedPath=function(){return this.ResolvedPath},n.prototype.GetCameraType=function(){return this.CameraType},n.prototype.GetQuat=function(){return this.Quat},n.prototype.FlagForCollision=function(){this.bHasMoved=!0},n}();e.HBhvTargetObject=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(e){e===void 0&&(e=null),this.pAnimation=e,this.pTimelineArray=[],this.pInstancedTimeline=null,this.CurrentTick=0,this.StartTick=0,this.CurrentRelativeTick=0,this.bCheckRelativeFrame=!0,this.pTLRangeArray=[]}return t.ProcessXMLData=function(e,n){var r=new t(n);n.SetTimeline(r);var i=e.textContent;i=i.trim();var s=i.split(" ");for(var o=0;o<s.length;++o)r.AddKeyframe(parseInt(s[o]));r.AddTLRange()},t.prototype.AddTLRange=function(){this.pTLRangeArray=[];var t=this.GetTimelineArrayLength(),n=new e.TimeLineRange(this),r;for(r=0;r<t-1;r++)n.AddKeyFrameIndex(r),this.pAnimation.IsAnimationInterval(r,r+1)&&(this.pTLRangeArray.push(n),n=new e.TimeLineRange(this));r==t-1&&(n.AddKeyFrameIndex(r),this.pTLRangeArray.push(n))},t.prototype.AddKeyframe=function(e){return this.AddKeyframeInternal(e)},t.prototype.DeleteAllKeyframe=function(){this.pTimelineArray=[]},t.prototype.AddKeyframeInternal=function(e){var t=!1;t&&(t=!1);var n,r,i=0,s,o=e,u=this.GetTimelineArrayLength();s=0,n=0,r=u-1;if(r>=0)if(o<=this.pTimelineArray[r]&&o>=this.pTimelineArray[n]){i=n+(r-n)/2;while(r>=n){var a=this.pTimelineArray[i];if(a==o){s=i,t&&(t=!0);break}a>o?r=i-1:n=i+1,i=n+(r-n)/2}}else o>=this.pTimelineArray[r]?i=r+1:o<=this.pTimelineArray[n]&&(i=n);else u==0&&(i=0);if(t&&t)i>=this.pTimelineArray.length?this.pTimelineArray.push(e):this.pTimelineArray[i]=e;else{var f=this.pTimelineArray.splice(i,this.pTimelineArray.length-i,e);this.pTimelineArray=this.pTimelineArray.concat(f)}return this.pAnimation&&this.pAnimation.GetParentAnimation()&&this.pAnimation.GetParentAnimation().ResetFirstLastTickByChild(),[i,t]},t.prototype.GetTimelineArrayLength=function(){return this.pTimelineArray.length},t.prototype.SetAnimation=function(e){this.pAnimation=e},t.prototype.GetTimelineArray=function(){return this.pTimelineArray.length>0?this.pTimelineArray:null},t.prototype.GetCurrentRelativeTick=function(){return this.CurrentRelativeTick},t.prototype.DeleteKeyframe=function(e){for(var t=0;t<this.GetTimelineArrayLength();t++)if(this.pTimelineArray[t]==e)return this.pTimelineArray.splice(t,1),this.pAnimation&&this.pAnimation.GetParentAnimation()&&this.pAnimation.GetParentAnimation().ResetFirstLastTickByChild(),t;return-1},t.prototype.SetCurrentRelativeTick=function(e){this.CurrentRelativeTick=e},t.prototype.SetCheckRelativeFrame=function(e){e===void 0&&(e=!0),this.bCheckRelativeFrame=e},t.prototype.SetStartTick=function(e){this.StartTick=e},t.prototype.GetStartTick=function(){return this.StartTick},t.prototype.GetAnimation=function(){return this.pAnimation},t.prototype.AdjustTickToTimeline=function(e){var t=this.GetAnimation().GetLoop(),n=this.GetTimelineArray(),r=this.GetTimelineArrayLength();e-=this.StartTick;if(e>n[r-1]&&t!=0){var i=e/n[r-1];e-=i*n[r-1]}return e},t.prototype.Evaluate=function(e,t,n){var r,i=this.GetTimelineArrayLength();if(i<=0)return[!1,t,n];var s=this.GetTimelineArray(),o=this.AdjustTickToTimeline(e);this.CurrentTick=e;var u,a,f=0,l;l=0,u=0,a=i-1;if(this.bCheckRelativeFrame&&o<s[0])return[!1,t,n];if(o<=s[a]&&o>=s[u]){f=u+(a-u)/2,f-=f%1;while(a>=u){var c=s[f];if(c==o){l=f,r=f;break}c>o?a=f-1:u=f+1;var h=(a-u)/2;h-=h%1,f=u+h,f-=f%1}r=f}else o<s[u]?r=u+1:o>s[a]?r=i:r=0;r-=r%1;if(r==0){if(!(i>=1))return[!1,t,n];r=1}if(r==i)return t=i,n=1,this.CurrentTick=s[i-1],[!0,t,n];var p=s[r]-s[r-1];n=(o-s[r-1])/p,t=r-1;if(t!=0)var d=0;return this.CurrentRelativeTick=o,[!0,t,n]},t.prototype.GetLastTick=function(){return this.pTimelineArray.length?this.pTimelineArray[this.pTimelineArray.length-1]:-1},t}();e.HBhvTimeline=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(n,r,i,s,o,u,a,f){s===void 0&&(s=null),o===void 0&&(o=null),u===void 0&&(u=null),a===void 0&&(a=!0),f===void 0&&(f=-1),this.pParent=n,this.bSerializeFromKey=!0,r?this.Name=r:this.Name="",i?this.Path=i:this.Path="",this.Pos=new e.Vector3(0,0,0),s&&this.Pos.copyFrom(s),this.Quat=new e.Quaternion(1,0,0,0),o&&this.Quat.copyFrom(o),this.Scale=new e.Vector3(1,1,1),u&&this.Scale.copyFrom(u),this.bVisible=a,this.Trans=f,this.CameraType=e.HBhvCameraType.NoCamera;var l=[this.ResolvedPath,this.Type,this.CameraType];t.ResolveTarget(this.Path,l),this.ResolvedPath=l[0],this.Type=l[1],this.CameraType=l[2],this.Key=0;if(this.pParent)if(this.pParent instanceof e.SimulationAnimationManager)this.Key=this.pParent.RegisterInitTargetObjectKey();else if(this.pParent instanceof e.Process){var c=this.pParent.GetProcessManager().GetAnimationStepManager().GetSimulationAnimationManager().FindInitTargetObjectByPath(this.Path);c?this.Key=c.GetTargetKey():this.Key=this.pParent.GetSimulationAnimationManager().RegisterInitTargetObjectKey()}}return t.ResolveTarget=function(t,n){var r,i,s,o,u;if(!t)return;o=t,s=e.HBhvCameraType.NoCamera;var a=":",f,l=o.indexOf(a);i=o.substr(0,l),f=o.substr(l+1),f?o=f:o="",i==e.TARGETOBJECTTYPE_INS||i==e.TARGETOBJECTTYPE_PMI||i==e.TARGETOBJECTTYPE_CLIP||i==e.TARGETOBJECTTYPE_FOLDER||i==e.TARGETOBJECTTYPE_SOUND||i==e.TARGETOBJECTTYPE_IMAGE||i=="TID"||i=="ANIM"||i=="SSR"?(r=o,n[0]=r,n[1]=i,n[2]=s):i=="CAMERA"||i=="TARGET"||i=="POSITION"||i=="TARGETFREE"||i=="POSITIONFREE"||i=="POSITIONTARGET"?i=="CAMERA"?n[2]=e.HBhvCameraType.CameraPosition:i=="TARGET"?n[2]=e.HBhvCameraType.CameraTarget:i=="TARGETFREE"?n[2]=e.HBhvCameraType.CameraTargetFree:i=="POSITIONFREE"?n[2]=e.HBhvCameraType.CameraPositionFree:i=="POSITIONTARGET"&&(n[2]=e.HBhvCameraType.CameraPositionTarget):n[2]=e.HBhvCameraType.NoCamera},t.prototype.GetTargetKey=function(){return this.Key==-1&&this.CameraType!=e.HBhvCameraType.NoCamera&&(this.Key=0),this.Key},t.prototype.IsEqual=function(e){return this.Path===e?!0:!1},t.ProcessXMLData=function(t,n){var r=/(\[)+([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+(\])+/,i=/(\[)+([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+(\])+/,s=t.getAttribute("ID"),o=t.getAttribute("Name"),u=t.getAttribute("Path"),a=t.getAttribute("pos"),f;if(a){var l=r.exec(a);l?f=new e.Vector3(parseFloat(l[2]),parseFloat(l[4]),parseFloat(l[6])):f=new e.Vector3}else f=new e.Vector3;var c=t.getAttribute("quat"),h;if(c){var l=i.exec(c);l?h=new e.Quaternion(parseFloat(l[8]),parseFloat(l[2]),parseFloat(l[4]),parseFloat(l[6])):h=new e.Quaternion}else h=new e.Quaternion;a=t.getAttribute("scale");var p;if(a){var l=r.exec(a);l?p=new e.Vector3(parseFloat(l[2]),parseFloat(l[4]),parseFloat(l[6])):p=new e.Vector3(1,1,1)}else p=new e.Vector3(1,1,1);var d=!1;d=t.getAttribute("visible")=="1"?!0:!1;var v,m=t.getAttribute("trans");v=parseFloat(m);var g;if(n instanceof e.SimulationAnimationManager)o.substr(0,5)!=="IMAGE"&&(g=n.CreateInitTargetObjectByPath(o,u));else if(n instanceof e.Process){if(o==""&&u==""||o==null&&u==null||o==undefined&&u==undefined){var y=e.SimulationAnimationManager.Instance();if(y){var b=y.FindInitTargetObjectByByID(s);b&&(o=b.GetName(),u=b.GetPath())}}g=n.CreateTargetObjectByPath(o,u)}g&&(g.Pos=new e.Vector3(f.x,f.y,f.z),g.Quat=new e.Quaternion(h.w,h.x,h.y,h.z),g.Scale=new e.Vector3(p.x,p.y,p.z),g.bVisible=d,g.Key=s,g.Trans=v)},t.prototype.GetCameraType=function(){return this.CameraType},t.prototype.GetName=function(){return this.Name},t.prototype.GetPath=function(){return this.Path},t.prototype.GetType=function(){return this.Type},t.prototype.GetResolvedPath=function(){return this.ResolvedPath},t.prototype.GetInsPathAndPMIIdByResolvedPath=function(e){var t;if(this.GetType()=="PMI"){var n;n=this.GetResolvedPath();var r=-1;for(var i=n.length-1;i>=0;i--)if(n[i]=="\\"){r=i;break}if(r>0){var s=n;s=s.substr(0,r),e=s,t.concat(n.substr(r+1))}else e="",t=n}return t},t.prototype.GetPos=function(){return this.Pos},t.prototype.GetQuat=function(){return this.Quat},t.prototype.GetScale=function(){return this.Scale},t.prototype.GetVisible=function(){return this.bVisible},t.prototype.GetTrans=function(){return this.Trans},t}();e.ProcessTargetObject=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){this.view=null,this.BehaviorManagerList=[],this.InitTargetObjectList=[],this.bCameraPlay=!0,this.bShowTrochoid=!1,this.bPlaySound=!1,this.bPlayVisible=!0,this.bPlayImage=!1,this.bPlayPosRot=!0,this.bPlayClip=!1,this.bPlayColor=!0,this.bCollisionCheck=!1,this.CollisionDelay=100,this.bStopPlayAfterCollision=!1,this.bContinuousPlay=!1,this.bReversePlay=!1,this.fPlaySpeed=1,this.pAnimationPlayApi=new e.AnimationPlayApi}return t.prototype.GetView=function(){return this.view},t.prototype.SetView=function(e){this.view=e},t.prototype.FindInitTargetObjectByByID=function(e){for(var t=0;t<this.InitTargetObjectList.length;++t)if(this.InitTargetObjectList[t].GetTargetKey()==e)return this.InitTargetObjectList[t];return null},t.prototype.GetContinuousPlay=function(){return this.bContinuousPlay},t.prototype.SetContinuousPlay=function(e){this.bContinuousPlay=e},t.prototype.GetInitTargetObjectList=function(){return this.InitTargetObjectList},t.prototype.GetAnimationPlayCBList=function(){return this.pAnimationPlayApi.pAnimationPlayCBList},t.prototype.ReSetCBTran=function(){this.pAnimationRelated?this.pAnimationRelated.ReSetCBTran():(this.pAnimationRelated=new e.AnimationRelated,this.pAnimationRelated.SetAnimationPlayCB())},t.prototype.ProcessXMLData=function(t){var n=t.getElementsByTagName("SimulationAnimation");if(n.length>0){var r=n[0];this.CurSAID=r.getAttribute("CurSAID"),this.Version=r.getAttribute("Version"),this.Company=r.getAttribute("Company"),this.Name=r.getAttribute("Name"),this.SVLVersion=r.getAttribute("SVLVersion "),this.ViewerVersion=r.getAttribute("ViewerVersion");for(var i=0;i<r.childNodes.length;++i){var s=r.childNodes[i];if(s.nodeType===1){var o=s.nodeName;switch(o){case"BehaviorManager":e.HBhvBehaviorManager.ProcessXMLData(s,this);break;case"InitTargetObject":for(var u=0;u<s.childNodes.length;++u){var a=s.childNodes[u];if(a.nodeType===1){var f=a.nodeName;switch(f){case"ProcessTargetObject":e.ProcessTargetObject.ProcessXMLData(a,this)}}}break;case"AnimationStepManager":e.AnimationStepManager.ProcessXMLData(s,this)}}}this.GetBehaviorManagerCount()<=0&&this.AddSimAni(0),this.pAnimationStepManager||(this.pAnimationStepManager=this.CreateAnimationStepManager());var l=this.pAnimationStepManager.GetCurrentProcessManager();l||(l=this.pAnimationStepManager.AddProcessManager());var c=l.GetCurrentProcess();if(!c){for(var h=0;h<this.pAnimationStepManager.GetProcessManagerCount();h++){l=this.pAnimationStepManager.GetProcessManagerByIdx(h);if(l){c=l.GetCurrentProcess();if(c)break}}c?l.SetCurProcessByID(c.GetID(),!1):l.AddProcess(0,null,!1)}}this.ReSetCBTran(),this.GetAnimationStepManager()&&this.GetAnimationStepManager().CaculateTickCount()},t.prototype.GetCurSAID=function(){return this.CurSAID},t.prototype.GetBehaviorManagerCount=
function(){return this.BehaviorManagerList.length},t.prototype.RegisterBehaviorManagerID=function(){var e=0;for(var t=0;t<this.BehaviorManagerList.length;++t)this.BehaviorManagerList[t].GetID()>=e&&(e=this.BehaviorManagerList[t].GetID()+1);return e},t.prototype.AddSimAni=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length!=1){var i=null;return(i=this.FindSimAniByID(t[0]))?(this.CurSAID=t[0],i.SetName(t[3]),i.SetTicksPerSecond(t[1]),i.DeleteAllAnimations()):t.length==4?(i=new e.HBhvBehaviorManager(t[0],t[1],t[2],t[3]),this.AddSimAni(i)):t.length==6&&(i=new e.HBhvBehaviorManager(t[0],t[1],t[2],t[3],t[4],t[5]),this.AddSimAni(i)),i}if(t[0]instanceof e.HBhvBehaviorManager){var r=t[0];null!==r&&(this.BehaviorManagerList.push(r),this.CurSAID=r.GetID(),r.SetSimulationAnimationManager(this))}else this.AddSimAni(t[0],10,0,"")},t.prototype.CreateAnimationStepManager=function(t){return t===void 0&&(t=null),this.pAnimationStepManager?(this.pAnimationStepManager.SetName(t),this.pAnimationStepManager.DeleteAllProcessManager()):(this.pAnimationStepManager=new e.AnimationStepManager(t),this.pAnimationStepManager.SetSimulationAnimationManager(this)),this.pAnimationStepManager},t.prototype.IsPlaying=function(){var e=!1;for(var t=0;t<this.BehaviorManagerList.length;t++)if(this.BehaviorManagerList[t].IsPlaying()){e=!0;break}return e},t.prototype.SetCurSAByID=function(e){this.CurSAID=e},t.prototype.IsPlayPosRot=function(){return this.bPlayPosRot},t.prototype.SetCameraPlay=function(e){this.bCameraPlay=e,this.GetCurrentSA()&&this.GetCurrentSA().IsPlaying()&&(this.GetCurrentSA().Stop(),this.GetCurrentSA().ScheduleAllAnimations(!0),this.GetCurrentSA().ExecuteAnimations(this.GetCurrentSA().GetCurrentTick(),0),this.GetCurrentSA().Continue())},t.prototype.GetPlaySpeed=function(){return this.fPlaySpeed},t.prototype.SetPlaySpeed=function(e){this.fPlaySpeed=e},t.prototype.GetCurrentSA=function(){return-1!=this.CurSAID?this.FindSimAniByID(this.CurSAID):null},t.prototype.FindSimAniByID=function(e){for(var t=0;t<this.BehaviorManagerList.length;++t)if(this.BehaviorManagerList[t].GetID()==e)return this.BehaviorManagerList[t];return null},t.prototype.GetAnimationPlayApi=function(){return this.pAnimationPlayApi},t.prototype.IsCameraPlay=function(){return this.bCameraPlay},t.prototype.CreateInitTargetObjectByPath=function(t,n){var r;return(r=this.FindInitTargetObjectByPath(n))||(r=new e.ProcessTargetObject(this,t,n),this.AddInitTargetObject(r)),r},t.prototype.AddInitTargetObject=function(e){return this.InitTargetObjectList.push(e),e},t.prototype.RegisterInitTargetObjectKey=function(){var e=0;for(var t=0;t<this.InitTargetObjectList.length;++t)this.InitTargetObjectList[t].GetTargetKey()>=e&&(e=Number(this.InitTargetObjectList[t].GetTargetKey())+1);return e},t.prototype.FindInitTargetObjectByPath=function(e){for(var t=0;t<this.InitTargetObjectList.length;++t)if(this.InitTargetObjectList[t].IsEqual(e))return this.InitTargetObjectList[t];return null},t.Instance=function(){return t.instance||(t.instance=new t),t.instance},t.prototype.GetReversePlay=function(){return this.bReversePlay},t.prototype.GetAnimationStepManager=function(){return this.pAnimationStepManager},t.prototype.HasAnimations=function(){var e=!1;for(var t=0;t<this.BehaviorManagerList.length;++t)if(this.BehaviorManagerList[t].HasAnimations()){e=!0;break}return e},t.prototype.StopAll=function(){for(var e=0;e<this.BehaviorManagerList.length;++e)this.BehaviorManagerList[e].Stop()},t.prototype.SetReversePlay=function(e){this.bReversePlay=e},t.prototype.IsPlayVisible=function(){return this.bPlayVisible},t.prototype.SetPlayVisibleStatus=function(e){this.bPlayVisible=e,this.GetCurrentSA()&&this.GetCurrentSA().IsPlaying()&&(this.GetCurrentSA().Stop(),this.GetCurrentSA().ScheduleAllAnimations(),this.GetCurrentSA().ExecuteAnimations(this.GetCurrentSA().GetCurrentTick(),0),this.GetCurrentSA().Continue())},t.prototype.IsPlayColor=function(){return this.bPlayColor},t.prototype.SetPlayColorStatus=function(e){this.bPlayColor=e,this.GetCurrentSA()&&this.GetCurrentSA().IsPlaying()&&(this.GetCurrentSA().Stop(),this.GetCurrentSA().ScheduleAllAnimations(),this.GetCurrentSA().ExecuteAnimations(this.GetCurrentSA().GetCurrentTick(),0),this.GetCurrentSA().Continue())},t.instance=null,t}();e.SimulationAnimationManager=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){this.Name="",this.ID=-1,this.Path="",this.InsPath="",this.EntId=-1,this.bVisible=!1,this.Trans=-1,this.Type=-1,this.Pos=e.ArrayMaker.MakeNumArray(3),this.Quat=e.ArrayMaker.MakeNumArray(4),this.Scale=e.ArrayMaker.MakeNumArray(3),this.Color=e.ArrayMaker.MakeNumArray(3)}return t}();e.TargetObjectInfo=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(e){this.tlKeyFrameIndexArray=[],this.pTimeLine=e}return e.prototype.AddKeyFrameIndex=function(e){this.tlKeyFrameIndexArray.push(e)},e}();e.TimeLineRange=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){}return e}();e.AreaAllocator=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];this.min=new e.Vector3,this.max=new e.Vector3,this.defined=!1;var i=!0;if(n.length==1)n[0]instanceof t?(i=!1,this.copyFrom(n[0])):n[0]instanceof e.Rect?(i=!1,this.min=new e.Vector3(n[0].min,0),this.max=new e.Vector3(n[0].max,0),this.defined=!0):n[0]instanceof e.Frustum&&(i=!1,this.defined=!1,this.Define(n[0]));else if(n.length==2)if(n[0]instanceof e.Vector3,n[1]instanceof e.Vector3)i=!1,this.min.copyFrom(n[0]),this.max.copyFrom(n[1]),this.defined=!0;else if(typeof n[0]=="number"&&typeof n[1]=="number"){i=!1;var s=n[0],o=n[1];this.min=new e.Vector3(s,s,s),this.max=new e.Vector3(o,o,o),this.defined=!0}else n[0]instanceof e.Vector3&&typeof n[1]=="number"&&(i=!1,this.defined=!1,this.Define(n[0],n[1]));i&&(this.min.copyFrom(e.Vector3.ZERO()),this.max.copyFrom(e.Vector3.ZERO()),this.defined=!1)}return t.prototype.copyFrom=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length!=1)return;n[0]instanceof t?(this.min.copyFrom(n[0].min),this.max.copyFrom(n[0].max),this.defined=n[0].defined):n[0]instanceof e.Rect&&(this.min=new e.Vector3(n[0].min,0),this.max=new e.Vector3(n[0].max,0),this.defined=!0)},t.prototype.Define=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length==1)n[0]instanceof t?this.Define(n[0].min,n[0].max):n[0]instanceof e.Rect?this.Define(new e.Vector3(n[0].min,0),new e.Vector3(n[0].max,0)):n[0]instanceof e.Vector3?(this.min.copyFrom(n[0]),this.max.copyFrom(n[0]),this.defined=!0):n[0]instanceof e.Frustum?this.Define(n[0].vertices,e.NUFRUSTUVERTICES):Object.prototype.toString.call(n[0])=="[object Array]"&&this.Merge(n[0]);else if(n.length==2)if(n[0]instanceof e.Vector3&&n[1]instanceof e.Vector3)this.min.copyFrom(n[0]),this.max.copyFrom(n[1]),this.defined=!0;else if(typeof n[0]=="number"&&typeof n[1]=="number"){var i=n[0],s=n[1];this.min=new e.Vector3(i,i,i),this.max=new e.Vector3(s,s,s),this.defined=!0}},t.prototype.Merge=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length==1){if(n[0]instanceof t){if(!this.defined){this.min.copyFrom(n[0].min),this.max.copyFrom(n[0].max),this.defined=!0;return}n[0].min.x<this.min.x&&(this.min.x=n[0].min.x),n[0].min.y<this.min.y&&(this.min.y=n[0].min.y),n[0].min.z<this.min.z&&(this.min.z=n[0].min.z),n[0].max.x>this.max.x&&(this.max.x=n[0].max.x),n[0].max.y>this.max.y&&(this.max.y=n[0].max.y),n[0].max.z>this.max.z&&(this.max.z=n[0].max.z)}else if(n[0]instanceof e.Vector3){if(!this.defined){this.min.copyFrom(n[0]),this.max.copyFrom(n[0]),this.defined=!0;return}n[0].x<this.min.x&&(this.min.x=n[0].x),n[0].y<this.min.y&&(this.min.y=n[0].y),n[0].z<this.min.z&&(this.min.z=n[0].z),n[0].x>this.max.x&&(this.max.x=n[0].x),n[0].y>this.max.y&&(this.max.y=n[0].y),n[0].z>this.max.z&&(this.max.z=n[0].z)}else if(n[0]instanceof e.Frustum)this.Merge(n[0].vertices);else if(Object.prototype.toString.call(n[0])=="[object Array]")for(var i=0;i<n[0].length;++i)this.Merge(n[0][i])}else if(n.length==3&&typeof n[0]=="number"&&typeof n[1]=="number"&&typeof n[2]=="number"){if(!this.defined){this.min.x=n[0],this.min.y=n[1],this.min.z=n[2],this.max.x=n[0],this.max.y=n[1],this.max.z=n[2],this.defined=!0;return}n[0]<this.min.x&&(this.min.x=n[0]),n[1]<this.min.y&&(this.min.y=n[1]),n[2]<this.min.z&&(this.min.z=n[2]),n[0]>this.max.x&&(this.max.x=n[0]),n[1]>this.max.y&&(this.max.y=n[1]),n[2]>this.max.z&&(this.max.z=n[2])}},t.prototype.Clip=function(e){e.min.x>this.min.x&&(this.min.x=e.min.x),e.max.x<this.max.x&&(this.max.x=e.max.x),e.min.y>this.min.y&&(this.min.y=e.min.y),e.max.y<this.max.y&&(this.max.y=e.max.y),e.min.z>this.min.z&&(this.min.z=e.min.z),e.max.z<this.max.z&&(this.max.z=e.max.z);if(this.min.x>this.max.x){var t=this.min.x;this.min.x=this.max.x,this.max.x=t}if(this.min.y>this.max.y){var t=this.min.y;this.min.y=this.max.y,this.max.y=t}if(this.min.z>this.max.z){var t=this.min.z;this.min.z=this.max.z,this.max.z=t}},t.prototype.Transform=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length!=1)return;t[0]instanceof e.Matrix3?this.copyFrom(this.Transformed(new e.Matrix3x4(t[0]))):t[0]instanceof e.Matrix3x4&&this.copyFrom(this.Transformed(t[0]))},t.prototype.Transformed=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length!=1)return;if(n[0]instanceof e.Matrix3)return this.Transformed(new e.Matrix3x4(n[0]));if(n[0]instanceof e.Matrix3x4){var i=n[0].Multiply(this.Center()),s=this.Size().Multiply(.5),o=new e.Vector3(Math.abs(n[0].data[0])*s.x+Math.abs(n[0].data[1])*s.y+Math.abs(n[0].data[2])*s.z,Math.abs(n[0].data[4])*s.x+Math.abs(n[0].data[5])*s.y+Math.abs(n[0].data[6])*s.z,Math.abs(n[0].data[8])*s.x+Math.abs(n[0].data[9])*s.y+Math.abs(n[0].data[10])*s.z);return new t(i.Sub(o),i.AddED(o))}},t.prototype.Clear=function(){this.min=e.Vector3.ZERO().Clone(),this.max=e.Vector3.ZERO().Clone(),this.defined=!1,this.GetVertexs()},t.prototype.Center=function(){return this.max.Add(this.min).MultiplyED(.5)},t.prototype.Size=function(){return this.max.Sub(this.min)},t.prototype.HalfSize=function(){return this.max.Sub(this.min).Multiply(.5)},t.prototype.Length=function(){return this.max.Sub(this.min).Length()},t.prototype.GetXLength=function(){var e=this.max.x-this.min.x;return e>=0?e:-e},t.prototype.GetYLength=function(){var e=this.max.y-this.min.y;return e>=0?e:-e},t.prototype.GetZLength=function(){var e=this.max.z-this.min.z;return e>=0?e:-e},t.prototype.Projected=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length!=1)return;if(n[0]instanceof e.Matrix4){var i=this.min.Clone(),s=this.max.Clone();i.z<e.MIN_NEARCLIP&&(i.z=e.MIN_NEARCLIP),s.z<e.MIN_NEARCLIP&&(s.z=e.MIN_NEARCLIP);var o=Array(8);o[0]=i,o[1]=new e.Vector3(s.x,i.y,i.z),o[2]=new e.Vector3(i.x,s.y,i.z),o[3]=new e.Vector3(s.x,s.y,i.z),o[4]=new e.Vector3(i.x,i.y,s.z),o[5]=new e.Vector3(s.x,i.y,s.z),o[6]=new e.Vector3(i.x,s.y,s.z),o[7]=s;var u=new e.Rect;for(var a=0;a<8;++a){var f=n[0].Multiply(o[a]);u.Merge(new e.Vector2(f.x,f.y))}return u}if(n[0]instanceof e.Plane){var l=new t,i=this.min.Clone(),s=this.max.Clone(),o=[];o[0]=i,o[1]=new e.Vector3(s.x,i.y,i.z),o[2]=new e.Vector3(i.x,s.y,i.z),o[3]=new e.Vector3(s.x,s.y,i.z),o[4]=new e.Vector3(i.x,i.y,s.z),o[5]=new e.Vector3(s.x,i.y,s.z),o[6]=new e.Vector3(i.x,s.y,s.z),o[7]=s;for(var a=0;a<8;++a){var f=n[0].Project(o[a]);l.Merge(new e.Vector3(f.x,f.y,f.z))}return l}},t.prototype.IsInside=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length!=1)return;if(n[0]instanceof e.Vector3)return n[0].x<this.min.x||n[0].x>this.max.x||n[0].y<this.min.y||n[0].y>this.max.y||n[0].z<this.min.z||n[0].z>this.max.z?e.Intersection.OUTSIDE:e.Intersection.INSIDE;if(n[0]instanceof t)return n[0].max.x<this.min.x||n[0].min.x>this.max.x||n[0].max.y<this.min.y||n[0].min.y>this.max.y||n[0].max.z<this.min.z||n[0].min.z>this.max.z?e.Intersection.OUTSIDE:n[0].min.x<this.min.x||n[0].max.x>this.max.x||n[0].min.y<this.min.y||n[0].max.y>this.max.y||n[0].min.z<this.min.z||n[0].max.z>this.max.z?e.Intersection.INTERSECTS:e.Intersection.INSIDE},t.prototype.IsInsideFast=function(t){return t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z?e.Intersection.OUTSIDE:e.Intersection.INSIDE},t.prototype.GetTriangleArray=function(){var e=t.pointsArray,n=this.GetVertexs(),r=new Float32Array(4);for(var i=0;i<12;i++)for(var s=0;s<3;s++){var o=t.triIndex()[i][s]*3;r[0]=n[o],r[1]=n[o+1],r[2]=n[o+2],r[3]=1,e[i*9+s*3+0]=r[0]/r[3],e[i*9+s*3+1]=r[1]/r[3],e[i*9+s*3+2]=r[2]/r[3]}return e},t.prototype.GetVertexs=function(){var e=t.points;return e[0]=this.max.x,e[1]=this.max.y,e[2]=this.max.z,e[3]=this.min.x,e[4]=this.max.y,e[5]=this.max.z,e[6]=this.min.x,e[7]=this.min.y,e[8]=this.max.z,e[9]=this.max.x,e[10]=this.min.y,e[11]=this.max.z,e[12]=this.max.x,e[13]=this.min.y,e[14]=this.min.z,e[15]=this.max.x,e[16]=this.max.y,e[17]=this.min.z,e[18]=this.min.x,e[19]=this.max.y,e[20]=this.min.z,e[21]=this.min.x,e[22]=this.min.y,e[23]=this.min.z,e},t.prototype.Defined=function(){return this.defined},t.prototype.ScaleBox=function(e){var t=this.Center().Clone(),n=this.max.Sub(t).NormalizedED(),r=this.min.Sub(t).NormalizedED(),i=t.Add(n.MultiplyED(this.max.Sub(t).Length()*e)),s=t.Add(r.MultiplyED(this.min.Sub(t).Length()*e));this.max=i.Clone(),this.min=s.Clone()},t.prototype.Clone=function(){return new t(this)},t.prototype.Tostring=function(){return"min:"+this.min.Tostring()+"max:"+this.max.Tostring()},t.prototype.fromString=function(t){var n=!1,r=" ",i=t.split(r);return i.length==6&&(this.min=new e.Vector3(parseFloat(i[0]),parseFloat(i[1]),parseFloat(i[2])),this.max=new e.Vector3(parseFloat(i[3]),parseFloat(i[4]),parseFloat(i[5])),n=!0),n},t.boxIndexs=function(){return t._boxIndexs===null&&(t._boxIndexs=[0,1,1,2,2,3,3,0,3,4,4,5,5,0,5,6,6,7,7,4,6,1,7,2]),t._boxIndexs},t.triIndex=function(){return t._triIndex===null&&(t._triIndex=[[1,0,2],[0,3,2],[0,4,3],[0,5,4],[7,4,5],[5,6,7],[6,1,7],[1,2,7],[6,0,1],[6,5,0],[3,7,2],[3,4,7]]),t._triIndex},t.ZeroBox=function(){return t._ZeroBox==null&&(t._ZeroBox=new t),t._ZeroBox},t.MAX_BOX=function(){return t._MAX_BOX==null&&(t._MAX_BOX=new t),t._MAX_BOX},t.NO_BOX=function(){return t._NO_BOX==null&&(t._NO_BOX=new t),t._NO_BOX},t._boxIndexs=null,t._triIndex=null,t.points=new Float32Array(108),t.pointsArray=new Float32Array(24),t}();e.BoundingBox=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];var r=!0;e.length==1?e[0]instanceof t?(r=!1,this.copyFrom(e[0])):e[0]instanceof Float32Array&&e[0].length===4&&(r=!1,this.r=e[0][0],this.g=e[0][1],this.b=e[0][2],this.a=e[0][3]):e.length==2?e[0]instanceof t&&typeof e[1]=="number"&&(r=!1,this.copyFrom(e[0]),this.a=e[1]):e.length==3?typeof e[0]=="number"&&typeof e[1]=="number"&&typeof e[2]=="number"&&(r=!1,this.r=e[0],this.g=e[1],this.b=e[2],this.a=1):e.length==4&&typeof e[0]=="number"&&typeof e[1]=="number"&&typeof e[2]=="number"&&typeof e[3]=="number"&&(r=!1,this.r=e[0],this.g=e[1],this.b=e[2],this.a=e[3]),r&&(this.r=.8,this.g=.8,this.b=.8,this.a=1)}return t.prototype.Clone=function(){return new t(this)},t.prototype.SetColor=function(e,t,n,r){r===void 0&&(r=1),this.r=e,this.g=t,this.b=n,this.a=r},t.prototype.copyFrom=function(e){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a},t.prototype.Equals=function(t){return e.Equals(this.r,t.r)&&e.Equals(this.g,t.g)&&e.Equals(this.b,t.b)&&e.Equals(this.a,t.a)},t.prototype.Multiply=function(e){return new t(this.r*e,this.g*e,this.b*e,this.a*e)},t.prototype.Add=function(e){return new t(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)},t.prototype.AddED=function(e){this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a},t.prototype.Sub=function(e){return new t(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)},t.prototype.Data=function(){var e=new Float32Array(4);return e[0]=this.r,e[1]=this.g,e[2]=this.b,e[3]=this.a,e},t.prototype.ToUInt=function(){var t=e.Clamp(this.r*255,0,255),n=e.Clamp(this.g*255,0,255),r=e.Clamp(this.b*255,0,255),i=e.Clamp(this.a*255,0,255);return i<<24|r<<16|n<<8|t},t.prototype.Bounds=function(e,t){t===void 0&&(t=!1);if(e.length<2)return;this.r>this.g?this.g>this.b?(e[1]=this.r,e[0]=this.b):(e[1]=this.r>this.b?this.r:this.b,e[0]=this.g):this.b>this.g?(e[1]=this.b,e[0]=this.r):(e[1]=this.g,e[0]=this.r<this.b?this.r:this.b),t&&(e[1]=e[1]>1?1:e[1]<0?0:e[1],e[0]=e[0]>1?1:e[0]<0?0:e[0])},t.prototype.ToHSL=function(){var t=[0,0];this.Bounds(t,!0);var n=this.Hue(t[0],t[1]),r=this.SaturationHSL(t[0],t[1]),i=(t[0]+t[1])*.5;return new e.Vector3(n,r,i)},t.prototype.ToHSV=function(){var t=[0,0];this.Bounds(t,!0);var n=this.Hue(t[0],t[1]),r=this.SaturationHSV(t[0],t[1]),i=t[1];return new e.Vector3(n,r,i)},t.prototype.SaturationHSV=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length==0){var r=[0,0];return this.Bounds(r,!0),this.SaturationHSV(r[0],r[1])}if(t.length==2)return t[1]<=e.EPSILON?0:1-t[0]/t[1]},t.prototype.Value=function(){return this.MaxRGB()},t.prototype.FromHSL=function(e,t,n,r){var i;n<.5?i=(1+(2*n-1))*t:i=(1-(2*n-1))*t;var s=n-.5*i;this.FromHCM(e,i,s),this.a=r},t.prototype.FromHSV=function(e,t,n,r){var i=n*t,s=n-i;this.FromHCM(e,i,s),this.a=r},t.prototype.ToVector3=function(){return new e.Vector3(this.r,this.g,this.b)},t.prototype.ToVector4=function(){return new e.Vector4(this.r,this.g,this.b,this.a)},t.prototype.SumRGB=function(){return this.r+this.g+this.b},t.prototype.Average=function(){return(this.r+this.g+this.b)/3},t.prototype.Luma=function(){return this.r*.299+this.g*.587+this.b*.114},t.prototype.Chroma=function(){var e=[0,0];return this.Bounds(e,!0),e[1]-e[0]},t.prototype.Hue=function(t,n){var r=n-t;if(r<=e.EPSILON)return 0;if(e.Equals(this.g,n))return(this.b+2*r-this.r)/(6*r);if(e.Equals(this.b,n))return(4*r-this.g+this.r)/(6*r);var i=(this.g-this.b)/(6*r);return i<0?1+i:i>=1?i-1:i},t.prototype.SaturationHSL=function(t,n){if(n<=e.EPSILON||t>=1-e.EPSILON)return 0;var r=n+t;return r<=1?(n-t)/r:(t-n)/(r-2)},t.prototype.MaxRGB=function(){return this.r>this.g?this.r>this.b?this.r:this.b:this.g>this.b?this.g:this.b},t.prototype.MinRGB=function(){return this.r<this.g?this.r<this.b?this.r:this.b:this.g<this.b?this.g:this.b},t.prototype.Range=function(){var e=[0,0];return this.Bounds(e),e[1]-e[0]},t.prototype.Lightness=function(){var e=[0,0];return this.Bounds(e,!0),(e[1]+e[0])*.5},t.prototype.IsTransparent=function(){return this.a<.99},t.prototype.Clip=function(e){this.r=this.r>1?1:this.r<0?0:this.r,this.g=this.g>1?1:this.g<0?0:this.g,this.b=this.b>1?1:this.b<0?0:this.b,e&&(this.a=this.a>1?1:this.a<0?0:this.a)},t.prototype.Invert=function(e){this.r=1-this.r,this.g=1-this.g,this.b=1-this.b,e&&(this.a=1-this.a)},t.prototype.Lerp=function(e,n){var r=1-n;return new t(this.r*r+e.r*n,this.g*r+e.g*n,this.b*r+e.b*n,this.a*r+e.a*n)},t.prototype.Abs=function(){return new t(Math.abs(this.r),Math.abs(this.g),Math.abs(this.b),Math.abs(this.a))},t.prototype.FromHCM=function(e,t,n){if(e<0||e>=1)e-=Math.floor(e);var r=e*6,i=t*(1-Math.abs(r%2-1));r<2?(this.b=0,r<1?(this.g=i,this.r=t):(this.g=t,this.r=i)):r<4?(this.r=0,r<3?(this.g=t,this.b=i):(this.g=i,this.b=t)):(this.g=0,r<5?(this.r=i,this.b=t):(this.r=t,this.b=i)),this.r+=n,this.g+=n,this.b+=n},t.prototype.Tostring=function(){return this.r.toString()+" "+this.g.toString()+" "+this.b.toString()+" "+this.a.toString()},t.WHITE=function(){return t.white===null&&(t.white=new t(1,1,1,1)),t.white},t.GRAY=function(){return t.gray===null&&(t.gray=new t(.5,.5,.5)),t.gray},t.BLACK=function(){return t.black===null&&(t.black=new t(0,0,0)),t.black},t.RED=function(){return t.red===null&&(t.red=new t(1,0,0)),t.red},t.GREEN=function(){return t.green===null&&(t.green=new t(0,1,0)),t.green},t.BLUE=function(){return t.blue===null&&(t.blue=new t(0,0,1)),t.blue},t.CYAN=function(){return t.cyan===null&&(t.cyan=new t(0,1,1)),t.cyan},t.MAGENTA=function(){return t.magenta===null&&(t.magenta=new t(1,0,1)),t.magenta},t.YELLOW=function(){return t.yellow===null&&(t.yellow=new t(1,1,0)),t.yellow},t.TRANSPARENT=function(){return t.transparent===null&&(t.transparent=new t(0,0,0,0)),t.transparent},t.Default=function(){return t.default===null&&(t.default=new t(.8,.8,.8,1)),t.default},t.SelectColor=function(){return t.selectColor===null&&(t.selectColor=new t(1,0,0,1)),t.selectColor},t.SelectorShelter=function(){return t.selectorShelter===null&&(t.selectorShelter=new t(1,0,0,.2)),t.selectorShelter},t.FaceDefaultColor=function(){return t.faceDefaultColor===null&&(t.faceDefaultColor=new t(1,0,0,0)),t.faceDefaultColor},t.FaceSelectColor=function(){return t.faceSelectColor===null&&(t.faceSelectColor=new t(1,0,0,0)),t.faceDefaultColor},t.EdgeDefaultColor=function(){return t.edgeDefaultColor===null&&(t.edgeDefaultColor=new t(.25,.25,.25,1)),t.edgeDefaultColor},t.EdgeSelectColor=function(){return t.edgeSelectColor===null&&(t.edgeSelectColor=new t(1,0,0,1)),t.edgeSelectColor},t.white=null,t.gray=null,t.black=null,t.red=null,t.green=null,t.blue=null,t.cyan=null,t.magenta=null,t.yellow=null,t.transparent=null,t.default=null,t.selectColor=null,t.selectorShelter=null,t.faceDefaultColor=null,t.faceSelectColor=null,t.edgeDefaultColor=null,t.edgeSelectColor=null,t}();e.Color=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];this.moveVector=new e.Vector3,this.rotation=new e.Quaternion,this.currPos=new e.Vector3,this.scaleVector=new e.Vector3,t.length===0?this.ReSet():(this.rotation=new e.Quaternion(t[0],t[1],t[2],t[3]),this.moveVector.ToZero(),this.scaleVector.ToOne(),this.scaleFactor=1,this.moveVector.ToZero())}return t.prototype.ReSet=function(){this.rotation=new e.Quaternion(0,new e.Vector3(0,0,1)),this.moveVector.ToZero(),this.scaleVector.ToOne(),this.scaleFactor=1,this.fitFactor=1,this.aspective=1},t.prototype.SetScale=function(e){this.scaleFactor=e},t.prototype.GetScale=function(){return this.scaleFactor*this.fitFactor},t.prototype.GetFitFactor=function(){return this.scaleFactor},t.prototype.SetFitFactor=function(e){this.fitFactor=e},t.prototype.SetAspective=function(e){this.aspective=e},t.prototype.GetAspective=function(){return this.aspective},t.prototype.SetMoveVec=function(e){this.moveVector.copyFrom(e)},t.prototype.SetRotate=function(e){this.rotation.copyFrom(e)},t}();e.ControlInfo=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){this._count=0,this._data={}}return e.prototype.get=function(e){var t=this._data[e.toString()];return t!==undefined?t:undefined},e.prototype.getOrAddWithFactory=function(e,t){var n=this.get(e);return n!==undefined?n:(n=t(e),n&&this.add(e,n),n)},e.prototype.getOrAdd=function(e,t){var n=this.get(e);return n!==undefined?n:(this.add(e,t),t)},e.prototype.contains=function(e){return this._data[e]!==undefined},e.prototype.add=function(e,t){return this._data[e.toString()]!==undefined?!1:(this._data[e.toString()]=t,++this._count,!0)},e.prototype.set=function(e,t){return this._data[e.toString()]===undefined?!1:(this._data[e.toString()]=t,!0)},e.prototype.remove=function(e){return this.contains(e)?(delete this._data[e.toString()],--this._count,!0):!1},e.prototype.clear=function(){this._data={},this._count=0},Object.defineProperty(e.prototype,"count",{get:function(){return this._count},enumerable:!0,configurable:!0}),e.prototype.forEach=function(e){for(var t in this._data){var n=this._data[t];e(t,n)}},e.prototype.first=function(e){for(var t in this._data){var n=this._data[t],r=e(t,n);if(r)return r}return null},e}();e.Dictionary=t})(M3D||(M3D={}));var M3D;(function(e){e.NUFRUSTUPLANES=6,e.NUFRUSTUVERTICES=8;var t;(function(e){e[e.PLANE_NEAR=0]="PLANE_NEAR",e[e.PLANE_LEFT=1]="PLANE_LEFT",e[e.PLANE_RIGHT=2]="PLANE_RIGHT",e[e.PLANE_UP=3]="PLANE_UP",e[e.PLANE_DOWN=4]="PLANE_DOWN",e[e.PLANE_FAR=5]="PLANE_FAR"})(t||(t={}));var n=function(){function n(){var t=[];for(var r=0;r<arguments.length;r++)t[r]=arguments[r];this.planes=new Array(e.NUFRUSTUPLANES),this.vertices=new Array(e.NUFRUSTUVERTICES),this.Init(),t.length===0?this.UpdatePlanes():t.length===1&&t[0]instanceof n&&this.copyFrom(t[0])}return n.prototype.Init=function(){for(var t=0;t<this.planes.length;t++)this.planes[t]=new e.Plane;for(var t=0;t<this.vertices.length;t++)this.vertices[t]=new e.Vector3},n.prototype.Clone=function(){return new n},n.prototype.copyFrom=function(t){for(var n=0;n<e.NUFRUSTUPLANES;++n)this.planes[n].copyFrom(t.planes[n]);for(var n=0;n<e.NUFRUSTUVERTICES;++n)this.vertices[n].copyFrom(t.vertices[n])},n.prototype.Define=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length<1)return;if(t[0]instanceof e.BoundingBox){var r=new e.Matrix3x4;t[1]&&t[1]instanceof e.Matrix3x4?r.copyFrom(t[1]):r.copyFrom(e.Matrix3x4.IDENTITY()),this.vertices[0]=r.Multiply(new e.Vector3(t[0].max.x,t[0].max.y,t[0].min.z)),this.vertices[1]=r.Multiply(new e.Vector3(t[0].max.x,t[0].min.y,t[0].min.z)),this.vertices[2]=r.Multiply(new e.Vector3(t[0].min.x,t[0].min.y,t[0].min.z)),this.vertices[3]=r.Multiply(new e.Vector3(t[0].min.x,t[0].max.y,t[0].min.z)),this.vertices[4]=r.Multiply(new e.Vector3(t[0].max.x,t[0].max.y,t[0].max.z)),this.vertices[5]=r.Multiply(new e.Vector3(t[0].max.x,t[0].min.y,t[0].max.z)),this.vertices[6]=r.Multiply(new e.Vector3(t[0].min.x,t[0].min.y,t[0].max.z)),this.vertices[7]=r.Multiply(new e.Vector3(t[0].min.x,t[0].max.y,t[0].max.z)),this.UpdatePlanes()}else if(t.length===3&&t[0]instanceof e.Vector3&&t[1]&&t[1]instanceof e.Vector3){var r=new e.Matrix3x4;t[2]&&t[2]instanceof e.Matrix3x4?r.copyFrom(t[2]):r.copyFrom(e.Matrix3x4.IDENTITY());var i=t[0],s=t[1];this.vertices[0]=r.Multiply(i),this.vertices[1]=r.Multiply(new e.Vector3(i.x,-i.y,i.z)),this.vertices[2]=r.Multiply(new e.Vector3(-i.x,-i.y,i.z)),this.vertices[3]=r.Multiply(new e.Vector3(-i.x,i.y,i.z)),this.vertices[4]=r.Multiply(s),this.vertices[5]=r.Multiply(new e.Vector3(s.x,-s.y,s.z)),this.vertices[6]=r.Multiply(new e.Vector3(-s.x,-s.y,s.z)),this.vertices[7]=r.Multiply(new e.Vector3(-s.x,s.y,s.z)),this.UpdatePlanes()}else if(t.length>=5)if(typeof t[0]=="number"&&typeof t[1]=="number"&&typeof t[2]=="number"&&typeof t[3]=="number"&&typeof t[4]=="number"){var r=new e.Matrix3x4;t[5]&&t[5]instanceof e.Matrix3x4?r.copyFrom(t[5]):r.copyFrom(e.Matrix3x4.IDENTITY());var o=t[0],u=t[1],a=t[2],f=t[3],l=t[4];f=Math.max(f,0),l=Math.max(l,f);var c=Math.tan(o*e.DEGTORAD_2)/a,i=new e.Vector3,s=new e.Vector3;i.z=-f,i.y=i.z*c,i.x=i.y*u,s.z=-l,s.y=s.z*c,s.x=s.y*u,this.Define(i,s,r)}else t[0]instanceof e.Vector3&&(this.vertices[0]=t[4].Clone(),this.vertices[1]=t[5].Clone(),this.vertices[2]=t[6].Clone(),this.vertices[3]=t[7].Clone(),this.vertices[4]=t[0].Clone(),this.vertices[5]=t[1].Clone(),this.vertices[6]=t[2].Clone(),this.vertices[7]=t[3].Clone(),this.UpdatePlanes())},n.prototype.DefineOrtho=function(t,n,r,i,s,o){i=Math.max(i,0),s=Math.max(s,i);var u=t*.5/r,a=new e.Vector3,f=new e.Vector3;a.z=-i,f.z=-s,f.y=a.y=u,f.x=a.x=a.y*n,this.Define(a,f,o)},n.prototype.Transform=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length<1)return;if(t[0]instanceof e.Matrix3){for(var r=0;r<e.NUFRUSTUVERTICES;++r)this.vertices[r]=t[0].Multiply(this.vertices[r]);this.UpdatePlanes()}else if(t[0]instanceof e.Matrix3x4){for(var r=0;r<e.NUFRUSTUVERTICES;++r)this.vertices[r]=t[0].Multiply(this.vertices[r]);this.UpdatePlanes()}},n.prototype.IsInside=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length<1)return;if(t[0]instanceof e.Vector3){for(var r=0;r<e.NUFRUSTUPLANES;++r)if(this.planes[r].Distance(t[0])<0)return e.Intersection.OUTSIDE;return e.Intersection.INSIDE}if(t[0]instanceof e.BoundingBox){var i=t[0],s=i.Center(),o=s.Sub(i.min),u=!0;for(var r=0;r<e.NUFRUSTUPLANES;++r){var a=this.planes[r],f=a.normal.DotProduct(s)+a.d,l=a.absNormal.DotProduct(o);if(f<-l)return e.OUTSIDE;f<l&&(u=!1)}return u?e.INSIDE:e.INTERSECTS}},n.prototype.IsInsideFast=function(t){var n=t.Center(),r=n.Sub(t.min);for(var i=0;i<e.NUFRUSTUPLANES;++i){var s=this.planes[i],o=s.normal.DotProduct(n)+s.d,u=s.absNormal.DotProduct(r);if(o<-u)return e.OUTSIDE}return e.INSIDE},n.prototype.Distance=function(t){var n=0;for(var r=0;r<e.NUFRUSTUPLANES;++r)n=e.Max(-this.planes[r].Distance(t),n);return n},n.prototype.Transformed=function(){var t=[];for(var r=0;r<arguments.length;r++)t[r]=arguments[r];if(t.length<1)return;if(t[0]instanceof e.Matrix3){var i=new n;for(var s=0;s<e.NUFRUSTUVERTICES;++s)i.vertices[s]=t[0].Multiply(this.vertices[s]);return i.UpdatePlanes(),i}if(t[0]instanceof e.Matrix3x4){var i=new n;for(var s=0;s<e.NUFRUSTUVERTICES;++s)i.vertices[s]=t[0].Multiply(this.vertices[s]);return i.UpdatePlanes(),i}},n.prototype.ClipEdgeZ=function(t,n,r){return new e.Vector3(n.x+(t.x-n.x)*((r-n.z)/(t.z-n.z)),n.y+(t.y-n.y)*((r-n.z)/(t.z-n.z)),r)},n.prototype.ProjectAndMergeEdge=function(t,n,r,i){if(t.z<e.MIN_NEARCLIP&&n.z<e.MIN_NEARCLIP)return;n.z<e.MIN_NEARCLIP?n=this.ClipEdgeZ(n,t,e.MIN_NEARCLIP):t.z<e.MIN_NEARCLIP&&(t=this.ClipEdgeZ(t,n,e.MIN_NEARCLIP));var s=i.Multiply(t),o=i.Multiply(n);r.Merge(new e.Vector2(s.x,s.y)),r.Merge(new e.Vector2(o.x,o.y))},n.prototype.Projected=function(t){var n=new e.Rect;return this.ProjectAndMergeEdge(this.vertices[0],this.vertices[4],n,t),this.ProjectAndMergeEdge(this.vertices[1],this.vertices[5],n,t),this.ProjectAndMergeEdge(this.vertices[2],this.vertices[6],n,t),this.ProjectAndMergeEdge(this.vertices[3],this.vertices[7],n,t),this.ProjectAndMergeEdge(this.vertices[4],this.vertices[5],n,t),this.ProjectAndMergeEdge(this.vertices[5],this.vertices[6],n,t),this.ProjectAndMergeEdge(this.vertices[6],this.vertices[7],n,t),this.ProjectAndMergeEdge(this.vertices[7],this.vertices[4],n,t),n},n.prototype.UpdatePlanes=function(){this.planes[t.PLANE_NEAR].Define(this.vertices[2],this.vertices[1],this.vertices[0]),this.planes[t.PLANE_LEFT].Define(this.vertices[3],this.vertices[7],this.vertices[6]),this.planes[t.PLANE_RIGHT].Define(this.vertices[1],this.vertices[5],this.vertices[4]),this.planes[t.PLANE_UP].Define(this.vertices[0],this.vertices[4],this.vertices[7]),this.planes[t.PLANE_DOWN].Define(this.vertices[6],this.vertices[5],this.vertices[1]),this.planes[t.PLANE_FAR].Define(this.vertices[5],this.vertices[6],this.vertices[7]);if(this.planes[t.PLANE_NEAR].Distance(this.vertices[5])<0)for(var n=0;n<e.NUFRUSTUPLANES;++n)this.planes[n].normal=this.planes[n].normal.Multiply(-1),this.planes[n].d=-this.planes[n].d},n}();e.Frustum=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){}return t.prototype.CreateImage=function(t,n){var r=e.IDCreator.GetUUID(32,16);e.DrawingUtility.createImage(t,n)},t}();e.GlueObj=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];this.data=new Float32Array([1,0,0,0,1,0,0,0,1]),e.length===1?e[0]instanceof t?(this.data[0]=e[0].data[0],this.data[1]=e[0].data[1],this.data[2]=e[0].data[2],this.data[3]=e[0].data[3],this.data[4]=e[0].data[4],this.data[5]=e[0].data[5],this.data[6]=e[0].data[6],this.data[7]=e[0].data[7],this.data[8]=e[0].data[8]):e[0]instanceof Float32Array&&e[0].length===9?(this.data[0]=e[0][0],this.data[1]=e[0][1],this.data[2]=e[0][2],this.data[3]=e[0][3],this.data[4]=e[0][4],this.data[5]=e[0][5],this.data[6]=e[0][6],this.data[7]=e[0][7],this.data[8]=e[0][8]):(this.data[0]=1,this.data[1]=0,this.data[2]=0,this.data[3]=0,this.data[4]=1,this.data[5]=0,this.data[6]=0,this.data[7]=0,this.data[8]=1):e.length===9&&(this.data[0]=e[0],this.data[1]=e[1],this.data[2]=e[2],this.data[3]=e[3],this.data[4]=e[4],this.data[5]=e[5],this.data[6]=e[6],this.data[7]=e[7],this.data[8]=e[8])}return t.prototype.Clone=function(){return new t(this)},t.prototype.copyFrom=function(e){this.data[0]=e.data[0],this.data[1]=e.data[1],this.data[2]=e.data[2],this.data[3]=e.data[3],this.data[4]=e.data[4],this.data[5]=e.data[5],this.data[6]=e.data[6],this.data[7]=e.data[7],this.data[8]=e.data[8]},t.prototype.Equals=function(t){return e.Equals(this.data[0],t.data[0])&&e.Equals(this.data[1],t.data[1])&&e.Equals(this.data[2],t.data[2])&&e.Equals(this.data[3],t.data[3])&&e.Equals(this.data[4],t.data[4])&&e.Equals(this.data[5],t.data[5])&&e.Equals(this.data[6],t.data[6])&&e.Equals(this.data[7],t.data[7])&&e.Equals(this.data[8],t.data[8])},t.prototype.Multiply=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];return n.length!==1?null:typeof n[0]=="number"?new t(this.data[0]*n[0],this.data[1]*n[0],this.data[2]*n[0],this.data[3]*n[0],this.data[4]*n[0],this.data[5]*n[0],this.data[6]*n[0],this.data[7]*n[0],this.data[8]*n[0]):n[0]instanceof e.Vector3?new e.Vector3(this.data[0]*n[0].x+this.data[1]*n[0
].y+this.data[2]*n[0].z,this.data[3]*n[0].x+this.data[4]*n[0].y+this.data[5]*n[0].z,this.data[6]*n[0].x+this.data[7]*n[0].y+this.data[8]*n[0].z):n[0]instanceof t?new t(this.data[0]*n[0].data[0]+this.data[1]*n[0].data[3]+this.data[2]*n[0].data[6],this.data[0]*n[0].data[1]+this.data[1]*n[0].data[4]+this.data[2]*n[0].data[7],this.data[0]*n[0].data[2]+this.data[1]*n[0].data[5]+this.data[2]*n[0].data[8],this.data[3]*n[0].data[0]+this.data[4]*n[0].data[3]+this.data[5]*n[0].data[6],this.data[3]*n[0].data[1]+this.data[4]*n[0].data[4]+this.data[5]*n[0].data[7],this.data[3]*n[0].data[2]+this.data[4]*n[0].data[5]+this.data[5]*n[0].data[8],this.data[6]*n[0].data[0]+this.data[7]*n[0].data[3]+this.data[8]*n[0].data[6],this.data[6]*n[0].data[1]+this.data[7]*n[0].data[4]+this.data[8]*n[0].data[7],this.data[6]*n[0].data[2]+this.data[7]*n[0].data[5]+this.data[8]*n[0].data[8]):null},t.prototype.Sub=function(e){return new t(this.data[0]-e.data[0],this.data[1]-e.data[1],this.data[2]-e.data[2],this.data[3]-e.data[3],this.data[4]-e.data[4],this.data[5]-e.data[5],this.data[6]-e.data[6],this.data[7]-e.data[7],this.data[8]-e.data[8])},t.prototype.Add=function(e){return new t(this.data[0]+e.data[0],this.data[1]+e.data[1],this.data[2]+e.data[2],this.data[3]+e.data[3],this.data[4]+e.data[4],this.data[5]+e.data[5],this.data[6]+e.data[6],this.data[7]+e.data[7],this.data[8]+e.data[8])},t.prototype.MultiplyED=function(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];if(e.length!==1)return this;if(typeof e[0]=="number")this.data[0]*=e[0],this.data[1]*=e[0],this.data[2]*=e[0],this.data[3]*=e[0],this.data[4]*=e[0],this.data[5]*=e[0],this.data[6]*=e[0],this.data[7]*=e[0],this.data[8]*=e[0];else if(e[0]instanceof t){var r=this.data[0]*e[0].data[0]+this.data[1]*e[0].data[3]+this.data[2]*e[0].data[6],i=this.data[0]*e[0].data[1]+this.data[1]*e[0].data[4]+this.data[2]*e[0].data[7],s=this.data[0]*e[0].data[2]+this.data[1]*e[0].data[5]+this.data[2]*e[0].data[8],o=this.data[3]*e[0].data[0]+this.data[4]*e[0].data[3]+this.data[5]*e[0].data[6],u=this.data[3]*e[0].data[1]+this.data[4]*e[0].data[4]+this.data[5]*e[0].data[7],a=this.data[3]*e[0].data[2]+this.data[4]*e[0].data[5]+this.data[5]*e[0].data[8],f=this.data[6]*e[0].data[0]+this.data[7]*e[0].data[3]+this.data[8]*e[0].data[6],l=this.data[6]*e[0].data[1]+this.data[7]*e[0].data[4]+this.data[8]*e[0].data[7],c=this.data[6]*e[0].data[2]+this.data[7]*e[0].data[5]+this.data[8]*e[0].data[8];this.data[0]=r,this.data[1]=i,this.data[2]=s,this.data[3]=o,this.data[4]=u,this.data[5]=a,this.data[6]=f,this.data[7]=l,this.data[8]=c}return this},t.prototype.SubED=function(e){return this.data[0]-=e.data[0],this.data[1]-=e.data[1],this.data[2]-=e.data[2],this.data[3]-=e.data[3],this.data[4]-=e.data[4],this.data[5]-=e.data[5],this.data[6]-=e.data[6],this.data[7]-=e.data[7],this.data[8]-=e.data[8],this},t.prototype.AddED=function(e){return this.data[0]+=e.data[0],this.data[1]+=e.data[1],this.data[2]+=e.data[2],this.data[3]+=e.data[3],this.data[4]+=e.data[4],this.data[5]+=e.data[5],this.data[6]+=e.data[6],this.data[7]+=e.data[7],this.data[8]+=e.data[8],this},t.prototype.SetScale=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length!=1)return;typeof t[0]=="number"?(this.data[0]=t[0],this.data[4]=t[0],this.data[8]=t[0]):t[0]instanceof e.Vector3&&(this.data[0]=t[0].x,this.data[4]=t[0].y,this.data[8]=t[0].z)},t.prototype.Scale=function(){return new e.Vector3(Math.sqrt(this.data[0]*this.data[0]+this.data[3]*this.data[3]+this.data[6]*this.data[6]),Math.sqrt(this.data[1]*this.data[1]+this.data[4]*this.data[4]+this.data[7]*this.data[7]),Math.sqrt(this.data[2]*this.data[2]+this.data[5]*this.data[5]+this.data[8]*this.data[8]))},t.prototype.Transpose=function(){return new t(this.data[0],this.data[3],this.data[6],this.data[1],this.data[4],this.data[7],this.data[2],this.data[5],this.data[8])},t.prototype.Scaled=function(e){return new t(this.data[0]*e.x,this.data[1]*e.y,this.data[2]*e.z,this.data[3]*e.x,this.data[4]*e.y,this.data[5]*e.z,this.data[6]*e.x,this.data[7]*e.y,this.data[8]*e.z)},t.prototype.Inverse=function(){var e=this.data[0]*this.data[4]*this.data[8]+this.data[3]*this.data[7]*this.data[2]+this.data[6]*this.data[1]*this.data[5]-this.data[6]*this.data[4]*this.data[2]-this.data[3]*this.data[1]*this.data[8]-this.data[0]*this.data[7]*this.data[5],n=1/e;return new t((this.data[4]*this.data[8]-this.data[7]*this.data[5])*n,-(this.data[1]*this.data[8]-this.data[7]*this.data[2])*n,(this.data[1]*this.data[5]-this.data[4]*this.data[2])*n,-(this.data[3]*this.data[8]-this.data[6]*this.data[5])*n,(this.data[0]*this.data[8]-this.data[6]*this.data[2])*n,-(this.data[0]*this.data[5]-this.data[3]*this.data[2])*n,(this.data[3]*this.data[7]-this.data[6]*this.data[4])*n,-(this.data[0]*this.data[7]-this.data[6]*this.data[1])*n,(this.data[0]*this.data[4]-this.data[3]*this.data[1])*n)},t.prototype.InverseED=function(){var e=this.data[0]*this.data[4]*this.data[8]+this.data[3]*this.data[7]*this.data[2]+this.data[6]*this.data[1]*this.data[5]-this.data[6]*this.data[4]*this.data[2]-this.data[3]*this.data[1]*this.data[8]-this.data[0]*this.data[7]*this.data[5],t=1/e,n=(this.data[4]*this.data[8]-this.data[7]*this.data[5])*t,r=-(this.data[1]*this.data[8]-this.data[7]*this.data[2])*t,i=(this.data[1]*this.data[5]-this.data[4]*this.data[2])*t,s=-(this.data[3]*this.data[8]-this.data[6]*this.data[5])*t,o=(this.data[0]*this.data[8]-this.data[6]*this.data[2])*t,u=-(this.data[0]*this.data[5]-this.data[3]*this.data[2])*t,a=(this.data[3]*this.data[7]-this.data[6]*this.data[4])*t,f=-(this.data[0]*this.data[7]-this.data[6]*this.data[1])*t,l=(this.data[0]*this.data[4]-this.data[3]*this.data[1])*t;return this.data[0]=n,this.data[1]=r,this.data[2]=i,this.data[3]=s,this.data[4]=o,this.data[5]=u,this.data[6]=a,this.data[7]=f,this.data[8]=l,this},t.prototype.Data=function(){return this.data},t.prototype.Value=function(e,t){return this.data[e*3+t]},t.prototype.Tostring=function(){return this.data[0].toString()+" "+this.data[1].toString()+" "+this.data[2].toString()+" "+this.data[3].toString()+" "+this.data[4].toString()+" "+this.data[5].toString()+" "+this.data[6].toString()+" "+this.data[7].toString()+" "+this.data[8].toString()},t.BulkTranspose=function(e,t){for(var n=0;n<e.length&&n<t.length;++n){if(e[n].length!=9||t[n].length!=9)continue;e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8]}},t.ZERO=function(){return t._ZERO==null&&(t._ZERO=new t(0,0,0,0,0,0,0,0,0)),t._ZERO},t.IDENTITY=function(){return t._IDENTITY==null&&(t._IDENTITY=new t),t._IDENTITY},t}();e.Matrix3=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];this.data=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0]),n.length===1?n[0]instanceof t?this.copyFrom(n[0]):n[0]instanceof e.Matrix3?this.copyFrom(n[0]):n[0]instanceof e.Matrix4?this.copyFrom(n[0]):n[0]instanceof Float32Array&&n[0].length===12&&(this.data[0]=n[0][0],this.data[1]=n[0][1],this.data[2]=n[0][2],this.data[3]=n[0][3],this.data[4]=n[0][4],this.data[5]=n[0][5],this.data[6]=n[0][6],this.data[7]=n[0][7],this.data[8]=n[0][8],this.data[9]=n[0][9],this.data[10]=n[0][10],this.data[11]=n[0][11]):n.length===3?n[0]instanceof e.Vector3&&n[1]instanceof e.Quaternion&&typeof n[2]=="number"?(this.SetRotation(n[1].RotationMatrix().MultiplyED(n[2])),this.SetTranslation(n[0])):n[0]instanceof e.Vector3&&n[1]instanceof e.Quaternion&&n[2]instanceof e.Vector3&&(this.SetRotation(n[1].RotationMatrix().Scaled(n[2])),this.SetTranslation(n[0])):n.length===12&&(this.data[0]=n[0],this.data[1]=n[1],this.data[2]=n[2],this.data[3]=n[3],this.data[4]=n[4],this.data[5]=n[5],this.data[6]=n[6],this.data[7]=n[7],this.data[8]=n[8],this.data[9]=n[9],this.data[10]=n[10],this.data[11]=n[11])}return t.prototype.copyFrom=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length!=1)return;n[0]instanceof t||n[0]instanceof e.Matrix4?(this.data[0]=n[0].data[0],this.data[1]=n[0].data[1],this.data[2]=n[0].data[2],this.data[3]=n[0].data[3],this.data[4]=n[0].data[4],this.data[5]=n[0].data[5],this.data[6]=n[0].data[6],this.data[7]=n[0].data[7],this.data[8]=n[0].data[8],this.data[9]=n[0].data[9],this.data[10]=n[0].data[10],this.data[11]=n[0].data[11]):n[0]instanceof e.Matrix3&&(this.data[0]=n[0].data[0],this.data[1]=n[0].data[1],this.data[2]=n[0].data[2],this.data[3]=0,this.data[4]=n[0].data[3],this.data[5]=n[0].data[4],this.data[6]=n[0].data[5],this.data[7]=0,this.data[8]=n[0].data[6],this.data[9]=n[0].data[7],this.data[10]=n[0].data[8],this.data[11]=0)},t.prototype.Equals=function(t){return e.Equals(this.data[0],t.data[0])&&e.Equals(this.data[1],t.data[1])&&e.Equals(this.data[2],t.data[2])&&e.Equals(this.data[3],t.data[3])&&e.Equals(this.data[4],t.data[4])&&e.Equals(this.data[5],t.data[5])&&e.Equals(this.data[6],t.data[6])&&e.Equals(this.data[7],t.data[7])&&e.Equals(this.data[8],t.data[8])&&e.Equals(this.data[9],t.data[9])&&e.Equals(this.data[10],t.data[10])&&e.Equals(this.data[11],t.data[11])},t.prototype.Clone=function(){return new t(this)},t.prototype.Multiply=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];return n.length!==1?null:typeof n[0]=="number"?new t(this.data[0]*n[0],this.data[1]*n[0],this.data[2]*n[0],this.data[3]*n[0],this.data[4]*n[0],this.data[5]*n[0],this.data[6]*n[0],this.data[7]*n[0],this.data[8]*n[0],this.data[9]*n[0],this.data[10]*n[0],this.data[11]*n[0]):n[0]instanceof e.Vector3?new e.Vector3(this.data[0]*n[0].x+this.data[1]*n[0].y+this.data[2]*n[0].z+this.data[3],this.data[4]*n[0].x+this.data[5]*n[0].y+this.data[6]*n[0].z+this.data[7],this.data[8]*n[0].x+this.data[9]*n[0].y+this.data[10]*n[0].z+this.data[11]):n[0]instanceof e.Vector4?new e.Vector3(this.data[0]*n[0].x+this.data[1]*n[0].y+this.data[2]*n[0].z+this.data[3]*n[0].w,this.data[4]*n[0].x+this.data[5]*n[0].y+this.data[6]*n[0].z+this.data[7]*n[0].w,this.data[8]*n[0].x+this.data[9]*n[0].y+this.data[10]*n[0].z+this.data[11]*n[0].w):n[0]instanceof e.Matrix4?new e.Matrix4(this.data[0]*n[0].data[0]+this.data[1]*n[0].data[4]+this.data[2]*n[0].data[8]+this.data[3]*n[0].data[12],this.data[0]*n[0].data[1]+this.data[1]*n[0].data[5]+this.data[2]*n[0].data[9]+this.data[3]*n[0].data[13],this.data[0]*n[0].data[2]+this.data[1]*n[0].data[6]+this.data[2]*n[0].data[10]+this.data[3]*n[0].data[14],this.data[0]*n[0].data[3]+this.data[1]*n[0].data[7]+this.data[2]*n[0].data[11]+this.data[3]*n[0].data[15],this.data[4]*n[0].data[0]+this.data[5]*n[0].data[4]+this.data[6]*n[0].data[8]+this.data[7]*n[0].data[12],this.data[4]*n[0].data[1]+this.data[5]*n[0].data[5]+this.data[6]*n[0].data[9]+this.data[7]*n[0].data[13],this.data[4]*n[0].data[2]+this.data[5]*n[0].data[6]+this.data[6]*n[0].data[10]+this.data[7]*n[0].data[14],this.data[4]*n[0].data[3]+this.data[5]*n[0].data[7]+this.data[6]*n[0].data[11]+this.data[7]*n[0].data[15],this.data[8]*n[0].data[0]+this.data[9]*n[0].data[4]+this.data[10]*n[0].data[8]+this.data[11]*n[0].data[12],this.data[8]*n[0].data[1]+this.data[9]*n[0].data[5]+this.data[10]*n[0].data[9]+this.data[11]*n[0].data[13],this.data[8]*n[0].data[2]+this.data[9]*n[0].data[6]+this.data[10]*n[0].data[10]+this.data[11]*n[0].data[14],this.data[8]*n[0].data[3]+this.data[9]*n[0].data[7]+this.data[10]*n[0].data[11]+this.data[11]*n[0].data[15],n[0].data[12],n[0].data[13],n[0].data[14],n[0].data[15]):n[0]instanceof t?new t(this.data[0]*n[0].data[0]+this.data[1]*n[0].data[4]+this.data[2]*n[0].data[8],this.data[0]*n[0].data[1]+this.data[1]*n[0].data[5]+this.data[2]*n[0].data[9],this.data[0]*n[0].data[2]+this.data[1]*n[0].data[6]+this.data[2]*n[0].data[10],this.data[0]*n[0].data[3]+this.data[1]*n[0].data[7]+this.data[2]*n[0].data[11]+this.data[3],this.data[4]*n[0].data[0]+this.data[5]*n[0].data[4]+this.data[6]*n[0].data[8],this.data[4]*n[0].data[1]+this.data[5]*n[0].data[5]+this.data[6]*n[0].data[9],this.data[4]*n[0].data[2]+this.data[5]*n[0].data[6]+this.data[6]*n[0].data[10],this.data[4]*n[0].data[3]+this.data[5]*n[0].data[7]+this.data[6]*n[0].data[11]+this.data[7],this.data[8]*n[0].data[0]+this.data[9]*n[0].data[4]+this.data[10]*n[0].data[8],this.data[8]*n[0].data[1]+this.data[9]*n[0].data[5]+this.data[10]*n[0].data[9],this.data[8]*n[0].data[2]+this.data[9]*n[0].data[6]+this.data[10]*n[0].data[10],this.data[8]*n[0].data[3]+this.data[9]*n[0].data[7]+this.data[10]*n[0].data[11]+this.data[11]):null},t.prototype.Sub=function(e){return new t(this.data[0]-e.data[0],this.data[1]-e.data[1],this.data[2]-e.data[2],this.data[3]-e.data[3],this.data[4]-e.data[4],this.data[5]-e.data[5],this.data[6]-e.data[6],this.data[7]-e.data[7],this.data[8]-e.data[8],this.data[9]-e.data[9],this.data[10]-e.data[10],this.data[11]-e.data[11])},t.prototype.Add=function(e){return new t(this.data[0]+e.data[0],this.data[1]+e.data[1],this.data[2]+e.data[2],this.data[3]+e.data[3],this.data[4]+e.data[4],this.data[5]+e.data[5],this.data[6]+e.data[6],this.data[7]+e.data[7],this.data[8]+e.data[8],this.data[9]+e.data[9],this.data[10]+e.data[10],this.data[11]+e.data[11])},t.prototype.MultiplyED=function(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];if(e.length!==1)return this;if(typeof e[0]=="number")this.data[0]*=e[0],this.data[1]*=e[0],this.data[2]*=e[0],this.data[3]*=e[0],this.data[4]*=e[0],this.data[5]*=e[0],this.data[6]*=e[0],this.data[7]*=e[0],this.data[8]*=e[0],this.data[9]*=e[0],this.data[10]*=e[0],this.data[11]*=e[0];else if(e[0]instanceof t){var r=this.data[0]*e[0].data[0]+this.data[1]*e[0].data[4]+this.data[2]*e[0].data[8],i=this.data[0]*e[0].data[1]+this.data[1]*e[0].data[5]+this.data[2]*e[0].data[9],s=this.data[0]*e[0].data[2]+this.data[1]*e[0].data[6]+this.data[2]*e[0].data[10],o=this.data[0]*e[0].data[3]+this.data[1]*e[0].data[7]+this.data[2]*e[0].data[11]+this.data[3],u=this.data[4]*e[0].data[0]+this.data[5]*e[0].data[4]+this.data[6]*e[0].data[8],a=this.data[4]*e[0].data[1]+this.data[5]*e[0].data[5]+this.data[6]*e[0].data[9],f=this.data[4]*e[0].data[2]+this.data[5]*e[0].data[6]+this.data[6]*e[0].data[10],l=this.data[4]*e[0].data[3]+this.data[5]*e[0].data[7]+this.data[6]*e[0].data[11]+this.data[7],c=this.data[8]*e[0].data[0]+this.data[9]*e[0].data[4]+this.data[10]*e[0].data[8],h=this.data[8]*e[0].data[1]+this.data[9]*e[0].data[5]+this.data[10]*e[0].data[9],p=this.data[8]*e[0].data[2]+this.data[9]*e[0].data[6]+this.data[10]*e[0].data[10],d=this.data[8]*e[0].data[3]+this.data[9]*e[0].data[7]+this.data[10]*e[0].data[11]+this.data[11];this.data[0]=r,this.data[1]=i,this.data[2]=s,this.data[3]=o,this.data[4]=u,this.data[5]=a,this.data[6]=f,this.data[7]=l,this.data[8]=c,this.data[9]=h,this.data[10]=p,this.data[11]=d}return this},t.prototype.SubED=function(e){return this.data[0]-=e.data[0],this.data[1]-=e.data[1],this.data[2]-=e.data[2],this.data[3]-=e.data[3],this.data[4]-=e.data[4],this.data[5]-=e.data[5],this.data[6]-=e.data[6],this.data[7]-=e.data[7],this.data[8]-=e.data[8],this.data[9]-=e.data[9],this.data[10]-=e.data[10],this.data[11]-=e.data[11],this},t.prototype.AddED=function(e){return this.data[0]+=e.data[0],this.data[1]+=e.data[1],this.data[2]+=e.data[2],this.data[3]+=e.data[3],this.data[4]+=e.data[4],this.data[5]+=e.data[5],this.data[6]+=e.data[6],this.data[7]+=e.data[7],this.data[8]+=e.data[8],this.data[9]+=e.data[9],this.data[10]+=e.data[10],this.data[11]+=e.data[11],this},t.prototype.SetTranslation=function(e){this.data[3]=e.x,this.data[7]=e.y,this.data[11]=e.z},t.prototype.SetRotation=function(e){this.data[0]=e.data[0],this.data[1]=e.data[1],this.data[2]=e.data[2],this.data[4]=e.data[3],this.data[5]=e.data[4],this.data[6]=e.data[5],this.data[8]=e.data[6],this.data[9]=e.data[7],this.data[10]=e.data[8]},t.prototype.SetScale=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length!=1)return;typeof t[0]=="number"?(this.data[0]=t[0],this.data[5]=t[0],this.data[10]=t[0]):t[0]instanceof e.Vector3&&(this.data[0]=t[0].x,this.data[5]=t[0].y,this.data[10]=t[0].z)},t.prototype.ToMatrix3=function(){return new e.Matrix3(this.data[0],this.data[1],this.data[2],this.data[4],this.data[5],this.data[6],this.data[8],this.data[9],this.data[10])},t.prototype.ToMatrix4=function(){return new e.Matrix4(this.data[0],this.data[1],this.data[2],this.data[3],this.data[4],this.data[5],this.data[6],this.data[7],this.data[8],this.data[9],this.data[10],this.data[11],0,0,0,1)},t.prototype.RotationMatrix=function(){var t=new e.Vector3(1/Math.sqrt(this.data[0]*this.data[0]+this.data[4]*this.data[4]+this.data[8]*this.data[8]),1/Math.sqrt(this.data[1]*this.data[1]+this.data[5]*this.data[5]+this.data[9]*this.data[9]),1/Math.sqrt(this.data[2]*this.data[2]+this.data[6]*this.data[6]+this.data[10]*this.data[10]));return this.ToMatrix3().Scaled(t)},t.prototype.Translation=function(){return new e.Vector3(this.data[3],this.data[7],this.data[11])},t.prototype.Rotation=function(){return new e.Quaternion(this.RotationMatrix())},t.prototype.Scale=function(){return new e.Vector3(Math.sqrt(this.data[0]*this.data[0]+this.data[4]*this.data[4]+this.data[8]*this.data[8]),Math.sqrt(this.data[1]*this.data[1]+this.data[5]*this.data[5]+this.data[9]*this.data[9]),Math.sqrt(this.data[2]*this.data[2]+this.data[6]*this.data[6]+this.data[10]*this.data[10]))},t.prototype.MultiTranslate=function(e){var n=new t;n.SetTranslation(e),this.copyFrom(this.Multiply(n))},t.prototype.MultiRotatiton=function(e){var n=new t;n.SetRotation(e.RotationMatrix()),this.copyFrom(this.Multiply(n))},t.prototype.MultiScale=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length!=1)return;if(typeof n[0]=="number"||n[0]instanceof e.Vector3){var i=new t;i.SetScale(n[0]),this.copyFrom(this.Multiply(i))}},t.prototype.GetLookAt=function(n,r,i,s){var o=new t;o=this.Inverse();var u=o.Multiply(new e.Vector3(0,0,0));i=this.Multiply(new e.Vector4(0,1,0,0));var a=this.Multiply(new e.Vector4(0,0,-1,0));return a.Normalize(),a=u.Add(a.Multiply(s).Clone()).Clone(),n=u,r=a,[n,r,i]},t.prototype.Decompose=function(t,n,r){t.x=this.data[3],t.y=this.data[7],t.z=this.data[11],r.x=Math.sqrt(this.data[0]*this.data[0]+this.data[4]*this.data[4]+this.data[8]*this.data[8]),r.y=Math.sqrt(this.data[1]*this.data[1]+this.data[5]*this.data[5]+this.data[9]*this.data[9]),r.z=Math.sqrt(this.data[2]*this.data[2]+this.data[6]*this.data[6]+this.data[10]*this.data[10]);var i=new e.Vector3(1/r.x,1/r.y,1/r.z);n=new e.Quaternion(this.ToMatrix3().Scaled(i))},t.prototype.Inverse=function(){var e=this.data[0]*this.data[5]*this.data[10]+this.data[4]*this.data[9]*this.data[2]+this.data[8]*this.data[1]*this.data[6]-this.data[8]*this.data[5]*this.data[2]-this.data[4]*this.data[1]*this.data[10]-this.data[0]*this.data[9]*this.data[6],n=1/e,r=new t;return r.data[0]=(this.data[5]*this.data[10]-this.data[9]*this.data[6])*n,r.data[1]=-(this.data[1]*this.data[10]-this.data[9]*this.data[2])*n,r.data[2]=(this.data[1]*this.data[6]-this.data[5]*this.data[2])*n,r.data[3]=-(this.data[3]*r.data[0]+this.data[7]*r.data[1]+this.data[11]*r.data[2]),r.data[4]=-(this.data[4]*this.data[10]-this.data[8]*this.data[6])*n,r.data[5]=(this.data[0]*this.data[10]-this.data[8]*this.data[2])*n,r.data[6]=-(this.data[0]*this.data[6]-this.data[4]*this.data[2])*n,r.data[7]=-(this.data[3]*r.data[4]+this.data[7]*r.data[5]+this.data[11]*r.data[6]),r.data[8]=(this.data[4]*this.data[9]-this.data[8]*this.data[5])*n,r.data[9]=-(this.data[0]*this.data[9]-this.data[8]*this.data[1])*n,r.data[10]=(this.data[0]*this.data[5]-this.data[4]*this.data[1])*n,r.data[11]=-(this.data[3]*r.data[8]+this.data[7]*r.data[9]+this.data[11]*r.data[10]),r},t.prototype.InverseED=function(){var e=this.data[0]*this.data[5]*this.data[10]+this.data[4]*this.data[9]*this.data[2]+this.data[8]*this.data[1]*this.data[6]-this.data[8]*this.data[5]*this.data[2]-this.data[4]*this.data[1]*this.data[10]-this.data[0]*this.data[9]*this.data[6],t=1/e,n=(this.data[5]*this.data[10]-this.data[9]*this.data[6])*t,r=-(this.data[1]*this.data[10]-this.data[9]*this.data[2])*t,i=(this.data[1]*this.data[6]-this.data[5]*this.data[2])*t,s=-(this.data[3]*n+this.data[7]*r+this.data[11]*i),o=-(this.data[4]*this.data[10]-this.data[8]*this.data[6])*t,u=(this.data[0]*this.data[10]-this.data[8]*this.data[2])*t,a=-(this.data[0]*this.data[6]-this.data[4]*this.data[2])*t,f=-(this.data[3]*o+this.data[7]*u+this.data[11]*a),l=(this.data[4]*this.data[9]-this.data[8]*this.data[5])*t,c=-(this.data[0]*this.data[9]-this.data[8]*this.data[1])*t,h=(this.data[0]*this.data[5]-this.data[4]*this.data[1])*t,p=-(this.data[3]*l+this.data[7]*c+this.data[11]*h);return this.data[0]=n,this.data[1]=r,this.data[2]=i,this.data[3]=s,this.data[4]=o,this.data[5]=u,this.data[6]=a,this.data[7]=f,this.data[8]=l,this.data[9]=c,this.data[10]=h,this.data[11]=p,this},t.prototype.Data=function(){return this.data},t.prototype.Value=function(e,t){return this.data[e*4+t]},t.prototype.Tostring=function(){return this.data[0].toString()+" "+this.data[1].toString()+" "+this.data[2].toString()+" "+this.data[3].toString()+" "+this.data[4].toString()+" "+this.data[5].toString()+" "+this.data[6].toString()+" "+this.data[7].toString()+" "+this.data[8].toString()+" "+this.data[9].toString()+" "+this.data[10].toString()+this.data[11].toString()},t.prototype.fromString=function(t){var n=!1,r=" ",i=t.split(r);if(i.length==16){var s=new e.Matrix4;s.fromString(t)&&(this.copyFrom(s),n=!0)}else if(i.length==12){for(var o=0;o<12;o++)this.data[o]=parseFloat(i[o]);n=!0}return n},t.ZERO=function(){return t._ZERO==null&&(t._ZERO=new t(0,0,0,0,0,0,0,0,0,0,0,0)),t._ZERO},t.IDENTITY=function(){return t._IDENTITY==null&&(t._IDENTITY=new t),t._IDENTITY.Clone()},t._ZERO=null,t._IDENTITY=null,t}();e.Matrix3x4=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];this.data=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),n.length===1?n[0]instanceof t?this.copyFrom(n[0]):n[0]instanceof e.Matrix3?this.copyFrom(n[0]):n[0]instanceof Float32Array&&n[0].length===16&&(this.data[0]=n[0][0],this.data[1]=n[0][1],this.data[2]=n[0][2],this.data[3]=n[0][3],this.data[4]=n[0][4],this.data[5]=n[0][5],this.data[6]=n[0][6],this.data[7]=n[0][7],this.data[8]=n[0][8],this.data[9]=n[0][9],this.data[10]=n[0][10],this.data[11]=n[0][11],this.data[12]=n[0][12],this.data[13]=n[0][13],this.data[14]=n[0][14],this.data[15]=n[0][15]):n.length===3?n[0]instanceof e.Vector3&&n[1]instanceof e.Quaternion&&typeof n[2]=="number"?(this.ToIdentity(),this.SetRotation(n[1].RotationMatrix().MultiplyED(n[2])),this.SetTranslation(n[0])):n[0]instanceof e.Vector3&&n[1]instanceof e.Quaternion&&n[2]instanceof e.Vector3&&(this.ToIdentity(),this.SetRotation(n[1].RotationMatrix().Scaled(n[2])),this.SetTranslation(n[0])):n.length===16&&(this.data[0]=n[0],this.data[1]=n[1],this.data[2]=n[2],this.data[3]=n[3],this.data[4]=n[4],this.data[5]=n[5],this.data[6]=n[6],this.data[7]=n[7],this.data[8]=n[8],this.data[9]=n[9],this.data[10]=n[10],this.data[11]=n[11],this.data[12]=n[12],this.data[13]=n[13],this.data[14]=n[14],this.data[15]=n[15])}return t.prototype.Clone=function(){return new t(this)},t.prototype.Set=function(e){this.data[0]=e[0],this.data[1]=e[1],this.data[2]=e[2],this.data[3]=e[3],this.data[4]=e[4],this.data[5]=e[5],this.data[6]=e[6],this.data[7]=e[7],this.data[8]=e[8],this.data[9]=e[9],this.data[10]=e[10],this.data[11]=e[11],this.data[12]=e[12],this.data[13]=e[13],this.data[14]=e[14],this.data[15]=e[15]},t.prototype.copyFrom=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length!=1)return;n[0]instanceof t?(this.data[0]=n[0].data[0],this.data[1]=n[0].data[1],this.data[2]=n[0].data[2],this.data[3]=n[0].data[3],this.data[4]=n[0].data[4],this.data[5]=n[0].data[5],this.data[6]=n[0].data[6],this.data[7]=n[0].data[7],this.data[8]=n[0].data[8],this.data[9]=n[0].data[9],this.data[10]=n[0].data[10],this.data[11]=n[0].data[11],this.data[12]=n[0].data[12],this.data[13]=n[0].data[13],this.data[14]=n[0].data[14],this.data[15]=n[0].data[15]):n[0]instanceof e.Matrix3&&(this.data[0]=n[0].data[0],this.data[1]=n[0].data[1],this.data[2]=n[0].data[2],this.data[3]=0,this.data[4]=n[0].data[3],this.data[5]=n[0].data[4],this.data[6]=n[0].data[5],this.data[7]=0,this.data[8]=n[0].data[6],this.data[9]=n[0].data[7],this.data[10]=n[0].data[8],this.data[11]=0,this.data[12]=0,this.data[13]=0,this.data[14]=0,this.data[15]=1)},t.prototype.ToIdentity=function(){this.copyFrom(t.IDENTITY())},t.prototype.SetRotation=function(e){this.data[0]=e.data[0],this.data[1]=e.data[1],this.data[2]=e.data[2],this.data[4]=e.data[3],this.data[5]=e.data[4],this.data[6]=e.data[5],this.data[8]=e.data[6],this.data[9]=e.data[7],this.data[10]=e.data[8]},t.prototype.SetTranslation=function(e){this.data[3]=e.x,this.data[7]=e.y,this.data[11]=e.z},t.prototype.Equals=function(t){return e.Equals(this.data[0],t.data[0])&&e.Equals(this.data[1],t.data[1])&&e.Equals(this.data[2],t.data[2])&&e.Equals(this.data[3],t.data[3])&&e.Equals(this.data[4],t.data[4])&&e.Equals(this.data[5],t.data[5])&&e.Equals(this.data[6],t.data[6])&&e.Equals(this.data[7],t.data[7])&&e.Equals(this.data[8],t.data[8])&&e.Equals(this.data[9],t.data[9])&&e.Equals(this.data[10],t.data[10])&&e.Equals(this.data[11],t.data[11])&&e.Equals(this.data[12],t.data[12])&&e.Equals(this.data[13],t.data[13])&&e.Equals(this.data[14],t.data[14])&&e.Equals(this.data[15],t.data[15])},t.prototype.MultiplyMat4=function(e,t){t.data[0]=this.data[0]*e.data[0]+this.data[1]*e.data[4]+this.data[2]*e.data[8]+this.data[3]*e.data[12],t.data[1]=this.data[0]*e.data[1]+this.data[1]*e.data[5]+this.data[2]*e.data[9]+this.data[3]*e.data[13],t.data[2]=this.data[0]*e.data[2]+this.data[1]*e.data[6]+this.data[2]*e.data[10]+this.data[3]*e.data[14],t.data[3]=this.data[0]*e.data[3]+this.data[1]*e.data[7]+this.data[2]*e.data[11]+this.data[3]*e.data[15],t.data[4]=this.data[4]*e.data[0]+this.data[5]*e.data[4]+this.data[6]*e.data[8]+this.data[7]*e.data[12],t.data[5]=this.data[4]*e.data[1]+this.data[5]*e.data[5]+this.data[6]*e.data[9]+this.data[7]*e.data[13],t.data[6]=this.data[4]*e.data[2]+this.data[5]*e.data[6]+this.data[6]*e.data[10]+this.data[7]*e.data[14],t.data[7]=this.data[4]*e.data[3]+this.data[5]*e.data[7]+this.data[6]*e.data[11]+this.data[7]*e.data[15],t.data[8]=this.data[8]*e.data[0]+this.data[9]*e.data[4]+this.data[10]*e.data[8]+this.data[11]*e.data[12],t.data[9]=this.data[8]*e.data[1]+this.data[9]*e.data[5]+this.data[10]*e.data[9]+this.data[11]*e.data[13],t.data[10]=this.data[8]*e.data[2]+this.data[9]*e.data[6]+this.data[10]*e.data[10]+this.data[11]*e.data[14],t.data[11]=this.data[8]*e.data[3]+this.data[9]*e.data[7]+this.data[10]*e.data[11]+this.data[11]*e.data[15],t.data[12]=this.data[12]*e.data[0]+this.data[13]*e.data[4]+this.data[14]*e.data[8]+this.data[15]*e.data[12],t.data[13]=this.data[12]*e.data[1]+this.data[13]*e.data[5]+this.data[14]*e.data[9]+this.data[15]*e.data[13],t.data[14]=this.data[12]*e.data[2]+this.data[13]*e.data[6]+this.data[14]*e.data[10]+this.data[15]*e.data[14],t.data[15]=this.data[12]*e.data[3]+this.data[13]*e.data[7]+this.data[14]*e.data[11]+this.data[15]*e.data[15]},t.prototype.Multiply=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length!==1)return null;if(typeof n[0]=="number")return new t(this.data[0]*n[0],this.data[1]*n[0],this.data[2]*n[0],this.data[3]*n[0],this.data[4]*n[0],this.data[5]*n[0],this.data[6]*n[0],this.data[7]*n[0],this.data[8]*n[0],this.data[9]*n[0],this.data[10]*n[0],this.data[11]*n[0],this.data[12]*n[0],this.data[13]*n[0],this.data[14]*n[0],this.data[15]*n[0]);if(n[0]instanceof e.Vector3){var i=1/(this.data[12]*n[0].x+this.data[13]*n[0].y+this.data[14]*n[0].z+this.data[15]);return new e.Vector3((this.data[0]*n[0].x+this.data[1]*n[0].y+this.data[2]*n[0].z+this.data[3])*i,(this.data[4]*n[0].x+this.data[5]*n[0].y+this.data[6]*n[0].z+this.data[7])*i,(this.data[8]*n[0].x+this.data[9]*n[0].y+this.data[10]*n[0].z+this.data[11])*i)}if(n[0]instanceof e.Vector4)return new e.Vector4(this.data[0]*n[0].x+this.data[1]*n[0].y+this.data[2]*n[0].z+this.data[3]*n[0].w,this.data[4]*n[0].x+this.data[5]*n[0].y+this.data[6]*n[0].z+this.data[7]*n[0].w,this.data[8]*n[0].x+this.data[9]*n[0].y+this.data[10]*n[0].z+this.data[11]*n[0].w,this.data[12]*n[0].x+this.data[13]*n[0].y+this.data[14]*n[0].z+this.data[15]*n[0].w);if(n[0]instanceof e.Quaternion){var s=n[0].RotationMatrix(),o=new t(s);return this.Multiply(o)}return n[0]instanceof t?new t(this.data[0]*n[0].data[0]+this.data[1]*n[0].data[4]+this.data[2]*n[0].data[8]+this.data[3]*n[0].data[12],this.data[0]*n[0].data[1]+this.data[1]*n[0].data[5]+this.data[2]*n[0].data[9]+this.data[3]*n[0].data[13],this.data[0]*n[0].data[2]+this.data[1]*n[0].data[6]+this.data[2]*n[0].data[10]+this.data[3]*n[0].data[14],this.data[0]*n[0].data[3]+this.data[1]*n[0].data[7]+this.data[2]*n[0].data[11]+this.data[3]*n[0].data[15],this.data[4]*n[0].data[0]+this.data[5]*n[0].data[4]+this.data[6]*n[0].data[8]+this.data[7]*n[0].data[12],this.data[4]*n[0].data[1]+this.data[5]*n[0].data[5]+this.data[6]*n[0].data[9]+this.data[7]*n[0].data[13],this.data[4]*n[0].data[2]+this.data[5]*n[0].data[6]+this.data[6]*n[0].data[10]+this.data[7]*n[0].data[14],this.data[4]*n[0].data[3]+this.data[5]*n[0].data[7]+this.data[6]*n[0].data[11]+this.data[7]*n[0].data[15],this.data[8]*n[0].data[0]+this.data[9]*n[0].data[4]+this.data[10]*n[0].data[8]+this.data[11]*n[0].data[12],this.data[8]*n[0].data[1]+this.data[9]*n[0].data[5]+this.data[10]*n[0].data[9]+this.data[11]*n[0].data[13],this.data[8]*n[0].data[2]+this.data[9]*n[0].data[6]+this.data[10]*n[0].data[10]+this.data[11]*n[0].data[14],this.data[8]*n[0].data[3]+this.data[9]*n[0].data[7]+this.data[10]*n[0].data[11]+this.data[11]*n[0].data[15],this.data[12]*n[0].data[0]+this.data[13]*n[0].data[4]+this.data[14]*n[0].data[8]+this.data[15]*n[0].data[12],this.data[12]*n[0].data[1]+this.data[13]*n[0].data[5]+this.data[14]*n[0].data[9]+this.data[15]*n[0].data[13],this.data[12]*n[0].data[2]+this.data[13]*n[0].data[6]+this.data[14]*n[0].data[10]+this.data[15]*n[0].data[14],this.data[12]*n[0].data[3]+this.data[13]*n[0].data[7]+this.data[14]*n[0].data[11]+this.data[15]*n[0].data[15]):n[0]instanceof e.Matrix3x4?new t(this.data[0]*n[0].data[0]+this.data[1]*n[0].data[4]+this.data[2]*n[0].data[8],this.data[0]*n[0].data[1]+this.data[1]*n[0].data[5]+this.data[2]*n[0].data[9],this.data[0]*n[0].data[2]+this.data[1]*n[0].data[6]+this.data[2]*n[0].data[10],this.data[0]*n[0].data[3]+this.data[1]*n[0].data[7]+this.data[2]*n[0].data[11]+this.data[3],this.data[4]*n[0].data[0]+this.data[5]*n[0].data[4]+this.data[6]*n[0].data[8],this.data[4]*n[0].data[1]+this.data[5]*n[0].data[5]+this.data[6]*n[0].data[9],this.data[4]*n[0].data[2]+this.data[5]*n[0].data[6]+this.data[6]*n[0].data[10],this.data[4]*n[0].data[3]+this.data[5]*n[0].data[7]+this.data[6]*n[0].data[11]+this.data[7],this.data[8]*n[0].data[0]+this.data[9]*n[0].data[4]+this.data[10]*n[0].data[8],this.data[8]*n[0].data[1]+this.data[9]*n[0].data[5]+this.data[10]*n[0].data[9],this.data[8]*n[0].data[2]+this.data[9]*n[0].data[6]+this.data[10]*n[0].data[10],this.data[8]*n[0].data[3]+this.data[9]*n[0].data[7]+this.data[10]*n[0].data[11]+this.data[11],this.data[12]*n[0].data[0]+this.data[13]*n[0].data[4]+this.data[14]*n[0].data[8],this.data[12]*n[0].data[1]+this.data[13]*n[0].data[5]+this.data[14]*n[0].data[9],this.data[12]*n[0].data[2]+this.data[13]*n[0].data[6]+this.data[14]*n[0].data[10],this.data[12]*n[0].data[3]+this.data[13]*n[0].data[7]+this.data[14]*n[0].data[11]+this.data[15]):null},t.prototype.Sub=function(e){return new t(this.data[0]-e.data[0],this.data[1]-e.data[1],this.data[2]-e.data[2],this.data[3]-e.data[3],this.data[4]-e.data[4],this.data[5]-e.data[5],this.data[6]-e.data[6],this.data[7]-e.data[7],this.data[8]-e.data[8],this.data[9]-e.data[9],this.data[10]-e.data[10],this.data[11]-e.data[11],this.data[12]-e.data[12],this.data[13]-e.data[13],this.data[14]-e.data[14],this.data[15]-e.data[15])},t.prototype.Add=function(e){return new t(this.data[0]+e.data[0],this.data[1]+e.data[1],this.data[2]+e.data[2],this.data[3]+e.data[3],this.data[4]+e.data[4],this.data[5]+e.data[5],this.data[6]+e.data[6],this.data[7]+e.data[7],this.data[8]+e.data[8],this.data[9]+e.data[9],this.data[10]+e.data[10],this.data[11]+e.data[11],this.data[12]+e.data[12],this.data[13]+e.data[13],this.data[14]+e.data[14],this.data[15]+e.data[15])},t.prototype.MultiplyED=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(typeof n[0]=="number")this.data[0]*=n[0],this.data[1]*=n[0],this.data[2]*=n[0],this.data[3]*=n[0],this.data[4]*=n[0],this.data[5]*=n[0],this.data[6]*=n[0],this.data[7]*=n[0],this.data[8]*=n[0],this.data[9]*=n[0],this.data[10]*=n[0],this.data[11]*=n[0],this.data[12]*=n[0],this.data[13]*=n[0],this.data[14]*=n[0],this.data[15]*=n[0];else{if(n[0]instanceof e.Quaternion
){var i=n[0].RotationMatrix(),s=new t(i);return this.MultiplyED(s)}if(n[0]instanceof t){var o=this.data[0]*n[0].data[0]+this.data[1]*n[0].data[4]+this.data[2]*n[0].data[8]+this.data[3]*n[0].data[12],u=this.data[0]*n[0].data[1]+this.data[1]*n[0].data[5]+this.data[2]*n[0].data[9]+this.data[3]*n[0].data[13],a=this.data[0]*n[0].data[2]+this.data[1]*n[0].data[6]+this.data[2]*n[0].data[10]+this.data[3]*n[0].data[14],f=this.data[0]*n[0].data[3]+this.data[1]*n[0].data[7]+this.data[2]*n[0].data[11]+this.data[3]*n[0].data[15],l=this.data[4]*n[0].data[0]+this.data[5]*n[0].data[4]+this.data[6]*n[0].data[8]+this.data[7]*n[0].data[12],c=this.data[4]*n[0].data[1]+this.data[5]*n[0].data[5]+this.data[6]*n[0].data[9]+this.data[7]*n[0].data[13],h=this.data[4]*n[0].data[2]+this.data[5]*n[0].data[6]+this.data[6]*n[0].data[10]+this.data[7]*n[0].data[14],p=this.data[4]*n[0].data[3]+this.data[5]*n[0].data[7]+this.data[6]*n[0].data[11]+this.data[7]*n[0].data[15],d=this.data[8]*n[0].data[0]+this.data[9]*n[0].data[4]+this.data[10]*n[0].data[8]+this.data[11]*n[0].data[12],v=this.data[8]*n[0].data[1]+this.data[9]*n[0].data[5]+this.data[10]*n[0].data[9]+this.data[11]*n[0].data[13],m=this.data[8]*n[0].data[2]+this.data[9]*n[0].data[6]+this.data[10]*n[0].data[10]+this.data[11]*n[0].data[14],g=this.data[8]*n[0].data[3]+this.data[9]*n[0].data[7]+this.data[10]*n[0].data[11]+this.data[11]*n[0].data[15],y=this.data[12]*n[0].data[0]+this.data[13]*n[0].data[4]+this.data[14]*n[0].data[8]+this.data[15]*n[0].data[12],b=this.data[12]*n[0].data[1]+this.data[13]*n[0].data[5]+this.data[14]*n[0].data[9]+this.data[15]*n[0].data[13],w=this.data[12]*n[0].data[2]+this.data[13]*n[0].data[6]+this.data[14]*n[0].data[10]+this.data[15]*n[0].data[14],E=this.data[12]*n[0].data[3]+this.data[13]*n[0].data[7]+this.data[14]*n[0].data[11]+this.data[15]*n[0].data[15];this.data[0]=o,this.data[1]=u,this.data[2]=a,this.data[3]=f,this.data[4]=l,this.data[5]=c,this.data[6]=h,this.data[7]=p,this.data[8]=d,this.data[9]=v,this.data[10]=m,this.data[11]=g,this.data[12]=y,this.data[13]=b,this.data[14]=w,this.data[15]=E}else if(n[0]instanceof e.Matrix3x4){var o=this.data[0]*n[0].data[0]+this.data[1]*n[0].data[4]+this.data[2]*n[0].data[8],u=this.data[0]*n[0].data[1]+this.data[1]*n[0].data[5]+this.data[2]*n[0].data[9],a=this.data[0]*n[0].data[2]+this.data[1]*n[0].data[6]+this.data[2]*n[0].data[10],f=this.data[0]*n[0].data[3]+this.data[1]*n[0].data[7]+this.data[2]*n[0].data[11]+this.data[3],l=this.data[4]*n[0].data[0]+this.data[5]*n[0].data[4]+this.data[6]*n[0].data[8],c=this.data[4]*n[0].data[1]+this.data[5]*n[0].data[5]+this.data[6]*n[0].data[9],h=this.data[4]*n[0].data[2]+this.data[5]*n[0].data[6]+this.data[6]*n[0].data[10],p=this.data[4]*n[0].data[3]+this.data[5]*n[0].data[7]+this.data[6]*n[0].data[11]+this.data[7],d=this.data[8]*n[0].data[0]+this.data[9]*n[0].data[4]+this.data[10]*n[0].data[8],v=this.data[8]*n[0].data[1]+this.data[9]*n[0].data[5]+this.data[10]*n[0].data[9],m=this.data[8]*n[0].data[2]+this.data[9]*n[0].data[6]+this.data[10]*n[0].data[10],g=this.data[8]*n[0].data[3]+this.data[9]*n[0].data[7]+this.data[10]*n[0].data[11]+this.data[11],y=this.data[12]*n[0].data[0]+this.data[13]*n[0].data[4]+this.data[14]*n[0].data[8],b=this.data[12]*n[0].data[1]+this.data[13]*n[0].data[5]+this.data[14]*n[0].data[9],w=this.data[12]*n[0].data[2]+this.data[13]*n[0].data[6]+this.data[14]*n[0].data[10],E=this.data[12]*n[0].data[3]+this.data[13]*n[0].data[7]+this.data[14]*n[0].data[11]+this.data[15];this.data[0]=o,this.data[1]=u,this.data[2]=a,this.data[3]=f,this.data[4]=l,this.data[5]=c,this.data[6]=h,this.data[7]=p,this.data[8]=d,this.data[9]=v,this.data[10]=m,this.data[11]=g,this.data[12]=y,this.data[13]=b,this.data[14]=w,this.data[15]=E}}return this},t.prototype.SubED=function(e){return this.data[0]-=e.data[0],this.data[1]-=e.data[1],this.data[2]-=e.data[2],this.data[3]-=e.data[3],this.data[4]-=e.data[4],this.data[5]-=e.data[5],this.data[6]-=e.data[6],this.data[7]-=e.data[7],this.data[8]-=e.data[8],this.data[9]-=e.data[9],this.data[10]-=e.data[10],this.data[11]-=e.data[11],this.data[12]-=e.data[12],this.data[13]-=e.data[13],this.data[14]-=e.data[14],this.data[15]-=e.data[15],this},t.prototype.AddED=function(e){return this.data[0]+=e.data[0],this.data[1]+=e.data[1],this.data[2]+=e.data[2],this.data[3]+=e.data[3],this.data[4]+=e.data[4],this.data[5]+=e.data[5],this.data[6]+=e.data[6],this.data[7]+=e.data[7],this.data[8]+=e.data[8],this.data[9]+=e.data[9],this.data[10]+=e.data[10],this.data[11]+=e.data[11],this.data[12]+=e.data[12],this.data[13]+=e.data[13],this.data[14]+=e.data[14],this.data[15]+=e.data[15],this},t.prototype.SetScale=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length!=1)return;typeof t[0]=="number"?(this.data[0]=t[0],this.data[5]=t[0],this.data[10]=t[0]):t[0]instanceof e.Vector3&&(this.data[0]=t[0].x,this.data[5]=t[0].y,this.data[10]=t[0].z)},t.prototype.ToMatrix3=function(){return new e.Matrix3(this.data[0],this.data[1],this.data[2],this.data[4],this.data[5],this.data[6],this.data[8],this.data[9],this.data[10])},t.prototype.RotationMatrix=function(){var t=new e.Vector3(1/Math.sqrt(this.data[0]*this.data[0]+this.data[4]*this.data[4]+this.data[8]*this.data[8]),1/Math.sqrt(this.data[1]*this.data[1]+this.data[5]*this.data[5]+this.data[9]*this.data[9]),1/Math.sqrt(this.data[2]*this.data[2]+this.data[6]*this.data[6]+this.data[10]*this.data[10]));return this.ToMatrix3().Scaled(t)},t.prototype.Translation=function(){return new e.Vector3(this.data[3],this.data[7],this.data[11])},t.prototype.MultiTranslate=function(e){var n=new t;n.SetTranslation(e),this.MultiplyED(n)},t.prototype.MultiRotatiton=function(e){var n=new t;n.SetRotation(e.RotationMatrix()),this.copyFrom(n.MultiplyED(this))},t.prototype.MultiScale=function(e){var n=new t;n.SetScale(e),this.copyFrom(n.MultiplyED(this))},t.prototype.Rotation=function(){return new e.Quaternion(this.RotationMatrix())},t.prototype.Scale=function(){return new e.Vector3(Math.sqrt(this.data[0]*this.data[0]+this.data[4]*this.data[4]+this.data[8]*this.data[8]),Math.sqrt(this.data[1]*this.data[1]+this.data[5]*this.data[5]+this.data[9]*this.data[9]),Math.sqrt(this.data[2]*this.data[2]+this.data[6]*this.data[6]+this.data[10]*this.data[10]))},t.prototype.Transpose=function(){return new t(this.data[0],this.data[4],this.data[8],this.data[12],this.data[1],this.data[5],this.data[9],this.data[13],this.data[2],this.data[6],this.data[10],this.data[14],this.data[3],this.data[7],this.data[11],this.data[15])},t.prototype.TransposeED=function(){var e=this.data[0],t=this.data[4],n=this.data[8],r=this.data[12],i=this.data[1],s=this.data[5],o=this.data[9],u=this.data[13],a=this.data[2],f=this.data[6],l=this.data[10],c=this.data[14],h=this.data[3],p=this.data[7],d=this.data[11],v=this.data[15];return this.data[0]=e,this.data[1]=t,this.data[2]=n,this.data[3]=r,this.data[4]=i,this.data[5]=s,this.data[6]=o,this.data[7]=u,this.data[8]=a,this.data[9]=f,this.data[10]=l,this.data[11]=c,this.data[12]=h,this.data[13]=p,this.data[14]=d,this.data[15]=v,this},t.prototype.Ortho=function(n,r,i,s,o,u){if(e.Equals(n,r)||e.Equals(i,s)||e.Equals(o,u))return;var a=r-n,f=s-i,l=u-o,c=new t;c.data[0]=2/a,c.data[4]=0,c.data[8]=0,c.data[12]=-(n+r)/a,c.data[1]=0,c.data[5]=2/f,c.data[9]=0,c.data[13]=-(s+i)/f,c.data[2]=0,c.data[6]=0,c.data[10]=-2/l,c.data[14]=-(o+u)/l,c.data[3]=0,c.data[7]=0,c.data[11]=0,c.data[15]=1,this.copyFrom(this.Multiply(c))},t.prototype.LookAt=function(n,r,i,s,o,u,a,f,l){var c,h,p,d=new t;c=new e.Vector3(s-n,o-r,u-i),p=new e.Vector3(a,f,l),c.Normalize(),h=c.CrossProduct(p),h.Normalize(),p=h.CrossProduct(c),p.Normalize(),d.data[0]=h.x,d.data[4]=h.y,d.data[8]=h.z,d.data[1]=p.x,d.data[5]=p.y,d.data[9]=p.z,d.data[2]=-c.x,d.data[6]=-c.y,d.data[10]=-c.z,d.data[3]=n,d.data[7]=r,d.data[11]=i,this.copyFrom(d)},t.prototype.Decompose=function(t,n,r){t.x=this.data[3],t.y=this.data[7],t.z=this.data[11],r.x=Math.sqrt(this.data[0]*this.data[0]+this.data[4]*this.data[4]+this.data[8]*this.data[8]),r.y=Math.sqrt(this.data[1]*this.data[1]+this.data[5]*this.data[5]+this.data[9]*this.data[9]),r.z=Math.sqrt(this.data[2]*this.data[2]+this.data[6]*this.data[6]+this.data[10]*this.data[10]);var i=new e.Vector3(1/r.x,1/r.y,1/r.z),s=new e.Quaternion(this.ToMatrix3().Scaled(i));n.copyFrom(s)},t.prototype.Inverse=function(){var e=this.data[8]*this.data[13]-this.data[9]*this.data[12],n=this.data[8]*this.data[14]-this.data[10]*this.data[12],r=this.data[8]*this.data[15]-this.data[11]*this.data[12],i=this.data[9]*this.data[14]-this.data[10]*this.data[13],s=this.data[9]*this.data[15]-this.data[11]*this.data[13],o=this.data[10]*this.data[15]-this.data[11]*this.data[14],u=o*this.data[5]-s*this.data[6]+i*this.data[7],a=-(o*this.data[4]-r*this.data[6]+n*this.data[7]),f=s*this.data[4]-r*this.data[5]+e*this.data[7],l=-(i*this.data[4]-n*this.data[5]+e*this.data[6]),c=1/(u*this.data[0]+a*this.data[1]+f*this.data[2]+l*this.data[3]);u*=c,a*=c,f*=c,l*=c;var h=-(o*this.data[1]-s*this.data[2]+i*this.data[3])*c,p=(o*this.data[0]-r*this.data[2]+n*this.data[3])*c,d=-(s*this.data[0]-r*this.data[1]+e*this.data[3])*c,v=(i*this.data[0]-n*this.data[1]+e*this.data[2])*c;e=this.data[4]*this.data[13]-this.data[5]*this.data[12],n=this.data[4]*this.data[14]-this.data[6]*this.data[12],r=this.data[4]*this.data[15]-this.data[7]*this.data[12],i=this.data[5]*this.data[14]-this.data[6]*this.data[13],s=this.data[5]*this.data[15]-this.data[7]*this.data[13],o=this.data[6]*this.data[15]-this.data[7]*this.data[14];var m=(o*this.data[1]-s*this.data[2]+i*this.data[3])*c,g=-(o*this.data[0]-r*this.data[2]+n*this.data[3])*c,y=(s*this.data[0]-r*this.data[1]+e*this.data[3])*c,b=-(i*this.data[0]-n*this.data[1]+e*this.data[2])*c;e=this.data[9]*this.data[4]-this.data[8]*this.data[5],n=this.data[10]*this.data[4]-this.data[8]*this.data[6],r=this.data[11]*this.data[4]-this.data[8]*this.data[7],i=this.data[10]*this.data[5]-this.data[9]*this.data[6],s=this.data[11]*this.data[5]-this.data[9]*this.data[7],o=this.data[11]*this.data[6]-this.data[10]*this.data[7];var w=-(o*this.data[1]-s*this.data[2]+i*this.data[3])*c,E=(o*this.data[0]-r*this.data[2]+n*this.data[3])*c,S=-(s*this.data[0]-r*this.data[1]+e*this.data[3])*c,x=(i*this.data[0]-n*this.data[1]+e*this.data[2])*c;return new t(u,h,m,w,a,p,g,E,f,d,y,S,l,v,b,x)},t.prototype.InverseED=function(){var e=this.data[8]*this.data[13]-this.data[9]*this.data[12],t=this.data[8]*this.data[14]-this.data[10]*this.data[12],n=this.data[8]*this.data[15]-this.data[11]*this.data[12],r=this.data[9]*this.data[14]-this.data[10]*this.data[13],i=this.data[9]*this.data[15]-this.data[11]*this.data[13],s=this.data[10]*this.data[15]-this.data[11]*this.data[14],o=s*this.data[5]-i*this.data[6]+r*this.data[7],u=-(s*this.data[4]-n*this.data[6]+t*this.data[7]),a=i*this.data[4]-n*this.data[5]+e*this.data[7],f=-(r*this.data[4]-t*this.data[5]+e*this.data[6]),l=1/(o*this.data[0]+u*this.data[1]+a*this.data[2]+f*this.data[3]);o*=l,u*=l,a*=l,f*=l;var c=-(s*this.data[1]-i*this.data[2]+r*this.data[3])*l,h=(s*this.data[0]-n*this.data[2]+t*this.data[3])*l,p=-(i*this.data[0]-n*this.data[1]+e*this.data[3])*l,d=(r*this.data[0]-t*this.data[1]+e*this.data[2])*l;e=this.data[4]*this.data[13]-this.data[5]*this.data[12],t=this.data[4]*this.data[14]-this.data[6]*this.data[12],n=this.data[4]*this.data[15]-this.data[7]*this.data[12],r=this.data[5]*this.data[14]-this.data[6]*this.data[13],i=this.data[5]*this.data[15]-this.data[7]*this.data[13],s=this.data[6]*this.data[15]-this.data[7]*this.data[14];var v=(s*this.data[1]-i*this.data[2]+r*this.data[3])*l,m=-(s*this.data[0]-n*this.data[2]+t*this.data[3])*l,g=(i*this.data[0]-n*this.data[1]+e*this.data[3])*l,y=-(r*this.data[0]-t*this.data[1]+e*this.data[2])*l;e=this.data[9]*this.data[4]-this.data[8]*this.data[5],t=this.data[10]*this.data[4]-this.data[8]*this.data[6],n=this.data[11]*this.data[4]-this.data[8]*this.data[7],r=this.data[10]*this.data[5]-this.data[9]*this.data[6],i=this.data[11]*this.data[5]-this.data[9]*this.data[7],s=this.data[11]*this.data[6]-this.data[10]*this.data[7];var b=-(s*this.data[1]-i*this.data[2]+r*this.data[3])*l,w=(s*this.data[0]-n*this.data[2]+t*this.data[3])*l,E=-(i*this.data[0]-n*this.data[1]+e*this.data[3])*l,S=(r*this.data[0]-t*this.data[1]+e*this.data[2])*l;return this.data[0]=o,this.data[1]=c,this.data[2]=v,this.data[3]=b,this.data[4]=u,this.data[5]=h,this.data[6]=m,this.data[7]=w,this.data[8]=a,this.data[9]=p,this.data[10]=g,this.data[11]=E,this.data[12]=f,this.data[13]=d,this.data[14]=y,this.data[15]=S,this},t.BulkTranspose=function(e,t){for(var n=0;n<e.length&&n<t.length;++n){if(e[n].length!=16||t[n].length!=16)continue;e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15]}},t.prototype.Data=function(){return this.data},t.prototype.Value=function(e,t){return this.data[e*4+t]},t.prototype.ToMatrix3x4=function(){var t=new e.Matrix3x4;return t.copyFrom(this),t},t.prototype.Tostring=function(){return this.data[0].toString()+" "+this.data[1].toString()+" "+this.data[2].toString()+" "+this.data[3].toString()+" "+this.data[4].toString()+" "+this.data[5].toString()+" "+this.data[6].toString()+" "+this.data[7].toString()+" "+this.data[8].toString()+" "+this.data[9].toString()+" "+this.data[10].toString()+" "+this.data[11].toString()+" "+this.data[12].toString()+" "+this.data[13].toString()+" "+this.data[14].toString()+" "+this.data[15].toString()},t.prototype.fromString=function(e){var t=!1,n=" ",r=e.split(n);if(r.length==16){for(var i=0;i<16;i++)this.data[i]=parseFloat(r[i]);t=!0}return t},t.ZERO=function(){return t._ZERO==null&&(t._ZERO=new t(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)),t._ZERO},t.IDENTITY=function(){return t._IDENTITY==null&&(t._IDENTITY=new t),t._IDENTITY},t}();e.Matrix4=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];this.d=0,this.normal=new e.Vector3,this.absNormal=new e.Vector3;var i=!0;n.length===1?n[0]instanceof t?(i=!1,this.normal=n[0].normal,this.absNormal=n[0].absNormal,this.d=n[0].d):n[0]instanceof e.Vector4&&(i=!1,this.Define(n[0])):n.length===2?n[0]instanceof e.Vector3&&typeof n[1]=="number"?(i=!1,this.normal=n[0],this.absNormal=this.normal.Abs(),this.d=n[1]):n[0]instanceof e.Vector3&&n[1]instanceof e.Vector3&&(i=!1,this.Define(n[0],n[1])):n.length===3&&n[0]instanceof e.Vector3&&n[1]instanceof e.Vector3&&n[2]instanceof e.Vector3&&(i=!1,this.Define(n[0],n[1],n[2])),i&&(this.d=0)}return t.prototype.Define=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length===1)t[0]instanceof e.Vector4&&(this.normal=new e.Vector3(t[0].x,t[0].y,t[0].z),this.absNormal=this.normal.Abs(),this.d=t[0].w);else if(t.length===2)t[0]instanceof e.Vector3&&t[1]instanceof e.Vector3&&(this.normal=t[0].Normalized(),this.absNormal=this.normal.Abs(),this.d=-this.normal.DotProduct(t[1]));else if(t.length===3&&t[0]instanceof e.Vector3&&t[1]instanceof e.Vector3&&t[2]instanceof e.Vector3){var r=t[1].Sub(t[0]),i=t[2].Sub(t[0]);this.Define(r.CrossProductED(i),t[0])}},t.prototype.Clone=function(){return new t(this)},t.prototype.Transform=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length!=1)return;t[0]instanceof e.Matrix3?this.Define((new e.Matrix4(t[0])).InverseED().TransposeED().Multiply(this.ToVector4())):t[0]instanceof e.Matrix3x4?this.Define(t[0].ToMatrix4().InverseED().TransposeED().Multiply(this.ToVector4())):t[0]instanceof e.Matrix4&&this.Define(t[0].Inverse().TransposeED().Multiply(this.ToVector4()))},t.prototype.ToVector4=function(){return new e.Vector4(this.normal,this.d)},t.prototype.Project=function(e){return e.Sub(this.normal.Multiply(this.normal.DotProduct(e)+this.d))},t.prototype.Distance=function(e){return this.normal.DotProduct(e)+this.d},t.prototype.Reflect=function(e){return e.Sub(this.normal.Multiply(2*this.normal.DotProduct(e)))},t.prototype.ReflectionMatrix=function(){return new e.Matrix3x4(-2*this.normal.x*this.normal.x+1,-2*this.normal.x*this.normal.y,-2*this.normal.x*this.normal.z,-2*this.normal.x*this.d,-2*this.normal.y*this.normal.x,-2*this.normal.y*this.normal.y+1,-2*this.normal.y*this.normal.z,-2*this.normal.y*this.d,-2*this.normal.z*this.normal.x,-2*this.normal.z*this.normal.y,-2*this.normal.z*this.normal.z+1,-2*this.normal.z*this.d)},t.prototype.Transformed=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length!=1)return;if(n[0]instanceof e.Matrix3)return new t((new e.Matrix4(n[0])).InverseED().TransposeED().Multiply(this.ToVector4()));if(n[0]instanceof e.Matrix3x4)return new t(n[0].ToMatrix4().InverseED().TransposeED().Multiply(this.ToVector4()));if(n[0]instanceof e.Matrix4)return new t(n[0].Inverse().TransposeED().Multiply(this.ToVector4()))},t.prototype.GetInsectPnt=function(e,t){var n=this.normal.DotProduct(e.GetDirection());if(Math.abs(n)<1e-8)return!1;var r=e.GetOrigin(),i=(-this.d-this.normal.DotProduct(r))/n;return i>=0?(t=r.Add(e.GetDirection().Multiply(i)),!0):!1},t.prototype.copyFrom=function(e){this.normal.copyFrom(e.normal),this.absNormal.copyFrom(e.absNormal),this.d=e.d},t}();e.Plane=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];var i=!0;n.length===1?n[0]instanceof e.Vector4?(i=!1,this.min=new e.Vector2(n[0].x,n[0].y),this.max=new e.Vector2(n[0].z,n[0].w),this.defined=!0):n[0]instanceof t?(i=!1,this.min=new e.Vector2(n[0].min),this.max=new e.Vector2(n[0].max),this.defined=n[0].defined):n[0]instanceof Float32Array&&n[0].length>=4&&(i=!1,this.min=new e.Vector2(n[0][0],n[0][1]),this.max=new e.Vector2(n[0][2],n[0][3]),this.defined=!0):n.length===2?n[0]instanceof e.Vector2&&n[1]instanceof e.Vector2&&(i=!1,this.min=new e.Vector2,this.max=new e.Vector2,this.min.copyFrom(n[0]),this.max.copyFrom(n[1]),this.defined=!0):n.length>=4&&(this.min=new e.Vector2(n[0],n[1]),this.max=new e.Vector2(n[2],n[3]),this.defined=!0),i&&(this.min=new e.Vector2,this.max=new e.Vector2,this.min.copyFrom(e.Vector2.ZERO()),this.max.copyFrom(e.Vector2.ZERO()),this.defined=!1)}return t.prototype.copyFrom=function(e){this.min.copyFrom(e.min),this.max.copyFrom(e.max),this.defined=e.defined},t.prototype.Equals=function(e){return this.min.Equals(e.min)&&this.max.Equals(e.max)},t.prototype.Define=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];n.length===1?n[0]instanceof t?(this.min.copyFrom(n[0].min),this.max.copyFrom(n[0].max),this.defined=!0):n[0]instanceof e.Vector2&&(this.min.copyFrom(n[0]),this.max.copyFrom(n[0]),this.defined=!0):n.length===2&&(this.min.copyFrom(n[0]),this.max.copyFrom(n[1]),this.defined=!0)},t.prototype.Merge=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length!==1)return;n[0]instanceof e.Vector2?(this.defined||(this.min=this.max=n[0],this.defined=!0),n[0].x<this.min.x&&(this.min.x=n[0].x),n[0].x>this.max.x&&(this.max.x=n[0].x),n[0].y<this.min.y&&(this.min.y=n[0].y),n[0].y>this.max.y&&(this.max.y=n[0].y)):n[0]instanceof t&&(this.defined||(this.min=n[0].min,this.max=n[0].max,this.defined=!0),n[0].min.x<this.min.x&&(this.min.x=n[0].min.x),n[0].min.y<this.min.y&&(this.min.y=n[0].min.y),n[0].max.x>this.max.x&&(this.max.x=n[0].max.x),n[0].max.y>this.max.y&&(this.max.y=n[0].max.y))},t.prototype.Clear=function(){this.min=e.Vector2.ZERO(),this.max=e.Vector2.ZERO(),this.defined=!1},t.prototype.Clip=function(e){e.min.x>this.min.x&&(this.min.x=e.min.x),e.max.x<this.max.x&&(this.max.x=e.max.x),e.min.y>this.min.y&&(this.min.y=e.min.y),e.max.y<this.max.y&&(this.max.y=e.max.y);if(this.min.x>this.max.x){var t=this.min.x;this.min.x=this.max.x,this.max.x=t}if(this.min.y>this.max.y){var t=this.min.y;this.min.y=this.max.y,this.max.y=t}},t.prototype.Center=function(){return this.max.Add(this.min).MultiplyED(.5)},t.prototype.Size=function(){return this.max.Sub(this.min)},t.prototype.HalSize=function(){return this.max.Sub(this.min).MultiplyED(.5)},t.prototype.IsInside=function(t){return t.x<this.min.x||t.y<this.min.y||t.x>this.max.x||t.y>this.max.y?e.Intersection.OUTSIDE:e.Intersection.INSIDE},t.prototype.ToVector4=function(){return new e.Vector4(this.min.x,this.min.y,this.max.x,this.max.y)},t.prototype.Tostring=function(){return this.min.x.toString()+" "+this.min.y.toString()+" "+this.max.x.toString()+" "+this.max.y},t.FULL=function(){return t.full==null&&(t.full=new t(-1,-1,1,1)),t.full},t.POSITIVE=function(){return t.positive==null&&(t.positive=new t(0,0,1,1)),t.positive},t.ZERO=function(){return t.zero==null&&(t.zero=new t(0,0,0,0)),t.zero},t.full=null,t.positive=null,t.zero=null,t}();e.Rect=t;var n=function(){function t(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];e.length===0?(this.left=0,this.top=0,this.right=0,this.bottom=0):e.length===1?(this.left=e[0],this.top=e[1],this.right=e[2],this.bottom=e[3]):e.length===4&&(this.left=e[0],this.top=e[1],this.right=e[2],this.bottom=e[3])}return t.prototype.copyFrom=function(e){this.left=e.left,this.top=e.top,this.right=e.right,this.bottom=e.bottom},t.prototype.Equal=function(e){return this.left===e.left&&this.top===e.top&&this.right===e.right&&this.bottom===e.bottom},t.prototype.NotEqual=function(e){return this.left!==e.left||this.top!==e.top||this.right!==e.right||this.bottom!==e.bottom},t.prototype.Size=function(){return new e.Vector2(this.Width(),this.Height())},t.prototype.Width=function(){return this.right-this.left},t.prototype.Height=function(){return this.bottom-this.top},t.prototype.Center=function(){return new e.Vector2(this.left+this.Width()/2,this.top+this.Height()/2)},t.prototype.Data=function(){return this.left},t.prototype.IsInside=function(t){return t.x<this.left||t.y<this.top||t.x>=this.right||t.y>=this.bottom?e.OUTSIDE:e.INSIDE},t.prototype.Tostring=function(){return this.left.toString()+" "+this.top.toString()+" "+this.right.toString()+" "+this.bottom.toString()},t.ZERO=function(){return t.zero==null&&(t.zero=new t(0,0,0,0)),t.zero},t.zero=null,t}();e.IntRect=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];var i=!0;this.origin=new e.Vector3,this.direction=new e.Vector3,n.length==1?n[0]instanceof t&&(i=!1,this.origin.copyFrom(n[0].origin),this.direction.copyFrom(n[0].direction)):n.length==2&&n[0]instanceof e.Vector3&&n[1]instanceof e.Vector3&&(i=!1,this.Define(n[0],n[1]))}return t.prototype.copyFrom=function(e){this.origin.copyFrom(e.origin),this.direction.copyFrom(e.direction)},t.prototype.Equals=function(e){return this.origin.Equals(e.origin)&&this.direction.Equals(e.direction)},t.prototype.Define=function(e,t){this.origin=e.Clone(),this.direction.copyFrom(t.Normalized())},t.prototype.Project=function(e){var t=e.Sub(this.origin);return this.origin.Add(this.direction.Multiply(t.DotProduct(this.direction)))},t.prototype.Distance=function(e){var t=this.Project(e);return e.Sub(t).Length()},t.prototype.Clone=function(){var e=new t;return e.origin=this.origin,e.direction=this.direction,e},t.prototype.ClosestPoint=function(t){var n=this.origin.Sub(t.origin),r=t.direction,i=this.direction,s=n.DotProduct(r),o=r.DotProduct(i),u=n.DotProduct(i),a=r.DotProduct(r),f=i.DotProduct(i),l=f*a-o*o;if(e.Abs(l)<e.EPSILON)return this.origin.Clone();var c=s*o-u*a,h=c/l;return this.origin.Add(this.direction.Multiply(h))},t.prototype.HitDistance=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length==1){if(t[0]instanceof e.Plane){var r=t[0].normal.DotProduct(this.direction);if(e.Abs(r)>=e.EPSILON){var i=-(t[0].normal.DotProduct(this.origin)+t[0].d)/r;return i>=0?i:e.INFINITY}return e.INFINITY}if(t[0]instanceof e.BoundingBox){if(!t[0].defined)return e.INFINITY;if(t[0].IsInside(this.origin))return 0;var s=e.INFINITY;if(this.origin.x<t[0].min.x&&this.direction.x>0){var o=(t[0].min.x-this.origin.x)/this.direction.x;if(o<s){var u=this.origin.Add(this.direction.Multiply(o));u.y>=t[0].min.y&&u.y<=t[0].max.y&&u.z>=t[0].min.z&&u.z<=t[0].max.z&&(s=o)}}if(this.origin.x>t[0].max.x&&this.direction.x<0){var o=(t[0].max.x-this.origin.x)/this.direction.x;if(o<s){var u=this.origin.Add(this.direction.Multiply(o));u.y>=t[0].min.y&&u.y<=t[0].max.y&&u.z>=t[0].min.z&&u.z<=t[0].max.z&&(s=o)}}if(this.origin.y<t[0].min.y&&this.direction.y>0){var o=(t[0].min.y-this.origin.y)/this.direction.y;if(o<s){var u=this.origin.Add(this.direction.Multiply(o));u.x>=t[0].min.x&&u.x<=t[0].max.x&&u.z>=t[0].min.z&&u.z<=t[0].max.z&&(s=o)}}if(this.origin.y>t[0].max.y&&this.direction.y<0){var o=(t[0].max.y-this.origin.y)/this.direction.y;if(o<s){var u=this.origin.Add(this.direction.Multiply(o));u.x>=t[0].min.x&&u.x<=t[0].max.x&&u.z>=t[0].min.z&&u.z<=t[0].max.z&&(s=o)}}if(this.origin.z<t[0].min.z&&this.direction.z>0){var o=(t[0].min.z-this.origin.z)/this.direction.z;if(o<s){var u=this.origin.Add(this.direction.Multiply(o));u.x>=t[0].min.x&&u.x<=t[0].max.x&&u.y>=t[0].min.y&&u.y<=t[0].max.y&&(s=o)}}if(this.origin.z>t[0].max.z&&this.direction.z<0){var o=(t[0].max.z-this.origin.z)/this.direction.z;if(o<s){var u=this.origin.Add(this.direction.Multiply(o));u.x>=t[0].min.x&&u.x<=t[0].max.x&&u.y>=t[0].min.y&&u.y<=t[0].max.y&&(s=o)}}return s}}else if(t.length==2){if(t[0]instanceof e.Frustum&&t[1]instanceof Boolean){var a=0,f=e.INFINITY,l=!0;for(var c=0;c<e.NUFRUSTUPLANES;++c){var h=t[0].planes[c],p=this.HitDistance(t[0].planes[c]);h.Distance(this.origin)<0?(a=e.Max(a,p),l=!1):f=e.Min(f,p)}return l?t[1]?0:f:a<=f?a:e.INFINITY}}else if(t.length>=3&&t[0]instanceof e.Vector3&&t[1]instanceof e.Vector3&&t[2]instanceof e.Vector3){var d=t[1].Sub(t[0]),v=t[2].Sub(t[0]),m=new e.Vector3(this.direction.CrossProduct(v)),g=d.DotProduct(m);if(g>=e.EPSILON){var i=this.origin.Sub(t[0]),y=i.DotProduct(m);if(y>=0&&y<=g){var b=i.CrossProductED(d),w=this.direction.DotProduct(b);if(w>=0&&y+w<=g){var p=v.DotProduct(b)/g;if(p>=0)return t[2]&&t[2].copyFrom(d.CrossProductED(v)),p}}}return e.INFINITY}},t.prototype.Transformed=function(n){var r=new t;return r.origin=n.Multiply(this.origin),r.direction=n.Multiply(new e.Vector4(this.direction,0)),r},t.prototype.GetDirection=function(){return this.direction},t.prototype.GetOrigin=function(){return this.origin},t}();e.Ray=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){}return t.prototype.IsInside=function(t){var n=this.radius_*this.radius_,r=0,i,s=t.min.Clone(),o=t.max.Clone();this.center_.x<s.x?(i=this.center_.x-s.x,r+=i*i):this.center_.x>o.x&&(i=this.center_.x-o.x,r+=i*i),this.center_.y<s.y?(i=this.center_.y-s.y,r+=i*i):this.center_.y>o.y&&(i=this.center_.y-o.y,r+=i*i),this.center_.z<s.z?(i=this.center_.z-s.z,r+=i*i):this.center_.z>o.z&&(i=this.center_.z-o.z,r+=i*i);if(r>=n)return e.OUTSIDE;s=s.Sub(this.center_).Clone(),o=s.Sub(this.center_).Clone();var u=s.Clone();return u.LengthSquared()>=n?e.INTERSECTS:(u.x=o.x,u.LengthSquared()>=n?e.INTERSECTS:(u.y=o.y,u.LengthSquared()>=n?e.INTERSECTS:(u.x=s.x,u.LengthSquared()>=n?e.INTERSECTS:(u.z=o.z,u.LengthSquared()>=n?e.INTERSECTS:(u.y=s.y,u.LengthSquared()>=n?e.INTERSECTS:(u.x=o.x,u.LengthSquared()>=n?e.INTERSECTS:(u.y=o.y,u.LengthSquared()>=n?e.INTERSECTS:e.INSIDE)))))))},t.prototype.GetCenter=function(){return this.center_},t.prototype.SetCenter=function(e){this.center_=e},t.prototype.SetRadius=function(e){this.radius_=e},t.prototype.GetRadius=function(){return this.radius_},t.prototype.Distance=function(t){return e.Max(t.Sub(this.center_).Length()-this.radius_,0)},t}();e.Sphere=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){this._count=0,this._data={}}return e.prototype.get=function(e){var t=this._data[e];return t!==undefined?t:undefined},e.prototype.getOrAddWithFactory=function(e,t){var n=this.get(e);return n!==undefined?n:(n=t(e),n&&this.add(e,n),n)},e.prototype.getOrAdd=function(e,t){var n=this.get(e);return n!==undefined?n:(this.add(e,t),t)},e.prototype.contains=function(e){return this._data[e]!==undefined},e.prototype.add=function(e,t){return this._data[e]!==undefined?!1:(this._data[e]=t,++this._count,!0)},e.prototype.set=function(e,t){return this._data[e]===undefined?!1:(this._data[e]=t,!0)},e.prototype.remove=function(e){return this.contains(e)?(delete this._data[e],--this._count,!0):!1},e.prototype.clear=function(){this._data={},this._count=0},Object.defineProperty(e.prototype,"count",{get:function(){return this._count},enumerable:!0,configurable:!0}),e.prototype.forEach=function(e){for(var t in this._data){var n=this._data[t];e(t,n)}},e.prototype.first=function(e){for(var t in this._data){var n=this._data[t],r=e(t,n);if(r)return r}return null},e}();e.StringDictionary=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){this.isStart=!1,this.outerTimerId=-1,this.innerTimerId=-1,this.interval=36,this.task=null}return e.prototype.SetTimer=function(e,t,n){this.task=e,this.interval=n,this.data=t},e.prototype.StartTimer=function(){this.isStart=!0;var e=this;this.outerTimerId=setTimeout(function(){e.task(e.data),e.IsStart()&&(e.innerTimerId=setTimeout(arguments.callee,e.interval))},e.interval)},e.prototype.StopTimer=function(){this.isStart=!1,clearTimeout(this.innerTimerId),clearTimeout(this.outerTimerId)},e.prototype.IsStart=function(){return this.isStart},e}();e.Timer=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];var r=!0;e.length===1?e[0]instanceof t?(r=!1,this.x=e[0].x,this.y=e[0].y):e[0]instanceof Float32Array&&e[0].length===2&&(r=!1,this.x=e[0][0],this.y=e[0][1]):e.length===2&&typeof e[0]=="number"&&typeof e[1]=="number"&&(r=!1,this.x=e[0],this.y=e[1]),r&&(this.x=this.y=0)}return t.prototype.Clone=function(){return new t(this)},t.prototype.copyFrom=function(e){this.x=e.x,this.y=e.y},t.prototype.Equals=function(t){return e.Equals(this.x,t.x)&&e.Equals(this.y,t.y)},t.prototype.Add=function(e){return new t(this.x+e.x,this.y+e.y)},t.prototype.AddED=function(e){return this.x+=e.x,this.y+=e.y,this},t.prototype.Sub=function(e){return new t(this.x-e.x,this.y-e.y)},t.prototype.SubED=function(e){return this.x-=e.x,this.y-=e.y,this},t.prototype.Multiply=function(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];return e.length!==1?null:typeof e[0]=="number"?new t(this.x*e[0],this.y*e[0]):e[0]instanceof t?new t(this.x*e[0].x,this.y*e[0].y):null},t.prototype.MultiplyED=function(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];return e.length!==1?this:typeof e[0]=="number"?(this.x*=e[0],this.y*=e[0],this):e[0]instanceof t?(this.x*=e[0].x,this.y*=e[0].y,this):this},t.prototype.Divide=function(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];return e.length!==1?null:typeof e[0]=="number"?new t(this.x/e[0],this.y/e[0]):e[0]instanceof t?new t(this.x/e[0].x,this.y/e[0].y):null},t.prototype.DivideED=function(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];return e.length!==1?this:typeof e[0]=="number"?(this.x/=e[0],this.y/=e[0],this):e[0]instanceof t?(this.x/=e[0].x,this.y/=e[0].y,this):this},t.prototype.LengthSquared=function(){return this.x*this.x+this.y*this.y},t.prototype.Normalize=function(){var t=this.LengthSquared();if(!e.Equals(t,1)&&t>0){var n=1/Math.sqrt(t);this.x*=n,this.y*=n}return this},t.prototype.Length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},t.prototype.DotProduct=function(e){return this.x*e.x+this.y*e.y},t.prototype.AbsDotProduct=function(e){return Math.abs(this.x*e.x)+Math.abs(this.y*e.y)},t.prototype.Abs=function(){return new t(Math.abs(this.x),Math.abs(this.y))},t.prototype.AbsED=function(){return this.x<0&&(this.x=-this.x),this.y<0&&(this.y=-this.y),this},t.prototype.Lerp=function(e,t){return this.Multiply(1-t).AddED(e.Multiply(t))},t.prototype.LerpED=function(e,t){return this.MultiplyED(1-t).AddED(e.Multiply(t)),this},t.prototype.IsZero=function(){return this.LengthSquared()<1e-8},t.prototype.Nagative=function(){return this.Multiply(-1)},t.prototype.NagativeED=function(){return this.x*=-1,this.y*=-1,this},t.prototype.ToZero=function(){this.copyFrom(t.ZERO())},t.prototype.ToOne=function(){this.copyFrom(t.ONE())},t.prototype.Normalized=function(){var n=this.LengthSquared();if(!e.Equals(n,1)&&n>0){var r=1/Math.sqrt(n);return this.Multiply(r)}return new t(this)},t.prototype.NormalizedED=function(){var t=this.LengthSquared();if(!e.Equals(t,1)&&t>0){var n=1/Math.sqrt(t);return this.MultiplyED(n)}return this},t.prototype.Data=function(){var e=new Float32Array(2);return e[0]=this.x,e[1]=this.y,e},t.prototype.Tostring=function(){return this.x.toString()+" "+this.y.toString()},t.ZERO=function(){return t._ZERO==null&&(t._ZERO=new t),t._ZERO},t.LEFT=function(){return t._LEFT==null&&(t._LEFT=new t(-1,0)),t._LEFT},t.RIGHT=function(){return t._RIGHT==null&&(
t._RIGHT=new t(1,0)),t._RIGHT},t.UP=function(){return t._UP==null&&(t._UP=new t(0,1)),t._UP},t.DOWN=function(){return t._DOWN==null&&(t._DOWN=new t(0,-1)),t._DOWN},t.ONE=function(){return t._ONE==null&&(t._ONE=new t(1,1)),t._ONE},t}();e.Vector2=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];var i=!0;n.length===1?n[0]instanceof t?(i=!1,this.x=n[0].x,this.y=n[0].y,this.z=n[0].z,this.w=n[0].w):n[0]instanceof e.Matrix3?(i=!1,this.FromRotationMatrix(n[0])):typeof n[0]=="number"?(i=!1,this.FromAngleAxis(n[0],e.Vector3.FORWARD())):n[0]instanceof Float32Array&&n[0].length===4&&(i=!1,this.w=n[0][0],this.x=n[0][1],this.y=n[0][2],this.z=n[0][3]):n.length===2?(i=!1,n[1]instanceof e.Vector3&&typeof n[0]=="number"?this.FromAngleAxis(n[0],n[1]):n[1]instanceof e.Vector3&&n[0]instanceof e.Vector3&&this.FromRotationTo(n[0],n[1])):n.length===3?typeof n[0]=="number"&&typeof n[1]=="number"&&typeof n[2]=="number"?(i=!1,this.FromEulerAngles(n[0],n[1],n[2])):n[0]instanceof e.Vector3&&n[1]instanceof e.Vector3&&n[2]instanceof e.Vector3&&(i=!1,this.FromAxes(n[0],n[1],n[2])):n.length===4&&(i=!1,this.w=n[0],this.x=n[1],this.y=n[2],this.z=n[3]),i&&(this.w=1,this.x=this.y=this.z=0)}return t.prototype.IsZero=function(){return this.x*this.x+this.y*this.y+this.z*this.z<1e-8},t.prototype.FromAxes=function(t,n,r){var i=new e.Matrix3(t.x,n.x,r.x,t.y,n.y,r.y,t.z,n.z,r.z);this.FromRotationMatrix(i)},t.prototype.ToMatrix=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p;t=2/(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w),n=this.x*t,r=this.y*t,i=this.z*t,s=this.w*n,o=this.w*r,u=this.w*i,a=this.x*n,f=this.x*r,l=this.x*i,c=this.y*r,h=this.y*i,p=this.z*i,e[0][0]=1-(c+p),e[0][1]=f+u,e[0][2]=l-o,e[0][3]=0,e[1][0]=f-u,e[1][1]=1-(a+p),e[1][2]=h+s,e[1][3]=0,e[2][0]=l+o,e[2][1]=h-s,e[2][2]=1-(a+c),e[2][3]=0,e[3][0]=0,e[3][1]=0,e[3][2]=0,e[3][3]=1},t.prototype.FromEulerAngles=function(t,n,r){t*=e.DEGTORAD_2,n*=e.DEGTORAD_2,r*=e.DEGTORAD_2;var i=Math.sin(t),s=Math.cos(t),o=Math.sin(n),u=Math.cos(n),a=Math.sin(r),f=Math.cos(r);this.w=u*s*f+o*i*a,this.x=u*i*f+o*s*a,this.y=o*s*f-u*i*a,this.z=u*s*a-o*i*f},t.prototype.FromRotationTo=function(t,n){var r=t.Normalized(),i=n.Normalized(),s=r.DotProduct(i);if(s>-1+e.EPSILON){var o=r.CrossProduct(i),u=Math.sqrt((1+s)*2),a=1/u;this.x=o.x*a,this.y=o.y*a,this.z=o.z*a,this.w=.5*u}else{var f=e.Vector3.RIGHT().CrossProduct(r);f.Length()<e.EPSILON&&(f=e.Vector3.UP().CrossProduct(r)),this.FromAngleAxis(180,f)}},t.prototype.Clone=function(){return new t(this)},t.prototype.FromAngleAxis=function(t,n){var r=n.Normalized();t*=e.DEGTORAD_2;var i=Math.sin(t),s=Math.cos(t);this.w=s,this.x=r.x*i,this.y=r.y*i,this.z=r.z*i},t.prototype.FromRotationMatrix=function(e){var t=e.data[0]+e.data[4]+e.data[8];if(t>0){var n=.5/Math.sqrt(1+t);this.x=(e.data[7]-e.data[5])*n,this.y=(e.data[2]-e.data[6])*n,this.z=(e.data[3]-e.data[1])*n,this.w=.25/n}else if(e.data[0]>e.data[4]&&e.data[0]>e.data[8]){var n=.5/Math.sqrt(1+e.data[0]-e.data[4]-e.data[8]);this.x=.25/n,this.y=(e.data[1]+e.data[3])*n,this.z=(e.data[6]+e.data[2])*n,this.w=(e.data[7]-e.data[5])*n}else if(e.data[4]>e.data[8]){var n=.5/Math.sqrt(1+e.data[4]-e.data[0]-e.data[8]);this.x=(e.data[1]+e.data[3])*n,this.y=.25/n,this.z=(e.data[5]+e.data[7])*n,this.w=(e.data[2]-e.data[6])*n}else{var n=.5/Math.sqrt(1+e.data[8]-e.data[0]-e.data[4]);this.x=(e.data[2]+e.data[6])*n,this.y=(e.data[5]+e.data[7])*n,this.z=.25/n,this.w=(e.data[3]-e.data[1])*n}},t.prototype.FromLookRotation=function(e,n){var r=e.Normalized(),i=n.Normalized(),s=r.CrossProduct(i).Normalized();i=s.CrossProduct(r).Normalized();var o=new t;return o.FromAxes(s,i,r.Nagative()),this.copyFrom(o),!0},t.prototype.copyFrom=function(e){this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w},t.prototype.Equal=function(e,t){if(t>=0){var n=this.x-e.x,r=this.y-e.y,i=this.z-e.z,s=this.w-e.w;return Math.abs(n)<=t&&Math.abs(r)<=t&&Math.abs(i)<=t&&Math.abs(s)<=t?!0:!1}return!1},t.prototype.Equals=function(t){return e.Equals(this.x,t.x)&&e.Equals(this.y,t.y)&&e.Equals(this.z,t.z)&&e.Equals(this.w,t.w)},t.prototype.Add=function(e){return new t(this.w+e.w,this.x+e.x,this.y+e.y,this.z+e.z)},t.prototype.AddED=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},t.prototype.Sub=function(e){return new t(this.w-e.w,this.x-e.x,this.y-e.y,this.z-e.z)},t.prototype.SubED=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},t.prototype.Multiply=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length!==1)return null;if(typeof n[0]=="number")return new t(this.w*n[0],this.x*n[0],this.y*n[0],this.z*n[0]);if(n[0]instanceof t)return new t(this.w*n[0].w-this.x*n[0].x-this.y*n[0].y-this.z*n[0].z,this.w*n[0].x+this.x*n[0].w+this.y*n[0].z-this.z*n[0].y,this.w*n[0].y+this.y*n[0].w+this.z*n[0].x-this.x*n[0].z,this.w*n[0].z+this.z*n[0].w+this.x*n[0].y-this.y*n[0].x);if(n[0]instanceof e.Vector3){var i=new e.Vector3(this.x,this.y,this.z),s=i.CrossProduct(n[0]),o=i.CrossProductED(s);return n[0].Add(s.MultiplyED(this.w).AddED(o).MultiplyED(2))}return null},t.prototype.MultiplyED=function(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];if(e.length!==1)return this;if(typeof e[0]=="number")this.x*=e[0],this.y*=e[0],this.z*=e[0],this.w*=e[0];else if(e[0]instanceof t){var r=this.w*e[0].w-this.x*e[0].x-this.y*e[0].y-this.z*e[0].z,i=this.w*e[0].x+this.x*e[0].w+this.y*e[0].z-this.z*e[0].y,s=this.w*e[0].y+this.y*e[0].w+this.z*e[0].x-this.x*e[0].z,o=this.w*e[0].z+this.z*e[0].w+this.x*e[0].y-this.y*e[0].x;this.w=r,this.x=i,this.y=s,this.z=o}return this},t.prototype.LengthSquared=function(){return this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z},t.prototype.Normalize=function(){var t=this.LengthSquared();if(!e.Equals(t,1)&&t>0){var n=1/Math.sqrt(t);this.w*=n,this.x*=n,this.y*=n,this.z*=n}},t.prototype.NormalizeED=function(){var t=this.LengthSquared();if(!e.Equals(t,1)&&t>0){var n=1/Math.sqrt(t);this.w*=n,this.x*=n,this.y*=n,this.z*=n}return this},t.prototype.ToZero=function(){this.copyFrom(t.IDENTITY())},t.prototype.Normalized=function(){var n=this.LengthSquared();if(!e.Equals(n,1)&&n>0){var r=1/Math.sqrt(n);return this.Multiply(r)}return new t(this)},t.prototype.NormalizedED=function(){var t=this.LengthSquared();if(!e.Equals(t,1)&&t>0){var n=1/Math.sqrt(t);return this.MultiplyED(n)}return this},t.prototype.Conjugate=function(){return new t(this.w,-this.x,-this.y,-this.z)},t.prototype.Inverse=function(){var n=this.LengthSquared();return e.Equals(n,1)?this.Conjugate():n>=e.EPSILON?this.Conjugate().Multiply(1/n):t.IDENTITY().Clone()},t.prototype.ConjugateED=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},t.prototype.InverseED=function(){var n=this.LengthSquared();return e.Equals(n,1)?this.ConjugateED():n>=e.EPSILON?this.ConjugateED().MultiplyED(1/n):t.IDENTITY().Clone()},t.prototype.DotProduct=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},t.prototype.EulerAngles=function(){var t=2*(-this.y*this.z+this.w*this.x);return t<-0.995?new e.Vector3(-90,0,-Math.atan2(2*(this.x*this.z-this.w*this.y),1-2*(this.y*this.y+this.z*this.z))*e.RADTODEG):t>.995?new e.Vector3(90,0,Math.atan2(2*(this.x*this.z-this.w*this.y),1-2*(this.y*this.y+this.z*this.z))*e.RADTODEG):new e.Vector3(Math.asin(t)*e.RADTODEG,Math.atan2(2*(this.x*this.z+this.w*this.y),1-2*(this.x*this.x+this.y*this.y))*e.RADTODEG,Math.atan2(2*(this.x*this.y+this.w*this.z),1-2*(this.x*this.x+this.z*this.z))*e.RADTODEG)},t.prototype.YawAngle=function(){return this.EulerAngles().y},t.prototype.PitchAngle=function(){return this.EulerAngles().x},t.prototype.RollAngle=function(){return this.EulerAngles().z},t.prototype.RotationMatrix=function(){return new e.Matrix3(1-2*this.y*this.y-2*this.z*this.z,2*this.x*this.y-2*this.w*this.z,2*this.x*this.z+2*this.w*this.y,2*this.x*this.y+2*this.w*this.z,1-2*this.x*this.x-2*this.z*this.z,2*this.y*this.z-2*this.w*this.x,2*this.x*this.z-2*this.w*this.y,2*this.y*this.z+2*this.w*this.x,1-2*this.x*this.x-2*this.y*this.y)},t.prototype.Slerp=function(e,t){var n=this.DotProduct(e);n<0&&(n=-n,e=e.Multiply(-1));var r=Math.acos(n),i=Math.sin(r),s,o;if(i>.001){var u=1/i;s=Math.sin((1-t)*r)*u,o=Math.sin(t*r)*u}else s=1-t,o=t;return this.Multiply(s).AddED(e.Multiply(o))},t.prototype.SlerpED=function(e,t){var n=this.DotProduct(e);n<0&&(n=-n,e=e.Multiply(-1));var r=Math.acos(n),i=Math.sin(r),s,o;if(i>.001){var u=1/i;s=Math.sin((1-t)*r)*u,o=Math.sin(t*r)*u}else s=1-t,o=t;return this.MultiplyED(s).AddED(e.Multiply(o))},t.prototype.Nlerp=function(e,t,n){var r,i=this.DotProduct(e);return i<0&&n?r=this.Add(e.Multiply(-1).SubED(this).MultiplyED(t)):r=this.Add(e.Sub(this).MultiplyED(t)),r.NormalizeED(),r},t.prototype.NlerpED=function(e,t,n){var r,i=this.DotProduct(e);return i<0&&n?r=this.AddED(e.Multiply(-1).SubED(this).MultiplyED(t)):r=this.AddED(e.Sub(this).MultiplyED(t)),r.NormalizeED(),r},t.QslerpNoInvertExtraSpins=function(e,t,n,r){var i=e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w,s=Math.acos(i);if(Math.abs(s)<.005)return e;var o=Math.sin(s),u=1/o,a=3.1415927*r*n,f=Math.sin((1-n)*s-a)*u,l=Math.sin(n*s+a)*u;return e.Multiply(f).AddED(t.Multiply(l))},t.Qexp=function(e){var n=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z),r=Math.sin(n),i=Math.cos(n),s=new t;return s.w=i,n>0?(s.x=r*e.x/n,s.y=r*e.y/n,s.z=r*e.z/n):s.x=s.y=s.z=0,s},t.Qlog=function(e){var n=Math.acos(e.w),r=Math.sin(n),i=new t;return i.w=0,r>0?(i.x=n*e.x/r,i.y=n*e.y/r,i.z=n*e.z/r):i.x=i.y=i.z=0,i},t.Qspline=function(e,n,r){var i=new t;return i.x=-n.x,i.y=-n.y,i.z=-n.z,i.w=n.w,n.Multiply(t.Qexp(t.Qlog(i.Multiply(e)).AddED(t.Qlog(i.Multiply(r))).MultiplyED(-1/4)))},t.Qsquad=function(e,n,r,i,s){var o,u;o=t.QslerpNoInvert(e,n,s),u=t.QslerpNoInvert(r,i,s);var a=t.QslerpNoInvert(o,u,2*s*(1-s));return a},t.Qlerp=function(e,n,r){var i=new t;return i=e.Add(n.Sub(e).MultiplyED(r)),i.NormalizeED()},t.QslerpNoInvert=function(e,n,r){var i=e.x*n.x+e.y*n.y+e.z*n.z+e.w*n.w,s=new t;if(i>-0.95&&i<.95){var o=Math.acos(i),u=void 0,a=void 0,f=void 0;return u=Math.sin(o),a=Math.sin(o*r),f=Math.sin(o*(1-r)),s=e.Multiply(f).AddED(n.Multiply(a)).Multiply(1/u),s}return s=t.Qlerp(e,n,r),s},t.MatrixToQuaternion=function(n){var r=e.ArrayMaker.MakeNumArray(4),i,s,o,u,a;i=n[0][0]+n[1][1]+n[2][2];if(i>0)s=Math.sqrt(i+1),r[3]=s*.5,s=.5/s,r[0]=(n[1][2]-n[2][1])*s,r[1]=(n[2][0]-n[0][2])*s,r[2]=(n[0][1]-n[1][0])*s;else{o=0,n[1][1]>n[0][0]&&(o=1),n[2][2]>n[o][o]&&(o=2);var f=[1,2,0];u=f[o],a=f[u],s=Math.sqrt(n[o][o]-(n[u][u]+n[a][a])+1),r[o]=s*.5,s=.5/s,r[3]=(n[u][a]-n[a][u])*s,r[u]=(n[o][u]+n[u][o])*s,r[a]=(n[o][a]+n[a][o])*s}return new t(r[3],r[0],r[1],r[2])},t.prototype.Data=function(){var e=new Float32Array(4);return e[0]=this.w,e[1]=this.x,e[2]=this.y,e[3]=this.z,e},t.prototype.Tostring=function(){return this.x.toString()+" "+this.y.toString()+" "+this.z.toString()+" "+this.w.toString()},t.IDENTITY=function(){return t._IDENTITY==null&&(t._IDENTITY=new t),t._IDENTITY},t}();e.Quaternion=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];var i=!0;n.length===1?n[0]instanceof t?(i=!1,this.x=n[0].x,this.y=n[0].y,this.z=n[0].z):n[0]instanceof e.Vector2?(i=!1,this.x=n[0].x,this.y=n[0].y,this.z=0):n[0]instanceof Float32Array&&n[0].length===3&&(i=!1,this.x=n[0][0],this.y=n[0][1],this.z=n[0][2]):n.length===2?n[0]instanceof e.Vector2&&typeof n[1]=="number"?(i=!1,this.x=n[0].x,this.y=n[0].y,this.z=n[1]):typeof n[0]=="number"&&typeof n[1]=="number"&&(i=!1,this.x=n[0],this.y=n[1],this.z=0):n.length===3&&(i=!1,this.x=n[0],this.y=n[1],this.z=n[2]),i&&(this.x=this.y=this.z=0)}return t.prototype.Clone=function(){return new t(this)},t.prototype.copyFrom=function(e){this.x=e.x,this.y=e.y,this.z=e.z},t.prototype.copyFromXYZ=function(e,t,n){this.x=e,this.y=t,this.z=n},t.prototype.Equal=function(t,n){return n===void 0&&(n=e.HPOINT_EPSILON),this.x-t.x<n&&this.x-t.x>-n&&this.y-t.y<n&&this.y-t.y>-n&&this.z-t.z<n&&this.z-t.z>-n},t.prototype.Equals=function(t){return e.Equals(this.x,t.x)&&e.Equals(this.y,t.y)&&e.Equals(this.z,t.z)},t.prototype.Add=function(e){return new t(this.x+e.x,this.y+e.y,this.z+e.z)},t.prototype.AddED=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},t.prototype.Sub=function(e){return new t(this.x-e.x,this.y-e.y,this.z-e.z)},t.prototype.SubFill=function(e,t){t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z},t.prototype.SubED=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},t.prototype.Multiply=function(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];return e.length!==1?null:typeof e[0]=="number"?new t(this.x*e[0],this.y*e[0],this.z*e[0]):e[0]instanceof t?new t(this.x*e[0].x,this.y*e[0].y,this.z*e[0].z):null},t.prototype.MultiplyED=function(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];return e.length!==1?this:typeof e[0]=="number"?(this.x*=e[0],this.y*=e[0],this.z*=e[0],this):e[0]instanceof t?(this.x*=e[0].x,this.y*=e[0].y,this.z*=e[0].z,this):this},t.prototype.Divide=function(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];return e.length!==1?null:typeof e[0]=="number"?new t(this.x/e[0],this.y/e[0],this.z/e[0]):e[0]instanceof t?new t(this.x/e[0].x,this.y/e[0].y,this.z/e[0].z):null},t.prototype.DivideED=function(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];return e.length!==1?this:typeof e[0]=="number"?(this.x/=e[0],this.y/=e[0],this.z/=e[0],this):e[0]instanceof t?(this.x/=e[0].x,this.y/=e[0].y,this.z/=e[0].z,this):this},t.prototype.LengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z},t.prototype.Normalize=function(){var t=this.LengthSquared();if(!e.Equals(t,1)&&t>0){var n=1/Math.sqrt(t);this.x*=n,this.y*=n,this.z*=n}},t.prototype.NormalizeED=function(){var t=this.LengthSquared();if(!e.Equals(t,1)&&t>0){var n=1/Math.sqrt(t);this.x*=n,this.y*=n,this.z*=n}return this},t.prototype.Length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},t.prototype.DotProduct=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},t.prototype.AbsDotProduct=function(e){return Math.abs(this.x*e.x)+Math.abs(this.y*e.y)+Math.abs(this.z*e.z)},t.prototype.CrossProduct=function(e){return new t(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)},t.prototype.CrossProductFill=function(e,t){t.x=this.y*e.z-this.z*e.y,t.y=this.z*e.x-this.x*e.z,t.z=this.x*e.y-this.y*e.x},t.prototype.CrossProductED=function(e){var t=this.y*e.z-this.z*e.y,n=this.z*e.x-this.x*e.z,r=this.x*e.y-this.y*e.x;return this.x=t,this.y=n,this.z=r,this},t.prototype.Abs=function(){return new t(Math.abs(this.x),Math.abs(this.y),Math.abs(this.z))},t.prototype.AbsED=function(){return this.x<0&&(this.x=-this.x),this.y<0&&(this.y=-this.y),this.z<0&&(this.z=-this.z),this},t.prototype.Lerp=function(e,t){return this.Multiply(1-t).AddED(e.Multiply(t))},t.prototype.LerpED=function(e,t){return this.MultiplyED(1-t).AddED(e.Multiply(t))},t.prototype.Angle=function(t){return e.Acos(this.DotProduct(t)/(this.Length()*t.Length()))},t.prototype.IsZero=function(){return this.LengthSquared()<1e-8},t.prototype.Nagative=function(){return this.Multiply(-1)},t.prototype.NagativeED=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},t.prototype.ToZero=function(){this.copyFrom(t.ZERO())},t.prototype.ToOne=function(){this.copyFrom(t.ONE())},t.prototype.Normalized=function(){var n=this.LengthSquared();if(!e.Equals(n,1)&&n>0){var r=1/Math.sqrt(n);return this.Multiply(r)}return new t(this)},t.prototype.NormalizedED=function(){var t=this.LengthSquared();if(!e.Equals(t,1)&&t>0){var n=1/Math.sqrt(t);return this.MultiplyED(n)}return this},t.prototype.Data=function(){var e=new Float32Array(3);return e[0]=this.x,e[1]=this.y,e[2]=this.z,e},t.prototype.Tostring=function(){return"x:"+this.x.toString()+"  y:"+this.y.toString()+"  Z:"+this.z.toString()},t.prototype.toPlainString=function(){return this.x.toString()+" "+this.y.toString()+" "+this.z.toString()},t.prototype.fromString=function(e){var t=!1,n=" ",r=e.split(n);return r.length==3&&(this.x=parseFloat(r[0]),this.y=parseFloat(r[1]),this.z=parseFloat(r[2]),t=!0),t},t.ZERO=function(){return t._ZERO==null&&(t._ZERO=new t),t._ZERO},t.LEFT=function(){return t._LEFT==null&&(t._LEFT=new t(-1,0,0)),t._LEFT},t.RIGHT=function(){return t._RIGHT==null&&(t._RIGHT=new t(1,0,0)),t._RIGHT},t.UP=function(){return t._UP==null&&(t._UP=new t(0,1,0)),t._UP},t.DOWN=function(){return t._DOWN==null&&(t._DOWN=new t(0,-1,0)),t._DOWN},t.FORWARD=function(){return t._FORWARD==null&&(t._FORWARD=new t(0,0,1)),t._FORWARD},t.BACK=function(){return t._BACK==null&&(t._BACK=new t(0,0,-1)),t._BACK},t.ONE=function(){return t._ONE==null&&(t._ONE=new t(1,1,1)),t._ONE},t.MINIMUM=function(){return t._MINIMUM==null&&(t._MINIMUM=new t(-99999,-99999,-9999)),t._MINIMUM},t.MAXMUN=function(){return t._MAXMUN==null&&(t._MAXMUN=new t(99999,99999,9999)),t._MAXMUN},t.BYTE_SIZE=12,t}();e.Vector3=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];var i=!0;n.length===1?n[0]instanceof t?(i=!1,this.x=n[0].x,this.y=n[0].y,this.z=n[0].z,this.w=n[0].w):n[0]instanceof Float32Array&&n[0].length===4&&(i=!1,this.x=n[0][0],this.y=n[0][1],this.z=n[0][2],this.w=n[0][3]):n.length===2?n[0]instanceof e.Vector3&&typeof n[1]=="number"&&(i=!1,this.x=n[0].x,this.y=n[0].y,this.z=n[0].z,this.w=n[1]):n.length===4&&(i=!1,this.x=n[0],this.y=n[1],this.z=n[2],this.w=n[3]),i&&(this.x=this.y=this.z=this.w=0)}return t.prototype.Clone=function(){return new t(this)},t.prototype.GetVector3=function(){return new e.Vector3(this.x,this.y,this.z)},t.prototype.copyFrom=function(e){this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w},t.prototype.Equals=function(t){return e.Equals(this.x,t.x)&&e.Equals(this.y,t.y)&&e.Equals(this.z,t.z)&&e.Equals(this.w,t.w)},t.prototype.Add=function(e){return new t(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)},t.prototype.AddED=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},t.prototype.Sub=function(e){return new t(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)},t.prototype.SubED=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},t.prototype.Multiply=function(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];return e.length!==1?null:typeof e[0]=="number"?new t(this.x*e[0],this.y*e[0],this.z*e[0],this.w*e[0]):e[0]instanceof t?new t(this.x*e[0].x,this.y*e[0].y,this.z*e[0].z,this.w*e[0].w):null},t.prototype.MultiplyED=function(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];return e.length!==1?this:typeof e[0]=="number"?(this.x*=e[0],this.y*=e[0],this.z*=e[0],this.w*=e[0],this):e[0]instanceof t?(this.x*=e[0].x,this.y*=e[0].y,this.z*=e[0].z,this.w*=e[0].w,this):this},t.prototype.Divide=function(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];return e.length!==1?null:typeof e[0]=="number"?new t(this.x/e[0],this.y/e[0],this.z/e[0],this.w/e[0]):e[0]instanceof t?new t(this.x/e[0].x,this.y/e[0].y,this.z/e[0].z,this.w/e[0].w):null},t.prototype.DivideED=function(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];return e.length!==1?this:typeof e[0]=="number"?(this.x/=e[0],this.y/=e[0],this.z/=e[0],this.w/=e[0],this):e[0]instanceof t?(this.x/=e[0].x,this.y/=e[0].y,this.z/=e[0].z,this.w/=e[0].w,this):this},t.prototype.DotProduct=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},t.prototype.AbsDotProduct=function(e){return Math.abs(this.x*e.x)+Math.abs(this.y*e.y)+Math.abs(this.z*e.z)+Math.abs(this.w*e.w)},t.prototype.Abs=function(){return new t(Math.abs(this.x),Math.abs(this.y),Math.abs(this.z),Math.abs(this.w))},t.prototype.AbsED=function(){return this.x<0&&(this.x=-this.x),this.y<0&&(this.y=-this.y),this.z<0&&(this.z=-this.z),this.w<0&&(this.w=-this.w),this},t.prototype.Lerp=function(e,t){return this.Multiply(1-t).AddED(e.Multiply(t))},t.prototype.LerpED=function(e,t){return this.MultiplyED(1-t).AddED(e.Multiply(t))},t.prototype.Data=function(){var e=new Float32Array(4);return e[0]=this.x,e[1]=this.y,e[2]=this.z,e[3]=this.w,e},t.prototype.Tostring=function(){return this.x.toString()+" "+this.y.toString()+this.z.toString()+this.w.toString()},t.ZERO=function(){return t._ZERO==null&&(t._ZERO=new t),t._ZERO},t.ONE=function(){return t._ONE==null&&(t._ONE=new t(1,1,1,1)),t._ONE},t}();e.Vector4=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];this.rect=new e.IntRect,t.length===0?this.rect.copyFrom(e.IntRect.ZERO()):t[0]instanceof e.Camera&&t[1]instanceof e.IntRect&&(this.camera=t[0],this.rect.copyFrom(t[1]))}return t.prototype.SetCamera=function(e){this.camera=e},t.prototype.SetRect=function(e){this.rect.copyFrom(e)},t.prototype.GetRect=function(){return this.rect},t.prototype.GetCamera=function(){return this.camera},t.prototype.GetScreenRay=function(t,n){if(!this.camera)return new e.Ray;var r=0,i=0;return this.rect.Equal(e.IntRect.ZERO())||(r=(t-this.rect.left)/this.rect.Width(),i=(n-this.rect.top)/this.rect.Height()),this.camera.GetScreenRay(r,i)},t.prototype.WorldToScreenPoint=function(t){if(!this.camera)return new e.Vector2(e.Vector2.ZERO());var n=this.camera.WorldToScreenPoint(t),r=0,i=0;return this.rect.Equal(e.IntRect.ZERO())||(r=this.rect.left+n.x*this.rect.Width(),i=this.rect.top+n.y*this.rect.Height()),new e.Vector2(r,i)},t.prototype.ScreenToWorldPoint=function(t,n,r){if(!this.camera)return e.Vector3.ZERO().Clone();var i=0,s=0;return this.rect.Equal(e.IntRect.ZERO())||(i=(t-this.rect.left)/this.rect.Width(),s=(n-this.rect.top)/this.rect.Height()),this.camera.ScreenToWorldPoint(new e.Vector3(i,s,r))},t.prototype.Clone=function(){return null},t}();e.Viewport=t})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.SHAPE_FEATURE_COORDINATE=-2]="SHAPE_FEATURE_COORDINATE",e[e.SHAPE_COORDINATE=-1]="SHAPE_COORDINATE",e[e.SHAPE_POINT=0]="SHAPE_POINT",e[e.SHAPE_EDGE=1]="SHAPE_EDGE",e[e.SHAPE_FACE=2]="SHAPE_FACE",e[e.SHAPE_BODY=3]="SHAPE_BODY",e[e.SHAPE_MODEL=4]="SHAPE_MODEL",e[e.SHAPE_NOTE=5]="SHAPE_NOTE",e[e.CURVE_UNKNOWN=6]="CURVE_UNKNOWN",e[e.CURVE_POLYLINE=7]="CURVE_POLYLINE",e[e.CURVE_ELLIPSE=8]="CURVE_ELLIPSE",e[e.CURVE_LINE=9]="CURVE_LINE",e[e.CURVE_NURBSCURVE=10]="CURVE_NURBSCURVE",e[e.CURVE_HYPERBOLA=11]="CURVE_HYPERBOLA",e[e.CURVE_PARABOLA=12]="CURVE_PARABOLA",e[e.CURVE_REF_POLYLINE=13]="CURVE_REF_POLYLINE",e[e.SHAPE_TRIMESH=20]="SHAPE_TRIMESH",e[e.SHAPE_REF_TRIMESH=21]="SHAPE_REF_TRIMESH",e[e.SHAPE_POLYLINE=22]="SHAPE_POLYLINE",e[e.SHAPE_REF_POLYLINE=23]="SHAPE_REF_POLYLINE",e[e.SHAPE_BILLBOARD=25]="SHAPE_BILLBOARD",e[e.SHAPE_ATTRIBUTE_NOTE=30]="SHAPE_ATTRIBUTE_NOTE",e[e.SHAPE_MEASURE_BASE=50]="SHAPE_MEASURE_BASE",e[e.SHAPE_MEASURE_DISTANCE=51]="SHAPE_MEASURE_DISTANCE",e[e.SHAPE_MEASURE_ANGLE=52]="SHAPE_MEASURE_ANGLE",e[e.SHAPE_MEASURE_PROPERTY=53]="SHAPE_MEASURE_PROPERTY",e[e.SHAPE_MEASURE_PNT_PNT_LENGTH=53]="SHAPE_MEASURE_PNT_PNT_LENGTH",e[e.SHAPE_MEASURE_PNT_LINE_LENGTH=54]="SHAPE_MEASURE_PNT_LINE_LENGTH",e[e.SHAPE_MEASURE_PNT_FACE_LENGTH=55]="SHAPE_MEASURE_PNT_FACE_LENGTH",e[e.SHAPE_LIGHT_BASE=70]="SHAPE_LIGHT_BASE",e[e.SHAPE_LIGHT_DIRECTIONAL=71]="SHAPE_LIGHT_DIRECTIONAL",e[e.SHAPE_LIGHT_SPOT=72]="SHAPE_LIGHT_SPOT",e[e.SHAPE_LIGHT_POINT=73]="SHAPE_LIGHT_POINT",e[e.SHAPE_LITTLE_FACE=80]="SHAPE_LITTLE_FACE",e[e.SHAPE_NOTE_BASE=200]="SHAPE_NOTE_BASE",e[e.SHAPE_VOICE_NOTE=201]="SHAPE_VOICE_NOTE",e[e.SHAPE_TEXT_NOTE=202]="SHAPE_TEXT_NOTE",e[e.SHAPE_SEQUENCE_NUMBER_NOTE=203]="SHAPE_SEQUENCE_NUMBER_NOTE",e[e.SHAPE_HANDLE=300]="SHAPE_HANDLE",e[e.SHAPE_POINT_HANDLE=301]="SHAPE_POINT_HANDLE",e[e.SHAPE_PLANE_HANDLE=302]="SHAPE_PLANE_HANDLE",e[e.SHAPE_AXIS_HANDLE=303]="SHAPE_AXIS_HANDLE",e[e.SHAPE_ROTATE_HANDLE=304]="SHAPE_ROTATE_HANDLE",e[e.SHAPE_SCALE_HANDLE=305]="SHAPE_SCALE_HANDLE",e[e.SHAPE_ROTATECENTER=305]="SHAPE_ROTATECENTER",e[e.SHAPE_BASE=1e3]="SHAPE_BASE",e[e.SHAPE_Collection=1001]="SHAPE_Collection",e[e.MODEL_SHAPE=401]="MODEL_SHAPE",e[e.IMAGEMODEL_SHAPE=402]="IMAGEMODEL_SHAPE",e[e.LINEMODEL_SHAPE=403]="LINEMODEL_SHAPE"})(t=e.ShapeType||(e.ShapeType={}));var n=function(){function n(){this.node=null,this.Color=new e.Color,this.initColor=new e.Color(.8,.8,.8,1),this.BoundingBox=new e.BoundingBox,this.IsSelect=!1,this.selectAble=!0,this.Visible=!0,this.type=t.SHAPE_BASE,this.IsSetSelectColor=!1,this.frontShow=!1,this.copyId=-1,this.allowExcluding=!0,this.Init()}return n.prototype.Init=function(){this.Visible=!0,this.IsSelect=!1,this.node=null,this.Id=n.BASEID++,this.IsFirstGetProperties=!0,this.allowExcluding=!0,this.properties=""},n.prototype.Traverse=function(e){},n.prototype.FindVisiableObject=function(e){},n.prototype.GetType=function(){return this.type},n.prototype.SetType=function(e){this.type=e},n.prototype.RayPick=function(e){},n.prototype.SetVisible=function(e){this.Visible=e},n.prototype.IsVisible=function(){return this.Visible},n.prototype.IsSelected=function(){return this.IsSelect},n.prototype.GetSelectAble=function(){return this.selectAble},n.prototype.SetSelectAble=function(e){this.selectAble=e},n.prototype.SetSelected=function(e){this.IsSelect=e},n.prototype.GetID=function(){return this.Id},n.prototype.SetID=function(e){this.Id=e},n.prototype.GetName=function(){return this.Name},n.prototype.SetName=function(e){this.Name=e},n.prototype.GetDrawColor=function(){return this.IsSelected()?this.IsSetSelectColor?this.selectColor:e.Color.SelectColor():this.Color},n.prototype.SetSelectColor=function(e){this.selectColor=e.Clone(),this.IsSetSelectColor=!0},n.prototype.GetSelectColor=function(){return this.selectColor},n.prototype.ResetAlpha=function(){this.SetAlpha(this.initColor.a)},n.prototype.GetInitColor=function(){return this.initColor},n.prototype.SetInitColor=function(e){this.initColor=e.Clone(),this.Color=this.initColor.Clone()},n.prototype.ResetColor=function(){this.Color=this.initColor.Clone()},n.prototype.SetColor=function(e){this.Color=e.Clone()},n.prototype.SetAlpha=function(e){this.Color.a=e},n.prototype.GetColor=function(){return this.Color},n.prototype.GetAlpha=function(){return this.Color.a},n.prototype.SetSceneNode=function(e){this.node=e},n.prototype.GetSceneNode=function(){return this.node},n.prototype.ComputeBox=function(){},n.prototype.SetBox=function(e){this.BoundingBox=e.Clone()},n.prototype.GetBoundingBox=function(){return this.BoundingBox.Defined()||this.ComputeBox(),this.BoundingBox},n.prototype.AssignOperator=function(e){this!==e&&(this.Visible=e.Visible,this.IsSelect=e.IsSelect,this.Color=e.Color.Clone(),this.initColor=e.initColor.Clone(),this.node=null,this.IsFirstGetProperties=e.IsFirstGetProperties,this.properties=e.properties,this.SetType(e.GetType()),this.copyId=e.copyId)},n.prototype.AllowExculding=function(){return this.allowExcluding},n.prototype.SetAlloewExculding=function(e){this.allowExcluding=e},n.prototype.IsFrontShow=function(){return this.frontShow},n.prototype.GetProperties=function(){return this.IsFirstGetProperties&&(this.InitProperties(),this.IsFirstGetProperties=!1),this.properties},n.prototype.InitProperties=function(){},n.prototype.AddProperty=function(e,t){if(this.properties.indexOf(e+"::")>=0)return;this.properties.length!=0&&(this.properties+=";;"),this.properties=this.properties+(e+"::"+t)},n.prototype.ClearProperties=function(){this.properties=""},n.prototype.SetFrontShow=function(e){this.frontShow=e},n.prototype.FramePick=function(e){},n.prototype.SetInitHightlight=function(e){this.m_isHighlight=e},n.prototype.IsHightlight=function(){return this.IsSelect||this.m_isHighlight},n.BASEID=0,n}();e.Shape=n})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.Undefine=-1]="Undefine",e[e.TextNote=0]="TextNote",e[e.VoiceNote=1]="VoiceNote",e[e.VidioNote=2]="VidioNote",e[e.GestureNote=3]="GestureNote",e[e.ImageNote=4]="ImageNote",e[e.ThreeDGestureNote=5]="ThreeDGestureNote"})(t=e.NoteType||(e.NoteType={}));var n=function(t){function n(){var n=t.call(this)||this;return n.renderWorldMatrix=new e.Matrix4,n.PointList=[],n.LineList=[],n.ComTexts=[],n.imageBoardList=[],n.isParallelScreen=!1,n.isFix=!1,n.drawPoints=[],n.drawLines=[],n.isDirty=!0,n.hasLeader=!1,n.bindBillboard=new e.Billboard,n}return __extends(n,t),n.prototype.SetRenderWorldMatrix=function(e){this.renderWorldMatrix=e.Clone()},n.prototype.GetRenderWorldMatrix=function(){return this.renderWorldMatrix},n.prototype.GetRenderColor=function(){return e.Color.Default().Clone()},n.prototype.GetRenderMaterial=function(){return null},n.prototype.SetRenderMesh=function(e){},n.prototype.GetDataLength=function(){return-1},n.prototype.IsUseIndex=function(){return!1},n.prototype.SetIndexOffset=function(e){},n.prototype.GetIndexOffset=function(){return-1},n.prototype.SetNormalOffset=function(e){},n.prototype.GetNormalOffset=function(){return-1},n.prototype.SetVertexOffset=function(e){},n.prototype.GetVertexOffset=function(){return-1},n.prototype.SetTextureCoordsOffset=function(e){},n.prototype.GetTextureCoordsOffset=function(){return-1},n.prototype.SetCentersCoordsOffset=function(e){},n.prototype.GetCentersCoordsOffset=function(){return-1},n.prototype.GetHardWareVertexBuffer=function(){return null},n.prototype.GetHardWareIndexBuffer=function(){return null},n.prototype.AddPoint=function(e){this.PointList.push(e)},n.prototype.AddLine=function(e){this.LineList.push(e)},n.prototype.AddImage=function(e){e!=null&&e!=undefined&&this.imageBoardList.push(e)},n.prototype.AddText=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length===1&&t[0]instanceof e.ComText)this.ComTexts.push(t[0]),this.MarkDirty();else{var r=new e.ComText,i=new e.CText;i.SetText(t[0]),i.SetInnerLoc(t[1]);var s=new e.Vector3,o=new e.Vector3;s.x=0,s.y=0,s.z=0,i.SetInnerXYAxis(s,o),i.SetCharWidthHeight(t[2],t[2]),r.AddCText(i),this.AddText(r),this.MarkDirty()}},n.prototype.SetSelected=function(e){t.prototype.SetSelected.call(this,e);for(var n=0;n<this.imageBoardList.length;n++)this.imageBoardList[n]&&this.imageBoardList[n].SetSelected(e);for(var n=0;n<this.LineList.length;n++)this.LineList[n]&&this.LineList[n].SetSelected(e)},n.prototype.RayPick=function(t){if(!this.IsVisible()||!t.CanPickShape(this.GetType()))return;var n=new e.Vector3,r=null,i=t.GetData().GetModelRay().Clone(),s=this.bindBillboard.GetWorldMatrix().Inverse();i=i.Transformed(s);if(this.imageBoardList.length===0){for(var o=0;o<this.ComTexts.length;o++){var u=this.ComTexts[o],a=u.GetBoundingBox();e.RayPickAction.IsRayHitBox(i,a)&&(n=this.bindBillboard.GetWorldMatrix().Multiply(n),t.AddIntersectPnt(n))}for(var o=0;o<this.LineList.length;o++){var f=this.LineList[o],l=f.StartPoint,c=f.EndPoint;if(t.Intersect(l,c,n)){t.AddIntersectPnt(n);break}}}for(var o=0;o<this.imageBoardList.length;o++)if(this.imageBoardList[o]!==null&&this.imageBoardList[o]!==undefined){var h=this.imageBoardList[o].GetIntersects(t);if(h.length>0)for(var p=0;p<h.length;p++)t.AddIntersectPnt(h[p])}t.AddShape(this)},n.prototype.ComputeBox=function(){this.BoundingBox=new e.BoundingBox(e.Vector3.MINIMUM().Clone(),e.Vector3.MAXMUN().Clone())},n.prototype.FindVisiableObject=function(e){if(this.IsVisible()){this.SetRenderWorldMatrix(e.GetGLWorldMatrix());for(var t=0;t<this.PointList.length;t++)this.PointList[t].UpdateRenderData(e);this.IsDirty()&&this.imageBoardList.length===0&&(this.isDirty=!1),this.bindBillboard.GetGLWorldMatrix(e);for(var t=0;t<this.imageBoardList.length;t++)this.imageBoardList[t]!==null&&this.imageBoardList[t]!==undefined&&this.imageBoardList[t].UpdateRenderData(e);e.PrepareRenderNote(this)}},n.prototype.IsDirty=function(){return this.isDirty},n.prototype.MarkDirty=function(){this.isDirty=!0},n.prototype.IsFix=function(){return this.isFix},n.prototype.SetFix=function(e){this.isFix=e},n.prototype.IsParallelScreen=function(){return this.isParallelScreen},n.prototype.SetParallelScreen=function(e){this.isParallelScreen=e},n.prototype.GetAnchorPnt=function(){},n.prototype.HasLeader=function(){return this.hasLeader},n.prototype.SetHasLeader=function(e){this.hasLeader=e},n.prototype.GetBillBoard=function(){return this.bindBillboard},n.prototype.GetImageBoards=function(){return this.imageBoardList},n.prototype.GetTextValue=function(){var e="";if(this.ComTexts.length>0){var t=this.ComTexts[0];if(t.GetCTextList().length>0){var n=t.GetCText(0);e=n.GetText()}}return e},n.prototype.SetTextValue=function(t){if(this.ComTexts.length>0){var n=this.ComTexts[0],r=new e.CText;r.SetText(t),n.AddCText(r)}else{var i=new e.ComText,r=new e.CText;r.SetText(t),i.AddCText(r),this.ComTexts.push(i)}},n.prototype.Clear=function(){this.PointList=[],this.LineList=[],this.ComTexts=[],this.imageBoardList=[]},n.prototype.InitNote=function(){this.SetAlloewExculding(!1),this.Color=e.Parameters.Instance().DefaultNoteColornew.Clone(),this.SetType(e.ShapeType.SHAPE_NOTE
),this.bindBillboard.AllowRotate(!1),this.bindBillboard.AllowTran(!0),this.bindBillboard.AllowScale(!1),this.isDirty=!0},n.prototype.GetTextsCenter=function(){var t=new e.BoundingBox},n}(e.Shape);e.Note=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n.measureType=-1,n.SetType(e.ShapeType.SHAPE_MEASURE_BASE),n}return __extends(n,t),n.prototype.GetMeasureType=function(){return this.measureType},n.prototype.SetMeasureType=function(e){this.measureType=e},n.MEASURE_TYPE_BASE=0,n.MEASURE_TYPE_PNT_PNT_DISTANCE=1,n.MEASURE_TYPE_PNT_LINE_DISTANCE=2,n.MEASURE_TYPE_PNT_FACE_DISTANCE=3,n.MEASURE_TYPE_LINE_LINE_DISTANCE=4,n.MEASURE_TYPE_LINE_FACE_DISTANCE=5,n.MEASURE_TYPE_FACE_FACE_DISTANCE=6,n.MEASURE_TYPE_LINE_LINE_ANGLE=50,n.MEASURE_TYPE_FACE_FACE_ANGLE=51,n.MEASURE_TYPE_LINE_FACE_ANGLE=52,n.MEASURE_TYPE_CURVE_CURVE_ANGLE=53,n.MEASURE_TYPE_PNT_COORD=100,n.MEASURE_TYPE_LINE_LENGTH=101,n.MEASURE_TYPE_CRICLE_PROPERTY=102,n.MEASURE_TYPE_FACE_PROPERTY=103,n.MEASURE_TYPE_APERTURE_PROPERTY=104,n.MEASURE_TYPE_MODEL_PROPERTY=105,n.MEASURE_TYPE_TEXT_NOTE=150,n.MEASURE_TYPE_VOICE_NOTE=151,n.MEASURE_TYPE_SEQUENCE_NUMBER_NOTE=152,n.MEASURE_TYPE_THREED_GESTURE_NOTE=153,n.MEASURE_TYPE_MODELVIEW_TRACK_LINE=161,n}(e.Note);e.Measure=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var e=t.call(this)||this;return e.InitMeasureDistance(),e}return __extends(n,t),n.prototype.InitMeasureDistance=function(){this.SetType(e.ShapeType.SHAPE_MEASURE_ANGLE)},n}(e.Measure);e.MeasureAngle=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var e=t.call(this)||this;return e.InitMeasureDistance(),e}return __extends(n,t),n.prototype.InitMeasureDistance=function(){this.SetType(e.ShapeType.SHAPE_MEASURE_DISTANCE)},n}(e.Measure);e.MeasureDistance=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){}return t.LeaderColor=function(){return t.m_leaderColor===null&&(t.m_leaderColor=new e.Color(.294,.294,.294)),t.m_leaderColor},t.SelectColor=function(){return t.m_selectColor===null&&(t.m_selectColor=new e.Color(0,1,0)),t.m_selectColor},t.ExLineColor=function(){return t.m_exLineColor===null&&(t.m_exLineColor=new e.Color(.51,1,.51)),t.m_exLineColor},t.MeasureColor1=function(){return t.m_measureColor1===null&&(t.m_measureColor1=new e.Color(0,.443,.78)),t.m_measureColor1},t.MeasureColor2=function(){return t.m_measureColor2===null&&(t.m_measureColor2=new e.Color(.969,.373,.047)),t.m_measureColor2},t.MeasureColor3=function(){return t.m_measureColor3===null&&(t.m_measureColor3=new e.Color(.071,.686,.565)),t.m_measureColor3},t.CreateDistanceMeasure=function(n,r,i,s,o){var u=null;return o===null?u:(i===e.Measure.MEASURE_TYPE_PNT_PNT_DISTANCE?u=this.CreatePntToPntDistance(n,r,s,o):i===e.Measure.MEASURE_TYPE_PNT_LINE_DISTANCE?u=this.createPntToLineDistance(n,r,s,o):i===e.Measure.MEASURE_TYPE_PNT_FACE_DISTANCE?u=this.createPntToFaceDistance(n,r,s,o):i===e.Measure.MEASURE_TYPE_LINE_LINE_DISTANCE?u=this.createLineToLineDistance(n,r,s,o):i===e.Measure.MEASURE_TYPE_LINE_FACE_DISTANCE?u=this.createLineToFaceDistance(n,r,s,o):i===e.Measure.MEASURE_TYPE_FACE_FACE_DISTANCE&&(u=this.createFaceToFaceDistance(n,r,s,o)),t.AddMeasureToScene(o,u),u&&u.SetFrontShow(!0),u)},t.CreateAngleMeasure=function(n,r,i,s,o){var u=null;return o==null?u:(i==e.Measure.MEASURE_TYPE_LINE_LINE_ANGLE?u=this.createLineToLineAngle(n,r,s,o):i==e.Measure.MEASURE_TYPE_FACE_FACE_ANGLE?u=this.createFaceToFaceAngle(n,r,s,o):i==e.Measure.MEASURE_TYPE_LINE_FACE_ANGLE?u=this.createLineToFaceAngle(n,r,s,o):i==e.Measure.MEASURE_TYPE_CURVE_CURVE_ANGLE&&(u=this.createLineToLineAngle(n,r,s,o)),t.AddMeasureToScene(o,u),u&&u.SetFrontShow(!0),u)},t.CreateCurveAngleMeasure=function(n,r,i,s,o,u,a){var f=null;return a==null?f:(o==e.Measure.MEASURE_TYPE_CURVE_CURVE_ANGLE&&(f=this.createCurveToCurveAngle(n,r,i,s,u,a)),t.AddMeasureToScene(a,f),f&&f.SetFrontShow(!0),f)},t.CreatePropertyMeasure=function(n,r,i,s){var o=null;return s==null?o:(r==e.Measure.MEASURE_TYPE_PNT_COORD?o=this.createPntProperty(n,i,s):r==e.Measure.MEASURE_TYPE_LINE_LENGTH?o=this.createLineProperty(n,i,s):r==e.Measure.MEASURE_TYPE_CRICLE_PROPERTY?o=this.createCircleProperty(n,i,s):r==e.Measure.MEASURE_TYPE_FACE_PROPERTY?o=this.createFaceProperty(n,i,s):r!=e.Measure.MEASURE_TYPE_APERTURE_PROPERTY&&r==e.Measure.MEASURE_TYPE_MODEL_PROPERTY&&(o=this.createModelProperty(n,i,s)),t.AddMeasureToScene(s,o),o&&o.SetFrontShow(!0),o)},t.CreateFaceDistanceMeasure=function(n,r,i,s,o,u,a){var f=null;return a==null?f:(o==e.Measure.MEASURE_TYPE_FACE_FACE_DISTANCE&&(f=this.createFaceToFaceDistance(n,r,i,s,u,a)),t.AddMeasureToScene(a,f),f&&f.SetFrontShow(!0),f)},t.CreateFaceAngleMeasure=function(n,r,i,s,o,u,a){var f=null;return a==null?f:(o==e.Measure.MEASURE_TYPE_FACE_FACE_ANGLE?f=this.createFaceToFaceAngle(n,r,i,s,u,a):o==e.Measure.MEASURE_TYPE_LINE_FACE_ANGLE&&(f=this.createLineToFaceAngle(n,r,i,s,u,a)),t.AddMeasureToScene(a,f),f&&f.SetFrontShow(!0),f)},t.GetMeasureProperty=function(t,n,r,i){if(n==e.Measure.MEASURE_TYPE_PNT_COORD)return this.GetPntProperty(t,r,i);if(n==e.Measure.MEASURE_TYPE_LINE_LENGTH||n==e.Measure.MEASURE_TYPE_CRICLE_PROPERTY)return this.GetLineProperty(t,r,i);if(n==e.Measure.MEASURE_TYPE_FACE_PROPERTY)return this.GetFaceProperty(t,r,i);if(n==e.Measure.MEASURE_TYPE_MODEL_PROPERTY)return this.GetModelProperty(t,r,i)},t.CreatePntToPntDistance=function(n,r,i,s){var o=null,u=s.GetShape(n),a=s.GetShape(r);if(u&&a&&u.GetType()===e.ShapeType.SHAPE_POINT_HANDLE&&a.GetType()===e.ShapeType.SHAPE_POINT_HANDLE){o=new e.MeasureDistance,o.SetMeasureType(e.Measure.MEASURE_TYPE_PNT_PNT_DISTANCE);var f=u,l=a,c=f.GetPosition().Clone(),h=l.GetPosition().Clone(),p=c.Sub(h).Length(),d=s.GetCamera().GetViewPort().GetScreenRay(i.x,i.y),v=c.Add(h).Multiply(.5),m=new e.Plane(d.GetDirection(),v),g=m.Project(d.GetOrigin()),y=new e.Line3D(c,h),b=e.Color.BLACK().Clone();y.SetColor(t.MeasureColor1().Clone());var w=new e.Line3D(v,g);w.SetColor(t.LeaderColor().Clone()),w.SetName("MeasureImageLeader");var E=new Array;E.push(p);var S="";S=e.MeasureDisplayHelper.SetMeasureUnit(e.Parameters.Instance().measureUnitStyle,E,S);var x=s.GetSceneBox().Length()/20,T=new e.Point(c);T.SetDrawType(1),T.SetSize(.8);var N=new e.Point(h);N.SetDrawType(1),N.SetSize(.8),o.AddLine(y),o.AddLine(w),o.AddPoint(T),o.AddPoint(N);var C=new e.Shape2DSet,k=250,L=40,A=new e.Vector2(1,1),O=new e.Vector2(k,100),M=450,_=e.Color.GRAY().Clone(),D=e.Color.WHITE().Clone(),P=e.Color.BLACK().Clone(),H=e.Color.GREEN().Clone(),B=e.Color.RED().Clone(),j=e.Color.BLUE().Clone();e.MeasureDisplayHelper.createRectImage(C,A,O,M,t.MeasureColor1().Clone(),D,D,P,"点点距离",E[0].toFixed(3).toString()+S,L,!0);var F=null;e.MeasureDisplayHelper.addImageToMemory(s,F,C,g,(M+k)/100,1.5,o)}else e.LOGE("MeasureFactory.createPntToPntDistance shape is null");return o},t.createPntToLineDistance=function(n,r,i,s){var o=new e.Measure,u=s.GetShape(n),a=s.GetShape(r);if(u&&a&&u.GetType()==e.ShapeType.SHAPE_POINT_HANDLE&&a.GetType()==e.ShapeType.SHAPE_EDGE){o=new e.MeasureDistance,o.SetMeasureType(e.Measure.MEASURE_TYPE_PNT_LINE_DISTANCE);var f=u,l=a,c=l.GetLineData(),h=l.GetGeoAttribute();if(h!=null&&h.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE){var p=h,d=e.ShapeHelper.GetShapeWorldMatrix(l);e.GeometryHelper.Transform(p,d);var v=f.GetPosition(),m=void 0,g=void 0,y=void 0,b=void 0,w=new e.Vector3;m=e.MeasureCalculateHelper.PntLineDistance(v,p,m,b,w);var E=p.GetStartPoint(),S=p.GetEndPoint(),x=v.Sub(E).Length(),T=v.Sub(S).Length(),N=new e.Vector3,C=new e.Vector3;x>T?(y=x,g=T,N=E.Clone(),C=S.Clone()):(y=T,g=x,C=E.Clone(),N=S.Clone());var k=s.GetCamera().GetViewPort().GetScreenRay(i.x,i.y),L=new e.Plane(k.GetDirection(),E.Add(S).Divide(2)),A=L.Project(k.GetOrigin()),O=new e.Line3D(E,S),M=e.Color.GREEN().Clone();O.SetColor(t.SelectColor().Clone());var _=E.Add(S).Divide(2),D=new e.Point(v);D.SetDrawType(1),D.SetSize(.8);var P=new e.Line3D(v,w),H=e.Color.BLACK().Clone();P.SetColor(t.MeasureColor1().Clone());var B=new e.Point(w);B.SetDrawType(1),B.SetSize(.8);var j=new e.Line3D(N,v),F=e.Color.RED().Clone();j.SetColor(t.MeasureColor2().Clone());var I=new e.Line3D(C,v),q=e.Color.BLUE().Clone();I.SetColor(t.MeasureColor3().Clone());var R=null;if(!e.MeasureCalculateHelper.pntInSegment(w,p)){R=new e.Line3D(C,w);var U=e.Color.BLACK().Clone();R.SetColor(t.ExLineColor().Clone()),R.SetName("exLine")}var z=new e.Line3D(w.Add(v).Divide(2),A);z.SetName("MeasureImageLeader"),z.SetColor(t.LeaderColor().Clone());var W=s.GetSceneBox().Length()/20;o.AddLine(O),o.AddLine(z),o.AddLine(j),o.AddLine(I),o.AddLine(P),R&&o.AddLine(R),o.AddPoint(D),o.AddPoint(B);var X="投影距离",V="端点最大距离",$="端点最小距离",J=350,K=new Array;K.push(m),K.push(y),K.push(g);var Q="";Q=e.MeasureDisplayHelper.SetMeasureUnit(e.Parameters.Instance().measureUnitStyle,K,Q);var G=String(K[0].toFixed(3))+Q,Y=String(K[1].toFixed(3))+Q,Z=String(K[2].toFixed(3))+Q;+Q;var et=new e.ComText,tt=new e.CText;tt.SetText(G),et.AddCText(tt),o.ComTexts.push(et);var nt=new e.ComText,rt=new e.CText;rt.SetText(Y),nt.AddCText(rt),o.ComTexts.push(nt);var it=new e.ComText,st=new e.CText;st.SetText(Z),it.AddCText(st),o.ComTexts.push(it);var ot=new e.Shape2DSet,ut=40,at=new e.Vector2(1,1),ft=new e.Vector2(J,100),lt=450,ct=e.Color.GRAY().Clone(),ht=e.Color.WHITE().Clone(),pt=e.Color.BLACK().Clone(),dt=e.Color.GREEN().Clone(),vt=e.Color.RED().Clone(),mt=e.Color.BLUE().Clone();e.MeasureDisplayHelper.createRectImage(ot,at,ft,lt,t.MeasureColor1().Clone(),ht,ht,pt,X,G,ut,!1);var gt=new e.Vector2(1,100),yt=new e.Vector2(J,200);e.MeasureDisplayHelper.createRectImage(ot,gt,yt,lt,t.MeasureColor2().Clone(),ht,ht,pt,V,Y,ut,!1);var bt=new e.Vector2(1,200),wt=new e.Vector2(J,300);e.MeasureDisplayHelper.createRectImage(ot,bt,wt,lt,t.MeasureColor3().Clone(),ht,ht,pt,$,Z,ut,!0);var Et=null;e.MeasureDisplayHelper.addImageToMemory(s,Et,ot,A,(J+lt)/100,4.5,o)}else if(h!=null&&h.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE){e.LOGI("point to circle distance");var ct=e.Color.GRAY().Clone(),ht=e.Color.WHITE().Clone(),pt=e.Color.BLACK().Clone(),dt=e.Color.GREEN().Clone(),vt=e.Color.RED().Clone(),mt=e.Color.BLUE().Clone(),St=h,d=e.ShapeHelper.GetShapeWorldMatrix(l);e.GeometryHelper.Transform(St,d);var v=f.GetPosition(),m=void 0,b=void 0,w=new e.Vector3;m=e.MeasureCalculateHelper.PntLineDistance(v,St,m,b,w,d,c);var E=St.GetStartPoint(),S=St.GetEndPoint(),k=s.GetCamera().GetViewPort().GetScreenRay(i.x,i.y),L=(new e.Plane(k.GetDirection(),E.Add(S).Divide(2))).Clone(),A=L.Project(k.GetOrigin()),O=new e.Line3D(w,v);O.SetColor(t.MeasureColor1().Clone());var _=w.Add(v).Divide(2).Clone(),xt=new e.Line3D(_,A);xt.SetName("MeasureImageLeader"),xt.SetColor(t.LeaderColor().Clone());var D=new e.Point(v);D.SetDrawType(1),D.SetSize(.8);var B=new e.Point(w);B.SetDrawType(1),B.SetSize(.8),o.AddPoint(B);var X="点线距离",Tt=250,W=s.GetSceneBox().Length()/20,Nt=c.GetRefLine(),Ct=Nt.GetPoints(),kt=c.GetDataOffset(),Lt=c.GetDataLength(),At=1;for(var Ot=kt;Ot<Lt;Ot+=2){var Mt=new e.Line3D(d.Multiply(Ct[Ot]),d.Multiply(Ct[Ot+1])),_t=e.Color.GREEN().Clone();Mt.SetColor(t.SelectColor().Clone()),o.AddLine(Mt)}o.AddLine(O),o.AddLine(xt),o.AddPoint(D);var K=new Array;K.push(m);var Q=void 0;Q=e.MeasureDisplayHelper.SetMeasureUnit(e.Parameters.Instance().measureUnitStyle,K,Q);var Dt=String(K[0].toFixed(3))+Q,et=new e.ComText,tt=new e.CText;tt.SetText(Dt),et.AddCText(tt),o.ComTexts.push(et);var ot=new e.Shape2DSet,ut=40,at=new e.Vector2(1,1),ft=new e.Vector2(Tt,100),lt=450;e.MeasureDisplayHelper.createRectImage(ot,at,ft,lt,t.MeasureColor1().Clone(),ht,ht,pt,"点线距离",Dt,ut,!0);var Et=null;e.MeasureDisplayHelper.addImageToMemory(s,Et,ot,A,(lt+Tt)/100,1.5,o)}else{e.LOGI("point to polyline distance");var v=f.GetPosition(),Pt=e.ShapeHelper.GetShapeWorldMatrix(l),Ht=Pt.Inverse(),Bt=Ht.Multiply(v).Clone(),m=void 0,C=new e.Vector3;m=e.MeasureCalculateHelper.PntLineDistance(c,Bt,m,C),C=Pt.Multiply(C).Clone();var k=s.GetCamera().GetViewPort().GetScreenRay(i.x,i.y),L=new e.Plane(k.GetDirection(),v),A=L.Project(k.GetOrigin()),xt=new e.Line3D(C.Add(v).Divide(2),A);xt.SetName("MeasureImageLeader"),xt.SetColor(t.LeaderColor().Clone());var O=new e.Line3D(v,C);O.SetColor(t.MeasureColor1().Clone());var D=new e.Point(v);D.SetDrawType(1),D.SetSize(.8);var B=new e.Point(C);B.SetDrawType(1),B.SetSize(.8),o.AddPoint(B);var X="点线距离",Tt=250,W=s.GetSceneBox().Length()/20,Nt=c.GetRefLine(),Ct=Nt.GetPoints(),kt=c.GetDataOffset(),Lt=c.GetDataLength(),At=1;for(var Ot=kt;Ot<Ct.length+Lt;Ot+=2){var Mt=new e.Line3D(Pt.Multiply(Ct[Ot]),Pt.Multiply(Ct[Ot+1])),_t=e.Color.GREEN().Clone();Mt.SetColor(t.SelectColor()),o.AddLine(Mt)}o.AddLine(O),o.AddLine(xt);var K=new Array;K.push(m);var Q=void 0;Q=e.MeasureDisplayHelper.SetMeasureUnit(e.Parameters.Instance().measureUnitStyle,K,Q);var Dt=String(K[0].toFixed(3))+Q,et=new e.ComText,tt=new e.CText;tt.SetText(Dt),et.AddCText(tt),o.ComTexts.push(et);var ot=new e.Shape2DSet,ut=40,at=new e.Vector2(1,1),ft=new e.Vector2(Tt,100),lt=450,ct=e.Color.GRAY().Clone(),ht=e.Color.WHITE().Clone(),pt=e.Color.BLACK().Clone(),dt=e.Color.GREEN().Clone(),vt=e.Color.RED().Clone(),mt=e.Color.BLUE().Clone();e.MeasureDisplayHelper.createRectImage(ot,at,ft,lt,t.MeasureColor1().Clone(),ht,ht,pt,X,Dt,ut,!0);var Et=null;e.MeasureDisplayHelper.addImageToMemory(s,Et,ot,A,(lt+Tt)/100,1.5,o)}}else e.LOGE("MeasureFactory.createPntTOLineDistance shape is null");return o},t.createPntToFaceDistance=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length==4){var i=n[0],s=n[1],o=n[2],u=n[3],a=null,f=u.GetShape(i),l=u.GetShape(s);if(f&&l&&f.GetType()==e.ShapeType.SHAPE_POINT_HANDLE&&l.GetType()==e.ShapeType.SHAPE_FACE){a=new e.MeasureDistance,a.SetMeasureType(e.Measure.MEASURE_TYPE_PNT_FACE_DISTANCE);var c=f,h=l,p=c.GetPosition(),d=h.GetMesh(),v=h.GetGeoAttribute();if(v!=null&&v.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){var m=v,g=e.ShapeHelper.GetShapeWorldMatrix(h);e.GeometryHelper.Transform(m,g);var y=new e.Plane(m.GetNormal(),m.GetOrigin()),b=y.Project(p),w=p.Sub(b).Length(),E=p.Add(b).Divide(2).Clone(),S=g.Inverse(),x=S.Multiply(p).Clone(),T=void 0,N=void 0,C=new e.Vector3,k=new e.Vector3,L=e.MeasureCalculateHelper.PntFaceDistance(x,d,T,N,C,k);T=L[0],N=L[1],C=g.Multiply(C).Clone(),k=g.Multiply(k).Clone();var A=u.GetCamera().GetViewPort().GetScreenRay(o.x,o.y),O=new e.Plane(A.GetDirection(),E),M=O.Project(A.GetOrigin()),_=new e.Line3D(p,b),D=e.Color.BLACK().Clone();_.SetColor(t.MeasureColor1().Clone());var P=new e.Line3D(E,M);P.SetName("MeasureImageLeader"),P.SetColor(t.LeaderColor().Clone());var H=new e.Point(p);H.SetDrawType(1),H.SetSize(.8);var B=new e.Point(b);B.SetDrawType(1),B.SetSize(.8);var j=new e.Point(k);j.SetDrawType(1),j.SetSize(.8);var F=new e.Point(C);F.SetDrawType(1),F.SetSize(.8);var I=new e.Line3D(p,C),q=e.Color.RED().Clone();I.SetColor(t.MeasureColor3().Clone());var R=new e.Line3D(p,k),U=e.Color.BLUE().Clone();R.SetColor(t.MeasureColor2().Clone());var z=new e.Line3D(C,b);z.SetColor(t.ExLineColor().Clone()),z.SetName("exLine");var W=u.GetSceneBox().Length()/20,X=new Array,V="点线距离",$=40;X.push($);var J="最大距离",K=40;X.push(K);var Q="最小距离",G=40;X.push(G);var Y=250;a.AddLine(P),a.AddLine(z),a.AddPoint(H);var Z=new Array;Z.push(w),Z.push(N),Z.push(T);var et=void 0;et=e.MeasureDisplayHelper.SetMeasureUnit(e.Parameters.Instance().measureUnitStyle,Z,et);var tt=String(Z[0].toFixed(3))+et,nt=String(Z[1].toFixed(3))+et,rt=String(Z[2].toFixed(3))+et,it=new e.Shape2DSet,st=40,ot=new e.Vector2(1,1),ut=new e.Vector2(Y,100),at=450,ft=e.Color.GRAY().Clone(),lt=e.Color.WHITE().Clone(),ct=e.Color.BLACK().Clone(),ht=e.Color.GREEN().Clone(),pt=e.Color.RED().Clone(),dt=e.Color.BLUE().Clone(),vt=new e.Vector2(1,1),mt=new e.Vector2(Y,300);if(T>0){a.AddLine(_),a.AddLine(I),a.AddLine(R),a.AddPoint(B),a.AddPoint(j),a.AddPoint(F);var gt=new e.ComText,yt=new e.CText;yt.SetText(tt),gt.AddCText(yt),a.ComTexts.push(gt);var bt=new e.ComText,wt=new e.CText;wt.SetText(nt),bt.AddCText(wt),a.ComTexts.push(bt);var Et=new e.ComText,St=new e.CText;St.SetText(rt),Et.AddCText(St),a.ComTexts.push(Et),e.MeasureDisplayHelper.createRectImage(it,ot,ut,at,t.MeasureColor1().Clone(),lt,lt,ct,V,tt,st,!0);var xt=new e.Vector2(1,100),Tt=new e.Vector2(Y,200);e.MeasureDisplayHelper.createRectImage(it,xt,Tt,at,t.MeasureColor2().Clone(),lt,lt,ct,J,nt,st,!0);var Nt=new e.Vector2(1,200),Ct=new e.Vector2(Y,300);e.MeasureDisplayHelper.createRectImage(it,Nt,Ct,at,t.MeasureColor3().Clone(),lt,lt,ct,Q,rt,st,!0);var kt=null;e.MeasureDisplayHelper.addImageToMemory(u,kt,it,M,(Y+at)/100,4.5,a)}else{var Et=new e.ComText,St=new e.CText;St.SetText(rt),Et.AddCText(St),a.ComTexts.push(Et);var Nt=new e.Vector2(1,1),Ct=new e.Vector2(Y,100);e.MeasureDisplayHelper.createRectImage(it,Nt,Ct,at,t.MeasureColor1().Clone(),lt,lt,ct,Q,rt,st,!0);var kt=null;e.MeasureDisplayHelper.addImageToMemory(u,kt,it,M,(Y+at)/100,1,a)}}else{var g=e.ShapeHelper.GetShapeWorldMatrix(h),S=g.Inverse(),x=S.Multiply(p).Clone(),T=void 0,N=void 0,Lt=new e.Vector3,k=new e.Vector3,L=e.MeasureCalculateHelper.PntFaceDistance(x,d,T,N,Lt,k);T=L[0],N=L[1],Lt=g.Multiply(Lt).Clone(),k=g.Multiply(k).Clone();var E=p.Add(Lt).Clone().Divide(2),A=u.GetCamera().GetViewPort().GetScreenRay(o.x,o.y),O=new e.Plane(A.GetDirection(),Lt),M=O.Project(A.GetOrigin()),P=new e.Line3D(E,M);P.SetName("MeasureImageLeader"),P.SetColor(t.LeaderColor().Clone());var H=new e.Point(p);H.SetDrawType(1),H.SetSize(.8);var B=new e.Point(Lt);B.SetDrawType(1),B.SetSize(.8);var j=new e.Point(k);j.SetDrawType(1),j.SetSize(.8);var I=new e.Line3D(p,Lt),q=e.Color.RED().Clone();I.SetColor(t.MeasureColor1().Clone());var R=new e.Line3D(p,k),U=e.Color.BLUE().Clone();R.SetColor(t.MeasureColor2().Clone());var W=u.GetSceneBox().Length()/20,X=new Array,J="最大距离",K=40;X.push(K);var Q="最小距离",G=40;X.push(G);var Y=250;a.AddLine(P),a.AddPoint(H);var Z=new Array;Z.push(T),Z.push(N);var et=void 0;et=e.MeasureDisplayHelper.SetMeasureUnit(e.Parameters.Instance().measureUnitStyle,Z,et);var rt=String(Z[0].toFixed(3))+et,nt=String(Z[1].toFixed(3))+et,it=new e.Shape2DSet,st=40,ot=new e.Vector2(1,1),ut=new e.Vector2(Y,100),at=450,ft=e.Color.GRAY().Clone(),lt=e.Color.WHITE().Clone(),ct=e.Color.BLACK().Clone(),ht=e.Color.GREEN().Clone(),pt=e.Color.RED().Clone(),dt=e.Color.BLUE().Clone(),vt=new e.Vector2(1,1),mt=new e.Vector2(Y,200);if(T>0){var Et=new e.ComText,St=new e.CText;St.SetText(rt),Et.AddCText(St),a.ComTexts.push(Et);var bt=new e.ComText,wt=new e.CText;wt.SetText(nt),bt.AddCText(wt),a.ComTexts.push(bt),a.AddLine(I),a.AddLine(R),a.AddPoint(B),a.AddPoint(j),e.MeasureDisplayHelper.createRectImage(it,ot,ut,at,t.MeasureColor1().Clone(),lt,lt,ct,Q,rt,st,!1);var xt=new e.Vector2(1,100),Tt=new e.Vector2(Y,200);e.MeasureDisplayHelper.createRectImage(it,xt,Tt,at,t.MeasureColor2().Clone(),lt,lt,ct,J,nt,st,!0);var kt=null;e.MeasureDisplayHelper.addImageToMemory(u,kt,it,M,(Y+at)/100,3,a)}else{var Et=new e.ComText,St=new e.CText;St.SetText(rt),Et.AddCText(St),a.ComTexts.push(Et);var Nt=new e.Vector2(1,1),Ct=new e.Vector2(Y,100);e.MeasureDisplayHelper.createRectImage(it,Nt,Ct,at,t.MeasureColor1().Clone(),lt,lt,ct,Q,rt,st,!0);var kt=null;e.MeasureDisplayHelper.addImageToMemory(u,kt,it,M,(Y+at)/100,1.5,a)}}}return a}if(n.length==6){var i=n[0],s=n[1],At=n[2],Ot=n[3],o=n[4],u=n[5],a=null,f=u.GetShape(i),l=u.GetShape(s),Mt=u.GetShape(Ot);if(f&&l&&Mt&&f.GetType()==e.ShapeType.SHAPE_POINT_HANDLE&&l.GetType()==e.ShapeType.SHAPE_FACE&&Mt.GetType()==e.ShapeType.SHAPE_POINT_HANDLE){e.LOGE("createLineTOFaceAngle step2"),a=new e.MeasureDistance,a.SetMeasureType(e.Measure.MEASURE_TYPE_PNT_FACE_DISTANCE);var c=f,_t=Mt,h=l,p=c.GetPosition(),Dt=_t.GetPosition(),d=h.GetMesh(),v=h.GetGeoAttribute();if(v!=null&&v.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){var m=v,g=e.ShapeHelper.GetShapeWorldMatrix(h);e.GeometryHelper.Transform(m,g);var y=new e.Plane(m.GetNormal(),m.GetOrigin()),b=y.Project(p),w=p.Sub(b).Length(),E=p.Add(b).Divide(2).Clone(),S=g.Inverse(),x=S.Multiply(p).Clone(),T=void 0,N=void 0,C=new e.Vector3,k=new e.Vector3,L=e.MeasureCalculateHelper.PntFaceDistance(x,d,T,N,C,k);T=L[0],N=L[1],C=g.Multiply(C),k=g.Multiply(k);var A=u.GetCamera().GetViewPort().GetScreenRay(o.x,o.y),O=new e.Plane(A.GetDirection(),E),M=O.Project(A.GetOrigin()),_=new e.Line3D(p,b),D=e.Color.BLACK().Clone();_.SetColor(t.MeasureColor1().Clone());var P=new e.Line3D(E,M);P.SetName("MeasureImageLeader"),P.SetColor(t.LeaderColor().Clone());var H=new e.Point(p);H.SetDrawType(1),H.SetSize(.8);var B=new e.Point(b);B.SetDrawType(1),B.SetSize(.8);var j=new e.Point(k);j.SetDrawType(1),j.SetSize(.8);var F=new e.Point(C);F.SetDrawType(1),F.SetSize(.8);var Pt=new e.Point(Dt);Pt.SetDrawType(1),Pt.SetSize(3),a.AddPoint(Pt);var I=new e.Line3D(p,C),q=e.Color.RED().Clone();I.SetColor(t.MeasureColor3().Clone());var R=new e.Line3D(p,k),U=e.Color.BLUE().Clone();R.SetColor(t.MeasureColor2().Clone());var z=new e.Line3D(C,b);z.SetColor(t.ExLineColor().Clone()),z.SetName("exLine");var W=u.GetSceneBox().Length()/20,X=new Array,V="点面距离",$=40;X.push($);var J="最大距离",K=40;X.push(K);var Q="最小距离",G=40;X.push(G);var Y=250;a.AddLine(P),a.AddLine(z),a.AddPoint(H);var Z=new Array;Z.push(w),Z.push(N),Z.push(T);var et=void 0;et=e.MeasureDisplayHelper.SetMeasureUnit(e.Parameters.Instance().measureUnitStyle,Z,et);var tt=String(Z[0].toFixed(3))+et,nt=String(Z[1].toFixed(3))+et,rt=String(Z[2].toFixed(3))+et,gt=new e.ComText,yt=new e.CText;yt.SetText(tt),gt.AddCText(yt),a.ComTexts.push(gt);var Ht=new e.ComText,Bt=new e.CText;Bt.SetText(nt),Ht.AddCText(Bt),a.ComTexts.push(Ht);var Et=new e.ComText,St=new e.CText;St.SetText(rt),Et.AddCText(St),a.ComTexts.push(Et);var it=new e.Shape2DSet,st=40,ot=new e.Vector2(1,1),ut=new e.Vector2(Y,100),at=450,ft=e.Color.GRAY().Clone(),lt=e.Color.WHITE().Clone(),ct=e.Color.BLACK().Clone(),ht=e.Color.GREEN().Clone(),pt=e.Color.RED().Clone(),dt=e.Color.BLUE().Clone(),vt=new e.Vector2(1,1),mt=new e.Vector2(Y,300);if(T>0){a.AddLine(_),a.AddLine(I),a.AddLine(R),a.AddPoint(B),a.AddPoint(j),a.AddPoint(F),e.MeasureDisplayHelper.createRectImage(it,ot,ut,at,t.MeasureColor1().Clone(),lt,lt,ct,V,tt,st,!0);var xt=new e.Vector2(1,100),Tt=new e.Vector2(Y,200);e.MeasureDisplayHelper.createRectImage(it,xt,Tt,at,t.MeasureColor2().Clone(),lt,lt,ct,J,nt,st,!0);var Nt=new e.Vector2(1,200),Ct=new e.Vector2(Y,300);e.MeasureDisplayHelper.createRectImage(it,Nt,Ct,at,t.MeasureColor3().Clone(),lt,lt,ct,Q,rt,st,!0);var kt=null;e.MeasureDisplayHelper.addImageToMemory(u,kt,it,M,(Y+at)/100,4.5,a)}else{var Nt=new e.Vector2(1,1),Ct=new e.Vector2(Y,100);e.MeasureDisplayHelper.createRectImage(it,Nt,Ct,at,t.MeasureColor1().Clone(),lt,lt,ct,Q,rt,st,!0);var kt=null;e.MeasureDisplayHelper.addImageToMemory(u,kt,it,M,(Y+at)/100,1.5,a)}}else{var g=e.ShapeHelper.GetShapeWorldMatrix(h),S=g.Inverse(),x=S.Multiply(p).Clone(),T=void 0,N=void 0,Lt=new e.Vector3,k=new e.Vector3,L=e.MeasureCalculateHelper.PntFaceDistance(x,d,T,N,Lt,k);T=L[0],N=L[0],Lt=g.Multiply(Lt).Clone(),k=g.Multiply(k).Clone();var E=p.Add(Lt).Divide(2).Clone(),A=u.GetCamera().GetViewPort().GetScreenRay(o.x,o.y),O=new e.Plane(A.GetDirection(),Lt),M=O.Project(A.GetOrigin()),P=new e.Line3D(E,M);P.SetName("MeasureImageLeader"),P.SetColor(t.LeaderColor().Clone());var H=new e.Point(p);H.SetDrawType(1),H.SetSize(.8);var B=new e.Point(Lt);B.SetDrawType(1),B.SetSize(.8);var j=new e.Point(k);j.SetDrawType(1),j.SetSize(.8);var Pt=new e.Point(Dt);Pt.SetDrawType(1),Pt.SetSize(3),a.AddPoint(Pt);var I=new e.Line3D(p,Lt),q=e.Color.RED().Clone();I.SetColor(t.MeasureColor1().Clone());var R=new e.Line3D(p,k),U=e.Color.BLUE().Clone();R.SetColor(t.MeasureColor2().Clone());var W=u.GetSceneBox().Length()/20,X=new Array,J="最大距离",K=40;X.push(K);var Q="最小距离",G=40;X.push(G);var Y=250;a.AddLine(P),a.AddPoint(H);var Z=void 0;Z.push(T),Z.push(N);var et=void 0;et=e.MeasureDisplayHelper.SetMeasureUnit(e.Parameters.Instance().measureUnitStyle,Z,et);var rt=String(Z[0].toFixed(3))+et,nt=String(Z[1].toFixed(3))+et,Et=new e.ComText,St=new e.CText;St.SetText(rt),Et.AddCText(St),a.ComTexts.push(Et);var Ht=new e.ComText,Bt=new e.CText;Bt.SetText(nt),Ht.AddCText(Bt),a.ComTexts.push(Ht);var it=new e.Shape2DSet,st=40,ot=new e.Vector2(1,1),ut=new e.Vector2(Y,100),at=450,ft=e.Color.GRAY().Clone(),lt=e.Color.WHITE().Clone(),ct=e.Color.BLACK().Clone(),ht=e.Color.GREEN().Clone(),pt=e.Color.RED().Clone(),dt=e.Color.BLUE().Clone(),vt=new e.Vector2(1,1),mt=new e.Vector2(Y,200);if(T>0){a.AddLine(I),a.AddLine(R),a.AddPoint(B),a.AddPoint(j),e.MeasureDisplayHelper.createRectImage(it,ot,ut,at,t.MeasureColor1().Clone(),lt,lt,ct,Q,rt,st,!1);var xt=new e.Vector2(1,100),Tt=new e.Vector2(Y,200);e.MeasureDisplayHelper.createRectImage(it,xt,Tt,at,t.MeasureColor2().Clone(),lt,lt,ct,J,nt,st,!0);var kt=null;e.MeasureDisplayHelper.addImageToMemory(u,kt,it,M,(Y+at)/100,3,a)}else{var Nt=new e.Vector2(1,1),Ct=new e.Vector2(Y,100);e.MeasureDisplayHelper.createRectImage(it,Nt,Ct,at,t.MeasureColor1().Clone(),lt,lt,ct,Q,rt,st,!0);var kt=null;e.MeasureDisplayHelper.addImageToMemory(u,kt,it,M,(Y+at)/100,1,a)}}}return a}},t.createLineToLineDistance=function(n,r,i,s){var o=null,u=s.GetShape(n),a=s.GetShape(r);if(u&&a&&u.GetType()==e.ShapeType.SHAPE_EDGE&&a.GetType()==e.ShapeType.SHAPE_EDGE){e.LOGE("createLineTOLineDistance step2"),o=new e.MeasureDistance,o.SetMeasureType(e.Measure.MEASURE_TYPE_LINE_LINE_DISTANCE);var f=u,l=a,c=f.GetLineData(),h=l.GetLineData(),p=f.GetGeoAttribute(),d=l.GetGeoAttribute();if(p!=null&&p.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE&&d!=null&&d.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE){e.LOGE("createLineTOLineDistance step3");var v=p,m=d,g=e.ShapeHelper.GetShapeWorldMatrix(f),y=e.ShapeHelper.GetShapeWorldMatrix(l);e.GeometryHelper.Transform(v,g),e.GeometryHelper.Transform(m,y);var b=void 0,w=new e.Vector3,E=new e.Vector3,S=!0,x=e.MeasureCalculateHelper.LineLineDistance(v,m,b,w,E,S);b=x[0],S=x[1];var T=v.GetStartPoint(),N=v.GetEndPoint(),C=m.GetStartPoint(),k=m.GetEndPoint(),L=void 0,A=void 0,O=void 0,M=void 0,_=void 0,D=void 0;_=e.MeasureCalculateHelper.pntInSegment(w,v),D=e.MeasureCalculateHelper.pntInSegment(E,m);var P=0,H=new e.Vector3;P=e.MeasureCalculateHelper.PntLineDistance(C,k,T,P,H);var B=0,j=new e.Vector3;B=e.MeasureCalculateHelper.PntLineDistance(C,k,N,B,j);var F=0,I=new e.Vector3;F=e.MeasureCalculateHelper.PntLineDistance(T,N,C,F,I);var q=0,R=new e.Vector3;q=e.MeasureCalculateHelper.PntLineDistance(T,N,k,q,R);var U=0,z=new e.Vector3,W=new e.Vector3;O=F,M=q,L=P,A=B,O>M?(U=M,z=R,W=k):(U=O,z=I,W=C),U>L&&(U=L,z=H,W=T),U>A&&(U=A,z=N,W=j);var X=s.GetCamera().GetViewPort().GetScreenRay(i.x,i.y),V=w.Add(E).Divide(2).Clone(),$=E.Sub(w).Clone(),J=new e.Plane(X.GetDirection(),V),K=J.Project(X.GetOrigin()),Q=new e.Line3D(T,N),G=e.Color.GREEN().Clone();Q.SetColor(t.SelectColor().Clone());var Y=new e.Line3D(C,k),Z=e.Color.GREEN().Clone();Y.SetColor(t.SelectColor().Clone());var et=new e.Line3D(w,E),tt=e.Color.BLACK().Clone();et.SetColor(t.MeasureColor1().Clone());var nt=new e.Line3D(V,K);nt.SetName("MeasureImageLeader"),nt.SetColor(t.LeaderColor().Clone());var rt=new e.Line3D(z,W),it=e.Color.RED().Clone();rt.SetColor(t.MeasureColor2().Clone());var st=new e.Vector3;w.Sub(T).Length()>w.Sub(N).Length()?st=N:st=T;var ot=new e.Line3D(st,w),ut=e.Color.BLACK().Clone();ot.SetColor(t.ExLineColor().Clone()),ot.SetName("exLine");var at=new e.Vector3;E.Sub(C).Length()>E.Sub(k).Length()?at=k:at=C;var ft=new e.Line3D(at,E),lt=e.Color.BLACK().Clone();ft.SetColor(t.ExLineColor().Clone()),ft.SetName("exLine");var ct=new e.Point(w);ct.SetDrawType(1),ct.SetSize(.8);var ht=new e.Point(E);ht.SetDrawType(1),ht.SetSize(.8);var pt=String($.x),dt=String($.y),vt=String($.z),mt=s.GetSceneBox().Length()/20;o.AddLine(Q),o.AddLine(Y),o.AddLine(et),o.AddLine(nt),o.AddLine(rt),_||o.AddLine(ot),D||o.AddLine(ft),o.AddPoint(ct),o.AddPoint(ht);var gt=new e.Shape2DSet,yt=40,bt=450,wt=e.Color.GRAY().Clone(),Et=e.Color.WHITE().Clone(),St=e.Color.BLACK().Clone(),xt=e.Color.GREEN().Clone(),Tt=e.Color.RED().Clone(),Nt=e.Color.BLUE().Clone();if(S){var Ct=new Array,kt="线线距离",Lt=40;Ct.push(Lt);var At="最短距离",Ot=40;Ct.push(Ot);var Mt=250,_t=new Array;_t.push(b),_t.push(U);var Dt="";Dt=e.MeasureDisplayHelper.SetMeasureUnit(e.Parameters.Instance().measureUnitStyle,_t,Dt);var Pt=String(_t[0].toFixed(3))+Dt,Ht=String(_t[1].toFixed(3))+Dt,Bt=new e.ComText,jt=new e.CText;jt.SetText(Pt),Bt.AddCText(jt),o.ComTexts.push(Bt);var Ft=new e.ComText,It=new e.CText;It.SetText(Ht),Ft.AddCText(It),o.ComTexts.push(Ft);var qt=new e.Vector2(1,1),Rt=new e.Vector2(Mt,200),Ut=new e.Vector2(1,1),zt=new e.Vector2(Mt,100);e.MeasureDisplayHelper.createRectImage(gt,Ut,zt,bt,t.MeasureColor1().Clone(),Et,Et,St,kt,Pt,yt,!1);var Wt=new e.Vector2(1,100),Xt=new e.Vector2(Mt,200);e.MeasureDisplayHelper.createRectImage(gt,Wt,Xt,bt,t.MeasureColor2().Clone(),Et,Et,St,At,Ht,yt,!0);var Vt=null;e.MeasureDisplayHelper.addImageToMemory(s,Vt,gt,K,(Mt+bt)/100,3,o)}else{var Ct=new Array,$t="最短距离",Ot=40;Ct.push(Ot);var Jt="交叉线距离",Kt=40;Ct.push(Kt);var Mt=250,_t=new Array;_t.push(b),_t.push(U);var Dt="";Dt=e.MeasureDisplayHelper.SetMeasureUnit(e.Parameters.Instance().measureUnitStyle,_t,Dt);var Qt=String(_t[0].toFixed(3))+Dt,Ht=String(_t[1].toFixed(3))+Dt,Gt=new e.ComText,Yt=new e.CText;Yt.SetText(Qt),Gt.AddCText(Yt),o.ComTexts.push(Gt);var Zt=new e.ComText,en=new e.CText;en.SetText(Ht),Zt.AddCText(en),o.ComTexts.push(Zt);var qt=new e.Vector2(1,1),Rt=new e.Vector2(Mt,200),Ut=new e.Vector2(1,1),zt=new e.Vector2(Mt,100);e.MeasureDisplayHelper.createRectImage(gt,Ut,zt,bt,t.MeasureColor1().Clone(),Et,Et,St,Jt,Qt,yt,!1);var Wt=new e.Vector2(1,100),Xt=new e.Vector2(Mt,200);e.MeasureDisplayHelper.createRectImage(gt,Wt,Xt,bt,t.MeasureColor2().Clone(),Et,Et,St,$t,Ht,yt,!0);var Vt=null;e.MeasureDisplayHelper.addImageToMemory(s,Vt,gt,K,(Mt+bt)/100,3,o)}}else if(p!=null&&p.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE&&d!=null&&d.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE){var tn=p,nn=d,g=e.ShapeHelper.GetShapeWorldMatrix(f),y=e.ShapeHelper.GetShapeWorldMatrix(l);e.GeometryHelper.Transform(tn,g),e.GeometryHelper.Transform(nn,y);var rn=void 0,sn=void 0,on=new e.Vector3,w=new e.Vector3,un=void 0,an=e.MeasureCalculateHelper.LineLineDistance(tn,nn,rn,sn,on,w,un);rn=an[0],sn=an[1],un=an[2];var fn=new e.Vector3,ln=new e.Vector3,cn=void 0,hn=void 0,pn=new e.Vector3,dn=new e.Vector3,vn=new e.Vector3,mn=new e.Vector3,gn=new e.Vector3,yn=new e.Vector3,bn=new e.Vector3,wn=new e.Vector3;tn.GetXYZDir(vn,mn,gn),nn.GetXYZDir(yn,bn,wn),fn=tn.GetCenterPoint(),ln=nn.GetCenterPoint(),cn=tn.GetMajorRadius(),hn=nn.GetMajorRadius(),pn=tn.GetStartPoint(),dn=nn.GetStartPoint();var X=s.GetCamera().GetViewPort().GetScreenRay(i.x,i.y),V=w.Add(on).Divide(2).Clone(),J=new e.Plane(X.GetDirection(),V),K=J.Project(X.GetOrigin()),En=new e.Point(ln);En.SetDrawType(1),En.SetSize(.8);var Sn=new e.Point(fn);Sn.SetDrawType(1),Sn.SetSize(.8),o.AddPoint(Sn),o.AddPoint(En);var xn=c.GetRefLine(),Tn=xn.GetPoints(),Nn=c.GetDataOffset(),Cn=c.GetDataLength(),kn=1;for(var Ln=Nn;Ln<Nn+Cn;Ln+=2){var An=new e.Line3D(g.Multiply(Tn[Ln]),g.Multiply(Tn[Ln+1])),On=e.Color.GREEN().Clone();An.SetColor(t.SelectColor()),o.AddLine(An)}var xn=h.GetRefLine(),Tn=xn.GetPoints(),Nn=h.GetDataOffset(),Cn=h.GetDataLength(),kn=1;for(var Ln=Nn;Ln<Nn+Cn;Ln+=2){var An=new e.Line3D(y.Multiply(Tn[Ln]),y.Multiply(Tn[Ln+1])),On=e.Color.GREEN().Clone();An.SetColor(t.SelectColor()),o.AddLine(An)}var _t=new Array;_t.push(rn),_t.push(sn);var Dt="";Dt=e.MeasureDisplayHelper.SetMeasureUnit(e.Parameters.Instance().measureUnitStyle,_t,Dt);var Mn=String(_t[0].toFixed(3))+Dt,_n=String(_t[1].toFixed(3))+Dt,gt=new e.Shape2DSet,yt=40,bt=450,wt=e.Color.GRAY().Clone(),Et=e.Color.WHITE().Clone(),St=e.Color.BLACK().Clone(),xt=e.Color.GREEN().Clone(),Tt=e.Color.RED().Clone(),Nt=e.Color.BLUE().Clone();if(0==un){var Q=new e.Line3D(fn,ln);Q.SetColor(Tt),o.AddLine(Q);var Y=new e.Line3D(V,K);Y.SetName("MeasureImageLeader"),Y.SetColor(t.LeaderColor().Clone()),o.AddLine(Y);var Dn="曲线中心",Pn=250,Hn=new e.ComText,Bn=new e.CText;Bn.SetText(_n),Hn.AddCText(Bn),o.ComTexts.push(Hn);var qt=new e.Vector2(1,1),Rt=new e.Vector2(Pn,100),Ut=new e.Vector2(1,1),zt=new e.Vector2(Pn,100);e.MeasureDisplayHelper.createRectImage(gt,Ut,zt,bt,t.MeasureColor1().Clone(),Et,Et,St,Dn,_n,yt,!0);var Vt=null;e.MeasureDisplayHelper.addImageToMemory(s,Vt,gt,K,(Pn+bt)/100,1.5,o)}else if(1==un){var Q=new e.Line3D(fn,ln);Q.SetColor(t.MeasureColor1().Clone()),o.AddLine(Q);var Y=new e.Line3D(on,w);Y.SetColor(t.MeasureColor2().Clone()),o.AddLine(Y);var et=new e.Line3D(fn,on);et.SetColor(t.ExLineColor().Clone()),et.SetName("exLine"),o.AddLine(et);var nt=new e.Line3D(fn.Add
(ln).Divide(2).Clone(),K);nt.SetName("MeasureImageLeader"),nt.SetColor(t.LeaderColor().Clone()),o.AddLine(nt);var ct=new e.Point(on);ct.SetDrawType(1),ct.SetSize(.8),o.AddPoint(ct);var ht=new e.Point(w);ht.SetDrawType(1),ht.SetSize(.8),o.AddPoint(ht);var Ct=new Array,Dn="曲线中心",Pn=40;Ct.push(Pn);var jn="线线轴距",Fn=40;Ct.push(Fn);var Hn=new e.ComText,Bn=new e.CText;Bn.SetText(_n),Hn.AddCText(Bn),o.ComTexts.push(Hn);var In=new e.ComText,qn=new e.CText;qn.SetText(Mn),In.AddCText(qn),o.ComTexts.push(In);var Mt=250,qt=new e.Vector2(1,1),Rt=new e.Vector2(Mt,200),Ut=new e.Vector2(1,1),zt=new e.Vector2(Mt,100);e.MeasureDisplayHelper.createRectImage(gt,Ut,zt,bt,t.MeasureColor1().Clone(),Et,Et,St,Dn,_n,yt,!1);var Rn=new e.Vector2(1,100),Un=new e.Vector2(Mt,200);e.MeasureDisplayHelper.createRectImage(gt,Rn,Un,bt,t.MeasureColor2().Clone(),Et,Et,St,jn,Mn,yt,!0);var Vt=null;e.MeasureDisplayHelper.addImageToMemory(s,Vt,gt,K,(Mt+bt)/100,3,o)}else if(2==un){var zn="半径差",Wn=250,Q=new e.Line3D(on,w);Q.SetColor(t.MeasureColor1().Clone()),o.AddLine(Q);var Hn=new e.ComText,Bn=new e.CText;Bn.SetText(_n),Hn.AddCText(Bn),o.ComTexts.push(Hn);var Y=new e.Line3D(V,K);Y.SetName("MeasureImageLeader"),Y.SetColor(t.LeaderColor().Clone()),o.AddLine(Y);var qt=new e.Vector2(1,1),Rt=new e.Vector2(Wn,100),Ut=new e.Vector2(1,1),zt=new e.Vector2(Wn,100);e.MeasureDisplayHelper.createRectImage(gt,Ut,zt,bt,t.MeasureColor1().Clone(),Et,Et,St,zn,_n,yt,!0);var Vt=null;e.MeasureDisplayHelper.addImageToMemory(s,Vt,gt,K,(Wn+bt)/100,1.5,o)}}else if(p!=null&&p.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE&&d!=null&&d.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE||p!=null&&p.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE&&d!=null&&d.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE){e.LOGI("line and ellipse distance BEGIN");var wt=e.Color.GRAY().Clone(),Et=e.Color.WHITE().Clone(),St=e.Color.BLACK().Clone(),xt=e.Color.GREEN().Clone(),Tt=e.Color.RED().Clone(),Nt=e.Color.BLUE().Clone(),g=e.ShapeHelper.GetShapeWorldMatrix(f),y=e.ShapeHelper.GetShapeWorldMatrix(l),Xn=new e.Vector3,Vn=new e.Vector3,$n=1e5;$n=e.MeasureCalculateHelper.PolylinePolylineDistance(c,h,Xn,Vn,$n,g,y);var xn=c.GetRefLine(),Tn=xn.GetPoints(),Nn=c.GetDataOffset(),Cn=c.GetDataLength(),kn=1;for(var Ln=Nn;Ln<Cn;Ln+=2){var An=new e.Line3D(g.Multiply(Tn[Ln]),g.Multiply(Tn[Ln+1])),On=e.Color.GREEN().Clone();An.SetColor(t.SelectColor().Clone()),o.AddLine(An)}var xn=h.GetRefLine(),Tn=xn.GetPoints(),Nn=h.GetDataOffset(),Cn=h.GetDataLength(),kn=1;for(var Ln=Nn;Ln<Cn;Ln+=2){var An=new e.Line3D(y.Multiply(Tn[Ln]),y.Multiply(Tn[Ln+1])),On=e.Color.GREEN().Clone();An.SetColor(t.SelectColor().Clone()),o.AddLine(An)}var V=Xn.Add(Vn).Divide(2).Clone(),X=s.GetCamera().GetViewPort().GetScreenRay(i.x,i.y),J=new e.Plane(X.GetDirection(),V),K=J.Project(X.GetOrigin()),Q=new e.Line3D(Xn,Vn);Q.SetColor(t.MeasureColor1().Clone()),o.AddLine(Q);var ct=new e.Point(Xn);ct.SetDrawType(1),ct.SetSize(.8);var ht=new e.Point(Vn);ht.SetDrawType(1),ht.SetSize(.8),o.AddPoint(ct),o.AddPoint(ht);var Y=new e.Line3D(V,K);Y.SetColor(wt),Y.SetName("MeasureImageLeader"),Y.SetColor(t.LeaderColor().Clone()),o.AddLine(Y);var Ct=new Array,At="最短距离",Ot=40;Ct.push(Ot);var Mt=250,_t=new Array;_t.push($n);var Dt="";Dt=e.MeasureDisplayHelper.SetMeasureUnit(e.Parameters.Instance().measureUnitStyle,_t,Dt);var Jn=String(_t[0].toFixed(3))+Dt,Kn=new e.ComText,Qn=new e.CText;Qn.SetText(Jn),Kn.AddCText(Qn),o.ComTexts.push(Kn);var gt=new e.Shape2DSet,yt=40,Ut=new e.Vector2(1,1),zt=new e.Vector2(Mt,100),bt=450;e.MeasureDisplayHelper.createRectImage(gt,Ut,zt,bt,t.MeasureColor1().Clone(),Et,Et,St,At,Jn,yt,!0);var Vt=null;e.MeasureDisplayHelper.addImageToMemory(s,Vt,gt,K,(Mt+bt)/100,1.5,o)}}else e.LOGE("MeasureFactory.createLineTOLineDistance shape is null");return o},t.createLineToFaceDistance=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length==4){var i=n[0],s=n[1],o=n[2],u=n[3],a=null,f=u.GetShape(i),l=u.GetShape(s);if(f&&l&&f.GetType()==e.ShapeType.SHAPE_EDGE&&l.GetType()==e.ShapeType.SHAPE_FACE){a=new e.MeasureDistance,a.SetMeasureType(e.Measure.MEASURE_TYPE_LINE_FACE_DISTANCE);var c=f,h=l,p=c.GetLineData(),d=h.GetMesh(),v=c.GetGeoAttribute(),m=h.GetGeoAttribute();if(v!=null&&v.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE&&m!=null&&m.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){var g=v,y=m,b=e.ShapeHelper.GetShapeWorldMatrix(c),w=e.ShapeHelper.GetShapeWorldMatrix(h);e.GeometryHelper.Transform(g,b),e.GeometryHelper.Transform(y,w);var E=void 0,S=new e.Vector3,x=new e.Vector3,T=e.MeasureCalculateHelper.LineFaceDistance(g,y,E,S,x);E=T[1];var N=d.GetBoundingBox(),C=N.Center();e.GeometryHelper.Transform(C,w);var k=u.GetCamera().GetViewPort().GetScreenRay(o.x,o.y),L=g.GetStartPoint(),A=g.GetEndPoint(),O=L.Add(A).Divide(2).Clone(),M=O.Add(C).Divide(2).Clone(),_=A.Sub(L),D=y.GetNormal(),P=void 0,H=new Array;H.push(N.GetXLength()),H.push(N.GetYLength()),H.push(N.GetZLength()),H.sort(),H[0]>2?P=H[0]:P=H[1];var B=e.Color.GRAY().Clone(),j=e.Color.WHITE().Clone(),F=e.Color.BLACK().Clone(),I=e.Color.GREEN().Clone(),q=e.Color.RED().Clone(),R=e.Color.BLUE().Clone(),U=new e.Plane(y.GetNormal(),y.GetOrigin()),z=U.Project(O),W=new e.Plane(k.GetDirection(),O.Add(z).Divide(2)),X=W.Project(k.GetOrigin()),V=new e.Line3D(O,z);V.SetColor(t.MeasureColor1().Clone());var $=new e.Line3D(O.Add(z).Divide(2),X);$.SetName("MeasureImageLeader"),$.SetColor(t.LeaderColor().Clone());var J=new e.Line3D(L,A);J.SetColor(t.SelectColor().Clone());var K=new e.Line3D(z,C);K.SetColor(t.ExLineColor().Clone()),K.SetName("exLine"),a.AddLine(K);var Q=new e.Point(z);Q.SetDrawType(1),Q.SetSize(.8),a.AddPoint(Q);var G=new e.Point(O);G.SetDrawType(1),G.SetSize(.8),a.AddPoint(G);var Y=new Array,Z=void 0,et=new Array;if(!(E>=0))return a=null,a;var tt=new Array;tt.push(E);var nt="";nt=e.MeasureDisplayHelper.SetMeasureUnit(e.Parameters.Instance().measureUnitStyle,tt,nt),Z=String(tt[0].toFixed(3))+nt;var rt="线面距离",it=40;Y.push(it);var st=new e.ComText,ot=new e.CText;ot.SetText(Z),st.AddCText(ot),a.ComTexts.push(st);var ut=250,at=u.GetSceneBox().Length()/20;a.AddLine(V),a.AddLine($),a.AddLine(J);var ft=new e.Shape2DSet,lt=40,ct=new e.Vector2(1,1),ht=new e.Vector2(ut,100),pt=450;e.MeasureDisplayHelper.createRectImage(ft,ct,ht,pt,t.MeasureColor1().Clone(),j,j,F,rt,Z,lt,!0);var dt=null;e.MeasureDisplayHelper.addImageToMemory(u,dt,ft,X,(ut+pt)/100,1.5,a)}else a=null}return a}if(n.length==6){var i=n[0],s=n[1],vt=n[2],mt=n[3],o=n[4],u=n[5],a=null,f=u.GetShape(i),l=u.GetShape(s),gt=u.GetShape(mt);if(f&&l&&gt&&f.GetType()==e.ShapeType.SHAPE_EDGE&&l.GetType()==e.ShapeType.SHAPE_FACE&&gt.GetType()==e.ShapeType.SHAPE_POINT_HANDLE){a=new e.MeasureDistance,a.SetMeasureType(e.Measure.MEASURE_TYPE_LINE_FACE_DISTANCE);var c=f,h=l,yt=gt,bt=yt.GetPosition(),p=c.GetLineData(),d=h.GetMesh(),v=c.GetGeoAttribute(),m=h.GetGeoAttribute();if(v!=null&&v.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE&&m!=null&&m.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){var g=v,y=m,b=e.ShapeHelper.GetShapeWorldMatrix(c),w=e.ShapeHelper.GetShapeWorldMatrix(h);e.GeometryHelper.Transform(g,b),e.GeometryHelper.Transform(y,w);var E=void 0,S=new e.Vector3,x=new e.Vector3,T=e.MeasureCalculateHelper.LineFaceDistance(g,y,E,S,x);E=T[1];var N=d.GetBoundingBox(),C=N.Center();e.GeometryHelper.Transform(C,w);var k=u.GetCamera().GetViewPort().GetScreenRay(o.x,o.y),L=g.GetStartPoint(),A=g.GetEndPoint(),O=L.Add(A).Divide(2).Clone(),M=O.Add(C).Divide(2).Clone(),_=A.Sub(L).Clone(),D=y.GetNormal(),P=void 0,H=new Array;H.push(N.GetXLength()),H.push(N.GetYLength()),H.push(N.GetZLength()),H.sort(),H[0]>2?P=H[0]:P=H[1];var B=e.Color.GRAY().Clone(),j=e.Color.WHITE().Clone(),F=e.Color.BLACK().Clone(),I=e.Color.GREEN().Clone(),q=e.Color.RED().Clone(),R=e.Color.BLUE().Clone(),W=new e.Plane(k.GetDirection(),L),X=W.Project(k.GetOrigin()),wt=new e.Point(bt);wt.SetDrawType(1),wt.SetSize(.8),a.AddPoint(wt);var V=new e.Line3D(O,bt);V.SetColor(t.MeasureColor1().Clone());var $=new e.Line3D(M,X);$.SetName("MeasureImageLeader"),$.SetColor(t.LeaderColor().Clone());var J=new e.Line3D(L,A),Et=e.Color.GREEN().Clone();J.SetColor(t.SelectColor().Clone());var Y=new Array,Z=void 0,et=new Array;if(!(E>=0))return a=null,a;var tt=new Array;tt.push(E);var nt="";nt=e.MeasureDisplayHelper.SetMeasureUnit(e.Parameters.Instance().measureUnitStyle,tt,nt),Z=String(tt[0].toFixed(3))+nt;var rt="线面距离",it=40;Y.push(it);var st=new e.ComText,ot=new e.CText;ot.SetText(Z),st.AddCText(ot),a.ComTexts.push(st);var ut=250,at=u.GetSceneBox().Length()/20;a.AddLine(V),a.AddLine($),a.AddLine(J);var ft=new e.Shape2DSet,lt=40,ct=new e.Vector2(1,1),ht=new e.Vector2(ut,100),pt=450;e.MeasureDisplayHelper.createRectImage(ft,ct,ht,pt,t.MeasureColor1().Clone(),j,j,F,rt,Z,lt,!0);var dt=null;e.MeasureDisplayHelper.addImageToMemory(u,dt,ft,X,(ut+pt)/100,1.5,a)}else a=null}return a}},t.createFaceToFaceDistance=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length==4){var i=n[0],s=n[1],o=n[2],u=n[3],a=null,f=u.GetShape(i),l=u.GetShape(s);if(f&&l&&f.GetType()==e.ShapeType.SHAPE_FACE&&l.GetType()==e.ShapeType.SHAPE_FACE){e.LOGE("createFaceTOFaceAngle step2"),a=new e.MeasureDistance,a.SetMeasureType(e.Measure.MEASURE_TYPE_FACE_FACE_DISTANCE);var c=f,h=l,p=c.GetMesh(),d=h.GetMesh(),v=c.GetGeoAttribute(),m=h.GetGeoAttribute();if(v!=null&&v.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE&&m!=null&&m.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){e.LOGI("createFaceTOFaceAngle step3");var g=e.Color.GRAY().Clone(),y=e.Color.WHITE().Clone(),b=e.Color.BLACK().Clone(),w=e.Color.GREEN().Clone(),E=e.Color.RED().Clone(),S=e.Color.BLUE().Clone(),x=v,T=m,N=e.ShapeHelper.GetShapeWorldMatrix(c),C=e.ShapeHelper.GetShapeWorldMatrix(h);e.GeometryHelper.Transform(x,N),e.GeometryHelper.Transform(T,C);var k=void 0,L=new e.Vector3,A=new e.Vector3;k=e.MeasureCalculateHelper.FaceFaceDistance(x,T,k,L,A);var O=p.GetBoundingBox(),M=O.Center();e.GeometryHelper.Transform(M,N);var _=d.GetBoundingBox(),D=_.Center();e.GeometryHelper.Transform(D,C);var P=M.Add(D).Divide(2),H=u.GetCamera().GetViewPort().GetScreenRay(o.x,o.y),B=new e.Plane(H.GetDirection(),P),j=B.Project(H.GetOrigin()),F=new e.Plane(x.GetNormal(),M),I=F.Project(D),q=new e.Line3D(P,j);q.SetName("MeasureImageLeader"),q.SetColor(t.LeaderColor().Clone());var R=new e.Line3D(M,D);R.SetColor(t.MeasureColor1().Clone());var U=new e.Line3D(I,D);U.SetColor(t.MeasureColor1().Clone());var z=new e.Point(M);z.SetSize(.8),z.SetDrawType(1);var W=new e.Point(D);W.SetSize(.8),W.SetDrawType(1);var X=void 0;if(!(k>=0))return a=null,a;var V=new Array(0);V.push(k);var $=void 0;$=e.MeasureDisplayHelper.SetMeasureUnit(e.Parameters.Instance().measureUnitStyle,V,$),X=String(V[0].toFixed(3))+$;var J=new Array,K="面面距离",Q=40;J.push(Q);var G=new e.ComText,Y=new e.CText;Y.SetText(X),G.AddCText(Y),a.ComTexts.push(G);var Z=250,et=u.GetSceneBox().Length()/20;a.AddLine(q),a.AddLine(R),a.AddPoint(z),a.AddPoint(W);var tt=new e.Shape2DSet,nt=40,rt=new e.Vector2(1,1),it=new e.Vector2(Z,100),st=450;e.MeasureDisplayHelper.createRectImage(tt,rt,it,st,t.MeasureColor1().Clone(),y,y,b,K,X,nt,!0);var ot=null;e.MeasureDisplayHelper.addImageToMemory(u,ot,tt,j,(Z+st)/100,1.5,a)}else a=null}return a}if(n.length==6){var i=n[0],s=n[1],ut=n[2],at=n[3],o=n[4],u=n[5],a=null,f=u.GetShape(i),l=u.GetShape(s),ft=u.GetShape(ut),lt=u.GetShape(at);if(f&&l&&ft&&lt&&f.GetType()==e.ShapeType.SHAPE_FACE&&l.GetType()==e.ShapeType.SHAPE_FACE&&ft.GetType()==e.ShapeType.SHAPE_POINT_HANDLE&&lt.GetType()==e.ShapeType.SHAPE_POINT_HANDLE){a=new e.MeasureDistance,a.SetMeasureType(e.Measure.MEASURE_TYPE_FACE_FACE_DISTANCE);var c=f,h=l,p=c.GetMesh(),d=h.GetMesh(),ct=ft,ht=ct.GetPosition(),pt=lt,dt=pt.GetPosition(),v=c.GetGeoAttribute(),m=h.GetGeoAttribute();if(v!=null&&v.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE&&m!=null&&m.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){e.LOGI("createFaceTOFaceAngle step3");var g=e.Color.GRAY().Clone(),y=e.Color.WHITE().Clone(),b=e.Color.BLACK().Clone(),w=e.Color.GREEN().Clone(),E=e.Color.RED().Clone(),S=e.Color.BLUE().Clone(),x=v,T=m,N=e.ShapeHelper.GetShapeWorldMatrix(c),C=e.ShapeHelper.GetShapeWorldMatrix(h);e.GeometryHelper.Transform(x,N),e.GeometryHelper.Transform(T,C);var k=void 0,L=new e.Vector3,A=new e.Vector3;k=e.MeasureCalculateHelper.FaceFaceDistance(x,T,k,L,A);var F=new e.Plane(x.GetNormal(),ht),I=F.Project(dt),P=I.Add(dt).Divide(2).Clone(),H=u.GetCamera().GetViewPort().GetScreenRay(o.x,o.y),B=new e.Plane(H.GetDirection(),P),j=B.Project(H.GetOrigin()),q=new e.Line3D(P,j);q.SetName("MeasureImageLeader"),q.SetColor(t.LeaderColor().Clone());var R=new e.Line3D(I,ht);R.SetColor(t.ExLineColor().Clone()),R.SetName("exLine");var U=new e.Line3D(I,dt);U.SetColor(t.MeasureColor1().Clone());var z=new e.Point(I);z.SetSize(.8),z.SetDrawType(1);var vt=new e.Point(ht);vt.SetDrawType(1),vt.SetSize(.8),a.AddPoint(vt);var mt=new e.Point(dt);mt.SetDrawType(1),mt.SetSize(.8),a.AddPoint(mt);var X=void 0;if(!(k>=0))return a=null,a;var V=new Array;V.push(k);var $=void 0;$=e.MeasureDisplayHelper.SetMeasureUnit(e.Parameters.Instance().measureUnitStyle,V,$),X=String(V[0].toFixed(3))+$;var J=new Array,K="面面距离",Q=40;J.push(Q);var G=new e.ComText,Y=new e.CText;Y.SetText(X),G.AddCText(Y),a.ComTexts.push(G);var Z=250,et=u.GetSceneBox().Length()/20;a.AddLine(q),a.AddLine(R),a.AddLine(U),a.AddPoint(z);var tt=new e.Shape2DSet,nt=40,rt=new e.Vector2(1,1),it=new e.Vector2(Z,100),st=450;e.MeasureDisplayHelper.createRectImage(tt,rt,it,st,t.MeasureColor1().Clone(),y,y,b,K,X,nt,!0);var ot=null;e.MeasureDisplayHelper.addImageToMemory(u,ot,tt,j,(Z+st)/100,1.5,a)}else a=null}return a}},t.createLineToLineAngle=function(n,r,i,s){var o=null,u=s.GetShape(n),a=s.GetShape(r);if(u&&a&&u.GetType()==e.ShapeType.SHAPE_EDGE&&a.GetType()==e.ShapeType.SHAPE_EDGE){o=new e.MeasureAngle,o.SetMeasureType(e.Measure.MEASURE_TYPE_LINE_LINE_ANGLE);var f=u,l=a,c=f.GetLineData(),h=l.GetLineData(),p=f.GetGeoAttribute(),d=l.GetGeoAttribute(),v=e.Color.GRAY().Clone(),m=e.Color.WHITE().Clone(),g=e.Color.BLACK().Clone(),y=e.Color.GREEN().Clone(),b=e.Color.RED().Clone(),w=e.Color.BLUE().Clone();if(p!=null&&p.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE&&d!=null&&d.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE){var E=p,S=d,x=e.ShapeHelper.GetShapeWorldMatrix(f),T=e.ShapeHelper.GetShapeWorldMatrix(l);e.GeometryHelper.Transform(E,x),e.GeometryHelper.Transform(S,T);var N=void 0;N=e.MeasureCalculateHelper.LineLineAngle(E,S,N);var C=s.GetCamera().GetViewPort().GetScreenRay(i.x,i.y),k=E.GetStartPoint(),L=E.GetEndPoint(),A=L.Sub(k).Clone(),O=S.GetStartPoint(),M=S.GetEndPoint(),_=O.Add(M).Divide(2).Clone(),D=O.Add(A).Clone(),P=new e.Plane(C.GetDirection(),k),H=P.Project(C.GetOrigin()),B=new e.Line3D(k,L),j=e.Color.GREEN().Clone();B.SetColor(t.SelectColor().Clone());var F=new e.Line3D(O,M);F.SetColor(t.SelectColor().Clone());var I=new e.Line3D(O,D),q=e.Color.YELLOW().Clone();I.SetColor(t.ExLineColor().Clone()),I.SetName("exLine");var R=new e.Line3D(k,O);R.SetColor(t.ExLineColor().Clone()),R.SetName("exLine");var U=new e.Line3D(L,D);U.SetColor(t.ExLineColor().Clone()),U.SetName("exLine");var z=new Array;e.MeasureDisplayHelper.CreateAngleMark(O,D,O,M,N,z);var W=void 0;if(z.length>0){for(var X=0;X<z.length-1;X++){var V=new e.Line3D(z[X],z[X+1]);V.SetColor(t.MeasureColor1().Clone()),o.AddLine(V)}N>0&&N<90||N>90&&N<180?W=new e.Line3D(z[z.length/2].Add(z[z.length/2-1]).Divide(2).Clone(),H):N-90<1e-7&&N-90>-1e-7?W=new e.Line3D(z[1],H):W=new e.Line3D(O,H)}else W=new e.Line3D(O,H);W.SetName("MeasureImageLeader"),W.SetColor(t.LeaderColor().Clone());var $=new Array,J="线线角度",K=40;$.push(K);var Q=250,G=String(N),Y=new e.ComText,Z=new e.CText;Z.SetText(G),Y.AddCText(Z),o.ComTexts.push(Y);var et=s.GetSceneBox().Length()/20;o.AddLine(W),o.AddLine(B),o.AddLine(F),o.AddLine(I);var tt=new e.Shape2DSet,nt=40,rt=new e.Vector2(1,1),it=new e.Vector2(Q,100),st=450;e.MeasureDisplayHelper.createRectImage(tt,rt,it,st,t.MeasureColor1().Clone(),m,m,g,J,G,nt,!0);var ot=null;e.MeasureDisplayHelper.addImageToMemory(s,ot,tt,H,(Q+st)/100,1.5,o)}else o=null}return o},t.createCurveToCurveAngle=function(n,r,i,s,o,u){var a=null,f=u.GetShape(n),l=u.GetShape(r);if(i&&s&&i.GetType()==e.ShapeType.SHAPE_EDGE&&s.GetType()==e.ShapeType.SHAPE_EDGE){a=new e.MeasureAngle,a.SetMeasureType(e.Measure.MEASURE_TYPE_CURVE_CURVE_ANGLE);var c=f,h=l,p=e.Color.GRAY().Clone(),d=e.Color.WHITE().Clone(),v=e.Color.BLACK().Clone(),m=e.Color.GREEN().Clone(),g=e.Color.RED().Clone(),y=e.Color.BLUE().Clone(),b=new e.LineAttribute;b.SetID(i.GetID()),b.SetDirection(new e.Vector3(i.GetPosition().x-i.GetEndPoint().x,i.GetPosition().y-i.GetEndPoint().y,i.GetPosition().z-i.GetEndPoint().z)),b.SetStartPoint(i.GetEndPoint()),b.SetEndPoint(i.GetPosition()),b.SetCenterPoint(new e.Vector3(NaN,NaN,NaN));var w=new e.LineAttribute;w.SetID(s.GetID()),w.SetDirection(new e.Vector3(s.GetPosition().x-s.GetEndPoint().x,s.GetPosition().y-s.GetEndPoint().y,s.GetPosition().z-s.GetEndPoint().z)),w.SetStartPoint(s.GetEndPoint()),w.SetEndPoint(s.GetPosition()),w.SetCenterPoint(new e.Vector3(NaN,NaN,NaN));var E=e.ShapeHelper.GetShapeWorldMatrix(c),S=e.ShapeHelper.GetShapeWorldMatrix(h);e.GeometryHelper.Transform(b,E),e.GeometryHelper.Transform(w,S);var x=void 0;x=e.MeasureCalculateHelper.LineLineAngle(b,w,x),x=x.toFixed(3);var T=u.GetCamera().GetViewPort().GetScreenRay(o.x,o.y),N=b.GetStartPoint(),C=b.GetEndPoint(),k=C.Sub(N).Clone(),L=w.GetStartPoint(),A=w.GetEndPoint(),O=L.Add(A).Divide(2).Clone(),M=L.Add(k).Clone(),_=new e.Plane(T.GetDirection(),N),D=_.Project(T.GetOrigin()),P=new e.Line3D(N,C),H=e.Color.GREEN().Clone();P.SetColor(t.SelectColor().Clone());var B=new e.Line3D(L,A);B.SetColor(t.SelectColor().Clone());var j=new e.Line3D(L,M),F=e.Color.YELLOW().Clone();j.SetColor(t.ExLineColor().Clone()),j.SetName("exLine");var I=new e.Line3D(N,L);I.SetColor(t.ExLineColor().Clone()),I.SetName("exLine");var q=new e.Line3D(C,M);q.SetColor(t.ExLineColor().Clone()),q.SetName("exLine");var R=new Array;e.MeasureDisplayHelper.CreateAngleMark(L,M,L,A,x,R);var U=void 0;if(R.length>0){for(var z=0;z<R.length-1;z++){var W=new e.Line3D(R[z],R[z+1]);W.SetColor(t.MeasureColor1().Clone()),a.AddLine(W)}x>0&&x<90||x>90&&x<180?U=new e.Line3D(R[R.length/2].Add(R[R.length/2-1]).Divide(2).Clone(),D):x-90<1e-7&&x-90>-1e-7?U=new e.Line3D(R[1],D):U=new e.Line3D(L,D)}else U=new e.Line3D(L,D);U.SetName("MeasureImageLeader"),U.SetColor(t.LeaderColor().Clone());var X=new Array,V="线线角度",$=40;X.push($);var J=250,K=String(x),Q=new e.ComText,G=new e.CText;G.SetText(K),Q.AddCText(G),a.ComTexts.push(Q);var Y=u.GetSceneBox().Length()/20;a.AddLine(U),a.AddLine(P),a.AddLine(B),a.AddLine(j);var Z=new e.Shape2DSet,et=40,tt=new e.Vector2(1,1),nt=new e.Vector2(J,100),rt=450;e.MeasureDisplayHelper.createRectImage(Z,tt,nt,rt,t.MeasureColor1().Clone(),d,d,v,V,K,et,!0);var it=null;e.MeasureDisplayHelper.addImageToMemory(u,it,Z,D,(J+rt)/100,1.5,a)}return a},t.createLineToFaceAngle=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length==4){var i=n[0],s=n[1],o=n[2],u=n[3],a=null,f=u.GetShape(i),l=u.GetShape(s);if(f&&l&&f.GetType()==e.ShapeType.SHAPE_EDGE&&l.GetType()==e.ShapeType.SHAPE_FACE){e.LOGE("createLineTOFaceAngle step2"),a=new e.MeasureAngle,a.SetMeasureType(e.Measure.MEASURE_TYPE_LINE_FACE_ANGLE);var c=f,h=l,p=c.GetLineData(),d=h.GetMesh(),v=c.GetGeoAttribute(),m=h.GetGeoAttribute(),g=e.Color.GRAY().Clone(),y=e.Color.WHITE().Clone(),b=e.Color.BLACK().Clone(),w=e.Color.GREEN().Clone(),E=e.Color.RED().Clone(),S=e.Color.BLUE().Clone();if(v!=null&&v.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE&&m!=null&&m.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){var x=v,T=m,N=e.ShapeHelper.GetShapeWorldMatrix(c),C=e.ShapeHelper.GetShapeWorldMatrix(h);e.GeometryHelper.Transform(x,N),e.GeometryHelper.Transform(T,C);var k=void 0;k=e.MeasureCalculateHelper.LineFaceAngle(x,T,k).toFixed(3);var L=d.GetBoundingBox(),A=L.Center();e.GeometryHelper.Transform(A,C);var O=u.GetCamera().GetViewPort().GetScreenRay(o.x,o.y),M=x.GetStartPoint(),_=x.GetEndPoint(),D=M.Add(_).Divide(2).Clone(),P=D.Add(A).Divide(2).Clone(),H=new e.Plane(O.GetDirection(),M),B=H.Project(O.GetOrigin()),j=new e.Line3D(D,A);j.SetColor(t.MeasureColor1().Clone());var F=new e.Line3D(P,B);F.SetName("MeasureImageLeader"),F.SetColor(t.LeaderColor().Clone());var I=new e.Line3D(M,_);I.SetColor(t.SelectColor().Clone());var q=new e.Point(D);q.SetDrawType(1),q.SetSize(.8),a.AddPoint(q);var R=new e.Point(A);R.SetDrawType(1),R.SetSize(.8),a.AddPoint(R);var U=k.toString(),z=new Array,W="线面夹角",X=40;z.push(X);var V=250,$=u.GetSceneBox().Length()/20,J=new e.ComText,K=new e.CText;K.SetText(U),J.AddCText(K),a.ComTexts.push(J),a.AddLine(j),a.AddLine(F),a.AddLine(I);var Q=new e.Shape2DSet,G=40,Y=new e.Vector2(1,1),Z=new e.Vector2(V,100),et=450;e.MeasureDisplayHelper.createRectImage(Q,Y,Z,et,t.MeasureColor1().Clone(),y,y,b,W,U,G,!0);var tt=null;e.MeasureDisplayHelper.addImageToMemory(u,tt,Q,B,(V+et)/100,1.5,a)}else a=null}return a}if(n.length==6){var i=n[0],s=n[1],nt=n[2],rt=n[3],o=n[4],u=n[5],a=null,f=u.GetShape(i),l=u.GetShape(s),it=u.GetShape(rt);if(f&&l&&it&&f.GetType()==e.ShapeType.SHAPE_EDGE&&l.GetType()==e.ShapeType.SHAPE_FACE&&it.GetType()==e.ShapeType.SHAPE_POINT_HANDLE){a=new e.MeasureAngle,a.SetMeasureType(e.Measure.MEASURE_TYPE_LINE_FACE_ANGLE);var c=f,h=l,p=c.GetLineData(),d=h.GetMesh(),st=it,ot=st.GetPosition(),v=c.GetGeoAttribute(),m=h.GetGeoAttribute(),g=e.Color.GRAY().Clone(),y=e.Color.WHITE().Clone(),b=e.Color.BLACK().Clone(),w=e.Color.GREEN().Clone(),E=e.Color.RED().Clone(),S=e.Color.BLUE().Clone();if(v!=null&&v.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE&&m!=null&&m.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){var x=v,T=m,N=e.ShapeHelper.GetShapeWorldMatrix(c),C=e.ShapeHelper.GetShapeWorldMatrix(h);e.GeometryHelper.Transform(x,N),e.GeometryHelper.Transform(T,C);var k=void 0;k=e.MeasureCalculateHelper.LineFaceAngle(x,T,k).toFixed(3);var O=u.GetCamera().GetViewPort().GetScreenRay(o.x,o.y),M=x.GetStartPoint(),_=x.GetEndPoint(),D=M.Add(_).Divide(2),P=D.Add(ot).Divide(2).Clone(),H=new e.Plane(O.GetDirection(),M),B=H.Project(O.GetOrigin()),j=new e.Line3D(D,ot);j.SetColor(t.MeasureColor1().Clone());var F=new e.Line3D(P,B);F.SetName("MeasureImageLeader"),F.SetColor(t.LeaderColor().Clone());var I=new e.Line3D(M,_);I.SetColor(t.SelectColor().Clone());var q=new e.Point(D);q.SetDrawType(1),q.SetSize(.8),a.AddPoint(q);var R=new e.Point(ot);R.SetDrawType(1),R.SetSize(.8),a.AddPoint(R);var U=String(k),z=new Array,W="线面角度",X=40;z.push(X);var V=250,$=u.GetSceneBox().Length()/20;a.AddLine(j),a.AddLine(F),a.AddLine(I);var Q=new e.Shape2DSet,G=40,Y=new e.Vector2(1,1),Z=new e.Vector2(X,100),et=450;e.MeasureDisplayHelper.createRectImage(Q,Y,Z,et,t.MeasureColor1().Clone(),y,y,b,W,U,G,!0);var tt=null;e.MeasureDisplayHelper.addImageToMemory(u,tt,Q,B,(V+et)/100,1.5,a)}else a=null}return a}},t.createFaceToFaceAngle=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length==4){var i=n[0],s=n[1],o=n[2],u=n[3],a=null,f=u.GetShape(i),l=u.GetShape(s);if(f&&l&&f.GetType()==e.ShapeType.SHAPE_FACE&&l.GetType()==e.ShapeType.SHAPE_FACE){a=new e.MeasureAngle,a.SetMeasureType(e.Measure.MEASURE_TYPE_FACE_FACE_ANGLE);var c=f,h=l,p=c.GetMesh(),d=h.GetMesh(),v=c.GetGeoAttribute(),m=h.GetGeoAttribute();if(v!=null&&v.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE&&m!=null&&m.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){e.LOGI("createFaceTOFaceAngle step3");var g=v,y=m,b=e.ShapeHelper.GetShapeWorldMatrix(c),w=e.ShapeHelper.GetShapeWorldMatrix(h);e.GeometryHelper.Transform(g,b),e.GeometryHelper.Transform(y,w);var E=void 0;E=e.MeasureCalculateHelper.FaceFaceAngle(g,y,E).toFixed(3);var S=p.GetBoundingBox(),x=S.Center();e.GeometryHelper.Transform(x,b);var T=d.GetBoundingBox(),N=T.Center();e.GeometryHelper.Transform(N,w);var C=x.Add(N).Divide(2).Clone(),k=u.GetCamera().GetViewPort().GetScreenRay(o.x,o.y),L=new e.Plane(k.GetDirection(),C),A=L.Project(k.GetOrigin()),O=new e.Line3D(C,A);O.SetName("MeasureImageLeader");var M=new e.Line3D(x,N);M.SetColor(t.MeasureColor1().Clone());var _=new e.Point(x);_.SetDrawType(1),_.SetSize(.8),a.AddPoint(_);var D=new e.Point(N);D.SetDrawType(1),D.SetSize(.8),a.AddPoint(D),O.SetColor(t.LeaderColor().Clone());var P=String(E),H=new Array,B="面面夹角",j=40;H.push(j);var F=250,I=new e.ComText,q=new e.CText;q.SetText(P),I.AddCText(q),a.ComTexts.push(I);var R=u.GetSceneBox().Length()/20;a.AddLine(O),a.AddLine(M);var U=new e.Shape2DSet,z=40,W=new e.Vector2(1,1),X=new e.Vector2(F,100),V=450,$=e.Color.GRAY().Clone(),J=e.Color.WHITE().Clone(),K=e.Color.BLACK().Clone(),Q=e.Color.GREEN().Clone(),G=e.Color.RED().Clone(),Y=e.Color.BLUE().Clone();e.MeasureDisplayHelper.createRectImage(U,W,X,V,t.MeasureColor1().Clone(),J,J,K,B,P,z,!0);var Z=null;e.MeasureDisplayHelper.addImageToMemory(u,Z,U,A,(F+V)/100,1.5,a)}else a=null}return a}if(n.length==6){var i=n[0],s=n[1],et=n[2],tt=n[2],o=n[4],u=n[5],a=null,f=u.GetShape(i),l=u.GetShape(s),nt=u.GetShape(et),rt=u.GetShape(tt);if(f&&l&&nt&&rt&&f.GetType()==e.ShapeType.SHAPE_FACE&&l.GetType()==e.ShapeType.SHAPE_FACE&&nt.GetType()==e.ShapeType.SHAPE_POINT_HANDLE&&rt.GetType()==e.ShapeType.SHAPE_POINT_HANDLE){e.LOGE("createFaceTOFaceAngle step2"),a=new e.MeasureAngle,a.SetMeasureType(e.Measure.MEASURE_TYPE_FACE_FACE_ANGLE);var c=f,h=l,p=c.GetMesh(),d=h.GetMesh(),it=nt,st=it.GetPosition(),ot=rt,ut=ot.GetPosition(),v=c.GetGeoAttribute(),m=h.GetGeoAttribute();if(v!=null&&v.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE&&m!=null&&m.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){var g=v,y=m,b=e.ShapeHelper.GetShapeWorldMatrix(c),w=e.ShapeHelper.GetShapeWorldMatrix(h);e.GeometryHelper.Transform(g,b),e.GeometryHelper.Transform(y,w);var E=void 0;E=e.MeasureCalculateHelper.FaceFaceAngle(g,y,E).toFixed(3);var C=st.Add(ut).Divide(2),k=u.GetCamera().GetViewPort().GetScreenRay(o.x,o.y),L=new e.Plane(k.GetDirection(),C),A=L.Project(k.GetOrigin()),O=new e.Line3D(C,A);O.SetName("MeasureImageLeader");var M=new e.Line3D(st,ut);M.SetColor(t.MeasureColor1().Clone());var _=new e.Point(st);_.SetDrawType(1),_.SetSize(.8),a.AddPoint(_);var D=new e.Point(ut);D.SetDrawType(1),D.SetSize(.8),a.AddPoint(D),O.SetColor(t.LeaderColor().Clone());var P=String(E),H=new Array,B="面面夹角",j=40;H.push(j);var F=250,R=u.GetSceneBox().Length()/20;a.AddLine(O),a.AddLine(M);var U=new e.Shape2DSet,z=40,W=new e.Vector2(1,1),X=new e.Vector2(F,100),V=450,$=e.Color.GRAY().Clone(),J=e.Color.WHITE().Clone(),K=e.Color.BLACK().Clone(),Q=e.Color.GREEN().Clone(),G=e.Color.RED().Clone(),Y=e.Color.BLUE().Clone();e.MeasureDisplayHelper.createRectImage(U,W,X,V,t.MeasureColor1().Clone(),J,J,K,B,P,z,!0);var Z=null;e.MeasureDisplayHelper.addImageToMemory(u,Z,U,A,(F+V)/100,1.5,a)}else a=null}return a}},t.GetPntProperty=function(t,n,r){r="";var i=n.GetShape(t);if(i&&i.GetType()==e.ShapeType.SHAPE_POINT_HANDLE){var s=i,o=s.GetPosition(),u=String(o.x)+", ",a=String(o.y)+", ",f=String(o.z),l="点属性",c=u+a+f;s.ClearProperties(),s.AddProperty(l,c),r=s.GetProperties()}else e.LOGE("MeasureFactory.GetPntProperty is NULL"),r="";return r},t.GetLineProperty=function(t,n,r){r="";var i=n.GetShape(t);if(i&&i.GetType()==e.ShapeType.SHAPE_EDGE){var s=i,o=s.GetLineData(),u=s.GetGeoAttribute();if(u!=null&&u.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE){var a=u,f=e.ShapeHelper.GetShapeWorldMatrix(s);e.GeometryHelper.Transform(a,f);var l=a.GetStartPoint(),c=a.GetEndPoint(),h=l.Add(c).Divide(2).Clone(),p=l.Sub(c).Length(),d=String(p),v="线属性";s.AddProperty(v,d),r=s.GetProperties()}else if(u!=null&&u.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE){var m=u,f=e.ShapeHelper.GetShapeWorldMatrix(s);e.GeometryHelper.Transform(m,f);var l=m.GetStartPoint(),c=m.GetEndPoint(),g=m.GetCenterPoint(),y=m.GetMajorRadius(),b=new e.Vector3,w=new e.Vector3,E=new e.Vector3;m.GetXYZDir(b,w,E);var S=0,x=l.Sub(g).Clone(),T=c.Sub(g).Clone(),N=x.CrossProduct(T),C=N.DotProduct(E),k=e.Acos(x.DotProduct(T.Divide(x.Length()*T.Length())));l==c?S=2*e.PI*y:C>0?S=k*y:S=(2*e.PI-k)*y;var L=String(y),A=String(g.x),O=String(g.y),M=String(g.z),_=A+","+O+","+M,D=String(S),P="曲线中心",H="曲线角度",B="曲线半径";s.AddProperty(P,_),s.AddProperty(H,L),s.AddProperty(B,D),r=s.GetProperties()}else{var j=0;e.MeasureCalculateHelper.PolyLineLength(o,j);var d=String(j),v="线属性";s.AddProperty(v,d),r=s.GetProperties()}}else r="";return e.LOGI(" MeasureFactory.GetLineProperty END"),r},t.GetFaceProperty=function(t,n,r){r="";var i=n.GetShape(t);if(i&&i.GetType()==e.ShapeType.SHAPE_FACE){var s=i,o=s.GetMesh(),u=s.GetGeoAttribute();r=s.GetProperties()}return e.LOGI(" MeasureFactory::GetFaceProperty END"),r},t.GetModelProperty=function(t,n,r){r="";var i=n.GetShape(t);if(i&&i.GetType()==e.ShapeType.SHAPE_MODEL){var s=i;r=s.GetProperties()}else{var s=n.GetModel();r=s.GetProperties()}return r},t.createPntProperty=function(n,r,i){var s=null,o=i.GetShape(n);if(o&&o.GetType()==e.ShapeType.SHAPE_POINT_HANDLE){var u=o;s=new e.MeasureProperty,s.SetMeasureType(e.Measure.MEASURE_TYPE_PNT_COORD);var a=u.GetPosition(),f=i.GetCamera().GetViewPort().GetScreenRay(r.x,r.y),l=new e.Plane(f.GetDirection(),a),c=l.Project(f.GetOrigin()),h=new e.Line3D(a,c);h.SetName("MeasureImageLeader"),h.SetColor(t.LeaderColor().Clone());var p=new e.Point(a),d=e.Color.GREEN().Clone();p.SetColor(d),p.SetDrawType(1),p.SetSize(.8);var v=String(a.x)+", ",m=String(a.y)+", ",g=String(a.z),y="点坐标",b=v+m+g,w=i.GetSceneBox().Length()/2;s.AddLine(h),s.AddPoint(p);var E=new e.Shape2DSet,S=40,x=new e.Vector2(1,1),T=new e.Vector2((y.length-1)*S/2+S,S*2.5),N=S*b.length/2+S/2,C=e.Color.GRAY().Clone(),k=e.Color.WHITE().Clone(),L=e.Color.BLACK().Clone(),A=e.Color.GREEN().Clone(),O=e.Color.RED().Clone(),M=e.Color.BLUE().Clone();e.MeasureDisplayHelper.createRectImage(E,x,T,N,C,k,k,L,y,b,S,!0);var _=null;e.MeasureDisplayHelper.addImageToMemory(i,_,E,c,((y.length-1)*S/2+S+N)/100,S*2.5/100,s)}return s},t.createLineProperty=function(n,r,i){var s=null,o=i.GetShape(n);if(o&&o.GetType()==e.ShapeType.SHAPE_EDGE){var u=o;s=new e.MeasureProperty,s.SetMeasureType(e.Measure.MEASURE_TYPE_LINE_LENGTH);var a=u.GetLineData(),f=a.GetGeoAttribute();if(f!=null&&f.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE){var l=f,c=e.ShapeHelper.GetShapeWorldMatrix(u);e.GeometryHelper.Transform(l,c);var h=l.GetStartPoint(),p=l.GetEndPoint(),d=h.Add(p).Divide(2).Clone(),v=i.GetCamera().GetViewPort().GetScreenRay(r.x,r.y),m=new e.Plane(v.GetDirection(),d),g=m.Project(v.GetOrigin()),y=new e.Line3D(h,p),b=e.Color.GREEN().Clone();y.SetColor(b);var w=new e.Line3D(d,g),E=e.Color.GRAY().Clone();w.SetName("MeasureImageLeader"),w.SetColor(t.LeaderColor().Clone());var S=h.Sub(p).Length(),x=String(S),T="长度",N=i.GetSceneBox().Length()/20;s.AddLine(y),s.AddLine(w);var C=new e.Shape2DSet,k=40,L=new e.Vector2(1,1),A=new e.Vector2(180,100),O=450,M=e.Color.GRAY().Clone(),_=e.Color.WHITE().Clone(),D=e.Color.BLACK().Clone(),P=e.Color.GREEN().Clone(),H=e.Color.RED().Clone(),B=e.Color.BLUE().Clone();e.MeasureDisplayHelper.createRectImage(C,L,A,O,M,_,_,D,T,x,k,!0);var j=null;e.MeasureDisplayHelper.addImageToMemory(i,j,C,g,6,1,s)}}return s},t.createCircleProperty=function(n,r,i){var s=null,o=i.GetShape(n);if(o&&o.GetType()==e.ShapeType.SHAPE_EDGE){var u=o;s=new e.MeasureProperty,s.SetMeasureType(e.Measure.MEASURE_TYPE_CRICLE_PROPERTY);var a=u.GetLineData(),f=a.GetGeoAttribute();if(f!=null&&f.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE){var l=f,c=e.ShapeHelper.GetShapeWorldMatrix(u);e.GeometryHelper.Transform(l,c);var h=l.GetStartPoint(),p=l.GetEndPoint(),d=l.GetCenterPoint(),v=l.GetMajorRadius(),m=new e.Vector3,g=new e.Vector3,y=new e.Vector3;l.GetXYZDir(m,g,y);var b=0,w=h.Sub(d).Clone(),E=p.Sub(d).Clone(),S=w.CrossProduct(E),x=S.DotProduct(y),T=e.Acos(w.DotProduct(E.Divide(w.Length())));h==p?b=2*e.PI*v:x>0?b=T*v:b=(2*e.PI-T)*v;var N=i.GetCamera().GetViewPort().GetScreenRay(r.x,r.y),C=new e.Plane(N.GetDirection(),d),k=C.Project(N.GetOrigin()),L=a.GetRefLine(),A=L.GetPoints(),O=a.GetDataOffset(),M=a.GetDataLength();for(var _=O;_<M;_+=2){var D=new e.Line3D(c.Multiply(A[_]).Clone(),c.Multiply(A[_+1]).Clone()),P=e.Color.GREEN().Clone();D.SetColor(P),s.AddLine(D)}var H=new e.Line3D(d,k);H.SetName("MeasureImageLeader"),H.SetColor(t.LeaderColor().Clone());var B=new e.Line3D(d,h),j=e.Color.RED().Clone();B.SetColor(j);var F=new e.Point(d);F.SetDrawType(1),F.SetSize(.5);var I=String(v),q=String(d.x),R=String(d.y),
U=String(d.z),z=q+","+R+","+U,W=String(b),X="圆心",V=i.GetSceneBox().Length()/20;s.AddLine(H),s.AddLine(B),s.AddPoint(F);var $=new e.Shape2DSet,J=40,K=new e.Vector2(1,1),Q=new e.Vector2(180,100),G=450,Y=e.Color.GRAY().Clone(),Z=e.Color.WHITE().Clone(),et=e.Color.BLACK().Clone(),tt=e.Color.GREEN().Clone(),nt=e.Color.RED().Clone(),rt=e.Color.BLUE().Clone(),it=new e.Vector2(1,1),st=new e.Vector2(180,300);e.MeasureDisplayHelper.createRectImage($,K,Q,G,Y,Z,Z,et,X,z,J,!1);var ot=new e.Vector2(1,100),ut=new e.Vector2(180,200);e.MeasureDisplayHelper.createRectImage($,ot,ut,G,nt,Z,Z,et,"半径",I,J,!1);var at=new e.Vector2(1,200),ft=new e.Vector2(180,300);e.MeasureDisplayHelper.createRectImage($,at,ft,G,tt,Z,et,et,"弧长",W,J,!0);var lt=null;e.MeasureDisplayHelper.addImageToMemory(i,lt,$,k,6,3,s)}}return s},t.createFaceProperty=function(n,r,i){var s=null,o=i.GetShape(n);if(o&&o.GetType()==e.ShapeType.SHAPE_FACE){var u=o;s=new e.MeasureProperty,s.SetMeasureType(e.Measure.MEASURE_TYPE_FACE_PROPERTY);var a=u.GetMesh(),f=a.GetGeoAttribute(),l=0;e.MeasureCalculateHelper.faceArea(a,l);if(f!=null&&f.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE){var c=f,h=e.ShapeHelper.GetShapeWorldMatrix(u);e.GeometryHelper.Transform(c,h);var p=a.GetBoundingBox(),d=p.Center();e.GeometryHelper.Transform(d,h);var v=i.GetCamera().GetViewPort().GetScreenRay(r.x,r.y),m=new e.Plane(v.GetDirection(),d),g=m.Project(v.GetOrigin()),y=new e.Line3D(d,g);y.SetName("MeasureImageLeader"),y.SetColor(t.LeaderColor().Clone());var b=c.GetNormal(),w=String(l),E=i.GetSceneBox().Length()/20;s.AddLine(y);var S=new e.Shape2DSet,x=40,T=new e.Vector2(1,1),N=new e.Vector2(180,100),C=450,k=e.Color.GRAY().Clone(),L=e.Color.WHITE().Clone(),A=e.Color.BLACK().Clone(),O=e.Color.GREEN().Clone(),M=e.Color.RED().Clone(),_=e.Color.BLUE().Clone();e.MeasureDisplayHelper.createRectImage(S,T,N,C,k,L,L,A,"面积",w,x,!0);var D=null;e.MeasureDisplayHelper.addImageToMemory(i,D,S,g,6,1,s)}else if(f!=null&&f.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_REVOLUTIONFACE){var P=f,h=e.ShapeHelper.GetShapeWorldMatrix(u);e.GeometryHelper.Transform(P,h);var p=a.GetBoundingBox(),d=p.Center();e.GeometryHelper.Transform(d,h);var v=i.GetCamera().GetViewPort().GetScreenRay(r.x,r.y),m=new e.Plane(v.GetDirection(),d),g=m.Project(v.GetOrigin()),y=new e.Line3D(d,g);y.SetName("MeasureImageLeader"),y.SetColor(t.LeaderColor().Clone());var H=P.GetRadius(),w=String(l),E=i.GetSceneBox().Length()/20;s.AddLine(y);var S=new e.Shape2DSet,x=40,T=new e.Vector2(1,1),N=new e.Vector2(200,100),C=450,k=e.Color.GRAY().Clone(),L=e.Color.WHITE().Clone(),A=e.Color.BLACK().Clone(),O=e.Color.GREEN().Clone(),M=e.Color.RED().Clone(),_=e.Color.BLUE().Clone();e.MeasureDisplayHelper.createRectImage(S,T,N,C,k,L,L,A,"面积",w,x,!0);var D=null;e.MeasureDisplayHelper.addImageToMemory(i,D,S,g,6,1,s)}else if(f!=null&&f.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_CYLINDERFACE){var P=f,h=e.ShapeHelper.GetShapeWorldMatrix(u);e.GeometryHelper.Transform(P,h);var p=a.GetBoundingBox(),d=p.Center();e.GeometryHelper.Transform(d,h);var v=i.GetCamera().GetViewPort().GetScreenRay(r.x,r.y),m=new e.Plane(v.GetDirection(),d),g=m.Project(v.GetOrigin()),y=new e.Line3D(d,g);y.SetName("MeasureImageLeader"),y.SetColor(t.LeaderColor().Clone());var w=String(l),E=i.GetSceneBox().Length()/20;s.AddLine(y);var S=new e.Shape2DSet,x=40,T=new e.Vector2(1,1),N=new e.Vector2(200,100),C=450,k=e.Color.GRAY().Clone(),L=e.Color.WHITE().Clone(),A=e.Color.BLACK().Clone(),O=e.Color.GREEN().Clone(),M=e.Color.RED().Clone(),_=e.Color.BLUE().Clone();e.MeasureDisplayHelper.createRectImage(S,T,N,C,k,L,L,A,"面积",w,x,!0);var D=null;e.MeasureDisplayHelper.addImageToMemory(i,D,S,g,6,1,s)}else if(f!=null&&f.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_CONICALFACE){var P=f,h=e.ShapeHelper.GetShapeWorldMatrix(u);e.GeometryHelper.Transform(P,h);var p=a.GetBoundingBox(),d=p.Center();e.GeometryHelper.Transform(d,h);var v=i.GetCamera().GetViewPort().GetScreenRay(r.x,r.y),m=new e.Plane(v.GetDirection(),d),g=m.Project(v.GetOrigin()),y=new e.Line3D(d,g);y.SetName("MeasureImageLeader"),y.SetColor(t.LeaderColor().Clone());var w=String(l),E=i.GetSceneBox().Length()/20;s.AddLine(y);var S=new e.Shape2DSet,x=40,T=new e.Vector2(1,1),N=new e.Vector2(200,100),C=450,k=e.Color.GRAY().Clone(),L=e.Color.WHITE().Clone(),A=e.Color.BLACK().Clone(),O=e.Color.GREEN().Clone(),M=e.Color.RED().Clone(),_=e.Color.BLUE().Clone();e.MeasureDisplayHelper.createRectImage(S,T,N,C,k,L,L,A,"面积",w,x,!0);var D=null;e.MeasureDisplayHelper.addImageToMemory(i,D,S,g,6,1,s)}else if(f!=null&&f.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_SPHEREFACE){var P=f,h=e.ShapeHelper.GetShapeWorldMatrix(u);e.GeometryHelper.Transform(P,h);var p=a.GetBoundingBox(),d=p.Center();e.GeometryHelper.Transform(d,h);var v=i.GetCamera().GetViewPort().GetScreenRay(r.x,r.y),m=new e.Plane(v.GetDirection(),d),g=m.Project(v.GetOrigin()),y=new e.Line3D(d,g);y.SetName("MeasureImageLeader"),y.SetColor(t.LeaderColor().Clone());var w=String(l),E=i.GetSceneBox().Length()/20;s.AddLine(y);var S=new e.Shape2DSet,x=40,T=new e.Vector2(1,1),N=new e.Vector2(200,100),C=450,k=e.Color.GRAY().Clone(),L=e.Color.WHITE().Clone(),A=e.Color.BLACK().Clone(),O=e.Color.GREEN().Clone(),M=e.Color.RED().Clone(),_=e.Color.BLUE().Clone();e.MeasureDisplayHelper.createRectImage(S,T,N,C,k,L,L,A,"面积",w,x,!0);var D=null;e.MeasureDisplayHelper.addImageToMemory(i,D,S,g,6,1,s)}else if(f!=null&&f.GetGeoAttrType()==e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_TOROIDALFACE){var P=f,h=e.ShapeHelper.GetShapeWorldMatrix(u);e.GeometryHelper.Transform(P,h);var p=a.GetBoundingBox(),d=p.Center();e.GeometryHelper.Transform(d,h);var v=i.GetCamera().GetViewPort().GetScreenRay(r.x,r.y),m=new e.Plane(v.GetDirection(),d),g=m.Project(v.GetOrigin()),y=new e.Line3D(d,g);y.SetName("MeasureImageLeader"),y.SetColor(t.LeaderColor().Clone());var w=String(l),E=i.GetSceneBox().Length()/20;s.AddLine(y);var S=new e.Shape2DSet,x=40,T=new e.Vector2(1,1),N=new e.Vector2(200,100),C=450,k=e.Color.GRAY().Clone(),L=e.Color.WHITE().Clone(),A=e.Color.BLACK().Clone(),O=e.Color.GREEN().Clone(),M=e.Color.RED().Clone(),_=e.Color.BLUE().Clone();e.MeasureDisplayHelper.createRectImage(S,T,N,C,k,L,L,A,"面积",w,x,!0);var D=null;e.MeasureDisplayHelper.addImageToMemory(i,D,S,g,6,1,s)}else{var h=e.ShapeHelper.GetShapeWorldMatrix(u),p=a.GetBoundingBox(),d=p.Center();e.GeometryHelper.Transform(d,h);var v=i.GetCamera().GetViewPort().GetScreenRay(r.x,r.y),m=new e.Plane(v.GetDirection(),d),g=m.Project(v.GetOrigin()),y=new e.Line3D(d,g);y.SetName("MeasureImageLeader"),y.SetColor(t.LeaderColor().Clone());var w=String(l),E=i.GetSceneBox().Length()/20;s.AddLine(y);var S=new e.Shape2DSet,x=40,T=new e.Vector2(1,1),N=new e.Vector2(180,100),C=450,k=e.Color.GRAY().Clone(),L=e.Color.WHITE().Clone(),A=e.Color.BLACK().Clone(),O=e.Color.GREEN().Clone(),M=e.Color.RED().Clone(),_=e.Color.BLUE().Clone();e.MeasureDisplayHelper.createRectImage(S,T,N,C,k,L,L,A,"面积",w,x,!0);var D=null;e.MeasureDisplayHelper.addImageToMemory(i,D,S,g,6,1,s)}}return s},t.createModelProperty=function(n,r,i){var s=null,o=i.GetShape(n);if(o&&o.GetType()==e.ShapeType.SHAPE_MODEL){var u=o;s=new e.MeasureProperty,s.SetMeasureType(e.Measure.MEASURE_TYPE_MODEL_PROPERTY);var a=u.GetName(),f=u.GetColor(),l=u.GetVertexCount(0)/3,c=u.GetVertexCount(1)/3,h=e.ShapeHelper.GetShapeWorldMatrix(u),p=u.GetBoundingBox(),d=p.Center();e.GeometryHelper.Transform(d,h);var v=i.GetCamera().GetViewPort().GetScreenRay(r.x,r.y),m=new e.Plane(v.GetDirection(),d),g=m.Project(v.GetOrigin()),y=new e.Line3D(d,g);y.SetName("MeasureImageLeader"),y.SetColor(t.LeaderColor().Clone()),s.AddLine(y);var b=new e.Shape2DSet,w=40,E=500,S=e.Color.GRAY().Clone(),x=e.Color.WHITE().Clone(),T=e.Color.BLACK().Clone(),N=e.Color.GREEN().Clone(),C=e.Color.RED().Clone(),k=e.Color.BLUE().Clone(),L=new e.Vector2(1,1),A=new e.Vector2(180,200),O=new e.Vector2(1,1),M=new e.Vector2(180,100);e.MeasureDisplayHelper.createRectImage(b,O,M,E,S,x,x,T,"名称",a,w,!1);var _=new e.Vector2(1,100),D=new e.Vector2(180,200);e.MeasureDisplayHelper.createRectImage(b,_,D,E,C,x,x,T,"面数",String(l),w,!0);var P=null;e.MeasureDisplayHelper.addImageToMemory(i,P,b,g,6,2,s)}return s},t.AddMeasureToScene=function(t,n){var r=!1;if(t&&n){var i=t.GetMeasureGroup(),s=new e.ShapeNode;s.SetShape(n);var o=s.GetID().toString();s.SetName(i.GetName()+"|"+o),i.AddChild(s),t.AddShapeIDToMap(n),r=!0}return r},t.UpdateMeasureImagePos=function(t,n,r){var i=new e.Vector3;if(t!=null&&r!=null){var s=t.GetImageBoards();for(var o=0;o<s.length;o++){var u=s[0];if(u){var a=u.GetPosition().Clone(),f=r.GetCamera().GetViewPort().GetScreenRay(n.x,n.y),l=new e.Plane(f.GetDirection(),a);a=l.Project(f.GetOrigin()),u.SetPosition(a),i=a}}var c=t.LineList;for(var o=0;o<c.length;o++){var h=c[o];h&&h.GetName()=="MeasureImageLeader"&&(h.EndPoint=i)}r.GetRenderManager().RequestRedraw()}},t.MeasureToXMLElement=function(n,r){var i="",s=document,o=s.createElement(t.Serializer_XML_Element_Measures);o.setAttribute(t.Serializer_XML_Attribute_ID,String(n.GetID())),o.setAttribute(t.Serializer_XML_Attribute_MeasureType,String(n.GetMeasureType()));var u=s.createElement(t.Serializer_XML_Element_ImageBoard);o.appendChild(u);if(n.imageBoardList.length>0){var a=n.imageBoardList[0],f=a.GetPosition(),l=s.createElement(t.Serializer_XML_Element_Center);l.setAttribute(t.Serializer_XML_Attribute_X,String(f.x)),l.setAttribute(t.Serializer_XML_Attribute_Y,String(f.y)),l.setAttribute(t.Serializer_XML_Attribute_Z,String(f.z)),u.appendChild(l)}var c=s.createElement(t.Serializer_XML_Element_Points);o.appendChild(c);for(var h=0;h<n.PointList.length;h++){var p=n.PointList[h],d=s.createElement(t.Serializer_XML_Element_Point);c.appendChild(d),d.setAttribute(t.Serializer_XML_Attribute_X,String(p.GetCoordinate().x)),d.setAttribute(t.Serializer_XML_Attribute_Y,String(p.GetCoordinate().y)),d.setAttribute(t.Serializer_XML_Attribute_Z,String(p.GetCoordinate().z));var v=p.GetColor(),m=String(v.r)+" "+String(v.g)+" "+String(v.b);d.setAttribute(t.Serializer_XML_Attribute_Color,m)}var g=new e.Vector3,y=s.createElement(t.Serializer_XML_Element_Line3Ds);o.appendChild(y);for(var b=0;b<n.LineList.length;b++){var w=n.LineList[b],E=s.createElement(t.Serializer_XML_Element_Line3D);y.appendChild(E);var S=s.createElement(t.Serializer_XML_Element_Color);E.appendChild(S);var v=w.GetColor();S.setAttribute(t.Serializer_XML_Attribute_R,String(v.r)),S.setAttribute(t.Serializer_XML_Attribute_G,String(v.g)),S.setAttribute(t.Serializer_XML_Attribute_B,String(v.b));var x=s.createElement(t.Serializer_XML_Element_Position);E.appendChild(x),x.setAttribute(t.Serializer_XML_Attribute_X,String(w.StartPoint.x)),x.setAttribute(t.Serializer_XML_Attribute_Y,String(w.StartPoint.y)),x.setAttribute(t.Serializer_XML_Attribute_Z,String(w.StartPoint.z));var T=s.createElement(t.Serializer_XML_Element_Direction);E.appendChild(T),T.setAttribute(t.Serializer_XML_Attribute_X,String(w.EndPoint.x)),T.setAttribute(t.Serializer_XML_Attribute_Y,String(w.EndPoint.y)),T.setAttribute(t.Serializer_XML_Attribute_Z,String(w.EndPoint.z)),w.GetName()=="MeasureImageLeader"?(E.setAttribute(t.Serializer_XML_Attribute_Type,String(1)),g=w.EndPoint.Clone()):E.setAttribute(t.Serializer_XML_Attribute_Type,String(0))}var N=s.createElement(t.Serializer_XML_Element_MeasureTexts);o.appendChild(N);if(n.ComTexts.length>0)for(var h=0;h<n.ComTexts.length;h++){var C=n.ComTexts[h],k=s.createElement(t.Serializer_XML_Element_Texts);N.appendChild(k);var L=s.createElement(t.Serializer_XML_Element_Text);k.appendChild(L),L.setAttribute(t.Serializer_XML_Attribute_Value,C.GetCText(0).GetText());var A=s.createElement(t.Serializer_XML_Element_Location);L.appendChild(A),A.setAttribute(t.Serializer_XML_Attribute_X,String(g.x)),A.setAttribute(t.Serializer_XML_Attribute_Y,String(g.y)),A.setAttribute(t.Serializer_XML_Attribute_Z,String(g.z));var S=s.createElement(t.Serializer_XML_Element_Color);L.appendChild(S);var v=C.GetColor();S.setAttribute(t.Serializer_XML_Attribute_R,String(v.r)),S.setAttribute(t.Serializer_XML_Attribute_G,String(v.g)),S.setAttribute(t.Serializer_XML_Attribute_B,String(v.b))}return i=o.outerHTML,i},t.CreateMeasureFromXMLElement=function(n,r){var i=null,s,o=new e.Vector3,u=new e.Vector3,a=new e.Vector3,f;if(r.length==0)return i;i=new e.MeasureDistance;var l=r.firstChild;if(l==null)return null;var c=Number(l.getAttribute(t.Serializer_XML_Attribute_ID)),h=Number(l.getAttribute(t.Serializer_XML_Attribute_MeasureType));i.SetMeasureType(h);var p=new e.Vector3,d=l.getElementsByTagName(t.Serializer_XML_Element_ImageBoard)[0];if(d){var v=d.getElementsByTagName(t.Serializer_XML_Element_Center)[0];p.x=Number(v.getAttribute(t.Serializer_XML_Attribute_X)),p.y=Number(v.getAttribute(t.Serializer_XML_Attribute_Y)),p.z=Number(v.getAttribute(t.Serializer_XML_Attribute_Z))}var m=l.getElementsByTagName(t.Serializer_XML_Element_Points)[0];if(m){var g=m.getElementsByTagName(t.Serializer_XML_Element_Point),y=new Array;for(var b=0;b<g.length;b++){var w=new e.Vector3;w.x=Number(g[b].getAttribute(t.Serializer_XML_Attribute_X)),w.y=Number(g[b].getAttribute(t.Serializer_XML_Attribute_Y)),w.z=Number(g[b].getAttribute(t.Serializer_XML_Attribute_Z)),y.push(w)}o=y[0];var E=new e.Point(o);E.SetDrawType(1),E.SetSize(.8),i.AddPoint(E);if(b==1)u=o;else{u=y[1];var S=new e.Point(u);S.SetDrawType(1),S.SetSize(.8),i.AddPoint(S)}}var x=l.getElementsByTagName(t.Serializer_XML_Element_Line3Ds)[0];if(x){var T=x.getElementsByTagName(t.Serializer_XML_Element_Line3D);for(var N=0;N<T.length;N++){var C=void 0,k=void 0,L=new e.Vector3,A=new e.Vector3,O=T[N].getElementsByTagName(t.Serializer_XML_Element_Color)[0];k=new e.Color,k.r=Number(O.getAttribute(t.Serializer_XML_Attribute_R)),k.g=Number(O.getAttribute(t.Serializer_XML_Attribute_G)),k.b=Number(O.getAttribute(t.Serializer_XML_Attribute_B));var M=T[N].getElementsByTagName(t.Serializer_XML_Element_Position)[0],y=new e.Vector3;y.x=Number(M.getAttribute(t.Serializer_XML_Attribute_X)),y.y=Number(M.getAttribute(t.Serializer_XML_Attribute_Y)),y.z=Number(M.getAttribute(t.Serializer_XML_Attribute_Z)),L=y;var _=T[N].getElementsByTagName(t.Serializer_XML_Element_Direction)[0],y=new e.Vector3;y.x=Number(_.getAttribute(t.Serializer_XML_Attribute_X)),y.y=Number(_.getAttribute(t.Serializer_XML_Attribute_Y)),y.z=Number(_.getAttribute(t.Serializer_XML_Attribute_Z)),A=y;var D=Number(T[N].getAttribute(t.Serializer_XML_Attribute_Type));C=new e.Line3D(L,A),C.SetColor(k),D==1&&C.SetName("MeasureImageLeader"),i.AddLine(C)}}var P=l.getElementsByTagName(t.Serializer_XML_Element_MeasureTexts)[0];if(P){var H=P.getElementsByTagName(t.Serializer_XML_Element_Texts);for(var B=0;B<H.length;B++){var j=H.getElementsByTagName(t.Serializer_XML_Element_Text),F=j.Attribute(t.Serializer_XML_Attribute_Value);f=F;var I=new e.ComText,q=new e.CText;q.SetText(F),I.AddCText(q),i.ComTexts.push(I);if(j){var k=void 0,O=j.getElementsByTagName(t.Serializer_XML_Element_Color);k=new e.Color,k.r=O.FloatAttribute(t.Serializer_XML_Attribute_R),k.g=O.FloatAttribute(t.Serializer_XML_Attribute_G),k.b=O.FloatAttribute(t.Serializer_XML_Attribute_B);var R=j.getElementsByTagName(t.Serializer_XML_Element_Location);a=new e.Vector3,a.x=R.FloatAttribute(t.Serializer_XML_Attribute_X),a.y=R.FloatAttribute(t.Serializer_XML_Attribute_Y),a.z=R.FloatAttribute(t.Serializer_XML_Attribute_Z)}H=H.NextSiblingElement(t.Serializer_XML_Element_Texts)}}var U=new Array,z=new Array,W=new Array;for(var b=0;b<i.ComTexts.length;b++){var X=i.ComTexts[b].GetCText(0),V=X.GetText(),$="",J="",K=void 0;K,z.push(Number(K))}if(i.ComTexts.length===0&&i.GetMeasureType()===1){var K=i.PointList[0].GetCoordinate().Sub(i.PointList[1].GetCoordinate()).Length();z.push(Number(K))}var Q=250,G="";G=e.MeasureDisplayHelper.SetMeasureUnit(e.Parameters.Instance().measureUnitStyle,z,G);var Y=new e.Shape2DSet,Z=40,et=450,tt=e.Color.GRAY().Clone(),nt=e.Color.WHITE().Clone(),rt=e.Color.BLACK().Clone(),it=e.Color.GREEN().Clone(),st=e.Color.RED().Clone(),ot=e.Color.BLUE().Clone();for(var b=0;b<z.length;b++){var ut=z[b].toFixed(3).toString()+G,at=new e.Vector2,ft=new e.Vector2,lt=void 0;b==0?(at.x=at.y=1,ft.x=Q,ft.y=100,lt=t.MeasureColor1().Clone()):b==1?(at.x=1,at.y=100,ft.x=Q,ft.y=200,lt=t.MeasureColor2().Clone()):b==2&&(at.x=1,at.y=200,ft.x=Q,ft.y=300,lt=t.MeasureColor3().Clone());var ct=!1;b+1==z.length&&(ct=!0),e.MeasureDisplayHelper.createRectImage(Y,at,ft,et,lt,nt,nt,rt,"点点距离",ut,Z,ct)}var ht=null;return e.MeasureDisplayHelper.addImageToMemory(n,ht,Y,p,(Q+et)/(e.MeasureDisplayHelper.IsPC()?100:40),e.MeasureDisplayHelper.IsPC()?2:4,i),i.SetFrontShow(!0),i&&t.AddMeasureToScene(n,i),i},t.m_leaderColor=null,t.m_selectColor=null,t.m_exLineColor=null,t.m_measureColor1=null,t.m_measureColor2=null,t.m_measureColor3=null,t.Serializer_XML_Element_SVL="svl",t.Serializer_XML_Element_Model="model",t.Serializer_XML_Element_Users="users",t.Serializer_XML_Element_User="user",t.Serializer_XML_Element_Measures="measures",t.Serializer_XML_Element_Color="color",t.Serializer_XML_Element_ImageBoard="imageboard",t.Serializer_XML_Element_Center="center",t.Serializer_XML_Element_Line3Ds="line3ds",t.Serializer_XML_Element_Line3D="line3d",t.Serializer_XML_Element_Points="points",t.Serializer_XML_Element_Point="point",t.Serializer_XML_Element_Position="position",t.Serializer_XML_Element_Direction="direction",t.Serializer_XML_Element_MeasureTexts="measuretexts",t.Serializer_XML_Element_Texts="texts",t.Serializer_XML_Element_Text="text",t.Serializer_XML_Element_Location="location",t.Serializer_XML_Element_Attributes="attributes",t.Serializer_XML_Element_Attribute="attribute",t.Serializer_XML_Attribute_ID="id",t.Serializer_XML_Attribute_MeasureType="measuretype",t.Serializer_XML_Attribute_UserID="userid",t.Serializer_XML_Attribute_Created="created",t.Serializer_XML_Attribute_R="r",t.Serializer_XML_Attribute_G="g",t.Serializer_XML_Attribute_B="b",t.Serializer_XML_Attribute_Color="color",t.Serializer_XML_Attribute_X="x",t.Serializer_XML_Attribute_Y="y",t.Serializer_XML_Attribute_Z="z",t.Serializer_XML_Attribute_Value="value",t.Serializer_XML_Attribute_Length="length",t.Serializer_XML_Attribute_Type="type",t.Serializer_XML_Attribute_Key="key",t.Serializer_XML_Attribute_URI="uri",t.Serializer_XML_Attribute_Width="width",t.Serializer_XML_Attribute_Height="height",t.Serializer_XML_Attribute_Name="name",t}();e.MeasureFactory=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var e=t.call(this)||this;return e.InitMeasureDistance(),e}return __extends(n,t),n.prototype.InitMeasureDistance=function(){this.SetType(e.ShapeType.SHAPE_MEASURE_PROPERTY)},n}(e.Measure);e.MeasureProperty=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){}return t.Transform=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length==2)if(t[0]instanceof e.LineAttribute&&t[1]instanceof e.Matrix3x4){var r=t[0],i=t[1],s=i.Multiply(r.GetCenterPoint()).Clone(),o=i.Multiply(new e.Vector4(r.GetDirection(),0)).Clone(),u=i.Multiply(r.GetStartPoint()).Clone(),a=i.Multiply(r.GetEndPoint()).Clone();r.SetCenterPoint(s),r.SetDirection(a.Sub(u).Clone()),r.SetStartPoint(u),r.SetEndPoint(a)}else if(t[0]instanceof e.EllipseAttribute&&t[1]instanceof e.Matrix3x4){var r=t[0],i=t[1],s=i.Multiply(r.GetCenterPoint()).Clone(),u=i.Multiply(r.GetStartPoint()).Clone(),a=i.Multiply(r.GetEndPoint()).Clone(),f=new e.Vector3,l=new e.Vector3,c=new e.Vector3;r.GetXYZDir(f,l,c),f.copyFrom(i.Multiply(new e.Vector4(f,0))),l.copyFrom(i.Multiply(new e.Vector4(l,0))),c.copyFrom(i.Multiply(new e.Vector4(c,0))),r.SetCenterPoint(s),r.SetStartPoint(u),r.SetEndPoint(a),r.SetXYZDir(f,l,c)}else if(t[0]instanceof e.PlaneFaceAttribute&&t[1]instanceof e.Matrix3x4){var r=t[0],i=t[1],h=i.Multiply(new e.Vector4(r.GetNormal(),0)).Clone(),p=r.GetOrigin();r.SetOrigin(i.Multiply(p).Clone()),r.SetNormal(h)}else if(t[0]instanceof e.RevolutionFaceAttribute&&t[1]instanceof e.Matrix3x4){var r=t[0],i=t[1],d=i.Multiply(new e.Vector4(r.GetRevoAxis(),0)).Clone(),v=i.Multiply(r.GetAxisOrigin()).Clone();r.SetAxisOrigin(v),r.SetRevoAxis(d)}else if(t[0]instanceof e.Vector3&&t[1]instanceof e.Matrix3x4){var m=t[0],i=t[1];m.copyFrom(i.Multiply(m).Clone())}},t}();e.GeometryHelper=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){}return t.PntPntDistance=function(e,t){return e.Sub(t).Length()},t.PntLineDistance=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length==5){if(n[1]instanceof e.LineAttribute){var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=new e.Ray(s.GetStartPoint(),s.GetDirection());return a.copyFrom(f.Project(i)),u=0,o=i.Sub(a).Length(),o}if(n[1]instanceof e.Vector3){var l=n[0],c=n[1],h=n[2],p=n[3],d=n[4],v=new e.Vector3;return t.pntInSegment(h,l,c,v),p=h.Sub(v).Length(),d.copyFrom(v),p}}else{if(n.length==7){var i=n[0],m=n[1],o=n[2],u=n[3],a=n[4],g=n[5],y=n[6];u=0;var b=m.GetCenterPoint(),w=m.GetStartPoint(),E=m.GetEndPoint(),S=new e.Vector3,x=new e.Vector3,T=new e.Vector3;m.GetXYZDir(S,x,T);var N=m.GetMajorRadius(),C=new e.Plane(T,b),k=C.Project(i),L=k.Sub(b).Clone(),A=L.Length();if(A>N){e.LOGI("在圆外");var O=y.GetRefLine(),M=O.GetPoints(),_=y.GetDataOffset(),D=y.GetDataLength(),P=!1;for(var H=_;H<_+D;H+=2)P=t.RaySegmentInsect(b,k,M[H],M[H+1]),P&&(a.copyFrom(b.Add(L.Multiply(N*(1/A)))),o=i.Sub(a).Clone().Length());if(!P){var B=k.Sub(w).Clone().Length(),j=k.Sub(E).Clone().Length();B>=j?(o=i.Sub(E).Clone().Length(),a.copyFrom(E)):(o=i.Sub(w).Clone().Length(),a.copyFrom(w))}return o}e.LOGI("在圆内");var O=y.GetRefLine(),M=O.GetPoints(),_=y.GetDataOffset(),D=y.GetDataLength(),P=!1;for(var H=_;H<_+D;H+=2)P=t.RaySegmentInsect(b,k,M[H],M[H+1]),P&&(a.copyFrom(b.Add(L.Multiply(N*(1/A)))),o=i.Sub(a).Clone().Length());if(!P){var B=k.Sub(w).Clone().Length(),j=k.Sub(E).Clone().Length();B>=j?(o=i.Sub(E).Clone().Length(),a.copyFrom(E)):(o=i.Sub(w).Clone().Length(),a.copyFrom(w))}return o}if(n.length==4){var F=n[0],h=n[1],o=n[2],d=n[3],O=F.GetRefLine(),M=O.GetPoints(),_=F.GetDataOffset(),D=F.GetDataLength(),I=1;o=M[_].Sub(h).Clone().Length(),d.copyFrom(M[_]);for(var H=_;H<_+D;H+=2){var q=void 0,R=new e.Vector3,l=M[H],c=M[H+1];q=t.PntLineDistance(l,c,h,q,R),q==undefined&&console.log("sadas"),o>q&&(o=q,d.copyFrom(R))}return o}}},t.RaySegmentInsect=function(n,r,i,s){var o=!0,u,a=r.Sub(n).Clone(),f=s.Sub(i).Clone();if(a.CrossProduct(f).IsZero())return u=!0,!1;u=!1;var l=void 0,c=void 0,h=void 0,p=void 0,d=void 0,v=void 0,m=void 0,g=void 0,y=void 0,b=void 0,w=void 0,E=void 0;l=n.x,c=n.y,h=n.z,p=r.x,d=r.y,v=r.z,m=i.x,g=i.y,y=i.z,b=s.x,w=s.y,E=s.z;var S=void 0,x=void 0,T=void 0,N=void 0,C=void 0,k=void 0;S=p-l,x=d-c,T=v-h,N=b-m,C=w-g,k=E-y;var L=void 0,A=void 0,O=void 0,M=void 0;L=S*x*C-x*x*N-T*T*N+S*T*k,A=S*S*C-S*x*N-x*T*k+T*T*C,O=S*T*N-S*S*k-x*x*k+x*T*C,M=-l*L+c*A-h*O;var _=(A*g-L*m-O*y-M)/(L*N-A*C+O*k),D=new e.Vector3,P=new e.Vector3;D.x=N*_+m,D.y=C*_+g,D.z=k*_+y;var H=new e.Vector3,B=new e.Ray(n,r.Sub(n).Clone().Normalized());H=B.Project(D);var j=D,F=H,I=H.Sub(D).Clone().Length(),q=new e.Vector3,R=t.pntInSegment(j,i,s,q);return R&&j.Sub(F).IsZero()?F.Sub(n).DotProduct(r.Sub(n))>0?!0:!1:!1},t.PntFaceDistance=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length!=6){var i=n[0],G=n[1],o=n[2],Y=n[3],Z=!0,P=new e.Plane(G.GetNormal(),G.GetOrigin());return Y.copyFrom(P.Project(i)),o=Y.Sub(i).Length(),o}if(n[0]instanceof e.Vector3&&n[1]instanceof e.Mesh){var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=s.GetRefMesh(),c=s.GetDataOffset(),h=s.GetDataLength(),p=new Array,d=l.GetPositionArray();for(var v=0;v<d.length;v+=3)p.push(new e.Vector3(d[v],d[v+1],d[v+2]));if(p.length>0){var m=l.GetIndexArray(),g=0,y=0,b=void 0,w=void 0,E=void 0,S=0,x=p[c];a.copyFrom(x),g=i.Sub(x).Clone().Length(),o=g,u=0;for(var v=c;v<c+h;v+=3){var T=void 0,N=void 0,C=void 0,k=void 0,L=p[v],A=p[v+1],O=p[v+2],M=i.Sub(L).Clone().Length(),_=i.Sub(A).Clone().Length(),D=i.Sub(O).Clone().Length();M>_?M>D?(N=v,k=M):(N=v+2,k=D):_>D?(N=v+1,k=_):(N=v+2,k=D),y<k&&(y=k,E=N);var P=new e.Plane(L,A,O),H=P.Project(i),B=new e.Ray(i,H.Sub(i)),j=new e.Vector3;if(i.Sub(H).Clone().IsZero())o=0,a.copyFrom(H);else if(e.RayPickAction.ISintersectRayAndTriangle(L,A,O,B,j)){var F=0;F=i.Sub(j).Clone().Length(),o>F&&(o=F,a.copyFrom(j))}else{var F=void 0,I=new e.Vector3,q=new e.Vector3,R=new e.Vector3,U=new e.Vector3;t.pntInSegment(i,L,A,q),t.pntInSegment(i,L,O,R),t.pntInSegment(i,A,O,U);var z=i.Sub(q).Clone().Length(),W=i.Sub(R).Clone().Length(),X=i.Sub(U).Clone().Length();z<W?z<X?(F=z,I=q):(F=X,I=U):W<X?(F=W,I=R):(F=X,I=U),o>F&&(o=F,a.copyFrom(I))}}e.LOGI("complete "),e.LOGI("maxIndex = %d",E),u=y,f.copyFrom(p[E])}else{var g=0,y=0,x=p[c];a.copyFrom(x),g=i.Sub(x).Clone().Length(),o=g;var C=void 0,k=void 0,V=new e.Vector3,$=new e.Vector3,J=new e.Vector3,K=new e.Vector3,b=void 0;for(var v=c;v<c+h;v+=3){var F=0,L=p[v],A=p[v+1],O=p[v+2],M=i.Sub(L).Clone().Length(),_=i.Sub(A).Clone().Length(),D=i.Sub(O).Clone().Length();M>_?M>D?($=L,k=M):($=O,k=D):_>D?($=A,k=_):($=O,k=D),y<k&&(y=k,K.copyFrom($));var P=new e.Plane(L,A,O),H=P.Project(i),B=new e.Ray(i,H.Sub(i).Clone()),j=new e.Vector3;if(i.Sub(H).IsZero())o=0,a.copyFrom(H);else if(e.RayPickAction.ISintersectRayAndTriangle(L,A,O,B,j))F=i.Sub(j).Clone().Length(),o>F&&(o=F,a.copyFrom(j));else{var Q=void 0,I=new e.Vector3,q=new e.Vector3,R=new e.Vector3,U=new e.Vector3;t.pntInSegment(i,L,A,q),t.pntInSegment(i,L,O,R),t.pntInSegment(i,A,O,U);var z=i.Sub(q).Clone().Length(),W=i.Sub(R).Clone().Length(),X=i.Sub(U).Clone().Length();z<W?z<X?(Q=z,I=q):(Q=X,I=U):W<X?(Q=W,I=R):(Q=X,I=U),o>Q&&(o=Q,a.copyFrom(I))}}u=y,f.copyFrom(K)}return[o,u]}},t.pntInSegment=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length!=4){var r=t[0],h=t[1],u=void 0,a=void 0,p=h.GetStartPoint(),d=h.GetEndPoint();return u=r.Sub(p).Length(),a=r.Sub(d).Length(),u+a>p.Sub(d).Length()?!1:!0}if(t[0]instanceof e.Vector3&&t[1]instanceof e.Vector3&&t[2]instanceof e.Vector3&&t[3]instanceof e.Vector3){var r=t[0],i=t[1],s=t[2],o=t[3],u=void 0,a=void 0,f=s.Sub(i).Clone(),l=new e.Ray(i,f),c=l.Project(r);return u=c.Sub(i).Clone().Length(),a=c.Sub(s).Clone().Length(),u+a>f.Length()?(u>a?o.copyFrom(s):o.copyFrom(i),!1):(o.copyFrom(c),!0)}},t.LineFaceDistance=function(e,n,r,i,s){var o=!0,u=e.GetEndPoint().Sub(e.GetStartPoint()),a=n.GetNormal(),f;return u.DotProduct(a)>=-0.001&&u.DotProduct(a)<=.001?(r=t.PntFaceDistance(e.GetStartPoint(),n,r,i),r=t.PntFaceDistance(e.GetEndPoint(),n,r,s)):o=!1,[o,r]},t.LineLineDistance=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length==6){var r=[],i=t[0],s=t[1],o=t[2],u=t[3],a=t[4],f=t[5],l=i.GetEndPoint().Sub(i.GetStartPoint()).Normalized(),c=s.GetEndPoint().Sub(s.GetStartPoint()).Normalized();if(l.CrossProduct(c).Length()>=-0.001&&l.CrossProduct(c).Length()<=.001){e.LOGI("平行线"),f=!0;var h=new e.Vector3,p=new e.Ray(i.GetStartPoint(),i.GetDirection());h.copyFrom(p.Project(s.GetStartPoint())),o=s.GetStartPoint().Sub(h).Length();var d=i.GetStartPoint().Sub(h).Length(),v=i.GetEndPoint().Sub(h).Length(),m=i.GetLength()-(d+v);u.copyFrom(h),a.copyFrom(s.GetStartPoint())}else{e.LOGI("异面直线或公面相交线"),f=!1;var g=void 0,y=void 0,b=void 0,w=void 0,E=void 0,S=void 0,x=void 0,T=void 0,N=void 0,C=void 0,k=void 0,L=void 0;g=i.GetStartPoint().x,y=i.GetStartPoint().y,b=i.GetStartPoint().z,w=i.GetEndPoint().x,E=i.GetEndPoint().y,S=i.GetEndPoint().z,x=s.GetStartPoint().x,T=s.GetStartPoint().y,N=s.GetStartPoint().z,C=s.GetEndPoint().x,k=s.GetEndPoint().y,L=s.GetEndPoint().z;var A=void 0,O=void 0,M=void 0,_=void 0,D=void 0,P=void 0;A=w-g,O=E-y,M=S-b,_=C-x,D=k-T,P=L-N;var H=void 0,B=void 0,j=void 0,F=void 0;H=A*O*D-O*O*_-M*M*_+A*M*P,B=A*A*D-A*O*_-O*M*P+M*M*D,j=A*M*_-A*A*P-O*O*P+O*M*D,F=-g*H+y*B-b*j;var I=(B*T-H*x-j*N-F)/(H*_-B*D+j*P),q=new e.Vector3,R=new e.Vector3;q.x=_*I+x,q.y=D*I+T,q.z=P*I+N;var U=void 0,z=new e.Ray(i.GetStartPoint(),i.GetDirection());U=z.Project(q),a.copyFrom(q),u.copyFrom(U),o=U.Sub(q).Length()}return r.push(o),r.push(f),r}if(t.length==7){var W=t[0],X=t[1],V=t[2],$=t[3],u=t[4],a=t[5],J=t[6],K=new e.Vector3,Q=new e.Vector3,G=void 0,Y=void 0,Z=new e.Vector3,et=new e.Vector3,tt=new e.Vector3,nt=new e.Vector3,rt=new e.Vector3,it=new e.Vector3,st=new e.Vector3,ot=new e.Vector3;W.GetXYZDir(tt,nt,rt),X.GetXYZDir(it,st,ot),K=W.GetCenterPoint(),Q=X.GetCenterPoint(),G=W.GetMajorRadius(),Y=X.GetMajorRadius(),Z=W.GetStartPoint(),et=X.GetStartPoint(),e.LOGI("radius0 %f radius1 %f ",G,Y);var ut=rt.CrossProduct(ot);if(ut.IsZero())if(K.Sub(Q).IsZero())V=0,$=e.Abs(G-Y),u.copyFrom(Z),a.copyFrom(Q.Add(Z.Sub(K).Multiply(Y).Divide(Z.Sub(K).Length()))),J=2;else{var p=new e.Ray(K,rt),h=p.Project(Q);V=h.Sub(Q).Length(),$=K.Sub(Q).Length(),u.copyFrom(h),a.copyFrom(Q),J=1}else J=0,V=-1,$=K.Sub(Q).Length(),u.copyFrom(K),a.copyFrom(Q);return[V,$,J]}},t.PolylinePolylineDistance=function(n,r,i,s,o,u,a){var f=n.GetRefLine(),l=f.GetPoints(),c=n.GetDataOffset(),h=n.GetDataLength(),p=r.GetRefLine(),d=p.GetPoints(),v=r.GetDataOffset(),m=r.GetDataLength(),g=1e5,y=new e.Vector3,b=new e.Vector3;for(var w=c;w<c+h;w+=2){var E=u.Multiply(l[w]),S=u.Multiply(l[w+1]);for(var x=v;x<v+m;x+=2){var T=0,N=new e.Vector3,C=new e.Vector3,k=a.Multiply(d[x]),L=a.Multiply(d[x+1]);T=t.SegmentSegmentDiatance(E,S,k,L,N,C,T),g>T&&(g=T,y=N,b=C)}}return i.copyFrom(y),s.copyFrom(b),o=g,g},t.FaceFaceDistance=function(t,n,r,i,s){var o=t.GetOrigin(),u=n.GetOrigin(),a=t.GetNormal(),f=n.GetNormal(),l=a.CrossProduct(f);if(l.IsZero()){var c=new e.Plane(a,o),h=new e.Plane(f,u);i.copyFrom(h.Project(o)),s.copyFrom(c.Project(u)),r=i.Sub(o).Length()}else r=-1;return r},t.LineLineAngle=function(e,t,n){return n=e.GetDirection().Angle(t.GetDirection())},t.LineFaceAngle=function(t,n,r){var i=n.GetNormal(),s=t.GetDirection(),o=Math.abs(i.DotProduct(s)/(i.Length()*s.Length()));return r=e.Asin(o)},t.FaceFaceAngle=function(e,t,n){return n=e.GetNormal().Angle(t.GetNormal())},t.faceArea=function(n,r){var i=n.GetRefMesh(),s=n.GetDataOffset(),o=n.GetDataLength(),u=new Array;for(var a=0;a<i.GetPositionArray().length;a+=3)u.push(new e.Vector3(i.GetPositionArray[a],i.GetPositionArray[a+1],i.GetPositionArray[a+2]));if(u.length>0){var f=i.GetIndexArray();for(var a=s;a<s+o;a+=3){var l=u[f[a]],c=u[f[a+1]],h=u[f[a+2]],p=0;t.triangleArea(l,c,h,p),r+=p}}else{var f=i.GetPositionArray();for(var a=s;a<s+o;a+=3){var l=u[a],c=u[a+1],h=u[a+2],p=0;t.triangleArea(l,c,h,p),r+=p}}return!0},t.triangleArea=function(e,t,n,r){var i=t.Sub(e).Clone(),s=n.Sub(e).Clone();return r=i.CrossProduct(s).Length()/2,!0},t.PolyLineLength=function(e,t){var n=e.GetRefLine(),r=n.GetPoints(),i=e.GetDataOffset(),s=e.GetDataLength();t=0;for(var o=i;o<i+s;o+=2){var u=void 0,a=void 0,f=r[o],l=r[o+1];t+=l.Sub(f).Length()}},t.SegmentSegmentDiatance=function(n,r,i,s,o,u,a){var f=new e.LineAttribute,l=new e.LineAttribute;f.SetStartPoint(n),f.SetEndPoint(r),f.SetDirection(r.Sub(n).Clone()),l.SetStartPoint(i),l.SetEndPoint(s),l.SetDirection(s.Sub(i));var c,h=new e.Vector3,p=new e.Vector3,d=!0,v=t.LineLineDistance(f,l,c,h,p,d);c=v[0],d=v[1];var m=n,g=r,y=i,b=s,w,E,S,x,T,N;T=t.pntInSegment(h,f),N=t.pntInSegment(p,l);var C=0,k=new e.Vector3;C=t.PntLineDistance(y,b,m,C,k);var L=0,A=new e.Vector3;L=t.PntLineDistance(y,b,g,L,A);var O=0,M=new e.Vector3;O=t.PntLineDistance(m,g,y,O,M);var _=0,D=new e.Vector3;_=t.PntLineDistance(m,g,b,_,D);var P=0,H=new e.Vector3,B=new e.Vector3;return S=O,x=_,w=C,E=L,S>x?(P=x,H=D,B=b):(P=S,H=M,B=y),P>w&&(P=w,H=k,B=m),P>E&&(P=E,H=g,B=A),a=P,o.copyFrom(H),u.copyFrom(B),a},t}();e.MeasureCalculateHelper=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){}return t.createRectImage=function(t,n,r,i,s,o,u,a,f,l,c,h){e.LOGI("createRectImage shape2DSet %p",t);var p=n.x,d=n.y,v=r.x,m=r.y,g=new e.Color(.45,.45,.45),y=new e.Rect2D;y.setColor(s),y.setStart(n.Clone()),y.setEnd(r.Clone()),t.addShape(y);var b=new e.Texts2D;b.setColor(u);var w=new e.Vector2(p+10,(d+m)/2+c/3);b.setStart(w.Clone()),b.setSize(c),b.setTexts(f),t.addShape(b);var E=new e.Line2D;E.setStart(new e.Vector2(p,d)),E.setEnd(new e.Vector2(p,m)),E.setBlod(4),E.setColor(g),t.addShape(E);var S=new e.Line2D;S.setStart(new e.Vector2(p,d)),S.setEnd(new e.Vector2(v,d)),S.setBlod(4),S.setColor(g),t.addShape(S);if(h){var x=new e.Line2D;x.setStart(new e.Vector2(p,m)),x.setEnd(new e.Vector2(v,m)),x.setBlod(4),x.setColor(g),t.addShape(x)}var T=new e.Line2D;T.setStart(new e.Vector2(v,d)),T.setEnd(new e.Vector2(v,m)),T.setBlod(4),T.setColor(g),t.addShape(T);var N=v,C=d,k=v+i,L=m,A=new e.Rect2D;A.setColor(o),A.setStart(new e.Vector2(N,C)),A.setEnd(new e.Vector2(k,L)),t.addShape(A);var O=new e.Texts2D;O.setColor(a);var M=new e.Vector2(N+10,(C+L)/2+c/3);O.setStart(M),O.setSize(c),O.setTexts(l),t.addShape(O);var _=new e.Line2D;_.setStart(new e.Vector2(N,C)),_.setEnd(new e
.Vector2(N,L)),_.setBlod(4),_.setColor(g),t.addShape(_);var D=new e.Line2D;D.setStart(new e.Vector2(N,C)),D.setEnd(new e.Vector2(k,C)),D.setBlod(4),D.setColor(g),t.addShape(D);if(h){var P=new e.Line2D;P.setStart(new e.Vector2(N,L)),P.setEnd(new e.Vector2(k,L)),P.setBlod(4),P.setColor(g),t.addShape(P)}var H=new e.Line2D;H.setStart(new e.Vector2(k,C)),H.setEnd(new e.Vector2(k,L)),H.setBlod(4),H.setColor(g),t.addShape(H)},t.addImageToMemory=function(t,n,r,i,s,o,u){var a=t.GetGlueObj(),f="",l=function(r){var a=null;r instanceof Blob?a=URL.createObjectURL(r):a=r;var f=e.IDCreator.GetUUID(32,16),l=new e.Vector2(s,o);l=e.ShapeHelper.GetCommonSize(t,l),n=new e.ImageBoard(i,l),n.m_fixShowInScreen=!0;var c=t.GetResourceManager().GetOrCreateTexture(f),h=t.GetResourceManager().GetImage(f);h===null&&(h=t.GetResourceManager().GetOrCreateImage(f,a)),c.AddImage(h),n.SetTexture(c),n.SetCurrentGLContext(t.GetResourceManager().GetRenderContext()),u.AddImage(n)};a.CreateImage(r,l)},t.IsPC=function(){var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=!0;for(var r=0;r<t.length;r++)if(e.indexOf(t[r])>0){n=!1;break}return n},t.createNoteTextsImageN=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f;n.length==6&&(f=n[5]);var l="",c=new e.Shape2DSet,h,p,d;if(o instanceof Array){o.length>=4?o[3].getTexts()==""?l=o[1].getTexts():e.Parameters.Instance().textNoteStyle==0?l=o[1].getTexts():e.Parameters.Instance().textNoteStyle==1&&(l=o[3].getTexts()+"："+o[1].getTexts()):l=o[1].getTexts();var v=o[1].getSize();v<1&&(v=15),v=v*40/15;var m=0,g=l.length,y=m*.6+(g-m)*2,b=(y+1)*v,w=document.createElement("canvas");document.body.appendChild(w);var E=w.getContext("2d");E.font="Bold 40pt "+o[1].getFontName();var S=E.measureText(l);document.body.removeChild(w);var x=new e.Vector2(1,1),T=new e.Vector2(S.width+v,v*3.5+1),N=e.Color.BLACK().Clone(),C=e.Color.GRAY().Clone(),k=e.Color.WHITE().Clone(),L=new e.Color(.15,.15,.15),A=new e.Color(.03,.38,.73),O=4;t.createNoteRectangleImage(c,x,T,A,O,k,L,v,l),h=e.DrawingUtility.getRectF(c),p=h.getWidth()/(t.IsPC()?70:25),d=h.getHeigh()/(t.IsPC()?70:25)}else{var M=n[2],_=0;for(var D in M){var P=16,H=450,C=e.Color.WHITE().Clone(),k=e.Color.WHITE().Clone(),B=e.Color.BLACK().Clone(),N=e.Color.BLACK().Clone(),j=e.Color.GREEN().Clone(),F=e.Color.RED().Clone(),I=e.Color.BLUE().Clone(),q=new e.Vector2(1,1+_*100),R=new e.Vector2(260,100+_*100);t.createRectImage(c,q,R,H,C,k,B,N,D,n[2][D],P,!0),_++}var U=Object.keys(M).length;p=5.5,d=U+2}var z=i.GetGlueObj(),W="";if(z){var X=function(t){var r=null;t instanceof Blob?r=URL.createObjectURL(t):r=t;var o=e.IDCreator.GetUUID(32,16),l=new e.Vector2(p,d);l=e.ShapeHelper.GetCommonSize(i,l),s=new e.ImageBoard(u,l),s.m_fixShowInScreen=!0;var c=i.GetResourceManager().GetOrCreateTexture(o),h=i.GetResourceManager().GetImage(o);h===null&&(h=i.GetResourceManager().GetOrCreateImage(o,r)),c.AddImage(h),s.SetTexture(c),s.SetCurrentGLContext(i.GetResourceManager().GetRenderContext()),n.length==5?(a.imageBoardList.splice(0,1),a.AddImage(s)):a[f]=s};z.CreateImage(c,X)}},t.createNoteRectangleImage=function(t,n,r,i,s,o,u,a,f){var l=n.x,c=n.y,h=r.x,p=r.y,d=s/2,v=new e.Rect2D;v.setColor(o),v.setStart(n),v.setEnd(r),t.addShape(v);var m=new e.Texts2D;m.setColor(u);var g=new e.Vector2(l+a/2,(c+p)/2+a/3);m.setStart(g),m.setSize(a),m.setTexts(f),t.addShape(m);var y=new e.Line2D;y.setBlod(s),y.setStart(new e.Vector2(l+d,c)),y.setEnd(new e.Vector2(l+d,p)),y.setColor(i),t.addShape(y);var b=new e.Line2D;b.setBlod(s),b.setStart(new e.Vector2(l,c+d)),b.setEnd(new e.Vector2(h,c+d)),b.setColor(i),t.addShape(b);var w=new e.Line2D;w.setBlod(s),w.setStart(new e.Vector2(l,p-d)),w.setEnd(new e.Vector2(h,p-d)),w.setColor(i),t.addShape(w);var E=new e.Line2D;E.setBlod(s),E.setStart(new e.Vector2(h-d,c)),E.setEnd(new e.Vector2(h-d,p)),E.setColor(i),t.addShape(E)},t.CreateSequenceNumberImage=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5];if(!s)return null;var f=null,l=s.getTexts(),c=new e.Shape2DSet,h=s.getSize();h<1&&(h=15),h=h*40/15;var p=0,d=l.length,v=p*.6+(d-p)*2,m=(v+1)*h,g=new e.Vector2(1,1),y=new e.Vector2(m,m),b=e.Color.WHITE().Clone(),w=new e.Color(.15,.15,.15),E=new e.Color(.03,.38,.73),S=2,x=g.x+S/2,T=g.y+S/2,N=y.x-S/2,C=y.y-S/2,k=new e.Vector2(x,T),L=new e.Vector2(N,C),A=new e.Ellipse2D;A.setColor(E),A.setStart(k),A.setEnd(L),A.setStrokeWidth(S),A.setIsFill(!1),c.addShape(A);var O=new e.Ellipse2D;O.setColor(b),O.setStart(g),O.setEnd(y),O.setIsFill(!0),A.setStrokeWidth(0),c.addShape(O);var M=new e.Texts2D;M.setColor(w);var _=new e.Vector2((x+N)/2,(T+C)/2+h/3);M.setStart(_),M.setSize(h),M.setTexts(l),M.setAlignCenter(!0),c.addShape(M);var D=r.GetGlueObj(),P="",H=m/40,B=m/40;if(D){var j=function(n){var s=null;n instanceof Blob?s=URL.createObjectURL(n):s=n;var f=e.IDCreator.GetUUID(32,16),l=new e.Vector2(H,B);i=new e.ImageBoard(o,l),i.m_fixShowInScreen=!0;var c=r.GetResourceManager().GetOrCreateTexture(f),h=r.GetResourceManager().GetImage(f);h===null&&(h=r.GetResourceManager().GetOrCreateImage(f,s)),c.AddImage(h),i.SetTexture(c),i.SetCurrentGLContext(r.GetResourceManager().GetRenderContext()),t.length==5?(u.imageBoardList.splice(0,1),u.AddImage(i)):u[a]=i};D.CreateImage(c,j)}},t.SetMeasureUnit=function(t,n,r){switch(t){case 0:r="";break;case 1:r=" mm";break;case 2:r=" cm";for(var i=0;i<n.length;i++)n[i]=n[i]/10;break;case 3:r=" m";for(var i=0;i<n.length;i++)n[i]=n[i]/1e3;break;case 4:r=" in";for(var i=0;i<n.length;i++)n[i]=n[i]/.0393701;break;case 5:r=" ft";for(var i=0;i<n.length;i++)n[i]=n[i]*.0032808;break;default:e.LOGE(" Invalid Unit Flag")}return r},t.CreateAngleMark=function(t,n,r,i,s,o){if(s<1e-6&&s>-0.000001)return;var u=n.Sub(t).Length(),a=i.Sub(r).Length(),f=u>a?a/3:u/3,l=r,c=s/5,h=n.Sub(t).Normalized(),p=i.Sub(r).Normalized(),d=h.CrossProduct(p);d=d.Normalized();var v=h.DotProduct(p),m=l.Add(h.Multiply(f));o.push(m);if(s<90||s>90&&s<180)for(var g=0;g<4;g++){var y=new e.Quaternion(c*(g+1),d);y.Normalize();var b=new e.Quaternion(0,h.x,h.y,h.z),w=y.Multiply(b).Multiply(y.Conjugate()),E=new e.Vector3(w.x,w.y,w.z);E.Normalize();var S=l.Add(E.Multiply(f)).Clone();o.push(S)}else{var x=m.Add(p.Multiply(f)).Clone();o.push(x)}if(s>=0){var T=l.Add(p.Multiply(f)).Clone();o.push(T)}else{var T=l.Sub(p.Multiply(f));o.push(T)}},t}();e.MeasureDisplayHelper=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){this.view=null,this.commandType=-1,this.commandType=e.TYPE}return e.prototype.GetType=function(){return this.commandType},e.prototype.execute=function(){var e=!1;return e=this.OnExecute(),e},e.prototype.OnExecute=function(){return!1},e.prototype.Undo=function(){return!1},e.prototype.Redo=function(){return!1},e.prototype.ToJsonString=function(){return""},e.prototype.GetView=function(){return this.view},e.prototype.SetView=function(e){this.view=e},e.TYPE=0,e}();e.Operation=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(e,r,i){var s=t.call(this)||this;return s.srcPlcPath="",s.destPlcPath="",s.srcModel=null,s.desModel=null,s.newModel=null,s.commandType=n.TYPE,s.view=e,s.srcModel=r,s.desModel=i,s.newModel=null,s}return __extends(n,t),n.prototype.OnExecute=function(){var t=!1;if(this.view){var n=this.srcModel,r=this.desModel;this.newModel=new e.Model;if(n&&r){this.newModel.CopyData(n);var i=this.view.GetSceneManager();t=e.ModelTransformHelper.InsertBefore(this.view,this.newModel,r);if(!t)return this.newModel=null,t;var s=e.ModelTransformHelper.GetPlaceMatrix(n),o=i.GetSceneBox(),u=o.Center().Clone(),a=e.Vector3.LEFT().Clone().Multiply(.8*o.Length()),f=e.M3DTOOLS.Random(10,350),l=new e.Quaternion(f,e.Vector3.UP().Clone());a=l.Multiply(a);var c=new e.Matrix3x4;c.MultiTranslate(a);var h=e.ModelTransformHelper.GetWorldMatrix(r),p=e.ModelTransformHelper.GetWorldMatrix(n);s=h.Inverse().Multiply(c.Multiply(p)),this.newModel.SetOrigPlcMatrix(s),t=!0}else this.newModel=null,t=!1}else t=!1;return t},n.prototype.GetNewMode=function(){return this.newModel},n.prototype.GetDestPlcPath=function(){return this.destPlcPath},n.prototype.GetSrcPlcPath=function(){return this.srcPlcPath},n.TYPE=10,n}(e.Operation);e.CopyModelOperation=t})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.ASSAMBLY_BASE=-1]="ASSAMBLY_BASE",e[e.ASSAMBLY_INS_BEFO_ERR=0]="ASSAMBLY_INS_BEFO_ERR",e[e.ASSAMBLY_INS_AFTR_ERR=1]="ASSAMBLY_INS_AFTR_ERR",e[e.ASSAMBLY_DET_ERR=2]="ASSAMBLY_DET_ERR",e[e.ASSAMBLY_MOVTO_ERR=3]="ASSAMBLY_MOVTO_ERR",e[e.ASSAMBLY_CPYTO_ERR=4]="ASSAMBLY_CPYTO_ERR",e[e.ASSAMBLY_ADD_ERR=5]="ASSAMBLY_ADD_ERR",e[e.ASSAMBLY_DEL_ERR=6]="ASSAMBLY_DEL_ERR",e[e.ASSAMBLY_INS_BEFO_SUCES=20]="ASSAMBLY_INS_BEFO_SUCES",e[e.ASSAMBLY_INS_AFTR_SUCES=21]="ASSAMBLY_INS_AFTR_SUCES",e[e.ASSAMBLY_DET_SUCES=22]="ASSAMBLY_DET_SUCES",e[e.ASSAMBLY_MOVTO_SUCES=23]="ASSAMBLY_MOVTO_SUCES",e[e.ASSAMBLY_CPYTO_SUCES=24]="ASSAMBLY_CPYTO_SUCES",e[e.ASSAMBLY_ADD_SUCES=25]="ASSAMBLY_ADD_SUCES",e[e.ASSAMBLY_DEL_SUCES=26]="ASSAMBLY_DEL_SUCES"})(t=e.AssambleMsg||(e.AssambleMsg={}));var n=function(){function t(e){this.view=null,this.view=e}return t.prototype.Delete=function(t){var n=!1,r=new e.RemoveModelOperation(this.view,t);return n=r.execute(),n},t.prototype.MoveTo=function(t,n){var r=!1,i=new e.MoveModelOperation(this.view,t,n);return r=i.execute(),r},t.prototype.CopyTo=function(t,n){var r=!1,i=new e.CopyModelOperation(this.view,t,n);r=i.execute();var s=i.GetNewMode(),o=[r,s];return o},t.prototype.AddTo=function(t,n,r){var i=!1,s=new e.AddFileOperation(this.view,t,n);return i=s.execute(),r=s.GetNewModel(),i},t.prototype.ReName=function(t,n){var r=!1,i=new e.RenameOperation(this.view,t,n);return r=i.execute(),r},t.prototype.Move=function(t,n){var r=n.split(","),i=this.view.GetModelBySVLPath(t),s=new e.Matrix4(Number(r[0]),Number(r[1]),Number(r[2]),Number(r[3]),Number(r[4]),Number(r[5]),Number(r[6]),Number(r[7]),Number(r[8]),Number(r[9]),Number(r[10]),Number(r[11]),Number(r[12]),Number(r[13]),Number(r[14]),Number(r[15])),o=new e.Matrix3x4(s);e.ModelTransformHelper.SetWorldMatrix(i,o)},t}();e.ModelManager=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){}return t.GetPlaceMatrix=function(t){var n=new e.Matrix3x4;return t,n},t.GetWorldMatrix=function(e){var t;return e&&(t=e.GetWorldTransform().ToMatrix3x4()),t},t.GetPlacePath=function(e){var t="";return e,t},t.SetPlacePath=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length===2&&n[1]instanceof e.Model&&n[0]&&n[1]){var i=t.GetPlacePath(n[1]),s=n[0].GetPlcId(),o=s.toString(16),u=i+"|"+o;t.SetPlacePath(n[0],u);var a=n[0];if(a.GetSubModels().length>0)for(var f=0;f<a.GetSubModels().length;f++)t.SetPlacePath(a.GetSubModels()[f],a)}},t.SetPlaceMatrix=function(e,t){e},t.ComputePlaceMatrix=function(e){},t.SetWorldMatrix=function(e,t){e},t.GetMaxPlcId=function(e){},t.GetModelFromId=function(e,t){},t.InsertBefore=function(e,t,n){var r=!1;if(t&&n){var i=n.GetUseablePlcId();n.AddSubModel(t),t.SetPlcId(i),e.GetSceneManager().AsynUpdateModelCacheInfo(t,!0),e.GetSceneManager().RequestUpdateWhenSceneBoxChanged(),r=!0}else r=!1;return r},t.DetachModel=function(e){var t=!1;if(e){var n=e.GetParent();n&&n.DetachSubModel(e),t=!0}else t=!1;return t},t.DeleteModel=function(e,t){var n=!1;if(t){var r=e.GetSceneManager();n=e.GetSceneManager().AsynRemoveModelFromeScene(t.GetParent(),t),n=!0}else n=!1;return n},t.AddModel=function(t,n){var r=n.GetSceneManager().GetModel(),i=n.GetSceneManager(),s=r.GetSubModelCount()-1,o=r.GetSceneNode().GetParent();if(o&&o instanceof e.ModelNode)var u=o,a=i.CreateModelNodes(t,u.GetName(),s);return t},t.GetParentNode=function(t){var n=null;if(t){var r=t.GetSceneNode().GetParent();if(r){var i=r.GetParent();i&&i instanceof e.ModelNode&&(n=i)}}return n},t.GetModelNode=function(t){var n=null;if(t!==null){var r=t.GetSceneNode().GetParent();r&&r instanceof e.ModelNode&&(n=r)}return n},t.RotateModel=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length===5||n.length===4){var i=n[0],s=n[1],o=n[2]/2,u=n[3],a=n[4];a||(u===e.TRANSAXIS.AXIS_Z?a=new e.Vector3(0,0,1):u===e.TRANSAXIS.AXIS_Y?a=new e.Vector3(0,1,0):u===e.TRANSAXIS.AXIS_X&&(a=new e.Vector3(1,0,0)));var f=new e.Quaternion;f.FromAngleAxis(o,a);var l=new e.Quaternion(i.GetSceneManager().GetCamera().GetView().ToMatrix3());l.Normalize();if(!s)throw Error("'Model' parameter is null");if(s.GetType()!==e.ShapeType.SHAPE_MODEL)throw Error("the shape type of 'Model' must be SHAPE_MODEL");var c=l.Inverse().Multiply(f).Multiply(f);if(u===e.TRANSAXIS.AXIS_FACE)t.RotateModel(s,c);else if(u===e.TRANSAXIS.AXIS_Z){var h=new e.Quaternion(c.w,0,0,c.z);h.Normalize(),t.RotateModel(s,h)}else if(u===e.TRANSAXIS.AXIS_Y){var p=new e.Quaternion(c.w,0,c.y,0);p.Normalize(),t.RotateModel(s,p)}else if(u===e.TRANSAXIS.AXIS_X){var d=new e.Quaternion(c.w,c.x,0,0);d.Normalize(),t.RotateModel(s,d)}}else{var s=n[0],v=n[1];if(!s||!v)throw Error("one of parameters is null");if(s.GetType()!==e.ShapeType.SHAPE_MODEL)throw Error("the shape type of 'Model' must be SHAPE_MODEL");var m=s.GetParent(),g=s.GetWorldTransform(),y=m?m.GetWorldTransform().Clone():new e.Matrix3x4,b=this.GetModelWorldBoundingBox(s).Center(),w=new e.Matrix3x4,E=new e.Matrix3x4,S=new e.Matrix3x4;w.MultiTranslate(b.Nagative()),S.MultiRotatiton(v),E.MultiTranslate(b);var x=E.Multiply(S.Multiply(w)),T=y.Inverse().Multiply(x.Multiply(g));s.SetPlaceMatrix(T)}},t.TranslateModel=function(t,n){if(!t)return;var r=t.GetParent(),i=t.GetWorldTransform(),s=r?r.GetWorldTransform():new e.Matrix3x4,o=new e.Matrix3x4;o.MultiTranslate(n);var u=s.Inverse().Multiply(o.Multiply(i));t.SetPlaceMatrix(u)},t.ScaleModel=function(n,r){var i=n.GetParent(),s=n.GetWorldTransform(),o=i?i.GetWorldTransform():new e.Matrix3x4,u=t.GetModelWorldBoundingBox(n).Center(),a=new e.Matrix3x4,f=new e.Matrix3x4,l=new e.Matrix3x4;a.MultiTranslate(u.Nagative()),l.MultiScale(r),f.MultiTranslate(u);var c=f.Multiply(l).Multiply(a),h=o.Inverse().Multiply(c).Multiply(s);n.SetPlaceMatrix(h)},t.GetModelWorldBoundingBox=function(n){var r=n.GetWorldBoundingBox();r||(r=new e.BoundingBox);if(n.GetSubModelCount()>0)for(var i=0;i<n.GetSubModels().length;i++)r.Merge(t.GetModelWorldBoundingBox(n.GetSubModels()[i]));return r},t}();e.ModelTransformHelper=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(r,i,s){var o=t.call(this)||this;return o.ForwPlcPath="",o.AfterPlcpath="",o.srcModel=null,o.destModel=null,o.srcModel=i,o.destModel=s,o.commandType=n.TYPE,o.ForwPlcPath=e.PathHelper.GetM3DPath(o.srcModel),o.view=r,o}return __extends(n,t),n.prototype.OnExecute=function(){var t=!1;if(this.view){var n=this.srcModel,r=this.destModel;if(n&&r){t=e.ModelTransformHelper.DetachModel(n);if(!t)return t;t=e.ModelTransformHelper.InsertBefore(this.view,n,r);if(!t)return t;this.AfterPlcpath=e.PathHelper.GetM3DPath(r),e.ModelTransformHelper.ComputePlaceMatrix(n)}t=!0}else t=!1;return t},n.prototype.GetForwPlcPath=function(){this.ForwPlcPath},n.prototype.GetAfterPlcPath=function(){this.AfterPlcpath},n.TYPE=11,n}(e.Operation);e.MoveModelOperation=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(e,r){var i=t.call(this)||this;return i.plcPath="",i.model=null,i.commandType=n.TYPE,i.Init(e,r),i}return __extends(n,t),n.prototype.OnExecute=function(){var t=!1;return this.view?this.model?t=e.ModelTransformHelper.DeleteModel(this.view,this.model):t=!1:t=!1,t},n.prototype.ToJsonString=function(){return""},n.prototype.GetPlcPath=function(){},n.prototype.Init=function(t,n){this.plcPath="",this.model=n,this.view=t,this.model&&(this.plcPath=e.PathHelper.GetM3DPath(this.model))},n.TYPE=12,n}(e.Operation);e.RemoveModelOperation=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(e,n,r){var i=t.call(this)||this;return i.desModel=null,i.retModel=null,i.Init(e,n,r),i}return __extends(n,t),n.prototype.Init=function(e,t,n){this.sourceModel=t,this.desModel=n,this.view=e},n.prototype.GetUpperPlcPath=function(){return this.upperPlcPath},n.prototype.GetSourceModel=function(){return this.sourceModel},n.prototype.OnExecute=function(){var t=!1;if(this.view){var n=this.desModel;if(n){this.desModel&&(this.upperPlcPath=e.PathHelper.GetM3DPath(this.desModel)),t=e.ModelTransformHelper.InsertBefore(this.view,this.GetSourceModel(),n);if(!t)return t;t=!0}else t=!1}else t=!1;return t},n.prototype.GetNewModel=function(){return this.retModel},n.TYPE=9,n}(e.Operation);e.AddFileOperation=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(e){function t(t,n,r){var i=e.call(this)||this;return i.model=null,i.lastName="",i.newName="",i.newName=r,i.model=n,i.view=t,i.lastName=n.GetName(),i}return __extends(t,e),t.prototype.OnExecute=function(){var e=!1;return this.view&&(this.model?(this.model.SetName(this.newName),e=!0):e=!1),e},t}(e.Operation);e.RenameOperation=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){}return e}();e.OperationHistoryManager=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){this.isFirstGetProperties=!0,this.placePath=""}return e}();e.ModelExtInfo=t;var n=function(){function e(){this.instanceId=-1,this.partId=-1}return e.prototype.getInstanceId=function(){return this.instanceId},e.prototype.setInstanceId=function(e){this.instanceId=e},e.prototype.getPartId=function(){return this.partId},e.prototype.setPartId=function(e){this.partId=e},e}();e.ModelFileInfo=n;var r=function(n){function r(){var t=n.call(this)||this;return t.worldMatrix=null,t.dirty=!0,t.SubModelArray=[],t.userData=null,t.PlaceID=-1,t.InstanceID=-1,t.plcMatrix=new e.Matrix4,t.ParentModel=null,t.SectionPlaneList=[],t.userPlcId=-1,t.origVisible=!0,t.ModleViewList=[],t.modelShape=null,t.modelFileInfo=null,t.modelExtInfo=null,t.SetType(e.ShapeType.SHAPE_MODEL),t}return __extends(r,n),r.prototype.IsDirty=function(){return this.dirty},r.prototype.MarkDirty=function(){this.dirty=!0,this.OnMarkedDirty(),this.modelShape&&this.modelShape.MarkDirty();for(var e=0;e<this.SubModelArray.length;++e)this.SubModelArray[e].MarkDirty()},r.prototype.OnMarkedDirty=function(){},r.prototype.GetWorldTransform=function(){return this.IsDirty()&&this.UpdateWorldTransform(),this.worldMatrix},r.prototype.UpdateWorldTransform=function(){var e=this.GetLocalTransform();this.ParentModel==null?this.worldMatrix=e:this.worldMatrix=this.ParentModel.GetWorldTransform().Multiply(e),this.dirty=!1},r.prototype.GetTransform=function(){var e=this.GetPlaceMatrix();return e},r.prototype.GetLocalTransform=function(){return this.GetTransform()},r.prototype.UpdateHardWareBuffer=function(e){},r.prototype.SetInitHightlight=function(e){this.modelShape!==null&&this.modelShape.SetInitHightlight(e)},r.prototype.IsHightlight=function(){return!1},r.prototype.GetModelShape=function(){return this.modelShape},r.prototype.SetModelShape=function(e){this.modelShape=e,e&&this.modelShape.SetModel(this)},r.prototype.GetOrigPlcMartirx=function(){return this.modelExtInfo?this.modelExtInfo.origPlcMatrix:null},r.prototype.SetOrigPlcMatrix=function(e){this.modelExtInfo||(this.modelExtInfo=new t),this.modelExtInfo&&(this.modelExtInfo.origPlcMatrix=e,this.SetPlaceMatrix(e.ToMatrix4())),this.MarkDirty()},r.prototype.GetWorldPosition=function(){return this.dirty&&this.UpdateWorldTransform(),this.worldMatrix.Translation()},r.prototype.SetWorldScale=function(e){},r.prototype.SetScale=function(e){},r.prototype.SetWorldRotation=function(e){this.SetRotation(this.ParentModel==null?e:this.ParentModel.GetWorldRotation().Inverse().Multiply(e))},r.prototype.SetRotation=function(t){var n=new e.Vector3,r=t.Clone(),i=new e.Vector3;this.GetPlaceMatrix().Decompose(n,r,i),this.SetTransform(n,t,i)},r.prototype.SetWorldPosition=function(e){this.SetPosition(this.ParentModel==null?e:this.ParentModel.GetWorldTransform().Inverse().Multiply(e))},r.prototype.SetPosition=function(t){var n=new e.Vector3,r=new e.Quaternion,i=new e.Vector3;this.GetPlaceMatrix().Decompose(n,r,i),this.SetTransform(t,r,i)},r.prototype.SetTransform=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length==2)this.SetTransform(t[0],t[1],new e.Vector3(1,1,1)),this.MarkDirty();else if(t.length==3)if(t[2]instanceof e.Vector3){var r=new e.Matrix3x4(t[0],t[1],t[2]);this.SetPlaceMatrix(r.ToMatrix4())}else this.SetTransform(t[0],t[1],new e.Vector3(t[2],t[2],t[2]))},r.prototype.RendreVisible=function(){return this.modelExtInfo,!0},r.prototype.ClearLineData=function(){this.modelShape&&(this.modelShape=null)},r.prototype.AddLineData=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length==2){var r=t[0],i=t[1],s=new e.Body,o=s.GetPolyLine();if(o==null){o=new e.SPolyLine,s.SetPolyLine(o);var u=new e.RefPolyLine(o);u.SetDataOffset(o.GetPoints().length),u.SetDataLength(2*(i.length-1));var a=new e.Edge;a.AddData(u,0),s.AddEdge(a);var f=i.length;if(f>=2){o.AddPoint(r[0]);for(var l=1;l<f-1;l++)o.AddPoint(r[i[l]]),o.AddPoint(r[i[l]]);o.AddPoint(r[f-1])}}this.AddBody(s)}else{var r=t[0],s=new e.Body,o=s.GetPolyLine();if(o==null){o=new e.SPolyLine,s.SetPolyLine(o);var u=new e.RefPolyLine(o);u.SetDataOffset(o.GetPoints().length),u.SetDataLength(2*(r.length-1));var a=new e.Edge;a.AddData(u,0),s.AddEdge(a);var f=r.length;if(f>=2){o.AddPoint(r[0]);for(var l=1;l<f-1;l++)o.AddPoint(r[l]),o.AddPoint(r[l]);o.AddPoint(r[f-1])}}this.AddBody(s)}},r.prototype.GetWorldRotation=function(){return this.dirty&&this.UpdateWorldTransform(),this.worldMatrix.Rotation()},r.prototype.GetExtendInfoManager=function(){return this.extInfoMgr},r.prototype.SetModelExtInfo=function(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];if(e.length==1){var r=e[0];if(!this.extInfoMgr||this.extInfoMgr!=e[0])this.extInfoMgr=r,this.modelExtInfo||(this.modelExtInfo=new t),this.modelExtInfo.origVisible=this.IsVisible(),this.modelExtInfo.origPlcMatrix=this.plcMatrix.ToMatrix3x4(),this.SetModelExtInfo()}else if(e.length==2){var r=e[0],i=e[1];this.SetModelExtInfo(e[0]);if(i)for(var s=0;s<this.SubModelArray.length;s++)this.SubModelArray[s].SetModelExtInfo(r,i)}else{var o=this.GetBodys();if(o)for(var u=0;u<o.length;u++){var a=o[u];a&&a.SetBodyExtInfo()}}},r.prototype.getModelFileInfo=function(){return this.modelFileInfo},r.prototype.setModelFileInfo=function(e){this.modelFileInfo=e},r.prototype.AddBody=function(t){this.modelShape===null&&(this.modelShape=new e.ModelShape,this.modelShape.SetModel(this)),this.modelShape!==null&&this.modelShape.AddBody(t)},r.prototype.GetPlcPath=function(){return this.modelExtInfo?this.modelExtInfo.placePath.length>0?this.modelExtInfo.placePath:(this.ParentModel?this.SetPlcPath(this.ParentModel.GetPlcPath()+"|"+this.PlaceID.toString(16)):this.SetPlcPath(e.MAINMODELROOT+"|0"),this.GetPlcPath()):e.MAINMODELROOT},r.prototype.SetPlcPath=function(e){this.modelExtInfo||(this.modelExtInfo=new t),this.modelExtInfo.placePath=e},r.prototype.GetInstatnceID=function(){return this.InstanceID},r.prototype.SetInstanceID=function(e){this.InstanceID=e},r.prototype.AddSubModel=function(e){e!==null&&e instanceof r&&(this.SubModelArray.push(e),e.SetParent(this))},r.prototype.GetModelById=function(e){var t=null;if(this.GetID()===e)return this;for(var n=0,r=this.SubModelArray;n<r.length;n++){var i=r[n];t=i.GetModelById(e);if(t!=null)return t}return null},r.prototype.GetSubModels=function(){return this.SubModelArray},r.prototype.GetAllSubModels=function(e){for(var t=0;t<this.SubModelArray.length;t++){var n=this.SubModelArray[t];e.push(n),n.GetAllSubModels(e)}},r.prototype.RemoveSubModel=function(e){for(var t=0;t<this.SubModelArray.length;t++)if(this.SubModelArray[t]===e){this.SubModelArray.splice(t,1);return}},r.prototype.GetSubModelCount=function(){return this.SubModelArray.length},r.prototype.SetPlaceMatrix=function(e){this.plcMatrix.copyFrom(e),this.MarkDirty()},r.prototype.GetPlaceMatrix=function(){return this.plcMatrix},r.prototype.GetParent=function(){return this.ParentModel},r.prototype.SetParent=function(e){this.ParentModel=e},r.prototype.InsertChild=function(e,t){t>=this.SubModelArray.length||t<0},r.prototype.Clear=function(){},r.prototype.SetPlcId=function(e){this.PlaceID=e},r.prototype.GetPlcId=function(){return this.PlaceID},r.prototype.SetProtoTypeId=function(e){this.ProtoTypeID=e},r.prototype.GetProtoTypeId=function(){return this.ProtoTypeID},r.prototype.CopyData=function(t){if(t.GetSubModelCount()>0){var n=t.GetSubModels();for(var i=0;i<n.length;i++){var s=new r;s.CopyData(n[i]),this.AddSubModel(s)}}if(t.modelShape!==null)for(var o=0;o<t.GetBodys().length;o++){var u=new e.Body;u.AssignOperator(t.GetBodys()[o]),this.AddBody(u)}this.SetName(t.GetName()),this.SetPlaceMatrix(t.GetPlaceMatrix()),this.SetPlcId(t.GetPlcId()),this.SetProtoTypeId(t.GetProtoTypeId()),t.GetOrigPlcMartirx()&&this.SetOrigPlcMatrix(t.GetOrigPlcMartirx())},r.prototype.CopyRenderData=function(t){if(t.modelShape!==null)for(var n=0;n<t.GetBodys().length;n++){var r=new e.Body;r.AssignOperator(t.GetBodys()[n]),this.AddBody(r)}},r.prototype.FindVisiableObject=function(e){if(!this.IsVisible())return;this.modelShape!==null&&this.modelShape.FindVisiableObject(e);for(var t=0;t<this.SubModelArray.length;++t)this.SubModelArray[t].FindVisiableObject(e)},r.prototype.RayPick=function(e){if(!this.Visible||!this.selectAble)return;this.modelShape!==null&&this.modelShape.RayPick(e);for(var t=0;t<this.SubModelArray.length;++t)this.SubModelArray[t].RayPick(e)},r.prototype.SetSelected=function(e){n.prototype.SetSelected.call(this,e),this.modelShape!==null&&this.modelShape.SetSelected(e);for(var t=0;t<this.SubModelArray.length;t++){var r=this.SubModelArray[t];null!==r&&r.SetSelected(e)}},r.prototype.SetSelectAble=function(t,r){r===void 0&&(r=!1),n.prototype.SetSelectAble.call(this,t),this.modelShape===null&&(this.modelShape=new e.ModelShape,this.modelShape.SetModel(this)),this.modelShape.SetSelectAble(t);if(r)for(var i=0;i<this.SubModelArray.length;i++)this.SubModelArray[i].SetSelectAble(t,r)},r.prototype.SetVisible=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];if(e.length===1)this.SetVisible(e[0],!0);else{n.prototype.SetVisible.call(this,e[0]),this.modelShape&&this.modelShape.SetVisible(e[0]);if(e[1])for(var r=0;r<this.SubModelArray.length;r++)this.SubModelArray[r].SetVisible(e[0],e[1])}},r.prototype.ComputeBox=function(){this.modelShape!==null&&this.modelShape.ComputeBox()},r.prototype.ResetAlpha=function(){n.prototype.ResetAlpha.call(this),this.modelShape!==null&&this.modelShape.ResetAlpha();for(var e=0;e<this.SubModelArray.length;e++)this.SubModelArray[e].ResetAlpha()},r.prototype.ResetColor=function(){n.prototype.ResetColor.call(this),this.modelShape!==null&&this.modelShape.ResetColor();for(var e=0;e<this.SubModelArray.length;e++)this.SubModelArray[e].ResetColor()},r.prototype.SetFaceMaterial=function(e){for(var t=0;t<this.GetBodys().length;t++){var n=this.GetBodys()[t];for(var r=0;r<n.GetFaces().length;r++)n.GetFaces()[r].SetMaterial(e)}for(var t=0;t<this.SubModelArray.length;t++)this.SubModelArray[t].SetFaceMaterial(e)},r.prototype.SetInitColor=function(e){this.modelShape!==null&&this.modelShape.SetInitColor(e);for(var t=0;t<this.SubModelArray.length;t++)this.SubModelArray[t].SetInitColor(e);this.Color=e.Clone()},r.prototype.GetTotalWorldBoundingBox=function(){var t=[];this.GetAllSubModels(t);var n=new e.BoundingBox;for(var r=0;r<t.length;r++){var i=t[r];i.GetWorldBoundingBox()&&i.GetWorldBoundingBox().Defined()&&n.Merge(i.GetWorldBoundingBox())}return this.GetWorldBoundingBox()&&this.GetWorldBoundingBox().Defined()&&n.Merge(this.GetWorldBoundingBox()),n},r.prototype.GetTotalBoundingBox=function(){var t=[];this.GetAllSubModels(t);var n=new e.BoundingBox;for(var r=0;r<t.length;r++){var i=t[r];i.GetBoundingBox().Defined()&&n.Merge(i.GetBoundingBox())}return this.GetBoundingBox().Defined()&&n.Merge(this.GetBoundingBox()),n},r.prototype.GetBoundingBox=function(){return this.modelShape?this.modelShape.GetBoundingBox():e.BoundingBox.NO_BOX()},r.prototype.SetColor=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];if(e.length===1)this.SetColor(e[0],!0);else{this.Color=e[0].Clone(),this.modelShape!==null&&this.modelShape.SetColor(this.Color);if(e[1])for(var n=0;n<this.SubModelArray.length;n++)this.SubModelArray[n].SetColor(e[0])}},r.prototype.SetAlpha=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];if(e.length===1)this.SetAlpha(e[0],!0);else{this.Color.a=e[0],this.modelShape!==null&&this.modelShape.SetAlpha(this.Color.a);if(e[1])for(var n=0;n<this.SubModelArray.length;n++)this.SubModelArray[n].SetAlpha(e[0],!0)}},r.prototype.GetColor=function(){return n.prototype.GetColor.call(this).Clone()},r.prototype.GetDrawColor=function(){return n.prototype.GetDrawColor.call(this).Clone()},r.prototype.GetAlpha=function(){return this.Color.a},r.prototype.GetSceneNode=function(){return this.node},r.prototype.SetOrigVisible=function(e){this.origVisible=e,this.SetVisible(e)},r.prototype.IsOrigVisible=function(){return this.origVisible},r.prototype.Restore=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];if(e.length===1){if(e[0])for(var n=0;n<this.SubModelArray.length;n++)this.SubModelArray[n].Restore();this.Restore()}else this.modelShape!==null&&this.modelShape.Restore(),this.ResetColor(),this.SetVisible(this.IsOrigVisible()),this.SetSelected(!1),this.GetPlaceMatrix().Equals(this.GetOrigPlcMartirx().ToMatrix4())||this.SetPlaceMatrix(this.GetOrigPlcMartirx().ToMatrix4())},r.prototype.ResetMovement=function(){this.GetOrigPlcMartirx()&&(this.plcMatrix=this.GetOrigPlcMartirx().ToMatrix4()),this.MarkDirty()},r.prototype.GetSVLPath=function(){return e.AnimationHelper.AniDecPathToM3DHexPath(this.GetPlcPath())},r.prototype.GetUserSVLPath=function(){var e=this.GetSVLPath();return e.substring(e.indexOf("PATH"))},r.prototype.GetWorldBoundingBox=function(){return this.modelShape!==null?this.modelShape.GetWorldBoundingBox():null},r.prototype.SetBox=function(t){this.modelShape===null&&(this.modelShape=new e.ModelShape,this.modelShape.SetModel(this)),this.modelShape.SetBoundingBox(t)},r.prototype.SetDrawDataPrepared=function(e){this.modelShape!==null&&this.modelShape.SetDrawDataPrepared(e)},r.prototype.Traverse=function(e){if(e.IsFinish())return;e.Apply(this);for(var t=0;t<this.SubModelArray.length;++t)this.SubModelArray[t].Traverse(e)},r.prototype.GetUseablePlcId=function(){for(var e=0;e<this.SubModelArray.length;e++){var t=this.SubModelArray[e].GetPlcId();this.userPlcId<t&&(this.userPlcId=t)}return this.userPlcId++,this.userPlcId},r.prototype.GetBodys=function(){return this.modelShape!==null?this.modelShape.GetBodys():[]},r.prototype.DetachSubModel=function(e){for(var t=0;t<this.SubModelArray.length;t++)if(this.SubModelArray[t]===e){e.SetParent(null),this.SubModelArray.splice(t,1),e=null;break}},r.prototype.GetSectionPlaneList=function(){return this.extInfoMgr?this.extInfoMgr.GetModelSectionPlane(this.Id):this.SectionPlaneList},r.prototype.AddSectionPlane=function(t){var n=!1,r=this.extInfoMgr.GetModelSectionPlane(this.Id),i;if(r)for(var s=0,o=r;s<o.length;s++){var u=o[s];if(u.GetID()===t.GetID()){i=u,n=!0;break}}else{var a=[];a.push(new e.SectionPlane),this.extInfoMgr.AddModelSectionPlane(this.Id,a),r=this.extInfoMgr.GetModelSectionPlane(this.Id)}if(n){var f=r.indexOf(i);r.splice(f,1)}r.push(t)},r.prototype.GetSectionPlane=function(e){var t=null,n=this.GetSectionPlaneList();if(n)for(var r=0;r<n.length;r++)if(n[r].GetID()===e){t=n[r];break}return t},r.prototype.GetModelViewList=function(){return this.ModleViewList},r.prototype.GetModleViews=function(e,t){if(this.ModleViewList.length!==0)for(var n=0;n<this.ModleViewList.length;n++)e.push(this.ModleViewList[n].GetID()),t.push(this.ModleViewList[n].GetName())},r.prototype.SetModleViewList=function(e){this.ModleViewList=e},r.prototype.GetModleView=function(e){var t=null;if(this.ModleViewList.length)for(var n=0;n<this.ModleViewList.length;n++)if(this.ModleViewList[n].GetID()==e){t=this.ModleViewList[n];break}return t},r.prototype.AddModelView=function(t){var n=!1,r=0;if(this.ModleViewList.length)for(var i=0;i<this.ModleViewList.length;i++)if(this.ModleViewList[i].GetID()===t.GetID()){console.log("Exist View Id is ===== "+this.ModleViewList[i].GetID()),n=!0,r=i;break}n&&(e.LOGI("Model::addModelView: error：Id已经存在！将替换。"),this.ModleViewList[r]=t),this.ModleViewList.push(t)},r.prototype.RemoveModelView=function(e){if(this.ModleViewList.length)for(var t=0;t<this.ModleViewList.length;t++)if(this.ModleViewList[t].GetID()===e){this.ModleViewList.splice(t,1);break}},r.prototype.GetVertexCount=function(e){var t=0;for(var n=0;n<this.GetBodys().length;n++)t+=this.GetBodys()[n].GetVertexCount(e);for(var n=0;n<this.GetSubModels().length;n++)t+=this.GetSubModels()[n].GetVertexCount
(e);return t},r.prototype.InitProperties=function(){var e="名称",t="ID",n="PlaceID",r="ProtoTypeID",i="颜色",s="子模型数量",o="实例数量",u="视图数量",a="PMI数量",f="LOD0面片数量",l="LOD1PatchNumber";this.AddProperty(e,this.Name),this.AddProperty(t,String(this.Id)),this.AddProperty(n,String(this.PlaceID)),this.AddProperty(r,String(this.ProtoTypeID));var c=String(this.Color.r)+","+String(this.Color.g)+","+String(this.Color.b)+","+String(this.Color.a);this.AddProperty(i,c),this.AddProperty(s,String(this.SubModelArray.length)),this.AddProperty(o,String(this.GetInstanceCount())),this.AddProperty(u,String(this.GetModelViewList().length));if(this.extInfoMgr){var h=this.extInfoMgr.GetModelPMIRef(this.GetProtoTypeId());h!=null&&this.AddProperty(a,String(h.length))}this.AddProperty(f,String(this.GetVertexCount(0)/3));var p=this.GetExtendInfoManager().GetModelFileAttribute(this.GetProtoTypeId());for(var d in p)this.AddProperty(d,p[d])},r.prototype.GetInstanceCount=function(){var e=this.SubModelArray.length;for(var t in this.SubModelArray)e+=this.SubModelArray[t].GetInstanceCount();return e},r.prototype.FramePick=function(e){if(!this.IsVisible()||!e.CanPickShape(this.GetType()))return;e.FrustumIntersetWithWorldBox(this.GetWorldBoundingBox())&&e.AddToFramePickCollection(this)},r.prototype.GetUserData=function(){return this.userData},r.prototype.SetUserData=function(e){this.userData=e},r}(e.Shape);e.Model=r;var i=function(t){function n(){return t.call(this)||this}return __extends(n,t),n.prototype.GetType=function(){return e.ShapeType.IMAGEMODEL_SHAPE},n.prototype.SetImage=function(e){this.CreateModelShape();var t=this.GetImageModelShape();t&&t.SetImage(e)},n.prototype.SetImagePath=function(e){this.CreateModelShape();var t=this.GetImageModelShape();t&&t.SetImagePath(e)},n.prototype.SetImageData=function(e,t){this.CreateModelShape();var n=this.GetImageModelShape();n&&n.SetImageData(e,t)},n.prototype.SetImageSize=function(e,t){if(this.modelShape){var n=this.modelShape;n.SetImageSize(e,t)}},n.prototype.SetImagePosition=function(e){if(this.modelShape){var t=this.modelShape;t.SetImagePosition(e)}},n.prototype.SetImageGPUID=function(e){this.CreateModelShape();if(this.modelShape){var t=this.modelShape;t.SetImageGPUID(e)}},n.prototype.SetFlipImage=function(e){this.CreateModelShape();if(this.modelShape){var t=this.modelShape;t.SetFlipImage(e)}},n.prototype.SetAllowScall=function(e){if(this.modelShape){var t=this.modelShape;t.SetAllowScall(e)}},n.prototype.SetAllowRotate=function(e){if(this.modelShape){var t=this.modelShape;t.SetAllowRotate(e)}},n.prototype.SetInTopShow=function(e){if(this.modelShape){var t=this.modelShape;t.SetInTopShow(e)}},n.prototype.SetAllowTran=function(e){if(this.modelShape){var t=this.modelShape;t.SetAllowTran(e)}},n.prototype.GetImageModelShape=function(){return this.modelShape},n.prototype.CreateModelShape=function(){this.modelShape==null&&(this.modelShape=new e.ImageModelShape,this.modelShape.SetModel(this))},n}(r);e.ImageModel=i;var s=function(e){function t(){var t=e.call(this)||this;return t.SetSimpleSignModel(null),t.SetAllSignModel(null),t.SetNeedUpdataSign(!1),t.m_showSimpleSign=!1,t.m_ShowAllSign=!1,t}return __extends(t,e),t.prototype.GetShowSimpleSign=function(){return this.m_showSimpleSign},t.prototype.SetShowSimpleSign=function(e){this.m_showSimpleSign=e,this.m_allSignModel&&this.m_allSignModel.SetVisible(e)},t.prototype.GetShowAllSign=function(){return this.m_ShowAllSign},t.prototype.SetShowAllSign=function(e){this.m_ShowAllSign=e,this.m_allSignModel&&this.m_allSignModel.SetVisible(e)},t.prototype.OnMarkedDirty=function(){this.SetNeedUpdataSign(!0)},t.prototype.GetNeedUpdataSign=function(){return this.m_needUpdataSign},t.prototype.SetNeedUpdataSign=function(e){this.m_needUpdataSign=e},t.prototype.GetSimpleSignModel=function(){return this.m_simpleSignModel},t.prototype.SetSimpleSignModel=function(e){this.m_simpleSignModel=e},t.prototype.GetAllSignModel=function(){return this.m_allSignModel},t.prototype.SetAllSignModel=function(e){this.m_allSignModel=e},t}(r);e.SignModel=s})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.LightType_Base=0]="LightType_Base",e[e.LightType_Ambient=1]="LightType_Ambient",e[e.LightType_Directional=2]="LightType_Directional",e[e.LightType_Point=3]="LightType_Point",e[e.LightType_Spot=4]="LightType_Spot",e[e.LightType_Hemisphere=5]="LightType_Hemisphere"})(t=e.LightType||(e.LightType={}));var n=function(t){function n(){var n=t.call(this)||this;return n.renderWorldMatrix=null,n.vertexOffset=0,n.hardwareVertexBuffer=null,n.texCoodrsOffset=0,n.m_lightColor=new e.Color(1,1,1),n.m_intensity=1,n.m_direction=new e.Vector3(0,0,1),n.m_castShadow=!1,n.m_allSignModel=null,n.m_simpleSignModel=null,n.m_needUpdateInfo=!0,n.m_isTurnOn=!0,n}return __extends(n,t),n.prototype.GetLightShadow=function(){return null},n.prototype.GetNodeWorldPosition=function(){var t=new e.Vector3;return t=this.GetWorldPosition(),t},n.prototype.IsInWorld=function(){return this.m_isInWorld},n.prototype.SetIsInWorld=function(e){this.m_isInWorld=e},n.prototype.SetIsTurnOn=function(e){this.m_isTurnOn=e},n.prototype.IsTurnOn=function(){return this.m_isTurnOn},n.prototype.SetNodeWorldPosition=function(e){this.SetWorldPosition(e)},n.prototype.GetWorldDirection=function(){return this.GetWorldRotation().Multiply(this.m_direction)},n.prototype.RayPick=function(e){if(!this.IsVisible()||!this.RendreVisible())return;e.BeginPickAsGroup(this),t.prototype.RayPick.call(this,e),e.EndPickAsGroup(this,1)},n.prototype.FramePick=function(e){if(!this.IsVisible()||!this.RendreVisible())return},n.prototype.SetUpHelperData=function(){},n.prototype.GetLightSourceType=function(){return this.m_lightType},n.prototype.SetLightSourceType=function(e){this.m_lightType=e},n.prototype.GetLightColor=function(){return this.m_lightColor},n.prototype.SetLightColor=function(e){this.m_lightColor=e},n.prototype.GetIntensity=function(){return this.m_intensity},n.prototype.SetIntensity=function(e){this.m_intensity=e},n.prototype.SetCastShadow=function(e){this.m_castShadow=e},n.prototype.CastShadow=function(){return this.m_castShadow},n.prototype.NeedUpdateInfo=function(){return this.m_needUpdateInfo},n.prototype.SetNeedUpdateInfo=function(e){this.m_needUpdateInfo=e},n.prototype.GetType=function(){return e.ShapeType.SHAPE_LIGHT_BASE},n.prototype.SetRenderWorldMatrix=function(e){this.renderWorldMatrix=e.Clone()},n.prototype.GetRenderWorldMatrix=function(){return this.renderWorldMatrix},n.prototype.GetRenderColor=function(){var t=e.Color.WHITE().Clone();return this.IsSelected()?e.Color.SelectColor().Clone():t},n.prototype.GetRenderMaterial=function(){return new e.Material},n.prototype.SetRenderMesh=function(e){},n.prototype.GetDataLength=function(){return-1},n.prototype.IsUseIndex=function(){return!1},n.prototype.SetIndexOffset=function(e){},n.prototype.GetIndexOffset=function(){return-1},n.prototype.SetNormalOffset=function(e){},n.prototype.GetNormalOffset=function(){return-1},n.prototype.SetVertexOffset=function(e){this.vertexOffset=e},n.prototype.GetVertexOffset=function(){return this.vertexOffset},n.prototype.SetTextureCoordsOffset=function(e){this.texCoodrsOffset=e},n.prototype.GetTextureCoordsOffset=function(){return this.texCoodrsOffset},n.prototype.SetCentersCoordsOffset=function(e){},n.prototype.GetCentersCoordsOffset=function(){return-1},n.prototype.GetHardWareVertexBuffer=function(){return null},n.prototype.GetHardWareIndexBuffer=function(){return null},n}(e.SignModel);e.BaseLight=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n.m_lightColor=new e.Color(1,1,1),n.m_lightType=e.LightType.LightType_Ambient,n}return __extends(n,t),n}(e.BaseLight);e.AmbientLight=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){this.resourceManager=null,this.Init()}return e.prototype.setResourceManager=function(e){this.resourceManager=e},e.prototype.Init=function(){this.setResourceManager(null),this.SetSvlId(-1)},e.prototype.SetSvlId=function(e){this.m_svlId=e},e.prototype.GetSvlId=function(){return this.m_svlId},e}();e.Resource=t})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.MaterialType_Base=0]="MaterialType_Base",e[e.MaterialType_Phong=1]="MaterialType_Phong",e[e.MaterialType_Pbr=2]="MaterialType_Pbr",e[e.MaterialType_Shader=3]="MaterialType_Shader",e[e.MaterialType_MatCap=4]="MaterialType_MatCap",e[e.MaterialType_Inner=5]="MaterialType_Inner",e[e.MaterialType_Depth=6]="MaterialType_Depth"})(t=e.MaterialType||(e.MaterialType={}));var n;(function(e){e[e.CubeReflectionMapping=0]="CubeReflectionMapping",e[e.CubeRefractionMapping=1]="CubeRefractionMapping",e[e.EquirectangularReflectionMapping=2]="EquirectangularReflectionMapping",e[e.EquirectangularRefractionMapping=3]="EquirectangularRefractionMapping",e[e.SphericalReflectionMapping=4]="SphericalReflectionMapping",e[e.CubeUVReflectionMapping=5]="CubeUVReflectionMapping",e[e.CubeUVRefractionMapping=6]="CubeUVRefractionMapping"})(n=e.EnvTextureMappingType||(e.EnvTextureMappingType={}));var r=function(n){function r(){var r=n.call(this)||this;return r.m_uniformPatameters={},r.m_materialType=t.MaterialType_Base,r.m_useLight=!0,r.m_uuid=e.IDCreator.GetUUID(),r.m_program=null,r.m_needUpdate=!0,r.m_define={},r.m_lightHash="",r.needsUpdateUniformParameters=!0,r}return __extends(r,n),r.prototype.GetMaterialTypeStr=function(e){return e==t.MaterialType_Phong?"PhongMaterial":e==t.MaterialType_Pbr?"PbrMaterial":t.MaterialType_Depth?"DepthMaterial":t.MaterialType_MatCap?"MatCapMaterial":"ShaderMaterial"},r.prototype.SetName=function(e){this.m_name=e},r.prototype.GetName=function(){return this.m_name},r.prototype.GetMaterialType=function(){return this.m_materialType},r.prototype.SetMaterialType=function(e){this.m_materialType=e},r.prototype.SetUniformParameter=function(e,t){var n=!1;if(this.m_uniformPatameters[e]===null||this.m_uniformPatameters[e]===undefined)this.m_uniformPatameters[e]=t,n=!0;return n},r.prototype.GetUniformParameter=function(e){return this.m_uniformPatameters[e]!==null||this.m_uniformPatameters[e]!==undefined?this.m_uniformPatameters[e]:null},r.prototype.GetUnifomParameters=function(){return this.m_uniformPatameters},r.prototype.GetNeedsUpdateUniformParamerers=function(){return this.needsUpdateUniformParameters},r.prototype.SetNeedsUpdateUniformParamerers=function(e){this.needsUpdateUniformParameters=e},r.prototype.GetUseLight=function(){return this.m_useLight},r.prototype.SetUseLight=function(e){this.m_useLight=e},r.prototype.NeedUpdate=function(){return this.m_needUpdate},r.prototype.SetNeedUpdate=function(e){this.m_needUpdate=e},r.prototype.GetProgram=function(){return this.m_program},r.prototype.SetProgram=function(e){this.m_program=e},r.prototype.Uuid=function(){return this.m_uuid},r.prototype.Define=function(){return this.m_define},r.prototype.SetDefine=function(e,t){this.m_define[e]=t},r.prototype.LightHash=function(){return this.m_lightHash},r.prototype.SetDisplayName=function(e){this.m_displayName=e},r.prototype.GetDisplayName=function(){return this.m_displayName},r.prototype.SetLightHash=function(e){this.m_lightHash=e},r.prototype.GetLightHash=function(){return this.m_lightHash},r.prototype.Rename=function(e){},r.prototype.IsGammaOutpute=function(){return this.m_isGammaOutpute},r.prototype.SetIsGammaOutpute=function(e){this.m_isGammaOutpute=e},r.prototype.SetAcceptLight=function(e){this.m_acceptLight=e},r.prototype.AcceptLight=function(){return this.m_acceptLight},r}(e.Resource);e.BaseMaterial=r})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){this.worldMatrix=new e.Matrix3x4,this.glWorldMatrix=new e.Matrix4,this.center=new e.Vector3,this.AllowRotate(!1),this.AllowTran(!0),this.AllowScale(!1)}return t.prototype.GetWorldMatrix=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length===0)return this.worldMatrix;if(t.length===1&&t[0]instanceof e.RenderAction){this.worldMatrix=e.Matrix3x4.IDENTITY().Clone();if(this.GetScale()&&this.GetRotate()&&this.IsAllowTran())return this.worldMatrix;var r=t[0].GetWorldMatrix(),i=t[0].GetCamera(),s=i.GetView().Multiply(r).Inverse();this.worldMatrix.MultiTranslate(this.center);if(!this.GetScale()){var o=1;if(!i.IsOrthographic()){var u=i.GetWorldPosition().Clone(),a=i.GetOrthoSize().y,f=u.Sub(this.GetCenter()).Length();o=f*1.2/a;var l=1;l=i.GetViewPort().GetRect().Height();if(l=i.GetViewPort().GetRect().Width())l=i.GetViewPort().GetRect().Width();i.GetViewPort().GetRect().Height()>i.GetViewPort().GetRect().Width()?l=i.GetViewPort().GetRect().Width()/l:l=i.GetViewPort().GetRect().Height()/l,this.worldMatrix.MultiScale(o*l/i.GetZoom())}else this.worldMatrix.MultiScale(o/i.GetZoom())}if(!this.GetRotate()){var c=s.Rotation().Clone();this.worldMatrix.MultiRotatiton(c)}return this.IsAllowTran()||this.worldMatrix.MultiTranslate(s.Translation().Nagative()),this.worldMatrix.MultiTranslate(this.center.Nagative()),this.worldMatrix}},t.prototype.GetGLWorldMatrix=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length===0)return this.glWorldMatrix;if(t.length===1&&t[0]instanceof e.RenderAction)return this.glWorldMatrix=this.GetWorldMatrix(t[0]).ToMatrix4().Transpose(),this.glWorldMatrix},t.prototype.AllowTran=function(e){this.allowTran=e},t.prototype.AllowRotate=function(e){this.allowRotate=e},t.prototype.AllowScale=function(e){this.allowScale=e},t.prototype.IsAllowTran=function(){return this.allowTran},t.prototype.GetRotate=function(){return this.allowRotate},t.prototype.GetScale=function(){return this.allowScale},t.prototype.SetCenter=function(e){this.center=e.Clone()},t.prototype.GetCenter=function(){return this.center},t.GetFitShowScale=function(e,t){var n=1,r=e.GetCamera();if(!r.IsOrthographic()){var i=r.GetWorldPosition(),s=r.GetOrthoSize().y,o=i.Sub(t).Length();n=o*2/s}var u=1;u=r.GetViewPort().GetRect().Height(),u<r.GetViewPort().GetRect().Width()&&(u=r.GetViewPort().GetRect().Width());var a=r.GetViewPort().GetRect().Height(),f=r.GetViewPort().GetRect().Width();return a>f?u=f/u:u=a/u,n*u/r.GetZoom()},t}();e.Billboard=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n.m_updateUvTransform=!0,n.m_uvScale=new e.Vector2(1,1),n.m_uvTranslate=new e.Vector2(0,0),n.m_uvRotate=0,n.m_materialType=e.MaterialType.MaterialType_Inner,n.m_acceptLight=!0,n}return __extends(n,t),n.prototype.UpdateUvTransform=function(){var t=Math.cos(this.m_uvRotate),n=Math.sin(this.m_uvRotate),r=this.m_uvScale.x,i=this.m_uvScale.y,s=this.m_uvTranslate.x,o=this.m_uvTranslate.y;this.m_uvTransform=new e.Matrix3(r*t,r*n,s,-i*n,i*t,o,0,0,1),this.m_updateUvTransform=!1},n.prototype.SetUvTranslate=function(e){this.m_uvTranslate=e,this.m_updateUvTransform=!0},n.prototype.SetUvScale=function(e){this.m_uvScale=e,this.m_updateUvTransform=!0},n.prototype.SetUvRotate=function(e){this.m_uvRotate=e,this.m_updateUvTransform=!0},n.prototype.GetUvTransform=function(){return this.m_updateUvTransform&&this.UpdateUvTransform(),this.m_uvTransform},n.prototype.GetUvTranslate=function(){return this.m_uvTranslate},n.prototype.GetUvScale=function(){return this.m_uvScale},n.prototype.GetUvRotate=function(){return this.m_uvRotate},n}(e.BaseMaterial);e.InnerMaterial=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n.m_materialType=e.MaterialType.MaterialType_Depth,n.m_useLight=!1,n}return __extends(n,t),n.prototype.GetUseLight=function(){return this.m_useLight},n.prototype.SetUseLight=function(e){this.m_useLight=e},n}(e.InnerMaterial);e.DepthMaterial=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n.m_squarePoints=[],n.m_spotExponent=20,n.m_spotCutoff=180,n.m_spotCosCutoff=.5,n.m_constantAttenuation=1,n.m_linearAttenuation=0,n.m_quadraticAttenuation=0,n.m_specularIntensity=1,n.m_diffuse=e.Color.WHITE().Clone(),n.m_intensity=1,n.m_ShowAllSign=!0,n.m_showSimpleSign=!0,n.SetLightSourceType(e.LightType.LightType_Directional),n.m_lightShadow=new e.DirectionalLightShadow,n.m_castShadow=!0,n}return __extends(n,t),n.prototype.GetLightShadow=function(){return this.m_lightShadow},n.prototype.GetType=function(){return e.ShapeType.SHAPE_LIGHT_DIRECTIONAL},n.prototype.FindVisiableObject=function(n){if(this.m_needUpdataSign){var r=this.GetWorldTransform();this.m_glworldMatrix=r.Transpose();var i=e.Vector3.ZERO();if(this.m_showSimpleSign&&!this.m_simpleSignModel){this.m_simpleSignModel=new e.ImageModel;var s=e.Parameters.Instance().appWorkPath+"\\data\\pic\\"+"directional.png";this.m_simpleSignModel.SetImagePath(s),this.m_simpleSignModel.SetImageSize(i,new e.Vector2(.5,.5)),this.AddSubModel(this.m_simpleSignModel)}if(this.m_ShowAllSign){this.m_allSignModel||(this.m_allSignModel=new e.Model,this.AddSubModel(this.m_allSignModel)),this.m_allSignModel.ClearLineData();var o=[],u=i.Clone(),a=this.m_direction.Clone();a.Normalize();var f=n.GetScene().GetSceneBox().Length();o.push(u.Sub(a.Multiply(f*.5))),o.push(u),this.m_allSignModel.AddLineData(o);var l=[],c=f*.02,h=new e.Vector3(-c,c,0),p=new e.Vector3(-c,-c,0),d=new e.Vector3(c,-c,0),v=new e.Vector3(c,c,0);l.push(h),l.push(p),l.push(d),l.push(v),l.push(h),this.m_allSignModel.AddLineData(l)}this.m_needUpdataSign=!1}this.SetRenderWorldMatrix(this.m_glworldMatrix),t.prototype.FindVisiableObject.call(this,n)},n.prototype.InitProperties=function(){},n.prototype.SetLightType=function(e){this.SetType(e)},n.prototype.SetPerVertex=function(e){this.m_perVertex=e},n.prototype.SetSpecularIntensity=function(t){this.m_intensity=e.Max(t,0)},n.prototype.SetBrightness=function(e){this.m_brightness=e},n.prototype.SetRange=function(t){this.m_range=e.Max(t,0)},n.prototype.SetFov=function(t){this.m_fov=e.Clamp(t,0,e.MAX_FOV)},n.prototype.SetAspectRatio=function(t){this.m_aspectRatio=e.Max(t,e.EPSILON)},n.prototype.GetLinearAttenuation=function(){return this.m_linearAttenuation},n.prototype.SetLinearAttenuation=function(e){this.m_linearAttenuation=e},n.prototype.GetAmbient=function(){return this.m_ambient},n.prototype.SetAmbient=function(e){this.m_ambient=e},n.prototype.GetConstantAttenuation=function(){return this.m_constantAttenuation},n.prototype.SetConstantAttenuation=function(e){this.m_constantAttenuation=e},n.prototype.GetDiffuse=function(){return this.m_diffuse},n.prototype.SetDiffuse=function(e){this.m_diffuse=e},n.prototype.GetLightModelAmbient=function(){return this.m_lightModelAmbient},n.prototype.SetLightModelAmbient=function(e){this.m_lightModelAmbient=e},n.prototype.GetQuadraticAttenuation=function(){return this.m_quadraticAttenuation},n.prototype.SetQuadraticAttenuation=function(e){this.m_quadraticAttenuation=e},n.prototype.GetSpecular=function(){return this.m_specular},n.prototype.SetSpecular=function(e){this.m_specular=e},n.prototype.GetSpotCosCutoff=function(){return this.m_spotCosCutoff},n.prototype.SetSpotCosCutoff=function(e){this.m_spotCosCutoff=e},n.prototype.GetSpotCutoff=function(){return this.m_spotCutoff},n.prototype.SetSpotCutoff=function(e){this.m_spotCutoff=e},n.prototype.GetSpotDirection=function(){return this.m_spotDirection},n.prototype.SetSpotDirection=function(e){this.m_spotDirection=e},n.prototype.GetSpotExponent=function(){return this.m_spotExponent},n.prototype.SetSpotExponent=function(e){this.m_spotExponent=e},n.prototype.GetPositionOld=function(){return this.m_position_old},n.prototype.SetPositionOld=function(e){this.m_position_old=e},n.prototype.GetLightType=function(){return this.m_lightType},n.prototype.GetPerVertex=function(){return this.m_perVertex},n.prototype.GetSpecularIntensity=function(){return this.m_intensity},n.prototype.GetBrightness=function(){return this.m_brightness},n.prototype.GetEffectiveColor=function(){return new e.Color(this.m_lightColor.Multiply(this.m_brightness),1)},n.prototype.GetEffectiveSpecularIntensity=function(){return this.m_specularIntensity*e.Abs(this.m_brightness)},n.prototype.GetRange=function(){return this.m_range},n.prototype.GetFov=function(){return this.m_fov},n.prototype.GetAspectRatio=function(){return this.m_aspectRatio},n}(e.BaseLight);e.DirectionalLight=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){this.m_camera=null,this.renderTarget=null}return e.prototype.Update=function(e,t,n){},e.prototype.SetMapSize=function(e){this.m_mapSize=e.Clone()},e.prototype.GetMapSize=function(){return this.m_mapSize},e.prototype.GetCamera=function(){return this.m_camera},e.prototype.SetBias=function(e){this.m_bias=e},e.prototype.Bias=function(){return this.m_bias},e.prototype.SetRadius=function(e){this.m_radius=e},e.prototype.Radius=function(){return this.m_radius},e.prototype.Matrix=function(){return this.m_matrix},e.prototype.SetRenderTarget=function(e){this.renderTarget=e},e.prototype.RenderTarget=function(){return this.renderTarget},e}();e.LightShadow=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var e=t.call(this)||this;return e.Init(),e}return __extends(n,t),n.prototype.SetCameraInfo=function(e,t,n){this.orthoSize=e,this.cameraNear=t,this.cameraFar=n,this.needUpdata=!0},n.prototype.Update=function(e,t,n){this.UpdateCamera(e,t),this.UpdateMatrix()},n.prototype.UpdateCamera=function(t,n){var r=t.GetNodeWorldPosition(),i=t.GetWorldDirection().Nagative();i.Normalize();var s=new e.Vector3,o=n.GetSceneManager().GetSceneBox(),u=o.Center(),a=o.Length();if(!t.IsInWorld()){var f=n.GetView().Inverse();i=f.Multiply(new e.Vector4(i,0)),s=u.Clone(),r=i.Nagative().Multiply(a).Multiply(.5).Add(u)}else s=r.Add(i);this.m_camera.SetWorldPosition(r),this.m_camera.LookAt(s,new e.Vector3(0,1,0),e.SceneNode.TS_WORLD),this.needUpdata&&(this.m_camera.SetOrthoSize(new e.Vector2(this.orthoSize,this.orthoSize)),this.m_camera.SetNearClip(this.cameraNear),this.m_camera.SetFarClip(this.cameraFar),this.needUpdata=!1)},n.prototype.UpdateMatrix=function(){this.m_matrix=new e.Matrix4(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),this.m_matrix=this.m_matrix.Multiply(this.m_camera.GetProjection()),this.m_matrix=this.m_matrix.Multiply(this.m_camera.GetView().ToMatrix4())},n.prototype.Init=function(){this.orthoSize=64,this.cameraNear=.1,this.cameraFar=1e4,this.m_mapSize=new e.Vector2(2048,2048),this.m_camera=new e.Camera,this.m_camera.SetOrthographic(!0),this.m_camera.SetOrthoSize(new e.Vector2(this.orthoSize,this.orthoSize)),this.m_camera.SetNearClip(this.cameraNear),this.m_camera.SetFarClip(this.cameraFar),this.needUpdata=!1,this.m_bias=0,this.m_radius=4},n}(e.LightShadow);e.DirectionalLightShadow=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){this.filterMin=e.GL.LINEAR,this.filterMag=e.GL.LINEAR,this.wrapS=e.GL.REPEAT,this.wrapT=e.GL.REPEAT,this.isUseMinMap=!1,this.width=512,this.height=512,this.format=e.GL.RGBA,this.internalrFromat=e.GL.RGBA,this.imagePath=""}return t}();e.TextureParameter=t;var n;(function(e){e[e.TEXTURE_LOAD_AUTO=0]="TEXTURE_LOAD_AUTO",e[e.TEXTURE_LOAD_L=1]="TEXTURE_LOAD_L",e[e.TEXTURE_LOAD_LA=2]="TEXTURE_LOAD_LA",e[e.TEXTURE_LOAD_RGB=3]="TEXTURE_LOAD_RGB",e[e.TEXTURE_LOAD_RGBA=4]="TEXTURE_LOAD_RGBA"})(n=e.TEXTURE_LOAD||(e.TEXTURE_LOAD={}));var r;(function(e){e[e.TEXEL_ENCODING_TYPE_LINEAR=0]="TEXEL_ENCODING_TYPE_LINEAR",e[e.TEXEL_ENCODING_TYPE_SRGB=1]="TEXEL_ENCODING_TYPE_SRGB",e[e.TEXEL_ENCODING_TYPE_RGBE=2]="TEXEL_ENCODING_TYPE_RGBE",e[e.TEXEL_ENCODING_TYPE_RGBM7=3]="TEXEL_ENCODING_TYPE_RGBM7",e[e.TEXEL_ENCODING_TYPE_RGBM16=4]="TEXEL_ENCODING_TYPE_RGBM16",e[e.TEXEL_ENCODING_TYPE_RGBD=5]="TEXEL_ENCODING_TYPE_RGBD",e[e.TEXEL_ENCODING_TYPE_GAMMA=6]="TEXEL_ENCODING_TYPE_GAMMA"})(r=e.TextureEncodingType||(e.TextureEncodingType={}));var i;(function(e){e[e.TEXTURE_FLAG_POWER_OF_TWO=1]="TEXTURE_FLAG_POWER_OF_TWO",e[e.TEXTURE_FLAG_MIPMAPS=2]="TEXTURE_FLAG_MIPMAPS",e[e.TEXTURE_FLAG_TEXTURE_REPEATS=4]="TEXTURE_FLAG_TEXTURE_REPEATS",e[e.TEXTURE_FLAG_MULTIPLY_ALPHA=8]="TEXTURE_FLAG_MULTIPLY_ALPHA",e[e.TEXTURE_FLAG_INVERT_Y=16]="TEXTURE_FLAG_INVERT_Y",e[e.TEXTURE_FLAG_COMPRESS_TO_DXT=32]="TEXTURE_FLAG_COMPRESS_TO_DXT",e[e.TEXTURE_FLAG_DDS_LOAD_DIRECT=64]="TEXTURE_FLAG_DDS_LOAD_DIRECT",e[e.TEXTURE_FLAG_NTSC_SAFE_RGB=128]="TEXTURE_FLAG_NTSC_SAFE_RGB",e[e.TEXTURE_FLAG_CoCg_Y=256]="TEXTURE_FLAG_CoCg_Y",e[e.TEXTURE_FLAG_TEXTURE_RECTANGLE=512]="TEXTURE_FLAG_TEXTURE_RECTANGLE"})(i=e.TEXTURE_FLAG||(e.TEXTURE_FLAG={}));var s=function(){function n(e){this.gl=null,this.texObj=null,this.textureParameter=new t,this.isTextureDirty=!0,this.m_textures=[],this.resourceManager=null,this.name="",this.isNeedInit=!0,this.imageArray=[],this.isLoaded=!1,this.m_textureEncoding=r.TEXEL_ENCODING_TYPE_LINEAR,this.m_gammaInput=!1,this._textureRepeat=!1,this._isUseMipmap=!0,this.currentTarget=0,this.lastUnit=0,e&&(this.textureParameter=e)}return n.prototype.SetTextureParameter=function(e){e&&(this.textureParameter=e),this.MakeDirty()},n.prototype.SetResourceManager=function(e){this.resourceManager=e},n.prototype.UpdateOGLObj=function(){},n.prototype.Init=function(){this.MakeDirty(),this.name="",this.m_isMipMap=!1,this.m_minFliter=e.GL.LINEAR,this.m_magFliter=e.GL.LINEAR,this.m_wrapS=e.GL.REPEAT,this.m_wrapT=e.GL.REPEAT,this.m_textureEncoding=r.TEXEL_ENCODING_TYPE_LINEAR,this.m_gammaInput=!1},n.prototype.AddImage=function(t){if(this.imageArray.length>0)if(this instanceof e.Texture2D)this.GetImageArray[0]=t;else for(var n=0;n<this.imageArray.length;n++)this.imageArray[n].GetImagePath()!==t.GetImagePath()&&this.imageArray.push(t);else this.imageArray.length===0&&this.imageArray.push(t)},n.prototype.GetImageArray=function(){return this.imageArray},n.prototype.SetImageParameter=function(e,t){this.m_forceChannels=e,this.m_flags=t},n.prototype.SetImagePathes=function(e){if(this.imageArray.length<=e.length)for(var t=0;t<this.imageArray.length;t++)this.imageArray[t].SetImagePath(e[t])},n.prototype.GetImagePathes=function(){var e=[];if(this.imageArray.length>0){for(var t=0;t<this.imageArray.length;t++)e.push(this.imageArray[t].GetImagePath());return e}},n.prototype.MakeDirty=function(){this.isTextureDirty=!0},n.prototype.GetOGLObj=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];if(e.length===0)return this.isTextureDirty&&(this.UpdateOGLObj(),this.isTextureDirty=!1),this.m_textures[0];var n=e[0];return this.isNeedInit&&(this.gl=n,this.Init(),this.isNeedInit=!1),this.isTextureDirty&&(this.UpdateOGLObj(),this.isTextureDirty=!1),this.isLoaded?this.texObj:null},n.prototype.SetName=function(e){this.name=e},n.prototype.GetName=function(){return this.name},n.prototype.ClearResource=function(){this.gl.deleteTexture(this.texObj),this.texObj=null,this.isNeedInit=!0,this.isTextureDirty=!0,this.isLoaded=!1},n.prototype.bind=function(){},n.prototype.SetTextureUnit=function(e){this.currentTarget!=e&&(this.lastUnit=this.currentTarget,this.currentTarget=e)},n.prototype.unbind=function(){},n.prototype.MarkDirty=function(){this.isTextureDirty=!0},Object.defineProperty(n.prototype,"IsUseMipMap",{get:function(){return this._isUseMipmap},set:function(e){this._isUseMipmap=e},enumerable:!0,configurable:!0}),n.prototype.TextureEncoding=function(){return this.m_textureEncoding},n.prototype.SetTextureEncoding=function(e){this.m_textureEncoding=e},n.prototype.MinFliter=function(){return this.m_minFliter},n.prototype.SetMinFliter=function(e){this.m_minFliter=e},n.prototype.MagFliter=function(){return this.m_magFliter},n.prototype.SetMagFliter=function(e){this.m_magFliter=e},n.prototype.WrapS=function(){return this.m_wrapS},n.prototype.SetWrapS=function(e){this.m_wrapS=e},n.prototype.WrapT=function(){return this.m_wrapT},n.prototype.SetWrapT=function(e){this.m_wrapT=e},n.prototype.MipMap=function(){return this.m_isMipMap},n.prototype.SetMipMap=function(e){this.m_isMipMap=e},n.prototype.IsGammaInput=function(){return this.m_gammaInput},n.prototype.SetIsGammaInput=function(e){this.m_gammaInput=e},Object.defineProperty(n.prototype,"textureRepeat",{get:function(){return this._textureRepeat},set:function(e){this._textureRepeat=e},enumerable:!0,configurable:!0}),n.TEXTURE_BASE=0,n.TEXTURE_2D=1,n.TEXTURE_3D=2,n.TEXTURE_CUBE=3,n.TEXTURE_GEO=4,n}();e.Texture=s})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var e=t.call(this)||this;return e.Init(),e}return __extends(n,t),n.prototype.GetType=function(){return n.TEXTURE_GEO},n.prototype.UpdataOGLObj=function(){var t=this.resourceManager,n=this.GetName(),r=this.m_textures[0];r==0&&(this.gl.bindTexture(e.GL.TEXTURE_2D,r),this.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_MIN_FILTER,e.GL.LINEAR),this.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_MAG_FILTER,e.GL.LINEAR),this.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_WRAP_S,e.GL.CLAMP_TO_EDGE),this.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_WRAP_T,e.GL.CLAMP_TO_EDGE),this.gl.bindTexture(e.GL.TEXTURE_2D,0),r!=0&&t.AddOGLTexture(n,r)),this.m_textures[0]=r},n.prototype.Init=function(){this.m_targetType=e.RenderTargetType.TEXTURE_TARGET,this.m_textures[0]=0,this.SetImageParameter(e.TEXTURE_LOAD.TEXTURE_LOAD_RGBA,e.TEXTURE_FLAG.TEXTURE_FLAG_MIPMAPS),this.MarkDirty()},n.prototype.GenerateMipMap=function(){this.m_isMipMap&&this.gl.generateMipmap(e.GL.TEXTURE_2D)},n.LoadOGLTexture=function(e,t,n,r,i){},n}(e.Texture);e.GeometryBuffer=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(e){function t(t){var n=e.call(this)||this;return n.gl=null,n.gl=t,n}return __extends(t,e),t.prototype.GetObject=function(){return this.object},t.prototype.GetGLRenderContext=function(){return this.gl},t.DISK_CACHE=2,t.GPU_CACHE=1,t.NO_CACHE=0,t}(e.Resource);e.GPUObject=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(r){var i=t.call(this,r)||this;return i.width=512,i.height=512,i.m_maxColorAttachNum=4,i.m_colorAttachments=new Array(4),i.dirty=!0,i._usedColorAttachment=0,i.framebufferObj=null,i.originalFBO=null,i.colorTargets={},i.depthTarget=null,i.colorAttachmentNumber=1,i.m_colorUseRenderBuffer=!1,i.colorUseRenderBuffer=!1,i.m_depthUseRenderBuffer=!1,i.m_multisamplerNumber=4,i.m_useMultisample=!1,i.m_colorInternalFormat=e.GL.RGBA,i.m_depthInternalFormat=e.GL.DEPTH_COMPONENT,i.m_outColorTexture=null,i.m_outColorTextureLevel=-1,i.m_colorTextureMipmap=!1,i.useDepthBuffer=!0,i.useStencilBuffer=!0,n.id++,i}return __extends(n,t),n.prototype.markDirty=function(){this.dirty=!0},n.prototype.SetSize=function(e,t){if(this.width==e&&this.height==t)return;this.width=e,this.height=t,this.markDirty()},n.prototype.allocColorAttachment=function(){var e=this._usedColorAttachment;return this._usedColorAttachment+=1,e},n.prototype.keepOriginalFBO=function(){this.originalFBO=this.gl.getParameter(e.GL.FRAMEBUFFER_BINDING)},n.prototype.restoreOriginalFBO=function(){this.gl.bindFramebuffer(e.GL.FRAMEBUFFER,this.originalFBO)},n.prototype.create=function(){this.keepOriginalFBO(),this.framebufferObj=this.gl.createFramebuffer()},n.prototype.destroy=function(){if(this.depthTarget){var t=this.depthTarget.getRBO();this.gl.deleteRenderbuffer(t),this.depthTarget=null}for(var n in this.colorTargets){var r=this.colorTargets[n];if(r instanceof e.TextureTarget){var t=r.GetOGLObj(this.gl);this.gl.deleteTexture(t),this.resourceManager.RemoveTexture(r.GetName())}else if(r instanceof e.HardWareRenderBuffer){var t=r.getRBO();this.gl.deleteRenderbuffer(t)}delete this.colorTargets[n]}this.framebufferObj&&(this.gl.deleteFramebuffer(this.framebufferObj),this.framebufferObj=null)},n.prototype.bind=function(){this.framebufferObj&&this.gl.bindFramebuffer(e.GL.FRAMEBUFFER,this.framebufferObj)},n.prototype.unbind=function(){this.framebufferObj&&this.gl.bindFramebuffer(e.GL.FRAMEBUFFER,null),this.restoreOriginalFBO()},n.prototype.setSize=function(e,t){this.width=e,this.height=t,this.markDirty()},n.prototype.reShape=function(){this.dirty&&(this.destroy(),this._usedColorAttachment=0,this.generateNormalFramerBuffer())},n.prototype.generateNormalFramerBuffer=function(){this.create(),this.generateColorAttatchment(),this.generateDepthAttatchment(),this.dirty=!1},n.prototype.generateMultisampleFramerBuffer=function(e,t,n){},n.prototype.setCreationParameters=function(e,t,n){e===void 0&&(e=1),t===void 0&&(t=!0),n===void 0&&(n=!0),this.colorAttachmentNumber=e,this.useDepthBuffer=t,this.useStencilBuffer=n},n.prototype.generateColorAttatchment=function(){for(var e=0;e<this.colorAttachmentNumber;e++)this.colorUseRenderBuffer?this.attachRenderBufferToColor():this.attachTextureToColor()},n.prototype.generateDepthAttatchment=function(){this.useDepthBuffer&&!this.useStencilBuffer&&this.attachRenderBufferToDepth(!1)},n.prototype.attachTextureToColor=function(){this.gl.bindFramebuffer(e.GL.FRAMEBUFFER,this.framebufferObj);var t=this.allocColorAttachment(),n=e.IDCreator.GetUUID()+"_colorAttachment",r=this.resourceManager.GetOrCreateTexture(n,e.Texture.TEXTURE_GEO);r.IsUseMipMap=!1,r.setSize(this.width,this.height);var i=r.GetOGLObj(this.gl
);r.bind(),this.gl.framebufferTexture2D(e.GL.FRAMEBUFFER,e.GL.COLOR_ATTACHMENT0+t,e.GL.TEXTURE_2D,i,0),r.unbind(),this.gl.bindFramebuffer(e.GL.FRAMEBUFFER,null),this.colorTargets[t]=r},n.prototype.attachRenderBufferToColor=function(){this.gl.bindFramebuffer(e.GL.FRAMEBUFFER,this.framebufferObj);var t=this.allocColorAttachment(),n=new e.HardWareRenderBuffer(this.gl);n.generateRenderBuffer(this.width,this.height);var r=n.getRBO();n.bind(),this.gl.framebufferRenderbuffer(e.GL.FRAMEBUFFER,e.GL.COLOR_ATTACHMENT0+t,e.GL.RENDERBUFFER,r),this.gl.bindFramebuffer(e.GL.FRAMEBUFFER,null),this.colorTargets[t]=n},n.prototype.attachRenderBufferToDepth=function(t){t===void 0&&(t=!1);var n=new e.HardWareRenderBuffer(this.gl);this.gl.bindFramebuffer(e.GL.FRAMEBUFFER,this.framebufferObj);if(!t){n.generateRenderBuffer(this.width,this.height,e.GL.DEPTH_COMPONENT16);var r=n.getRBO();n.bind(),this.gl.framebufferRenderbuffer(e.GL.FRAMEBUFFER,e.GL.DEPTH_ATTACHMENT,e.GL.RENDERBUFFER,r)}else{n.generateRenderBuffer(this.width,this.height,e.GL.DEPTH_STENCIL);var r=n.getRBO();n.bind(),this.gl.framebufferRenderbuffer(e.GL.FRAMEBUFFER,e.GL.DEPTH_STENCIL_ATTACHMENT,e.GL.RENDERBUFFER,r)}this.depthTarget=n,this.gl.bindFramebuffer(e.GL.FRAMEBUFFER,null)},n.prototype.getColorTarget=function(e){return this.colorTargets[e]},n.prototype.checkStatus=function(){this.gl.bindFramebuffer(e.GL.FRAMEBUFFER,this.framebufferObj);var t=this.gl.checkFramebufferStatus(e.GL.FRAMEBUFFER);t!==e.GL.FRAMEBUFFER_COMPLETE&&(t===e.GL.FRAMEBUFFER_INCOMPLETE_ATTACHMENT?console.error("Framer buffer not complete! code is FRAMEBUFFER_INCOMPLETE_ATTACHMENT"):t===e.GL.FRAMEBUFFER_INCOMPLETE_DIMENSIONS?console.error("Framer buffer not complete! code is FRAMEBUFFER_INCOMPLETE_DIMENSIONS"):t===e.GL.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT?console.error("Framer buffer not complete! code is FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT"):t===e.GL.FRAMEBUFFER_UNSUPPORTED&&console.error("Framer buffer not complete! code is FRAMEBUFFER_UNSUPPORTED")),this.gl.bindFramebuffer(e.GL.FRAMEBUFFER,null)},n.prototype.SetMaxColorAttachmentNumber=function(e){this.m_maxColorAttachNum=e},n.prototype.GetWidth=function(){return this.width},n.prototype.GetHeight=function(){return this.height},n.prototype.GetDepthTarget=function(){return this.depthTarget},n.prototype.GetColorTarget=function(e){return this.colorTargets[e]},n.prototype.ClearResource=function(){if(this.m_depthAttachment)if(this.m_depthAttachment.GetTargetType()==e.RenderTargetType.RBO_TARGET){var t=this.m_depthAttachment;t&&(t=null)}else if(this.m_depthAttachment.GetTargetType()==e.RenderTargetType.TEXTURE_TARGET){var t=this.m_depthAttachment;t&&(t=null)}this.m_depthAttachment=null;for(var n=0;n<this.m_maxColorAttachNum;n++)this.m_colorAttachments[n]&&(this.m_colorAttachments[n].GetTargetType()==e.RenderTargetType.RBO_TARGET?this.m_colorAttachments[n]=null:this.m_colorAttachments[n].GetTargetType()==e.RenderTargetType.TEXTURE_TARGET&&(this.m_colorAttachments[n]=null)),this.m_colorAttachments[n]=null;this.destroy(),this.markDirty()},n.prototype.SetParameters=function(e,t,n,r,i,s,o){this.colorAttachmentNumber=e,this.useDepthBuffer=r,this.useStencilBuffer=i,this.m_useMultisample=s,this.m_multisamplerNumber=o,this.m_colorUseRenderBuffer=t,this.m_depthUseRenderBuffer=n},n.prototype.ReShape=function(){this.dirty&&(this.destroy(),this.framebufferObj&&(this.gl.deleteFramebuffer(this.framebufferObj),this.framebufferObj=0),this._usedColorAttachment=0,this.GenerateFramerBuffer())},n.prototype.GenerateFramerBuffer=function(){this.create(),this.GenerateColorAttatchment(),this.GenerateDepthAttatchment(),this.dirty=!1},n.prototype.GenerateColorAttatchment=function(){for(var e=0;e<this.colorAttachmentNumber;e++)this.m_colorUseRenderBuffer?this.attachRenderBufferToColor():this.attachTextureToColor()},n.prototype.GenerateDepthAttatchment=function(){this.m_useMultisample&&(this.m_depthUseRenderBuffer=!0),this.m_depthUseRenderBuffer},n.prototype.AttachRenderBufferToDepth=function(){this.gl.bindFramebuffer(e.GL.FRAMEBUFFER,this.framebufferObj);var t=new e.HardWareRenderBuffer(this.gl);t.generateRenderBuffer(this.GetWidth(),this.GetHeight()),t.setResourceManager(this.resourceManager),this.gl.framebufferRenderbuffer(e.GL.FRAMEBUFFER,e.GL.DEPTH_ATTACHMENT,e.GL.RENDERBUFFER,t.GetObject()),this.gl.framebufferRenderbuffer(e.GL.FRAMEBUFFER,e.GL.STENCIL_ATTACHMENT,e.GL.RENDERBUFFER,t.GetObject()),this.gl.bindFramebuffer(e.GL.FRAMEBUFFER,0),this.depthTarget=t},n.prototype.AttachTextureToDepth=function(t){var n,r;switch(this.m_depthInternalFormat){case e.GL.DEPTH_COMPONENT:n=e.GL.DEPTH_COMPONENT,r=e.GL.UNSIGNED_INT;break;default:}this.gl.bindFramebuffer(e.GL.FRAMEBUFFER,this.framebufferObj);var i=e.IDCreator.GetUUID()+"_depthAttachment",s=this.resourceManager.GetOrCreateTexture(i,e.Texture.TEXTURE_GEO),o=s.GetOGLObj();o&&(this.gl.bindTexture(e.GL.TEXTURE_2D,o),this.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_MIN_FILTER,e.GL.NEAREST),this.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_MAG_FILTER,e.GL.NEAREST),this.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_WRAP_S,e.GL.CLAMP_TO_EDGE),this.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_WRAP_T,e.GL.CLAMP_TO_EDGE),this.gl.texImage2D(e.GL.TEXTURE_2D,0,this.m_depthInternalFormat,this.width,this.height,0,n,r,null),this.gl.framebufferTexture2D(e.GL.FRAMEBUFFER,e.GL.DEPTH_ATTACHMENT,e.GL.TEXTURE_2D,o,0),this.gl.bindTexture(e.GL.TEXTURE_2D,0)),this.gl.bindFramebuffer(e.GL.FRAMEBUFFER,0),this.depthTarget=s},n.id=0,n}(e.GPUObject);e.HardWareFrameBuffer=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(n){var r=t.call(this,n)||this;return r.width=512,r.height=512,r.innerForamt=e.GL.RGBA,r.renderBufferObj=null,r}return __extends(n,t),n.prototype.generateRenderBuffer=function(t,n,r){this.width=t,this.height=n,this.innerForamt=r===undefined?e.GL.RGBA:r,this.renderBufferObj=this.gl.createRenderbuffer(),this.gl.bindRenderbuffer(e.GL.RENDERBUFFER,this.renderBufferObj),this.gl.renderbufferStorage(e.GL.RENDERBUFFER,this.innerForamt,this.width,this.height),this.gl.bindRenderbuffer(e.GL.RENDERBUFFER,null)},n.prototype.Create=function(e,t){},n.prototype.getRBO=function(){return this.renderBufferObj},n.prototype.bind=function(){this.gl.bindRenderbuffer(e.GL.RENDERBUFFER,this.renderBufferObj)},n.prototype.unbind=function(){this.gl.bindRenderbuffer(e.GL.RENDERBUFFER,null)},n}(e.GPUObject);e.HardWareRenderBuffer=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n.m_lightColor=new e.Color(1,1,1),n.m_groundColor=new e.Color(1,1,1),n.m_lightType=e.LightType.LightType_Hemisphere,n}return __extends(n,t),n.prototype.GroundColor=function(){return this.m_groundColor},n.prototype.SetGroundColor=function(e){this.m_groundColor=e},n}(e.BaseLight);e.HemisphereLight=t})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.FromURL=0]="FromURL",e[e.FromArray=1]="FromArray",e[e.FromeZip=2]="FromeZip"})(t=e.ImageSource||(e.ImageSource={}));var n=function(){function e(){this.mode=t.FromURL,this.urlImage=new Image,this.imagePath=""}return e.prototype.GetSourceMode=function(){return this.mode},e.prototype.SetSourceMode=function(e){this.mode=e},e.prototype.GetImage=function(){return this.urlImage},e.prototype.SetImageFromURL=function(e){this.urlImage=e},e.prototype.GetImagePath=function(){return this.imagePath},e.prototype.SetImagePath=function(e){this.imagePath=e},e.prototype.GetId=function(){return this.id},e.prototype.SetId=function(e){this.id=e},e}();e.ImageM3D=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];var i=t.call(this)||this;return i.position_=new e.Vector3,i.size_=new e.Vector2,i.origSize=new e.Vector2,i.uv_=new e.Rect,i.points=[],i.textCoords=[],i.bindBillboard=new e.Billboard,i.texture=null,i.m_bAllowClip=!0,i.hardwareVertexBuffer=null,i.gl=null,i.isNeedUpdateEdge=!0,i.vertexOffset=0,i.texCoodrsOffset=0,i.renderWorldMatrix=null,i.m_fixShowInScreen=!1,n.length===0?(i.uv_=new e.Rect(new e.Vector2(0,0),new e.Vector2(1,1)),i.texture=null,i.points=[],i.textCoords=[],i.bindBillboard.AllowRotate(!1),i.bindBillboard.AllowTran(!0),i.bindBillboard.AllowScale(!1)):n.length===2&&n[0]instanceof e.Vector3&&n[1]instanceof e.Vector2&&(i.uv_=new e.Rect(new e.Vector2(0,0),new e.Vector2(1,1)),i.texture=null,i.points=[],i.textCoords=[],i.bindBillboard.AllowRotate(!1),i.bindBillboard.AllowTran(!0),i.bindBillboard.AllowScale(!1),i.Set(n[0],n[1])),i}return __extends(n,t),n.prototype.SetCurrentGLContext=function(e){this.gl=e},n.prototype.SetRenderWorldMatrix=function(e){this.renderWorldMatrix=e.Clone()},n.prototype.GetRenderWorldMatrix=function(){return this.renderWorldMatrix},n.prototype.GetRenderColor=function(){var t=e.Color.WHITE().Clone();return this.IsSelected()?e.Color.SelectColor().Clone():t},n.prototype.GetRenderMaterial=function(){return new e.Material},n.prototype.SetRenderMesh=function(e){},n.prototype.GetDataLength=function(){return-1},n.prototype.IsUseIndex=function(){return!1},n.prototype.SetIndexOffset=function(e){},n.prototype.GetIndexOffset=function(){return-1},n.prototype.SetNormalOffset=function(e){},n.prototype.GetNormalOffset=function(){return-1},n.prototype.SetVertexOffset=function(e){this.vertexOffset=e},n.prototype.GetVertexOffset=function(){return this.vertexOffset},n.prototype.SetTextureCoordsOffset=function(e){this.texCoodrsOffset=e},n.prototype.GetTextureCoordsOffset=function(){return this.texCoodrsOffset},n.prototype.SetCentersCoordsOffset=function(e){},n.prototype.GetCentersCoordsOffset=function(){return-1},n.prototype.GetHardWareVertexBuffer=function(){if(this.gl===null)return null;this.hardwareVertexBuffer===null&&(this.hardwareVertexBuffer=new e.HardWareVertexBuffer(this.gl));if(this.isNeedUpdateEdge){var t=e.ArrayHelper.ConvertToFloat32Array(this.GetVertexs()).length,n=e.ArrayHelper.ConvertToFloat32ArrayV2(this.GetTextureCoords()).length;this.hardwareVertexBuffer.Create(0,t+n);var r=e.ArrayHelper.ConvertToFloat32Array(this.GetVertexs());this.hardwareVertexBuffer.SetDataRange(r,0);var i=e.ArrayHelper.ConvertToFloat32ArrayV2(this.GetTextureCoords());this.hardwareVertexBuffer.SetDataRange(i,t),this.SetVertexOffset(0),this.SetTextureCoordsOffset(t*4),this.hardwareVertexBuffer.WriteBuffer(),this.isNeedUpdateEdge=!1}return this.hardwareVertexBuffer},n.prototype.GetHardWareIndexBuffer=function(){return null},n.prototype.SetOrigSize=function(t,n){this.uv_=new e.Rect(new e.Vector2(0,0),new e.Vector2(1,1)),this.points=[],this.textCoords=[],this.origSize=n,this.Set(t,n)},n.prototype.Set=function(e,t){this.bindBillboard.SetCenter(e),this.position_=e.Clone(),this.size_=t.Clone(),this.points=[],this.textCoords=[],this.isNeedUpdateEdge=!0},n.prototype.SetPlan=function(e){},n.prototype.GetVertexs=function(){if(this.points.length===0){var t=this.size_.x/2,n=this.size_.y/2;this.points.push(new e.Vector3(this.position_.x-t,this.position_.y-n,this.position_.z)),this.points.push(new e.Vector3(this.position_.x+t,this.position_.y-n,this.position_.z)),this.points.push(new e.Vector3(this.position_.x-t,this.position_.y+n,this.position_.z)),this.points.push(new e.Vector3(this.position_.x-t,this.position_.y+n,this.position_.z)),this.points.push(new e.Vector3(this.position_.x+t,this.position_.y-n,this.position_.z)),this.points.push(new e.Vector3(this.position_.x+t,this.position_.y+n,this.position_.z))}return this.points},n.prototype.GetTextureCoords=function(){if(this.textCoords.length===0){var t=this.uv_.min.Clone(),n=this.uv_.max.Clone();this.textCoords.push(new e.Vector2(t.x,n.y)),this.textCoords.push(new e.Vector2(n.x,n.y)),this.textCoords.push(new e.Vector2(t.x,t.y)),this.textCoords.push(new e.Vector2(t.x,t.y)),this.textCoords.push(new e.Vector2(n.x,n.y)),this.textCoords.push(new e.Vector2(n.x,t.y))}return this.textCoords},n.prototype.ComputeBox=function(){this.BoundingBox.Clear(),this.points.length>0&&(this.BoundingBox.Merge(this.points[0]),this.BoundingBox.Merge(this.points[this.points.length-1]))},n.prototype.RayPick=function(e){var t=this.GetIntersects(e);if(t.length>0){for(var n=0;n<t.length;n++)e.AddIntersectPnt(t[n]);e.AddShape(this)}},n.prototype.GetIntersects=function(t){var n=[],r=t.GetData().GetModelRay().Clone(),i=this.bindBillboard.GetWorldMatrix().Inverse();r=r.Transformed(i);var s=this.points,o=new e.Vector3;for(var u=0;u<this.points.length/3;u++)e.RayPickAction.ISintersectRayAndTriangle(s[u*3],s[u*3+1],s[u*3+2],r,o)&&(o=this.bindBillboard.GetWorldMatrix().Multiply(o),n.push(o));return n},n.prototype.UpdateRenderData=function(t){if((t.GetSceneBoxChanged()||this.points.length===0)&&!this.m_fixShowInScreen){var n=new e.Vector2;n=e.ShapeHelper.GetCommonSize(t.GetScene(),this.origSize),this.Set(this.GetPosition(),n),this.GetVertexs()}var r=this.bindBillboard.GetGLWorldMatrix(t);this.SetRenderWorldMatrix(r)},n.prototype.SetTexture=function(e){this.texture&&(this.texture=null),this.texture=e},n.prototype.GetTexture=function(){return this.texture},n.prototype.SetPosition=function(e){return this.bindBillboard.SetCenter(e),this.position_=e.Clone(),this.points=[],this.isNeedUpdateEdge=!0,!0},n.prototype.GetPosition=function(){return this.position_},n.prototype.AllowTran=function(e){return this.bindBillboard.AllowTran(e)},n.prototype.AllowRotate=function(e){return this.bindBillboard.AllowRotate(e)},n.prototype.AllowScale=function(e){return this.bindBillboard.AllowScale(e)},n.prototype.IsAllowTran=function(){return this.bindBillboard.IsAllowTran()},n.prototype.IsAllowRotate=function(){return this.bindBillboard.GetRotate()},n.prototype.IsAllowScale=function(){return this.bindBillboard.GetScale()},n.prototype.GetInTop=function(){return this.IsFrontShow()},n.prototype.SetInTop=function(e){this.SetFrontShow(e)},n.prototype.GetFlipV=function(){return this.m_flipV},n.prototype.SetFlipV=function(e){this.m_flipV=e},n.prototype.GetAllowClip=function(){return this.m_bAllowClip},n.prototype.SetAllowClip=function(e){return this.m_bAllowClip},n}(e.Shape);e.ImageBoard=t})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.TextureOp_Multiply=0]="TextureOp_Multiply",e[e.TextureOp_Add=1]="TextureOp_Add",e[e.TextureOp_Subtract=2]="TextureOp_Subtract",e[e.TextureOp_Divide=3]="TextureOp_Divide",e[e.TextureOp_SmoothAdd=4]="TextureOp_SmoothAdd",e[e.TextureOp_SignedAdd=5]="TextureOp_SignedAdd"})(t=e.TextureOp||(e.TextureOp={}));var n;(function(e){e[e.TextureMapMode_Wrap=0]="TextureMapMode_Wrap",e[e.TextureMapMode_Clamp=1]="TextureMapMode_Clamp",e[e.TextureMapMode_Decal=3]="TextureMapMode_Decal",e[e.TextureMapMode_Mirror=2]="TextureMapMode_Mirror"})(n=e.TextureMapMode||(e.TextureMapMode={}));var r;(function(e){e[e.TextureMapping_UV=0]="TextureMapping_UV",e[e.TextureMapping_SPHERE=1]="TextureMapping_SPHERE",e[e.TextureMapping_CYLINDER=2]="TextureMapping_CYLINDER",e[e.TextureMapping_BOX=3]="TextureMapping_BOX",e[e.TextureMapping_PLANE=4]="TextureMapping_PLANE",e[e.TextureMapping_OTHER=5]="TextureMapping_OTHER"})(r=e.TextureMapping||(e.TextureMapping={}));var i;(function(e){e[e.TextureType_NONE=0]="TextureType_NONE",e[e.TextureType_DIFFUSE=1]="TextureType_DIFFUSE",e[e.TextureType_SPECULAR=2]="TextureType_SPECULAR",e[e.TextureType_AMBIENT=3]="TextureType_AMBIENT",e[e.TextureType_EMISSIVE=4]="TextureType_EMISSIVE",e[e.TextureType_HEIGHT=5]="TextureType_HEIGHT",e[e.TextureType_NORMALS=6]="TextureType_NORMALS",e[e.TextureType_SHININESS=7]="TextureType_SHININESS",e[e.TextureType_OPACITY=8]="TextureType_OPACITY",e[e.TextureType_DISPLACEMENT=9]="TextureType_DISPLACEMENT",e[e.TextureType_LIGHTMAP=10]="TextureType_LIGHTMAP",e[e.TextureType_REFLECTION=11]="TextureType_REFLECTION",e[e.TextureType_UNKNOWN=12]="TextureType_UNKNOWN"})(i=e.TextureType||(e.TextureType={}));var s;(function(e){e[e.ShadingMode_Flat=1]="ShadingMode_Flat",e[e.ShadingMode_Gouraud=2]="ShadingMode_Gouraud",e[e.ShadingMode_Phong=3]="ShadingMode_Phong",e[e.ShadingMode_Blinn=4]="ShadingMode_Blinn",e[e.ShadingMode_Toon=5]="ShadingMode_Toon",e[e.ShadingMode_OrenNayar=6]="ShadingMode_OrenNayar",e[e.ShadingMode_Minnaert=7]="ShadingMode_Minnaert",e[e.ShadingMode_CookTorrance=8]="ShadingMode_CookTorrance",e[e.ShadingMode_NoShading=9]="ShadingMode_NoShading",e[e.ShadingMode_Fresnel=10]="ShadingMode_Fresnel"})(s=e.ShadingMode||(e.ShadingMode={}));var o=function(t){function n(){var n=t.call(this)||this;return n.ambient=new e.Color(.1,.1,.1),n.diffuse=new e.Color(.5,.5,.5),n.specular=new e.Color(.5,.5,.5),n.ambientTexture=null,n.diffuseTexture=null,n.specularTexture=null,n.m_matcapMap=null,n.bumpTexture=null,n.name="",n.textureTransform=new e.Matrix4,n.uniformPatameters={},n.reflectiveTexture=null,n.Init(),n}return __extends(n,t),n.prototype.Init=function(){var t=new e.Color(.8,.8,.8,1);this.SetAmbient(t),this.SetDiffuse(t),this.SetSpecular(new e.Color(.067,.067,.067)),this.SetEmissive(new e.Color(0,0,0)),this.m_texture=null,this.m_normalMap=null,this.m_specularMap=null,this.m_displacementMap=null,this.m_displacementScale=5,this.m_displacementBias=0,this.m_normalMapScale=new e.Vector2(2,2),this.SetDiffuseMap(null),this.SetBumpMap(null),this.textureTransform=null,this.ambientTexture=null,this.m_shininess=30,this.m_reflectiveTexture=null,this.needsUpdateUniformParameters=!0,this.m_materialType=e.MaterialType.MaterialType_Phong,this.Opacity(1)},n.prototype.SetResourceManager=function(e){this.resourceManager=e},n.prototype.SetAmbient=function(e){this.ambient=e.Clone()},n.prototype.SetDiffuse=function(e){this.diffuse=e.Clone()},n.prototype.SetSpecular=function(e){this.specular=e.Clone()},n.prototype.SetEmissive=function(e){this.emissive=e.Clone()},n.prototype.GetAmbient=function(){return this.ambient},n.prototype.GetDiffuse=function(){return this.diffuse},n.prototype.GetSpecular=function(){return this.specular},n.prototype.GetEmissive=function(){return this.emissive},n.prototype.SetShadingMode=function(e){this.m_shadingMode=e},n.prototype.SetTextureOp=function(e){this.m_textureOp=e},n.prototype.SetTextureMapMode=function(e){this.m_textureMapMode=e},n.prototype.SetTextureMapping=function(e){this.m_textureMapping=e},n.prototype.GetShadingMode=function(){return this.m_shadingMode},n.prototype.GetTextureOp=function(){return this.m_textureOp},n.prototype.GetTextureMapMode=function(){return this.m_textureMapMode},n.prototype.GetTextureMapping=function(){return this.m_textureMapping},n.prototype.SetDiffuseMap=function(e){this.m_texture&&(this.m_texture=null),this.m_texture=e,this.m_texture&&this.SetNeedUpdate(!0)},n.prototype.SetMatcapMap=function(e){this.m_matcapMap&&(this.m_matcapMap=null),this.m_matcapMap=e,this.m_matcapMap&&this.SetNeedUpdate(!0)},n.prototype.GetMatcapMap=function(){return this.m_matcapMap},n.prototype.GetDiffuseMap=function(){return this.m_texture},n.prototype.SetSpecularMap=function(e){this.m_specularMap&&(this.m_specularMap=null),this.m_specularMap=e,this.m_specularMap&&this.SetNeedUpdate(!0)},n.prototype.GetSpecularMap=function(){return this.m_specularMap},n.prototype.SetEmissiveMap=function(e){},n.prototype.GetEmissiveMap=function(){return null},n.prototype.SetNormalMap=function(e){this.m_normalMap&&(this.m_normalMap=null),this.m_normalMap=e,this.m_normalMap&&this.SetNeedUpdate(!0)},n.prototype.GetNormalMap=function(){return this.m_normalMap},n.prototype.SetEvnMap=function(e){},n.prototype.GetEvnMap=function(){return null},n.prototype.SetBumpMap=function(e){this.m_bumpmap=e},n.prototype.GetBumpMap=function(){return this.m_bumpmap},n.prototype.SetAmbientMap=function(e){this.ambientTexture=e},n.prototype.GetAmbientMap=function(){return this.ambientTexture},n.prototype.CreateTexture2DTransform=function(){this.textureTransform||(this.textureTransform=new e.Matrix4)},n.prototype.GetTexture2DTransform=function(){return this.textureTransform},n.prototype.SetShininess=function(e){this.m_shininess=e},n.prototype.GetShininess=function(){return this.m_shininess},n.prototype.GetEnvTextureMapping=function(){return this.m_envTextureMapping},n.prototype.EnvTextureMapping=function(e){this.m_envTextureMapping=e},n.prototype.GetNormalMapScale=function(){return this.m_normalMapScale},n.prototype.NormalMapScale=function(e){this.m_normalMapScale=e},n.prototype.GetDisplacementMap=function(){return this.m_displacementMap},n.prototype.DisplacementMap=function(e){},n.prototype.GetDisplacementScale=function(){return this.m_displacementScale},n.prototype.DisplacementScale=function(e){this.m_displacementScale=e},n.prototype.GetDisplacementBias=function(){return this.m_displacementBias},n.prototype.DisplacementBias=function(e){this.m_displacementBias=e},n.prototype.GetOpacity=function(){return this.m_opacity},n.prototype.Opacity=function(e){this.m_opacity=e},n.prototype.TempOpacity=function(e){this.m_opacity=e},n.prototype.SetAmbientTexture=function(e){this.ambientTexture=e,this.SetUniformParameter("ambientTexture",this.ambientTexture)},n.prototype.SetDiffuseTexture=function(e){this.diffuseTexture=e,this.SetUniformParameter("diffuseTexture",this.diffuseTexture)},n.prototype.SetSpecularTexture=function(e){this.specularTexture=e,this.SetUniformParameter("specularTexture",this.specularTexture)},n.prototype.GetAmbientTexture=function(){return this.ambientTexture},n.prototype.GetDiffuseTexture=function(){return this.diffuseTexture},n.prototype.GetSpecularTexture=function(){return this.specularTexture},n.prototype.SetName=function(e){this.name=e},n.prototype.GetName=function(){return this.name},n.prototype.SetTexture2DTransform=function(e){this.textureTransform=e.Clone()},n.prototype.GHetTexture2DTransform=function(){return this.textureTransform},n.prototype.GetReflectiveTextureTexture=function(){return this.reflectiveTexture},n.prototype.SetReflectiveTexture=function(e){this.reflectiveTexture=e},n.prototype.SetUniformParameter=function(e,t){var n=!1;return this.uniformPatameters[e]===undefined&&(this.uniformPatameters[e]=t,n=!0),n},n.prototype.GetUniformParameter=function(e){return this.uniformPatameters.hasOwnProperty(e)?this.uniformPatameters[e]:null},n.prototype.GetUnifomParameters=function(){return this.uniformPatameters},n}(e.InnerMaterial);e.Material=o})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var e=t.call(this)||this;return e.Init(),e}return __extends(n,t),n.prototype.Init=function(){var t=new e.Color(0,0,0,1),n=e.Color.WHITE().Clone();this.SetAmbient(t),this.SetDiffuse(n),this.SetSpecular(t),this.SetEmissive(t),this.m_texture=null,this.m_normalMap=null,this.m_specularMap=null,this.m_displacementMap=null,this.m_matcapMap=null,this.m_displacementScale=5,this.m_displacementBias=0,this.m_normalMapScale=new e.Vector2(1,1),this.SetDiffuseMap(null),this.SetBumpMap(null),this.textureTransform=null,this.ambientTexture=null,this.m_shininess=0,this.m_reflectiveTexture=null,this.needsUpdateUniformParameters=!0,this.Opacity(1),this.m_isGammaOutpute=!1,this.m_materialType=e.MaterialType.MaterialType_MatCap},n}(e.Material);e.MatCapMaterial=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];var i=t.call(this)||this;return i.hardwareVertexBuffer=null,i.gl=null,i.isNeedUpdateEdge=!0,i.vertexOffset=0,i.position_=new e.Vector3,i.size_=new e.Vector2,i.points=[],i.bindBillboard=new e.Billboard,n.length===0?(i.points=[],i.bindBillboard.AllowRotate(!1),i.bindBillboard.AllowTran(!0),i.bindBillboard.AllowScale(!1)):n.length===2&&n[0]instanceof e.Vector3&&n[1]instanceof e.Vector2&&(i.points=[],i.bindBillboard.AllowRotate(!1),i.bindBillboard.AllowTran(!0),i.bindBillboard.AllowScale(!1),i.Set(n[0],n[1])),i}return __extends(n,t),n.prototype.SetCurrentGLContext=function(e){this.gl=e},n.prototype.SetRenderWorldMatrix=function(e){},n.prototype.GetRenderWorldMatrix=function(){return new e.Matrix4},n.prototype.GetRenderColor=function(){var t=e.Color.WHITE().Clone();return this.IsSelected()?e.Color.SelectColor().Clone():t},n.prototype.GetRenderMaterial=function(){return new e.Material},n.prototype.SetRenderMesh=function(e){},n.prototype.GetDataLength=function(){return-1},n.prototype.IsUseIndex=function(){return!1},n.prototype.SetIndexOffset=function(e){},n.prototype.GetIndexOffset=function(){return-1},n.prototype.SetNormalOffset=function(e){},n.prototype.GetNormalOffset=function(){return-1},n.prototype.SetVertexOffset=function(e){this.vertexOffset=e},n.prototype.GetVertexOffset=function(){return this.vertexOffset},n.prototype.SetTextureCoordsOffset=function(e){},n.prototype.GetTextureCoordsOffset=function(){return-1},n.prototype.SetCentersCoordsOffset=function(e){},n.prototype.GetCentersCoordsOffset=function(){return-1},n.prototype.GetHardWareVertexBuffer=function(){if(this.gl===null)return null;this.hardwareVertexBuffer===null&&(this.hardwareVertexBuffer=new e.HardWareVertexBuffer(this.gl));if(this.isNeedUpdateEdge){var t=this.GetLinesVertexs().length;this.hardwareVertexBuffer.Create(0,t);var n=e.ArrayHelper.ConvertToFloat32Array(this.GetLinesVertexs());this.hardwareVertexBuffer.SetDataRange(n,0),this.SetVertexOffset(0),this.hardwareVertexBuffer.WriteBuffer(),this.isNeedUpdateEdge=!1}return this.hardwareVertexBuffer},n.prototype.GetHardWareIndexBuffer=function(){return null},n.prototype.Set=function(e,t){this.bindBillboard.SetCenter(e),this.position_=e.Clone(),this.size_=t.Clone(),this.points=[]},n.prototype.GetLinesVertexs=function(){if(this.points.length==0){var t=this.size_.x/2,n=this.size_.y/2;this.points.push(new e.Vector3(this.position_.x,this.position_.y-n,this.position_.z)),this.points.push(new e.Vector3(this.position_.x,this.position_.y+n,this.position_.z)),this.points.push(new e.Vector3(this.position_.x-t,this.position_.y,this.position_.z)),this.points.push(new e.Vector3(this.position_.x+t,this.position_.y,this.position_.z))}return this.points},n.prototype.ComputeBox=function(){this.BoundingBox.Clear(),this.points.length>0&&(this.BoundingBox.Merge(this.points[0]),this.BoundingBox.Merge(this.points[this.points.length-1]))},n.prototype.UpdateRenderData=function(e){var t=this.bindBillboard.GetGLWorldMatrix(e);this.SetRenderWorldMatrix(t)},n}(e.Shape);e.MeshBoard=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n.m_materialType=e.MaterialType.MaterialType_Pbr,n.m_rougthnessFactor=.5,n.m_metalnessFactor=.04,n.m_aoMapIntensity=1,n.m_emissiveColor=new e.Color(0,0,0),n.m_normalMapScale=new e.Vector2(2,2),n.m_displacementMap=null,n.m_displacementScale=5,n.m_displacementBias=0,n.m_envMapIntensity=1,n.m_clearCoat=.9,n.m_clearCoatRoughness=.04,n.m_isUseClearCoat=!0,n.m_albedoMap=null,n.m_metalnessRoughnessMap=null,n.m_envMap=null,n.m_envIrradianceMap=null,n.m_emissiveMap=null,n.m_ambientOcclusiontMap=null,n.m_normalMap=null,n.SetDefine("PHYSICALLY_CORRECT_LIGHTSS","#define PHYSICALLY_CORRECT_LIGHTSS"),n.m_envTextureMapping=e.EnvTextureMappingType.CubeReflectionMapping,n.SetOpacity(1),n.m_isGammaOutpute=!0,n.SetUseClearCoat(!1),n}return __extends(n,t),n.prototype.Rename=function(e){},n.prototype.AlbedoMap=function(){return this.m_albedoMap},n.prototype.SetAlbedoMap=function(e){this.m_albedoMap&&(this.m_albedoMap=null),this.m_albedoMap=e,this.m_albedoMap&&(this.m_albedoMap.SetIsGammaInput(!0),this.SetNeedUpdate(!0))},n.prototype.EnvMap=function(){return this.m_envMap},n.prototype.SetEnvMap=function(e){this.m_envMap!==e&&(this.m_envMap&&(this.m_envMap=null),this.m_envMap=e,this.m_envMap&&this.m_envMap.SetIsGammaInput(!0),this.SetNeedUpdate(!0))},n.prototype.EnvIrradianceMap=function(){return this.m_envIrradianceMap},n.prototype.SetEnvIrradianceMap=function(e){this.m_envIrradianceMap!==e&&(this.m_envIrradianceMap&&(this.m_envIrradianceMap=null),this.m_envIrradianceMap=e,this.m_envIrradianceMap&&this.m_envIrradianceMap.SetIsGammaInput(!0),this.SetNeedUpdate(!0))},n.prototype.EmissiveMap=function(){return this.m_emissiveMap},n.prototype.SetEmissiveMap=function(e){this.m_emissiveMap&&(this.m_emissiveMap=null),this.m_emissiveMap=e,this.m_emissiveMap&&(this.m_emissiveMap.SetIsGammaInput(!0),this.SetNeedUpdate(!0))},n.prototype.AmbientOcclusiontMap=function(){return this.m_ambientOcclusiontMap},n.prototype.SetAmbientOcclusiontMap=function(e){this.m_ambientOcclusiontMap&&(this.m_ambientOcclusiontMap=null),this.m_ambientOcclusiontMap=e,this.m_ambientOcclusiontMap&&(this.m_ambientOcclusiontMap.SetIsGammaInput(!0),this.SetNeedUpdate(!0))},n.prototype.NormalMap=function(){return this.m_normalMap},n.prototype.SetNormalMap=function(e){this.m_normalMap&&(this.m_normalMap=null),this.m_normalMap=e,this.m_normalMap&&(this.m_normalMap.SetIsGammaInput(!0),this.SetNeedUpdate(!0))},n.prototype.EnvTextureMapping=function(){return this.m_envTextureMapping},n.prototype.SetEnvTextureMapping=function(e){this.m_envTextureMapping=e},n.prototype.MetalnessRoughnessMap=function(){return this.m_metalnessRoughnessMap},n.prototype.SetMetalnessRoughnessMap=function(e){this.m_metalnessRoughnessMap&&(this.m_metalnessRoughnessMap=null),this.m_metalnessRoughnessMap=e,this.m_metalnessRoughnessMap&&(this.m_metalnessRoughnessMap.SetIsGammaInput(!0),this.SetNeedUpdate(!0))},n.prototype.RougthnessFactor=function(){return this.m_rougthnessFactor},n.prototype.SetRougthnessFactor=function(e){this.m_rougthnessFactor=e},n.prototype.MetalnessFactor=function(){return this.m_metalnessFactor},n.prototype.SetMetalnessFactor=function(e){this.m_metalnessFactor=e},n.prototype.AlbedoColor=function(){return this.m_albedoColor},n.prototype.SetAlbedoColor=function(e){this.m_albedoColor=e},n.prototype.EmissiveColor=function(){return this.m_emissiveColor},n.prototype.SetEmissiveColor=function(e){this.m_emissiveColor=e},n.prototype.AoMapIntensity=function(){return this.m_aoMapIntensity},n.prototype.SetAoMapIntensity=function(e){this.m_aoMapIntensity=e},n.prototype.NormalMapScale=function(){return this.m_normalMapScale},n.prototype.SetNormalMapScale=function(e){this.m_normalMapScale=e},n.prototype.DisplacementMap=function(){return this.m_displacementMap},n.prototype.SetDisplacementMap=function(e){this.m_displacementMap&&(this.m_displacementMap=null),this.m_displacementMap=e,this.m_displacementMap&&(this.m_displacementMap.SetIsGammaInput(!0),this.SetNeedUpdate(!0))},n.prototype.DisplacementScale=function(){return this.m_displacementScale},n.prototype.SetDisplacementScale=function(e){this.m_displacementScale=e},n.prototype.DisplacementBias=function(){return this.m_displacementBias},n.prototype.SetDisplacementBias=function(e){this.m_displacementBias=e},n.prototype.EnvMapIntensity=function(){return this.m_envMapIntensity},n.prototype.SetEnvMapIntensity=function(e){this.m_envMapIntensity=e},n.prototype.ClearCoat=function(){return this.m_clearCoat},n.prototype.SetClearCoat=function(e){this.m_clearCoat=e},n.prototype.ClearCoatRoughness=function(){return this.m_clearCoatRoughness},n.prototype.SetClearCoatRoughness=function(e){this.m_clearCoatRoughness=e},n.prototype.UseClearCoat=function(){return this.m_isUseClearCoat},n.prototype.SetUseClearCoat=function(e){this.m_isUseClearCoat=e,this.SetDefine("STANDARD",this.m_isUseClearCoat?"":"#define STANDARD\n"),this.SetNeedUpdate(!0)},n.prototype.Opacity=function(){return this.m_opacity},n.prototype.SetOpacity=function(e){this.m_opacity=e},n}(e.InnerMaterial);e.PbrMaterial=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n.m_intensity=1,n.m_lightColor=e.Color.WHITE().Clone(),n.m_ShowAllSign=!1,n.m_showSimpleSign=!0,n.m_lightType=e.LightType.LightType_Point,n}return __extends(n,t),n.prototype.FindVisiableObject=function(n){if(this.m_needUpdataSign){var r=this.GetWorldTransform().ToMatrix3x4();this.m_glworldMatrix=r.ToMatrix4().Transpose();var i=e.Vector3.ZERO();if(this.m_showSimpleSign&&!this.m_simpleSignModel){this.m_simpleSignModel=new e.ImageModel;var s=e.Parameters.Instance().appWorkPath+"\\data\\pic\\"+"point.png";this.m_simpleSignModel.SetImagePath(s),this.m_simpleSignModel.SetImageSize(i,new e.Vector2(.5,.5)),this.AddSubModel(this.m_simpleSignModel)}if(this.m_ShowAllSign){this.m_allSignModel||(this.m_allSignModel=new e.Model,this.AddSubModel(this.m_allSignModel)),this.m_allSignModel.ClearLineData();var o=n.GetScene().GetSceneBox().Length(),u=[],a=[],f=this.m_distance;for(var l=0,c=32;l<c;l++){var h=l/(c*1)*e.PI*2,p=new e.Vector3(e.Cos(h),e.Sin(h),0);u.push(p.Multiply(f)),a.push((new e.Vector3(e.Cos(h),0,e.Sin(h))).Multiply(f))}u.push((new e.Vector3(e.Cos(0),e.Sin(0),0)).Multiply(f)),a.push((new e.Vector3(e.Cos(0),0,e.Sin(0))).Multiply(f)),this.m_allSignModel.AddLineData(u),this.m_allSignModel.AddLineData(a)}this.m_needUpdataSign=!1}this.SetRenderWorldMatrix(this.m_glworldMatrix),t.prototype.FindVisiableObject.call(this,n)},n.prototype.GetType=function(){return e.ShapeType.SHAPE_LIGHT_POINT},n.prototype.Decay=function(){return this.m_decay},n.prototype.SetDecay=
function(e){this.m_decay=e},n.prototype.Distance=function(){return this.m_distance},n.prototype.SetDistance=function(e){this.m_distance=e},n}(e.BaseLight);e.PointLight=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n.m_materialType=e.MaterialType.MaterialType_Shader,n}return __extends(n,t),n.prototype.FragmentShader=function(){return this.m_fragmentShader},n.prototype.SetFragmentShader=function(e){this.m_fragmentShader=e},n.prototype.VertexShader=function(){return this.m_vertexShader},n.prototype.SetVertexShader=function(e){this.m_vertexShader=e},n.prototype.RealeseParameters=function(){for(var t in this.m_uniformPatameters){var n=this.m_uniformPatameters[t];if(n instanceof e.Texture2D){var r=n;r&&(r=null)}else if(n instanceof e.TextureCube){var r=n;r&&(r=null)}else if(!(n instanceof Number))if(n instanceof e.Vector3){var i=n;i&&(i=null)}else if(n instanceof e.Vector4){var s=n;s&&(s=null)}else n instanceof Boolean}},n}(e.BaseMaterial);e.ShaderMaterial=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n.m_intensity=1,n.m_lightColor=e.Color.WHITE().Clone(),n.m_ShowAllSign=!1,n.m_showSimpleSign=!0,n.m_lightType=e.LightType.LightType_Spot,n}return __extends(n,t),n.prototype.GetType=function(){return e.ShapeType.SHAPE_LIGHT_SPOT},n.prototype.Decay=function(){return this.m_decay},n.prototype.SetDecay=function(e){this.m_decay=e},n.prototype.Distance=function(){return this.m_distance},n.prototype.SetDistance=function(e){this.m_distance=e},n.prototype.Angle=function(){return this.m_angle},n.prototype.SetAngle=function(e){this.m_angle=e},n.prototype.Penumbra=function(){return this.m_penumbra},n.prototype.SetPenumbra=function(e){this.m_penumbra=e},n.prototype.FindVisiableObject=function(n){if(this.m_needUpdataSign){var r=this.GetWorldTransform();this.m_glworldMatrix=r.Transpose();var i=e.Vector3.ZERO().Clone();if(this.m_showSimpleSign&&!this.m_simpleSignModel){this.m_simpleSignModel=new e.ImageModel;var s=e.Parameters.Instance().appWorkPath+"\\data\\pic\\"+"spot.png";this.m_simpleSignModel.SetImagePath(s),this.m_simpleSignModel.SetImageSize(i,new e.Vector2(.5,.5)),this.AddSubModel(this.m_simpleSignModel)}if(this.m_ShowAllSign){this.m_allSignModel||(this.m_allSignModel=new e.Model,this.AddSubModel(this.m_allSignModel)),this.m_allSignModel.ClearLineData();var o=this.m_distance,u=this.m_angle,a=e.Tan(u)*o,f=[],l=i.Clone(),c=this.m_direction;c.Normalize(),f.push(l.Sub(c.Multiply(o))),f.push(l),this.m_allSignModel.AddLineData(f);var h=[];h.push(new e.Vector3(0,0,0)),h.push(new e.Vector3(e.Cos(0)*a,e.Sin(0)*a,-o)),this.m_allSignModel.AddLineData(h);var p=[];p.push(new e.Vector3(0,0,0)),p.push(new e.Vector3(e.Cos(e.HALF_PI)*a,e.Sin(e.HALF_PI)*a,-o)),this.m_allSignModel.AddLineData(p);var d=[];d.push(new e.Vector3(0,0,0)),d.push(new e.Vector3(e.Cos(e.PI)*a,e.Sin(e.PI)*a,-o)),this.m_allSignModel.AddLineData(d);var v=[];v.push(new e.Vector3(0,0,0)),v.push(new e.Vector3(e.Cos(e.HALF_PI*3)*a,e.Sin(e.HALF_PI*3)*a,-o)),this.m_allSignModel.AddLineData(v);var m=[];for(var g=0,y=32;g<y;g++){var b=g/(y*1)*e.PI*2;m.push(new e.Vector3(e.Cos(b)*a,e.Sin(b)*a,-o))}m.push(new e.Vector3(e.Cos(0)*a,e.Sin(0)*a,-o)),this.m_allSignModel.AddLineData(m)}this.m_needUpdataSign=!1}this.SetRenderWorldMatrix(this.m_glworldMatrix),t.prototype.FindVisiableObject.call(this,n)},n}(e.BaseLight);e.SpotLight=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(e){return t.call(this,e)||this}return __extends(n,t),n.prototype.AddImage=function(e){this.imageArray.length>0?this.imageArray[0]=e:this.imageArray.length===0&&this.imageArray.push(e)},n.prototype.UpdateOGLObj=function(){var t=this,n=function(n,r){t.gl.bindTexture(e.GL.TEXTURE_2D,t.texObj),t.gl.pixelStorei(t.gl.UNPACK_FLIP_Y_WEBGL,!1),t.IsUseMipMap&&(t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MIN_FILTER,t.gl.LINEAR_MIPMAP_LINEAR),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MAG_FILTER,t.gl.LINEAR)),t.gl.texImage2D(t.gl.TEXTURE_2D,0,t.textureParameter.internalrFromat,t.textureParameter.format,t.gl.UNSIGNED_BYTE,n),t.IsUseMipMap&&t.gl.generateMipmap(e.GL.TEXTURE_2D),t.isLoaded=!0};for(var r=0;r<this.imageArray.length;r++)this.imageArray[r].GetSourceMode()===e.ImageSource.FromURL?(e.ImageLoader.LoadImage(this.imageArray[r],n,r),this.resourceManager.AddOGLTexture(this.imageArray[r].GetImagePath(),this.texObj)):this.imageArray[r].GetSourceMode()===e.ImageSource.FromeZip&&e.ImageLoader.LoadImage(this.imageArray[r],n,r)},n.prototype.Init=function(){t.prototype.Init.call(this),this.texObj=this.gl.createTexture(),this.gl.bindTexture(e.GL.TEXTURE_2D,this.texObj),this.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_MAG_FILTER,this.textureParameter.filterMag),this.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_MIN_FILTER,this.textureParameter.filterMin),this.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_WRAP_S,this.textureParameter.wrapS),this.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_WRAP_T,this.textureParameter.wrapT),this.gl.bindTexture(e.GL.TEXTURE_2D,null)},n}(e.Texture);e.Texture2D=t;var n=function(t){function n(){var e=t.call(this)||this;return e.m_textures[0]=0,e}return __extends(n,t),n.prototype.GetType=function(){return e.Texture.TEXTURE_2D},n.prototype.SetTexture2DID=function(e){this.m_textures[0]=e},n.prototype.GetTexture2DID=function(){return this.m_textures[0]},n}(e.Texture);e.Texture2DPackaging=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(e){var n=t.call(this,e)||this;return n.mipArray=[],n.miplevels=1,n.texCount=0,n}return __extends(n,t),n.prototype.AddImage=function(e){if(this.imageArray.length>0)for(var t=0;t<this.imageArray.length;t++)this.imageArray[t].GetImagePath()!==e.GetImagePath()&&this.imageArray.push(e);else this.imageArray.length===0&&this.imageArray.push(e)},n.prototype.AddImages=function(e){this.mipArray.push(e)},n.prototype.UpdateOGLObj=function(){var t=this,n=function(n,r,i){i===void 0&&(i=0),t.texCount++;var s=t.gl;t.gl.bindTexture(e.GL.TEXTURE_CUBE_MAP,t.texObj),t.gl.pixelStorei(t.gl.UNPACK_FLIP_Y_WEBGL,!1),t.IsUseMipMap?(s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,s.LINEAR_MIPMAP_LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,s.LINEAR)):(t.gl.texParameteri(e.GL.TEXTURE_CUBE_MAP,e.GL.TEXTURE_MAG_FILTER,t.textureParameter.filterMag),t.gl.texParameteri(e.GL.TEXTURE_CUBE_MAP,e.GL.TEXTURE_MIN_FILTER,t.textureParameter.filterMin),t.gl.texParameteri(e.GL.TEXTURE_CUBE_MAP,e.GL.TEXTURE_WRAP_S,t.textureParameter.wrapS),t.gl.texParameteri(e.GL.TEXTURE_CUBE_MAP,e.GL.TEXTURE_WRAP_T,t.textureParameter.wrapT)),t.gl.texImage2D(t.gl.TEXTURE_CUBE_MAP_POSITIVE_X+r,i,t.textureParameter.internalrFromat,t.textureParameter.format,t.gl.UNSIGNED_BYTE,n),t.texCount===6*t.miplevels&&(t.IsUseMipMap&&(t.gl.generateMipmap(e.GL.TEXTURE_CUBE_MAP),s.bindTexture(s.TEXTURE_2D,null)),t.isLoaded=!0,t.texCount=0)};for(var r=0;r<this.mipArray.length;r++){this.miplevels=this.mipArray.length;var i=this.mipArray[r];for(var s=0;s<i.length;s++)i[s].GetSourceMode()===e.ImageSource.FromURL&&e.ImageLoader.LoadImage(i[s],n,s,r)}},n.prototype.Init=function(){this.texObj=this.gl.createTexture()},n}(e.Texture);e.TextureCube=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(e){var n=t.call(this,e)||this;return n.width=512,n.height=512,n}return __extends(n,t),n.prototype.UpdateOGLObj=function(){var t=this;t.gl.bindTexture(e.GL.TEXTURE_2D,t.texObj),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.textureParameter.internalrFromat,this.width,this.height,0,this.textureParameter.format,this.gl.UNSIGNED_BYTE,null),t.isLoaded=!0},n.prototype.Init=function(){this.texObj=this.gl.createTexture(),this.gl.bindTexture(e.GL.TEXTURE_2D,this.texObj),this.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_MAG_FILTER,this.textureParameter.filterMag),this.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_MIN_FILTER,this.textureParameter.filterMin),this.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_WRAP_S,e.GL.CLAMP_TO_EDGE),this.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_WRAP_T,e.GL.CLAMP_TO_EDGE),this.gl.bindTexture(e.GL.TEXTURE_2D,null)},n.prototype.setSize=function(e,t){this.width=e,this.height=t},n.prototype.bind=function(){this.texObj||console.warn("Texture object is null"),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texObj)},n.prototype.unbind=function(){this.gl.bindTexture(this.gl.TEXTURE_2D,null)},n}(e.Texture);e.TextureTarget=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){this.worldMatrix=e.Matrix3x4.IDENTITY().Clone(),this.glRenderMatrix=e.Matrix4.IDENTITY().Clone(),this.plcMatrix=e.Matrix3x4.IDENTITY().Clone(),this.oldPlcMatrix=e.Matrix3x4.IDENTITY().Clone(),this.position=new e.Vector3,this.oldPosition=new e.Vector3,this.rotation=new e.Quaternion,this.oldRotation=new e.Quaternion,this.scale=e.Vector3.ONE().Clone(),this.oldScale=e.Vector3.ONE().Clone(),this.pParent=null,this.bdBox=new e.BoundingBox,this.worldBox=new e.BoundingBox,this.pParent=null,this.strNodeName="NONAME",this.position.ToZero(),this.rotation.ToZero(),this.scale.ToOne(),this.oldPosition=this.position,this.oldRotation=this.rotation,this.oldScale=this.scale,this.m_bVisible=!0,this.cullerState=e.Camera.FRUSTUINER,this.ID=e.IDCreator.GetDefaultID(),this.MarkDirty()}return t.prototype.Traverse=function(e){if(e.IsFinish())return;e.Apply(this)},t.prototype.Reset=function(){this.position=this.oldPosition.Clone(),this.scale=this.oldScale.Clone(),this.rotation=this.oldRotation.Clone(),this.plcMatrix=this.oldPlcMatrix.Clone(),this.worldMatrix=e.Matrix3x4.IDENTITY().Clone(),this.MarkDirty()},t.prototype.Search=function(t){var n=null,r=new e.SearchAction(null),i=function(e,n){return t===e.strNodeName?!0:!1};return r.SetCompare(i),this.Traverse(r),r.result.length>0&&(n=r.result[0]),n},t.prototype.SetID=function(e){this.ID=e},t.prototype.GetID=function(){return this.ID},t.prototype.GetType=function(){return e.SCENE_NODE},t.prototype.SetName=function(e){this.strNodeName=e},t.prototype.GetName=function(){return this.strNodeName},t.prototype.GetOldPosition=function(){return this.oldPosition},t.prototype.GetOldRotation=function(){return this.oldRotation},t.prototype.SetScale=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];typeof t[0]=="number"?t[0]>.001&&(this.scale=this.scale.Divide(t[0]),this.oldScale=this.scale):t[0]instanceof e.Vector3&&(this.scale=t[0].Abs(),this.MarkDirty())},t.prototype.ResetMovement=function(){this.position.ToZero(),this.rotation.ToZero(),this.plcMatrix=this.oldPlcMatrix.Clone()},t.prototype.SetPlcMatrix=function(e){this.plcMatrix=e.Clone(),this.MarkDirty()},t.prototype.SetOrigPlcMatrix=function(e){this.plcMatrix=e.Clone(),this.oldPlcMatrix=this.plcMatrix.Clone(),this.MarkDirty()},t.prototype.GetOrigPlcMartirx=function(){return this.oldPlcMatrix},t.prototype.IsVisible=function(){return this.m_bVisible},t.prototype.SetVisible=function(e){this.m_bVisible=e},t.prototype.GetBoundingBox=function(){return this.ComputeBox(),this.bdBox},t.prototype.GetWorldBoundingBox=function(){if(!this.worldBox.Defined()){var e=this.GetBoundingBox().Clone();e.Defined()&&(e.Transform(this.GetWorldTransform()),this.worldBox=e)}return this.worldBox},t.prototype.SetBoundingBox=function(e){this.bdBox=e},t.prototype.RayPick=function(e){},t.prototype.ComputeBox=function(){if(!this.bdBox.Defined()){var e=this.GetShape();if(e!=null){var t=e.GetBoundingBox();t.Defined()&&(this.bdBox=t)}}},t.prototype.GetShape=function(){return this.shape},t.prototype.SetCullerState=function(e){this.cullerState=e},t.prototype.GetCullerState=function(){return this.cullerState},t.prototype.GetPickType=function(){return 0},t.prototype.GetParent=function(){return this.pParent},t.prototype.SetParent=function(e){this.pParent=e},t.prototype.SetLocalTransform=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t[0]instanceof e.Matrix4){var r=t[0],i=this.GetPlcMatrix().Inverse().Multiply(r);this.SetTransform(i.Translation(),i.Rotation(),i.Scale()),this.MarkDirty()}else{if(!(t[0]instanceof e.Matrix3x4))return null;var r=t[0],i=this.GetPlcMatrix().Inverse().Multiply(r);this.SetTransform(i.Translation(),i.Rotation(),i.Scale()),this.MarkDirty()}},t.prototype.GetLocalTransform=function(){return this.GetPlcMatrix().Multiply(this.GetTransform())},t.prototype.GetTransform=function(){return new e.Matrix3x4(this.position,this.rotation,this.scale)},t.prototype.SetWorldTransform=function(t){var n=new e.Matrix3x4;this.pParent===null?n=t:n=this.pParent.GetWorldTransform().Inverse().Multiply(t),this.SetLocalTransform(n)},t.prototype.GetWorldTransform=function(){return this.IsDirty()&&this.UpdateWorldTransform(),this.worldMatrix},t.prototype.GetGLWorldTransform=function(){return this.GetWorldTransform(),this.glRenderMatrix},t.prototype.UpdateWorldTransform=function(){var e=this.GetLocalTransform();this.pParent===null?this.worldMatrix=e:this.worldMatrix=this.pParent.GetWorldTransform().Multiply(e),this.glRenderMatrix=this.worldMatrix.ToMatrix4().Transpose(),this.dirty=!1},t.prototype.FindVisiableObject=function(e){},t.prototype.GetPlcMatrix=function(){return this.plcMatrix},t.prototype.GetPosition=function(){return this.position},t.prototype.SetPosition=function(e){this.position=e,this.MarkDirty()},t.prototype.GetRotation=function(){return this.rotation},t.prototype.SetRotation=function(e){this.rotation=e,this.MarkDirty()},t.prototype.GetDirection=function(){return this.rotation.Multiply(e.Vector3.FORWARD())},t.prototype.SetDirection=function(t){this.SetRotation(new e.Quaternion(e.Vector3.FORWARD(),t))},t.prototype.SetTransform=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length===2)this.position=t[0],this.rotation=t[1];else if(t.length===3)if(t[2]instanceof Number){var r=t[0],i=t[1],s=t[2];this.SetTransform(r,i,new e.Vector3(s,s,s))}else if(t[2]instanceof e.Vector3){var r=t[0],i=t[1],s=t[2];this.position=r,this.rotation=i,this.scale=s}this.MarkDirty()},t.prototype.GetWorldRotation=function(){return this.dirty&&this.UpdateWorldTransform(),this.worldMatrix.Rotation()},t.prototype.GetWorldDirection=function(){return this.dirty&&this.UpdateWorldTransform(),this.worldMatrix.Rotation().Multiply(e.Vector3.FORWARD().Clone())},t.prototype.GetWorldPosition=function(){return this.dirty&&this.UpdateWorldTransform(),this.worldMatrix.Translation()},t.prototype.SetWorldPosition=function(e){var t=this.pParent===null?e:this.pParent.GetWorldTransform().Inverse().Multiply(e);this.SetPosition(t)},t.prototype.SetWorldRotation=function(e){this.SetRotation(this.pParent===null?e:this.pParent.GetWorldRotation().Inverse().MultiplyED(e))},t.prototype.SetWorldDirection=function(t){var n=this.pParent===null?t:this.pParent.GetWorldRotation().Inverse().Multiply(t);this.SetRotation(new e.Quaternion(e.Vector3.FORWARD(),n))},t.prototype.SetWorldScale=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length===1)if(t[0]instanceof e.Vector3){var r=t[0];this.SetScale(this.pParent===null?r:r.Divide(this.pParent.GetWorldScale()))}else{var r=t[0];this.SetWorldScale(new e.Vector3(r,r,r))}},t.prototype.GetWorldScale=function(){return this.IsDirty()&&this.UpdateWorldTransform(),this.worldMatrix.Scale()},t.prototype.Translate=function(e,n){switch(n){case t.TS_LOCAL:this.position.AddED(this.rotation.Multiply(e));break;case t.TS_PARENT:this.position.AddED(e);break;case t.TS_WORLD:this.position.AddED(this.pParent===null?e:this.pParent.GetWorldTransform().Inverse().Multiply(e))}this.MarkDirty()},t.prototype.Rotate=function(e,n){n===void 0&&(n=t.TS_LOCAL);switch(n){case t.TS_LOCAL:this.rotation=this.rotation.Multiply(e).Normalized();break;case t.TS_PARENT:this.rotation=e.Multiply(this.rotation).Normalized();break;case t.TS_WORLD:if(this.pParent===null)this.rotation=e.Multiply(this.rotation).Normalized();else{var r=this.GetWorldRotation();this.rotation=this.rotation.Multiply(r.Inverse()).Multiply(e).Multiply(r).Clone()}}this.MarkDirty()},t.prototype.RotateAround=function(n,r,i){var s=new e.Vector3,o=this.rotation.Clone();switch(i){case t.TS_LOCAL:s=this.GetTransform().Multiply(n),this.rotation=this.rotation.Multiply(r).Normalized();break;case t.TS_PARENT:s=n.Clone(),this.rotation=r.Multiply(this.rotation).Normalized();break;case t.TS_WORLD:if(this.pParent===null)s=n.Clone(),this.rotation=r.Multiply(this.rotation).Normalized();else{s=this.pParent.GetWorldTransform().Inverse().Multiply(n);var u=this.GetWorldRotation();this.rotation=this.rotation.Multiply(u.Inverse()).Multiply(r).Multiply(u)}}var a=o.Inverse().Multiply(this.position.Sub(s));this.position=this.rotation.Multiply(a).AddED(s),this.MarkDirty()},t.prototype.Yaw=function(t,n){this.Rotate(new e.Quaternion(t,e.Vector3.UP()),n)},t.prototype.Pitch=function(t,n){this.Rotate(new e.Quaternion(t,e.Vector3.RIGHT()),n)},t.prototype.Roll=function(t,n){this.Rotate(new e.Quaternion(t,e.Vector3.FORWARD()),n)},t.prototype.LookAt=function(n,r,i){var s=new e.Vector3;switch(i){case t.TS_LOCAL:s=this.GetWorldTransform().Multiply(n);break;case t.TS_PARENT:s=this.pParent===null?n.Clone():this.pParent.GetWorldTransform().Multiply(n);break;case t.TS_WORLD:s=n.Clone()}var o=s.Sub(this.GetWorldPosition());if(o.Equals(e.Vector3.ZERO().Clone()))return!1;var u=new e.Quaternion;return u.FromLookRotation(o,r)?(this.SetWorldRotation(u),!0):!1},t.prototype.Scale=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length===1)if(t instanceof e.Vector3){var r=t[0];this.scale.Multiply(r),this.MarkDirty()}else{var r=t[0];this.Scale(new e.Vector3(r,r,r))}},t.prototype.MarkDirty=function(){this.dirty=!0,this.worldBox.Clear(),this.OnMarkedDirty()},t.prototype.IsDirty=function(){return this.dirty},t.prototype.OnMarkedDirty=function(){},t.prototype.LocalToWorld=function(e){return this.GetWorldTransform().Multiply(e)},t.prototype.WorldToLocal=function(e){return this.GetWorldTransform().Inverse().Multiply(e)},t.prototype.UpdateName=function(){return!1},t.TS_LOCAL=0,t.TS_PARENT=1,t.TS_WORLD=2,t}();e.SceneNode=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var e=t.call(this)||this;return e.pChildrenList=[],e}return __extends(n,t),n.prototype.GetType=function(){return e.GROUP_NODE},n.prototype.Traverse=function(e){if(e.IsFinish())return;e.Apply(this);for(var t=0,n=this.pChildrenList;t<n.length;t++){var r=n[t];r.Traverse(e)}},n.prototype.Size=function(){return this.pChildrenList.length},n.prototype.GetChild=function(e){return this.pChildrenList[e]},n.prototype.GetChildren=function(){return this.pChildrenList},n.prototype.AddChild=function(e){e!==null&&(e.SetParent(this),this.pChildrenList.push(e))},n.prototype.RayPick=function(e){for(var t=0,n=this.pChildrenList;t<n.length;t++){var r=n[t];r.RayPick(e)}},n.prototype.FindVisiableObject=function(e){if(this.IsVisible())for(var t=0,n=this.pChildrenList;t<n.length;t++){var r=n[t];r.FindVisiableObject(e)}},n.prototype.OnMarkedDirty=function(){if(this.pChildrenList)for(var e=0;e<this.pChildrenList.length;e++){var t=this.pChildrenList[e];t.MarkDirty()}},n.prototype.DeleteAllChildren=function(){this.pChildrenList=[]},n.prototype.DeleteChild=function(t){if(t==null)return;(this.pChildrenList.length!==0||this.pChildrenList!==null)&&e.ArrayHelper.RemoveByValue(this.pChildrenList,t)},n.prototype.UpdateName=function(){for(var e=0;e<this.pChildrenList.length;e++)this.pChildrenList[e].UpdateName();return!0},n.prototype.DetachChild=function(e){if(e==null)return;if(this.pChildrenList!==null)for(var t=0;t<this.pChildrenList.length;t++)this.pChildrenList[t]===e&&(e.SetParent(null),this.pChildrenList.splice(t,1))},n}(e.SceneNode);e.GroupNode=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){this._nearPoint=new e.Vector3,this._farPoint=new e.Vector3,this._eyeDir=new e.Vector3(0,0,1)}return t.prototype.reset=function(){this.setCamera(null),this._pickDragger=null},t.prototype.setNearFarPoints=function(e,t){this._nearPoint=e,this._farPoint=t,this._eyeDir=t.Sub(e).Clone()},t.prototype.getNearFarPoints=function(){return[this._nearPoint.Clone(),this._farPoint.Clone()]},t.prototype.contains=function(e){return this._pickDragger==e},t.prototype.setCamera=function(t){if(t){this.m_camera=t;var n=new e.Vector3,r=new e.Vector3,i=new e.Vector3,s=t.GetView().GetLookAt(n,r,i,1);n=s[0],r=s[1],this._eyeDir=n.Sub(r).Clone()}else this._eyeDir=e.Vector3.FORWARD().Clone()},t.prototype.setIntersection=function(e,t){this._pickDragger=e,this._intersectPoint=t;var n=this._pickDragger.GetWorldTransform();this._LocalIntersectPoint=n.Inverse().Multiply(t)},t.prototype.setMousePosition=function(t,n){this.projectWindowXYIntoObject(new e.Vector2(t,n),this._nearPoint,this._farPoint)},t.prototype.projectWindowXYIntoObject=function(e,t,n){if(this.m_camera){var r=this.m_camera,i=r.GetViewPort();this._nearPoint=i.ScreenToWorldPoint(e.x,e.y,0),this._farPoint=i.ScreenToWorldPoint(e.x,e.y,1)}return!0},t.prototype.getEyeDir=function(){return this._eyeDir.Clone()},t.prototype.getLocalIntersectPoint=function(){return this._LocalIntersectPoint},t.prototype.setLocalIntersectPoint=function(e){this._LocalIntersectPoint=e},t}();e.PointerInfo=t;var n=function(n){function r(){var e=n.call(this)||this;return e._parentDragger=e,e._draggerCallbacks=new Array,e._pointer=new t,e._selfUpdater=new i(e),e.preSelected=!1,e._handleEvents=!1,e._draggerActive=!1,e._activationModKeyMask=0,e._activationKeyEvent=0,e._activationPermittedByModKeyMask=!1,e._activationPermittedByKeyEvent=!1,e}return __extends(r,n),r.prototype.setParentDragger=function(e){this._parentDragger=e},r.prototype.getParentDragger=function(){return this._parentDragger},r.prototype.getComposite=function(){return null},r.prototype.setActivationModKeyMask=function(e){this._activationModKeyMask=e},r.prototype.getActivationModKeyMask=function(){return this._activationModKeyMask},r.prototype.setActivationKeyEvent=function(e){this._activationKeyEvent=e},r.prototype.getActivationKeyEvent=function(){return this._activationKeyEvent},r.prototype.getDraggerCallbacks=function(){return this._draggerCallbacks},r.prototype.setDraggerActive=function(e){this._draggerActive=e},r.prototype.getDraggerActive=function(){return this._draggerActive},r.prototype.GetScene=function(){return this._scene},r.prototype.SetScene=function(e){this._scene=e},r.prototype.GetOrigScale=function(){return this._OrigScale},r.prototype.GetNeedScale=function(){return this._needScale},r.prototype.SetNeedScale=function(e){this._needScale=e},r.prototype.GetPreSelectColor=function(){return this._PreSelectColor},r.prototype.SetPreSelectColor=function(e){this._PreSelectColor=e},r.prototype.setColor=function(e){this._color=e},r.prototype.SetVisible=function(e){n.prototype.SetVisible.call(this,e),this.SetNeedScale(!0)},r.prototype.getColor=function(){return this._color},r.prototype.setPickColor=function(e){this._pickColor=e},r.prototype.getPickColor=function(){return this._pickColor},r.prototype.GetPreSelected=function(){return this.preSelected},r.prototype.SetPreSelected=function(e){this.preSelected=e},r.prototype.ClearDraggerCallbacks=function(){for(var e=0;e<this._draggerCallbacks.length;e++)this._draggerCallbacks[e]=null;this._draggerCallbacks=new Array},r.prototype.addDraggerCallback=function(e){for(var t=0;t<this._draggerCallbacks.length;t++){var n=this._draggerCallbacks[t];if(e==n)return}this._draggerCallbacks.push(e)},r.prototype.removeDraggerCallback=function(e){for(var t=0;t<this._draggerCallbacks.length;t++){var n=this._draggerCallbacks[t];if(e==n){this._draggerCallbacks.splice(t,1);return}}},r.prototype.handle=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length==2)return!1;var i=t[0];for(var s=0;s<this.Size();s++){var o=this.GetChild(s);o&&o instanceof r&&o.handle(i)}if(i.getHandled())return!1;var u=i.GetView();if(!u)return!1;var a=!1,f=!0;if(f||this._draggerActive){switch(i.getEventType()){case e.EventType.PUSH:this._pointer.reset();var l=this.GetPickDragger(u,i,this._pointer);if(l&&l==this){var c=u.GetSceneManager().GetCamera();this._pointer.setCamera(c),this._pointer.setMousePosition(i.getX(),i.getY()),l.handle(this._pointer,i),l.setDraggerActive(!0),a=!0};case e.EventType.DRAG:case e.EventType.RELEASE:this._draggerActive&&(this._pointer.setMousePosition(i.getX(),i.getY()),this.handle(this._pointer,i),a=!0);break;default:}this._draggerActive&&i.getEventType()==e.EventType.RELEASE&&(this.setDraggerActive(!1),this._pointer.reset())}return a&&i.setHandled(a),a},r.prototype.SetPreSelect=function(e){},r.prototype.receive=function(e){return this._selfUpdater!=null?this._selfUpdater.receive(e):!1},r.prototype.dispatch=function(e){var t=this.getParentDragger();if(t){t.receive(e);for(var n=0;n<t.getDraggerCallbacks().length;n++){var r=t.getDraggerCallbacks()[n];r.receive(e)}}},r.prototype.GetPickDragger=function(t,n,r){var i=null,s=t.GetSceneManager(),o=new e.RayPickAction(s);o.SetPickShapeType(e.ShapeType.SHAPE_MODEL),o.SetPickGeoType(0),o.SetInterctType(1),o.SetRay(n.getX(),n.getY()),o.SetUseclipPlane(!1);var u=t.GetSceneManager().GetHandlerGroup();u.RayPick(o);var a=o.GetNearPickShape();if(a&&a.GetType()==e.ShapeType.SHAPE_MODEL){var f=a,l=f.GetUserData();i=l,r.setIntersection(i,o.GetNearestPickPoint())}return o=null,i},r.prototype.SetOrigScale=function(e){this._OrigScale=e,this.SetScale(this._OrigScale)},r.prototype.FindVisiableObject=function(e){this._drawModel&&(this.getDraggerActive()?this._drawModel.SetColor(this.getPickColor()):this.GetPreSelected()?this._drawModel.SetColor(this.GetPreSelectColor()):this._drawModel.SetColor(this.getColor())),n.prototype.FindVisiableObject.call(this,e)},r}(e.GroupNode);e.Dragger=n;var r=function(){function t(){}return t.prototype.receive=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];var r=t[0];r instanceof e.MotionCommand&&this.receive(r)},t}();e.DraggerCallback=r;var i=function(t){function n(){var e=[];for(var n=0;n<arguments.length;n++)e[n]=arguments[n];var r=t.call(this)||this;return e.length==1?r.SetDragger(e[0]):r.SetDragger(null),r}return __extends(n,t),n.prototype.receive=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];var r=t[0];if(r.getStage()==e.Stage.MOVE){if(r instanceof e.TranslateInLineCommand){if(this.m_dragger){var i=r.getTranslation();i=r.getLocalToWorld().Multiply(new e.Vector4(i,0)),this.m_dragger.Translate(i,e.SceneNode.TS_WORLD)}return!0}if(r instanceof e.TranslateInPlaneCommand){if(this.m_dragger){var i=r.getTranslation();i=r.getLocalToWorld().Multiply(new e.Vector4(i,0)),this.m_dragger.Translate(i,e.SceneNode.TS_WORLD)}return!0}if(r instanceof e.Scale1DCommand){if(this.m_dragger){var i=r.getTranslation();i=r.getLocalToWorld().Multiply(new e.Vector4(i,0))}}else if(r instanceof e.Scale2DCommand){if(this.m_dragger){var i=r.getTranslation();i=r.getLocalToWorld().Multiply(new e.Vector4(i,0))}}else if(r instanceof e.ScaleUniformCommand){if(this.m_dragger){var i=r.getTranslation();i=r.getLocalToWorld().Multiply(new e.Vector4(i,0))}}else if(r instanceof e.Rotate3DCommand&&this.m_dragger){var s=r.getDeltaRotation();s=r.getLocalToWorld().Rotation().Multiply(s).Multiply(r.getLocalToWorld().Rotation().Inverse()).Clone(),this.m_dragger.Rotate(s,e.SceneNode.TS_WORLD)}}return!1},n.prototype.SetDragger=function(e){this.m_dragger=e},n.prototype.GetDragger=function(){return this.m_dragger},n}(r);e.DraggerTransformCallback=i;var s=function(e){function t(){var t=e.call(this)||this;return t._draggerList=new Array,t}return __extends(t,e),t.prototype.getComposite=function(){return this},t.prototype.getDragger=function(e){return this._draggerList[e]},t.prototype.handle=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length==1){e.prototype.handle.call(this,t[0]);return}var r=t[0],i=t[1],s=this;if(!r.contains(s))return!1;for(var o=0;o<this._draggerList.length;o++){var u=this._draggerList[o];if(u.handle(r,i))return!0}return!1},t.prototype.containsDragger=function(e){for(var t=0;t<this._draggerList.length;t++)if(this._draggerList[t]==e)return!0;return!1},t.prototype.findDragger=function(e){for(var t=0;t<this._draggerList.length;t++)if(this._draggerList[t]==e)return this._draggerList[t];return this._draggerList[this._draggerList.length-1]},t.prototype.CompositeDragger=function(){},t.prototype.addDragger=function(e){return e&&!this.containsDragger(e)?(this._draggerList.push(e),!0):!1},t.prototype.removeDragger=function(e){for(var t=0;t<this._draggerList.length;t++)if(this._draggerList[t]==e&&t!==this._draggerList.length-1)return this._draggerList.splice(t,1),!0;return!1},t.prototype.setParentDragger=function(t){for(var n=0;n<this._draggerList.length;n++){var r=this._draggerList[n];r.setParentDragger(t)}e.prototype.setParentDragger.call(this,t)},t}(n);e.CompositeDragger=s})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var e=t.call(this)||this;return e.m_draggerModels=new Array,e}return __extends(n,t),n.prototype.receive=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];var r=t[0];if(r.getStage()==e.Stage.MOVE){if(r instanceof e.TranslateInLineCommand){if(this.m_draggerModels.length){var i=r.getTranslation();i=r.getLocalToWorld().Multiply(new e.Vector4(i,0));for(var s=0;s<this.m_draggerModels.length;s++){var o=this.m_draggerModels[s];e.ModelTransformHelper.TranslateModel(o,i)}}return!0}if(r instanceof e.TranslateInPlaneCommand){if(this.m_draggerModels.length){var i=r.getTranslation();i=r.getLocalToWorld().Multiply(new e.Vector4(i,0));for(var s=0;s<this.m_draggerModels.length;s++){var o=this.m_draggerModels[s];e.ModelTransformHelper.TranslateModel(o,i)}}return!0}if(r instanceof e.Scale1DCommand){if(this.m_draggerModels.length){var u=new e.Vector3(r.getDeltaScale(),0,0);u=r.getLocalToWorld().Rotation().Multiply(u).Add(new e.Vector3(1,1,1)).Clone();for(var s=0;s<this.m_draggerModels.length;s++){var o=this.m_draggerModels[s];e.ModelTransformHelper.ScaleModel(o,u)}}return!0}if(r instanceof e.Scale2DCommand){if(this.m_draggerModels.length){var a=r.getDeltaScale(),u=new e.Vector3(a.x,a.y,0);u=r.getLocalToWorld().Rotation().Multiply(u).Add(new e.Vector3(1,1,1)).Clone();for(var s=0;s<this.m_draggerModels.length;s++){var o=this.m_draggerModels[s];e.ModelTransformHelper.ScaleModel(o,u)}}return!0}if(r instanceof e.ScaleUniformCommand){if(this.m_draggerModels.length){var f=r.getDeltaScale(),u=new e.Vector3(f,f,f);u=r.getLocalToWorld().Rotation().Multiply(u).Add(new e.Vector3(1,1,1)).Clone();for(var s=0;s<this.m_draggerModels.length;s++){var o=this.m_draggerModels[s];e.ModelTransformHelper.ScaleModel(o,u)}}return!0}if(r instanceof e.Rotate3DCommand){if(this.m_draggerModels.length){var l=r.getDeltaRotation();l=r.getLocalToWorld().Rotation().Multiply(l).Multiply(r.getLocalToWorld().Rotation().Inverse()).Clone();for(var s=0;s<this.m_draggerModels.length;s++){var o=this.m_draggerModels[s];e.ModelTransformHelper.RotateModel(o,l)}}return!0}}},n.prototype.AddModel=function(e){for(var t=0;t<this.m_draggerModels.length;t++)if(this.m_draggerModels[t]==e)return!1;return this.m_draggerModels.push(e),!0},n.prototype.AddModels=function(e){for(var t=0;t<e.length;t++)this.AddModel(e[t])},n.prototype.ClearModel=function(){for(var e=0;e<this.m_draggerModels.length;e++)this.m_draggerModels[e]=null;this.m_draggerModels=new Array},n}(e.DraggerCallback);e.ModelDraggerCallback=t;var n=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.receive=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];var r=t[0];if(r.getStage()==e.Stage.MOVE){if(r instanceof e.TranslateInLineCommand){if(this.m_draggerNodes.length){var i=r.getTranslation();i=r.getLocalToWorld().Multiply(new e.Vector4(i,0));for(var s=0;s<this.m_draggerNodes.length;s++){var o=this.m_draggerNodes[s];o.Translate(i,e.SceneNode.TS_WORLD)}}return!0}if(r instanceof e.TranslateInPlaneCommand){if(this.m_draggerNodes.length){var i=r.getTranslation();i=r.getLocalToWorld().Multiply(new e.Vector4(i,0));for(var s=0;s<this.m_draggerNodes.length;s++){var o=this.m_draggerNodes[s];o.Translate(i,e.SceneNode.TS_WORLD)}}return!0}if(r instanceof e.Scale1DCommand){if(this.m_draggerNodes.length){var u=new e.Vector3(r.getDeltaScale(),0,0);u=r.getLocalToWorld().Rotation().Multiply(u).Add(new e.Vector3(1,1,1)).Clone();for(var s=0;s<this.m_draggerNodes.length;s++){var o=this.m_draggerNodes[s];o.Scale(u)}}return!0}if(r instanceof e.Scale2DCommand){if(this.m_draggerNodes.length){var a=r.getDeltaScale(),u=new e.Vector3(a.x,a.y,0);u=r.getLocalToWorld().Rotation().Multiply(u).Add(new e.Vector3(1,1,1)).Clone();for(var s=0;s<this.m_draggerNodes
.length;s++){var o=this.m_draggerNodes[s];o.Scale(u)}}return!0}if(r instanceof e.ScaleUniformCommand){if(this.m_draggerNodes.length){var f=r.getDeltaScale(),u=new e.Vector3(f,f,f);u=r.getLocalToWorld().Rotation().Multiply(u).Add(new e.Vector3(1,1,1)).Clone();for(var s=0;s<this.m_draggerNodes.length;s++){var o=this.m_draggerNodes[s];o.Scale(u)}}return!0}if(r instanceof e.Rotate3DCommand){if(this.m_draggerNodes.length){var l=r.getDeltaRotation();l=r.getLocalToWorld().Rotation().Multiply(l).Multiply(r.getLocalToWorld().Rotation().Inverse()).Clone();for(var s=0;s<this.m_draggerNodes.length;s++){var o=this.m_draggerNodes[s];o.Rotate(l,e.SceneNode.TS_WORLD)}}return!0}}},n.prototype.AddNode=function(e){for(var t=0;t<this.m_draggerNodes.length;t++)if(this.m_draggerNodes[t]==e)return!1;return this.m_draggerNodes.push(e),!0},n.prototype.AddNodes=function(e){for(var t=0;t<e.length;t++)this.AddNode(e[t])},n.prototype.ClearNodes=function(){for(var e=0;e<this.m_draggerNodes.length;e++)this.m_draggerNodes[e]=null;this.m_draggerNodes=new Array},n}(e.DraggerCallback);e.SceneNodeDraggerCallback=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];e.length==1&&(this.m_view=e[0])}return t.prototype.GetCommandHistoryManager=function(){return this.m_commandHistoryManager},t.prototype.BindDragger=function(e,t){var n=null;switch(t){case 1:n=this.BindAxisDragger(e);break;case 2:n=this.BindRotateDragger(e);break;case 3:n=this.BindScaleDragger(e);break;default:}return n},t.prototype.UnBindDragger=function(e){return e&&(e.ClearDraggerCallbacks(),e.SetVisible(!1)),!0},t.prototype.BindSectionDragger=function(e){var t=null;switch(e){case 1:t=this.BindSectionAxisDragger();break;case 2:t=this.BindSectionRotateDragger();break;default:}return t},t.prototype.BindAxisDragger=function(t){var n=null,r=t.GetWorldBoundingBox().Center().Clone();if(this.m_view){n=this.m_view.GetSceneManager().GetHandlerGroup().GetTransformHandler(),n.SetName("TranslateAxisDragger"),n.SetVisible(!0),n.SetWorldPosition(r);var i=new e.ModelDraggerCallback;i.AddModel(t),n.addDraggerCallback(i)}return n},t.prototype.BindScaleDragger=function(t){var n=null,r=t.GetWorldBoundingBox().Center().Clone();if(this.m_view){n=this.m_view.GetSceneManager().GetHandlerGroup().GetScaleAxisDragger(),n.SetName("TranslateAxisDragger"),n.SetVisible(!0),n.SetWorldPosition(r);var i=new e.ModelDraggerCallback;i.AddModel(t),n.addDraggerCallback(i)}return n},t.prototype.BindRotateDragger=function(t){var n=null,r=t.GetWorldBoundingBox().Center();if(this.m_view){n=this.m_view.GetSceneManager().GetHandlerGroup().GetRotateCylinderAxisDragger(),n.SetName("TranslateAxisDragger"),n.SetVisible(!0),n.SetWorldPosition(r);var i=new e.ModelDraggerCallback;i.AddModel(t),n.addDraggerCallback(i)}return n},t.prototype.BindSectionAxisDragger=function(){var t=null,n=this.m_view.GetSceneManager(),r=n.GetSceneBox().Center();if(this.m_view){t=this.m_view.GetSceneManager().GetHandlerGroup().GetTransformHandler(),t.SetName("TranslateAxisDragger"),t.SetVisible(!0),t.SetWorldPosition(r);var i=new e.SceneNodeDraggerCallback,s=n.GetSectionNode();i.AddNode(s),t.addDraggerCallback(i)}return t},t.prototype.BindSectionRotateDragger=function(){var t=null,n=this.m_view.GetSceneManager(),r=n.GetSceneBox().Center();if(this.m_view){t=this.m_view.GetSceneManager().GetHandlerGroup().GetRotateCylinderAxisDragger(),t.SetName("TranslateAxisDragger"),t.SetVisible(!0),t.SetWorldPosition(r);var i=new e.SceneNodeDraggerCallback,s=n.GetSectionNode();i.AddNode(s),t.addDraggerCallback(i)}return t},t}();e.DraggerManager=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n.renderWorldMatrix=null,n.Mesh=null,n.SetAlloewExculding(!1),n.SetType(e.ShapeType.SHAPE_HANDLE),n.SetMesh(null),n}return __extends(n,t),n.prototype.SetRenderWorldMatrix=function(e){this.renderWorldMatrix=e.Clone()},n.prototype.GetRenderWorldMatrix=function(){return this.renderWorldMatrix},n.prototype.GetRenderColor=function(){return this.GetDrawColor()},n.prototype.GetRenderMaterial=function(){return null},n.prototype.SetRenderMesh=function(e){},n.prototype.GetDataLength=function(){return-1},n.prototype.IsUseIndex=function(){return!1},n.prototype.SetIndexOffset=function(e){},n.prototype.GetIndexOffset=function(){return-1},n.prototype.SetNormalOffset=function(e){},n.prototype.GetNormalOffset=function(){return-1},n.prototype.SetVertexOffset=function(e){},n.prototype.GetVertexOffset=function(){return-1},n.prototype.SetTextureCoordsOffset=function(e){},n.prototype.GetTextureCoordsOffset=function(){return-1},n.prototype.SetCentersCoordsOffset=function(e){},n.prototype.GetCentersCoordsOffset=function(){return-1},n.prototype.GetHardWareVertexBuffer=function(){return null},n.prototype.GetHardWareIndexBuffer=function(){return null},n.prototype.ComputeBox=function(){this.BoundingBox.Clear();if(!this.BoundingBox.Defined()){var t=new e.BoundingBox;this.BoundingBox=t.Clone();var n=this.Mesh;n!==null&&n.GetBoundingBox().Defined()&&(t=n.GetBoundingBox(),this.BoundingBox=t.Clone())}},n.prototype.RayPick=function(e){},n.prototype.FindVisiableObject=function(e){},n.prototype.GetWorldTransform=function(){var e=this.GetSceneNode(),t=this.ComputeTransform().Clone();if(e){var n=this.GetSceneNode().GetWorldTransform();t=n.Multiply(t)}return t},n.prototype.SetMesh=function(e){this.Mesh=e},n.prototype.GetMesh=function(){return this.Mesh},n.prototype.ComputeTransform=function(){return e.Matrix3x4.IDENTITY().Clone()},n}(e.Shape);e.Handler=t;var n;(function(e){e[e.NONE=0]="NONE",e[e.PUSH=1]="PUSH",e[e.RELEASE=2]="RELEASE",e[e.DOUBLECLICK=4]="DOUBLECLICK",e[e.DRAG=8]="DRAG",e[e.MOVE=16]="MOVE",e[e.KEYDOWN=32]="KEYDOWN",e[e.KEYUP=64]="KEYUP",e[e.FRAME=128]="FRAME",e[e.RESIZE=256]="RESIZE",e[e.SCROLL=512]="SCROLL",e[e.PEN_PRESSURE=1024]="PEN_PRESSURE",e[e.PEN_ORIENTATION=2048]="PEN_ORIENTATION",e[e.PEN_PROXIMITY_ENTER=4096]="PEN_PROXIMITY_ENTER",e[e.PEN_PROXIMITY_LEAVE=8192]="PEN_PROXIMITY_LEAVE",e[e.CLOSE_WINDOW=16384]="CLOSE_WINDOW",e[e.QUIT_APPLICATION=32768]="QUIT_APPLICATION",e[e.USER=65536]="USER"})(n=e.EventType||(e.EventType={}));var r=function(){function e(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];e.length==2?(this.touchPoints=e[1],this.handled=!1,this.touchPointsData=e[0]):(this.touchPoints=0,this.handled=!1,this.touchPointsData=null)}return e.prototype.getX=function(){return this.touchPoints>0?this.touchPointsData[0]:0},e.prototype.getY=function(){return this.touchPoints>0?this.touchPointsData[1]:0},e.prototype.GetView=function(){return this.view},e.prototype.SetView=function(e){this.view=e},e.prototype.setHandled=function(e){this.handled=e},e.prototype.getHandled=function(){return this.handled},e.prototype.setEventType=function(e){this.eventType=e},e.prototype.getEventType=function(){return this.eventType},e}();e.MotionEvent=r})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];var i=t.call(this)||this;i.point=null;if(n.length===0){var s=new e.Vector3;i.InitHandlerPoint(s,1)}else i.InitHandlerPoint(n[0],n[1]);return i}return __extends(n,t),n.prototype.RayPick=function(e){if(this.IsVisible()&&this.point){var t=this.point.GetCoordinate().Clone();e.Intersect(t)&&e.AddIntersectPnt(t)}},n.prototype.FindVisiableObject=function(t){this.IsVisible()&&(this.SetRenderWorldMatrix(t.GetGLWorldMatrix()),this.point&&(this.point.UpdateRenderData(t),t.PushRenderable(this,e.RenderableType.RGT_HANDLER)))},n.prototype.InitHandlerPoint=function(t,n){this.SetType(e.ShapeType.SHAPE_POINT_HANDLE),this.drawType=3,this.point=new e.Point(t),this.point.SetDrawType(this.drawType),this.point.SetSize(n)},n.prototype.SetDrawType=function(e){this.point&&this.point.SetDrawType(e)},n.prototype.GetPosition=function(){return this.point.GetCoordinate()},n.prototype.GetPoint=function(){return this.point},n.prototype.ComputeBox=function(){this.point&&this.SetBox(this.point.GetBoundingBox())},n}(e.Handler);e.HandlerPoint=t})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.NONE=0]="NONE",e[e.START=1]="START",e[e.MOVE=2]="MOVE",e[e.FINISH=3]="FINISH"})(t=e.Stage||(e.Stage={}));var n;(function(e){e[e.Type_NONE=0]="Type_NONE",e[e.TYPE_TRANSLATELINE=1]="TYPE_TRANSLATELINE",e[e.TYPE_TRANSLATEINPLANE=2]="TYPE_TRANSLATEINPLANE",e[e.TYPE_SCALE1D=3]="TYPE_SCALE1D",e[e.TYPE_SCALE2D=4]="TYPE_SCALE2D",e[e.TYPE_SCALEUNIFROM=5]="TYPE_SCALEUNIFROM",e[e.TYPE_ROTATE3D=6]="TYPE_ROTATE3D"})(n=e.Type||(e.Type={}));var r=function(){function r(){this._stage=t.NONE,this._localToWorld=new e.Matrix3x4,this._worldToLocal=new e.Matrix3x4}return r.prototype.setLocalToWorldAndWorldToLocal=function(e,t){this._localToWorld=e.Clone(),this._worldToLocal=t.Clone()},r.prototype.getLocalToWorld=function(){return this._localToWorld.Clone()},r.prototype.getWorldToLocal=function(){return this._worldToLocal.Clone()},r.prototype.createCommandInverse=function(){},r.prototype.setStage=function(e){this._stage=e},r.prototype.getStage=function(){return this._stage},r.prototype.GetType=function(){return n.Type_NONE},r}();e.MotionCommand=r;var i=function(e){function t(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];var r=e.call(this)||this;return t.length==1&&(r._plane=t[0]),r}return __extends(t,e),t.prototype.createCommandInverse=function(){},t.prototype.setPlane=function(e){this._plane=e},t.prototype.getPlane=function(){return this._plane},t.prototype.setTranslation=function(e){this._translation=e},t.prototype.getTranslation=function(){return this._translation},t.prototype.setReferencePoint=function(e){this._referencePoint=e},t.prototype.getReferencePoint=function(){return this._referencePoint},t.prototype.GetType=function(){return n.TYPE_TRANSLATEINPLANE},t}(r);e.TranslateInPlaneCommand=i;var s=function(t){function r(){var n=t.call(this)||this;return n._deltaScale=1,n._scaleCenter=0,n._referencePoint=0,n._minScale=1,n._scale=1,n._translation=new e.Vector3,n}return __extends(r,t),r.prototype.createCommandInverse=function(){},r.prototype.setDeltaScale=function(e){this._deltaScale=e},r.prototype.getDeltaScale=function(){return this._deltaScale},r.prototype.setScaleCenter=function(e){this._scaleCenter=e},r.prototype.getScaleCenter=function(){return this._scaleCenter},r.prototype.setReferencePoint=function(e){this._referencePoint=e},r.prototype.getReferencePoint=function(){return this._referencePoint},r.prototype.setMinScale=function(e){this._minScale=e},r.prototype.getMinScale=function(){return this._minScale},r.prototype.GetType=function(){return n.TYPE_SCALE1D},r.prototype.getTranslation=function(){return this._translation},r.prototype.setTranslation=function(e){this._translation=e},r.prototype.GetScale=function(){return this._scale},r.prototype.SetScale=function(e){this._scale=e},r}(r);e.Scale1DCommand=s;var o=function(t){function r(){var n=t.call(this)||this;return n._scale=new e.Vector2(1,1),n}return __extends(r,t),r.prototype.setDeltaScale=function(e){this._scale=e},r.prototype.getDeltaScale=function(){return this._scale},r.prototype.setScaleCenter=function(e){this._scaleCenter=e},r.prototype.getScaleCenter=function(){return this._scaleCenter},r.prototype.setReferencePoint=function(e){this._referencePoint=e},r.prototype.getReferencePoint=function(){return this._referencePoint},r.prototype.setMinScale=function(e){this._minScale=e},r.prototype.getMinScale=function(){return this._minScale},r.prototype.GetType=function(){return n.TYPE_SCALE2D},r.prototype.getTranslation=function(){return this._translation},r.prototype.setTranslation=function(e){this._translation=e},r.prototype.createCommandInverse=function(){},r}(r);e.Scale2DCommand=o;var u=function(t){function r(){var n=t.call(this)||this;return n._scale=1,n._scaleCenter=new e.Vector3,n._translation=new e.Vector3,n}return __extends(r,t),r.prototype.setDeltaScale=function(e){this._scale=e},r.prototype.getDeltaScale=function(){return this._scale},r.prototype.setScaleCenter=function(e){this._scaleCenter=e},r.prototype.getScaleCenter=function(){return this._scaleCenter},r.prototype.GetType=function(){return n.TYPE_SCALEUNIFROM},r.prototype.getTranslation=function(){return this._translation.Clone()},r.prototype.setTranslation=function(e){this._translation=e},r.prototype.createCommandInverse=function(){},r}(r);e.ScaleUniformCommand=u;var a=function(t){function r(){var n=t.call(this)||this;return n._rotation=new e.Quaternion,n._deltarotation=new e.Quaternion,n}return __extends(r,t),r.prototype.setRotation=function(e){this._rotation=e},r.prototype.getRotation=function(){return this._rotation},r.prototype.setDeltaRotation=function(e){this._deltarotation=e.Clone()},r.prototype.getDeltaRotation=function(){return this._deltarotation.Clone()},r.prototype.GetType=function(){return n.TYPE_ROTATE3D},r.prototype.createCommandInverse=function(){},r}(r);e.Rotate3DCommand=a;var f=function(t){function r(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];var i=t.call(this)||this;return n.length==2&&(i._line=new e.Line3D(n[0],n[1])),i._translation=new e.Vector3,i}return __extends(r,t),r.prototype.createCommandInverse=function(){},r.prototype.setLine=function(e,t){this._line.StartPoint=e,this._line.EndPoint=t},r.prototype.getLineStart=function(){return this._line.StartPoint},r.prototype.getLineEnd=function(){return this._line.EndPoint},r.prototype.setTranslation=function(e){this._translation=e},r.prototype.getTranslation=function(){return this._translation},r.prototype.GetType=function(){return n.TYPE_TRANSLATELINE},r}(r);e.TranslateInLineCommand=f})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){}return t.computeClosestPoints=function(e,t,n,r){var i=e.GetEndPoint().Sub(e.GetPosition()).Clone();i.Normalize();var s=t.GetEndPoint().Sub(t.GetPosition()).Clone();s.Normalize();var o=e.GetPosition().Sub(t.GetPosition()).Clone(),u=i.DotProduct(i),a=i.DotProduct(s),f=s.DotProduct(s),l=i.DotProduct(o),c=s.DotProduct(o),h=u*f-a*a;if(Math.abs(h)<1e-5)return!1;var p=(a*c-f*l)/h,d=(u*c-a*l)/h;return n=e.GetPosition().Add(i.Multiply(p).Clone()).Clone(),r=t.GetPosition().Add(s.Multiply(d).Clone()).Clone(),[!0,n,r]},t.getPlaneLineIntersection=function(t,n,r,i){var s=r.x-n.x,o=r.y-n.y,u=r.z-n.z,a=t.Data(),f=a[0]*s+a[1]*o+a[2]*u;if(!f)return[!1,new e.Vector3];var l=(a[0]*n.x+a[1]*n.y+a[2]*n.z+a[3])/f;return i.x=n.x-s*l,i.y=n.y-o*l,i.z=n.z-u*l,[!0,i]},t.computeClosestPointOnLine=function(e,t,n,r){var i=t.Sub(e).Clone(),s=n.Sub(e).Clone(),o=s.DotProduct(i),u=i.DotProduct(i),a=1e-6;if(u<a)return!1;var f=o/u;return r=e.Add(i.Multiply(f)),[!0,r]},t.getSphereLineIntersection=function(e,t,n,r,i){var s=n.Sub(t).Clone();s.Normalize();var o=t.Sub(e.GetCenter()).Clone(),u=2*s.DotProduct(o),a=o.DotProduct(o)-e.GetRadius()*e.GetRadius(),f=u*u-4*a;if(f<0)return!1;var l=Math.sqrt(f),c=(-u-l)*.5;r=t.Add(s.Multiply(c).Clone()).Clone();var h=(-u+l)*.5;return i=t.Add(s.Multiply(h).Clone()).Clone(),[!0,r,i]},t.getUnitCylinderLineIntersection=function(e,t,n,r){var i=t.Sub(e).Clone();i.Normalize();var s=i.Data()[0]*i.Data()[0]+i.Data()[1]*i.Data()[1],o=2*(e.Data()[0]*i.Data()[0]+e.Data()[1]*i.Data()[1]),u=e.Data()[0]*e.Data()[0]+e.Data()[1]*e.Data()[1]-1,a=o*o-4*s*u;if(a<0)return[!1,n,r];var f=Math.sqrt(a),l,c;return o>0?(l=-(2*u)/(f+o),c=-(f+o)/(2*s)):(l=2*u/(f-o),c=(f-o)/(2*s)),n=e.Add(i.Multiply(l).Clone()).Clone(),r=e.Add(i.Multiply(c).Clone()).Clone(),[!0,n,r]},t.getCylinderLineIntersection=function(n,r,i,s,o){var u=1/n.GetRadius(),a=new e.Matrix3x4;a.MultiRotatiton(n.GetRotation().Inverse()),a.MultiScale(u),a.MultiTranslate(n.GetCenter().NagativeED().Clone());var f=a.Multiply(r).Clone(),l=a.Multiply(i).Clone(),c=new e.Vector3,h=new e.Vector3,p=t.getUnitCylinderLineIntersection(f,l,c,h);if(!p[0])return[!1,s,o];c=p[1],h=p[2];var d=a.Inverse();return s=d.Multiply(c).Clone(),o=d.Multiply(h).Clone(),[!0,s,o]},t.getLocalEyeDirection=function(t,n){var r=n.Multiply(new e.Vector4(t,0)).Clone();return r.Normalize(),r},t.computePlaneThruPointAndOrientedToEye=function(n,r,i,s){var o=t.getLocalEyeDirection(n,r);s||(o=o.NagativeED());var u=new e.Plane(o,i);return u},t.computePlaneParallelToAxisAndOrientedToEye=function(n,r,i,s,o,u,a){var f=i.CrossProduct(t.getLocalEyeDirection(n,r)),l=f.CrossProduct(i);l.Normalize(),a||(l=l.NagativeED());var c=l.Multiply(s).Clone().Add(i).Clone(),h=new e.Plane(l,c);return o=c.Clone(),u=c.Add(i).Clone(),[h,o,u]},t}();e.ProjectorHelper=t;var n=function(){function e(){this._worldToLocalDirty=!1}return e.prototype.setLocalToWorld=function(e){this._localToWorld=e.Clone(),this._worldToLocalDirty=!0},e.prototype.getLocalToWorld=function(){return this._localToWorld.Clone()},e.prototype.getWorldToLocal=function(){return this._worldToLocalDirty&&(this._worldToLocal=this._localToWorld.Inverse().Clone(),this._worldToLocalDirty=!1),this._worldToLocal.Clone()},e}();e.Projector=n;var r=function(n){function r(){var t=[];for(var r=0;r<arguments.length;r++)t[r]=arguments[r];var i=n.call(this)||this;return t.length==0?i._line=new e.Line3D(new e.Vector3(0,0,0),new e.Vector3(0,0,0)):i._line=new e.Line3D(t[0],t[1]),i}return __extends(r,n),r.prototype.setLine=function(e,t){this._line.StartPoint=e,this._line.EndPoint=t},r.prototype.getLineStart=function(){return this._line.StartPoint},r.prototype.getLineEnd=function(){return this._line.EndPoint},r.prototype.setLineEnd=function(e){this._line.EndPoint=e.Clone()},r.prototype.setLineStart=function(e){this._line.StartPoint=e.Clone()},r.prototype.project=function(n,r){var i=this.getLocalToWorld().Multiply(this._line.GetPosition()).Clone(),s=this.getLocalToWorld().Multiply(this._line.GetEndPoint()).Clone(),o=new e.Line3D(i,s),u=n.getNearFarPoints(),a=u[0].Clone(),f=u[1].Clone(),l=new e.Line3D(a,f),c=new e.Vector3,h=new e.Vector3,p=t.computeClosestPoints(o,l,c,h);if(!p[0])return!1;var d=p[1],v=this.getWorldToLocal().Multiply(d).Clone();return r=v.Clone(),[!0,r]},r}(n);e.LineProjector=r;var i=function(n){function r(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];var r=n.call(this)||this;return e.length==1&&(r._plane=e[0].Clone()),r}return __extends(r,n),r.prototype.setPlane=function(e){this._plane=e.Clone()},r.prototype.getPlane=function(){return this._plane},r.prototype.project=function(n,r){var i=n.getNearFarPoints(),s=i[0].Clone(),o=i[1].Clone(),u=new e.Vector3,a=new e.Vector3;u=this.getWorldToLocal().Multiply(s).Clone(),a=this.getWorldToLocal().Multiply(o).Clone();var f=t.getPlaneLineIntersection(this._plane.ToVector4(),u,a,r);return f},r}(n);e.PlaneProjector=i;var s=function(n){function r(){var t=[];for(var r=0;r<arguments.length;r++)t[r]=arguments[r];var i=n.call(this)||this;return t.length==1?i._sphere=t[0]:i._sphere=new e.Sphere,i}return __extends(r,n),r.prototype.project=function(n,r){if(!this._sphere)return!1;var i=n.getNearFarPoints(),s=i[0].Clone(),o=i[1].Clone(),u=new e.Vector3,a=new e.Vector3;u=this.getWorldToLocal().Multiply(s).Clone(),a=this.getWorldToLocal().Multiply(o).Clone();var f=new e.Vector3,l;return this._front?(l=t.getSphereLineIntersection(this._sphere,u,a,r,f),[l[0],l[1]]):(l=t.getSphereLineIntersection(this._sphere,u,a,f,r),[l[0],l[2]])},r.prototype.isPointInFront=function(e,n){var r=this.getSphere().GetCenter().Sub(e.getLocalIntersectPoint()).Clone();return r.DotProduct(t.getLocalEyeDirection(e.getEyeDir(),n))<0?!1:!0},r.prototype.getSphere=function(){return this._sphere},r.prototype.setSphere=function(e){this._sphere=e},r.prototype.setFront=function(e){this._front=e},r}(n);e.SphereProjector=s;var o=function(n){function r(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];var r=this;return e.length==0?r=n.call(this)||this:r=n.call(this,e[0])||this,r}return __extends(r,n),r.prototype.isProjectionOnSphere=function(){return this._onSphere},r.prototype.getRotation=function(n,r,i,s,o){if(r&&s){var u=void 0;return this._front?u=new e.Quaternion(n.Sub(this.getSphere().GetCenter()).Clone(),i.Sub(this.getSphere().GetCenter()).Clone()):u=new e.Quaternion(i.Sub(this.getSphere().GetCenter()).Clone(),n.Sub(this.getSphere().GetCenter()).Clone()),u}if(!r&&!s){var u=void 0;u=new e.Quaternion(n.Sub(this.getSphere().GetCenter()).Clone(),i.Sub(this.getSphere().GetCenter()).Clone());var a=new e.Vector3,f=void 0;u=new e.Quaternion(f,a);var l=void 0;a.DotProduct(this._plane.normal)>0?l=this._plane.normal.Clone():l=this._plane.normal.Clone();var c=new e.Quaternion(f,l),h=n.Sub(this.getSphere().GetCenter()).Clone(),p=i.Sub(this.getSphere().GetCenter()).Clone(),d=p.Length()-h.Length(),v=d/this.getSphere().GetRadius();if(Math.abs(v)<1e-6||Math.abs(v)>1)return c;h.Normalize();var m=h.CrossProduct(this._plane.normal.Clone());m.Normalize();var g=new e.Quaternion(o*v,m),y=g.Multiply(c).Clone();return y}var b=this.getSphere().GetCenter(),w=new e.Vector3,E=new e.Vector3,S=void 0;r?S=t.getSphereLineIntersection(this.getSphere(),i,b,w,E):S=t.getSphereLineIntersection(this.getSphere(),n,b,w,E),w=S[1];var u=void 0;return r?u=new e.Quaternion(n.Sub(this.getSphere().GetCenter()).Clone(),w.Sub(this.getSphere().GetCenter()).Clone()):u=(new e.Quaternion(w.Sub(this.getSphere().GetCenter()).Clone(),i.Sub(this.getSphere().GetCenter()))).Clone(),u},r.prototype.project=function(n,r){if(!this._sphere)return!1;var i=n.getNearFarPoints(),s=i[0].Clone(),o=i[1].Clone(),u=new e.Vector3,a=new e.Vector3;u=this.getWorldToLocal().Multiply(s).Clone(),a=this.getWorldToLocal().Multiply(o).Clone();var f=new e.Vector3,l=new e.Vector3,c;this._front?(c=t.getSphereLineIntersection(this._sphere,u,a,f,l),f=c[1]):(c=t.getSphereLineIntersection(this._sphere,u,a,l,f),f=c[2]),this._plane=t.computePlaneThruPointAndOrientedToEye(n.getEyeDir(),this.getLocalToWorld(),this.getSphere().GetCenter().Clone(),this._front);var h=new e.Vector3;if(c[0]){var p=t.getPlaneLineIntersection(this._plane.ToVector4(),f,f.Add(this._plane.normal).Clone(),h);if(!p[0])return p}else{var d=t.getPlaneLineIntersection(this._plane.ToVector4(),u,a,h);if(!d[0])return d}var v=h.Sub(this.getSphere().GetCenter()).Clone().Length();if(v<this.getSphere().GetRadius()){if(!c)return[!1,h];r=f,this._onSphere=!0}else r=h,this._onSphere=!1;return[!0,h]},r}(s);e.SpherePlaneProjector=o;var u=function(n){function r(){var t=[];for(var r=0;r<arguments.length;r++)t[r]=arguments[r];var i=n.call(this)||this;return i._front=!0,t.length==1?i.setCylinder(t[0]):(i._cylinder=new e.Cylinder,i._cylinderAxis=new e.Vector3(0,0,1)),i}return __extends(r,n),r.prototype.setFront=function(e){this._front=e},r.prototype.getCylinder=function(){return this._cylinder},r.prototype.setCylinder=function(t){this._cylinder=t,this._cylinderAxis=t.GetRotation().Multiply(new e.Vector3(0,0,1)),this._cylinderAxis.Normalize()},r.prototype.project=function(n,r){if(!this._cylinder)return!1;var i=n.getNearFarPoints(),s=i[0].Clone(),o=i[1].Clone(),u,a;u=this.getWorldToLocal().Multiply(s).Clone(),a=this.getWorldToLocal().Multiply(o).Clone();var f=new e.Vector3,l=t.getCylinderLineIntersection(this._cylinder,u,a,r,f);return[l[0],l[1]]},r.prototype.isPointInFront=function(n,r){var i=new e.Vector3,s=t.computeClosestPointOnLine(this.getCylinder().GetCenter().Clone(),this.getCylinder().GetCenter().Add(this._cylinderAxis).Clone(),n.getLocalIntersectPoint(),i);i=s[1];var o=n.getLocalIntersectPoint().Sub(i).Clone();return o.DotProduct(t.getLocalEyeDirection(n.getEyeDir(),r))<0?!1:!0},r}(n);e.CylinderProjector=u;var a=function(n){function r(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];var r=this;return e.length==1?r=n.call(this,e[0])||this:r=n.call(this)||this,r}return __extends(r,n),r.prototype.isProjectionOnCylinder=function(){return this._onCylinder},r.prototype.project=function(n,r){if(!this._cylinder)return!1;var i=n.getNearFarPoints(),s=i[0].Clone(),o=i[1].Clone(),u,a;u=this.getWorldToLocal().Multiply(s).Clone(),a=this.getWorldToLocal().Multiply(o).Clone();var f=new e.Vector3,l=new e.Vector3,c;this._front?(c=t.getCylinderLineIntersection(this._cylinder,u,a,f,l),f=c[1],l=c[2]):(c=t.getCylinderLineIntersection(this._cylinder,u,a,l,f),f=c[2],l=c[1]);var h=t.computePlaneParallelToAxisAndOrientedToEye(n.getEyeDir(),this.getLocalToWorld(),this._cylinderAxis,this.getCylinder().GetRadius(),this._planeLineStart,this._planeLineEnd,this._front);this._plane=h[0],this._planeLineStart=h[1],this._planeLineEnd=h[2];var p=new e.Vector3,d=t.getPlaneLineIntersection(this._plane.ToVector4(),u,a,p);p=d[1];if(c[0]){var v=new e.Vector3;d=t.getPlaneLineIntersection(this._plane.ToVector4(),f,f.Add(this._plane.normal).Clone(),v),v=d[1];var m=new e.Vector3,g=t.computeClosestPointOnLine(this.getCylinder().GetCenter(),this.getCylinder().GetCenter().Add(this._cylinderAxis).Clone(),v,m);m=g[1];var y=v.Sub(m).Clone().Length();if(y<this.getCylinder().GetRadius()){if(!c[0])return!1;r=f,this._onCylinder=!0}else r=p,this._onCylinder=!1}else r=p,this._onCylinder=!1;return[!0,r]},r.prototype.getRotation=function(n,r,i,s){if(r&&s){var o=new e.Vector3,u=new e.Vector3,a=t.computeClosestPointOnLine(this.getCylinder().GetCenter().Clone(),this.getCylinder().GetCenter().Add(this._cylinderAxis.Multiply(this.getCylinder().GetHeight()).Clone()),n,o);o=a[1],a=t.computeClosestPointOnLine(this.getCylinder().GetCenter().Clone(),this.getCylinder().GetCenter().Add(this._cylinderAxis.Multiply(this.getCylinder().GetHeight()).Clone()),i,u),u=a[1];var f=n.Sub(o).Clone(),l=i.Sub(u).Clone(),c=f.DotProduct(l)/(f.Length()*l.Length());if(c>1||c<-1)return new e.Quaternion;var h=Math.acos(c),p=f.CrossProduct(l);return new e.Quaternion(h/e.DEGTORAD,p)}if(!r&&!s){var d=new e.Vector3,v=new e.Vector3,m=t.computeClosestPointOnLine(this._planeLineStart,this._planeLineEnd,n,d);d=m[1];var g=t.computeClosestPointOnLine(this._planeLineStart,this._planeLineEnd,i,v);v=g[1];var f=n.Sub(d).Clone(),l=i.Sub(v).Clone(),y=l.Sub(f).Clone(),b=y.Length(),h=this.getCylinder().GetRadius()===0?0:b/this.getCylinder().GetRadius(),p=this._plane.normal.CrossProduct(f);return l.Length()>f.Length()?new e.Quaternion(h/e.DEGTORAD,p):new e.Quaternion(-h/e.DEGTORAD,p)}var w=r?i:n,E=new e.Vector3,a=t.computeClosestPointOnLine(this._planeLineStart,this._planeLineEnd,w,E);E=a[1];var S=w.Sub(E).Clone();S.Normalize();var x=E.Add(S.Multiply(this.getCylinder().GetRadius()).Clone()).Clone();return r?this.getRotation(x,!1,i,!1).Multiply(this.getRotation(n,!0,x,!0)).Clone():this.getRotation(x,!0,i,!0).Multiply(this.getRotation(n,!1,x,!1).Clone())},r}(u);e.CylinderPlaneProjector=a})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n._xDragger=new e.RotateCylinderDragger,n.AddChild(n._xDragger),n.addDragger(n._xDragger),n._yDragger=new e.RotateCylinderDragger,n.AddChild(n._yDragger),n.addDragger(n._yDragger),n._zDragger=new e.RotateCylinderDragger,n.AddChild(n._zDragger),n.addDragger(n._zDragger),n.setParentDragger(n.getParentDragger()),n}return __extends(n,t),n.prototype.setupDefaultGeometry=function(){this._xDragger.setupDefaultGeometry(),this._yDragger.setupDefaultGeometry(),this._zDragger.setupDefaultGeometry();var t=new e.Quaternion(new e.Vector3(0,0,1),new e.Vector3(1,0,0));this._xDragger.SetRotation(t);var t=new e.Quaternion(new e.Vector3(0,0,1),new e.Vector3(0,1,0));this._yDragger.SetRotation(t),this._xDragger.setColor(new e.Color(1,0,0,1)),this._yDragger.setColor(new e.Color(0,1,0,1)),this._zDragger.setColor(new e.Color(0,0,1,1)),this._xDragger.setPickColor(e.Color.YELLOW().Clone()),this._yDragger.setPickColor(e.Color.YELLOW().Clone()),this._zDragger.setPickColor(e.Color.YELLOW().Clone()),this._xDragger.SetPreSelectColor(e.Color.YELLOW().Clone()),this._yDragger.SetPreSelectColor(e.Color.YELLOW().Clone()),this._zDragger.SetPreSelectColor(e.Color.YELLOW().Clone())},n}(e.CompositeDragger);e.RotateCylinderAxisDragger=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n._drawModel=null,n._projector=new e.CylinderPlaneProjector,n.setColor(new e.Color(0,1,0,1)),n.setPickColor(new e.Color(1,1,0,1)),n}return __extends(n,t),n.prototype.handle=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length==2){var i=n[1],s=n[0];switch(i.getEventType()){case e.EventType.PUSH:var o=this.GetWorldTransform();this._projector.setLocalToWorld(o),this._startLocalToWorld=this._projector.getLocalToWorld().Clone(),this._startWorldToLocal=this._projector.getWorldToLocal().Clone(),this._projector.isPointInFront(s,this._startLocalToWorld)?this._projector.setFront(!0):this._projector.setFront(!1);var u=new e.Vector3,a=this._projector.project(s,u);if(a[0]){u=a[1].Clone();var f=new e.Rotate3DCommand;f.setStage(e.Stage.START),f.setLocalToWorldAndWorldToLocal(this._startLocalToWorld,this._startWorldToLocal),this.dispatch(f),this._prevWorldProjPt=u.Clone(),this._prevRotation=new e.Quaternion,this._prevPtOnCylinder=this._projector.isProjectionOnCylinder()}return!0;case e.EventType.DRAG:var o=this.GetWorldTransform(),u=new e.Vector3,a=this._projector.project(s,u);if(a[0]){u=a[1].Clone();var l=this._prevWorldProjPt.Clone(),c=this._projector.getRotation(l,this._prevPtOnCylinder,u,this._projector.isProjectionOnCylinder()),h=this._prevRotation.Multiply(c).Clone(),p=l.Sub(u).Clone(),d=p.Length(),f=new e.Rotate3DCommand;f.setStage(e.Stage.MOVE),f.setLocalToWorldAndWorldToLocal(this._startLocalToWorld,this._startWorldToLocal),f.setRotation(h),f.setDeltaRotation(c),this.dispatch(f),this._prevWorldProjPt=u.Clone(),this._prevRotation=h,this._prevPtOnCylinder=this._projector.isProjectionOnCylinder()}return!0;case e.EventType.RELEASE:var f=new e.Rotate3DCommand;return f.setStage(e.Stage.FINISH),f.setLocalToWorldAndWorldToLocal(this._startLocalToWorld,this._startWorldToLocal),this.dispatch(f),!0;default:return!1}}else t.prototype.handle.call(this,n[0])},n.prototype.setupDefaultGeometry=function(){var t=this,n="CyicleXYHandler.stl";this._drawModel=null,e.MeshHelper.ReadSingleModel(n,this._drawModel,function(n,r){if(r){t._drawModel=r,t._drawModel.SetAlloewExculding(!1);var i=new e.ShapeNode;t.AddChild(i),i.SetShape(t._drawModel),t._drawModel.SetInitHightlight(!0),t._drawModel.SetUserData(t)}})},n}(e.Dragger);e.RotateCylinderDragger=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n._prevPtOnSphere=!0,n._projector=new e.SpherePlaneProjector,n.setColor(new e.Color(0,1,0,1)),n.setPickColor(new e.Color(1,1,0,1)),n}return __extends(n,t),n.prototype.getPickColor=function(){return this._pickColor},n.prototype.setPickColor=function(e){this._pickColor=e},n.prototype.getColor=function(){return this._color},n.prototype.setColor=function(e){this._color=e},n.prototype.handle=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length==2){var i=n[1],s=n[0];if(!s.contains(this))return!1;switch(i.getEventType()){case e.EventType.PUSH:var o=this.GetWorldTransform();this._projector.setLocalToWorld(o),this._startLocalToWorld=this._projector.getLocalToWorld(),this._startWorldToLocal=this._projector.getWorldToLocal(),this._projector.isPointInFront(s,this._startLocalToWorld)?this._projector.setFront(!0):this._projector.setFront(!1);var u=new e.Vector3,a=this._projector.project(s,u);if(a[0]){u=a[1].Clone();var f=new e.Rotate3DCommand;f.setStage(e.Stage.START),f.setLocalToWorldAndWorldToLocal(this._startLocalToWorld,this._startWorldToLocal),this.dispatch(f),this._prevRotation=new e.Quaternion,this._prevWorldProjPt=this._projector.getLocalToWorld().Multiply(u).Clone(),this._prevPtOnSphere=this._projector.isProjectionOnSphere()}return!0;case e.EventType.DRAG:var l=new e.Matrix3x4;l.SetRotation(this._prevRotation.RotationMatrix());var o=this._startLocalToWorld.Multiply(l).Clone();this._projector.setLocalToWorld(o);var u=new e.Vector3,a=this._projector.project(s,u);if(a[0]){u=a[1].Clone();var c=this._projector.getWorldToLocal().Multiply(this._prevWorldProjPt).Clone(),h=this._projector.getRotation(c,this._prevPtOnSphere,u,this._projector.isProjectionOnSphere(),1),p=h.Multiply(this._prevRotation).Clone(),f=new e.Rotate3DCommand;f.setStage(e.Stage.MOVE),f.setLocalToWorldAndWorldToLocal(this._startLocalToWorld,this._startWorldToLocal),f.setRotation(p),this.dispatch(f),this._prevWorldProjPt=this._projector.getLocalToWorld().Multiply(u).Clone(),this._prevRotation=p,this._prevPtOnSphere=this._projector.isProjectionOnSphere()}return!0;case e.EventType.RELEASE:var f=new e.Rotate3DCommand;return f.setStage(e.Stage.FINISH),f.setLocalToWorldAndWorldToLocal(this._startLocalToWorld,this._startWorldToLocal),this.dispatch(f),!0;default:return!1}}else t.prototype.handle.call(this,n[0])},n.prototype.setupDefaultGeometry=function(){},n}(e.Dragger);e.RotateSphereDragger=t})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.SCALE_WITH_ORIGIN_AS_PIVOT=0]="SCALE_WITH_ORIGIN_AS_PIVOT"
,e[e.SCALE_WITH_OPPOSITE_HANDLE_AS_PIVOT=1]="SCALE_WITH_OPPOSITE_HANDLE_AS_PIVOT"})(t=e.ScaleMode||(e.ScaleMode={}));var n=function(){function e(){}return e.computeScale=function(e,t,n){var r=e.Data()[0]-n,i=r?(t.Data()[0]-n)/r:1;return i},e}();e.Scale1DDraggerHelper=n;var r=function(t){function r(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];var i=t.call(this)||this;return i._drawModel=null,i._projector=new e.LineProjector(new e.Vector3(-0.5,0,0),new e.Vector3(.5,0,0)),i.setColor(new e.Color(0,1,0,1)),i.setPickColor(new e.Color(1,1,0,1)),i.SetScales(0),i._minScale=.001,n.length==1?i._scaleMode=n[0]:i._scaleMode=0,i}return __extends(r,t),r.prototype.setLeftHandlePosition=function(t){this._projector.setLineStart(new e.Vector3(t,0,0))},r.prototype.getLeftHandlePosition=function(){return this._projector.getLineStart().Data()[0]},r.prototype.setRightHandlePosition=function(t){this._projector.setLineEnd(new e.Vector3(t,0,0))},r.prototype.getRightHandlePosition=function(){return this._projector.getLineEnd().Data()[0]},r.prototype.setMinScale=function(e){this._minScale=e},r.prototype.getMinScale=function(){return this._minScale},r.prototype.GetScales=function(){return this._scale},r.prototype.SetScales=function(e){this._scale=e},r.prototype.handle=function(){var r=[];for(var i=0;i<arguments.length;i++)r[i]=arguments[i];if(r.length==2){var s=r[1],o=r[0];if(!o.contains(this))return!1;switch(s.getEventType()){case e.EventType.PUSH:this._priProjectedPoint=e.Vector3.ZERO().Clone();var u=this.GetWorldTransform();this._projector.setLocalToWorld(u);var a=this._projector.project(o,this._startProjectedPoint);if(a[0]){this._startProjectedPoint=a[1],this.SetScales(0),this._scaleCenter=0;var f=new e.Scale1DCommand;f.setStage(e.Stage.START),f.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),this._priProjectedPoint=this._startProjectedPoint,this.dispatch(f)}return!0;case e.EventType.DRAG:var u=this.GetWorldTransform();this._projector.setLocalToWorld(u);var l,a=this._projector.project(o,l);if(a[0]){l=a[1];var f=new e.Scale1DCommand,c=l.Sub(this._priProjectedPoint).Clone(),h=n.computeScale(this._startProjectedPoint,this._priProjectedPoint,this._scaleCenter);this._priProjectedPoint=l;var p=n.computeScale(this._startProjectedPoint,l,this._scaleCenter),d=p-h;this.SetScales(this.GetScales()+d),f.setStage(e.Stage.MOVE),f.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),f.setDeltaScale(d),f.SetScale(this.GetScales()),f.setScaleCenter(this._scaleCenter),f.setMinScale(this.getMinScale()),f.setTranslation(c),this.dispatch(f)}return!0;case e.EventType.RELEASE:var f=new e.Scale1DCommand;return f.setStage(e.Stage.FINISH),f.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),this.dispatch(f),!0;default:return!1}}else t.prototype.handle.call(this,r[0])},r.prototype.setupDefaultGeometry=function(){var t=this,n="ScaleHandler.stl";this._drawModel=null,e.MeshHelper.ReadSingleModel(n,this._drawModel,function(n,r){if(r){t._drawModel=r,t._drawModel.SetAlloewExculding(!1);var i=new e.ShapeNode;t.AddChild(i),i.SetShape(t._drawModel),t._drawModel.SetInitHightlight(!0),t._drawModel.SetUserData(t)}})},r}(e.Dragger);e.Scale1DDragger=r})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){}return t.computeScale=function(t,n,r){var i=new e.Vector2(1,1);return t.Data()[0]-r.Data()[0]!=0&&(i.x=(n.Data()[0]-r.Data()[0])/(t.Data()[0]-r.Data()[0])),t.Data()[2]-r.Data()[1]!=0&&(i.y=(n.Data()[2]-r.Data()[1])/(t.Data()[2]-r.Data()[1])),i},t}();e.Scale2DDrageerHelper=t;var n=function(n){function r(){var t=[];for(var r=0;r<arguments.length;r++)t[r]=arguments[r];var i=n.call(this)||this;return i._projector=new e.PlaneProjector(new e.Plane(new e.Vector3(0,1,0),0)),i.setColor(new e.Color(0,1,0,1)),i.setPickColor(new e.Color(1,1,0,1)),i._topLeftHandlePosition=new e.Vector2(-0.5,.5),i._bottomLeftHandlePosition=new e.Vector2(-0.5,-0.5),i._bottomRightHandlePosition=new e.Vector2(.5,-0.5),i._topRightHandlePosition=new e.Vector2(.5,.5),i._minScale=new e.Vector2(.001,.001),t.length==1&&(i._scaleMode=t[0]),i}return __extends(r,n),r.prototype.setTopLeftHandlePosition=function(e){this._topLeftHandlePosition=e},r.prototype.getTopLeftHandlePosition=function(){return this._topLeftHandlePosition},r.prototype.setBottomLeftHandlePosition=function(e){this._bottomLeftHandlePosition=e},r.prototype.getBottomLeftHandlePosition=function(){return this._bottomLeftHandlePosition},r.prototype.setTopRightHandlePosition=function(e){this._topRightHandlePosition=e},r.prototype.getTopRightHandlePosition=function(){return this._topRightHandlePosition},r.prototype.setBottomRightHandlePosition=function(e){this._bottomRightHandlePosition=e},r.prototype.getBottomRightHandlePosition=function(){return this._bottomRightHandlePosition},r.prototype.setPickColor=function(e){this._pickColor=e},r.prototype.getPickColor=function(){return this._pickColor},r.prototype.setColor=function(e){this._color=e},r.prototype.getColor=function(){return this._color},r.prototype.setMinScale=function(e){this._minScale=e},r.prototype.getMinScale=function(){return this._minScale},r.prototype.handle=function(){var r=[];for(var i=0;i<arguments.length;i++)r[i]=arguments[i];if(r.length==2){var s=r[1],o=r[0];if(!o.contains(this))return!1;switch(s.getEventType()){case e.EventType.PUSH:var u=this.GetWorldTransform();this._projector.setLocalToWorld(u);var a=this._projector.project(o,this._startProjectedPoint);if(a[0]){this._startProjectedPoint=a[1],this._scaleCenter=new e.Vector2(0,0);var f=new e.Scale2DCommand;f.setStage(e.Stage.START),f.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),f.setReferencePoint(this._referencePoint),this.dispatch(f)}return!0;case e.EventType.DRAG:var u=this.GetWorldTransform();this._projector.setLocalToWorld(u);var l=new e.Vector3,a=this._projector.project(o,l);if(a[0]){l=a[1];var c=t.computeScale(this._startProjectedPoint,l,this._scaleCenter);c.Data()[0]<this.getMinScale().Data()[0]&&(c.x=this.getMinScale().Data()[0]),c.Data()[1]<this.getMinScale().Data()[1]&&(c.y=this.getMinScale().Data()[1]);var f=new e.Scale2DCommand;f.setStage(e.Stage.MOVE),f.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),f.setDeltaScale(c),f.setScaleCenter(this._scaleCenter),f.setReferencePoint(this._referencePoint),f.setMinScale(this.getMinScale()),this.dispatch(f)}return!0;case e.EventType.RELEASE:var f=new e.Scale2DCommand;return f.setStage(e.Stage.FINISH),f.setReferencePoint(this._referencePoint),f.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),this.dispatch(f),!0;default:return!1}}else n.prototype.handle.call(this,r[0])},r.prototype.setupDefaultGeometry=function(){var t=this,n="PlanXYHandler.stl",r=null;e.MeshHelper.ReadSingleModel(n,r,function(n,i){if(i){r=i,t._drawModel.SetAlloewExculding(!1);var s=new e.ShapeNode;t.AddChild(s),s.SetShape(r),r.SetUserData(t)}})},r}(e.Dragger);e.Scale2DDragger=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n._xDragger=new e.Scale1DDragger,n.comPositeDragger=new e.CompositeDragger,n.comPositeDragger.AddChild(n._xDragger),n.comPositeDragger.addDragger(n._xDragger),n.AddChild(n.comPositeDragger),n.comPositeDragger.setParentDragger(n.comPositeDragger.getParentDragger()),n.comPositeDragger1=new e.CompositeDragger,n._yDragger=new e.Scale1DDragger,n.comPositeDragger1.AddChild(n._yDragger),n.comPositeDragger1.addDragger(n._yDragger),n.AddChild(n.comPositeDragger1),n.comPositeDragger1.setParentDragger(n.comPositeDragger1.getParentDragger()),n.comPositeDragger2=new e.CompositeDragger,n._zDragger=new e.Scale1DDragger,n.comPositeDragger2.AddChild(n._zDragger),n.comPositeDragger2.addDragger(n._zDragger),n.AddChild(n.comPositeDragger2),n.comPositeDragger2.setParentDragger(n.comPositeDragger2.getParentDragger()),n}return __extends(n,t),n.prototype.addDraggerCallback=function(e){this.comPositeDragger.addDraggerCallback(e),this.comPositeDragger1.addDraggerCallback(e),this.comPositeDragger2.addDraggerCallback(e)},n.prototype.removeDraggerCallback=function(e){this.comPositeDragger.removeDraggerCallback(e),this.comPositeDragger1.removeDraggerCallback(e),this.comPositeDragger2.removeDraggerCallback(e)},n.prototype.setupDefaultGeometry=function(){this._xDragger.setupDefaultGeometry(),this._yDragger.setupDefaultGeometry(),this._zDragger.setupDefaultGeometry();var t=new e.Quaternion(new e.Vector3(1,0,0),new e.Vector3(0,1,0));this._yDragger.SetRotation(t);var t=new e.Quaternion(new e.Vector3(1,0,0),new e.Vector3(0,0,1));this._zDragger.SetRotation(t),this._xDragger.setColor(new e.Color(1,0,0,1)),this._yDragger.setColor(new e.Color(0,1,0,1)),this._zDragger.setColor(new e.Color(0,0,1,1)),this._xDragger.setPickColor(e.Color.YELLOW().Clone()),this._yDragger.setPickColor(e.Color.YELLOW().Clone()),this._zDragger.setPickColor(e.Color.YELLOW().Clone())},n}(e.CompositeDragger);e.ScaleAxisDragger=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];var i=t.call(this)||this;return n.length==2?i._projector=new e.LineProjector(n[0],n[1]):i._projector=new e.LineProjector,i._startProjectedPoint=new e.Vector3,i.setColor(new e.Color(0,1,0,1)),i.setPickColor(new e.Color(1,1,0,1)),i}return __extends(n,t),n.prototype.handle=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length==2){var i=n[1],s=n[0];this._checkForNodeInNodePath;switch(i.getEventType()){case e.EventType.PUSH:var o=this.GetWorldTransform();this._projector.setLocalToWorld(o);var u=this._projector.project(s,this._startProjectedPoint);if(u[0]){this._startProjectedPoint=u[1];var a=new e.TranslateInLineCommand(this._projector.getLineStart(),this._projector.getLineEnd());a.setStage(e.Stage.START),a.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),this.dispatch(a)}return!0;case e.EventType.DRAG:var o=this.GetWorldTransform();this._projector.setLocalToWorld(o);var f=new e.Vector3,u=this._projector.project(s,f);if(u[0]){f=u[1];var a=new e.TranslateInLineCommand(this._projector.getLineStart(),this._projector.getLineEnd());a.setStage(e.Stage.MOVE),a.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),a.setTranslation(f.Sub(this._startProjectedPoint)),this.dispatch(a)}return!0;case e.EventType.RELEASE:var f,u=this._projector.project(s,this._startProjectedPoint);if(u[0]){this._startProjectedPoint=u[1];var a=new e.TranslateInLineCommand(this._projector.getLineStart(),this._projector.getLineEnd());a.setStage(e.Stage.FINISH),a.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),this.dispatch(a)}return!0;default:return!1}}else t.prototype.handle.call(this,n[0])},n.prototype.setupDefaultGeometry=function(){var t=this,n=this._projector.getLineEnd().Sub(this._projector.getLineStart()).Clone(),r="AxisHandler.stl";this._drawModel=null,e.MeshHelper.ReadSingleModel(r,this._drawModel,function(n,r){if(r){t._drawModel=r,t._drawModel.SetAlloewExculding(!1);var i=new e.ShapeNode;t.AddChild(i),i.SetShape(t._drawModel),t._drawModel.SetInitHightlight(!0),t._drawModel.SetUserData(t)}})},n}(e.Dragger);e.Translate1DDragger=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];var i=t.call(this)||this;return n.length==1?i._projector=new e.PlaneProjector(n[0]):i._projector=new e.PlaneProjector(new e.Plane(new e.Vector3(0,1,0),0)),i._startProjectedPoint=new e.Vector3,i._drawModel=null,i.setColor(new e.Color(0,1,0,1)),i.setPickColor(new e.Color(1,1,0,1)),i}return __extends(n,t),n.prototype.handle=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length==2){var i=n[0],s=n[1];if(!i.contains(this))return!1;switch(s.getEventType()){case e.EventType.PUSH:var o=this.GetWorldTransform();this._projector.setLocalToWorld(o);var u=this._projector.project(i,this._startProjectedPoint);if(u[0]){this._startProjectedPoint=u[1];var a=new e.TranslateInPlaneCommand(this._projector.getPlane());a.setStage(e.Stage.START),a.setReferencePoint(this._startProjectedPoint),a.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),this.dispatch(a)}return!0;case e.EventType.DRAG:var o=this.GetWorldTransform();this._projector.setLocalToWorld(o);var f=new e.Vector3,u=this._projector.project(i,f);if(u[0]){f=u[1];var a=new e.TranslateInPlaneCommand(this._projector.getPlane());a.setStage(e.Stage.MOVE),a.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),a.setTranslation(f.Sub(this._startProjectedPoint).Clone()),a.setReferencePoint(this._startProjectedPoint),this.dispatch(a)};case e.EventType.RELEASE:var a=new e.TranslateInPlaneCommand(this._projector.getPlane());return a.setStage(e.Stage.FINISH),a.setReferencePoint(this._startProjectedPoint),a.setLocalToWorldAndWorldToLocal(this._projector.getLocalToWorld(),this._projector.getWorldToLocal()),this.dispatch(a),!0;default:return!1}}else t.prototype.handle.call(this,n[0])},n.prototype.setupDefaultGeometry=function(){var t=this,n="PlanXYHandler.stl";this._drawModel=null,e.MeshHelper.ReadSingleModel(n,this._drawModel,function(n,r){if(r){t._drawModel=r,t._drawModel.SetAlloewExculding(!1);var i=new e.ShapeNode;t.AddChild(i),t._drawModel.SetInitHightlight(!0),i.SetShape(t._drawModel),t._drawModel.SetUserData(t)}})},n}(e.Dragger);e.Translate2DDragger=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n._xDragger=new e.Translate1DDragger(new e.Vector3(0,0,0),new e.Vector3(0,0,1)),n.AddChild(n._xDragger),n.addDragger(n._xDragger),n._yDragger=new e.Translate1DDragger(new e.Vector3(0,0,0),new e.Vector3(0,0,1)),n.AddChild(n._yDragger),n.addDragger(n._yDragger),n._zDragger=new e.Translate1DDragger(new e.Vector3(0,0,0),new e.Vector3(0,0,1)),n.AddChild(n._zDragger),n.addDragger(n._zDragger),n._xzDragger=new e.Translate2DDragger,n.AddChild(n._xzDragger),n.addDragger(n._xzDragger),n._xyDragger=new e.Translate2DDragger,n.AddChild(n._xyDragger),n.addDragger(n._xyDragger),n._yzDragger=new e.Translate2DDragger,n.AddChild(n._yzDragger),n.addDragger(n._yzDragger),n.setParentDragger(n.getParentDragger()),n}return __extends(n,t),n.prototype.setupDefaultGeometry=function(){this._xDragger.setupDefaultGeometry(),this._yDragger.setupDefaultGeometry(),this._zDragger.setupDefaultGeometry(),this._xzDragger.setupDefaultGeometry(),this._xyDragger.setupDefaultGeometry(),this._yzDragger.setupDefaultGeometry();var t=new e.Quaternion(new e.Vector3(0,0,1),new e.Vector3(1,0,0));this._xDragger.SetRotation(t);var n=new e.Quaternion(new e.Vector3(0,0,1),new e.Vector3(0,1,0));this._xyDragger.SetRotation(n);var t=new e.Quaternion(new e.Vector3(0,0,1),new e.Vector3(0,1,0));this._yDragger.SetRotation(t);var n=new e.Quaternion(new e.Vector3(1,0,0),new e.Vector3(0,1,0));this._yzDragger.SetRotation(n);for(var r=0,i=this._draggerList;r<i.length;r++){var s=i[r];s._drawModel}this.totalBoundingBox,this._xDragger.setColor(new e.Color(1,0,0,1)),this._yDragger.setColor(new e.Color(0,1,0,1)),this._zDragger.setColor(new e.Color(0,0,1,1)),this._xzDragger.setColor(new e.Color(1,0,0,1)),this._xyDragger.setColor(new e.Color(0,1,0,1)),this._yzDragger.setColor(new e.Color(0,0,1,1)),this._xDragger.setPickColor(e.Color.YELLOW().Clone()),this._yDragger.setPickColor(e.Color.YELLOW().Clone()),this._zDragger.setPickColor(e.Color.YELLOW().Clone()),this._xDragger.SetPreSelectColor(e.Color.YELLOW().Clone()),this._yDragger.SetPreSelectColor(e.Color.YELLOW().Clone()),this._zDragger.SetPreSelectColor(e.Color.YELLOW().Clone()),this._xzDragger.setPickColor(e.Color.YELLOW().Clone()),this._xyDragger.setPickColor(e.Color.YELLOW().Clone()),this._yzDragger.setPickColor(e.Color.YELLOW().Clone()),this._xzDragger.SetPreSelectColor(e.Color.YELLOW().Clone()),this._xyDragger.SetPreSelectColor(e.Color.YELLOW().Clone()),this._yzDragger.SetPreSelectColor(e.Color.YELLOW().Clone())},n}(e.CompositeDragger);e.TranslateAxisDragger=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n._usingTranslate1DDragger=!1,n._translate2DDragger=new e.Translate2DDragger,n._translate2DDragger.setColor(new e.Color(.7,.7,.7,1)),n.addDragger(n._translate2DDragger),n._translate1DDragger=new e.Translate1DDragger(new e.Vector3(0,0,0),new e.Vector3(0,1,0)),n.addDragger(n._translate1DDragger),n.setParentDragger(n.getParentDragger()),n}return __extends(n,t),n.prototype.getTranslate1DDragger=function(){return this._translate1DDragger},n.prototype.getTranslate2DDragger=function(){return this._translate2DDragger},n.prototype.setColor=function(e){this._translate2DDragger&&this._translate2DDragger.setColor(e)},n.prototype.handle=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length==2){var r=t[0],i=t[1];if(!r.contains(this))return!1;var s=!1;return this._usingTranslate1DDragger?this._translate1DDragger.handle(r,i)&&(s=!0):this._translate2DDragger.handle(r,i)&&(s=!0),i.getEventType()==e.EventType.RELEASE&&(this._usingTranslate1DDragger=!1),s}},n.prototype.setupDefaultGeometry=function(){},n}(e.CompositeDragger);e.TranslatePlaneDragger=t})(M3D||(M3D={}));var SView;(function(e){var t=function(){function t(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];this.linkStr=new Array,this.actionList=new Array,this.relationShape=null,t.length!==0&&(t.length===8?(this.ID=t[0],this.name=t[1],this.refs=t[2],this.describe=t[3],this.isEnable=t[4],this.isVisible=t[5],this.startPos=t[6],this.endPos=t[7]):(this.ID=t[0],this.name=t[1],this.describe=t[2],this.describe!=null&&this.describe!==""&&this.action.push(new e.SHotSpotDescriptionAction(this.ID,e.SHotSpotActionType.SHOWDESCRIPTION,this.describe)),this.viewName=t[3],this.viewName!==""&&this.viewName!=null&&this.action.push(new e.SHotSpotOpenViewAction(this.ID,e.SHotSpotActionType.OPENVIEW,this.viewName)),this.animationName=t[4],this.animationName!==""&&this.animationName!=null&&this.action.push(new e.SHotSpotOpenAniAction(this.ID,e.SHotSpotActionType.PLAYANIMATION,this.animationName)),this.voiceFileName=t[5],this.posX=t[6],this.posY=t[7],this.posZ=t[8],this.cameraPositionX=t[9],this.cameraPositionY=t[10],this.cameraPositionZ=t[11],this.cameraRotationW=t[12],this.cameraRotationX=t[13],this.cameraRotationY=t[14],this.cameraRotationZ=t[15],this.cameraZoomX=t[16],this.cameraZoomY=t[17],this.cameraZoomZ=t[18],this.cameraProjectionType=t[19],this.hotspotImage=t[20]))}return t.prototype.GetID=function(){return this.ID},t.prototype.SetID=function(e){this.ID=e},t.prototype.GetName=function(){return this.name},t.prototype.SetName=function(e){this.name=e},t.prototype.GetType=function(){return this.type},t.prototype.SetType=function(e){this.type=e},t.prototype.GetRef=function(){return this.refs},t.prototype.SetRef=function(e){this.refs=e},t.prototype.GetIsEnable=function(){return this.isEnable},t.prototype.SetIsEnable=function(e){this.isEnable=e},t.prototype.GetDescribe=function(){return this.describe},t.prototype.SetDescribe=function(e){this.describe=e},t.prototype.IsVisible=function(){return this.isVisible},t.prototype.SetIsVisible=function(e){this.isVisible=e},t.prototype.SetVisible=function(e){this.isVisible=e},t.prototype.GetLinkStr=function(){return this.linkStr},Object.defineProperty(t.prototype,"action",{get:function(){return this.actionList},set:function(e){this.actionList=e},enumerable:!0,configurable:!0}),t.prototype.onExecute=function(){if(this.action.length>0){e.SHotSpotManager.Instance().view.view.StopModelViewAnimation(),e.SHotSpotManager.Instance().view.GetAnimationPlayer().StopPlayer(),e.SHotSpotManager.Instance().view.showShotSpotDescribe(null);for(var t=0,n=this.action;t<n.length;t++){var r=n[t];r.Execute()}}},t.prototype.SetLinkStr=function(e){this.linkStr=e},t.prototype.GetRelationShape=function(){return this.relationShape},t.prototype.SetRelationShape=function(e){this.relationShape=e},t.prototype.GetPosX=function(){return this.posX},t.prototype.SetPosX=function(e){this.posX=e},t.prototype.GetPosY=function(){return this.posY},t.prototype.SetPosY=function(e){this.posY=e},t.prototype.GetPosZ=function(){return this.posZ},t.prototype.SetPosZ=function(e){this.posZ=e},t.prototype.GetCameraPositionX=function(){return this.cameraPositionX},t.prototype.SetCameraPositionX=function(e){this.cameraPositionX=e},t.prototype.GetCameraPositionY=function(){return this.cameraPositionY},t.prototype.SetCameraPositionY=function(e){this.cameraPositionY=e},t.prototype.GetCameraPositionZ=function(){return this.cameraPositionZ},t.prototype.SetCameraPositionZ=function(e){this.cameraPositionZ=e},t.prototype.GetCameraRotationX=function(){return this.cameraRotationX},t.prototype.SetCameraRotationX=function(e){this.cameraRotationX=e},t.prototype.GetCameraRotationY=function(){return this.cameraRotationY},t.prototype.SetCameraRotationY=function(e){this.cameraRotationY=e},t.prototype.GetCameraRotationZ=function(){return this.cameraRotationZ},t.prototype.SetCameraRotationZ=function(e){this.cameraRotationZ=e},t.prototype.GetCameraRotationW=function(){return this.cameraRotationW},t.prototype.SetCameraRotationW=function(e){this.cameraRotationW=e},t.prototype.GetCameraZoomX=function(){return this.cameraZoomX},t.prototype.SetCameraZoomX=function(e){this.cameraZoomX=e},t.prototype.GetCameraZoomY=function(){return this.cameraZoomY},t.prototype.SetCameraZoomY=function(e){this.cameraZoomY=e},t.prototype.GetCameraZoomZ=function(){return this.cameraZoomZ},t.prototype.SetCameraZoomZ=function(e){this.cameraZoomZ=e},t.prototype.GetCameraProjectionType=function(){return this.cameraProjectionType},t.prototype.SetCameraProjectionType=function(e){this.cameraProjectionType=e},t.prototype.GetStartPos=function(){return this.startPos},t.prototype.SetStartPos=function(e){this.startPos=e},t.prototype.GetEndPos=function(){return this.endPos},t.prototype.SetEndPos=function(e){this.endPos=e},t.prototype.GetViewName=function(){return this.viewName},t.prototype.SetViewName=function(e){this.viewName=e},t.prototype.GetHotSpotImage=function(){return this.hotspotImage},t.prototype.SetHotSpotImage=function(e){this.hotspotImage=e},t.prototype.GetAnimationName=function(){return this.animationName},t.prototype.SetAnimationName=function(e){this.animationName=e},t.prototype.GetVoiceFileName=function(){return this.voiceFileName},t.prototype.SetVoiceFileName=function(e){this.voiceFileName=e},t}();e.SHotSpot=t})(SView||(SView={}));var SView;(function(e){var t;(function(e){e[e.OPENFILE=0]="OPENFILE",e[e.OPENWEB=1]="OPENWEB",e[e.OPENFTP=2]="OPENFTP",e[e.OPENVIEW=3]="OPENVIEW",e[e.SHOWNOTE=4]="SHOWNOTE",e[e.PLAYANIMATION=5]="PLAYANIMATION",e[e.HIGHLIGHTPARTS=6]="HIGHLIGHTPARTS",e[e.SHOWDESCRIPTION=7]="SHOWDESCRIPTION"})(t=e.SHotSpotActionType||(e.SHotSpotActionType={}));var n=function(){function e(){}return e.prototype.GetId=function(){return this.id},e.prototype.Execute=function(){},e.prototype.GetActionType=function(){return this.type},e}();e.SHotSpotAction=n})(SView||(SView={}));var SView;(function(e){var t=function(e){function t(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];var r=e.call(this)||this;return t.length!==0&&(r.id=t[0],r.type=t[1],r.descriptionStr=t[2]),r}return __extends(t,e),t.prototype.getDescriptionStr=function(){return this.descriptionStr},t.prototype.Execute=function(){this.view.showShotSpotDescribe(this.descriptionStr)},t}(e.SHotSpotAction);e.SHotSpotDescriptionAction=t})(SView||(SView={}));var SView;(function(e){var t=function(e){function t(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];var r=e.call(this)||this;return r.parts=new Array,t.length!==0&&(r.id=t[0],r.type=t[1],r.parts=t[2]),r}return __extends(t,e),t.prototype.getParts=function(){return this.parts},t.prototype.Execute=function(){},t}(e.SHotSpotAction);e.SHotSpotHighLightPartAction=t})(SView||(SView={}));var SView;(function(e){var t=function(){function e(){this.hotSpots=new Array}return e.Instance=function(){return e.instance==null&&(e.instance=new e),e.instance},Object.defineProperty(e.prototype,"view",{get:function(){return this._view},set:function(e){this._view=e},enumerable:!0,configurable:!0}),e.prototype.readFile=function(){},e.prototype.ShowHotSpotOnPart=function(e){return null},e.prototype.GetHotSpotByPart=function(e){var t=new Array,n=this.GetAllHotSpotList();for(var r=0;r<n.length;r++){var i=n[r].GetLinkStr();for(var s=0;s<i.length;s++)if(i[s].indexOf("INS:")){var o=i[s].substring(i[s].lastIndexOf(":")+1),u="";e===u&&t.indexOf(n[r])<0&&t.push(n[r])}}return t},e.prototype.GetHotSpotByPostion=function(e){var t=new Array,n=this.GetAllHotSpotList();for(var r=0;r<n.length;r++)n[r].GetPosX().toFixed(2)===e.x.toFixed(2)&&n[r].GetPosY().toFixed(2)===e.y.toFixed(2)&&n[r].GetPosZ().toFixed(2)===e.z.toFixed(2)&&t.push(n[r]);return t},e.prototype.GetAllHotSpotList=function(){return this.hotSpots},e.prototype.ClearData=function(){this.hotSpots.splice(0,this.hotSpots.length)},e.prototype.AddHotSpot=function(e){var t=e.action;for(var n=0,r=t;n<r.length;n++){var i=r[n];i.view=this.view}this.hotSpots.push(e)},e.prototype.DeleteHotspot=function(e){var t=this.hotSpots.indexOf(e);t>-1&&this.hotSpots.splice(t,1)},e.prototype.DeleteHotspotByName=function(e){for(var t=0,n=this.hotSpots;t<n.length;t++){var r=n[t];if(r.GetName()===e){this.hotSpots.splice(this.hotSpots.indexOf(r),1);return}}},e.prototype.GetHotspot=function(e){for(var t=0,n=this.hotSpots;t<n.length;t++){var r=n[t];if(r.GetName()===e)return r}return null},e.instance=null,e}();e.SHotSpotManager=t})(SView||(SView={}));var SView;(function(e){var t=function(e){function t(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];var r=e.call(this)||this;return t.length!==0&&(t.length===3?(r.id=t[0],r.type=t[1],r.taskName=t[2]):(r.id=t[0],r.type=t[1],r.playMode=t[2],r.processID=t[3],r.stepID=t[4])),r}return __extends(t,e),t.prototype.GetStepID=function(){return this.stepID},t.prototype.GetPlayMode=function(){return this.playMode},t.prototype.GetProcessID=function(){return this.processID},t.prototype.Execute=function(){this.view.AnimationOpenFile();var e=this.view.GetAnimationPlayer().GetTaskList();for(var t=0,n=e;t<n.length;t++){var r=n[t];if(r.GetName()===this.taskName){this.processID=r.GetId().toString();break}var i=r.GetStepList();for(var s=0,o=i;s<o.length;s++){var u=o[s];if(u.GetName()===this.taskName){this.processID=u.GetProcessId(),this.stepID=u.GetId().toString();break}}}this.view.GetAnimationPlayer().playAnimation(Number(this.processID),this.stepID?Number(this.stepID):null)},t}(e.SHotSpotAction);e.SHotSpotOpenAniAction=t})(SView||(SView={}));var SView;(function(e){var t=function(e){function t(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];var r=e.call(this)||this;return t.length!==0&&(r.id=t[0],r.type=t[1],r.url=t[2],r.bytes=t[3]),r}return __extends(t,e),t.prototype.GetUrl=function(){return this.url},t.prototype.GetByte=function(){return this.bytes},t.prototype.Execute=function(){},t}(e.SHotSpotAction);e.SHotSpotOpenUrlAction=t})(SView||(SView={}));var SView;(function(e){var t=function(e){function t(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];var r=e.call(this)||this;return t.length!==0&&t.length===3&&(r.id=t[0],r.type=t[1],r.viewName=t[2]),r}return __extends(t,e),t.prototype.getViewID=function(){return this.viewID},t.prototype.Execute=function(){var e=this.view.view.GetModelViewsList();for(var t=0,n=e;t<n.length;t++){var r=n[t];if(r.GetName()===this.viewName){this.viewID=r.GetID();break}}this.view.view.ShowModelView(Number(this.getViewID()),!0,!0)},t}(e.SHotSpotAction);e.SHotSpotOpenViewAction=t})(SView||(SView={}));var SView;(function(e){var t=function(e){function t(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];var r=e.call(this)||this;return t.length!==0&&(r.id=t[0],r.type=t[1],r.part=t[2],r.noteID=t[3]),r}return __extends(t,e),t.prototype.GetNoteID=function(){return this.noteID},t.prototype.GetPart=function(){return this.part},t.prototype.Execute=function(){},t}(e.SHotSpotAction);e.SHotSpotShowNoteAction=t})(SView||(SView={}));var M3D;(function(e){var t=function(){function e(){}return e.createPowerTwoImage=function(t){var n=t;if(!e.isPowerOfTwo(t.width)||!e.isPowerOfTwo(t.height)){var r=document.createElement("canvas");r.width=e.nearestPowerOfTwo(t.width),r.height=e.nearestPowerOfTwo(t.height);var i=r.getContext("2d");return i.drawImage(t,0,0,r.width,r.height),r}return n},e.LoadImage=function(t,n,r,i){i===void 0&&(i=0);var s=t.GetImage();s.onload=function(){var t=e.createPowerTwoImage(s);n&&n(t,r,i)},s.src=t.GetImagePath()},e.isPowerOfTwo=function(e){return(e&e-1)===0&&e!==0},e.nearestPowerOfTwo=function(e){return Math.pow(2,Math.round(Math.log(e)/Math.LN2))},e.nextPowerOfTwo=function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e++,e},e}();e.ImageLoader=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){this.readListeners=[],this.readNextListener=null,this.readModelListener=null,this.option={readPMI:!1},this.Id=t.globalId++,this.view=null,this.topModel=null,this.readPercent=0,this.allFilesCount=1,this.currentFileIndex=0,this.currentFilesName="",this.File="",this.isCancel=!1}return t.GetReader=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];var r="ERROR",i=null;if(t[0]instanceof FileList){var u=t[0];if(u.length===2){var s=e.FileHelper.GetSuffix(u[0].name),a=e.FileHelper.GetSuffix(u[1].name);if(s==="jsvl"&&a==="bin")i=new e.JSvlReader,i.fileName=u[0].name;else if(a==="jsvl"&&s==="bin")return i=new e.JSvlReader,i.fileName=u[1].name,[i,r]}else if(u.length===1){var s=e.FileHelper.GetSuffix(u[0].name);switch(s){case"svl":i=new e.SvlReader,i.fileName=u[0].name;break;case"stl":i=new e.StlReader,i.fileName=u[0].name;break;case"obj":i=new e.ObjReader,i,i.fileName=u[0].name;break;case"svlx":i=new e.SvlxReader,i.fileName=u[0].name}}return i!==null&&(r="OK"),[i,r]}var s=e.FileHelper.GetSuffix(t[0]),o=t[0];switch(s){case"svl":i=new e.SvlReader,i.fileName=o;break;case"stl":i=new e.StlReader,i.fileName=o;break;case"obj":i=new e.ObjReader,i.fileName=o;break;case"svlx":i=new e.SvlxReader,i.fileName=o}return i!==null&&(r="OK"),[i,r]},t.prototype.ReadFile=function(t){return new e.Model},t.prototype.SetView=function(e){this.view=e},t.prototype.GetResourceManager=function(){return this.view.GetSceneManager().GetResourceManager()},t.prototype.GetView=function(){return this.view},t.prototype.GetModel=function(){return this.topModel},t.prototype.SetModel=function(e){this.topModel=e},t.prototype.GetReadPercent=function(){return this.readPercent},t.prototype.SetReadPercent=function(e){this.readNextListener!=null&&(this.allFilesCount=this.readNextListener.allFilesCount,this.currentFileIndex=this.readNextListener.currentFileIndex,this.currentFilesName=this.readNextListener.currentFilesName),this.readPercent=e;for(var t=0,n=this.readListeners;t<n.length;t++){var r=n[t];r.onReading(this)}},t.prototype.BeginRead=function(){this.SetReadPercent(0);for(var e=0,t=this.readListeners;e<t.length;e++){var n=t[e];n.onReadBegin(this)}},t.prototype.EndRead=function(){this.readModelListener!=null&&this.readModelListener.onReadEnd(this);if(this.readNextListener==null){this.SetReadPercent(1);for(var e=0,t=this.readListeners;e<t.length;e++){var n=t[e];n.onReadEnd(this)}}else{for(var r=0,i=this.readListeners;r<i.length;r++){var n=i[r];n.onSingleFileReadEnd(this)}this.readNextListener.onReadEnd(this)}if(this.view){var s=this.view.GetSceneManager().GetModelFillManager();s.AddSVLXreader(this),s.doNextReaderFill()}},t.prototype.Cancel=function(){for(var e=0,t=this.readListeners;e<t.length;e++){var n=t[e];n.onReadCancel(this)}},t.prototype.SetListeners=function(e){this.readListeners=e},t.prototype.GetListeners=function(){return this.readListeners},t.prototype.AddListener=function(e){return e!==null&&e!==undefined&&this.readListeners.indexOf(e)===-1&&this.readListeners.push(e),!0},t.prototype.RemoveListener=function(e){return e!==null&&e!==undefined&&this.readListeners.indexOf(e)!==-1&&this.readListeners.splice(this.readListeners.indexOf(e),1),!0},t.prototype.coverColorToMaterial=function(t){var n=t.Tostring(),r="ColorBaseMaterial"+n,i=this.GetView().GetSceneManager().GetResourceManager().GetMaterial(r);if(i)return i;i=this.GetView().GetSceneManager().GetResourceManager().GetOrCreateMaterial(r,e.MaterialType.MaterialType_Phong);var s=i;s.SetName(r),s.SetDiffuse(t),s.Opacity(t
.a);var o=20;return o>=0&&s.SetShininess(o),i},t.globalId=0,t}();e.Reader=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var e=t.call(this)||this;return e.delay=50,e.instanceCount=0,e.currentReadInstanceCount=0,e}return __extends(n,t),n.prototype.ReadJSvl=function(t,n){function r(e){e.BeginRead(),e.SetReadPercent(.02),i(e)}function i(e){e.asm=JSON.parse(e.text),s(e),e.SetReadPercent(.12)}function s(e){e.map=e.parseBinary(e.mapObj),e.SetReadPercent(.22),o(e)}function o(e){e.proto=e.asm.ProtoTypes.TopProto!==undefined?e.asm.ProtoTypes.TopProto:e.asm.ProtoTypes,e.proto!==undefined&&e.proto.ChildIns!==undefined&&e.GetInstanceCount(e.asm,e.proto),e.SetReadPercent(.25),u(e)}function u(t){t.topModel=new e.Model,t.topModel.SetName(t.proto.Name),t.topModel.SetPlcId(0);if(t.proto.ChildIns!==undefined)t.SearchInstance(t.asm,t.map,t.proto,t.topModel,t);else{var n=void 0,r=new e.Matrix4,i=t.proto.Name;if(t.map.contains(i)){var s=t.map.get(i);if(s!=""){var o=!1;t.AddMesh(t.topModel,s[0],s[1],s[2],s[3],o)}else n=new e.Body,t.topModel.AddBody(n)}else n=new e.Body,t.topModel.AddBody(n);t.topModel.SetPlaceMatrix(r)}a(t)}function a(e){e.SetReadPercent(.9),e.EndRead()}return this.text=t,this.mapObj=n,r(this),null},n.prototype.ReadFile=function(t){var n=new e.Model;return n},n.prototype.GetInstanceCount=function(e,t){var n=t.ChildIns;this.instanceCount++;for(var r=0;r<n.length;r++){var i="ChildIns"+(r+1),s=n[r][i],o=s.PointProtoName,u=e.ProtoTypes[o];u!==undefined&&u.ChildIns!==undefined&&this.GetInstanceCount(e,u)}},n.prototype.SearchInstance=function(e,t,n,r,i){i.SetReadPercent(.25+.65*i.currentReadInstanceCount++/i.instanceCount);var s=n.ChildIns;for(var o=0;o<s.length;o++){var u="ChildIns"+(o+1),a=s[o][u],f=i.CreateInstance(t,a);r.AddSubModel(f);var l=a.PointProtoName,c=e.ProtoTypes[l];c!==undefined&&c.ChildIns!==undefined&&i.SearchInstance(e,t,c,f,i),f=null}},n.prototype.CreateInstance=function(t,n){var r=new e.Model,i,s,o=!1,u=new e.Matrix4,a=n.InsName;r.SetName(a),r.SetPlcId(n.PlcID),n.HasColor==1&&(o=n.Color),i=n.PlcMatrix,i===undefined?console.log("Warning: the ProtoType "+a+" have not PlacementMatrix!"):u=new e.Matrix4(i[0],i[1],i[2],i[3],i[4],i[5],i[6],i[7],i[8],i[9],i[10],i[11],i[12],i[13],i[14],i[15]);var f=n.PointProtoName;if(t.contains(f)){var l=t.get(f);l!=""?this.AddMesh(r,l[0],l[1],l[2],l[3],o):(s=new e.Body,r.AddBody(s))}else s=new e.Body,r.AddBody(s);return r.SetPlaceMatrix(u),r},n.prototype.AddMesh=function(t,n,r,i,s,o){var u,a;if(!n||n&&n.length<3){console.log("vertex array length is too short!");return}var f=new e.Color(.5,.5,.5,1),l=0;if(i&&i.length>2){var c=void 0;for(var h=0,p=i.length;h<p;h+=1){o!==!1?o[0]>-0.00001&&o[0]<1.00001?c=new e.Color(o[0],o[1],o[2],1-o[3]):s.length>h/3*4&&s[h/3*4]>-0.00001&&s[h/3*4]<1.00001&&(c=new e.Color(s[h/3*4],s[h/3*4+1],s[h/3*4+2],1-s[h/3*4+3])):s.length>h/3*4&&s[h/3*4]>-0.00001&&s[h/3*4]<1.00001&&(c=new e.Color(s[h/3*4],s[h/3*4+1],s[h/3*4+2],1-s[h/3*4+3])),c||(c=new e.Color(.5,.5,.5,1));if(h==0)f=c,l=h;else if(!c.Equals(f)||h==i.length-1){var d=h-l;h==i.length-1&&++d,u=new Float32Array(d*3),r&&(a=new Float32Array(d*3));for(var v=0;v<d;++v)u[v*3]=n[i[v+l]*3],u[v*3+1]=n[i[v+l]*3+1],u[v*3+2]=n[i[v+l]*3+2],a&&(a[v*3]=r[i[v+l]*3],a[v*3+1]=r[i[v+l]*3+1],a[v*3+2]=r[i[v+l]*3+2]);var m=[],g=void 0,y=new e.VertexSet;y.SetUseIndex(!1),y.SetPositionArray(u);var b=new e.Body;a&&u.length==a.length?y.SetNormalArray(a):y.computeVertexNormals(),b.SetVertexSet(y);var w=new e.Face;w.SetInitColor(f),b.AddFace(w);var E=new e.Mesh(y),S=y.GetPositionArray().length/3;E.SetDataOffset(0),E.SetDataLength(S),w.SetMesh(E),t.AddBody(b),f=c,l=h}}}else{var x=new e.Color(.5,.5,.5,1),T=0,c=void 0;for(var h=0;h<n.length;++h){o!==!1?o[0]>-0.00001&&o[0]<1.00001?c=new e.Color(o[0],o[1],o[2],1-o[3]):s.length>h/9*4&&s[h/9*4]>-0.00001&&s[h/9*4]<1.00001&&(c=new e.Color(s[h/9*4],s[h/9*4+1],s[h/9*4+2],1-s[h/9*4+3])):s.length>h/9*4&&s[h/9*4]>-0.00001&&s[h/9*4]<1.00001&&(c=new e.Color(s[h/9*4],s[h/9*4+1],s[h/9*4+2],1-s[h/9*4+3])),c||(c=new e.Color(.5,.5,.5,1));if(h==0)x=c,T=h;else if(!c.Equals(x)||h==i.length-1){var d=h-T;h==i.length-1&&++d,u=new Float32Array(d),r&&(a=new Float32Array(d));for(var v=0;v<d;++v)u[v]=n[v+T],a&&(a[v]=r[v+T]);var m=[],g=void 0,y=new e.VertexSet;y.SetUseIndex(!1),y.SetPositionArray(u);var b=new e.Body;a&&u.length==a.length?y.SetNormalArray(a):y.computeVertexNormals(),b.SetVertexSet(y);var w=new e.Face;w.SetRenderColor(x),b.AddFace(w);var E=new e.Mesh(y),S=y.GetPositionArray().length/3;E.SetDataOffset(0),E.SetDataLength(S),w.SetMesh(E),t.AddBody(b),x=c,T=h}}}},n.prototype.parseBinary=function(t){var n=t.length,r=new e.Dictionary;if(n>552){var i=new e.Dictionary,s=void 0,o=void 0,u=0,a=0;while(u<n){a=u+24;var f=t.charCodeAt(a),l=t.charCodeAt(a+1)<<8,c=t.charCodeAt(a+2)<<16,h=t.charCodeAt(a+3)<<24,p=f|l|c|h;u+=p+28;if(u>n)return console.log("RangeError: offset is outside the bounds of the DataView!"),console.log("Failed to read the prototype name!"),i;a+=16;var d=t.slice(a,a+512);s=this.getProtoName(d),a=u,a+=24,f=t.charCodeAt(a),l=t.charCodeAt(a+1)<<8,c=t.charCodeAt(a+2)<<16,h=t.charCodeAt(a+3)<<24;var v=f|l|c|h;u+=v+28;if(u>n)return console.log("RangeError: offset is outside the bounds of the DataView!"),console.log("Failed to read the prototype MeshDate!"),i;a+=16,f=t.charCodeAt(a),l=t.charCodeAt(a+1)<<8,c=t.charCodeAt(a+2)<<16,h=t.charCodeAt(a+3)<<24;var m=f|l|c|h;if(m!==0){var g=0;o=new Array(4);var y=new Array(m*3);a+=4;for(var b=0;b<m;b++){var w=a+b*12,E=new ArrayBuffer(4),S=new Int8Array(E);S[0]=t.charCodeAt(w+0),S[1]=t.charCodeAt(w+1),S[2]=t.charCodeAt(w+2),S[3]=t.charCodeAt(w+3);var x=new DataView(E);y[g]=x.getFloat32(0,!0),S[0]=t.charCodeAt(w+4),S[1]=t.charCodeAt(w+5),S[2]=t.charCodeAt(w+6),S[3]=t.charCodeAt(w+7),x=new DataView(E),y[g+1]=x.getFloat32(0,!0),S[0]=t.charCodeAt(w+8),S[1]=t.charCodeAt(w+9),S[2]=t.charCodeAt(w+10),S[3]=t.charCodeAt(w+11),x=new DataView(E),y[g+2]=x.getFloat32(0,!0),g+=3}o[0]=y,g=0,a+=m*12,a+=12,a+=4;var T=new Array(m*3);for(var N=0;N<m;N++){var C=a+N*12,k=void 0,L=new ArrayBuffer(4),A=new Int8Array(L);A[0]=t.charCodeAt(C+0),A[1]=t.charCodeAt(C+1),A[2]=t.charCodeAt(C+2),A[3]=t.charCodeAt(C+3),k=new DataView(L),T[g]=k.getFloat32(0,!0),A[0]=t.charCodeAt(C+4),A[1]=t.charCodeAt(C+5),A[2]=t.charCodeAt(C+6),A[3]=t.charCodeAt(C+7),k=new DataView(L),T[g+1]=k.getFloat32(0,!0),A[0]=t.charCodeAt(C+8),A[1]=t.charCodeAt(C+9),A[2]=t.charCodeAt(C+10),A[3]=t.charCodeAt(C+11),k=new DataView(L),T[g+2]=k.getFloat32(0,!0),g+=3}o[1]=T,a+=m*12,a+=12;var O=void 0,M=new ArrayBuffer(4),_=new Int8Array(M);_[0]=t.charCodeAt(a+0),_[1]=t.charCodeAt(a+1),_[2]=t.charCodeAt(a+2),_[3]=t.charCodeAt(a+3),O=new DataView(M);var D=O.getUint32(0,!0);a+=4;var P=new Array(D);for(var H=0;H<D;H++){var B=a+H*4;_[0]=t.charCodeAt(B+0),_[1]=t.charCodeAt(B+1),_[2]=t.charCodeAt(B+2),_[3]=t.charCodeAt(B+3),O=new DataView(M),P[H]=O.getUint32(0,!0)}o[2]=P,g=0,a+=D*4,a+=12,_[0]=t.charCodeAt(a+0),_[1]=t.charCodeAt(a+1),_[2]=t.charCodeAt(a+2),_[3]=t.charCodeAt(a+3),O=new DataView(M);var j=O.getUint32(0,!0);a+=4;var F=new Array(D/3*4);for(var I=0;I<j;I++){var q=a+I*16;_[0]=t.charCodeAt(q+0),_[1]=t.charCodeAt(q+1),_[2]=t.charCodeAt(q+2),_[3]=t.charCodeAt(q+3),O=new DataView(M),F[g]=O.getFloat32(0,!0),_[0]=t.charCodeAt(q+4),_[1]=t.charCodeAt(q+5),_[2]=t.charCodeAt(q+6),_[3]=t.charCodeAt(q+7),O=new DataView(M),F[g+1]=O.getFloat32(0,!0),_[0]=t.charCodeAt(q+8),_[1]=t.charCodeAt(q+9),_[2]=t.charCodeAt(q+10),_[3]=t.charCodeAt(q+11),O=new DataView(M),F[g+2]=O.getFloat32(0,!0),_[0]=t.charCodeAt(q+12),_[1]=t.charCodeAt(q+13),_[2]=t.charCodeAt(q+14),_[3]=t.charCodeAt(q+15),O=new DataView(M),F[g+3]=O.getFloat32(0,!0),g+=4}o[3]=F}else o="";i.getOrAdd(s,o)}return o=null,i}return console.log("Warning: Not Find MeshData!!!"),""},n.prototype.getProtoName=function(e){var t="",n=String.fromCharCode(0);for(var r=0;r<e.length;r+=2){var i=String.fromCharCode(e.charCodeAt(r)|e.charCodeAt(r+1)<<8);if(i===n)break;t+=i}return t},n}(e.Reader);e.AsyJSvlReader=t})(M3D||(M3D={}));var M3D;(function(e){String.prototype.trim=function(){return this.replace(/(^\s*)|(\s*$)/g,"")};var t=function(){function t(){}return t.Instance=function(){return t.instance||(t.instance=new t),t.instance},t.prototype.LoadMtl=function(t,n){var r=t.split("\n"),i,s=n,o=/([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+/;for(var u=0;u<r.length;++u){var a=r[u];a=a.trim();if(a===null||a===undefined||a.length==0)continue;var f=a.substr(0,7);f=f.toLowerCase();if(f==="newmtl "){var l=a.substr(7);i=s.GetMaterial(l),i===null&&(i=new e.Material,i.SetName(l),s.AddMaterial(l,i));continue}if(i===null||i===undefined)continue;f=a.substr(0,3),f=f.toLowerCase();var c=void 0;switch(f){case"ka ":c=o.exec(a.substr(3));if(c===null)continue;i.SetAmbient(new e.Color(parseFloat(c[1]),parseFloat(c[3]),parseFloat(c[5])));continue;case"kd ":c=o.exec(a.substr(3));if(c===null)continue;i.SetDiffuse(new e.Color(parseFloat(c[1]),parseFloat(c[3]),parseFloat(c[5])));continue;case"ks ":c=o.exec(a.substr(3));if(c===null)continue;i.SetSpecular(new e.Color(parseFloat(c[1]),parseFloat(c[3]),parseFloat(c[5])));continue;case"kt ":continue;case"ni ":continue;case"ke ":continue;case"ns ":continue}f=a.substr(0,7),f=f.toLowerCase();var h=void 0;h=a.substr(7);switch(f){case"map_ka ":if(h.charAt(0)!=="."||h.charAt(1)!=="\\"&&h.charAt(1)!=="/"){if(h.charAt(0)==="\\"||h.charAt(0)==="/")h=h.substr(1)}else h=h.substr(2);h=h.trim();var p=s.GetOrCreateTexture(h),d=s.GetImage(h);d===null&&(d=s.GetOrCreateImage(h)),p.AddImage(d),i.SetAmbientTexture(p);continue;case"map_kd ":if(h.charAt(0)!=="."||h.charAt(1)!=="\\"&&h.charAt(1)!=="/"){if(h.charAt(0)==="\\"||h.charAt(0)==="/")h=h.substr(1)}else h=h.substr(2);h=h.trim();var p=s.GetOrCreateTexture(h),d=s.GetImage(h);d===null&&(d=s.GetOrCreateImage(h)),p.AddImage(d),i.SetDiffuseTexture(p);continue;case"map_ks ":if(h.charAt(0)!=="."||h.charAt(1)!=="\\"&&h.charAt(1)!=="/"){if(h.charAt(0)==="\\"||h.charAt(0)==="/")h=h.substr(1)}else h=h.substr(2);h=h.trim();var p=s.GetOrCreateTexture(h),d=s.GetImage(h);d===null&&(d=s.GetOrCreateImage(h)),p.AddImage(d),i.SetSpecularTexture(p);continue}}},t.prototype.fillMaterial=function(e,t,n){var r=e.GetSceneManager().GetResourceManager(),i=r.GetOrCreateTexture(n),s=r.GetImage(n);s===null&&(s=r.GetOrCreateImage(n,n)),i.AddImage(s);var o=[],u=[];this.getAllModelFace(o,t),o.forEach(function(e){e.SetDiffuseMap(i)})},t.prototype.getAllModelFace=function(e,t){var n=t.GetModelShape();if(n){var r=n.GetBodys();for(var i=0;i<r.length;i++){var s=r[i].GetFaces();for(var o=0;o<s.length;o++){var u=s[o].GetMaterial(),a=e.indexOf(u);if(a>-1)continue;a<0&&e.push(u)}}}var f=t.GetSubModels(),l=this;f.forEach(function(t){l.getAllModelFace(e,t)})},t.instance=null,t}();e.MaterialReader=t})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.PMISourceUnknown=0]="PMISourceUnknown",e[e.PMI_SOURCE_CONVERT=1]="PMI_SOURCE_CONVERT",e[e.PMI_SOURCE_CREATE=2]="PMI_SOURCE_CREATE"})(t=e.StkPMISourceEnum||(e.StkPMISourceEnum={}));var n;(function(e){e[e.PMI_TYPE_UNKNOWN=0]="PMI_TYPE_UNKNOWN",e[e.PMI_TYPE_LinearDimension=1]="PMI_TYPE_LinearDimension",e[e.PMI_TYPE_AngularDimension=2]="PMI_TYPE_AngularDimension",e[e.PMI_TYPE_CurvilinearDimension=3]="PMI_TYPE_CurvilinearDimension",e[e.PMI_TYPE_DiameterDimension=4]="PMI_TYPE_DiameterDimension",e[e.PMI_TYPE_LinearDiameterDimension=5]="PMI_TYPE_LinearDiameterDimension",e[e.PMI_TYPE_RadiusDimension=6]="PMI_TYPE_RadiusDimension",e[e.PMI_TYPE_LinearRadiusDimension=7]="PMI_TYPE_LinearRadiusDimension",e[e.PMI_TYPE_CumulatedDimension=8]="PMI_TYPE_CumulatedDimension",e[e.PMI_TYPE_ChamferDimension=9]="PMI_TYPE_ChamferDimension",e[e.PMI_TYPE_DistanceDimension=10]="PMI_TYPE_DistanceDimension",e[e.PMI_TYPE_LengthDimension=11]="PMI_TYPE_LengthDimension",e[e.PMI_TYPE_TypeNote=12]="PMI_TYPE_TypeNote",e[e.PMI_TYPE_TypeDatum=13]="PMI_TYPE_TypeDatum",e[e.PMI_TYPE_TypeBalloon=14]="PMI_TYPE_TypeBalloon",e[e.PMI_TYPE_TypeDatumTarget=15]="PMI_TYPE_TypeDatumTarget",e[e.PMI_TYPE_TypeRoughness=16]="PMI_TYPE_TypeRoughness",e[e.PMI_TYPE_TypeDimension=17]="PMI_TYPE_TypeDimension",e[e.PMI_TYPE_TypeFlagNote=18]="PMI_TYPE_TypeFlagNote",e[e.PMI_TYPE_TypeGeometricalTolerance=19]="PMI_TYPE_TypeGeometricalTolerance",e[e.PMI_TYPE_TypeAnnotationTable=20]="PMI_TYPE_TypeAnnotationTable",e[e.PMI_TYPE_TypeCell=21]="PMI_TYPE_TypeCell",e[e.PMI_TYPE_TypeTable=22]="PMI_TYPE_TypeTable",e[e.PMI_TYPE_TypeCallout=23]="PMI_TYPE_TypeCallout",e[e.PMI_TYPE_TypeWelding=24]="PMI_TYPE_TypeWelding",e[e.PMI_TYPE_TypeCoordinateDimension=25]="PMI_TYPE_TypeCoordinateDimension",e[e.PMI_TYPE_Symbol=26]="PMI_TYPE_Symbol",e[e.PMI_TYPE_SVIEW_3DNOTE=27]="PMI_TYPE_SVIEW_3DNOTE",e[e.PMI_TYPE_SVIEW_ARC=28]="PMI_TYPE_SVIEW_ARC",e[e.PMI_TYPE_SVIEW_NOTE_COMPONENT=29]="PMI_TYPE_SVIEW_NOTE_COMPONENT",e[e.PMI_TYPE_SVIEW_NOTE_WELD=30]="PMI_TYPE_SVIEW_NOTE_WELD",e[e.PMI_TYPE_SVIEW_NOTE_COMPONENT_SN=31]="PMI_TYPE_SVIEW_NOTE_COMPONENT_SN",e[e.PMI_TYPE_SVIEW_NOTE_WELD_SN=32]="PMI_TYPE_SVIEW_NOTE_WELD_SN",e[e.PMI_TYPE_SVIEW_PICTURE=33]="PMI_TYPE_SVIEW_PICTURE",e[e.PMI_TYPE_DISTANCE_POINT_TO_POINT=34]="PMI_TYPE_DISTANCE_POINT_TO_POINT",e[e.PMI_TYPE_DISTANCE_POINT_TO_LINE=35]="PMI_TYPE_DISTANCE_POINT_TO_LINE",e[e.PMI_TYPE_DISTANCE_POINT_TO_FACE=36]="PMI_TYPE_DISTANCE_POINT_TO_FACE",e[e.PMI_TYPE_DISTANCE_LINE_TO_LINE=37]="PMI_TYPE_DISTANCE_LINE_TO_LINE",e[e.PMI_TYPE_DISTANCE_LINE_TO_FACE=38]="PMI_TYPE_DISTANCE_LINE_TO_FACE",e[e.PMI_TYPE_DISTANCE_FACE_TO_FACE=39]="PMI_TYPE_DISTANCE_FACE_TO_FACE",e[e.PMI_TYPE_DISTANCE_CENTER_TO_CENTER=40]="PMI_TYPE_DISTANCE_CENTER_TO_CENTER",e[e.PMI_TYPE_DISTANCE_WHEELBASE=41]="PMI_TYPE_DISTANCE_WHEELBASE"})(n=e.StkPMITypeEnum||(e.StkPMITypeEnum={}));var r;(function(e){e[e.CURVE_TYPE_UNKNOWN=0]="CURVE_TYPE_UNKNOWN",e[e.CURVE_TYPE_POLYLINE=1]="CURVE_TYPE_POLYLINE",e[e.CURVE_TYPE_ELLIPSE=2]="CURVE_TYPE_ELLIPSE",e[e.CURVE_TYPE_LINE=3]="CURVE_TYPE_LINE",e[e.CURVE_TYPE_NURBSCURVE=4]="CURVE_TYPE_NURBSCURVE",e[e.CURVE_TYPE_HYPERBOLA=5]="CURVE_TYPE_HYPERBOLA",e[e.CURVE_TYPE_PARABOLA=6]="CURVE_TYPE_PARABOLA"})(r=e.StkCurveTypeEnum||(e.StkCurveTypeEnum={}));var i=function(){function i(){}return i.CreateExtensionLines=function(t,n){var i=!1,s=0,o=t.length;if(0==o)return i;for(var u=0;u<o;u++){var a=t[u];if(a==null)continue;var f=a.exLineType;if(r.CURVE_TYPE_POLYLINE==f){var l=a.curves.polylines[0];if(l==null)continue;var c=[];for(var h=0;h<l.points.length/3;h++){var p=new e.Vector3;p.x=l.points[h*3],p.y=l.points[h*3+1],p.z=l.points[h*3+2],c.push(p)}n.push(c)}else if(r.CURVE_TYPE_LINE==f){var d=a.curves.line,c=[];c.push(d.startPnt[0],d.startPnt[1],d.startPnt[2]),c.push(d.endPnt[0],d.endPnt[1],d.endPnt[2]),n.push(c)}}return!0},i.CreateOutFrame=function(t,n,r){var s=0;for(var o=0;o<t.length;o++){var u=t[o],a=u.GetFrameData(),f=u.GetFrameType();for(var l=0;l<a.length;l++){var c=a[l],h=c.GetCurveType(),p=void 0;if(h==1)p=c.GetPoints();else if(h==2){var d=new e.Stk_Arc;d.fromJson(c),e.TessCircle.GetCircleDiscretization(d,0,p)}if(p.length!=0){for(var v=0;v<p.length;v++)n.push(p[v]),r.push(s),s++;r.push(i.SO_END_FACE_INDEX)}}}return!0},i.CreateAnchorPoints=function(e,t,n){return!0},i.CreateEndSymbol=function(t,n,i){var s=!1,o=[],u=[],a=[],f=[],l=[],c=new e.Vector3,h=new e.Vector3,p=!1;if(t==null)return s;var d=t.leaders;if(d==null)return s;var v=0,m=0,g=d.length;if(g<=0)return!1;var y=[],b=d[0],w,E=null,S=r.CURVE_TYPE_UNKNOWN;if(b==null)return s;b.curves.polylines!=undefined?w=b.curves.polylines:b.curves.arcs!=undefined?w=b.curves.arcs:b.curves.lines!=undefined&&(w=b.curves.lines);if(w.length==0)return s;E=w[w.length-1];if(E==null)return s;S=E.type,p=e.PMIUtility.GetEndSymbolDirection(d,y);for(var x=0;x<g;x++){a.length=0,f.length=0,b=d[x];if(b==null)return s;i=b.termType;for(var T=0,N=b.termSize.split(" ");T<N.length;T++){var C=N[T];l.push(parseFloat(C))}c.fromString(b.termLoc),h.fromString(b.termDir);if(h.x!=h.x||h.y!=h.y)return!1;S==r.CURVE_TYPE_POLYLINE&&p&&(h.x=h.x*y[x],h.y=h.y*y[x],h.z=h.z*y[x]),o[0]=c.x,o[1]=c.y,o[2]=c.z,u[0]=h.x,u[1]=h.y,u[2]=h.z;var k=[0,0,0],L=[0,0,0],A=Math.sqrt(u[0]*u[0]+u[1]*u[1]+u[2]*u[2]);L[0]=u[0]/A,L[1]=u[1]/A,L[2]=u[2]/A,k[0]=-1*L[1],k[1]=L[0],k[2]=0,e.PMIESymbol.SetESymbolInfo(l[0],l[1],o,u,k,i,a,f);var O=a.length,M=[];for(v=0;v<O;v++){var _=new e.Vector3;_.x=a[v].x,_.y=a[v].y,_.z=a[v].z,M.push(_)}O>0&&n.push(M),M=[],O=f.length;for(v=0;v<O;v++){var _=new e.Vector3;_.x=f[v].x,_.y=f[v].y,_.z=f[v].z,M.push(_)}O>0&&n.push(M)}return!0},i.CreateLeader=function(i,s,o,u){var a=[],f=[],l=[],c=0,h=!1,p=!1,d=[],v=u.Source,m=u.Type,g=[];g.push(s),m==n.PMI_TYPE_TypeNote&&(g.length=0);var y=i.length;if(y<=0)return!1;var b=i[0],w=[];b.curves.polylines!=undefined?w=b.curves.polylines:b.curves.arcs!=undefined?w=b.curves.arcs:b.curves.lines!=undefined&&(w=b.curves.lines);if(w.length==0)return!1;var E=w[w.length-1];E.type==r.CURVE_TYPE_ELLIPSE&&(h=e.TessCircle.GetCircleDrawData(i,f,l,c,a)),p=e.PMIUtility.GetEndSymbolDirection(i,d);var S=new e.Vector3;S.x=(s.BoundBox[0][0]+s.BoundBox[1][0])*.5,S.y=(s.BoundBox[0][1]+s.BoundBox[1][1])*.5,S.z=(s.BoundBox[0][2]+s.BoundBox[1][2])*.5;var x=new Array,T=0;for(var N=0;N<i.length;N++){var C=i[N],k=[],L=[],A=0,O=[],M=[];C.curves.polylines!=undefined?M=C.curves.polylines:C.curves.arcs!=undefined?M=C.curves.arcs:C.curves.lines!=undefined&&(M=C.curves.lines);var _=M[0];if(_!=null)if(r.CURVE_TYPE_POLYLINE==_.type){var D=[];for(var P=0;P<_.points.length/3;P++){var H=new e.Vector3;H.x=_.points[P*3],H.y=_.points[P*3+1],H.z=_.points[P*3+2],D.push(H)}v!=t.PMI_SOURCE_CREATE||m!=n.PMI_TYPE_RadiusDimension&&m!=n.PMI_TYPE_DiameterDimension?e.PMIUtility.DivideLeader(2,g,D,O):D.length==2&&e.PMIUtility.DivideLeader(2,g,D,O);if(D.length!=0)if(O.length==0)for(var B=0;B<D.length;B++)k.push(D[B]),L.push(A),A++;else for(var B=0;B<O.length;B++)k.push(O[B]),L.push(A),A++;o.push(k),T+=A}else if(r.CURVE_TYPE_ELLIPSE==_.type){var j=[],F=new e.Stk_Arc;F.fromJson(_);var I=0,q=0,R=0,U=0,z=0;h?e.TessCircle.GetCircleDiscretization2(F,f[N],l[N],0,a[N],j):e.TessCircle.GetCircleDiscretization(F,0,j),e.PMIUtility.DivideLeader(2,g,j,O);if(j.length!=0)if(O.length==0)for(var B=0;B<3;B++)k.push(j[B]),L.push(A),A++;else for(var B=0;B<O.length;B++)k.push(O[B]),L.push(A),A++;o.push(k),T+=A,x.length>0&&(O.length=0,e.PMIUtility.DivideLeader(2,g,x,O),O.length==0?(o.push(x),T+=x.length):(o.push(O),T+=O.length))}else if(r.CURVE_TYPE_LINE==_.type){var W=[];W.push(new e.Vector3(_.StartPoint[0],_.StartPoint[1],_.StartPoint[2])),W.push(new e.Vector3(_.EndPoint[0],_.EndPoint[1],_.EndPoint[2])),o.push(W),T+=2}}return!0},i.CreateSpeciallLines=function(t,n,r){var s=0;for(var o=0;o<t.length;o++){var u=t[o];if(u.curves.polylines!=undefined){var a=u.curves.polylines;for(var f=0;f<a.length;f++){var l=a[f],c=[];for(var h=0;h<l.points.length/3;h++){var p=new e.Vector3;p.x=l.points[h*3],p.y=l.points[h*3+1],p.z=l.points[h*3+2],c.push(p)}if(c.length!=0){for(var d=0;d<c.length;d++)n.push(c[d]),r.push(s),s++;r.push(i.SO_END_FACE_INDEX)}}}if(u.curves.arcs!=undefined){var a=u.curves.arcs;for(var f=0;f<a.length;f++){var v=new e.Stk_Arc;v.fromJson(a[f]);var c=[];e.TessCircle.GetCircleDiscretization(v,0,c);if(c.length!=0){for(var m=0;m<c.length;m++)n.push(c[m]),r.push(s),s++;r.push(i.SO_END_FACE_INDEX)}}}if(u.curves.lines!=undefined){var a=u.curves.lines;for(var f=0;f<a.length;f++){var g=a[f],c=[],y=new e.Vector3;y.fromString(g.startPnt);var b=new e.Vector3;b.fromString(g.endPnt),c.push(y),c.push(b);if(c.length!=0){for(var w=0;w<c.length;w++)n.push(c[w]),r.push(s),s++;r.push(i.SO_END_FACE_INDEX)}}}}return!0},i.SO_END_FACE_INDEX=-1,i}();e.PMICreator=i})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.TERM_PATSMNONE=0]="TERM_PATSMNONE",e[e.TERM_PATSMOPENARROW=1]="TERM_PATSMOPENARROW",e[e.TERM_PATSMCLOSEARROW=2]="TERM_PATSMCLOSEARROW",e[e.TERM_PATSMFILLARROW=3]="TERM_PATSMFILLARROW",e[e.TERM_PATSMCROSSARROW=4]="TERM_PATSMCROSSARROW",e[e.TERM_PATSMCIRCLE=5]="TERM_PATSMCIRCLE",e[e.TERM_PATSMFILLEDCIRCLE=6]="TERM_PATSMFILLEDCIRCLE",e[e.TERM_PATSMSQUARE=7]="TERM_PATSMSQUARE",e[e.TERM_PATSMFILLEDSQUARE=8]="TERM_PATSMFILLEDSQUARE",e[e.TERM_PATSMSLASH=9]="TERM_PATSMSLASH",e[e.TERM_PATSMCROSSCIRCLE=10]="TERM_PATSMCROSSCIRCLE",e[e.TERM_PATSMXCIRCLE=11]="TERM_PATSMXCIRCLE",e[e.TERM_PATSMTRIANGLE=12]="TERM_PATSMTRIANGLE",e[e.TERM_PATSMFILLEDTRIANGLE=13]="TERM_PATSMFILLEDTRIANGLE",e[e.TERM_PATSMPLUS=14]="TERM_PATSMPLUS",e[e.TERM_PATSMXCROSS=15]="TERM_PATSMXCROSS",e[e.TERM_PATSMINTEGRAL=16]="TERM_PATSMINTEGRAL",e[e.TERM_PATSMCIRCLECENTER=17]="TERM_PATSMCIRCLECENTER",e[e.TERM_PATSMDOUBLEOPENCENTER=18]="TERM_PATSMDOUBLEOPENCENTER",e[e.TERM_PATSMDOUBLECLOSEARROW=19]="TERM_PATSMDOUBLECLOSEARROW",e[e.TERM_PATSMDOUBLEFILLARROW=20]="TERM_PATSMDOUBLEFILLARROW",e[e.TERM_PATSMDOUBLETRIANGLE=21]="TERM_PATSMDOUBLETRIANGLE",e[e.TERM_PATSMWHTTRI=22]="TERM_PATSMWHTTRI",e[e.TERM_PATSMBLKTRI=23]="TERM_PATSMBLKTRI",e[e.TERM_PATSMWHTTRI2=24]="TERM_PATSMWHTTRI2",e[e.TERM_PATSMSPACELIN=25]="TERM_PATSMSPACELIN"})(t=e.StkTermTypeEnum||(e.StkTermTypeEnum={}));var n=function(){function t(){}return t.SetESymbolInfo=function(n,r,i,s,o,u,a,f){var l=[0,0,0],c=[0,0,0],h=0,p=0,d=0,v=r/2,m=3,g=[0,0,0],y=[0,0,0],b=[[0,0,0],[0,0,0]],w=[0,0,0],E=0,S=37,x=e.PI/18,T=0,N=0,C=e.PI/4,k=[0,0,0],L=0,A=0,O=1,M=0,_=[[0,0,0],[0,0,0],[0,0,0],[0,0,0]],D=0,P=0,H=[[0,0,0],[0,0,0],[0,0,0],[0,0,0]],B=[1,0,0],j=[0,1,0],F=[[0,0,0],[0,0,0],[0,0,0],[0,0,0]],I=[0,0,0],q=1,R=[0,0,0],U=1,z=[0,0,0],W=new e.Vector3,X=new e.Vector3,V=new e.Vector3,$=new e.Vector3,J=new e.Vector3,K=new e.Vector3,Q=0,G=0,Y=0;this.LengthAndUnit(3,s,Y,l),this.LengthAndUnit(3,o,Y,c),d=Math.sqrt(v*v+n*n),h=n/d,p=v/d,g[0]=c[0],g[1]=c[1],g[2]=c[2],y[0]=-c[0],y[1]=-c[1],y[2]=-c[2],E=r/2,T=d/2,M=n,L=r,A=r,D=r,P=n,q=r/2,U=n/2,G=n/3*2;switch(u){case t.TERM_PATSMARW:case t.TERM_PATSMWHTARW:case t.TERM_PATSMBLKARW:case t.PATCROSSARW:var Z=new e.Vector3;Z.x=i[0]+n*s[0],Z.y=i[1]+n*s[1],Z.z=i[2]+n*s[2],W.x=Z.x+r/2*g[0],W.y=Z.y+r/2*g[1],W.z=Z.z+r/2*g[2],a.push(W.Clone()),W.x=i[0],W.y=i[1],W.z=i[2],a.push(W.Clone()),W.x=Z.x+r/2*y[0],W.y=Z.y+r/2*y[1],W.z=Z.z+r/2*y[2],a.push(W.Clone()),u==t.TERM_PATSMWHTARW&&(W.x=Z.x+r/2*g[0],W.y=Z.y+r/2*g[1],W.z=Z.z+r/2*g[2],a.push(W.Clone()));break;case t.TERM_PATSMWHTCIR:case t.TERM_PATSMBLKCIR:case t.TERM_PATSMCROSSEDCIR:u==t.TERM_PATSMBLKCIR&&(S=6,x=2*e.PI/6);for(var et=0;et<S;et++)W.x=i[0]+E*Math.cos(x*et),W.y=i[1]+E*Math.sin(x*et),W.z=i[2],a.push(W.Clone());break;case t.TERM_PATSMSLASH_TYPE:N=Math.sqrt(r*r+n*n),k[0]=l[0]*Math.cos(C)-l[1]*Math.sin(C),k[1]=l[0]*Math.sin(C)+l[1]*Math.cos(C),k[2]=0,W.x=i[0]+N/2*k[0],W.y=i[1]+N/2*k[1],W.z=i[2],a.push(W.Clone()),W.x=W.x-N*k[0],W.y=W.y-N*k[1],W.z=i[2],a.push(W.Clone());break;case t.TERM_PATSMWHTTRI_TYPE:case t.TERM_PATSMBLKTRI_TYPE:case t.TERM_PATSMWHTTRI2_TYPE:case t.PATSSPACELIN_TYPE:_[0][0]=i[0]+M*l[0],_[0][1]=i[1]+M*l[1],_[0][2]=0,u==t.PATSSPACELIN_TYPE?(_[1][0]=i[0]+A/2*l[1]+O*l[0],_[1][1]=i[1]-A/2*l[0]+O*l[1],_[1][2]=0,_[2][0]=i[0]-A/2*l[1]+O*l[0],_[2][1]=i[1]+A/2*l[0]+O*l[1],_[2][2]=0):(_[1][0]=i[0]+L/2*l[1],_[1][1]=i[1]-L/2*l[0],_[1][2]=0,_[2][0]=i[0]-L/2*l[1],_[2][1]=i[1]+L/2*l[0],_[2][2]=0),_[3][0]=i[0]+M*l[0],_[3][1]=i[1]+M*l[1],_[3][2]=0,u==t.PATSSPACELIN_TYPE?(W.x=_[1][0],W.y=_[1][1],W.z=i[2],a.push(W.Clone()),W.x=_[2][0],W.y=_[2][1],W.z=i[2],a.push(W.Clone()),W.x=_[2][0],W.y=_[2][1],W.z=i[2],a.push(W.Clone())):(W.x=_[2][0],W.y=_[2][1],W.z=i[2],a.push(W.Clone()),W.x=_[0][0],W.y=_[0][1],W.z=i[2],a.push(W.Clone()),W.x=_[1][0],W.y=_[1][1],W.z=i[2],a.push(W.Clone()),u==t.TERM_PATSMWHTTRI_TYPE&&(W.x=_[2][0],W.y=_[2][1],W.z=i[2],a.push(W.Clone())));break;case t.TERM_PATSMCRSBIG:H[0][0]=i[0]-D/2*B[0],H[0][1]=i[1]-D/2*B[1],H[0][2]=0,H[1][0]=i[0]+D/2*B[0],H[1][1]=i[1]+D/2*B[1],H[1][2]=0,H[2][0]=i[0]-P/2*j[0],H[2][1]=i[1]-P/2*j[1],H[2][2]=0,H[3][0]=i[0]+P/2*j[0],H[3][1]=i[1]+P/2*j[1],H[3][2]=0,W.x=H[0][0],W.y=H[0][1],W.z=i[2],a.push(W.Clone()),W.x=H[1][0],W.y=H[1][1],W.z=i[2],a.push(W.Clone()),W.x=i[0],W.y=i[1],W.z=i[2],a.push(W.Clone()),W.x=H[2][0],W.y=H[2][1],W.z=i[2],a.push(W.Clone()),W.x=H[3][0],W.y=H[3][1],W.z=i[2],a.push(W.Clone());break;case t.TERM_PATSMWHTSQR:case t.TERM_PATSMBLKSQR:case t.TERM_PATSMCRSX:W.x=i[0]+d*g[0]-U*l[0],W.y=i[1]+d*g[1]-U*l[1],W.z=i[2],a.push(W.Clone()),W.x=i[0]+d*g[0]-3*U*l[0],W.y=i[1]+d*g[1]-3*U*l[1],W.z=i[2],u==t.TERM_PATSMCRSX?f.push(W.Clone()):a.push(W.Clone()),W.x=i[0]+d*y[0]-3*U*l[0],W.y=i[1]+d*y[1]-3*U*l[1],W.z=i[2],a.push(W.Clone()),W.x=i[0]+d*y[0]-U*l[0],W.y=i[1]+d*y[1]-U*l[1],W.z=i[2],u==t.TERM_PATSMCRSX?f.push(W.Clone()):a.push(W.Clone()),u==t.TERM_PATSMWHTSQR&&(W.x=i[0]+d*g[0]-U*l[0],W.y=i[1]+d*g[1]-U*l[1],W.z=i[2],a.push(W.Clone()));break;case t.TERM_PATSMWHTTRI3:case t.TERM_PATSMBLKTRI2:I[0]=-l[1],I[1]=l[0],I[2]=0,R[0]=i[0]+q*I[0],R[1]=i[1]+q*I[1],R[2]=0,W.x=i[0]-q*I[0],W.y=i[1]-q*I[1],W.z=i[2],a.push(W.Clone()),W.x=R[0]+U*l[0],W.y=R[1]+U*l[1],W.z=i[2],a.push(W.Clone()),W.x=R[0]-U*l[0],W.y=R[1]-U*l[1],W.z=i[2],a.push(W.Clone()),u==t.TERM_PATSMWHTTRI3&&(W.x=i[0]-q*I[0],W.y=i[1]-q*I[1],W.z=i[2],a.push(W.Clone()));break;case t.TERM_PATSMDBOPNARW:d=Math.sqrt(G*G+v*v),h=G/d,p=v/d,g[0]=l[0]*h-l[1]*p,g[1]=l[0]*p+l[1]*h,g[2]=0,y[0]=l[0]*h+l[1]*p,y[1]=-l[0]*p+l[1]*h,y[2]=0,W.x=i[0]+g[0]*d,W.y=i[1]+g[1]*d,W.z=i[2],a.push(W.Clone()),W.x=i[0],W.y=i[1],W.z=i[2],a.push(W.Clone()),W.x=i[0]+y[0]*d,W.y=i[1]+y[1]*d,W.z=i[2],a.push(W.Clone()),W.x=i[0]+l[0]*(G/2),W.y=i[1]+l[1]*(G/2),W.z=i[2],X.x=W.x+g[0]*d,X.y=W.y+g[1]*d,X.z=i[2],f.push(X.Clone()),f.push(W.Clone()),X.x=W.x+y[0]*d,X.y=W.y+y[1]*d,X.z=i[2],f.push(X.Clone());break;case t.TERM_PATSMDBCLSARW:case t.TERM_PATSMDBFILLARW:d=Math.sqrt(G*G+v*v),h=G/d,p=v/d,g[0]=l[0]*h-l[1]*p,g[1]=l[0]*p+l[1]*h,g[2]=0,y[0]=l[0]*h+l[1]*p,y[1]=-l[0]*p+l[1]*h,y[2]=0,W.x=i[0]+g[0]*d,W.y=i[1]+g[1]*d,W.z=i[2],J=W,a.push(W.Clone()),W.x=i[0],W.y=i[1],W.z=i[2],a.push(W.Clone()),W.x=i[0]+y[0]*d,W.y=i[1]+y[1]*d,W.z=i[2],K=W,a.push(W.Clone()),t.TERM_PATSMDBCLSARW==u&&(W.x=i[0]+g[0]*d,W.y=i[1]+g[1]*d,W.z=i[2],a.push(W.Clone())),$.x=i[0]+G/2*l[0],$.y=i[1]+G/2*l[1],$.z=0,J.x=J.x+G/2*l[0],J.y=J.y+G/2*l[1],J.z=i[2],t.TERM_PATSMDBCLSARW==u?f.push(J):a.push(J),V.x=J.x,V.y=J.y,V.z=J.z,K.x=K.x+G/2*l[0],K.y=K.y+G/2*l[1],K.z=i[2],t.TERM_PATSMDBCLSARW==u?f.push(K):a.splice(3,0,K),K.x=(K.x+$.x)/2,K.y=(K.y+$.y)/2,K.z=i[2],t.TERM_PATSMDBCLSARW==u?f.push(K):a.splice(3,0,K),J.x=(J.x+$.x)/2,J.y=(J.y+$.y)/2,J.z=i[2],t.TERM_PATSMDBCLSARW==u?f.push(J):a.push(J),t.TERM_PATSMDBCLSARW==u&&f.push(V);break;case t.TERM_PATSMDBFILLTRI:d=Math.sqrt(G*G+v*v),h=G/d,p=v/d,g[0]=l[0]*h-l[1]*p,g[1]=l[0]*p+l[1]*h,g[2]=0,y[0]=l[0]*h+l[1]*p,y[1]=-l[0]*p+l[1]*h,y[2]=0,W.x=i[0]+l[0]*n,W.y=i[1]+l[1]*n,W.z=i[2],X.x=W.x,X.y=W.y,X.z=W.z,W.x=W.x-g[0]*d,W.y=W.y-g[1]*d,W.z=i[2],a.push(W.Clone()),a.push(X),W.x=X.x-y[0]*d,W.y=X.y-y[1]*d,W.z=i[2],a.push(W.Clone()),$.x=i[0]+l[0]*G,$.y=i[1]+l[1]*G,$.z=0,K.x=i[0]+v*c[0],K.y=i[1]+v*c[1],K.z=i[2],a.push(K),J.x=i[0]-v*c[0],J.y=i[1]-v*c[1],J.z=i[2],a.push(J),K.x=(K.x+$.x)/2,K.y=(K.y+$.y)/2,K.z=i[2],a.splice(3,0,K),J.x=(J.x+$.x)/2,J.y=(J.y+$.y)/2,J.z=i[2],a.push(J);break;case t.TERM_PATSMNO:break;default:W.x=i[0]+d*g[0],W.y=i[1]+d*g[1],W.z=i[2],a.push(W.Clone()),W.x=i[0],W.y=i[1],W.z=i[2],a.push(W.Clone()),W.x=i[0]+d*y[0],W.y=i[1]+d*y[1],W.z=i[2],a.push(W.Clone()),W.x=i[0]+d*g[0],W.y=i[1]+d*g[1],W.z=i[2],a.push(W.Clone())}return 0},t.LengthAndUnit=function(e,n,r,i){var s=0,o=0,u=0,a=0;if(e==3){u=n[0]*n[0]+n[1]*n[1]+n[2]*n[2];if(u<t.ZDEPS){var f=0;i[0]=n[0],i[1]=n[1],i[2]=n[2],s=-2}else{a=Math.sqrt(u),i[0]=n[0]/a,i[1]=n[1]/a,i[2]=n[2]/a;var l=a;s=0}}else if(e==2){u=n[0]*n[0]+n[1]*n[1];if(u<t.ZDEPS){var c=0;i[0]=n[0],i[1]=n[1],s=-2}else{a=Math.sqrt(u),i[0]=n[0]/a,i[1]=n[1]/a;var h=a;s=0}}else if(e>0){u=0;for(o=0;o<e;o++)u+=n[o]*n[o];if(u<t.ZDEPS){var p=0;for(o=0;o<e;o++)i[o]=n[o];s=-2}else{a=Math.sqrt(u);for(o=0;o<e;o++)i[o]=n[o]/a;var d=a;s=0}}else s=-1;return s},t.TERM_PATSMNO=0,t.TERM_PATSMARW=1,t.TERM_PATSMWHTARW=2,t.TERM_PATSMBLKARW=3,t.PATCROSSARW=4,t.TERM_PATSMWHTCIR=5,t.TERM_PATSMBLKCIR=6,t.TERM_PATSMWHTSQR=7,t.TERM_PATSMBLKSQR=8,t.TERM_PATSMSLASH_TYPE=9,t.TERM_PATSMCROSSEDCIR=10,t.TERM_PATSMDBXCIRCLE=11,t.TERM_PATSMWHTTRI3=12,t.TERM_PATSMBLKTRI2=13,t.TERM_PATSMCRSBIG=14,t.TERM_PATSMCRSX=15,t.TERM_PATSMCIRCENT=17,t.TERM_PATSMDBOPNARW=18,t.TERM_PATSMDBCLSARW=19,t.TERM_PATSMDBFILLARW=20,t.TERM_PATSMDBFILLTRI=21,t.TERM_PATSMWHTTRI_TYPE=22,t.TERM_PATSMBLKTRI_TYPE=23,t.PATSSPACELIN_TYPE=24,t.TERM_PATSMWHTTRI2_TYPE=25,t.TERM_PATSMUSR=100,t.PI=3.141592653589793,t.USERNOTEIDSTART=5e5,t.ZDEPS=1e-18,t}();e.PMIESymbol=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){}return t.GetEndSymbolDirection=function(e,t){var n,r,i,s;if(e.length!=2)return!1;for(var o=0;o<e.length;o++){var u=e[o];if(u.type!=1)return!1;n.length=0;var a=u.curves.polylines;if(a.length==0)return!1;var f=a[a.length-1];n=f.points,r[o]=n[0],i[o]=n[1]}s[0]=s[1]=1,i[0].x==i[1].x&&i[0].y==i[1].y&&(r[0].x<r[1].x?i[0].x<r[0].x?s[0]=-1:i[0].x>r[1].x&&(s[1]=-1):r[0].x>r[1].x?i[0].x<r[1].x?s[1]=-1:i[0].x>r[0].x&&(s[0]=-1):r[0].y<r[1].y?i[0].y<r[0].y?s[0]=-1:i[0].y>r[1].y&&(s[1]=-1):r[0].y>r[1].y&&(i[0].y<r[1].y?s[1]=-1:i[0].y>r[0].y&&(s[0]=-1)));for(var o=0;o<2;o++)t.push(s[o]);return!0},t.DivideLeader=function(n,r,i,s){var o,u,a=[],f=[],l=[],c=0,h=new e.Vector3,p=!1,d=[],v=0,m=0,g=0,y=0,b=0,w;if(n!=t.PMIDIM2)return!1;for(m=0;m<r.length;m++){o=r[m],a.length=0,u=t.ResetTextBox(o);if(!t.CheckPntFrmInter(n,i,u,a))continue;f[0]=new e.Vector3,f[0].x=o.BoundBox[0][0],f[0].y=o.BoundBox[0][1],f[0].z=0,f[1]=new e.Vector3,f[1].x=o.BoundBox[0][0],f[1].y=o.BoundBox[1][1],f[1].z=0,f[2]=new e.Vector3,f[2].x=o.BoundBox[1][0],f[2].y=o.BoundBox[1][1],f[2].z=0,f[3]=new e.Vector3,f[3].x=o.BoundBox[1][0],f[3].y=o.BoundBox[0][1],f[3].z=0,f[4]=new e.Vector3,f[4].x=f[0].x,f[4].y=f[0].y,f[4].z=0,s.push(i[0]);for(y=1;y<i.length;y++){if(!a[y-1]){s.push(i[y]);continue}d.length=0,l[0]=i[y-1],l[1]=i[y];for(g=0;g<4;g++){var E=[f[g],f[g+1]];p=t.GetLineCrossPoint(n,E,l,c,h),p&&c!=0&&d.push(h)}if(d.length!=0){if(d.length==1)s.push(d[0]);else if(d.length>=2&&d.length<=t.ARAAYNUM){w[t.ARAAYNUM]=0,v=0;for(b=0;b<d.length;b++)w[b]=Math.sqrt((d[b].x-l[0].x)*(d[b].x-l[0].x)+(d[b].y-l[0].y)*(d[b].y-l[0].y)),b==0?(w[t.ARAAYNUM]=w[0],v=0):w[t.ARAAYNUM]>w[b]&&(w[t.ARAAYNUM]=w[b],v=b);s.push(d[v])}else s.push(d[0]);break}s.push(i[y])}}return!0},t.ResetTextBox=function(t){var n=new e.STK_BOX32;return t.BoundBox[0][0]<t.BoundBox[1][0]?(n.BoundBox[0][0]=t.BoundBox[0][0],n.BoundBox[1][0]=t.BoundBox[1][0]):(n.BoundBox[0][0]=t.BoundBox[1][0],n.BoundBox[1][0]=t.BoundBox[0][0]),t.BoundBox[0][1]<t.BoundBox[1][1]?(n.BoundBox[0][1]=t.BoundBox[0][1],n.BoundBox[1][1]=t.BoundBox[1][1]):(n.BoundBox[0][1]=t.BoundBox[1][1],n.BoundBox[1][1]=t.BoundBox[0][1]),n.BoundBox[0][2]=0,n.BoundBox[1][2]=0,n},t.CheckPntFrmInter=function(n,r,i,s){var o,u=[],a=new e.STK_BOX32,f=!1;if(n!=t.PMIDIM2)return!1;s.length=0,a.BoundBox[0][2]=0,a.BoundBox[1][2]=0;for(var l=1;l<r.length;l++){o=!0,u[0]=r[l-1],u[1]=r[l],u[0].x<u[1].x?(a.BoundBox[0][0]=u[0].x,a.BoundBox[1][0]=u[1].x):(a.BoundBox[0][0]=u[1].x,a.BoundBox[1][0]=u[0].x),u[0].y<u[1].y?(a.BoundBox[0][1]=u[0].y,a.BoundBox[1][1]=u[1].y):(a.BoundBox[0][1]=u[1].y,a.BoundBox[1][1]=u[0].y);if(a.BoundBox[1][0]<i.BoundBox[0][0]-t.ZTOL||a.BoundBox[0][0]>i.BoundBox[1][0]+t.ZTOL)o=!1;if(a.BoundBox[1][1]<i.BoundBox[0][1]-t.ZTOL||a.BoundBox[0][1]>i.BoundBox[1][1]+t.ZTOL)o=!1;o&&(f=!0),s.push(o)}return f},t.GetLineCrossPoint=function(n,r,i,s,o){var u=!0,a=0,f=0,l=0,c=0,h,p,d,v,m=!1,g=0,y=0,b=0,w=0,E,S,x,T,N=!1,C=new e.Vector3;s=-1,h=E=0,p=S=0,d=x=0,v=T=0,m=N=!1;if(t.PMIDIM2!=n)return!1;if(r[1].x==r[0].x){if(r[1].y==r[0].y)return!1;m=!0,d=r[1].y>r[0].y?r[0].y:r[1].y,v=r[1].y<r[0].y?r[0].y:r[1].y}else l=(r[1].y-r[0].y)/(r[1].x-r[0].x),r[1].x>r[0].x?(h=r[0].x,p=r[1].x):(h=r[1].x,p=r[0].x);if(i[1].x==i[0].x){if(i[1].y==i[0].y)return!1;N=!0,x=i[1].y>i[0].y?i[0].y:i[1].y,T=i[1].y<i[0].y?i[0].y:i[1].y}else b=(i[1].y-i[0].y)/(i[1].x-i[0].x),i[1].x>i[0].x?(E=i[0].x,S=i[1].x):(E=i[1].x,S=i[0].x);m||N?(s=2,m&&N?r[0].x==i[0].x?(s=1,C.x=r[0].x,C.y=r[0].y<=r[1].y?r[0].y:r[1].y):s=0:m?(w=i[0].y-i[0].x*b,C.x=r[0].x,C.y=b*C.x+w):N&&(c=r[0].y-r[0].x*l,C.x=i[0].x,C.y=l*C.x+c)):(c=r[0].y-r[0].x*l,w=i[0].y-i[0].x*b,l==b?(s=0,c==w&&(s=1,h=r[0].x<=r[1].x?r[0].x:r[1].x,E=i[0].x<=i[1].x?i[0].x:i[1].x,C.x=h<=E?h:E,C.y=l*C.x+c)):(s=2,c==w?(C.x=0,C.y=c):(C.x=(w-c)/(l-b),C.y=l*C.x+c)));if(s!=0){if(m){if(C.y>v||C.y<d)u=!1}else if(C.x>p||C.x<h)u=!1;if(N){if(C.y>T||C.y<x)u=!1}else if(C.x>S||C.x<E)u=!1}return o=C,u},t.ARAAYNUM=4,t.PMIDIM2=2,t.ZTOL=2e-10,t}();e.PMIUtility=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){}return t.prototype.fromJson=function(t){this.m_fStartPar=t.beginPar,this.m_pntStart=new e.Vector3,this.m_pntStart.fromString(t.beginPnt),this.m_pntCenter=new e
.Vector3,this.m_pntCenter.fromString(t.center),this.m_fEndPar=t.endPar,this.m_pntEnd=new e.Vector3,this.m_pntEnd.fromString(t.endPnt),this.id=t.id,this.m_fMajorRadius=t.majorRadius,this.m_fUMax=t.max,this.m_fUMin=t.min,this.m_fMinorRadius=t.minorRadius,this.m_dirNormal=new e.Vector3,this.m_dirNormal.fromString(t.normal),this.m_dirOrigin=new e.Vector3,this.m_dirOrigin.fromString(t.originDir),this.type=t.type,this.m_dirX=new e.Vector3,this.m_dirX.fromString(t.xDir),this.m_dirY=new e.Vector3,this.m_dirY.fromString(t.yDir),this.m_dirZ=new e.Vector3,this.m_dirZ.fromString(t.zDir)},t}();e.Stk_Arc=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){this.BoundBox=[[0,0,0],[0,0,0]]}return e}();e.STK_BOX32=t})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.LEADER_TYPE_UNKNOWN=0]="LEADER_TYPE_UNKNOWN",e[e.LEADER_TYPE_LENGTH=1]="LEADER_TYPE_LENGTH",e[e.LEADER_TYPE_ANGULAR=2]="LEADER_TYPE_ANGULAR"})(t||(t={}));var n=function(){function e(){}return e}();e.Stk_Leader=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){}return t.GetCircleDrawData=function(e,t,n,r,i){var s,o,u,a,f,l,c,h,p;for(var d=0;d<e.length;d++){var v=e[d];if(v.type!=2)return!1;var m=v.curves.polylines;if(m.length==0)return!1;var g=m[m.length-1];g.GetRadius(u,a),g.GetCoordinatePnt(s,o),f=g.GetCenterPoint(),l=g.GetNormal(),this.GetCircleAngleParameter(2,s,f,a,c),this.GetCircleAngleParameter(2,o,f,a,h),p.push(l.z),t.push(c),n.push(h)}},t.GetCircleAngleParameter=function(n,r,i,s,o){var u;return n!=2?!1:(u=(r.x-i.x)/s,u>1?u-1<t.ANGLEPARA_TOL?(o=e.PI*2,!0):!1:u<-1?Math.abs(1+u)<t.ANGLEPARA_TOL?(o=e.PI,!0):!1:(r.x-i.x<0&&r.y-i.y<0||r.x-i.x>0&&r.y-i.y<0?o=e.PI*2-Math.acos(u):r.x-i.x==0&&r.y-i.y<0?o=e.PI+Math.acos(u):o=Math.acos(u),!0))},t.GetCircleDiscretization=function(e,n,r){var i,s,o,u,a,f,l,c,h;return i=e.m_fMajorRadius,s=e.m_fMinorRadius,o=e.m_pntCenter,u=e.m_pntStart,a=e.m_pntEnd,f=e.m_dirNormal,t.GetCircleAngleParameter(t.PMIDIM2,u,o,s,l),t.GetCircleAngleParameter(t.PMIDIM2,a,o,s,c),h=n==0?f.z>0?1:-1:n,t.MakeArcDiscretization(o,s,l,c,0,h,r)},t.GetCircleDiscretization2=function(n,r,i,s,o,u){var a=0,f=0,l=new e.Vector3,c=new e.Vector3,h=0;return a=n.m_fMajorRadius,f=n.m_fMinorRadius,l=n.m_pntCenter,h=o==0?c.z>0?1:-1:o,t.MakeArcDiscretization(l,f,r,i,s,h,u)},t.MakeArcDiscretization=function(n,r,i,s,o,u,a){var f=new e.Vector3,l=0,c=0,h=0;o>0?h=o:s>i?u>0?h=s-i:h=e.PI*2-s+i:s<i?u>0?h=e.PI*2-i+s:h=i-s:s==i&&(h=e.PI*2);var p=t.DIVANGLE*(e.PI/180),d=h/p;d<4&&(d=4,p=h/4);for(var v=0;v<d+1;v++)l=i+u*p*v,l<0?c=e.PI*2+l:l>e.PI*2?c=l-e.PI*2:c=l,v==d&&(c=s),f.x=n.x+r*Math.cos(c),f.y=n.y+r*Math.sin(c),f.z=0,a.push(f);return!0},t.IDXNUM=16384,t.ZDEPS=1e-18,t.MAXPNTVAL=1e8,t.ZTOL=2e-10,t.ANGLEPARA_TOL=.1,t.ARAAYNUM=4,t.PMIDIM2=2,t.DIVANGLE=2,t.PI=3.141592653589793,t}();e.TessCircle=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(e){this.sceneMgr=null,this.allSubModels=[],this.currentreader=null,this.CurrentShowModel=null,this.openFileEnd=function(){},this.svlxReaderMap={},this.sceneMgr=e}return t.prototype.AddSVLXreader=function(e){this.svlxReaderMap[e.Id]=e,this.CurrentShowModel=e.GetModel()},t.prototype.AsynFillModelEnd=function(e,t){t.svlxReaderMap[e.Id]=null,t.doNextReaderFill(),t.sceneMgr.OptimizeCameraView(!0),t.CurrentShowModel=null},t.prototype.doNextReaderFill=function(){var t=Object.getOwnPropertyNames(this.svlxReaderMap);if(t.length>0){var n=!0;for(var r=0;r<t.length;r++){var i=t[r],s=this.svlxReaderMap[i];if(s!==null){this.svlxReaderMap[i]=null,s instanceof e.SvlxReader?(s.AsynFillModelMesh(),n=!1):n=!0;break}}n===!0&&(this.svlxReaderMap={},this.openFileEnd&&(this.openFileEnd(),this.openFileEnd=null))}},t}();e.ModelFillManager=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){this.onReadBegin=function(e){},this.onReadCancel=function(e){},this.onReading=function(e){},this.onReadEnd=function(e){},this.onSingleFileReadEnd=function(e){}}return e}();e.ReadListener=t;var n=function(){function e(){this.allFilesCount=1,this.currentFileIndex=0,this.currentFilesName="",this.onReadEnd=function(e){}}return e}();e.ReadNextListener=n;var r=function(){function e(){this.onReadEnd=function(e){}}return e}();e.ReadModelListener=r})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n.host="",n.animationsrc="",n.instanceIdMap={},n.parentId_subInstanceId={},n.topInstanceId=[],n.modelMap={},n.modelBoundingBox={},n.hasLoadedModelMap={},n.mergeFaceFlag=!1,n.delay=50,n.zipFile=null,n.asynFillModelFlag=!1,n.allMeshFaceMap={},n.allMeshEdgeMap={},n.parseModelsMap={},n.modelViewArray={},n.materialMap={},n.imagesMap={},n.m_protoTypeMaterialCache={},n.m_protoTypeColorCache={},n.m3dMaterialMap={},n.instanceAttrMap={},n.pmiMap=new e.Map,n.modelPMIMap=new e.Map,n.storyList=null,n}return __extends(n,t),n.prototype.setHost=function(e){this.host=e},n.prototype.getHost=function(){return this.host},n.prototype.getFileName=function(){return this.fileName},n.prototype.setFileName=function(e){this.fileName=e},n.prototype.getAnimation=function(){return this.animationsrc},n.prototype.getFileFromRemote=function(e,t,n,r,i,s,o){if(!r){var u=new XMLHttpRequest;e+=(/\?/.test(e)?"&":"?")+(new Date).getTime(),u.open("GET",e,!0),u.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n&&(u.responseType=n),u.onreadystatechange=function(){if(u.readyState===4&&u.status===200){var e=u.response;i&&i(e)}},s&&(u.onprogress=s),u.send(t)}},n.prototype.GetDString=function(e,t){var n=CryptoJS.enc.Utf8.parse(CryptoJS.MD5(this.GetRandomString()).toString()),r=CryptoJS.enc.Utf8.parse(CryptoJS.MD5(this.GetRandomString()).toString().substring(0,16)),i=CryptoJS.AES.decrypt(e,n,{iv:r,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7});return i.toString(CryptoJS.enc.Utf8)},n.prototype.GetRandomString=function(e){if(this.random)return this.random;e=e||32;var t="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678oOLl9gqVvUuI1",n=t.length,r="";for(var i=0;i<e;i++)r+=t.charAt(Math.floor(Math.random()*n));return this.random=r,this.random},n.prototype.instanceFormBin=function(t,n){var r=(new Uint32Array(t,n,1))[0];n+=4;var i=(new Uint32Array(t,n,1))[0];n+=4;var s=(new Uint32Array(t,n,1))[0];n+=4;var o=(new Uint32Array(t,n,1))[0];n+=4;var u=(new Uint32Array(t,n,1))[0];n+=4;var a=(new Uint32Array(t,n,1))[0];n+=4;var f=new Float32Array(t,n,16);n+=64;var l=new e.Matrix4(f),c=new e.Model;c.SetPlcId(o),c.SetProtoTypeId(s),c.SetPlaceMatrix(l),c.SetVisible(u===1?!0:!1);var h=this.view.GetSceneManager().GetExtendInfoManager(),p=h.GetInstanceAttr(r,"name");p!=undefined&&c.SetName(p);var d=h.GetInstanceAttr(r,"selectable");d!=undefined&&d.length>0&&c.SetSelectAble(d.toLowerCase()==="true",!0);var v=[];return v[0]=i,v[1]=s,v[2]=a,v[3]=c,this.instanceIdMap[r]=v,this.parentId_subInstanceId[i]===undefined?(this.parentId_subInstanceId[i]=[],this.parentId_subInstanceId[i].push(r)):this.parentId_subInstanceId[i].push(r),i===4294967295&&this.topInstanceId.push(r),n},n.prototype.parseBom=function(t){var n=0,r=t.byteLength;while(n<r)n=this.instanceFormBin(t,n);for(var i in this.parentId_subInstanceId)if(i!=="4294967295"){var s=this.instanceIdMap[i][3];for(var o=0;o<this.parentId_subInstanceId[i].length;o++){var u=this.parentId_subInstanceId[i][o],a=this.instanceIdMap[u][3];s.AddSubModel(a)}}if(this.topInstanceId.length===1)this.topModel=this.instanceIdMap[this.topInstanceId[0]][3];else{this.topModel=new e.Model;for(var f=0;f<this.topInstanceId.length;f++)this.topModel.AddSubModel(this.instanceIdMap[this.topInstanceId[f]][3])}this.topModel.SetName(this.getFileName()),this.parentId_subInstanceId=null},n.prototype.loadBomFromRemote=function(e){var t=this;this.getFileFromRemote(e,null,"arraybuffer",!1,function(e){var n=new JSZip(e),r=new RegExp(".*.bom$","i"),i=n.file(r);t.parseBom(i[0].asArrayBuffer())})},n.prototype.fillModelBox=function(){var t=Object.getOwnPropertyNames(this.instanceIdMap);for(var n=0;n<t.length;n++){var r=this.instanceIdMap[t[n]][3],i=this.instanceIdMap[t[n]][1];if(i!==4294967295){var s=this.modelMap[i],o=this.modelBoundingBox[i],u=new e.BoundingBox(new e.Vector3(o[0],o[1],o[2]),new e.Vector3(o[3],o[4],o[5]));u.Defined()&&u.Length()<1e6&&(r.SetBox(u),r.SetDrawDataPrepared(!1))}}},n.prototype.modelFromBin=function(e,t){var n=(new Uint32Array(e,t,1))[0];t+=4;var r=new Float32Array(e,t,6);this.modelBoundingBox[n]=r,t+=24;var i=(new Uint32Array(e,t,1))[0];t+=4;var s=[];for(var o=0;o<i;o++){var u=[],a=(new Uint32Array(e,t,1))[0];t+=4,u.push(a);var f=(new Uint32Array(e,t,1))[0];t+=4,u.push(f);var l=(new Uint32Array(e,t,1))[0];t+=4,u.push(l),s.push(u)}return this.modelMap[n]=s,t},n.prototype.parseModel=function(e){var t=0;while(t<e.byteLength)t=this.modelFromBin(e,t);console.log("parseModel end")},n.prototype.loadModelFromRemote=function(e){var t=this;this.getFileFromRemote(e,"","arraybuffer",!1,function(e){var n=new JSZip(e),r=new RegExp(".*.lod$","i"),i=n.file(r);t.parseModel(i[0].asArrayBuffer())})},n.prototype.meshFromBin=function(t,n,r){var i=(new Uint32Array(n,r,1))[0];r+=4;var s=(new Uint32Array(n,r,1))[0];r+=4;var o=(new Uint32Array(n,r,1))[0];r+=4;var u=(new Uint32Array(n,r,1))[0];r+=4;var a=(new Uint32Array(n,r,1))[0];r+=4;var f=(new Uint32Array(n,r,1))[0];r+=4;var l=(new Uint32Array(n,r,1))[0];r+=4;var c=new Float32Array(n,r,s);r+=4*s;var h=new Float32Array(n,r,o);r+=4*o;var p=new Float32Array(n,r,u);r+=4*u;var d=new e.VertexSet,v=[],m=[],g=[];for(var y=0;y<f;y++){var b=(new Uint32Array(n,r,1))[0];r+=4;var w=(new Uint32Array(n,r,1))[0];r+=4;var E=(new Uint32Array(n,r,1))[0];r+=4;var S=(new Uint32Array(n,r,1))[0];r+=4;var x=new Uint32Array(n,r,E);r+=E*4;var T=new Uint32Array(n,r,S);r+=S*4;if(E===4294967295)continue;if(E<=0)continue;var N=new e.Face;N.SetSVLId(b);var C=new e.Mesh(d),k=v.length,L=c,A=h,O=p,M=!1;O.length>0&&(g=[],M=!0);var _=[];for(var D=0;D<E;D++)v.push(L[x[D]*3+0]),v.push(L[x[D]*3+1]),v.push(L[x[D]*3+2]),_.push(L[x[D]*3+0]),_.push(L[x[D]*3+1]),_.push(L[x[D]*3+2]),m.push(A[x[D]*3+0]),m.push(A[x[D]*3+1]),m.push(A[x[D]*3+2]),M&&(g.push(O[x[D]*3+0]),g.push(O[x[D]*3+1]),g.push(0));var P=E;C.SetDataOffset(k/3),C.SetDataLength(P);var H=this.getMaterial(w.toString());N.SetMaterial(H);var B=this.getMaterialColor(w.toString());N.SetInitColor(B),N.SetMesh(C),t.AddFace(N)}d.SetPositionArray(new Float32Array(v)),d.SetNormalArray(new Float32Array(m)),g.length>0&&d.SetUVArray(new Float32Array(g));for(var j=0;j<a;j++){var F=(new Uint32Array(n,r,1))[0];r+=4;var E=(new Uint32Array(n,r,1))[0];r+=4;var x=new Uint32Array(n,r,E);r+=E*4;if(E>=2){var I=t.GetPolyLine();I===null&&(I=new e.SPolyLine,t.SetPolyLine(I));var q=new e.RefPolyLine(I);q.SetDataOffset(I.GetPoints().length),q.SetDataLength(2*(E-1));var R=new Float32Array(E*3),L=c,U=new e.Vector3(L[x[0]*3+0],L[x[0]*3+1],L[x[0]*3+2]);I.AddPoint(U);for(var y=1;y<E-1;y++){var z=new e.Vector3(L[x[y]*3+0],L[x[y]*3+1],L[x[y]*3+2]);I.AddPoint(z),I.AddPoint(z)}var W=new e.Vector3(L[x[E-1]*3+0],L[x[E-1]*3+1],L[x[E-1]*3+2]);I.AddPoint(W);var X=new e.Edge;X.SetSVLId(F),X.AddData(q,0),t.AddEdge(X)}}var V=new Uint32Array(n,r,l);return r+=l*4,r},n.prototype.parseMesh=function(t,n,r,i,s){var o=this.instanceIdMap[n][1],u=this.instanceIdMap[n][2];if(this.hasLoadedModelMap[o]){var a=this.hasLoadedModelMap[o];t.CopyRenderData(a)}else{var f=0+r;while(f<i+r){var l=new e.Body;t.AddBody(l),f=this.meshFromBin(l,s,f)}this.hasLoadedModelMap[o]=t}t.SetDrawDataPrepared(!0);if(u!==4294967295&&u>0){var c=this.getMaterial(u),h=c.GetMaterialType(),p=void 0;if(c instanceof e.ShaderMaterial)return;h===e.MaterialType.MaterialType_Pbr?p=c.AlbedoColor().Clone():p=c.GetDiffuse().Clone(),p.r>=0&&p.g>=0&&p.b>=0&&(t.SetFaceMaterial(c),t.SetInitColor(p))}},n.prototype.meshFromBinMergeFace=function(e,t,n,r,i,s,o){var u=(new Uint32Array(t,n,1))[0];n+=4;var a=(new Uint32Array(t,n,1))[0];n+=4;var f=(new Uint32Array(t,n,1))[0];n+=4;var l=(new Uint32Array(t,n,1))[0];n+=4;var c=(new Uint32Array(t,n,1))[0];n+=4;var h=(new Uint32Array(t,n,1))[0];n+=4;var p=(new Uint32Array(t,n,1))[0];n+=4;var d=new Float32Array(t,n,a);n+=4*a;var v=new Float32Array(t,n,f);n+=4*f;var m=new Float32Array(t,n,l);n+=4*l;for(var g=0;g<h;g++){var y=(new Uint32Array(t,n,1))[0];n+=4;var b=(new Uint32Array(t,n,1))[0];n+=4;var w=(new Uint32Array(t,n,1))[0];n+=4;var E=(new Uint32Array(t,n,1))[0];n+=4;var S=new Uint32Array(t,n,w);n+=w*4;var x=new Uint32Array(t,n,E);n+=E*4;if(w===4294967295)continue;if(w<=0)continue;var T=[],N=[],C=null,k=d,L=v,A=m,O=!1;A.length>0&&(C=[],O=!0);for(var M=0;M<w;M++)r.push(k[S[M]*3+0]),r.push(k[S[M]*3+1]),r.push(k[S[M]*3+2]),i.push(L[S[M]*3+0]),i.push(L[S[M]*3+1]),i.push(L[S[M]*3+2]),O&&(s.push(A[S[M]*3+0]),s.push(A[S[M]*3+1]));b!==4294967295&&b>0&&(o[0]=b)}for(var _=0;_<c;_++){var D=(new Uint32Array(t,n,1))[0];n+=4;var w=(new Uint32Array(t,n,1))[0];n+=4;var S=new Uint32Array(t,n,w);n+=w*4;var T=new Float32Array(w*3),k=d;for(var g=0;g<w;g++)T[g*3+0]=k[S[g]*3+0],T[g*3+1]=k[S[g]*3+1],T[g*3+2]=k[S[g]*3+2]}var P=new Uint32Array(t,n,p);return n+=p*4,n},n.prototype.parseMeshMergeFace=function(t,n,r,i,s){var o=this.instanceIdMap[n][1],u=this.instanceIdMap[n][2];if(this.hasLoadedModelMap[o]){var a=this.hasLoadedModelMap[o];t.CopyRenderData(a)}else{var f=0+r,l=new e.Body;t.AddBody(l);var c=[],h=[],p=[],d=[];while(f<i+r)f=this.meshFromBinMergeFace(l,s,f,c,h,p,d);var v=new e.Face,m=new e.VertexSet,g=new e.Mesh(m),y=new Float32Array(c),b=new Float32Array(h),w=new Float32Array(0),E=!1;p.length>0&&(w=new Float32Array(p),E=!0),m.SetPositionArray(y),m.SetNormalArray(b),p.length>0&&m.SetUVArray(w);var S=m.GetPositionArray().length/3;g.SetDataOffset(0),g.SetDataLength(S);var x=this.getMaterialColor(d[0]);v.SetInitColor(x),v.SetMesh(g),l.AddFace(v),this.hasLoadedModelMap[o]=t}if(u!==4294967295&&u>0){var x=this.getMaterialColor(u);t.SetInitColor(x)}},n.prototype.meshFromBinMergeFaceByMaterial=function(t,n,r,i){var s=(new Uint32Array(n,r,1))[0];r+=4;var o=(new Uint32Array(n,r,1))[0];r+=4;var u=(new Uint32Array(n,r,1))[0];r+=4;var a=(new Uint32Array(n,r,1))[0];r+=4;var f=(new Uint32Array(n,r,1))[0];r+=4;var l=(new Uint32Array(n,r,1))[0];r+=4;var c=(new Uint32Array(n,r,1))[0];r+=4;var h=new Float32Array(n,r,o);r+=4*o;var p=new Float32Array(n,r,u);r+=4*u;var d=new Float32Array(n,r,a);r+=4*a;for(var v=0;v<l;v++){var m=(new Uint32Array(n,r,1))[0];r+=4;var g=(new Uint32Array(n,r,1))[0];r+=4;var y=(new Uint32Array(n,r,1))[0];r+=4;var b=(new Uint32Array(n,r,1))[0];r+=4;var w=new Uint32Array(n,r,y);r+=y*4;var E=new Uint32Array(n,r,b);r+=b*4;if(y===4294967295)continue;if(y<=0)continue;var S=null,x=null,T=null,N=i[g];N?(S=N[0],x=N[1],T=N[2]):(S=[],x=[],d.length>0&&(T=[]),i[g]=[S,x,T]);var C=h,k=p,L=d;L.length>0&&(T=new Float32Array(y*3)),g===4294967295&&console.log("ss");for(var A=0;A<y;A++)S.push(C[w[A]*3+0]),S.push(C[w[A]*3+1]),S.push(C[w[A]*3+2]),x.push(k[w[A]*3+0]),x.push(k[w[A]*3+1]),x.push(k[w[A]*3+2]),L.length>0&&(T[A*3+0]=L[w[A]*3+0],T[A*3+1]=L[w[A]*3+1]);y>0?i[g]=[S,x,T]:console.log("ss")}for(var O=0;O<f;O++){var M=(new Uint32Array(n,r,1))[0];r+=4;var y=(new Uint32Array(n,r,1))[0];r+=4;var w=new Uint32Array(n,r,y);r+=y*4;if(y>=2&&!e.Parameters.Instance().isIgnoreEdge){var _=t.GetPolyLine();_===null&&(_=new e.SPolyLine,t.SetPolyLine(_));var D=new e.RefPolyLine(_);D.SetDataOffset(_.GetPoints().length),D.SetDataLength(2*(y-1));var S=new Float32Array(y*3),C=h,P=new e.Vector3(C[w[0]*3+0],C[w[0]*3+1],C[w[0]*3+2]);_.AddPoint(P);for(var v=1;v<y-1;v++){var H=new e.Vector3(C[w[v]*3+0],C[w[v]*3+1],C[w[v]*3+2]);_.AddPoint(H),_.AddPoint(H)}var B=new e.Vector3(C[w[y-1]*3+0],C[w[y-1]*3+1],C[w[y-1]*3+2]);_.AddPoint(B);var j=new e.Edge;j.AddData(D,0),t.AddEdge(j)}}var F=new Uint32Array(n,r,c);return r+=c*4,h=null,p=null,d=null,r},n.prototype.parseMeshMergeFaceByMaterial=function(t,n,r,i,s){var o=this.instanceIdMap[n][1],u=this.instanceIdMap[n][2];if(this.hasLoadedModelMap[o]){var a=this.hasLoadedModelMap[o];t.CopyRenderData(a)}else{var f=0+r,l=new e.Body;t.AddBody(l);var c={};while(f<i+r)f=this.meshFromBinMergeFaceByMaterial(l,s,f,c);var h=Object.getOwnPropertyNames(c);for(var p=0;p<h.length;p++){var d=h[p],v=new e.Face,m=new e.VertexSet,g=new e.Mesh(m),y=c[d][0],b=c[d][1],w=c[d][2],E=new Float32Array(y),S=new Float32Array(b),x=new Float32Array(0),T=!1;w&&w.length>0&&(x=new Float32Array(w),T=!0),m.SetPositionArray(E),m.SetNormalArray(S);var N=!1;w&&w.length>0&&(m.SetUVArray(x),N=!0);var C=m.GetPositionArray().length/3;g.SetDataOffset(0),g.SetDataLength(C);if(e.Parameters.Instance().genetateTexCood&&!N){var k=g.GetBoundingBox();m.computeVertexNormals();var L=m.GetNormalArray(),A=new Float32Array(e.MeshHelper.GetUVArrayByPositionArray(m.GetPositionArray(),k,L));m.SetUVArray(A)}var O=this.getMaterial(d);v.SetMaterial(O);var M=this.getMaterialColor(d);v.SetInitColor(M),v.SetMesh(g),l.AddFace(v),this.hasLoadedModelMap[o]=t}}t.SetDrawDataPrepared(!0);if(u!==4294967295&&u>0){var O=this.getMaterial(u),_=O.GetMaterialType(),M=void 0;if(O instanceof e.ShaderMaterial)return;_===e.MaterialType.MaterialType_Pbr?M=O.AlbedoColor().Clone():M=O.GetDiffuse().Clone(),M.r>=0&&M.g>=0&&M.b>=0&&(t.SetFaceMaterial(O),t.SetInitColor(M))}},n.prototype.fillM3DModelBuffer=function(t,n,r){for(var i=0;i<t.length;i++){var s=this.instanceIdMap[t[i]][3],o=this.instanceIdMap[t[i]][1];if(o!==4294967295){var u=this.modelMap[o],a=this.modelBoundingBox[o],f=new e.BoundingBox(new e.Vector3(a[0],a[1],a[2]),new e.Vector3(a[3],a[4],a[5]));f.Defined()&&f.Length()<1e6&&s.SetBox(f);if(u.length>0){var l=u[0][2],c=u[0][1];this.parseMeshMergeFaceByMaterial(s,t[i],c,l,n)}}}},n.prototype.asynFillM3DModelBuffer=function(t,n,r){function o(t,n,r,i,s){if(t.asynFillModelFlag){var u=i,a=s,f=n;for(var l=0;l<r;l++){f=n+l;var c=t.instanceIdMap[u[f]];if(c){var h=c[3],p=c[1];if(p!==4294967295){var d=t.modelMap[p];if(d.length>0){var v=d[0][2],m=d[0][1];e.Parameters.Instance().isMergeFace?t.parseMeshMergeFaceByMaterial(h,u[f],m,v,a):t.parseMesh(h,u[f],m,v,a)}}}}f=n+r;if(f<u.length)e.Parameters.Instance().isProgressiveDisplay?setTimeout(o,1e-4,t,f,r,u,a):o(t,f,r,u,a);else{var g=t.view.GetSceneManager().GetModelFillManager();t.createM3dMaterial(t.zipFile),g.AsynFillModelEnd(this,g);var y=new RegExp(".*.light$","i"),b=t.zipFile.file(y);b.length>0&&t.parseLight(b[0].asText())}}}this.asynFillModelFlag=!0;var i=t.length,s=Math.floor(i/100);t.length<1e3?s=Math.floor(i/50):t.length<5e3&&(s=Math.floor(i/100)),s<1&&(s=1),o(this,0,s,t,n)},n.prototype.fillM3DModelBuffer1=function(e,t,n){if(n){var r=e.getModelFileInfo().getPartId(),i=e.getModelFileInfo().getInstanceId();if(r!==-1){var s=this.modelMap[r];if(s.length>0){var o=s[0][2],u=s[0][1];this.parseMeshMergeFaceByMaterial(e,i,u,o,t)}}}for(var a=0;a<e.GetSubModels().length;a++){var f=e.GetSubModels()[a];this.fillM3DModelBuffer1(f,t,n)}},n.prototype.OpenZipModel=function(e,t){function r(t){t.BeginRead();var n=/\.info$/i,r=e.file(n);if(r&&r.length>0){var s=r[0].asText();t.parseInfo(s)}var o=/\.animation$/i,u=e.file(o);u&&u.length>0&&(t.animationsrc=u[0].asText());var a=new RegExp(".*.model$","i"),f=e.file(a);t.parseInstanceAttribute(f[0].asText()),t.SetReadPercent(.02),setTimeout(i,t.delay,t)}function i(t){var n=/\.bom$/i,r=e.file(n);t.parseBom(r[0].asArrayBuffer()),setTimeout(s,t.delay,t),t.SetReadPercent(.15)}function s(t){var n=new RegExp(".*.material$","i"),r=e.file(n);t.parseMaterial(r[0].asText()),setTimeout(o,t.delay,t),t.SetReadPercent(.25)}function o(t){var n=new RegExp(".*.lod$","i"),r=e.file(n);t.parseModel(r[0].asArrayBuffer()),t.fillModelBox(),setTimeout(u,t.delay,t),t.SetReadPercent(.5)}function u(t){var n=new RegExp(".*.mesh$","i"),r=e.file(n),i=new RegExp(".*.geo$","i"),s=e.file(i);s.length>0&&t.parseGeo(s[0].asText()),setTimeout(a,t.delay,t),t.SetReadPercent(.9)}function a(t){t.createM3dMaterial(e),setTimeout(f,t.delay,t),t.SetReadPercent(.95)}function f(t){if(t.option.readPMI){var n=new RegExp(".*.pmi$","i"),r=e.file(n);t.parsePMI(r[0].asText())}t.EndRead()}var n=this;this.zipFile=e,r(n)},n.prototype.requestData=function(e,t,n,r){var i=new XMLHttpRequest;i.open(t,e,!1),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.onreadystatechange=function(){if(i.readyState===4&&i.status===200){var e=JSON.parse(JSON.parse(JSON.stringify(i.response)));r&&r(e)}else alert("密钥文件请求错误")};try{t==="POST"?i.send("data="+this.random):i.send(null)}catch(s){console.log(s.code+"\n"+s.message)}},n.prototype.OpenUrl=function(e,t,n){var r=this;this.random="",this.GetRandomString(),this.serverOptions=n,this.FillModelOnceTime(e,t)},n.prototype.FillModelOnceTime=function(t,n){var r=this,i=this;this.getFileFromRemote(t,null,"arraybuffer",!1,function(t){function u(e){e.BeginRead();if(o&&o.length>0){var t=o[0];e.setFileName(t.name.slice(0,t.name.lastIndexOf(".info")));var r=o[0].asText();e.parseInfo(r)}var i=/\.animation$/i,s=n.file(i);if(s&&s.length>0){var u=s[0].asText().split("</SimulationAnimation>"),f=u[u.length-1];f.length==1?e.animationsrc=s[0].asText().replace(f,""):e.animationsrc=s[0].asText()}var l=new RegExp(".*.model$","i"),c=n.file(l),h=c[0].asText();e.parseInstanceAttribute(h),e.parseModels(h),e.SetReadPercent(.02),setTimeout(a,e.delay,e)}function a(e){var t=/\.bom$/i,r=n.file(t);e.parseBom(r[0].asArrayBuffer()),setTimeout(f,e.delay,e),e.SetReadPercent(.15)}function f(e){var t=new RegExp(".*.material$","i"),r=n.file(t);e.parseMaterial(r[0].asText()),setTimeout(l,e.delay,e),e.SetReadPercent(.25)}function l(e){var t=new RegExp(".*.lod$","i"),r=n.file(t);e.parseModel(r[0].asArrayBuffer()),e.fillModelBox(),setTimeout(c,e.delay,e),e.SetReadPercent(.5)}function c(t){var r=new RegExp(".*.geo$","i"),i=n.file(r);i.length>0&&t.parseGeo(i[0].asText());var s=new RegExp(".*.story$","i"),o=n.file(s);o.length>0&&t.parseStory(o[0].asText());var u=new RegExp(".*.link$","i"),a=n.file(u);a.length>0&&t.parseRelated(a[0].asText());if(e.Parameters.Instance().IsShowSHotSpot){var f=new RegExp(".*.shotspot$","i"),l=n.file(f);l.length>0&&t.parseSHotSpot(l[0].asText())}setTimeout(h,t.delay,t),t.SetReadPercent(.9)}function h(e){var t=new RegExp(".*.view$","i"),r=n.file(t);r.length>0&&e.parseModelView(r[0].asText()),setTimeout(p,e.delay,e),e.SetReadPercent(.95)}function p(e){if(e.option.readPMI){var t=new RegExp(".*.pmi$","i"),r=n.file(t);if(r.length>0)try{e.parsePMI(r[0].asText())}catch(i){}else console.log("no pmi file exist.")}e.EndRead()}var n=new JSZip(t,{retrievePasswordCallback:function(){return i.GetDString(i.xd)},invalidPasswordCallback:function(e,t){return!0}});r.zipFile=n;var s=/\.info$/i,o=n.file(s);o[0]._data.encrypted&&i.serverOptions?r.requestData(i.serverOptions,"POST",r.random,function(e){i.xd=e.key,u(i)}):o[0]._data.encrypted&&!i.serverOptions?alert("该文件为加密文件，请配置密钥信息"):o[0]._data.encrypted||u(i)},n)},n.prototype.AsynFillModelMesh=function(){var e=this.zipFile,t=new RegExp(".*.mesh$","i"),n=e.file(t),r=Object.getOwnPropertyNames(this.instanceIdMap);this.asynFillM3DModelBuffer(r,n[0].asArrayBuffer(),!0)},n.prototype.CancelAsynFillModel=function(){this.asynFillModelFlag=!1},n.prototype.parseGeo=function(e){var t=JSON.parse(e),n=t.geometries.models;for(var r=0;r<n.length;r++){var i=n[r],s=i.meshFaces,o=i.meshEdges;for(var u in s){var a=s[u],f=this.allMeshFaceMap[i.id];f||(f={}),f[u]=a,this.allMeshFaceMap[i.id]=f}for(var l in o){var a=o[l],c=this.allMeshEdgeMap[i.id];c||(c={}),c[l]=a,this.allMeshEdgeMap[i.id]=c}}if(Object.keys(this.view.GetSceneManager().GetExtendInfoManager().allMeshFaceAttr).length>0)for(var h in this.allMeshFaceMap){var p=this.allMeshFaceMap[h];this.view.GetSceneManager().GetExtendInfoManager().allMeshFaceAttr[h]=p}else this.view.GetSceneManager().GetExtendInfoManager().SetAllMeshFaceAttr(this.allMeshFaceMap);if(Object.keys(this.view.GetSceneManager().GetExtendInfoManager().allMeshEdgeAttr).length>0)for(var h in this.allMeshEdgeMap){var p=this.allMeshEdgeMap[h];this.view.GetSceneManager().GetExtendInfoManager().allMeshEdgeAttr[h]=p}else this.view.GetSceneManager().GetExtendInfoManager().SetAllMeshEdgeAttr(this.allMeshEdgeMap)},n.prototype.parseModels=function(e){var t=JSON.parse(e),n=t.models;for(var r=0;r<n.length;r++){var i=n[r],s=void 0,o={};for(var u in i){if(u==="id"){s=i[u];continue}var a=i[u];o[u]=a}this.parseModelsMap[s]=o}this.view.GetSceneManager().GetExtendInfoManager().SetAllModelFileAttr(this.parseModelsMap)},n.prototype.parseModelView=function(t){var r=JSON.parse(JSON.parse(JSON.stringify(t)));if(!r)return;var i=r.views;if(!i)return;for(var s=0;s<i.length;s++){var o=i[s],u=n.parseOneModelView(o),a=e.SvlxReader.parseOneModelView(JSON.parse(JSON.parse(JSON.stringify(u.ToJson()))));this.topModel.AddModelView(a)}var f=r.view_pmis;if(f&&f.length>0)for(var s=0;s<f.length;s++){var l=f[s],c=l.id,h=l.pmis;if(c){var p=this.topModel.GetModleView(c);if(h&&h.length>0)for(var d=0;d<h.length;d++)h[d]&&p.AddPMIId(h[d])}}},n.parseOneModelView=function(t){var n=SView.ViewManager.GetInstance(),r=new e.ModleView;r.SetID(t.id),r.SetName(t.name),r.SetViewType(t.usageType);switch(t.usageType){case 9:var i=t.clipPlanes;if(i)for(var s=0;s<i.length;s++){var o=i[s],u=new e.Vector3(o.originPnt.split(" ")[0],o.originPnt.split(" ")[1],o.originPnt.split(" ")[2]),a=new e.Vector3(-o.normal.split(" ")[0],-o.normal.split(" ")[1],-o.normal.split(" ")[2]),f=new e.Vector3(o.UDir.split(" ")[0],o.UDir.split(" ")[1],o.UDir.split(" ")[2]),l=new e.Vector3(o.VDir.split(" ")[0],o.VDir.split(" ")[1],o.VDir.split(" ")[2]),c=new e.SectionPlane(u,a,f,l);r.AddSectionPlaneId(c.GetID())}}var h=t.camera;if(h){var p=new e.Camera,d=void 0,v=void 0,m=void 0;h.origin&&(d=new e.Vector3(h.origin.split(" ")[0],h.origin.split(" ")[1],h.origin.split(" ")[2])),h.targetVector&&(v=new e.Vector3(h.targetVector.split(" ")[0],h.targetVector.split(" ")[1],h.targetVector.split(" ")[2])),h.upVector&&(m=new e.Vector3(h.upVector.split(" ")[0],h.upVector.split(" ")[1],h.upVector.split(" ")[2]));if(h.matix){var g=new e.Matrix4;g.fromString(h.matix);var y=new e.Quaternion,b=new e.Matrix3(g.data[0],g.data[4],g.data[8],g.data[1],g.data[5],g.data[9],g.data[2],g.data[6],g.data[10]);y.FromRotationMatrix(b),p.SetPosition(new e.Vector3(g.data[12],g.data[13],g.data[14])),p.SetRotation(y)}else{var y=new e.Quaternion;if((v.x!=-1||v.y!=-1||v.z!=-1)&&(m.x!=-1||m.y!=-1||m.z!=-1)){var w=v.CrossProduct(m),E=m,S=v.NagativeED().Clone();y.FromAxes(w,E,S)}p.SetPosition(d),p.SetRotation(y)}p.SetOrthographic(h.projectType),r.SetCamera(p),r.SetUpDataCamera(!0)}var x=t.insAttributes;for(var T in x){var N=x[T],C=N.matix,k=new e.InstanceAttribute;if(C){var L=void 0,A=" ",O=C.split(A);O.length==16?L=new e.Matrix4:O.length==12&&(L=new e.Matrix3x4),L.fromString(C);if(L.Equals(e.Matrix4.ZERO().Clone()))continue;k.placeMatrix=L}k.path=e.PathHelper.SVLPathDecToHex(T);var M=N.color;if(M){var _=M.split(" ");if(Number(_[0])>=0&&Number(_[1])>=0&&Number(_[2])>=0){k.hasColor=!0;var D=new e.Color(Number(_[0]),Number(_[1]),Number(_[2]),Number(_[3]));k.insColor=D.Clone()}else k.hasColor=!1}var P=N.visible;k.visible=P===0?!0:!1,r.GetInstanceAttributeMap().Put(Number(N.plcPath),k)}return n.AddModleView(r),r},n.GetGeometryAttributeFromStk=function(t){var n=null,r=Number(t.type);switch(r){case e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN:break;case e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE:n=this.GetPlanfaceGeoFromStk(t);break;case e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_REVOLUTIONFACE:n=this.GetRevolutionfaceGeoFromStk(t);break;case e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_CYLINDERFACE:n=this.GetCylinderfaceGeoFromStk(t);break;case e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_CONICALFACE:n=this.GetConicalfaceGeoFromStk(t);break;case e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_SPHEREFACE:n=this.GetSpherefaceGeoFromStk(t);break;case e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_TOROIDALFACE:n=this.GetToroidaifaceFromStk(t);break;case e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE:n=this.GetLineGeoFromStk(t);break;case e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE:n=this.GetEllipseGeoFromStk(t);break;default:}return n},n.GetPlanfaceGeoFromStk=function(t){if(Number(t["type"])!=e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_PLANEFACE)return null;var n=new e.PlaneFaceAttribute,r=t.normal.split(" ");n.SetNormal(new e.Vector3(Number(r[0]),Number(r[1]),Number(r[2])));var i=t.origin.split(" ");return n.SetOrigin(new e.Vector3(Number(i[0]),Number(i[1]),Number(i[2]))),n},n.GetRevolutionfaceGeoFromStk=function(t){if(Number(t["type"])!=e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_REVOLUTIONFACE)return null;var n=new e.RevolutionFaceAttribute,r=t.radius;n.SetRadius(Number(r));var i=t.axisDirection.split(" ");n.SetRevoAxis(new e.Vector3(Number(i[0]),Number(i[1]),Number(i[2])));var s=t.axisOrigin.split(" ");return n.SetAxisOrigin(new e.Vector3(Number(s[0]),Number(s[1]),Number(s[2]))),n},n.GetCylinderfaceGeoFromStk=function(t){if(Number(t["type"])!=e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_CYLINDERFACE)return null;var n=new e.CylinderFaceAttribute;return n},n.GetConicalfaceGeoFromStk=function(t){if(Number(t["type"])!=e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_CONICALFACE)return null;var n=new e.ConicalFaceAttribute;return n},n.GetSpherefaceGeoFromStk=function(t){if(Number(t["type"])!=e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_SPHEREFACE)return null;var n=new e.SphereFaceAttribute;return n},n.GetToroidaifaceFromStk=function(t){if(Number(t["type"])!=e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_TOROIDALFACE)return null;var n=new e.ToroidalFaceAttribute;return n},n.GetLineGeoFromStk=function(t){if(Number(t["type"])!=e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_LINE)return null;var n=new e.LineAttribute,r=t.startPoint.split(" "),i=t.endPoint.split(" ");return n.SetCenterPoint(new e.Vector3((i[0]+r[0])/2,(i[1]+r[1])/2,(i[2]+r[2])/2)),n.SetDirection(new e.Vector3(i[0]-r[0],i[1]-r[1],i[2]-r[2])),n.SetStartPoint(new e.Vector3(r[0],r[1],r[2])),n.SetEndPoint(new e.Vector3(i[0],i[1],i[2])),n},n.GetEllipseGeoFromStk=function(t){if(Number(t["type"])!=e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_ELLIPSE)return null;var n=new e.EllipseAttribute,r=t.centerPoint.split(" "),i=Number(t.majorRadius),s=Number(t.minorRadius),o=t.startPoint.split(" "),u=t.endPoint.split(" "),a=t.xDirection.split(" "),f=t.yDirection.split(" "),l=t.zDirection.split(" ");return n.SetCenterPoint(new e.Vector3(r[0],r[1],r[2])),n.SetMajorRadius(i),n.SetMinorRadius(s),n.SetStartPoint(new e.Vector3(o[0],o[1],o[2])),n.SetEndPoint(new e.Vector3(u[0],u[1],u[2])),n.SetXYZDir(new e.Vector3(a[0],a[1],a[2]),new e.Vector3(f[0],f[1],f[2]),new e.Vector3(l[0],l[1],l[2])),n},n.prototype.parseMaterial=function(e){var t=JSON.parse(e);if(!t){console.error("Material file is empty!");return}var n="";t.GlobalEffect&&(n=t.GlobalEffect),this.view.GetSceneManager().GetRenderManager().SetGlobalEffect(n);var r=t.materials;if(!r){console.error("Material file is empty!");return}for(var i=0;i<r.length;i++){var s=r[i];this.materialMap[s.id+""]=s}var o=t.images;if(o)for(var i=0;i<o.length;i++){var u=o[i];this.imagesMap[u.id+""]=u}},n.prototype.getMaterialColor=function(t){var n=e.Color.GRAY().Clone(),r=this.materialMap[t];if(r){var i=r.diffuseColor,s=r.transparency;if(i===undefined||s===undefined)return n;s=s<0?1:s,n=new e.Color(i[0],i[1],i[2],s)}return n},n.prototype.GetTexture2D=function(){},n.prototype.getMaterial=function(t){var n,r;if(t===4294967295)return n;if(this.m_protoTypeMaterialCache[t]!==undefined&&this.m_protoTypeMaterialCache[t]!==null)return n=this.m_protoTypeMaterialCache[t],n;this.m_protoTypeColorCache[t]!==undefined&&this.m_protoTypeColorCache[t]!==null&&(r=this.m_protoTypeColorCache[t].Clone());var i=this.materialMap[t];if(i){var s=i.diffuseColor,o=i.transparency,u=i.diffuseTexture,a=i.reflectiveTexture,f={},l=i.type;if(l===1||l===0){n=this.view.GetSceneManager().GetResourceManager().GetOrCreateMaterial(t,1);var c=n;if(u||a)this.m3dMaterialMap[t]=c;c.SetDisplayName(i.name),r=i.diffuseColor;var h=i.ambientColor,p=i.specularColor,d=i.emissiveColor;r&&(r=new e.Color(i.diffuseColor[0],i.diffuseColor[1],i.diffuseColor[2],i.diffuseColor[3]?i.diffuseColor[3]:i.transparency),r.a<0&&(r.a=1)),h&&(h=new e.Color(i.ambientColor[0],i.ambientColor[1],i.ambientColor[2],i.ambientColor[3]?i.ambientColor[3]:1)),p&&(p=new e.Color(i.specularColor[0],i.specularColor[1],i.specularColor[2],i.specularColor[3]?i.specularColor[3]:1)),d&&(d=new e.Color(i.emissiveColor[0],i.emissiveColor[1],i.emissiveColor[2],i.emissiveColor[3]?i.emissiveColor[3]:1)),r&&r.r>=0&&r.g>=0&&r.b>=0&&(c.SetDiffuse(r),c.Opacity(r.a)),h&&h.r>=0&&h.g>=0&&h.b>=0&&c.SetAmbient(h),p&&p.r>=0&&p.g>=0&&p.b>=0&&c.SetSpecular(p),d&&d.r>=0&&d.g>=0&&d.b>=0&&c.SetEmissive(d);if(i.shininess){var v=i.shininess;v>=0&&c.SetShininess(v)}var m=!1,g=i.uvScale,y=i.uvRotate,b=i.uvTranslate,w=i.diffuseTexture;w&&(m=!0);var E=i.matcapMap;E&&(m=!0);var S=i.normalMapScale;S&&S[0]>=0&&S[1]>=0&&c.NormalMapScale(new e.Vector2(S[0],S[1])),m&&(b&&c.SetUvTranslate(new e.Vector2(b[0],b[1])),g&&c.SetUvScale(new e.Vector2(g[0],g[1])),y!==null&&
y!==undefined&&c.SetUvRotate(y)),this.m_protoTypeMaterialCache[t]=c,this.m_protoTypeColorCache[t]=r.Clone()}else if(l===4){n=this.view.GetSceneManager().GetResourceManager().GetOrCreateMaterial(t,l);var c=n;if(u||a||i.matcapMap)this.m3dMaterialMap[t]=c;c.SetDisplayName(i.name);var x;i.diffuseColor&&(x=new e.Color(i.diffuseColor[0],i.diffuseColor[1],i.diffuseColor[2],i.diffuseColor[3]?i.diffuseColor[3]:i.transparency),x.a<0&&(x.a=1)),x&&x.r>=0&&x.g>=0&&x.b>=0&&(c.SetDiffuse(x),c.Opacity(x.a));var g=i.uvScale;this.m_protoTypeMaterialCache[t]=c,this.m_protoTypeColorCache[t]=x}else if(l===2){n=this.view.GetSceneManager().GetResourceManager().GetOrCreateMaterial(t,l);var c=n;c.SetDisplayName(i.name);if(u||a)this.m3dMaterialMap[t]=c;var T;i.diffuseColor&&(T=new e.Color(i.diffuseColor[0],i.diffuseColor[1],i.diffuseColor[2],i.diffuseColor[3]?i.diffuseColor[3]:i.transparency),T.a<0&&(T.a=1)),T&&T.r>=0&&T.g>=0&&T.b>=0&&(c.SetAlbedoColor(T),c.SetOpacity(T.a));var N=i.metalnessFactor;N?N>=0&&c.SetMetalnessFactor(N):c.SetMetalnessFactor(0),N=i.roughnessFactor,N?N>=0&&c.SetRougthnessFactor(N):c.SetRougthnessFactor(0);var C=i.useClearCoat;c.SetUseClearCoat(C),N=i.clearCoat,N>=0?c.SetClearCoat(N):c.SetClearCoat(0),N=i.clearCoatRoughness,N>=0?c.SetClearCoatRoughness(N):c.SetClearCoatRoughness(0);var m=!1,w=i.diffuseTexture;w&&(m=!0);var S=i.normalMapScale;S&&S[0]>0&&S[1]>0&&c.SetNormalMapScale(new e.Vector2(S[0],S[1]));var g=i.uvScale,y=i.uvRotate,b=i.uvTranslate;m&&(b&&c.SetUvTranslate(new e.Vector2(b[0],b[1])),g&&c.SetUvScale(new e.Vector2(g[0],g[1])),y&&c.SetUvRotate(y)),this.m_protoTypeMaterialCache[t]=c,this.m_protoTypeColorCache[t]=T.Clone()}else{var k=i.parameters;n=this.view.GetSceneManager().GetResourceManager().GetOrCreateMaterial(t,e.MaterialType.MaterialType_Shader);if(!n.GetNeedsUpdateUniformParamerers())return n;n.SetUniformParameter("type",new e.Uniform("Int",[l])),this.ParseMaterialParameters(k,n),n.SetMaterialType(l)}n.SetSvlId(i.id)}else n=this.view.GetSceneManager().GetResourceManager().GetOrCreateMaterial(e.DEFAULT_MATERIAL,e.MaterialType.MaterialType_Phong);return n},n.prototype.fillTextureImageResouce=function(e,t,n,r){var i=new Array,s=e.GetOrCreateTexture(t),o=t.lastIndexOf("."),u=t.lastIndexOf("\\")+1,a=t.substring(u,o),f=new RegExp(a,"i"),l=n.file(f);if(l[0]){var c=l[0].asArrayBuffer(),h=new Blob([c],{type:"application/octet-binary"}),p=URL.createObjectURL(h),d=e.GetImage(t);d===null&&(d=e.GetOrCreateImageById(t,r,p)),s.AddImage(d)}else s=null;return s},n.prototype.createM3dMaterial=function(t){var n=this.view.GetSceneManager().GetResourceManager();for(var r in this.m3dMaterialMap){var i=this.m3dMaterialMap[r];if(this.materialMap[r].diffuseTexture){var s=this.imagesMap[this.materialMap[r].diffuseTexture.ref].uri,o=this.fillTextureImageResouce(n,s,t,this.materialMap[r].diffuseTexture.ref[0]);i.GetMaterialType()===e.MaterialType.MaterialType_Pbr?i.SetAlbedoMap(o):i.SetDiffuseMap(o)}if(this.materialMap[r].metalnessRoughnessMap){var s=this.imagesMap[this.materialMap[r].metalnessRoughnessMap.ref].uri,o=this.fillTextureImageResouce(n,s,t,this.materialMap[r].diffuseTexture.ref[0]);i.SetMetalnessRoughnessMap(o)}if(this.materialMap[r].matcapMap){var s=this.imagesMap[this.materialMap[r].matcapMap.ref].uri,o=this.fillTextureImageResouce(n,s,t,this.materialMap[r].matcapMap.ref[0]);i.SetMatcapMap(o)}if(this.materialMap[r].normalMap){var s=this.imagesMap[this.materialMap[r].normalMap.ref].uri,o=this.fillTextureImageResouce(n,s,t,this.materialMap[r].normalMap.ref[0]);i.SetNormalMap(o)}}this.view.GetSceneManager().GetResourceManager().MaterialToJSON()},n.prototype.parseLight=function(t){var n=this.GetView().GetSceneManager().GetLightManager();if(t.length>0){var r=JSON.parse(t),i=void 0,s=this.GetView().GetModel().GetWorldBoundingBox();if(s){var o=s.Center(),u=r.lights;n.RemoveAllLight();for(var a=0,f=u;a<f.length;a++){var l=f[a],c=l.type;switch(c){case 1:var h=n.CreateLight(e.LightType.LightType_Directional);if(h){i=h,h.SetWorldPosition(o.Clone());var p=new e.Quaternion(45,new e.Vector3(-1,0,0));h.SetWorldRotation(p)}break;case 2:var d=n.CreateLight(e.LightType.LightType_Point);if(d){i=d,d.SetWorldPosition(o);var v=l.distance;v&&d.SetDistance(v);var m=l.decay;m&&d.SetDecay(m)}break;case 3:var g=n.CreateLight(e.LightType.LightType_Spot);if(g!=null){i=g;var y=new e.Vector3(1,1,1);y.Normalize(),g.SetWorldPosition(o.Add(y.Multiply(s.Length()*.2)));var p=new e.Quaternion(45,new e.Vector3(-1,0,0));g.SetWorldRotation(p);var v=l.distance;v&&g.SetDistance(v);var m=l.decay;m&&g.SetDecay(m);var b=l.angle;b&&g.SetAngle(b);var w=l.penumbra;w&&g.SetPenumbra(w)}break;case 4:var E=n.CreateLight(e.LightType.LightType_Hemisphere);if(E!=null){i=E,E.SetWorldPosition(new e.Vector3(0,1,0));var S=l.groundColor;if(S){var x=new e.Color;x.r=S[0],x.g=S[1],x.b=S[2],x.a=S[3],E.SetGroundColor(x)}}}if(i){var T=l.name;T&&i.SetName(T);var N=l.Intensity;N&&i.SetIntensity(N);var C=l.lightColor;if(C){var k=new e.Color;k.r=C[0],k.g=C[1],k.b=C[2],k.a=C[3],i.SetLightColor(k)}var L=l.castShadow;L&&i.SetShowSimpleSign(L);var A=l.showSimpleSign;A&&i.SetShowSimpleSign(A);var O=l.showAllSign;O&&i.SetShowSimpleSign(O);var M=l.lightPosition,_=l.lightRotation;M&&i.SetWorldPosition(new e.Vector3(M[0],M[1],M[2]));if(_){var D=new e.Quaternion;D.x=_[0],D.y=_[1],D.z=_[2],D.w=_[3],i.SetWorldRotation(D)}n.AddLight(i)}}}}},n.prototype.parseInstanceAttribute=function(e){var t=JSON.parse(e),n=t.instances;for(var r=0;r<n.length;r++){var i=n[r];this.instanceAttrMap[i.id]=i}this.view.GetSceneManager().GetExtendInfoManager().SetAllInstanceAttr(this.instanceAttrMap)},n.prototype.parsePMI=function(t){var n=this,r=!1;if(!r){var i=JSON.parse(t);if(!i){console.error("pmi file is empty!");return}var s=i.pmis;if(!s){console.error("pmi file is empty!");return}for(var o=0;o<s.length;o++){var u=s[o],a=new e.PMI;a.fromJson(u),a.SetParentModel(n.topModel),n.pmiMap.Put(a.GetID(),a)}n.view.GetSceneManager().extendinfoMgr.SetPMIs(n.pmiMap);for(var o=0;o<i.model_pmis.length;o++){var f=i.model_pmis[o];n.modelPMIMap[f.id]=f.pmis}n.view.GetSceneManager().extendinfoMgr.SetModelPMIRefs(n.modelPMIMap),n.CreateAllPMITextMeshs()}},n.prototype.CreateAllPMITextMeshs=function(){var t=[];for(var n=0;n<this.pmiMap.Size();n++){var r=this.pmiMap.Values()[n];for(var i=0;i<r.ComTexts.length;i++){var s=r.ComTexts[i];s.clearMesh();for(var o=0;o<s.GetCTextList().length;o++){var u=s.GetCText(o),a={pmiID:n,comTextID:i,ctextID:o,text:u.GetText()};t.push(a)}}}var f=t.length;console.log("pmiText count:"+f);var l=e.ComText.option.pmiServer+"/getTextMeshAll",c="json",h="application/json",p=t;p.length>0&&this.SendRequest(this,l,"POST",h,p,c,this.onReceiveTextMesh)},n.prototype.onReceiveTextMesh=function(e,t){var n=t;for(var r=0;r<n.length;r++){var i=n[r],s=e.pmiMap.Values()[i.pmiID],o=s.ComTexts[i.comTextID];o.setTextMeshById(i.CTextID,i)}},n.prototype.SendRequest=function(e,t,n,r,i,s,o,u){n===void 0&&(n="GET"),i===void 0&&(i=null),s===void 0&&(s="text");var a=new XMLHttpRequest;a.open(n,t),a.setRequestHeader("Content-Type",r),s&&(a.responseType=s),a.onreadystatechange=function(){if(a.readyState===4&&a.status===200){var t=a.response;o&&o(e,t)}},u&&(a.onprogress=u),i&&r.toLowerCase()=="application/json"?a.send(JSON.stringify(i)):a.send()},n.prototype.travelModelTree=function(e,t){t(e);for(var n=0;n<e.GetSubModels().length;n++){var r=e.GetSubModels()[n];this.travelModelTree(r,t)}},n.prototype.parseInfo=function(e){var t=JSON.parse(JSON.stringify(e)),n=t.info;if(n){var r=n.scene;r&&this.loadInfoSceneNode(r)}},n.prototype.loadInfoSceneNode=function(t){var n=this.view.GetSceneManager().GetResourceManager(),r=t.background;if(r){var i=r.type,s=r.style;if(i===1){if(s===1){var o=r.items;for(var u in o){var a=u,f=o[u],l=f.split(","),c=l[0].split(" "),h=l[1].split(" "),p=new e.Color(parseFloat(c[0]),parseFloat(c[1]),parseFloat(c[2])),d=new e.Color(parseFloat(h[0]),parseFloat(h[1]),parseFloat(h[2]));this.view.SetBackgroundColor(p,d)}this.view.SetBackgroundUseImage(!1),this.view.SetBackgroundUseSkyBox(!1)}}else if(i===2){if(s===1){var o=r.items;for(var u in o){var v=u,m=o[v],g=n.GetOrCreateTexture(m),y=m.lastIndexOf("."),b=m.lastIndexOf("\\")+1,w=m.substring(b,y),E=new RegExp(w,"i"),S=this.zipFile.file(E),x=S[0].asArrayBuffer(),T=new Blob([x],{type:"application/octet-binary"}),N=URL.createObjectURL(T),C=n.GetImage(m);C===null&&(C=n.GetOrCreateImage(m,N)),g.AddImage(C),this.view.SetBackgroundTexture(g)}this.view.SetBackgroundUseImage(!0),this.view.SetBackgroundUseSkyBox(!1)}}else if(i===3&&s===1){var o=r.items;for(var u in o){var k=u,L=o[k].replace(/\s+/g,""),A=L.split(","),O=[];for(var M=0;M<A.length;M++){var m=A[M],y=m.lastIndexOf("."),b=m.lastIndexOf("\\")+1,w=m.substring(b,y),E=new RegExp(w,"i"),S=this.zipFile.file(E),x=S[0].asArrayBuffer(),T=new Blob([x],{type:"application/octet-binary"}),N=URL.createObjectURL(T),C=n.GetImage(m);C===null&&(C=n.GetOrCreateImage(m,N)),O.push(C)}var g=n.GetOrCreateTexture(k,e.Texture.TEXTURE_CUBE);g.AddImages(O),this.view.AddBackgroundSkyBoxTexture(k,g)}this.view.SetBackgroundUseImage(!1),this.view.SetBackgroundUseSkyBox(!0)}}},n.prototype.ParseMaterialParameters=function(t,n){for(var r in t){var i=t[r],s=i.type,o=i.value,u=this.GetResourceManager();if(s==="Texture2D"){var a=this.imagesMap[o].uri,f=this.GetResourceManager().GetOrCreateTexture(a),l=a.lastIndexOf("."),c=a.lastIndexOf("\\")+1,h=a.substring(c,l),p=new RegExp(h,"i"),d=this.zipFile.file(p),v=d[0].asArrayBuffer(),m=new Blob([v],{type:"application/octet-binary"}),g=URL.createObjectURL(m),y=u.GetImage(a);y===null&&(y=u.GetOrCreateImage(a,g)),f.AddImage(y),n.SetUniformParameter(r,new e.Uniform(s,f))}else if(s==="TextureCube"){var b=[],w="";for(var E=0;E<o.length;E++){var a=this.imagesMap[o[E]].uri,l=a.lastIndexOf("."),c=a.lastIndexOf("\\")+1,h=a.substring(c,l);w+=h;var p=new RegExp(h,"i"),d=this.zipFile.file(p),v=d[0].asArrayBuffer(),m=new Blob([v],{type:"application/octet-binary"}),g=URL.createObjectURL(m),y=u.GetImage(a);y===null&&(y=u.GetOrCreateImage(a,g)),b.push(y)}var f=u.GetOrCreateTexture(w,e.Texture.TEXTURE_CUBE);f.AddImages(b),n.SetUniformParameter(r,new e.Uniform(s,f))}else if(s==="Vector3"){var S=void 0;o&&o instanceof Array&&o.length===3?S=new e.Vector3(o[0],o[1],o[2]):S=new e.Vector3,n.SetUniformParameter(r,new e.Uniform(s,S))}else if(s==="Vector4"){var S=void 0;o&&o instanceof Array&&o.length===4?S=new e.Vector4(o[0],o[1],o[2],o[3]):S=new e.Vector4,n.SetUniformParameter(r,new e.Uniform(s,S))}else if(s==="Float"){var S=void 0;o instanceof Array?S=o:(S=[],S.push(o)),n.SetUniformParameter(r,new e.Uniform(s,S))}else if(s==="Bool"){var S=void 0;S=o==1?1:0,n.SetUniformParameter(r,new e.Uniform(s,S))}else if(s==="Int"){var S=void 0;o instanceof Array?S=o:(S=[],S.push(o)),n.SetUniformParameter(r,new e.Uniform(s,S))}}n.SetNeedsUpdateUniformParamerers(!1)},n.prototype.parseRelated=function(e){var t=JSON.parse(JSON.parse(JSON.stringify(e))),n=t.version;if(n){SView.LinkManager.Instance().version=n;var r=t.links;for(var i=0,s=r;i<s.length;i++){var o=s[i],u=o.srcType,a=o.src,f=o.targetType,l=o.target,c=o.condition,h=null;if(f=="story")for(var p=0,d=this.storyList;p<d.length;p++){var v=d[p];v.id.toString()===l&&(h=v)}var m=new SView.Link(u,a,f,l,c,h);SView.LinkManager.Instance().AddLink(m)}}},n.prototype.parseStory=function(e){var t=JSON.parse(JSON.parse(JSON.stringify(e))),n=t.version;if(n){var r=t.storis;r&&(this.storyList=r)}},n.prototype.parseSHotSpot=function(t){var n=JSON.parse(JSON.parse(JSON.stringify(t))),r=n.hotspots;for(var i=0;i<r.length;i++){var s=r[i],o=s.id,u=s.name,a=s.description,f="";s["viewName"]!=null&&(f=s.viewName);var l="";s["animationName"]!=null&&(l=s.animationName);var c="";s.voiceFileName===null&&(c=s.voiceFileName);var h=s.position[0],p=s.position[1],d=s.position[2],v=s.camera[0],m=s.camera[1],g=s.camera[2],y=s.camera[3],b=s.camera[4],w=s.camera[5],E=s.camera[6],S=s.camera[7],x=s.camera[8],T=s.camera[9],N=0;s["cameraProjectionType"]!=null&&(N=s.cameraProjectionType);var C=new e.ImageModel,k="./images/hotspot.png",L=this.view.GetSceneManager().GetResourceManager(),A=L.GetImage(k);A===null&&(A=L.GetOrCreateImage(k,k)),C.SetImage(A);var O=e.Parameters.Instance().hotSpotImageSize;C.SetImageSize(new e.Vector3(h,p,d),new e.Vector2(O,O)),C.SetAllowScall(!1),C.SetAllowRotate(!1),C.SetInTopShow(!0),this.GetView().GetSceneManager().GetHandlerGroup().AddSVLTool(C,u);var M=new SView.SHotSpot(o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C);SView.SHotSpotManager.Instance().AddHotSpot(M)}},n}(e.Reader);e.SvlxReader=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){}return e.GetXMLDom=function(e){var t=e.asText(),n=t.indexOf("<");t=t.substr(n);var r=null;if(window.hasOwnProperty("DOMParser"))try{var i=new DOMParser;r=i.parseFromString(t,"text/xml")}catch(s){}else if(window.hasOwnProperty("ActiveXObject")){var o=["MSXML2.DOMDocument","Microsoft.XMLDOM"];for(var u=0;u<o.length;u++)try{r=new ActiveXObject(o[u]),r.async=!1,r.loadXML(t);break}catch(s){continue}}return r},e}();e.XMLParser=t})(M3D||(M3D={}));var SView;(function(e){var t=function(){function e(){this.XMLDom=null}return e.GetInstance=function(){return e.instance||(e.instance=new e),e.instance},e.prototype.GetModleViewByXmlStr=function(e){var t=new M3D.ModleView,n=new M3D.Map,r=new M3D.Camera,i=e.getElementsByTagName("Camera")[0],s=i.getAttribute("Position").split(" "),o=i.getAttribute("Rotation").split(" ");r.SetCamera(new M3D.Vector3(parseFloat(s[0]),parseFloat(s[1]),parseFloat(s[2])),new M3D.Quaternion(parseFloat(o[3]),parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2])),parseFloat(i.getAttribute("ZoomFactor")),i.getAttribute("Orthographic")=="1"?!0:!1,parseFloat(i.getAttribute("NearClip")),parseFloat(i.getAttribute("FarClip")),parseInt(i.getAttribute("FOV")));var u=e.getElementsByTagName("Instances"),a=0;a==u.length;if(a>0&&u!==null){var f=u[0].getElementsByTagName("Instance");if(f.length>0)for(var l=0;l<f.length;l++){var c=new M3D.InstanceAttribute;c.id=parseInt(f[l].getAttribute("ID")),c.path=f[l].getAttribute("Path"),c.visible=f[l].getAttribute("Visible")==="1"?!0:!1,c.hasColor=f[l].getAttribute("HasColor")==="1"?!0:!1;var h=f[l].getAttribute("Color").split(" ");c.insColor=new M3D.Color(parseFloat(h[0]),parseFloat(h[1]),parseFloat(h[2]),parseFloat(h[3])),c.materialId=parseInt(f[l].getAttribute("MaterialID"));var p=f[l].getAttribute("PlaceMatrix").split(" ");c.placeMatrix=new M3D.Matrix4(parseFloat(p[0]),parseFloat(p[1]),parseFloat(p[2]),parseFloat(p[3]),parseFloat(p[4]),parseFloat(p[5]),parseFloat(p[6]),parseFloat(p[7]),parseFloat(p[8]),parseFloat(p[9]),parseFloat(p[10]),parseFloat(p[11]),parseFloat(p[12]),parseFloat(p[13]),parseFloat(p[14]),parseFloat(p[15])),n.Put(c.id,c)}}var d=e.getAttribute("Type");switch(d){case"DefaultView":this.Type=M3D.ViewTypeEnum.DefaultView;break;case"OrignalView":this.Type=M3D.ViewTypeEnum.OrignalView;break;case"UserView":this.Type=M3D.ViewTypeEnum.UserView;break;default:this.Type=M3D.ViewTypeEnum.DefaultView}return t.SetModleView(parseInt(e.getAttribute("ID")),e.getAttribute("Name"),this.Type,r,[],[],[],n),t},e.prototype.GetModleViewList=function(e,t){this.XMLDom=e,this.modleViewsArray=this.XMLDom.getElementsByTagName("SVL")[0].children[0].children[1].getElementsByTagName("View");for(var n=0;n<this.modleViewsArray.length;n++)t.push(this.GetModleViewByXmlStr(this.modleViewsArray[n]));return t},e.prototype.UpdateModleView=function(e){},e.prototype.DelateModleView=function(e){},e.prototype.AddModleView=function(e){},e.instance=null,e}();e.ViewManager=t})(SView||(SView={}));var M3D;(function(e){var t;(function(e){e[e.HANDLER_WALKTHROUGH=0]="HANDLER_WALKTHROUGH",e[e.HANDLER_COMMON=1]="HANDLER_COMMON",e[e.HANDLER_ORBIT=2]="HANDLER_ORBIT",e[e.HANDLER_DRAGGER=3]="HANDLER_DRAGGER"})(t=e.TouchHandlerType||(e.TouchHandlerType={}));var n=function(){function n(){this.m_restoreCamera=!0,this.trackBall=new e.Trackball,this.defaultView=6,this.keepRotateTimer=new e.Timer,this.upDirection=e.Vector3.UP().Clone(),this.oribitControlTarget=e.Vector3.ZERO().Clone(),this.firstPersionSpeed=0,this.standardSpeed=0,this.modelRotation=e.Quaternion.IDENTITY().Clone(),this.rotateRadius=0,this.changeDisOnRotate=!0,this.freeViewMode=!0,this.controlLockXY=!1,this.oribitMode=!1,this.PriPointTwo1=e.Vector2.ZERO().Clone(),this.PriPointTwo2=e.Vector2.ZERO().Clone(),this.needInitRotOnFix=!0,this.rotTheta=.5,this.oldCameraPosOnOrigin=e.Vector3.ZERO().Clone(),this.birdEyeFixedPnt=e.Vector3.ZERO().Clone(),this.birdEyeSpeed=1,this.rotateOnFixedPointTimer=new e.Timer,this.rotateFixedAxis=e.Vector3.UP().Clone(),this.modelRotateOnFixedPointTimer=new e.Timer,this.modelRotateAngle=.5,this.modelRotateAxis=e.Vector3.UP().Clone(),this.circleCount=1,this.rotCirlceCount=0,this.isMatchCircleCount=!1,this.screenDepth=.001,this.sceneManager=null,this.pView=null,this.touchHandlerType=t.HANDLER_WALKTHROUGH}return n.prototype.SetView=function(e){this.pView=e,this.keepRotateTimer.SetTimer(this.TimerTask,this,36),this.Reset()},n.prototype.Reset=function(){this.sceneManager=this.pView.GetSceneManager(),this.trackBall.SetSceneManager(this.sceneManager)},n.prototype.HandleTouchEvent=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];if(e.length===3)this.HandleTouchEvent(e[0],e[1],e[2],0);else if(e.length===4){this.width=this.sceneManager.GetRenderManager().GetWindowWidth(),this.height=this.sceneManager.GetRenderManager().GetWindowHeight();var r=[];e[0][2]!=null&&e[0][3]!=null?(r[0]=e[0][4],r[1]=e[0][5]):r=e[0];if(this.HandleDragger(r,e[1],e[2],e[3]))return;this.selectedNodes=this.pView.GetWorkNodes();switch(e[2]){case n.TOUCHDOWN:this.TouchDown(e[0],e[1]);break;case n.TOUCHMOVE:this.TouchMove(e[3],e[0],e[1]);break;case n.TOUCHUP:this.TouchUp(e[0],e[1]);break;default:}}},n.prototype.HandleDragger=function(t,r,i,s){r=1,s=1;var o=new e.MotionEvent(t,r);o.SetView(this.pView);if(this.pView){switch(i){case n.TOUCHDOWN:o.setEventType(e.EventType.PUSH);break;case n.TOUCHMOVE:o.setEventType(e.EventType.DRAG);break;case n.TOUCHUP:o.setEventType(e.EventType.RELEASE);break;default:}this.pView.GetSceneManager().GetHandlerGroup().HandleDragger(o)}return o.getHandled()},n.prototype.RefreshModelViewCamera=function(){this.InitModelViewCamera()},n.prototype.Open=function(){this.InitCamera()},n.prototype.Close=function(){},n.prototype.GetTouchHandlerType=function(){return this.touchHandlerType},n.prototype.GetDefaultView=function(){return this.defaultView},n.prototype.SetDefaultView=function(e){this.defaultView=e},n.prototype.OnUpDataTouchIntent=function(){},n.prototype.UpdateCamera=function(){},n.prototype.InitCamera=function(){if(this.sceneManager!=null){var t=this.sceneManager.GetCamera(),n=this.sceneManager.GetSceneBox();if(this.GetRestoreCamera()){t.ReSet();var r=n.Length(),i=n.Center();this.oribitControlTarget=i.Clone(),i.z+=n.Length()*e.CAMERA_POSFACTOR,t.SetWorldPosition(i),r=this.sceneManager.GetDefaultFocusLength(),t.SetNearClip(r*e.NEAR_CLIP_PLANE_FACTOR),t.SetFarClip(r*e.FAR_CLIP_PLANE_FACTOR),t.LookAt(n.Center(),new e.Vector3(0,1,0),e.SceneNode.TS_WORLD),this.trackBall.SetRotateSpeed(2)}else{var s=n.Length(),o=t.GetRotateCenter().Clone(),u=t.GetWorldPosition().Clone(),a=u.Sub(o).Normalized();t.SetWorldPosition(o.Add(a.Multiply(n.Length()).Multiply(e.CAMERA_POSFACTOR))),s=this.sceneManager.GetDefaultFocusLength(),t.SetNearClip(s*e.NEAR_CLIP_PLANE_FACTOR),t.SetFarClip(s*e.FAR_CLIP_PLANE_FACTOR)}var f=t.GetViewPort(),l=f.rect.Height(),c=f.rect.Width();this.sceneManager.GetRenderManager().WindowSizeChanged(c,l),t.SetZoom(this.sceneManager.GetDefaultZoom()),t.SetInitRotateCenter(n.Center());var h=t.GetViewPort().rect,p=h.Width()>h.Height()?h.Height():h.Width();this.trackBall.SetTrackWindow(p,p)}},n.prototype.InitModelViewCamera=function(){},n.prototype.OptimizeCamera=function(){},n.prototype.OnTouchUp=function(e,t){},n.prototype.OnTouchMove=function(e,t,n){},n.prototype.OnTouchDown=function(e,t){},n.prototype.TouchUp=function(e,t){this.OnTouchUp(e,t)},n.prototype.TouchMove=function(e,t,n){this.OnTouchMove(e,t,n)},n.prototype.TouchDown=function(e,t){this.OnTouchDown(e,t)},n.prototype.UpDataTouchIntent=function(){this.UpDataTouchIntentWithSpeedControl(1)},n.prototype.UpDataTouchIntentWithSpeedControl=function(t){this.OnUpDataTouchIntent(),this.sceneManager.ShowRotationCenter(e.Trackball.ISROTATING),this.sceneManager.GetRenderManager().UseLowQuality(e.Trackball.ISROTATING||e.Trackball.MOVESTATE!==-1)},n.prototype.StateChanged=function(){return Math.abs(this.trackBall.mvMatrix.rotation.LengthSquared())<.01&&this.trackBall.mvMatrix.moveVector.Length()<.02&&Math.abs(this.trackBall.mvMatrix.scaleFactor-1)<.05?!1:!0},n.prototype.UpdateRenderQuality=function(e){},n.prototype.RotateOnFixedPoint=function(){if(!this.sceneManager)return;var t=this.sceneManager,n=t.GetCamera(),r=e.Vector3.LEFT().Clone();if(this.needInitRotOnFix){var i=n.GetWorldPosition();this.birdEyeFixedPnt=t.GetSceneBox().Center(),this.oldCameraPosOnOrigin=i.Sub(this.birdEyeFixedPnt),this.rotateRadius=this.oldCameraPosOnOrigin.Length(),this.needInitRotOnFix=!1}var s=new e.Quaternion(this.rotTheta,r);s.Normalize();var o=new e.Quaternion(0,this.oldCameraPosOnOrigin.x,this.oldCameraPosOnOrigin.y,this.oldCameraPosOnOrigin.z),u=s.Multiply(o).Multiply(s.Inverse()),a=new e.Vector3(u.x,u.y,u.z);n.SetWorldPosition(a.Add(this.birdEyeFixedPnt)),n.LookAt(this.birdEyeFixedPnt,r,e.SceneNode.TS_WORLD),this.rotTheta=this.rotTheta+this.birdEyeSpeed;if(this.rotTheta-360>-1e-7&&this.rotTheta-360<1e-8||this.rotTheta>360)this.rotTheta=this.rotTheta-360},n.prototype.GetRotateOnFixedPointFunc=function(e){var t=e;return t.RotateOnFixedPoint(),null},n.prototype.StartRotateOnFixedPoint=function(){this.rotateOnFixedPointTimer.IsStart()&&(this.rotateOnFixedPointTimer.StopTimer(),this.needInitRotOnFix=!0,this.rotTheta=0),this.needInitRotOnFix=!0,this.rotTheta=0,this.rotateOnFixedPointTimer.StartTimer(),this.rotateOnFixedPointTimer.SetTimer(this.GetRotateOnFixedPointFunc,this,36)},n.prototype.EndRotateOnFixedPoint=function(){this.rotateOnFixedPointTimer.IsStart()&&this.rotateOnFixedPointTimer.StopTimer(),this.needInitRotOnFix=!0,this.rotTheta=0},n.prototype.StartKeepState=function(){this.keepRotateTimer.IsStart()||this.keepRotateTimer.StartTimer()},n.prototype.CloseKeepState=function(){this.keepRotateTimer.IsStart()&&this.EndKeepState()},n.prototype.EndKeepState=function(){this.keepRotateTimer.IsStart()&&this.keepRotateTimer.StopTimer()},n.prototype.KeepState=function(){this.StateChanged()&&this.UpDataTouchIntentWithSpeedControl(.3)},n.prototype.TimerTask=function(e){var t=e;return t.KeepState(),null},n.prototype.SetUpDirection=function(t,n){e.LOGI(" TouchHandler::SetUpDirection"),this.upDirection=t;var r=this.sceneManager,i=r.GetSceneRoot().Search(e.MAINMODELROOT);if(!i)return;var s=new e.Quaternion(e.Vector3.UP().Clone(),this.upDirection),o=r.GetSceneBox(),u=o.Center(),a=e.Matrix3x4.IDENTITY().Clone(),f=e.Matrix3x4.IDENTITY().Clone(),l=e.Matrix3x4.IDENTITY().Clone();a.MultiTranslate(u.Multiply(-1)),l.MultiRotatiton(s),f.MultiTranslate(u);var c=f.Multiply(l).Multiply(a),h=c;i.SetPlcMatrix(h),this.setUpPlcMat=h,o.Clear()},n.prototype.StartModelRotateOnFixedPoint=function(){this.modelRotateOnFixedPointTimer.IsStart()&&this.modelRotateOnFixedPointTimer.StopTimer(),this.modelRotateOnFixedPointTimer.StartTimer(),this.modelRotateOnFixedPointTimer.SetTimer(this.GetModelRotateOnFixedPointFunc,this,36)},n.prototype.EndModelRotateOnFixedPoint=function(){this.modelRotateOnFixedPointTimer.IsStart()&&this.modelRotateOnFixedPointTimer.StopTimer()},n.prototype.ModelRotateOnFixedPoint=function(){var t=this.sceneManager,n=t.GetSceneRoot().Search(e.MAINMODELROOT);if(!n)return;var r=this.sceneManager.GetCamera().GetView().ToMatrix3().Data();this.modelRotateAxis=new e.Vector3(r[3],r[4],r[5]),this.modelRotateAxis.Normalize();var i=new e.Quaternion(this.modelRotateAngle,this.modelRotateAxis),s=t.GetSceneBox(),o=s.Center(),u=new e.Matrix3x4,a=new e.Matrix3x4,f=new e.Matrix3x4;u.MultiTranslate(o.Multiply(-1)),f.MultiRotatiton(i),a.MultiTranslate(o);var l=a.Multiply(f).Multiply(u),c=l;n.SetPlcMatrix(c),this.modelRotateAngle=this.modelRotateAngle+this.birdEyeSpeed;if(this.modelRotateAngle-360>-1e-7&&this.modelRotateAngle-360<1e-8||this.modelRotateAngle>360)this.modelRotateAngle=this.modelRotateAngle-360,this.rotCirlceCount++,this.rotCirlceCount===this.circleCount?(this.isMatchCircleCount=!0,this.rotCirlceCount=0):this.isMatchCircleCount=!1},n.prototype.OnlyRotate=function(t){var n=t;n.sceneManager.GetCamera().RotateAroundCenter(new e.Quaternion(1,0,Math.sin(-0.02*n.birdEyeSpeed/2),0),e.SceneNode.TS_WORLD)},n.prototype.GetModelRotateOnFixedPointFunc=function(t){var n=t;return n.sceneManager.GetCamera().RotateAroundCenter(new e.Quaternion(1,0,Math.sin(-0.02*n.birdEyeSpeed/2),0),e.SceneNode.TS_WORLD),n.modelRotateAngle+=.02*n.birdEyeSpeed,n.modelRotateAngle>=2*Math.PI&&(n.modelRotateAngle=0,n.rotCirlceCount++,n.rotCirlceCount===99999&&(n.rotCirlceCount=0)),null},n.prototype.SetModelRotateAxis=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t[0]instanceof e.Vector3)this.modelRotateAxis=t[0].Clone();else if(typeof t[0]=="number")switch(t[0]){case 0:this.modelRotateAxis=e.Vector3.LEFT().Clone();break;case 1:this.modelRotateAxis=e.Vector3.UP().Clone();break;case 2:this.modelRotateAxis=e.Vector3.BACK().Clone()}},n.prototype.SetModelRotateSpeed=function(e){this.birdEyeSpeed=e},n.prototype.SetNeedCircle=function(e){this.circleCount=e},n.prototype.ResetRotCircleCount=function(){this.rotCirlceCount=0,this.isMatchCircleCount=!1},n.prototype.IsMatchCircleCount=function(){return this.isMatchCircleCount},n.prototype.GetCircleNumber=function(){return this.rotCirlceCount},n.prototype.TwoFingersRotate=function(t,n){if(t.length<4)return;var r=new e.Vector2(t[0],t[1]),i=new e.Vector2(t[2],t[3]),s=this.PriPointTwo1.Sub(this.PriPointTwo2),o=r.Sub(i),u=s.Length(),a=o.Length();if(u+a<5)return;var f=this.PriPointTwo1.Add(this.PriPointTwo2).Multiply(.5),l=s.DotProduct(o)/(u*a);l>1&&(l=1);var c=Math.acos(l);s.Normalized(),o.Normalized();var h=new e.Vector2(o.y,-o.x),p=s.DotProduct(h);p<=0&&(c=-c);var d=this.sceneManager.GetCamera(),v=d.GetRotateCenter().Clone(),m=d.GetViewPort(),g=m.ScreenToWorldPoint(f.x,f.y,.5);d.SetRotateCenter(g),d.RotateAroundCenter(new e.Quaternion(1,0,0,Math.sin(c*.5)),e.SceneNode.TS_WORLD),d.SetRotateCenter(v)},n.prototype.SetFirstPersionParameter=function(e){this.firstPersionSpeed=e},n.prototype.ResetViewCamera=function(){},n.prototype.SetRestoreCamera=function(e){this.m_restoreCamera=e},n.prototype.GetRestoreCamera=function(){return this.m_restoreCamera},n.TOUCHUP=0,n.TOUCHDOWN=1,n.TOUCHMOVE=2,n}();e.TouchHandler=n})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.TRANSLATE=0]="TRANSLATE",e[e.ROTATE=1]="ROTATE",e[e.SCALE=2]="SCALE"})(t=e.OPEMODE||(e.OPEMODE={}));var n;(function(e){e[e.AXIS_X=0]="AXIS_X",e[e.AXIS_Y=1]="AXIS_Y",e[e.AXIS_Z=2]="AXIS_Z",e[e.AXIS_FACE=3]="AXIS_FACE"})(n=e.TRANSAXIS||(e.TRANSAXIS={}));var r=function(r){function i(){var i=r.call(this)||this;return i.mode=t.TRANSLATE,i.axis=n.AXIS_FACE,i.priPointTwo1=new e.Vector2,i.touchHandlerType=e.TouchHandlerType.HANDLER_DRAGGER,i}return __extends(i,r),i.prototype.SetMode=function(e){this.mode=e},i.prototype.SetAxis=function(e){this.axis=e},i.prototype.InitCamera=function(){r.prototype.InitCamera.call(this),this.GetRestoreCamera()&&this.pView&&e.PerspectiveOperator.GetInstance().Show(this.pView,this.GetDefaultView(),!0,!1,!1)},i.prototype.InitModelViewCamera=function(){if(this.sceneManager){var t=this.sceneManager.GetCamera();t.ReSet(),t.SetOrthographic(!1);var n=this.sceneManager.GetSceneBox(),r=t.GetViewPort(),i=r.rect.Height(),s=r.rect.Width();this.sceneManager.GetRenderManager().WindowSizeChanged(s,i);var o=n.Length(),u=n.Center();u.z+=n.Length()*8.5,t.SetWorldPosition(u),t.SetNearClip(o*.1),t.SetFarClip(o*15.5);var a=1.8;a=a*i/s,i>s&&(a=a*.5*(s*1/i)),t.SetZoom(a),t.SetInitRotateCenter(n.Center()),t.LookAt(n.Center(),new e.Vector3(0,1,0),e.SceneNode.TS_WORLD),this.pView&&e.PerspectiveOperator.GetInstance().Show(this.pView,this.GetDefaultView(),!0,!1,!1)}},i.prototype.OptimizeCamera=function(){},i.prototype.OnTouchUp=function(t,n){if(e.Parameters.Instance().IsConRotate)if(1===n)if(this.trackBall.angle>3){var r=this.trackBall.angle;r>0?r=Math.min(r,15):r=Math.max(r,-15),Math.abs(this.trackBall.angle)>14&&this.trackBall.mvMatrix.rotation.FromAngleAxis(r,this.trackBall.axis),this.StartKeepState()}else this.EndKeepState();else 2===n?this.trackBall.TwoPointsUp(t,n):3===n;else 1===n?(this.EndKeepState(),this.trackBall.OnePointUp(t,n)):2===n?this.trackBall.TwoPointsUp(t,n):3===n,this.trackBall.Reset();this.UpdateRenderQuality(!1),this.UpDataTouchIntent()},i.prototype.OnTouchMove=function(r,i,s){if(1==s){if(r==1){var o=this.GetSelectModel();if(o)switch(this.mode){case t.ROTATE:this.trackBall.OnePointRotate(i,s);break;case t.TRANSLATE:this.trackBall.OnePointsMove(i,s);break;case t.SCALE:this.trackBall.OnePointsScale(i,s)}else this.trackBall.OnePointRotate(i,s)}}else 2==s?(this.trackBall.TwoPointsMove(i,s),this.GetSelectModel()||(this.TwoFingersRotate(i,s),this.PriPointTwo1.x=i[0],this.PriPointTwo1.y=i[1],this.PriPointTwo2.x=i[2],this.PriPointTwo2.y=i[3])):3==s;if(this.StateChanged()){var o=this.GetSelectModel();if(!o)this.UpDataTouchIntent();else switch(this.mode){case t.ROTATE:var u=this.trackBall.mvMatrix.rotation.Clone(),a=this.sceneManager.GetCamera(),f=a.GetView().ToMatrix3(),l=new e.Quaternion(f);l.Normalize(),u=l.Inverse().Multiply(u).Multiply(l);if(this.axis===n.AXIS_FACE)e.ModelTransformHelper.RotateModel(o,u);else if(this.axis===n.AXIS_Z){var c=new e.Quaternion(u.w,0,0,u.z);c.Normalize(),e.ModelTransformHelper.RotateModel(o,c)}else if(this.axis===n.AXIS_Y){var h=new e.Quaternion(u.w,0,u.y,0);h.Normalize(),e.ModelTransformHelper.RotateModel(o,h)}else if(this.axis===n.AXIS_X){var p=new e.Quaternion(u.w,u.x,0,0);p.Normalize(),e.ModelTransformHelper.RotateModel(o,p)}break;case t.TRANSLATE:var d=this.trackBall.mvMatrix.moveVector.Clone(),a=this.sceneManager.GetCamera(),f=a.GetView().ToMatrix3().Inverse();d=f.Multiply(d);if(this.axis===n.AXIS_X){var v=new e.Vector3(d.x,0,0);e.ModelTransformHelper.TranslateModel(o,v)}else if(this.axis===n.AXIS_Y){var m=new e.Vector3(0,d.y,0);e.ModelTransformHelper.TranslateModel(o,m)}else if(this.axis===n.AXIS_Z){var g=new e.Vector3(0,0,d.z);e.ModelTransformHelper.TranslateModel(o,g)}else if(this.axis===n.AXIS_FACE){var y=new e.Vector3,b=new e.Vector3,w=this.sceneManager.GetCamera(),E=w.GetViewPort();y=E.ScreenToWorldPoint(this.priPointTwo1.x,this.priPointTwo1.y,.5),b=E.ScreenToWorldPoint(i[0],i[1],.5);var S=new e.Vector3(b.Sub(y)),x=S;e.ModelTransformHelper.TranslateModel(o,x)}break;case t.SCALE:var T=1/this.trackBall.mvMatrix.scaleFactor;if(this.axis===n.AXIS_X){var v=new e.Vector3(T,1,1);e.ModelTransformHelper.ScaleModel(o,v)}else if(this.axis===n.AXIS_Y){var m=new e.Vector3(1,T,1);e.ModelTransformHelper.ScaleModel(o,m)}else if(this.axis===n.AXIS_Z){var g=new e.Vector3(1,1,T);e.ModelTransformHelper.ScaleModel(o,g)}else if(this.axis===n.AXIS_FACE){var N=new e.Vector3(T,T,T);e.ModelTransformHelper.ScaleModel(o,N)}}}this.priPointTwo1.x=i[0],this.priPointTwo1.y=i[1],this.UpdateRenderQuality(!0)},i.prototype.OnTouchDown=function(e,t){this.trackBall.Reset(),this.priPointTwo1.x=e[0],this.priPointTwo1.y=e[1],1==t?this.trackBall.OnePointStart(e,t):2==t?(this.GetSelectModel()||(this.PriPointTwo1.x=e[0],this.PriPointTwo1.y=e[1],this.PriPointTwo2.x=e[2],this.PriPointTwo2.y=e[3]),this.trackBall.TwoPointsStart(e,t)):3==t},i.prototype.OnUpDataTouchIntent=function(){var t=this.trackBall.mvMatrix.rotation.Inverse(),n=this.sceneManager.GetCamera();n.RotateAroundCenter(t,e.SceneNode.TS_WORLD),n.Translate(this.trackBall.mvMatrix.moveVector.Multiply(-1),e.SceneNode.TS_LOCAL),n.ZoomView(1/this.trackBall.mvMatrix.scaleFactor)},i.prototype.GetSelectModel=function(){var t=null,n=this.pView.GetSelector(),r=n.Get();return r&&r.GetType()===e.ShapeType.SHAPE_MODEL&&(t=r),t},i}(e.TouchHandler);e.DraggerHandler=r})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){}return t.drawLine=function(e,t){var n=t.getStart().x,r=t.getStart().y,i=t.getEnd().x,s=t.getEnd().y;e.lineWidth=t.getBlod();var o=Math.floor(t.getColor().r*255),u=Math.floor(t.getColor().g*255),a=Math.floor(t.getColor().b*255);e.strokeStyle="RGB("+o.toString()+","+u.toString()+","+a.toString()+")",e.beginPath(),e.moveTo(n,r),e.lineTo(i,s),e.stroke(),e.closePath()},t.drawRect=function(e,t){var n=Math.floor(t.getColor().r*255),r=Math.floor(t.getColor().g*255),i=Math.floor(t.getColor().b*255),s=t.getStart().x,o=t.getStart().y,u=t.getEnd().x,a=t.getEnd().y,f=t.getRadius().x,l=t.getRadius().y;e.fillStyle="RGB("+n.toString
()+","+r.toString()+","+i.toString()+")",e.fillRect(s,o,u-s,a-o)},t.drawTexts=function(e,t){var n=Math.floor(t.getColor().r*255),r=Math.floor(t.getColor().g*255),i=Math.floor(t.getColor().b*255),s=t.getStart().x,o=t.getStart().y;e.fillStyle="RGB("+n.toString()+","+r.toString()+","+i.toString()+")",e.font="Bold 40pt "+t.getFontName(),e.fillText(t.getTexts(),s,o)},t.drawFillCircle=function(e,t){var n=Math.floor(t.getColor().r*255),r=Math.floor(t.getColor().g*255),i=Math.floor(t.getColor().b*255),s=t.getStart().x,o=t.getStart().y,u=t.getEnd().x,a=t.getEnd().y;e.fillStyle="RGB("+n.toString()+","+r.toString()+","+i.toString()+")",e.beginPath(),e.arc((s+u)/2,(o+a)/2,(u-s)/2,0,Math.PI*2),e.fill(),e.closePath()},t.drawStrokeCircle=function(e,t){var n=Math.floor(t.getColor().r*255),r=Math.floor(t.getColor().g*255),i=Math.floor(t.getColor().b*255),s=t.getStart().x,o=t.getStart().y,u=t.getEnd().x,a=t.getEnd().y;e.lineWidth=t.getWidth(),e.strokeStyle="RGB("+n.toString()+","+r.toString()+","+i.toString()+")",e.beginPath(),e.arc((s+u)/2,(o+a)/2,(u-s)/2,0,Math.PI*2),e.stroke(),e.closePath()},t.externsRect=function(e,t){if(t===null)return;e.getStart().x>t.x&&(e.getStart().x=t.x),e.getStart().y>t.y&&(e.getStart().y=t.y),e.getEnd().x<t.x&&(e.getEnd().x=t.x),e.getEnd().y<t.y&&(e.getEnd().y=t.y)},t.getRectF=function(n){var r=new e.Rect2D,i=n.getShapes();for(var s=0;s<i.length;s++){var o=i[s];if(o instanceof e.Line2D){var u=o;t.externsRect(r,u.getStart()),t.externsRect(r,u.getEnd())}}for(var a=0;a<i.length;a++){var o=i[a];if(o instanceof e.Rect2D){var f=o;t.externsRect(r,f.getStart()),t.externsRect(r,f.getEnd())}}for(var l=0;l<i.length;l++){var o=i[l];if(o instanceof e.Ellipse2D){var c=o;t.externsRect(r,c.getStart()),t.externsRect(r,c.getEnd())}}return r.getStart().x=r.getStart().x,r.getStart().y=r.getStart().y,r.getEnd().x=r.getEnd().x,r.getEnd().y=r.getEnd().y,r},t.drawShapes=function(n,r){var i=r.getShapes();for(var s=0;s<i.length;s++){var o=i[s];if(o instanceof e.Ellipse2D){var u=o;u.GetIsFill()&&t.drawFillCircle(n,u)}}for(var s=0;s<i.length;s++){var o=i[s];if(o instanceof e.Ellipse2D){var u=o;u.GetIsFill()||t.drawStrokeCircle(n,u)}}for(var s=0;s<i.length;s++){var o=i[s];o instanceof e.Rect2D&&t.drawRect(n,o)}for(var s=0;s<i.length;s++){var o=i[s];o instanceof e.Line2D&&t.drawLine(n,o)}for(var s=0;s<i.length;s++){var o=i[s];o instanceof e.Texts2D&&t.drawTexts(n,o)}},t.createImageBase64=function(e){},t.createImage=function(e,n){var r=!0,i=t.getRectF(e),s=document.createElement("canvas");s.width=i.getWidth()+1,s.height=i.getHeigh()+1,document.body.appendChild(s);var o=s.getContext("2d");t.drawShapes(o,e);if(typeof s.toBlob=="function")s.toBlob(function(e){n(e)});else{var u=s.toDataURL();n(u)}document.body.removeChild(s)},t}();e.DrawingUtility=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){this.color=e.Color.RED().Clone()}return t.prototype.setColor=function(e){this.color=e.Clone()},t.prototype.getColor=function(){return this.color},t}();e.Shape2D=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t!==null&&t.apply(this,arguments)||this;return n.start=new e.Vector2,n.end=new e.Vector2,n.isFill=!0,n.strokeWidth=2,n}return __extends(n,t),n.prototype.getStart=function(){return this.start},n.prototype.setStart=function(e){this.start=e},n.prototype.getEnd=function(){return this.end},n.prototype.setEnd=function(e){this.end=e},n.prototype.toString=function(){return null},n.prototype.getWidth=function(){return Math.abs(this.getEnd().x-this.getStart().x)},n.prototype.getHeigh=function(){return Math.abs(this.getEnd().y-this.getStart().y)},n.prototype.GetIsFill=function(){return this.isFill},n.prototype.setIsFill=function(e){this.isFill=e},n.prototype.getStrokeWidth=function(){return this.strokeWidth},n.prototype.setStrokeWidth=function(e){this.strokeWidth=e},n}(e.Shape2D);e.Ellipse2D=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t!==null&&t.apply(this,arguments)||this;return n.start=new e.Vector2,n.end=new e.Vector2,n.lineType=1,n.blod=1,n}return __extends(n,t),n.prototype.getStart=function(){return this.start},n.prototype.setStart=function(e){this.start=e},n.prototype.getEnd=function(){return this.end},n.prototype.setEnd=function(e){this.end=e},n.prototype.getLineType=function(){return this.lineType},n.prototype.setLineType=function(e){this.lineType=e},n.prototype.getBlod=function(){return this.blod},n.prototype.setBlod=function(e){this.blod=e},n.prototype.toString=function(){return null},n}(e.Shape2D);e.Line2D=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t!==null&&t.apply(this,arguments)||this;return n.start=new e.Vector2,n.end=new e.Vector2,n.style=-1,n.radius=new e.Vector2,n.stroke=!1,n.round=!1,n.strokeWidth=2,n}return __extends(n,t),n.prototype.getStart=function(){return this.start},n.prototype.setStart=function(e){this.start=e},n.prototype.getEnd=function(){return this.end},n.prototype.setEnd=function(e){this.end=e},n.prototype.getStyle=function(){return this.style},n.prototype.setStyle=function(e){this.style=e},n.prototype.getWidth=function(){return Math.abs(this.getEnd().x-this.getStart().x)},n.prototype.getHeigh=function(){return Math.abs(this.getEnd().y-this.getStart().y)},n.prototype.getRadius=function(){return this.radius},n.prototype.setRadius=function(e){this.radius=e},n.prototype.isStroke=function(){return this.stroke},n.prototype.setStroke=function(e){this.stroke=e},n.prototype.isRound=function(){return this.round},n.prototype.setRound=function(e){this.round=e},n.prototype.getStrokeWidth=function(){return this.strokeWidth},n.prototype.setStrokeWidth=function(e){this.strokeWidth=e},n}(e.Shape2D);e.Rect2D=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){this.shape2ds=[]}return e.prototype.addShape=function(e){var t=!1;return e!==null&&this.shape2ds.indexOf(e)===-1&&(this.shape2ds.push(e),t=!0),t},e.prototype.getShapes=function(){return this.shape2ds},e.prototype.setShapes=function(e){this.shape2ds=e},e}();e.Shape2DSet=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t!==null&&t.apply(this,arguments)||this;return n.start=new e.Vector2,n.texts="",n.fontName="微软雅黑",n.size=15,n.alignCenter=!1,n}return __extends(n,t),n.prototype.getStart=function(){return this.start},n.prototype.setStart=function(e){this.start=e},n.prototype.getTexts=function(){return this.texts},n.prototype.setTexts=function(e){this.texts=e},n.prototype.getFontName=function(){return this.fontName},n.prototype.setFontName=function(e){this.fontName=e},n.prototype.getSize=function(){return this.size},n.prototype.setSize=function(e){this.size=e},n.prototype.toString=function(){return null},n.prototype.isAlignCenter=function(){return this.alignCenter},n.prototype.setAlignCenter=function(e){this.alignCenter=e},n}(e.Shape2D);e.Texts2D=t})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.Geometry=0]="Geometry",e[e.lines=1]="lines",e[e.triangle2D=2]="triangle2D"})(t=e.TextShapeTypeEnum||(e.TextShapeTypeEnum={}));var n=function(n){function r(){var r=[];for(var i=0;i<arguments.length;i++)r[i]=arguments[i];var s=n.call(this)||this;return s.CTextList=[],s.posFloats=[],s.m_VertexSet=new e.VertexSet,s.m_Meshdata=new e.Mesh(s.m_VertexSet),s.isDirty=!0,s.textType=t.triangle2D,s.textMeshFillStateArray=[],s.Visible=!1,s}return __extends(r,n),r.prototype.AddCText=function(e){this.CTextList.push(e),this.textMeshFillStateArray.push(!1)},r.prototype.GetCText=function(e){return this.CTextList[e]},r.prototype.GetCTextList=function(){return this.CTextList},r.prototype.GetTextType=function(){return this.textType},r.prototype.SetTextType=function(e){this.textType=e},r.prototype.GetMesh=function(){return this.m_Meshdata},r.prototype.ComputeBox=function(){this.GetMesh()&&this.SetBox(this.GetMesh().GetBoundingBox())},r.prototype.clearMesh=function(){this.m_VertexSet=new e.VertexSet,this.m_Meshdata=new e.Mesh(this.m_VertexSet),this.posFloats=[];for(var t=0;t<this.textMeshFillStateArray.length;t++)this.textMeshFillStateArray[t]=!1},r.prototype.beginUpdateMesh=function(){this.Visible=!1},r.prototype.endUpdateMesh=function(){var e=!0;for(var t=0;t<this.textMeshFillStateArray.length;t++)if(!this.textMeshFillStateArray[t]){e=!1;break}e&&(this.m_VertexSet.SetPositionArray(new Float32Array(this.posFloats)),this.m_VertexSet.SetUseIndex(!1),this.m_Meshdata.SetDataLength(this.posFloats.length),this.m_Meshdata.SetDataOffset(0),this.Visible=!0)},r.prototype.setTextMeshById=function(t,n){this.beginUpdateMesh();if(n.vertexs!=undefined){var r=this.CTextList[t],i=void 0,s=void 0,o=void 0,u=void 0;s=r.GetCharWidthHeight()[0],i=r.GetCharWidthHeight()[1],u=s/1,o=i/1;var a=r.GetInnerLoc(),f=void 0,l=void 0;f=r.GetInnerXYAxis()[0],l=r.GetInnerXYAxis()[1];var c=new e.Vector3(0,0,1),h=new e.Quaternion(new e.Vector3(1,0,0),f),p=new e.Matrix3x4(a,h,new e.Vector3(o,o,1));if(n.indexes!=null){var d=n.indexes,v=n.vertexs;for(var m=0;m<d.length;m++){var g=new e.Vector3(v[d[m]*3],v[d[m]*3+1],v[d[m]*3+2]),y=p.Multiply(g);this.posFloats.push(y.x),this.posFloats.push(y.y),this.posFloats.push(y.z)}}else{var y=void 0,v=n.vertexs;for(var m=0;m<v.length/3;++m){var g=new e.Vector3(v[m*3],v[m*3+1],v[m*3+2]);y=p.Multiply(g),this.posFloats.push(y.x),this.posFloats.push(y.y),this.posFloats.push(y.z)}}}this.textMeshFillStateArray[t]=!0,this.endUpdateMesh()},r.option={useLocalFont:!1,pmiServer:"http://localhost:8070/"},r}(e.Shape);e.ComText=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){this.Text="",this.pntInnerLoc=new e.Vector3,this.fCharSize=[5,5],this.dirAxis=[new e.Vector3,new e.Vector3]}return t.prototype.GetInnerLoc=function(){return this.pntInnerLoc},t.prototype.SetInnerLoc=function(e){this.pntInnerLoc=e},t.prototype.GetText=function(){return this.Text},t.prototype.SetText=function(e){this.Text=e},t.prototype.GetInnerXYAxis=function(){return this.dirAxis},t.prototype.SetInnerXYAxis=function(e,t){this.dirAxis[0]=e.Clone(),this.dirAxis[1]=t.Clone()},t.prototype.GetCharWidthHeight=function(){return this.fCharSize},t.prototype.SetCharWidthHeight=function(e,t){this.fCharSize[0]=e,this.fCharSize[1]=t},t}();e.CText=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n.m_geoAttribute=null,n.SetType(e.ShapeType.CURVE_UNKNOWN),n}return __extends(n,t),n.prototype.GetGeoAttribute=function(){return this.m_geoAttribute},n.prototype.SetGeoAttribute=function(e){this.m_geoAttribute=e},n}(e.Shape);e.Curve=t;var n=function(e){function t(){return e.call(this)||this}return __extends(t,e),t}(t);e.IPolyLine=n;var r=function(t){function n(){var e=t.call(this)||this;return e.m_fUMin=0,e.m_fUMax=0,e.m_pntPoints=[],e}return __extends(n,t),n.prototype.GetType=function(){return e.ShapeType.CURVE_POLYLINE},n.prototype.AddPoint=function(e){this.m_pntPoints.push(e)},n.prototype.SetPoints=function(e){this.m_pntPoints=e},n.prototype.SetDomain=function(e,t){this.m_fUMin=e,this.m_fUMax=t},n.prototype.GetDomain=function(){},n.prototype.GetPoints=function(){return this.m_pntPoints},n.prototype.RayPick=function(e){var t,n=this.GetPoints();for(var r=0;r<n.length-1;r++){var i=e.Intersect(n[r],n[r+1],t);i&&e.AddIntersectPnt(t)}},n}(n);e.SPolyLine=r;var i=function(t){function n(e){var n=t.call(this)||this;return n.m_refLine=e,n.m_dataOffset=0,n.m_dataLength=0,n}return __extends(n,t),n.prototype.GetType=function(){return e.ShapeType.CURVE_REF_POLYLINE},n.prototype.GetEndPnt=function(){var e;if(this.m_refLine){var t=this.GetRefLine().GetPoints();t.length>this.m_dataOffset+this.m_dataLength&&(e=t[this.m_dataOffset+this.m_dataLength])}},n.prototype.GetStartPnt=function(){var e;if(this.m_refLine){var t=this.GetRefLine().GetPoints();t.length>this.m_dataOffset&&(e=t[this.m_dataOffset])}return e},n.prototype.GetDataOffset=function(){return this.m_dataOffset},n.prototype.SetDataOffset=function(e){this.m_dataOffset=e},n.prototype.GetDataLength=function(){return this.m_dataLength},n.prototype.SetDataLength=function(e){this.m_dataLength=e},n.prototype.ComputeBox=function(){this.BoundingBox.Clear();var e=this.GetRefLine().GetPoints(),t,n=this.m_dataLength/2+1;for(var r=0;r<n-1;r++)this.BoundingBox.Merge(e[r*2]),this.BoundingBox.Merge(e[r*2+1])},n.prototype.RayPick=function(t){var n=this.GetRefLine().GetPoints(),r=new e.Vector3,i=this.m_dataLength/2+1;for(var s=0;s<i-1;s++)if(t.Intersect(n[s*2+this.m_dataOffset],n[s*2+1+this.m_dataOffset],r)){var o=new e.Vector3;o.copyFrom(r),t.AddIntersectPnt(o)}},n.prototype.GetRefLine=function(){return this.m_refLine},n}(n);e.RefPolyLine=i})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];var i=t.call(this)||this;return i.length=0,i.vertexPos=0,i.hardWareIndexBuffer=null,i.hardwareVertexBuffer=null,i.isNeedUpdateEdge=!0,n.length===0?(i.SetInitColor(e.Color.EdgeDefaultColor().Clone()),i.SetType(e.ShapeType.SHAPE_EDGE)):i.AssignOperator(n[0]),i.m_svlId=-1,i}return __extends(n,t),n.prototype.SetRenderWorldMatrix=function(e){this.renderWorldMatrix=e.Clone()},n.prototype.GetRenderWorldMatrix=function(){return this.renderWorldMatrix},n.prototype.GetRenderMaterial=function(){return new e.Material},n.prototype.SetRenderMesh=function(e){},n.prototype.GetDataLength=function(){return this.length},n.prototype.IsUseIndex=function(){return!1},n.prototype.SetIndexOffset=function(e){},n.prototype.GetIndexOffset=function(){return-1},n.prototype.SetNormalOffset=function(e){},n.prototype.GetNormalOffset=function(){return-1},n.prototype.SetVertexOffset=function(e){},n.prototype.GetVertexOffset=function(){return-1},n.prototype.SetTextureCoordsOffset=function(e){},n.prototype.GetTextureCoordsOffset=function(){return-1},n.prototype.SetCentersCoordsOffset=function(e){},n.prototype.GetCentersCoordsOffset=function(){return-1},n.prototype.GetHardWareVertexBuffer=function(){return this.hardwareVertexBuffer},n.prototype.GetHardWareIndexBuffer=function(){return this.hardWareIndexBuffer},n.prototype.UpdateHardWareBuffer=function(e){},n.prototype.AddData=function(e,t){switch(t){case 0:this.m_lineSet=e;break;default:}},n.prototype.ComputeBox=function(){this.BoundingBox.Clear(),this.m_lineSet&&this.SetBox(this.m_lineSet.GetBoundingBox())},n.prototype.GetLineData=function(){return this.m_lineSet},n.prototype.RayPick=function(t){if(!this.IsVisible()||!t.CanPickShape(this.GetType()))return;if(this.m_lineSet){var n=this.m_lineSet.GetGeoAttribute();if(n!=null){if(!t.CanPickGeo(n.GetGeoAttrType()))return}else if(!t.CanPickGeo(e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN))return;this.m_lineSet.RayPick(t),t.AddShape(this)}},n.prototype.GetGeoInfo=function(){var e,t=this.m_lineSet.GetGeoAttribute();return t!=null,e},n.prototype.GetSVLId=function(){return this.m_svlId},n.prototype.SetSVLId=function(e){this.m_svlId=e},n.prototype.GetGeoAttribute=function(){if(this.m_lineSet){var e=void 0;return this.GetSVLId()&&(this.GetBody()&&this.GetBody().GetModel()&&(e=this.GetBody().GetModel().GetExtendInfoManager().GetEdgeGeoAttribute(this.GetBody().GetModel().GetProtoTypeId(),this.GetSVLId())),this.m_lineSet.SetGeoAttribute(e)),e}return null},n.prototype.GetRenderColor=function(){return this.GetDrawColor()},n.prototype.InitProperties=function(){var e="ID",t="颜色";this.AddProperty(e,String(this.Id));var n=String(this.Color.r)+","+String(this.Color.g)+","+String(this.Color.b)+","+String(this.Color.a);this.AddProperty(t,n)},n.prototype.SetFace=function(e){this.face=e},n.prototype.GetFace=function(){return this.face},n.prototype.SetBody=function(e){this.body=e},n.prototype.GetBody=function(){return this.body},n.prototype.AssignOperator=function(n){this!==n&&(t.prototype.AssignOperator.call(this,n),this.SetColor(e.Color.EdgeDefaultColor().Clone()),this.m_lineSet=n.GetLineData(),this.m_svlId=n.m_svlId)},n.prototype.SetRenderPolyLine=function(e){var t=e.GetLineData(),n=t.GetRefLine(),r=t.GetDataOffset();this.vertexPos=r*3*4,this.length=t.GetDataLength()},n.prototype.MergeRenderPolyLine=function(e){var t=e.GetLineData();this.length+=t.GetDataLength()},n}(e.Shape);e.Edge=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];this.pmiMap=new e.Map,this.modelPmiRefs=new e.Map,this.userViewMap={},this.sectionPlaneMap={},this.allMeshEdgeAttr={},this.allMeshFaceAttr={},this.allModelFileAttr={},this.allInstanceAttr={}}return t.prototype.AddModelPMIRef=function(e,t){this.modelPmiRefs[e]=t},t.prototype.GetModelPMIRef=function(e){return this.modelPmiRefs[e]},t.prototype.SetPMIs=function(e){this.pmiMap=e},t.prototype.SetModelPMIRefs=function(e){this.modelPmiRefs=e},t.prototype.AddModelView=function(e,t){this.userViewMap[e]=t},t.prototype.GetModelView=function(e){return this.userViewMap[e]},t.prototype.AddModelSectionPlane=function(e,t){this.sectionPlaneMap[e]=t},t.prototype.GetModelSectionPlane=function(e){return this.sectionPlaneMap[e]},t.prototype.RayPick=function(e){for(var t=0,n=this.pmiMap.Keys();t<n.length;t++){var r=n[t],i=this.pmiMap.Get(r);i&&i.IsVisible()&&i.RayPick(e)}},t.prototype.FindVisiableObject=function(e){if(e!=undefined){var t=e.GetRenderEffect(),n=t.GetRenderableTypeFilter();e.PrepareRenderPMIS(this.pmiMap)}},t.prototype.Clear=function(e){delete this.pmiMap[e],delete this.userViewMap[e],delete this.sectionPlaneMap[e]},t.prototype.GetFaceGeoAttribute=function(t,n){if(n>0){var r=this.GetMeshFaceAllAttribute(t,n);if(Object.getOwnPropertyNames(r).length>0){var i=e.SvlxReader.GetGeometryAttributeFromStk(r);return i}return null}return null},t.prototype.GetModelFileAttribute=function(e){if(e>0){var t=this.allModelFileAttr[e];return t}return null},t.prototype.GetEdgeGeoAttribute=function(t,n){if(n>0){var r=this.GetMeshEdgeAllAttribute(t,n);if(Object.getOwnPropertyNames(r).length>0){var i=e.SvlxReader.GetGeometryAttributeFromStk(r);return i}return null}return null},t.prototype.GetMeshFaceAllAttribute=function(e,t){var n={};if(Object.getOwnPropertyNames(this.allMeshFaceAttr).length>0){var r=this.allMeshFaceAttr[e];if(!r)return n;var i=r[t];return i?i:n}return n},t.prototype.GetMeshEdgeAllAttribute=function(e,t){var n={};if(Object.getOwnPropertyNames(this.allMeshEdgeAttr).length>0){var r=this.allMeshEdgeAttr[e];if(!r)return n;var i=r[t];return i?i:n}return n},t.prototype.SetAllMeshFaceAttr=function(e){this.allMeshFaceAttr=e},t.prototype.SetAllMeshEdgeAttr=function(e){this.allMeshEdgeAttr=e},t.prototype.SetAllModelFileAttr=function(e){this.allModelFileAttr=e},t.prototype.GetInstanceAttr=function(e,t){t===void 0&&(t="");if(Object.getOwnPropertyNames(this.allInstanceAttr).length>0){var n=this.allInstanceAttr[e];if(n)return t==""?n:n[t]}return{}},t.prototype.SetAllInstanceAttr=function(e){this.allInstanceAttr=e},t}();e.ExtendInfoManager=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];t.length==3?(this._center=t[0].Clone(),this._radius=t[1],this._height=t[2]):(this._center=new e.Vector3(0,0,0),this._radius=1,this._height=1),this._rotation=new e.Quaternion}return t.prototype.ZeroRotation=function(){return this._rotation.IsZero()},t.prototype.ComputeRotationMatrix=function(){return this._rotation.RotationMatrix()},t.prototype.GetRotation=function(){return this._rotation},t.prototype.SetRotation=function(e){this._rotation=e.Clone()},t.prototype.GetHeight=function(){return this._height},t.prototype.SetHeight=function(e){this._height=e},t.prototype.GetRadius=function(){return this._radius},t.prototype.SetRadius=function(e){this._radius=e},t.prototype.GetCenter=function(){return this._center},t.prototype.SetCenter=function(e){this._center=e.Clone()},t.prototype.Set=function(e,t,n){this._center=e.Clone(),this._radius=t,this._height=n},t.prototype.Valid=function(){return this._radius>=0},t}();e.Cylinder=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];var i=t.call(this)||this;return i.StartPoint=new e.Vector3,i.EndPoint=new e.Vector3,i.lineWidth=4,i.StartArrowBufferArray=[],i.EndArrowBufferArray=[],n.length===0?i.InitLine3D():n.length===2&&n[0]instanceof e.Vector3&&n[1]instanceof e.Vector3&&(i.InitLine3D(),i.SetValue(n[0],n[1])),i}return __extends(n,t),n.prototype.InitLine3D=function(){this.StartArrowType=-1,this.EndArrowType=-1;var t=e.Color.GRAY().Clone();this.SetColor(t),this.lineWidth=4},n.prototype.SetValue=function(e,t){this.StartPoint=e.Clone(),this.EndPoint=t.Clone()},n.prototype.ComputeBox=function(){this.BoundingBox.Merge(this.StartPoint),this.BoundingBox.Merge(this.EndPoint)},n.prototype.GetStartArrow=function(){return this.StartArrowType},n.prototype.GetEndArrow=function(){return this.EndArrowType},n.prototype.SetStartArrow=function(e){this.StartArrowType=e,this.CreateArrowBuffer(this.StartArrowType,this.StartPoint,this.StartPoint.Sub(this.EndPoint),2,2,this.StartArrowBufferArray)},n.prototype.SetEndArrow=function(e){this.EndArrowType=e,this.CreateArrowBuffer(this.EndArrowType,this.EndPoint,this.EndPoint.Sub(this.StartPoint),2,2,this.EndArrowBufferArray)},n.prototype.CreateArrowBuffer=function(e,t,n,r,i,s){},n.prototype.GetStartArrowBuffer=function(){return this.StartArrowBufferArray},n.prototype.GetEndArrowBuffer=function(){return this.EndArrowBufferArray},n.prototype.SetLineWidth=function(e){this.lineWidth=e},n.prototype.GetLineWidth=function(){return this.lineWidth},n.prototype.GetPosition=function(){return this.StartPoint},n.prototype.GetEndPoint=function(){return this.EndPoint},n}(e.Shape);e.Line3D=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){this.m_worldBox=new e.BoundingBox,this.m_BoundingBox=new e.BoundingBox,this.m_drawDataPrepared=!0,this.m_SelectAble=!0,this.m_bodys=new Array,this.SetModel(null),this.SetOctant(null),this.SetOctree(null),this.SetOCTreeUpdated(!1),this.SetDrawDataPrepared(!0),this.MarkDirty()}return t.prototype.SetModel=function(e){this.m_parentModel=e},t.prototype.SetOctant=function(e){this.m_octant=e},t.prototype.GetOctant=function(){return this.m_octant},t.prototype.SetOctree=function(e){this.m_octree=e},t.prototype.GetOctree=function(){return this.m_octree},t.prototype.isOCtreeUpdated=function(){return this.m_updateQueued},t.prototype.SetOCTreeUpdated=function(e){this.m_updateQueued=e},t.prototype.IsDrawDataPrepared=function(){return this.m_drawDataPrepared},t.prototype.SetDrawDataPrepared=function(e){e&&this.MarkDirty(),this.m_drawDataPrepared=e},t.prototype.MarkDirty=function(){this.m_dirty=!0,this.m_worldBox.Clear()},t.prototype.SetBodys=function(e){this.m_bodys=e},t.prototype.GetBodys=function(){return this.m_bodys},t.prototype.GetColor=function(){return this.m_drawDataPrepared&&this.m_bodys.length>0?this.m_bodys[0].GetColor():null},t.prototype.SetColor=function(e){if(this.m_drawDataPrepared)for(var t=0;t<this.m_bodys.length;t++)this.m_bodys[t].SetColor(e)},t.prototype.ResetAlpha=function(){if(this.m_drawDataPrepared)for(var e=0;e<this.m_bodys.length;e++)this.m_bodys[e].ResetAlpha()},t.prototype.Restore=function(){if(this.m_drawDataPrepared){this.MarkDirty();for(var e=0;e<this.m_bodys.length;e++)this.m_bodys[e].Restore()}},t.prototype.GetVolumeAndArea=function(e,t){if(this.m_drawDataPrepared)for(var n=0;n<this.m_bodys.length;n++){var r=0,i=0;this.m_bodys[n].GetVolumeAndArea(r,i),e+=r,t+=i}return 0},t.prototype.ResetColor=function(){if(this.m_drawDataPrepared)for(var e=0;e<this.m_bodys.length;e++)this.m_bodys[e].ResetColor()},t.prototype.SetInitColor=function(e){if(this.m_drawDataPrepared)for(var t=0;t<this.m_bodys.length;t++)this.m_bodys[t].SetInitColor(e)},t.prototype.IsHightlight=function(){return!1},t.prototype.SetInitHightlight=function(e){if(this.m_drawDataPrepared)for(var t=0;t<this.m_bodys.length;t++)this.m_bodys[t].SetInitHightlight(e)},t.prototype.SetInitAlpha=function(e){if(this.m_drawDataPrepared)for(var t=0;t<this.m_bodys.length;t++)this.m_bodys[t].SetInitAlpha(e)},t.prototype.ComputeBox=function(){if(!this.IsDrawDataPrepared())return;this.m_BoundingBox.Clear();for(var e=0;e<this.m_bodys.length;e++){var t=this.m_bodys[e].GetFaces();for(var n=0;n<t.length;n++)this.m_BoundingBox.Merge(t[n].GetBoundingBox())}},t.prototype.GetVertexCount=function(e){if(this.m_drawDataPrepared){var t=0;for(var n=0;n<this.m_bodys.length;n++)t+=this.m_bodys[n].GetVertexCount(e);return t}return 0},t.prototype.SetVisible=function(e){if(this.m_drawDataPrepared)for(var t=0;t<this.m_bodys.length;t++)this.m_bodys[t].SetVisible(e)},t.prototype.IsVisible=function(){return this.m_parentModel?this.m_parentModel.IsVisible():!0},t.prototype.SetSelected=function(e){if(this.m_drawDataPrepared)for(var t=0;t<this.m_bodys.length;t++){var n=this.m_bodys[t];null!=n&&n.SetSelected(e)}},t.prototype.SetSelectAble=function(e){this.m_SelectAble=e;for(var t=0;t<this.m_bodys.length;t++)this.m_bodys[t]&&this.m_bodys[t].SetSelectAble(e)},t.prototype.SetAlpha=function(e){if(this.m_drawDataPrepared)for(var t=0;t<this.m_bodys.length;t++)this.m_bodys[t].SetAlpha(e)},t.prototype.AddBody=function(e){e!==null&&this.m_parentModel!==null&&(e.SetModel(this.m_parentModel),this.m_bodys.push(e))},t.prototype.GetType=function(){return e.ShapeType.MODEL_SHAPE},t.prototype.GetModel=function(){return this.m_parentModel},t.prototype.AssignOperator=function(t){if(this!==t){this.m_bodys=new Array,this.SetModel(null),this.SetOctant(null),this.SetOctree(null),this.SetOCTreeUpdated(!1),this.MarkDirty();for(var n=0;n<t.m_bodys.length;n++){var r=new e.Body(t.m_bodys[n]);this.AddBody(r)}}return this},t.prototype.CopyFrom=function(t){this.m_bodys=new Array,this.SetOCTreeUpdated(!1);for(var n=0;n<t.m_bodys.length;n++){var r=new e.Body(t.m_bodys[n]);this.AddBody(r)}return!0},t.prototype.FramePick=function(e){this.m_drawDataPrepared&&this.m_SelectAble&&e.FrustumIntersetWithWorldBox(this.GetWorldBoundingBox())&&e.AddToFramePickCollection(this.GetModel())},t.prototype.RayPick=function(t){if(this.m_drawDataPrepared&&this.m_SelectAble&&this.m_bodys.length>0&&t.GetData().GetCameraRay().HitDistance(this.GetWorldBoundingBox())!=e.INFINITY){t.UpdataModelRay(this.GetWorldTransform());for(var n=0;n<this.m_bodys.length;n++)this.m_bodys[n].RayPick(t)}},t.prototype.GetWorldBoundingBox=function(){return this.m_worldBox.Defined()||(this.m_worldBox=this.GetBoundingBox(),this.m_worldBox.Defined()&&this.m_worldBox.Transform(this.GetWorldTransform())),this.m_worldBox},t.prototype.SetBoundingBox=function(e){this.m_BoundingBox=e},t.prototype.GetBoundingBox=function(){return this.ComputeBox(),this.m_BoundingBox},t.prototype.FindVisiableObject=function(e){if(this.m_drawDataPrepared){var t=e.GetCullerHelper().InViewPort(this.GetWorldBoundingBox(),e.GetCamera());e.SetWorldMatrix(this.GetWorldTransform()),e.SetGLWorldMatrix(this.GetGLWorldTransform());for(var n=0;n<this.m_bodys.length;n++)this.m_bodys[n].FindVisiableObject(e)}},t.prototype.FindVisiableObjectFast=function(t,n){if(this.m_drawDataPrepared){var r=t.GetCullerHelper().InViewPort(this.GetWorldBoundingBox(),t.GetCamera());if(r!==e.OUTSIDE){t.SetWorldMatrix(this.GetWorldTransform()),t.SetGLWorldMatrix(this.GetGLWorldTransform());if(n===0){if(this.m_bodys)for(var i=0;i<this.m_bodys.length;i++)this.m_bodys[i].FindVisiableObject(t)}else if(n===1){t.SetDelayDraw(!0);if(this.m_bodys)for(var i=0;i<this.m_bodys.length;i++)this.m_bodys[i].FindVisiableObject(t);t.SetDelayDraw(!1)}}}},t.prototype.IsDirty=function(){return this.m_dirty},t.prototype.Clear=function(){if(this.m_drawDataPrepared){for(var e=0;e<this.m_bodys.length;e++);this.m_bodys=new Array}},t.prototype.GetWorldTransform=function(){return this.IsDirty()&&this.UpdateWorldTransform(),this.m_worldMatrix},t.prototype.GetGLWorldTransform=function(){return this.GetWorldTransform(),this.m_glRenderMatrix},t.prototype.UpdateWorldTransform=function(){this.m_dirty=!1;var t=new e.Matrix3x4;this.m_parentModel==null?this.m_worldMatrix=t:this.m_worldMatrix=this.m_parentModel.GetWorldTransform().Multiply(t).ToMatrix3x4(),this.m_glRenderMatrix=this.m_worldMatrix.ToMatrix4().Transpose(),this.UpdateOCTree()},t.prototype.SetWorldMatrix=function(e){this.m_worldMatrix=this.m_parentModel.GetWorldTransform().ToMatrix3x4().Multiply(e),this.m_glRenderMatrix=this.m_worldMatrix.ToMatrix4().Transpose(),this.m_worldBox.Clear(),this.UpdateOCTree()},t.prototype.UpdateOCTree=function(){this.SetOCTreeUpdated(!1),this.m_octree!==null&&this.m_octree.QueueUpdate(this)},t}();e.ModelShape=t;var n=function(t){function n(){var e=t.call(this)||this;return e.m_image=null,e.m_imageBoard=null,e}return __extends(n,t),n.prototype.FindVisiableObject=function(t){if(this.IsVisible()){t.SetWorldMatrix(this.GetWorldTransform()),t.SetGLWorldMatrix(this.GetGLWorldTransform());if(this.m_image&&this.m_imageBoard){if(!this.m_imageBoard.GetTexture()&&this.m_image){var n=t.GetScene().GetResourceManager().GetOrCreateTexture(this.m_image.GetImagePath(),e.Texture.TEXTURE_2D);n.AddImage(this.m_image),this.m_imageBoard.SetTexture(n)}this.m_imageBoard.UpdateRenderData(t),t.PrepareRenderImage(this.m_imageBoard)}}},n.prototype.RayPick=function(t){if(this.m_drawDataPrepared){var n=new e.Vector3;if(this.m_imageBoard){t.UpdataModelRay(e.Matrix3x4.IDENTITY().Clone());var r=this.m_imageBoard.GetIntersects(t);if(r.length>0)for(var i=0;i<r.length;i++)t.AddIntersectPnt(r[i])}t.AddShape(this.GetModel())}},n.prototype.FramePick=function(e){this.m_drawDataPrepared&&e.FrustumIntersetWithWorldBox(this.GetWorldBoundingBox())&&e.AddToFramePickCollection(this.GetModel())},n.prototype.SetImagePath=function(e){this.CreateImage(),this.m_image.SetImageFromURL(e)},n.prototype.SetImage=function(e){this.CreateImage(),this.m_image=e},n.prototype.SetImageData=function(e,t){this.CreateImage(),this.m_image.SetImageFromURL(e)},n.prototype.SetImageGPUID=function(t){this.CreateImage();if(!this.m_imageBoard.GetTexture()){var n=new e.Texture2DPackaging;this.m_imageBoard.SetTexture(n)}if(this.m_imageBoard.GetTexture()){var r=this.m_imageBoard.GetTexture();r.SetTexture2DID(t)}},n.prototype.SetFlipImage=function(e){this.CreateImage(),this.m_imageBoard.SetFlipV(e)},n.prototype.AllowCuller=function(){return!1},n.prototype.GetImageBoard=function(){return this.m_imageBoard},n.prototype.SetImageSize=function(e,t){this.m_imageBoard&&this.m_imageBoard.SetOrigSize(e,t)},n.prototype.SetImagePosition=function(e){this.m_imageBoard&&this.m_imageBoard.SetPosition(e)},n.prototype.SetAllowScall=function(e){this.m_imageBoard&&this.m_imageBoard.AllowScale(e)},n.prototype.SetAllowRotate=function(e){this.m_imageBoard&&this.m_imageBoard.AllowRotate(e)},n.prototype.SetAllowTran=function(e){this.m_imageBoard&&this.m_imageBoard.AllowTran(e)},n.prototype.SetInTopShow=function(e){this.m_imageBoard&&this.m_imageBoard.SetInTop(e)},n.prototype.ComputeBox=function(){t.prototype.ComputeBox.call(this);if(this.m_imageBoard){var e=this.m_imageBoard.GetVertexs();this.m_BoundingBox.Merge(this.m_imageBoard.GetBoundingBox())}},n.prototype.SetSelected=function(e){this.m_imageBoard&&this.m_imageBoard.SetSelected(e)},n.prototype.SetInitHightlight=function(e){this.m_imageBoard&&this.m_imageBoard.SetInitHightlight(e)},n.prototype.CreateImage=function(){this.m_image==null&&(this.m_image=new e.ImageM3D,this.m_imageBoard=new e.ImageBoard)},n}(t);e.ImageModelShape=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];var i=t.call(this)||this;return i.IsParallelScreen=!1,i.m_outramLocation=new e.Vector3,i.OutFrameMatrix=e.Matrix4.IDENTITY(),i.m_DefPlaneDirty=!0,i.m_GLDefPlaneMatrix=e.Matrix4.IDENTITY(),i.m_WorldMatrix=e.Matrix3x4.IDENTITY(),i.DefPlane=e.Matrix3x4.IDENTITY(),i.PolyLines=[],i.ComTexts=[],i.renderWorldMatrix=e.Matrix4.IDENTITY(),n.length=1,i}return __extends(n,t),n.prototype.SetRenderWorldMatrix=function(e){this.renderWorldMatrix=e},n.prototype.GetRenderWorldMatrix=function(){return this.renderWorldMatrix},n.prototype.GetRenderColor=function(){var e=this.GetDrawColor();return e},n.prototype.GetDrawColor=function(){var e=t.prototype.GetDrawColor.call(this).Clone();return e},n.prototype.GetRenderMaterial=function(){return null},n.prototype.SetRenderMesh=function(e){},n.prototype.GetRenderMesh=function(){return null},n.prototype.GetDataLength=function(){return-1},n.prototype.IsUseIndex=function(){return!1},n.prototype.SetIndexOffset=function(e){},n.prototype.GetIndexOffset=function(){return-1},n.prototype.SetNormalOffset=function(e){},n.prototype.GetNormalOffset=function(){return-1},n.prototype.SetVertexOffset=function(e){},n.prototype.GetVertexOffset=function(){return-1},n.prototype.SetTextureCoordsOffset=function(e){},n.prototype.GetTextureCoordsOffset=function(){return-1},n.prototype.SetCentersCoordsOffset=function(e){},n.prototype.GetCentersCoordsOffset=function(
){return-1},n.prototype.GetHardWareVertexBuffer=function(){return null},n.prototype.GetHardWareIndexBuffer=function(){return null},n.prototype.GetComTextsBox=function(){var t=new e.BoundingBox;if(this.ComTexts.length!=0)for(var n=0;n<this.ComTexts.length;n++){var r=this.ComTexts[n];r&&t.Merge(r.GetBoundingBox())}else t.max=new e.Vector3(1,1,1);return t},n.prototype.fromJson=function(t){this.Id=t.id,this.Name=t.name,this.Visible=t.visible;var n=t.color.split(" ");this.Color=e.Color.BLUE(),this.IsParallelScreen=(t.style&256)!=0,this.Type=t.type,this.DefPlane=new e.Matrix3x4,this.DefPlane.fromString(t.defPlane),this.Source=t.source;if(t.exLines!=null){var r=[];e.PMICreator.CreateExtensionLines(t.exLines,r),this.SetPolyLineArray(r)}if(t.outframes){var i=[],s=[];e.PMICreator.CreateOutFrame(t.outframes,i,s),this.SetPolyLineByIndex(i,s)}if(t.Anchors){var i=[],s=[];e.PMICreator.CreateAnchorPoints(t.Anchors,i,s),this.SetPolyLineByIndex(i,s)}if(t){var r=[],o=e.StkTermTypeEnum.TERM_PATSMNONE;e.PMICreator.CreateEndSymbol(t,r,o),this.SetPolyLineArray(r)}if(t.comTexts)for(var u=0;u<t.comTexts.length;u++){var a=t.comTexts[u],f=this.ConvertStkComTextToComText(a);this.ComTexts.push(f)}var l=new e.STK_BOX32,c=this.GetComTextsBox();l.BoundBox[0][0]=c.min.x,l.BoundBox[0][1]=c.min.y,l.BoundBox[0][2]=c.min.z,l.BoundBox[1][0]=c.max.x,l.BoundBox[1][1]=c.max.y,l.BoundBox[1][2]=c.max.z;if(t.leaders){var r=[];e.PMICreator.CreateLeader(t.leaders,l,r,this),this.SetPolyLineArray(r)}if(t.specialLines){var i=[],s=[];e.PMICreator.CreateSpeciallLines(t.specialLines,i,s),this.SetPolyLineByIndex(i,s)}},n.prototype.SetPolyLineArray=function(t){for(var n=0,r=t;n<r.length;n++){var i=r[n];if(i.length>0){var s=new e.SPolyLine;for(var o=0,u=i;o<u.length;o++){var a=u[o];s.AddPoint(a.Clone())}this.PolyLines.push(s)}}},n.prototype.SetPolyLineByIndex=function(t,n){var r=new e.SPolyLine;for(var i=0;i<n.length;i++){if(n[i]==-1&&i!=0){r.GetPoints().length>0&&(this.PolyLines.push(r),r=new e.SPolyLine);continue}r.AddPoint(t[n[i]])}r.GetPoints().length>0&&this.PolyLines.push(r)},n.prototype.ConvertStkComTextToComText=function(t){var n=new e.ComText,r=new e.BoundingBox;r.fromString(t.outBox),n.SetBox(r);var i=t.texts;for(var s=0;s<i.length;s++){var o=new e.CText,u=i[s],a=u.charSpace,f=u.size.split(" ");o.SetCharWidthHeight(f[0],f[1]);var l=new e.Vector3;l.fromString(u.innerLoc),o.SetInnerLoc(l);var c=new e.BoundingBox;c.fromString(u.axis),o.SetInnerXYAxis(c.min,c.max);var h=u.content;o.SetText(h),n.AddCText(o)}return n},n.prototype.RayPick=function(t){if(this.GetParentModel()){t.BeginPickAsGroup(this),t.UpdataModelRay(this.m_WorldMatrix);for(var n=0;n<this.ComTexts.length;n++){var r=this.ComTexts[n],i=r.GetMesh();i&&i.RayPick(t)}t.UpdataIntersecPnts(this.m_WorldMatrix);var s=new e.Vector3;for(var n=0;n<this.PolyLines.length;n++){var o=this.PolyLines[n].GetPoints();for(var u=1;u<o.length;u++)t.Intersect(o[u-1],o[u],s)&&(s=this.m_WorldMatrix.Multiply(s),t.AddIntersectPnt(s))}t.UpdateGroupPickPnts(),t.EndPickAsGroup(this,0)}},n.prototype.FindVisiableObject=function(t){if(this.IsVisible()&&this.GetParentModel()&&this.GetParentModel().GetSceneNode()){var r=this.GetParentModel().GetSceneNode().GetWorldTransform();this.m_DefPlaneDirty&&(this.m_DefPlaneDirty=!1,this.m_WorldMatrix=r.Multiply(this.DefPlane),this.m_GLDefPlaneMatrix=this.m_WorldMatrix.ToMatrix4().Transpose(),this.SetRenderWorldMatrix(this.m_GLDefPlaneMatrix));var i=t.GetCamera(),s=e.Matrix3x4.IDENTITY();if(this.IsParallelScreen&&this.Type==n.PMI_FixScreen)s=i.GetView().Multiply(r).Inverse(),s.MultiTranslate(new e.Vector3(-60,-40,-10)),s.MultiScale(.2);else if(this.IsParallelScreen&&this.Type!=n.PMI_FixScreen){s=i.GetView().Multiply(this.m_WorldMatrix).Inverse();var o=this.m_WorldMatrix.Multiply(this.m_outramLocation);s=this.GetWorldMatrix(s,t,o,!0,!1,!1),this.OutFrameMatrix=s.ToMatrix4().Transpose()}t.PushRenderable(this,e.RenderableType.RGT_PMI)}},n.prototype.MarkDefinePlaneDirty=function(){this.m_DefPlaneDirty=!0},n.prototype.SetParentModel=function(e){this.m_parentModel=e},n.prototype.GetParentModel=function(){return this.m_parentModel},n.prototype.GetWorldMatrix=function(t,n,r,i,s,o){var u=e.Matrix3x4.IDENTITY();u.MultiTranslate(r);if(!o){var a=this.GetComTextsBox().GetYLength(),f=new e.Vector2(.5/a,.5/a);f=e.ShapeHelper.GetCommonSize(n.GetScene(),f);var l=f.y,c=n.GetCamera();if(!c.IsOrthographic()){var h=c.GetWorldPosition(),p=c.GetOrthoSize().y,d=h.Sub(r).Length();l=d*2/p}u.MultiScale(l/c.GetZoom())}if(!s){var v=t.Rotation();u.MultiRotatiton(v)}return i||u.MultiTranslate(t.Translation().Nagative()),u.MultiTranslate(r.Nagative()),u},n.PMI_FixScreen=8e3,n}(e.Shape);e.PMI=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var r=[];for(var i=0;i<arguments.length;i++)r[i]=arguments[i];var s=t.call(this)||this;s.pointImage=null,s.meshboard=null,s.coordinate=new e.Vector3,s.body=null,s.drawType=0,s.size=-1;if(r.length===0){var o=new e.Vector3;s.InitPoint(o)}else r.length===1&&(r[0]instanceof e.Vector3?s.InitPoint(r[0]):r[0]instanceof n&&s.AssignOperator(r[0]));return s}return __extends(n,t),n.prototype.SetRenderWorldMatrix=function(e){this.renderWorldMatrix=e.Clone()},n.prototype.GetRenderWorldMatrix=function(){return this.renderWorldMatrix},n.prototype.GetRenderColor=function(){return this.GetDrawColor()},n.prototype.GetRenderMaterial=function(){return new e.Material},n.prototype.SetRenderMesh=function(e){},n.prototype.GetDataLength=function(){return-1},n.prototype.IsUseIndex=function(){return!1},n.prototype.SetIndexOffset=function(e){},n.prototype.GetIndexOffset=function(){return-1},n.prototype.SetNormalOffset=function(e){},n.prototype.GetNormalOffset=function(){return-1},n.prototype.SetVertexOffset=function(e){},n.prototype.GetVertexOffset=function(){return-1},n.prototype.SetTextureCoordsOffset=function(e){},n.prototype.GetTextureCoordsOffset=function(){return-1},n.prototype.SetCentersCoordsOffset=function(e){},n.prototype.GetCentersCoordsOffset=function(){return-1},n.prototype.GetHardWareVertexBuffer=function(){return null},n.prototype.GetHardWareIndexBuffer=function(){return null},n.prototype.InitPoint=function(t){this.SetType(e.ShapeType.SHAPE_POINT),this.SetCoordinate(t),this.BoundingBox.Clear(),this.pointImage=null,this.meshboard=null,this.drawType=0,this.SetSize(.8)},n.prototype.AssignOperator=function(e){this!==e&&t.prototype.AssignOperator.call(this,e)},n.prototype.SetCoordinate=function(e){this.coordinate=e.Clone()},n.prototype.GetCoordinate=function(){return this.coordinate},n.prototype.ComputeBox=function(){this.BoundingBox.Clear();if(!this.BoundingBox.Defined()){var t=new e.Vector3(this.coordinate.x+n.BOX_LENGTH,this.coordinate.y+n.BOX_LENGTH,this.coordinate.z+n.BOX_LENGTH),r=new e.Vector3(this.coordinate.x-n.BOX_LENGTH,this.coordinate.y-n.BOX_LENGTH,this.coordinate.z-n.BOX_LENGTH);this.BoundingBox=new e.BoundingBox(r,t)}},n.prototype.RayPick=function(e){if(!this.IsVisible()||!e.CanPickShape(this.GetType()))return;e.Intersect(this.GetCoordinate())&&(e.AddIntersectPnt(this.GetCoordinate()),e.AddShape(this))},n.prototype.FindVisiableObject=function(e){this.IsVisible()&&(this.UpdateRenderData(e),e.PreapareRenderPoint(this))},n.prototype.UpdateRenderData=function(t){this.SetRenderWorldMatrix(t.GetGLWorldMatrix());var n=this.drawType;if(n===1||n===2||n===3){if(!this.pointImage){var r=new e.Vector2(this.size,this.size);r=e.ShapeHelper.GetCommonSize(t.GetScene(),r),this.pointImage=new e.ImageBoard(this.GetCoordinate(),r),this.pointImage.m_fixShowInScreen=!0,this.pointImage.SetTexture(t.GetScene().GetResourceManager().getDefaultPointTexture(this.drawType)),this.pointImage.SetCurrentGLContext(t.GetScene().GetResourceManager().GetRenderContext())}this.pointImage.UpdateRenderData(t)}else if(n==0){if(!this.meshboard){var r=new e.Vector2(this.size,this.size);this.meshboard=new e.MeshBoard(this.GetCoordinate(),r)}this.meshboard.UpdateRenderData(t)}this.SetFrontShow(this.IsSelected())},n.prototype.SetBody=function(e){this.body=e},n.prototype.GetBody=function(){return this.body},n.prototype.GetImageboard=function(){return this.pointImage},n.prototype.GetMeshBoard=function(){return this.meshboard},n.prototype.SetDrawType=function(e){this.drawType=e},n.prototype.GetDrawType=function(){return this.drawType},n.prototype.SetSize=function(e){this.size=e/4},n.prototype.GetSize=function(){return this.size},n.prototype.SetFrontShow=function(e){this.frontShow=e,this.pointImage&&this.pointImage.SetFrontShow(e)},n.BOX_LENGTH=.1,n}(e.Shape);e.Point=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(e,t){this.uniformType=e,this.value=t}return e}();e.Uniform=t;var n=function(){function t(e){this.textureBindingTargetMap={},this.action=null,this.m_hardWareFrameBufferMap={},this.effectManager=null,this.action=e}return t.prototype.Render=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];e.length>0},t.prototype.SetEffectManager=function(e){this.effectManager=e},t.prototype.ClearResource=function(){},t.prototype.SetSize=function(e,t){},t.prototype.SetUniform=function(t,n,r){var i=this,s=this.action.GetRenderContext().GetGLRenderContext(),o=this.action.GetScene().GetResourceManager(),u=o.GetDeffaultTextureObj(),a=o.GetDefaultCubeMap();this.textureBindingTargetMap={},n.forEach(function(n,o){var f=o.name;if(r.hasOwnProperty(n)===!1){if(o.type===e.GL.SAMPLER_2D){var l=e.GLShapeDrawer.AllocTextureUnit();s.uniform1i(t.GetShaderUniformParameter(n).location,l),i.textureBindingTargetMap[l]=e.GL.TEXTURE_2D,s.activeTexture(e.GL.TEXTURE0+l),s.bindTexture(e.GL.TEXTURE_2D,u)}else if(o.type===e.GL.SAMPLER_CUBE){var l=e.GLShapeDrawer.AllocTextureUnit();s.uniform1i(t.GetShaderUniformParameter(n).location,l),i.textureBindingTargetMap[l]=e.GL.TEXTURE_CUBE_MAP,s.activeTexture(e.GL.TEXTURE0+l),s.bindTexture(e.GL.TEXTURE_CUBE_MAP,a)}return}var c=r[n],h=c.uniformType;if(o)if(h=="Texture2D"){var l=e.GLShapeDrawer.AllocTextureUnit();s.uniform1i(t.GetShaderUniformParameter(n).location,l);var p=c.value;if(p){var d=p.GetOGLObj(s);d?(i.textureBindingTargetMap[l]=e.GL.TEXTURE_2D,s.activeTexture(e.GL.TEXTURE0+l),s.bindTexture(e.GL.TEXTURE_2D,d)):(i.textureBindingTargetMap[l]=e.GL.TEXTURE_2D,s.activeTexture(e.GL.TEXTURE0+l),s.bindTexture(e.GL.TEXTURE_2D,u))}}else if(h=="TextureCube"){var l=e.GLShapeDrawer.AllocTextureUnit();s.uniform1i(t.GetShaderUniformParameter(n).location,l);var p=c.value;if(p){var d=p.GetOGLObj(s);d?(i.textureBindingTargetMap[l]=e.GL.TEXTURE_CUBE_MAP,s.activeTexture(e.GL.TEXTURE0+l),s.bindTexture(e.GL.TEXTURE_CUBE_MAP,d)):(i.textureBindingTargetMap[l]=e.GL.TEXTURE_CUBE_MAP,s.activeTexture(e.GL.TEXTURE0+l),s.bindTexture(e.GL.TEXTURE_CUBE_MAP,a))}}else if(h=="Float"){var v=c.value,m=new Float32Array(v);t.SetUniformValue(n,m.length,m)}else if(h=="Vector3"){var v=c.value;t.SetUniformValue(n,v)}else if(h=="Vector4"){var v=c.value;t.SetUniformValue(n,v)}else if(h=="Bool"){var v=c.value;s.uniform1i(t.GetShaderUniformParameter(n).location,v)}else if(h=="Matrix3"){var v=c.value;t.SetUniformValue(n,v)}else if(h=="Matrix4"){var v=c.value;t.SetUniformValue(n,v)}})},t.prototype.MergeUnifom=function(e,t){for(var n in e){var r=e[n];t[n]=r}},t.prototype.GetHardWareFrameBuffer=function(t){var n=this.action.GetCamera(),r=this.action.GetScene().GetResourceManager(),i=this.m_hardWareFrameBufferMap[t];if(i!==null)return i.second;var s=new e.HardWareFrameBuffer(this.action.GetRenderContext().GetGLRenderContext());return this.m_hardWareFrameBufferMap[t]=s,this.m_hardWareFrameBufferMap[t].SetSize(n.GetViewPort().GetRect().Width(),n.GetViewPort().GetRect().Height()),this.m_hardWareFrameBufferMap[t].SetResourceManager(r),this.m_hardWareFrameBufferMap[t]},t}();e.Effect=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(e){this.effects={},this.renderAction=null,this.quadVertexVBO=null,this.quadTexcoordVBO=null,this.needInit=!0,this.renderAction=e}return t.prototype.GetQuadVBO=function(){return this.needInit&&(this.Init(),this.needInit=!1),{vertex:this.quadVertexVBO,texcoords:this.quadTexcoordVBO}},t.prototype.Init=function(){if(!this.quadVertexVBO||!this.quadTexcoordVBO){var e=[-1,1,-1,-1,-1,-1,1,1,-1,1,-1,-1],t=[0,1,0,0,1,1,1,0],n=this.renderAction.GetRenderContext().GetGLRenderContext();this.quadVertexVBO=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,this.quadVertexVBO),n.bufferData(n.ARRAY_BUFFER,new Float32Array(e),n.STATIC_DRAW),this.quadTexcoordVBO=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,this.quadTexcoordVBO),n.bufferData(n.ARRAY_BUFFER,new Float32Array(t),n.STATIC_DRAW),n.bindBuffer(n.ARRAY_BUFFER,null)}},t.prototype.getEffect=function(t){if(this.effects.hasOwnProperty(t)===!1){if(t==="JEWELEFFECT"){var n=new e.JewelEffect(this.renderAction);return this.effects[t]=n,n.SetEffectManager(this),n}if(t==="OUTLINEEFFECT"){var r=new e.OutlineEffect(this.renderAction);return this.effects[t]=r,r.SetEffectManager(this),r}return null}return this.effects[t]},t.prototype.setSize=function(e,t){for(var n in this.effects){var r=this.effects[n];r.SetSize(e,t)}},t}();e.EffectManager=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(e){var n=t.call(this,e)||this;return n.hardWareFrameBufferMap={},n}return __extends(n,t),n.prototype.Render=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(!(t.length>0)){var r=this.action,i=r.GetRenderEffect(),s=i.GetRenderableTypeFilter(),o=i.GetRenderQueuePriority(),u=o.GetData(),a=null,f=r.GetRenderQueueGroup(),l=[];for(var c=0,h=u;c<h.length;c++){var p=h[c],d=f.get(p.GetRenderGroupType().GetType());if(d!==undefined){d.SetRenderTech(p);var v=d.GetType().GetType();(v==e.RenderableType.RGT_SOLID||v==e.RenderableType.RGT_TRANSPARENT||v==e.RenderableType.RGT_POINT||v==e.RenderableType.RGT_NOTE||v===e.RenderableType.RGT_INTOP)&&l.push(d)}}this.DrawJewelPassGroup(l)}},n.prototype.ClearResource=function(){},n.prototype.SetSize=function(e,t){for(var n in this.hardWareFrameBufferMap){var r=this.hardWareFrameBufferMap[n];r.setSize(e,t)}},n.prototype.RenderJewelFront=function(t){if(t.GetRenderableArray().length==0)return;var n=this.action,r=n.GetRenderContext(),i=r.GetGLRenderContext(),s=n.GetCamera(),o=n.GetShaderMananger().GetEffect(e.ShaderManager.JewelFront);o.UseProgram();var u=o.GetShaderAttributeParameter(e.VSP_POSITION),a=o.GetShaderAttributeParameter(e.VSP_NORMAL),f=o.GetShaderAttributeParameter(e.VSP_TEXCOORDS);o.EnableAttributeArray(u.location),o.EnableAttributeArray(a.location);var l=t.GetRenderableArray();for(var c=0,h=l;c<h.length;c++){var p=h[c],d=new e.Matrix4,v={};v[e.VSP_VIEWMAT]=new e.Uniform("Matrix4",r.GetViewMatrix()),v[e.VSP_PROJECTIONMAT]=new e.Uniform("Matrix4",r.GetProjectMatrix()),e.GLShapeDrawer._usedTextureUnits=0;var m=p,g=m.GetRenderWorldMatrix(),y=r.GetViewMatrix();g.MultiplyMat4(y,d);var b=d.InverseED().TransposeED(),w=g.Inverse().Transpose();v[e.VSP_MODELMAT]=new e.Uniform("Matrix4",g),v[e.VSP_NORMALMAT]=new e.Uniform("Matrix4",b),v.u_worldNormalMat=new e.Uniform("Matrix4",w);var E=m.GetRenderColor(),S=new e.Color(1,1,1,1);E.Equals(e.Color.SelectColor())&&(S=E.Clone()),v[e.FSP_SELECTCOLOR]=new e.Uniform("Vector4",S);var x=s.GetWorldPosition().Clone();v[e.VSP_LIGHTPOSITION]=new e.Uniform("Vector3",x),v[e.VSP_EYEPOSITION]=new e.Uniform("Vector3",x),v.depthTexture=new e.Uniform("Texture2D",this.GetHardWareFrameBuffer("Depth").getColorTarget(0));var T=m.GetRenderMaterial();if(!T)continue;var N=T.GetUnifomParameters(),C=T.GetUniformParameter("type").value,k=C[0];this.MergeUnifom(N,v);var L=o.GetShaderUniformMap();if(k==104)continue;this.SetUniform(o,L,v);if(k!=104){var A=m.GetDataLength(),O=m.IsUseIndex(),M=m.GetHardWareVertexBuffer(),_=m.GetHardWareIndexBuffer();M.Bind();var D=p.GetVertexOffset(),P=p.GetNormalOffset(),H=p.GetTextureCoordsOffset();o.SetVertexAttribPointer(u.location,3,e.GL.FLOAT,0,D),o.SetVertexAttribPointer(a.location,3,e.GL.FLOAT,0,P);if(O){var B=p.GetIndexOffset();e.GLShapeDrawer.DrawTriWithIndex(i,M,_,A,B)}else e.GLShapeDrawer.DrawTriNoIndex(i,M,A);M.UnBind()}for(var j in this.textureBindingTargetMap){var F=this.textureBindingTargetMap[j];i.activeTexture(e.GL.TEXTURE0+parseInt(j)),i.bindTexture(F,null)}}o.DisableAttributeArray(u.location),o.DisableAttributeArray(a.location),o.ReleaseShaderProgram()},n.prototype.RenderJewelBack=function(t){if(t.GetRenderableArray().length==0)return;var n=this.action,r=n.GetRenderContext(),i=r.GetGLRenderContext(),s=n.GetCamera(),o=n.GetShaderMananger().GetEffect(e.ShaderManager.JewelBack);o.UseProgram();var u=o.GetShaderAttributeParameter(e.VSP_POSITION),a=o.GetShaderAttributeParameter(e.VSP_NORMAL);o.EnableAttributeArray(u.location),o.EnableAttributeArray(a.location);var f=t.GetRenderableArray();for(var l=0,c=f;l<c.length;l++){var h=c[l],p=new e.Matrix4,d={};d[e.VSP_VIEWMAT]=new e.Uniform("Matrix4",r.GetViewMatrix()),d[e.VSP_PROJECTIONMAT]=new e.Uniform("Matrix4",r.GetProjectMatrix()),e.GLShapeDrawer._usedTextureUnits=0;var v=h,m=v.GetRenderWorldMatrix(),g=r.GetViewMatrix();m.MultiplyMat4(g,p);var y=p.InverseED().TransposeED(),b=m.Inverse().Transpose();d[e.VSP_MODELMAT]=new e.Uniform("Matrix4",m),d[e.VSP_NORMALMAT]=new e.Uniform("Matrix4",y),d.u_worldNormalMat=new e.Uniform("Matrix4",b);var w=v.GetRenderColor(),E=new e.Color(1,1,1,1);w.Equals(e.Color.SelectColor())&&(E=w.Clone()),d[e.FSP_SELECTCOLOR]=new e.Uniform("Vector4",E);var S=s.GetWorldPosition().Clone();d[e.VSP_LIGHTPOSITION]=new e.Uniform("Vector3",S),d[e.VSP_EYEPOSITION]=new e.Uniform("Vector3",S),d.depthTexture=new e.Uniform("Texture2D",this.GetHardWareFrameBuffer("Depth").getColorTarget(0));var x=v.GetRenderMaterial();if(!x)continue;var T=x.GetUnifomParameters(),N=x.GetUniformParameter("type").value,C=N[0];this.MergeUnifom(T,d);var k=o.GetShaderUniformMap();if(C==104)continue;this.SetUniform(o,k,d);if(C!=104){var L=v.GetDataLength(),A=v.IsUseIndex(),O=v.GetHardWareVertexBuffer(),M=v.GetHardWareIndexBuffer();O.Bind();var _=h.GetVertexOffset(),D=h.GetNormalOffset(),P=h.GetTextureCoordsOffset();o.SetVertexAttribPointer(u.location,3,e.GL.FLOAT,0,_),o.SetVertexAttribPointer(a.location,3,e.GL.FLOAT,0,D);if(A){var H=h.GetIndexOffset();e.GLShapeDrawer.DrawTriWithIndex(i,O,M,L,H)}else e.GLShapeDrawer.DrawTriNoIndex(i,O,L);O.UnBind()}for(var B in this.textureBindingTargetMap){var j=this.textureBindingTargetMap[B];i.activeTexture(e.GL.TEXTURE0+parseInt(B)),i.bindTexture(j,null)}}o.DisableAttributeArray(u.location),o.DisableAttributeArray(a.location),o.ReleaseShaderProgram()},n.prototype.RenderRing=function(t){if(t.GetRenderableArray().length==0)return;var n=this.action,r=n.GetRenderContext(),i=r.GetGLRenderContext(),s=n.GetCamera(),o=n.GetShaderMananger().GetEffect(e.ShaderManager.Ring);o.UseProgram();var u=o.GetShaderAttributeParameter(e.VSP_POSITION),a=o.GetShaderAttributeParameter(e.VSP_NORMAL);o.EnableAttributeArray(u.location),o.EnableAttributeArray(a.location);var f=t.GetRenderableArray();for(var l=0,c=f;l<c.length;l++){var h=c[l],p=new e.Matrix4,d={};d[e.VSP_VIEWMAT]=new e.Uniform("Matrix4",r.GetViewMatrix()),d[e.VSP_PROJECTIONMAT]=new e.Uniform("Matrix4",r.GetProjectMatrix()),e.GLShapeDrawer._usedTextureUnits=0;var v=h,m=v.GetRenderWorldMatrix(),g=r.GetViewMatrix();m.MultiplyMat4(g,p);var y=p.InverseED().TransposeED(),b=m.Inverse().Transpose();d[e.VSP_MODELMAT]=new e.Uniform("Matrix4",m),d[e.VSP_NORMALMAT]=new e.Uniform("Matrix4",y),d.u_worldNormalMat=new e.Uniform("Matrix4",b);var w=v.GetRenderColor(),E=new e.Color(1,1,1,1);w.Equals(e.Color.SelectColor())&&(E=w.Clone()),d[e.FSP_SELECTCOLOR]=new e.Uniform("Vector4",E);var S=s.GetWorldPosition().Clone();d[e.VSP_LIGHTPOSITION]=new e.Uniform("Vector3",S),d[e.VSP_EYEPOSITION]=new e.Uniform("Vector3",S);var x=v.GetRenderMaterial();if(!x)continue;var T=x.GetUnifomParameters(),N=x.GetUniformParameter("type").value,C=N[0];this.MergeUnifom(T,d);var k=o.GetShaderUniformMap();if(C!=104)continue;this.SetUniform(o,k,d);if(C==104){var L=v.GetDataLength(),A=v.IsUseIndex(),O=v.GetHardWareVertexBuffer(),M=v.GetHardWareIndexBuffer();O.Bind();var _=h.GetVertexOffset(),D=h.GetNormalOffset(),P=h.GetTextureCoordsOffset();o.SetVertexAttribPointer(u.location,3,e.GL.FLOAT,0,_),o.SetVertexAttribPointer(a.location,3,e.GL.FLOAT,0,D);if(A){var H=h.GetIndexOffset();e.GLShapeDrawer.DrawTriWithIndex(i,O,M,L,H)}else e.GLShapeDrawer.DrawTriNoIndex(i,O,L);O.UnBind()}for(var B in this.textureBindingTargetMap){var j=this.textureBindingTargetMap[B];i.activeTexture(e.GL.TEXTURE0+parseInt(B)),i.bindTexture(j,null)}}o.DisableAttributeArray(u.location),o.DisableAttributeArray(a.location),o.ReleaseShaderProgram()},n.prototype.DrawJewelType=function(t){if(t.GetRenderableArray().length==0)return;var n=this.action,r=n.GetRenderContext(),i=r.GetGLRenderContext(),s=n.GetCamera(),o=n.GetShaderMananger().GetEffect(e.ShaderManager.JewelType);o.UseProgram();var u=o.GetShaderAttributeParameter(e.VSP_POSITION);o.EnableAttributeArray(u.location);var a=t.GetRenderableArray();for(var f=0,l=a;f<l.length;f++){var c=l[f],h=new e.Matrix4,p={};p[e.VSP_VIEWMAT]=new e.Uniform("Matrix4",r.GetViewMatrix()),p[e.VSP_PROJECTIONMAT]=new e.Uniform("Matrix4",r.GetProjectMatrix()),e.GLShapeDrawer._usedTextureUnits=0;var d=c,v=d.GetRenderWorldMatrix();p[e.VSP_MODELMAT]=new e.Uniform("Matrix4",v);var m=d.GetRenderMaterial();if(!m)continue;var g=m.GetUniformParameter("type").value,y=g[0],b=m.GetUnifomParameters();if(y==104)continue;this.MergeUnifom(b,p);var w=o.GetShaderUniformMap();this.SetUniform(o,w,p);if(y!=104){var E=d.GetDataLength(),S=d.IsUseIndex(),x=d.GetHardWareVertexBuffer(),T=d.GetHardWareIndexBuffer();x.Bind();var N=c.GetVertexOffset(),C=c.GetNormalOffset(),k=c.GetTextureCoordsOffset();o.SetVertexAttribPointer(u.location,3,e.GL.FLOAT,0,N);if(S){var L=c.GetIndexOffset();e.GLShapeDrawer.DrawTriWithIndex(i,x,T,E,L)}else e.GLShapeDrawer.DrawTriNoIndex(i,x,E);x.UnBind()}for(var A in this.textureBindingTargetMap){var O=this.textureBindingTargetMap[A];i.activeTexture(e.GL.TEXTURE0+parseInt(A)),i.bindTexture(O,null)}}o.DisableAttributeArray(u.location),o.ReleaseShaderProgram()},n.prototype.DrawJewelHighLight=function(t){if(t.GetRenderableArray().length==0)return;var n=this.action,r=n.GetRenderContext(),i=r.GetGLRenderContext(),s=n.GetCamera(),o=n.GetShaderMananger().GetEffect(e.ShaderManager.JewelHighLight);o.UseProgram();var u=o.GetShaderAttributeParameter(e.VSP_POSITION),a=o.GetShaderAttributeParameter(e.VSP_NORMAL);o.EnableAttributeArray(u.location),o.EnableAttributeArray(a.location);var f=t.GetRenderableArray();for(var l=0,c=f;l<c.length;l++){var h=c[l],p=new e.Matrix4,d={};d[e.VSP_VIEWMAT]=new e.Uniform("Matrix4",r.GetViewMatrix()),d[e.VSP_PROJECTIONMAT]=new e.Uniform("Matrix4",r.GetProjectMatrix()),e.GLShapeDrawer._usedTextureUnits=0;var v=h,m=v.GetRenderWorldMatrix(),g=r.GetViewMatrix();m.MultiplyMat4(g,p);var y=p.InverseED().TransposeED(),b=m.Inverse().Transpose();d[e.VSP_MODELMAT]=new e.Uniform("Matrix4",m),d[e.VSP_NORMALMAT]=new e.Uniform("Matrix4",y);var w=v.GetRenderColor(),E=new e.Color(1,1,1,1);w.Equals(e.Color.SelectColor())&&(E=w.Clone());var S=v.GetRenderMaterial();if(!S)continue;var x=S.GetUnifomParameters(),T=new e.Vector3(1,1,1),N=new e.Vector3(0,0,0),C=S.GetUniformParameter("type").value,k=C[0];k==103?d[e.FSP_SPECULAR]=new e.Uniform("Vector3",T):d[e.FSP_SPECULAR]=new e.Uniform("Vector3",N);var L=o.GetShaderUniformMap();this.SetUniform(o,L,d);if(k!=104){var A=v.GetDataLength(),O=v.IsUseIndex(),M=v.GetHardWareVertexBuffer(),_=v.GetHardWareIndexBuffer();M.Bind();var D=h.GetVertexOffset(),P=h.GetNormalOffset(),H=h.GetTextureCoordsOffset();o.SetVertexAttribPointer(u.location,3,e.GL.FLOAT,0,D),o.SetVertexAttribPointer(a.location,3,e.GL.FLOAT,0,P);if(O){var B=h.GetIndexOffset();e.GLShapeDrawer.DrawTriWithIndex(i,M,_,A,B)}else e.GLShapeDrawer.DrawTriNoIndex(i,M,A);M.UnBind()}for(var j in this.textureBindingTargetMap){var F=this.textureBindingTargetMap[j];i.activeTexture(e.GL.TEXTURE0+parseInt(j)),i.bindTexture(F,null)}}o.DisableAttributeArray(u.location),o.DisableAttributeArray(a.location),o.ReleaseShaderProgram()},n.prototype.DrawDepth=function(t,n){if(t.GetRenderableArray().length==0)return;var r=this.action,i=r.GetRenderContext(),s=i.GetGLRenderContext(),o=r.GetCamera(),u=r.GetShaderMananger().GetEffect(e.ShaderManager.Depth);u.UseProgram();var a=u.GetShaderAttributeParameter(e.VSP_POSITION);u.EnableAttributeArray(a.location);var f=t.GetRenderableArray();for(var l=0,c=f;l<c.length;l++){var h=c[l],p=new e.Matrix4,d={};d[e.VSP_VIEWMAT]=new e.Uniform("Matrix4",i.GetViewMatrix()),d[e.VSP_PROJECTIONMAT]=new e.Uniform("Matrix4",i.GetProjectMatrix()),e.GLShapeDrawer._usedTextureUnits=0;var v=h,m=v.GetRenderWorldMatrix(),g=i.GetViewMatrix();d[e.VSP_MODELMAT]=new e.Uniform("Matrix4",m);var y=v.GetRenderColor(),b=new e.Color(1,1,1,1);y.Equals(e.Color.SelectColor())&&(b=y.Clone());var w=v.GetRenderMaterial();if(!w)continue;var E=w.GetUnifomParameters(),S=new e.Vector3(1,1,1),x=new e.Vector3(0,0,0),T=w.GetUniformParameter("type").value,N=T[0];if(N!==n)continue;this.MergeUnifom(E,d);var C=u.GetShaderUniformMap();this.SetUniform(u,C,d);var k=v.GetDataLength(),L=v.IsUseIndex(),A=v.GetHardWareVertexBuffer(),O=v.GetHardWareIndexBuffer();A.Bind();var M=h.GetVertexOffset(),_=h.GetNormalOffset(),D=h.GetTextureCoordsOffset();u.SetVertexAttribPointer(a.location,3,e.GL.FLOAT,0,M);if(L){var P=h.GetIndexOffset();e.GLShapeDrawer.DrawTriWithIndex(s,A,O,k,P)}else e.GLShapeDrawer.DrawTriNoIndex(s,A,k);A.UnBind();for(var H in this.textureBindingTargetMap){var B=this.textureBindingTargetMap[H];s.activeTexture(e.GL.TEXTURE0+parseInt(H)),s.bindTexture(B,null)}}u.DisableAttributeArray(a.location),u.ReleaseShaderProgram()},n.prototype.DrawJadeBlendQuad=function(){var t=this.action,n=t.GetRenderContext(),r=n.GetGLRenderContext(),i=t.GetCamera(),s=[-1,1,-1,-1,-1,-1,1,1,-1,1,-1,-1],o=[0,1,0,0,1,1,1,0],u=i.GetViewPort().GetRect();r.viewport(u.left,u.top,u.right,u.bottom);var a=1/u.right,f=1/u.bottom,l=t.GetShaderMananger().GetEffect(e.ShaderManager.JewelBlendQuad);l.UseProgram();var c={};e.GLShapeDrawer._usedTextureUnits=0;var h=l.GetShaderAttributeParameter(e.VSP_POSITION),p=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,p),r.bufferData(r.ARRAY_BUFFER,new Float32Array(s),r.STATIC_DRAW),l.EnableAttributeArray(h.location),l.SetVertexAttribPointer(h.location,3,e.GL.FLOAT,0,0);var d=l.GetShaderAttributeParameter(e.VSP_TEXCOORDS),v=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,v),r.bufferData(r.ARRAY_BUFFER,new Float32Array(o),r.STATIC_DRAW),l.EnableAttributeArray(d.location),l.SetVertexAttribPointer(d.location,2,e.GL.FLOAT,0,0);var m=new e.Matrix4,g=new e.Matrix4,y=new e.Matrix4;c[e.VSP_MODELMAT]=new e.Uniform("Matrix4",y),c[e.VSP_VIEWMAT]=new e.Uniform("Matrix4",m),c[e.VSP_PROJECTIONMAT]=new e.Uniform("Matrix4",g),c[e.FSP_SAMPLER0]=new e.Uniform("Texture2D",this.GetHardWareFrameBuffer("diamondFrontFBO").getColorTarget(0)),c[e.FSP_SAMPLER1]=new e.Uniform("Texture2D",this.GetHardWareFrameBuffer("diamondBackFBO").getColorTarget(0)),c[e.FSP_SAMPLER2]=new e.Uniform("Texture2D",this.GetHardWareFrameBuffer("jewelTypeFBO").getColorTarget(0)),c.u_sampler3=new e.Uniform("Texture2D",this.GetHardWareFrameBuffer("jewelHighLightFBO").getColorTarget(0));var b=l.GetShaderUniformMap();this.SetUniform(l,b,c),r.drawArrays(e.GL.TRIANGLE_STRIP,0,4);for(var w in this.textureBindingTargetMap){var E=this.textureBindingTargetMap[w];r.activeTexture(e.GL.TEXTURE0+parseInt(w)),r.bindTexture(E,null)}l.DisableAttributeArray(h.location),l.DisableAttributeArray(d.location),l.ReleaseShaderProgram(),r.deleteBuffer(p),r.deleteBuffer(v)},n.prototype.DrawJewelQuad=function(){var t=this.action,n=t.GetRenderContext(),r=n.GetGLRenderContext(),i=t.GetCamera(),s=[-1,1,-1,-1,-1,-1,1,1,-1,1,-1,-1],o=[0,1,0,0,1,1,1,0],u=i.GetViewPort().GetRect();r.viewport(u.left,u.top,u.right,u.bottom);var a=1/u.right,f=1/u.bottom,l=t.GetShaderMananger().GetEffect(e.ShaderManager.JewelFinalQuad);l.UseProgram();var c={};e.GLShapeDrawer._usedTextureUnits=0;var h=l.GetShaderAttributeParameter(e.VSP_POSITION),p=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,p),r.bufferData(r.ARRAY_BUFFER,new Float32Array(s),r.STATIC_DRAW),l.EnableAttributeArray(h.location),l.SetVertexAttribPointer(h.location,3,e.GL.FLOAT,0,0);var d=l.GetShaderAttributeParameter(e.VSP_TEXCOORDS),v=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,v),r.bufferData(r.ARRAY_BUFFER,new Float32Array(o),r.STATIC_DRAW),l.EnableAttributeArray(d.location),l.SetVertexAttribPointer(d.location,2,e.GL.FLOAT,0,0);var m=new e.Matrix4,g=new e.Matrix4,y=new e.Matrix4;c[e.VSP_MODELMAT]=new e.Uniform("Matrix4",y),c[e.VSP_VIEWMAT]=new e.Uniform("Matrix4",m),c[e.VSP_PROJECTIONMAT]=new e.Uniform("Matrix4",g),c[e.FSP_SAMPLER0]=new e.Uniform("Texture2D",this.GetHardWareFrameBuffer("jewelBlendQuadFBO").getColorTarget(0)),c[e.FSP_SAMPLER1]=new e.Uniform("Texture2D",this.GetHardWareFrameBuffer("jewelDepth").getColorTarget(0)),c[e.FSP_SAMPLER2]=new e.Uniform("Texture2D",this.GetHardWareFrameBuffer("ringFBO").getColorTarget(0)),c.u_sampler3=new e.Uniform("Texture2D",this.GetHardWareFrameBuffer("ringDepth").getColorTarget(0));var b=l.GetShaderUniformMap();this.SetUniform(l,b,c),r.drawArrays(e.GL.TRIANGLE_STRIP,0,4);for(var w in this.textureBindingTargetMap){var E=this.textureBindingTargetMap[w];r.activeTexture(e.GL.TEXTURE0+parseInt(w)),r.bindTexture(E,null)}l.DisableAttributeArray(h.location),l.DisableAttributeArray(d.location),l.ReleaseShaderProgram(),r.deleteBuffer(p),r.deleteBuffer(v)},n.prototype.DrawJewelPassGroup=function(t){if(t[0].GetRenderableArray().length===0)return;var n=this.action,r=n.GetRenderContext(),i=r.GetGLRenderContext(),s=n.GetCamera(),o=s.GetViewPort().GetRect();i.disable(e.GL.BLEND);var u=this.GetHardWareFrameBuffer("jewelDepth");u.reShape(),u.checkStatus(),u.bind(),i.enable(e.GL.DEPTH_TEST),i.depthFunc(e.GL.LEQUAL),i.clearColor(1,1,1,1),i.clear(e.GL.DEPTH_BUFFER_BIT|e.GL.COLOR_BUFFER_BIT|e.GL.STENCIL_BUFFER_BIT),i.viewport(o.left,o.top,o.right,o.bottom),i.enable(e.GL.CULL_FACE),i.cullFace(e.GL.BACK),i.frontFace(e.GL.CCW);for(var a=0;a<t.length;a++){var f=t[0].GetType().GetType();(f==e.RenderableType.RGT_SOLID||f==e.RenderableType.RGT_TRANSPARENT)&&this.DrawDepth(t[a],103)}u.unbind();var l=this.GetHardWareFrameBuffer("ringDepth");l.reShape(),l.checkStatus(),l.bind(),i.enable(e.GL.DEPTH_TEST),i.depthFunc(e.GL.LEQUAL),i.clearColor(1,1,1,1),i.clear(e.GL.DEPTH_BUFFER_BIT|e.GL.COLOR_BUFFER_BIT|e.GL.STENCIL_BUFFER_BIT),i.viewport(o.left,o.top,o.right,o.bottom),i.enable(e.GL.CULL_FACE),i.cullFace(e.GL.BACK),i.frontFace(e.GL.CCW);for(var a=0;a<t.length;a++){var f=t[0].GetType().GetType();(f==e.RenderableType.RGT_SOLID||f==e.RenderableType.RGT_TRANSPARENT)&&this.DrawDepth(t[a],104)}l.unbind();var c=this.GetHardWareFrameBuffer("diamondFrontFBO");c.reShape(),c.checkStatus(),c.bind(),i.enable(e.GL.DEPTH_TEST),i.depthFunc(e.GL.LEQUAL),i.clearColor(0,0,0,0),i.clear(e.GL.DEPTH_BUFFER_BIT|e.GL.COLOR_BUFFER_BIT|e.GL.STENCIL_BUFFER_BIT),e.GLShapeDrawer.DrawBackGround(n.GetBackGroundNode(),n),i.viewport(o.left,o.top,o.right,o.bottom),i.enable(e.GL.CULL_FACE),i.cullFace(e.GL.BACK),i.frontFace(e.GL.CCW);for(var a=0;a<t.length;a++){var f=t[0].GetType().GetType();(f==e.RenderableType.RGT_SOLID||f==e.RenderableType.RGT_TRANSPARENT)&&this.RenderJewelFront(t[a])}c.unbind();var h=this.GetHardWareFrameBuffer("diamondBackFBO");h.reShape(),h.checkStatus(),h.bind(),i.enable(e.GL.DEPTH_TEST),i.depthFunc(e.GL.LEQUAL),i.clearColor(0,0,0,0),i.clear(e.GL.DEPTH_BUFFER_BIT|e.GL.COLOR_BUFFER_BIT|e.GL.STENCIL_BUFFER_BIT),e.GLShapeDrawer.DrawBackGround(n.GetBackGroundNode(),n),i.viewport(o.left,o.top,o.right,o.bottom),i.enable(e.GL.CULL_FACE),i.cullFace(e.GL.BACK),i.frontFace(e.GL.CW);for(var a=0;a<t.length;a++){var f=t[0].GetType().GetType();(f==e.RenderableType.RGT_SOLID||f==e.RenderableType.RGT_TRANSPARENT)&&this.RenderJewelBack(t[a])}h.unbind(),i.frontFace(e.GL.CCW),i.disable(e.GL.CULL_FACE);var p=this.GetHardWareFrameBuffer("ringFBO");p.reShape(),p.checkStatus(),p.bind(),i.enable(e.GL.DEPTH_TEST),i.depthFunc(e.GL.LEQUAL),i.clearColor(0,0,0,0),i.clear(e.GL.DEPTH_BUFFER_BIT|e.GL.COLOR_BUFFER_BIT|e.GL.STENCIL_BUFFER_BIT),e.GLShapeDrawer.DrawBackGround(n.GetBackGroundNode(),n),i.viewport(o.left,o.top,o.right,o.bottom);for(var a=0;a<t.length;a++){var f=t[0].GetType().GetType();(f==e.RenderableType.RGT_SOLID||f==e.RenderableType.RGT_TRANSPARENT)&&this.RenderRing(t[a])}p.unbind();var d=this.GetHardWareFrameBuffer("jewelTypeFBO");d.reShape(),d.checkStatus(),d.bind(),i.enable(e.GL.DEPTH_TEST),i.depthFunc(e.GL.LEQUAL),i.clearColor(0,0,0,0),i.clear(e.GL.DEPTH_BUFFER_BIT|e.GL.COLOR_BUFFER_BIT|e.GL.STENCIL_BUFFER_BIT),i.viewport(o.left,o.top,o.right,o.bottom);for(var a=0;a<t.length;a++){var f=t[a].GetType().GetType();(f==e.RenderableType.RGT_SOLID||f==e.RenderableType.RGT_TRANSPARENT)&&this.DrawJewelType(t[a])}d.unbind
();var v=this.GetHardWareFrameBuffer("jewelHighLightFBO");v.reShape(),v.checkStatus(),v.bind(),i.enable(e.GL.DEPTH_TEST),i.depthFunc(e.GL.LEQUAL),i.clearColor(0,0,0,0),i.clear(e.GL.DEPTH_BUFFER_BIT|e.GL.COLOR_BUFFER_BIT|e.GL.STENCIL_BUFFER_BIT),i.viewport(o.left,o.top,o.right,o.bottom);for(var a=0;a<t.length;a++){var f=t[a].GetType().GetType();(f==e.RenderableType.RGT_SOLID||f==e.RenderableType.RGT_TRANSPARENT)&&this.DrawJewelHighLight(t[a])}v.unbind();var m=this.GetHardWareFrameBuffer("jewelBlendQuadFBO");m.reShape(),m.checkStatus(),m.bind(),i.enable(e.GL.DEPTH_TEST),i.depthFunc(e.GL.LEQUAL),i.clearColor(0,0,0,0),i.clear(e.GL.DEPTH_BUFFER_BIT|e.GL.COLOR_BUFFER_BIT|e.GL.STENCIL_BUFFER_BIT),i.viewport(o.left,o.top,o.right,o.bottom),this.DrawJadeBlendQuad(),m.unbind(),this.DrawJewelQuad();for(var a=0;a<t.length;a++){var f=t[a].GetType().GetType();f==e.RenderableType.RGT_INTOP&&e.GLShapeDrawer.DrawOutlinePassGroup(n,t[a])}i.viewport(o.left,o.top,o.right,o.bottom)},n.prototype.GetHardWareFrameBuffer=function(t){var n=this.action.GetCamera(),r=this.action.GetScene().GetResourceManager(),i=this.action.GetRenderContext(),s=i.GetGLRenderContext();if(this.hardWareFrameBufferMap.hasOwnProperty(t)!==!1)return this.hardWareFrameBufferMap[t];var o=new e.HardWareFrameBuffer(s);return o.setCreationParameters(1,!0,!1),o.setResourceManager(r),o.setSize(n.GetViewPort().GetRect().Width(),n.GetViewPort().GetRect().Height()),this.hardWareFrameBufferMap[t]=o,o},n.prototype.DrawFrameBufferDebug=function(){var t=this.action,n=t.GetRenderContext(),r=n.GetGLRenderContext(),i=t.GetCamera(),s=[-1,1,-1,-1,-1,-1,1,1,-1,1,-1,-1],o=[0,1,0,0,1,1,1,0],u=i.GetViewPort().GetRect();r.viewport(u.left,u.top,u.right,u.bottom);var a=1/u.right,f=1/u.bottom,l=t.GetShaderMananger().GetEffect(e.ShaderManager.FBODebug);l.UseProgram();var c={};e.GLShapeDrawer._usedTextureUnits=0;var h=l.GetShaderAttributeParameter(e.VSP_POSITION),p=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,p),r.bufferData(r.ARRAY_BUFFER,new Float32Array(s),r.STATIC_DRAW),l.EnableAttributeArray(h.location),l.SetVertexAttribPointer(h.location,3,e.GL.FLOAT,0,0);var d=l.GetShaderAttributeParameter(e.VSP_TEXCOORDS),v=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,v),r.bufferData(r.ARRAY_BUFFER,new Float32Array(o),r.STATIC_DRAW),l.EnableAttributeArray(d.location),l.SetVertexAttribPointer(d.location,2,e.GL.FLOAT,0,0);var m=new e.Matrix4,g=new e.Matrix4,y=new e.Matrix4;c[e.VSP_MODELMAT]=new e.Uniform("Matrix4",y),c[e.VSP_VIEWMAT]=new e.Uniform("Matrix4",m),c[e.VSP_PROJECTIONMAT]=new e.Uniform("Matrix4",g),c[e.FSP_SAMPLER0]=new e.Uniform("Texture2D",this.GetHardWareFrameBuffer("jewelDepth").getColorTarget(0));var b=l.GetShaderUniformMap();this.SetUniform(l,b,c),r.drawArrays(e.GL.TRIANGLE_STRIP,0,4);for(var w in this.textureBindingTargetMap){var E=this.textureBindingTargetMap[w];r.activeTexture(e.GL.TEXTURE0+parseInt(w)),r.bindTexture(E,null)}l.DisableAttributeArray(h.location),l.DisableAttributeArray(d.location),l.ReleaseShaderProgram(),r.deleteBuffer(p),r.deleteBuffer(v)},n}(e.Effect);e.JewelEffect=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(e){var n=t.call(this,e)||this;return n.hardWareFrameBufferMap={},n.outlineTexture=null,n.firstTimes=!0,n}return __extends(n,t),n.prototype.GetOutlineTexture=function(){return this.outlineTexture},n.prototype.Render=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length>0){var r=t[0],i=[];i.push(r),this.InnerRender(i)}else{var s=this.action,o=s.GetRenderEffect(),u=o.GetRenderableTypeFilter(),a=o.GetRenderQueuePriority(),f=a.GetData(),l=null,c=s.GetRenderQueueGroup(),i=[];for(var h=0,p=f;h<p.length;h++){var d=p[h],v=c.get(d.GetRenderGroupType().GetType());if(v!==undefined){v.SetRenderTech(d);var m=v.GetType().GetType();(m==e.RenderableType.RGT_SOLID||m==e.RenderableType.RGT_TRANSPARENT)&&i.push(v)}}this.InnerRender(i)}},n.prototype.InnerRender=function(t){this.firstTimes=!0;var n=this.action,r=n.GetRenderContext(),i=r.GetGLRenderContext(),s=n.GetCamera(),o=s.GetViewPort().GetRect(),u=this.GetHardWareFrameBuffer("model");u.reShape(),u.checkStatus(),u.bind(),i.enable(e.GL.DEPTH_TEST),i.depthFunc(e.GL.LEQUAL),i.clearColor(0,0,0,0),i.clear(e.GL.DEPTH_BUFFER_BIT|e.GL.COLOR_BUFFER_BIT|e.GL.STENCIL_BUFFER_BIT),i.viewport(o.left,o.top,o.right,o.bottom);for(var a=0;a<t.length;a++)this.RenderModel(t[a]);u.unbind();var f=this.GetHardWareFrameBuffer("width");f.reShape(),f.checkStatus(),f.bind(),i.disable(e.GL.DEPTH_TEST),i.depthFunc(e.GL.LEQUAL),i.clearColor(0,0,0,0),i.clear(e.GL.DEPTH_BUFFER_BIT|e.GL.COLOR_BUFFER_BIT|e.GL.STENCIL_BUFFER_BIT),i.viewport(o.left,o.top,o.right,o.bottom),this.RenderGaussianBlurWidth(),f.unbind();var l=this.GetHardWareFrameBuffer("height");l.reShape(),l.checkStatus(),l.bind(),i.disable(e.GL.DEPTH_TEST),i.depthFunc(e.GL.LEQUAL),i.clearColor(0,0,0,0),i.clear(e.GL.DEPTH_BUFFER_BIT|e.GL.COLOR_BUFFER_BIT|e.GL.STENCIL_BUFFER_BIT),i.viewport(o.left,o.top,o.right,o.bottom),this.RenderGaussianBlurHeight(),l.unbind(),f.bind(),this.RenderGaussianBlurWidth(),f.unbind(),l.bind(),this.RenderGaussianBlurHeight(),l.unbind(),f.bind(),this.RenderGaussianBlurWidth(),f.unbind(),l.bind(),this.RenderGaussianBlurHeight(),l.unbind(),f.bind(),this.RenderGaussianBlurWidth(),f.unbind(),l.bind(),this.RenderGaussianBlurHeight(),l.unbind(),f.bind(),this.RenderGaussianBlurWidth(),f.unbind(),l.bind(),this.RenderGaussianBlurHeight(),l.unbind(),f.bind(),this.RenderGaussianBlurWidth(),f.unbind(),l.bind(),this.RenderGaussianBlurHeight(),l.unbind(),f.bind(),this.RenderGaussianBlurWidth(),f.unbind(),l.bind(),this.RenderGaussianBlurHeight(),l.unbind();var c=this.GetHardWareFrameBuffer("outline");c.reShape(),c.checkStatus(),c.bind(),i.disable(e.GL.DEPTH_TEST),i.depthFunc(e.GL.LEQUAL),i.clearColor(0,0,0,0),i.clear(e.GL.DEPTH_BUFFER_BIT|e.GL.COLOR_BUFFER_BIT|e.GL.STENCIL_BUFFER_BIT),i.viewport(o.left,o.top,o.right,o.bottom),this.RenderOutline(),c.unbind(),this.outlineTexture=this.GetHardWareFrameBuffer("outline").getColorTarget(0)},n.prototype.RenderModel=function(t){if(t.GetRenderableArray().length===0)return;var n=this.action,r=n.GetRenderContext(),i=r.GetGLRenderContext(),s=n.GetCamera(),o=s.GetViewPort().GetRect(),u=n.GetShaderMananger().GetEffect(e.ShaderManager.Outline);u.UseProgram();var a=u.GetShaderAttributeParameter(e.VSP_POSITION),f=u.GetShaderAttributeParameter(e.VSP_NORMAL);u.EnableAttributeArray(a.location),u.SetUniformValue(e.VSP_VIEWMAT,r.GetViewMatrix()),u.SetUniformValue(e.VSP_PROJECTIONMAT,r.GetProjectMatrix());var l=n.clipPlane[0].Clone(),c=r.GetViewMatrix();l=c.Inverse().Multiply(l),u.SetUniformValue(e.FSP_CLIPPLANE,l);var h=new Int32Array([n.enableClip[0]]);u.SetUniformValue(e.FSP_ENABLECLIP,h);var p=new e.Matrix4,d=t.GetRenderableArray(),v=r.GetViewMatrix(),m=new e.Matrix4,g=new e.Matrix4;for(var y=0,b=d;y<b.length;y++){var w=b[y],E=w.GetDataLength(),S=w.IsUseIndex(),x=w.GetHardWareVertexBuffer(),T=w.GetHardWareIndexBuffer();p=w.GetRenderWorldMatrix(),p.MultiplyMat4(v,m),g=m.InverseED().TransposeED(),x.Bind();var N=w.GetVertexOffset(),C=w.GetNormalOffset(),k=w.GetTextureCoordsOffset(),L=w.GetCentersCoordsOffset(),A=w.GetRenderColor();u.SetVertexAttribPointer(a.location,3,e.GL.FLOAT,0,N),u.SetUniformValue(e.VSP_MODELMAT,p),u.SetUniformValue(e.VSP_NORMALMAT,g);if(E>0){u.SetUniformValue(e.FSP_DIFFUSE,e.Parameters.Instance().outlineColor);if(S){var O=w.GetIndexOffset();e.GLShapeDrawer.DrawTriWithIndex(i,x,T,E,O)}else e.GLShapeDrawer.DrawTriNoIndex(i,x,E)}}u.DisableAttributeArray(a.location),u.ReleaseShaderProgram(),i.enable(e.GL.DEPTH_TEST)},n.prototype.RenderGaussianBlurWidth=function(){var t=this.action,n=t.GetRenderContext(),r=n.GetGLRenderContext(),i=t.GetCamera(),s=i.GetViewPort().GetRect();r.viewport(s.left,s.top,s.right,s.bottom);var o=1/s.right,u=1/s.bottom,a=t.GetShaderMananger().GetEffect(e.ShaderManager.GaussianBlur);a.UseProgram();var f={};e.GLShapeDrawer._usedTextureUnits=0;var l=a.GetShaderAttributeParameter(e.VSP_POSITION),c=this.effectManager.GetQuadVBO().vertex;r.bindBuffer(r.ARRAY_BUFFER,c),a.EnableAttributeArray(l.location),a.SetVertexAttribPointer(l.location,3,e.GL.FLOAT,0,0);var h=a.GetShaderAttributeParameter(e.VSP_TEXCOORDS),p=this.effectManager.GetQuadVBO().texcoords;r.bindBuffer(r.ARRAY_BUFFER,p),a.EnableAttributeArray(h.location),a.SetVertexAttribPointer(h.location,2,e.GL.FLOAT,0,0);var d=new e.Matrix4,v=new e.Matrix4,m=new e.Matrix4,g=[];g.push(o),f.tex_offset=new e.Uniform("Float",g),f.horizontal=new e.Uniform("Bool",!0),this.firstTimes?(f.image=new e.Uniform("Texture2D",this.GetHardWareFrameBuffer("model").getColorTarget(0)),this.firstTimes=!1):f.image=new e.Uniform("Texture2D",this.GetHardWareFrameBuffer("height").getColorTarget(0));var y=a.GetShaderUniformMap();this.SetUniform(a,y,f),r.drawArrays(e.GL.TRIANGLE_STRIP,0,4);for(var b in this.textureBindingTargetMap){var w=this.textureBindingTargetMap[b];r.activeTexture(e.GL.TEXTURE0+parseInt(b)),r.bindTexture(w,null)}a.DisableAttributeArray(l.location),a.DisableAttributeArray(h.location),a.ReleaseShaderProgram(),r.bindBuffer(e.GL.ARRAY_BUFFER,null)},n.prototype.RenderGaussianBlurHeight=function(){var t=this.action,n=t.GetRenderContext(),r=n.GetGLRenderContext(),i=t.GetCamera(),s=i.GetViewPort().GetRect();r.viewport(s.left,s.top,s.right,s.bottom);var o=1/s.right,u=1/s.bottom,a=t.GetShaderMananger().GetEffect(e.ShaderManager.GaussianBlur);a.UseProgram();var f={};e.GLShapeDrawer._usedTextureUnits=0;var l=a.GetShaderAttributeParameter(e.VSP_POSITION),c=this.effectManager.GetQuadVBO().vertex;r.bindBuffer(r.ARRAY_BUFFER,c),a.EnableAttributeArray(l.location),a.SetVertexAttribPointer(l.location,3,e.GL.FLOAT,0,0);var h=a.GetShaderAttributeParameter(e.VSP_TEXCOORDS),p=this.effectManager.GetQuadVBO().texcoords;r.bindBuffer(r.ARRAY_BUFFER,p),a.EnableAttributeArray(h.location),a.SetVertexAttribPointer(h.location,2,e.GL.FLOAT,0,0);var d=new e.Matrix4,v=new e.Matrix4,m=new e.Matrix4,g=[];g.push(u),f.tex_offset=new e.Uniform("Float",g),f.horizontal=new e.Uniform("Bool",!1),f.image=new e.Uniform("Texture2D",this.GetHardWareFrameBuffer("width").getColorTarget(0));var y=a.GetShaderUniformMap();this.SetUniform(a,y,f),r.drawArrays(e.GL.TRIANGLE_STRIP,0,4);for(var b in this.textureBindingTargetMap){var w=this.textureBindingTargetMap[b];r.activeTexture(e.GL.TEXTURE0+parseInt(b)),r.bindTexture(w,null)}a.DisableAttributeArray(l.location),a.DisableAttributeArray(h.location),a.ReleaseShaderProgram(),r.bindBuffer(e.GL.ARRAY_BUFFER,null)},n.prototype.RenderOutline=function(){var t=this.action,n=t.GetRenderContext(),r=n.GetGLRenderContext(),i=t.GetCamera(),s=i.GetViewPort().GetRect();r.viewport(s.left,s.top,s.right,s.bottom);var o=1/s.right,u=1/s.bottom,a=t.GetShaderMananger().GetEffect(e.ShaderManager.GaussianBlurOutline);a.UseProgram();var f={};e.GLShapeDrawer._usedTextureUnits=0;var l=a.GetShaderAttributeParameter(e.VSP_POSITION),c=this.effectManager.GetQuadVBO().vertex;r.bindBuffer(r.ARRAY_BUFFER,c),a.EnableAttributeArray(l.location),a.SetVertexAttribPointer(l.location,3,e.GL.FLOAT,0,0);var h=a.GetShaderAttributeParameter(e.VSP_TEXCOORDS),p=this.effectManager.GetQuadVBO().texcoords;r.bindBuffer(r.ARRAY_BUFFER,p),a.EnableAttributeArray(h.location),a.SetVertexAttribPointer(h.location,2,e.GL.FLOAT,0,0);var d=new e.Matrix4,v=new e.Matrix4,m=new e.Matrix4;f.height=new e.Uniform("Texture2D",this.GetHardWareFrameBuffer("height").getColorTarget(0)),f.model=new e.Uniform("Texture2D",this.GetHardWareFrameBuffer("model").getColorTarget(0));var g=a.GetShaderUniformMap();this.SetUniform(a,g,f),r.drawArrays(e.GL.TRIANGLE_STRIP,0,4);for(var y in this.textureBindingTargetMap){var b=this.textureBindingTargetMap[y];r.activeTexture(e.GL.TEXTURE0+parseInt(y)),r.bindTexture(b,null)}a.DisableAttributeArray(l.location),a.DisableAttributeArray(h.location),a.ReleaseShaderProgram(),r.bindBuffer(e.GL.ARRAY_BUFFER,null)},n.prototype.DrawFrameBufferDebug=function(){var t=this.action,n=t.GetRenderContext(),r=n.GetGLRenderContext(),i=t.GetCamera(),s=[-1,1,-1,-1,-1,-1,1,1,-1,1,-1,-1],o=[0,1,0,0,1,1,1,0],u=i.GetViewPort().GetRect();r.viewport(u.left,u.top,u.right,u.bottom);var a=1/u.right,f=1/u.bottom,l=t.GetShaderMananger().GetEffect(e.ShaderManager.FBODebug);l.UseProgram();var c={};e.GLShapeDrawer._usedTextureUnits=0;var h=l.GetShaderAttributeParameter(e.VSP_POSITION),p=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,p),r.bufferData(r.ARRAY_BUFFER,new Float32Array(s),r.STATIC_DRAW),l.EnableAttributeArray(h.location),l.SetVertexAttribPointer(h.location,3,e.GL.FLOAT,0,0);var d=l.GetShaderAttributeParameter(e.VSP_TEXCOORDS),v=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,v),r.bufferData(r.ARRAY_BUFFER,new Float32Array(o),r.STATIC_DRAW),l.EnableAttributeArray(d.location),l.SetVertexAttribPointer(d.location,2,e.GL.FLOAT,0,0);var m=new e.Matrix4,g=new e.Matrix4,y=new e.Matrix4;c[e.VSP_MODELMAT]=new e.Uniform("Matrix4",y),c[e.VSP_VIEWMAT]=new e.Uniform("Matrix4",m),c[e.VSP_PROJECTIONMAT]=new e.Uniform("Matrix4",g),c[e.FSP_SAMPLER0]=new e.Uniform("Texture2D",this.GetHardWareFrameBuffer("outline").getColorTarget(0));var b=l.GetShaderUniformMap();this.SetUniform(l,b,c),r.drawArrays(e.GL.TRIANGLE_STRIP,0,4);for(var w in this.textureBindingTargetMap){var E=this.textureBindingTargetMap[w];r.activeTexture(e.GL.TEXTURE0+parseInt(w)),r.bindTexture(E,null)}l.DisableAttributeArray(h.location),l.DisableAttributeArray(d.location),l.ReleaseShaderProgram(),r.deleteBuffer(p),r.deleteBuffer(v)},n.prototype.SetSize=function(e,t){for(var n in this.hardWareFrameBufferMap){var r=this.hardWareFrameBufferMap[n];r.setSize(e,t)}},n.prototype.GetHardWareFrameBuffer=function(t){var n=this.action.GetCamera(),r=this.action.GetScene().GetResourceManager(),i=this.action.GetRenderContext(),s=i.GetGLRenderContext();if(this.hardWareFrameBufferMap.hasOwnProperty(t)!==!1)return this.hardWareFrameBufferMap[t];var o=new e.HardWareFrameBuffer(s);return o.setCreationParameters(1,!0,!1),o.setResourceManager(r),o.setSize(n.GetViewPort().GetRect().Width(),n.GetViewPort().GetRect().Height()),this.hardWareFrameBufferMap[t]=o,o},n}(e.Effect);e.OutlineEffect=t})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.DEFALUT_TARGET=-1]="DEFALUT_TARGET",e[e.TEXTURE_TARGET=0]="TEXTURE_TARGET",e[e.RBO_TARGET=1]="RBO_TARGET"})(t=e.RenderTargetType||(e.RenderTargetType={}));var n=function(){function e(){this.m_targetType=t.DEFALUT_TARGET}return e.prototype.GetTargetType=function(){return this.m_targetType},e.prototype.SetTargetType=function(e){this.m_targetType=e},e}();e.GLRenderTarget=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){}return e}();e.LightUniforms=t;var n=function(e){function t(){var t=e.call(this)||this;return t.shadow=0,t.shadowBias=0,t.shadowRadius=1,t}return __extends(t,e),t}(t);e.DirectionalLightUniforms=n;var r=function(e){function t(){var t=e.call(this)||this;return t.distance=0,t.decay=0,t.shadow=0,t.shadowBias=0,t.shadowRadius=1,t.shadowCameraFar=1,t.shadowCameraNear=1e3,t}return __extends(t,e),t}(t);e.PointLightUniforms=r;var i=function(e){function t(){var t=e.call(this)||this;return t.distance=0,t.coneCos=0,t.penumbraCos=0,t.decay=0,t.shadow=0,t.shadowBias=0,t.shadowRadius=1,t}return __extends(t,e),t}(t);e.SpotLightUniforms=i;var s=function(t){function n(){var n=t.call(this)||this;return n.direction=new e.Vector3(0,1,0),n.skyColor=new e.Color(1,1,1),n.groundColor=new e.Color(1,1,1),n}return __extends(n,t),n}(t);e.HemisphereLightUniforms=s;var o=function(){function t(){this.directional=[],this.spot=[],this.point=[],this.hemisphere=[]}return t.prototype.Resize=function(){this.directional=[],this.spot=[],this.point=[],this.hemisphere=[],this.ambient=new e.Vector3},t}();e.SceneLightState=o;var u=function(){function t(){this.m_sceneLights=[],this.m_directionalLightNumber=0,this.m_pointLightNumber=0,this.m_spotLightNumber=0,this.direnctionCastShadowLightNumber=0,this.pointLightCastShadowNumber=0,this.spotLightCastShadowNumber=0,this.m_hemisphereLightNumber=0,this.m_lightUniformCatch={},this.m_state=new o}return t.prototype.AddLight=function(e){if(e){for(var t=0;t<this.m_sceneLights.length;t++)if(this.m_sceneLights[t]==e)return;this.m_sceneManager.AsynUpdateModelCacheInfo(e,!0),this.m_sceneLights.push(e)}},t.prototype.RemoveLight=function(e){for(var t=0,n=this.m_sceneLights.length;t<n;t++)if(this.m_sceneLights[t]==e){var r=this.GetLightUniform(e);r&&(r=null),this.RemoveLightUniform(e),this.m_sceneManager.AsynUpdateModelCacheInfo(e,!1);var i=this.m_sceneLights.indexOf(e);this.m_sceneLights.splice(i,1);return}},t.prototype.RemoveAllLight=function(){this.m_sceneLights=[]},t.prototype.SetSceneManager=function(e){this.m_sceneManager=e},t.prototype.GetSceneManager=function(){return this.m_sceneManager},t.prototype.SetUp=function(t){this.m_directionalLightNumber=0,this.m_pointLightNumber=0,this.m_spotLightNumber=0,this.m_hemisphereLightNumber=0,this.m_state.Resize();var n=t.GetView().Clone(),r=0,i=0,s=0;this.m_sceneLights.length===0;for(var o=0;o<this.m_sceneLights.length;o++){var u=this.m_sceneLights[o];if(!u.IsTurnOn())continue;var a=u.GetLightSourceType(),f=this.GetLightUniform(u),l=u.GetIntensity(),c=u.GetLightColor().Multiply(l).Clone();if(a==e.LightType.LightType_Ambient)r+=c.r,i+=c.g,s+=c.b;else if(a==e.LightType.LightType_Directional){var h=f;h.color=c.Clone();var p=u.GetNodeWorldPosition(),d=void 0;u.IsInWorld()?d=n.Multiply(new e.Vector4(u.GetWorldDirection(),0)):d=u.GetWorldDirection(),d.Normalize(),h.direction=d;if(u.CastShadow()){var v=u.GetLightShadow();h.shadow=1,h.shadowBias=v.Bias(),h.shadowMapSize=v.GetMapSize(),h.shadowRadius=v.Radius()}this.m_state.directional.push(h),this.m_directionalLightNumber++}else if(a==e.LightType.LightType_Point){var m=f,g=u;m.color=c;var p=new e.Vector3;u.IsInWorld()?p=n.Multiply(new e.Vector4(u.GetNodeWorldPosition(),1)):p=u.GetNodeWorldPosition(),m.position=p,m.distance=g.Distance(),m.decay=g.Decay(),g.CastShadow(),this.m_state.point.push(m),this.m_pointLightNumber++}else if(a==e.LightType.LightType_Spot){var y=f,b=u;y.color=c,y.distance=b.Distance(),y.decay=b.Decay();var w=b.Angle()*e.DEGTORAD,E=b.Penumbra()*e.DEGTORAD;y.coneCos=Math.cos(w),y.penumbraCos=Math.cos(w*(1-E));var p=new e.Vector3,d=new e.Vector3;u.IsInWorld()?(p=n.Multiply(new e.Vector4(u.GetNodeWorldPosition(),1)),d=n.Multiply(new e.Vector4(u.GetWorldDirection(),1))):(p=u.GetNodeWorldPosition(),d=u.GetWorldDirection()),y.position=p.Clone(),d.Normalize(),y.direction=d.Clone(),b.CastShadow(),this.m_spotLightNumber++,this.m_state.spot.push(y)}else if(a==e.LightType.LightType_Hemisphere){var S=f,x=u,p=new e.Vector3;u.IsInWorld()?p=n.Multiply(new e.Vector4(u.GetNodeWorldPosition(),1)):p=u.GetNodeWorldPosition(),S.direction=p,S.direction.Normalize(),S.skyColor=c.Clone(),S.groundColor=x.GroundColor().Multiply(l).Clone(),this.m_hemisphereLightNumber++,this.m_state.hemisphere.push(S)}}this.m_state.ambient.x=r,this.m_state.ambient.y=i,this.m_state.ambient.z=s,this.m_state.hash=this.m_directionalLightNumber.toString()+","+this.m_pointLightNumber.toString()+","+this.m_spotLightNumber.toString()+","+this.m_hemisphereLightNumber.toString()},t.prototype.CreateDefaultLights=function(){if(this.m_sceneManager&&this.m_sceneManager.GetModel()){var t=this.m_sceneManager.GetModel().GetTotalWorldBoundingBox(),n=t.Center().Clone(),r=this.CreateLight(e.LightType.LightType_Ambient),i=this.CreateLight(e.LightType.LightType_Directional);if(i!==null&&i!==undefined){i.SetLightColor(e.Color.WHITE().Clone()),i.SetIntensity(.4);var s=new e.Vector3(-1,.4,.7);s.Normalized();var o=new e.Quaternion(new e.Vector3(0,0,1),s),u=n.Add(s.Multiply(t.Length()*.5));i.SetWorldRotation(o),i.SetWorldPosition(u),i.SetShowAllSign(!1),i.SetShowSimpleSign(!1),i.SetName("directionalLight"),this.AddLight(i)}var a=this.CreateLight(e.LightType.LightType_Directional);if(a!==null&&a!==undefined){a.SetLightColor(e.Color.WHITE().Clone()),a.SetIntensity(.3);var o=new e.Quaternion(new e.Vector3(0,0,1),new e.Vector3(1,.4,.7));a.SetWorldRotation(o),a.SetWorldPosition(n),a.SetShowAllSign(!1),a.SetShowSimpleSign(!1),a.SetName("directionalLigh1")}var f=this.CreateLight(e.LightType.LightType_Directional);if(f!==null&&f!==undefined){f.SetLightColor(e.Color.WHITE().Clone()),f.SetIntensity(.6);var o=new e.Quaternion(new e.Vector3(0,0,1),new e.Vector3(0,1,-1));f.SetWorldRotation(o),f.SetWorldPosition(n),f.SetShowAllSign(!1),f.SetShowSimpleSign(!1),f.SetName("directionalLigh1")}var l=this.CreateLight(e.LightType.LightType_Hemisphere);l!==null&&l!==undefined&&(l.SetIntensity(.5),l.SetWorldPosition(new e.Vector3(0,1,0)),l.SetLightColor(e.Color.WHITE().Clone()),l.SetGroundColor(e.Color.WHITE().Clone()),l.SetName("heimisphreLight"),l.SetShowAllSign(!1),this.AddLight(l));var c=this.CreateLight(e.LightType.LightType_Point);c!==null&&c!==undefined&&(c.SetIntensity(1),c.SetWorldPosition(n),c.SetLightColor(e.Color.WHITE().Clone()),c.SetDistance(2e3),c.SetDecay(1),c.SetName("poitLight"),c.SetShowAllSign(!1));var h=this.CreateLight(e.LightType.LightType_Spot);if(h!==null&&c!==undefined){h.SetIntensity(1);var p=new e.Vector3(1,1,1);p.Normalize(),h.SetWorldPosition(n.Add(p.Multiply(t.Length()*.2)));var o=new e.Quaternion(45,new e.Vector3(-1,0,0));h.SetLightColor(e.Color.WHITE().Clone()),h.SetDistance(2e3),h.SetDecay(1),h.SetAngle(30),h.SetPenumbra(15),h.SetWorldRotation(o),h.SetName("spotLight"),h.SetShowAllSign(!1)}}},t.prototype.CreateLight=function(t){var n=null;switch(t){case e.LightType.LightType_Base:n=new e.BaseLight;break;case e.LightType.LightType_Ambient:n=new e.AmbientLight;break;case e.LightType.LightType_Directional:n=new e.DirectionalLight;break;case e.LightType.LightType_Point:n=new e.PointLight;break;case e.LightType.LightType_Spot:n=new e.SpotLight;break;case e.LightType.LightType_Hemisphere:n=new e.HemisphereLight}return n},t.prototype.DirectionalLightNumber=function(){return this.m_directionalLightNumber},t.prototype.SetDirectionalLightNumber=function(e){this.m_directionalLightNumber=e},t.prototype.PointLightNumber=function(){return this.m_pointLightNumber},t.prototype.SetPointLightNumber=function(e){this.m_pointLightNumber=e},t.prototype.SpotLightNumber=function(){return this.m_spotLightNumber},t.prototype.SetSpotLightNumber=function(e){this.m_spotLightNumber=e},t.prototype.GetState=function(){return this.m_state},t.prototype.GetAllLight=function(){return this.m_sceneLights},t.prototype.HemisphereLightNumber=function(){return this.m_hemisphereLightNumber},t.prototype.SetHemisphereLightNumber=function(e){this.m_hemisphereLightNumber=e},t.prototype.GetLightUniform=function(t){if(!t)return null;var o=null,u=this.m_lightUniformCatch[t.GetID()];if(u!=null)return u;switch(t.GetLightSourceType()){case e.LightType.LightType_Directional:o=new n;break;case e.LightType.LightType_Point:o=new r;break;case e.LightType.LightType_Spot:o=new i;break;case e.LightType.LightType_Hemisphere:o=new s;break;default:}return this.m_lightUniformCatch[t.GetID()]=o,o},t.prototype.RemoveLightUniform=function(e){e&&delete this.m_lightUniformCatch[e.GetID()]},t}();e.LightManager=u})(M3D||(M3D={}));var M3D;(function(e){e.ShaderChunkStrings={},e.ShaderChunkStrings.begin_vertex=["vec3 transformed = vec3( a_position );"].join("\n"),e.ShaderChunkStrings.beginnormal_vertex=["vec3 objectNormal = vec3( a_normal );"].join("\n"),e.ShaderChunkStrings.bsdfs=["float punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {","	if( decayExponent > 0.0 ) {","#if defined ( PHYSICALLY_CORRECT_LIGHTS )","		// based upon Frostbite 3 Moving to Physically-based Rendering","		// page 32, equation 26: E[window1]","		// https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf","		// this is intended to be used on spot and point lights who are represented as luminous intensity","		// but who must be converted to luminous irradiance for surface lighting calculation","		float distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );","		float maxDistanceCutoffFactor = pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );","		return distanceFalloff * maxDistanceCutoffFactor;","#else","		return pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );","#endif","	}","	return 1.0;","}","vec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {","	return RECIPROCAL_PI * diffuseColor;","} // validated","vec3 F_Schlick( const in vec3 specularColor, const in float VdotH ) {","	// Original approximation by Christophe Schlick '94","	// float fresnel = pow( 1.0 - dotLH, 5.0 );","	// Optimized variant (presented by Epic at SIGGRAPH '13)","	// https://cdn2.unrealengine.com/Resources/files/2013SiggraphPresentationsNotes-26915738.pdf","  return specularColor + (1.0 - specularColor) * pow(clamp(1.0 - VdotH, 0., 1.), 5.0);","} // validated","vec3 fresnelSchlickRoughness(float dotNV, vec3 F0, float roughness)","{","    return F0 + (max(vec3(1.0 - roughness), F0) - F0) * pow(1.0 - dotNV, 5.0);","}","// Microfacet Models for Refraction through Rough Surfaces - equation (34)","// http://graphicrants.blogspot.com/2013/08/specular-brdf-reference.html","// alpha is 'roughness squared' in Disney’s reparameterization","float G_GGX_Smith( const in float alpha, const in float dotNL, const in float dotNV ) {","	// geometry term (normalized) = G(l)⋅G(v) / 4(n⋅l)(n⋅v)","	// also see #12151","	float a2 = pow2( alpha );","	float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );","	float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );","	return 1.0 / ( gl * gv );","} // validated","// Moving Frostbite to Physically Based Rendering 3.0 - page 12, listing 2","// https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf","float G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {","	float a2 = pow2( alpha );","	// dotNL and dotNV are explicitly swapped. This is not a mistake.","	float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );","	float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );","	return 0.5 / max( gv + gl, EPSILON );","}","// Microfacet Models for Refraction through Rough Surfaces - equation (33)","// http://graphicrants.blogspot.com/2013/08/specular-brdf-reference.html","// alpha is 'roughness squared' in Disney’s reparameterization","float D_GGX( const in float alpha, const in float dotNH ) {","	float a2 = pow2( alpha );","	float denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0; // avoid alpha = 0 with dotNH = 1","	return RECIPROCAL_PI * a2 / pow2( denom );","}","// GGX Distribution, Schlick Fresnel, GGX-Smith Visibility","vec3 BRDF_Specular_GGX( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ,out vec3 ks) {","	float alpha = pow2( roughness ); // UE4's roughness","	vec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );","	float dotNL = saturate( dot( geometry.normal, incidentLight.direction ) );","	float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );","	float dotNH = saturate( dot( geometry.normal, halfDir ) );","	float dotVH = saturate( dot( geometry.viewDir, halfDir ) );","	vec3 F = F_Schlick( specularColor, dotVH );","ks = F;","	float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );","	float D = D_GGX( alpha, dotNH );","	return F * ( G * D );","} // validated","// ref: https://www.unrealengine.com/blog/physically-based-shading-on-mobile - environmentBRDF for GGX on mobile","vec3 BRDF_Specular_GGX_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {","	float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );","	const vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );","	const vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );","	vec4 r = roughness * c0 + c1;","	float a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;","	vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;","	return specularColor * AB.x + AB.y;","} // validated","float G_BlinnPhong_Implicit( /* const in float dotNL, const in float dotNV */ ) {","	// geometry term is (n dot l)(n dot v) / 4(n dot l)(n dot v)","	return 0.25;","}","float D_BlinnPhong( const in float shininess, const in float dotNH ) {","	return RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );","}","vec3 BRDF_Specular_BlinnPhong( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {","	vec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );","	//float dotNL = saturate( dot( geometry.normal, incidentLight.direction ) );","	//float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );","	float dotNH = saturate( dot( geometry.normal, halfDir ) );","	float dotLH = saturate( dot( incidentLight.direction, halfDir ) );","	vec3 F = F_Schlick( specularColor, dotLH );","	float G = G_BlinnPhong_Implicit( /* dotNL, dotNV */ );","	float D = D_BlinnPhong( shininess, dotNH );","	return F * ( G * D );","} // validated","// source: http://simonstechblog.blogspot.ca/2011/12/microfacet-brdf.html","float GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {","	return ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );","}","float BlinnExponentToGGXRoughness( const in float blinnExponent ) {","	return sqrt( 2.0 / ( blinnExponent + 2.0 ) );","}","#if defined(PHYSICAL) ","vec3 BRDF_Specular_GGX_Environment_texture( const in GeometricContext geometry,const in vec3 specularColor, const in float roughness ) {","	float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );"," vec3 brdf = (texture2D(lut, vec2(dotNV, 1.0-roughness))).rgb;","	return specularColor * brdf.x + brdf.y;","} // validated","vec3 getSpecularDominantDir(const in vec3 N, const in vec3 R, const in float realRoughness)","{","	vec3 dominant;","   bool uSpecularPeak = true;","	if (uSpecularPeak == true) {","		float smoothness = 1.0 - realRoughness;","		float lerpFactor = smoothness * (sqrt(smoothness) + realRoughness);","		dominant = mix(N, R, lerpFactor);","	}","	else {","		dominant = R;","	}","	return dominant;","}","float occlusionHorizon(const in vec3 R, const in vec3 normal)","{","bool occlusion = true;","if (occlusion == false)","	return 1.0;","float factor = clamp(1.0 + dot(R, normal), 0.0, 1.0);","return factor * factor;","}","#endif"].join("\n"),e.ShaderChunkStrings.clip_fragment=["#if defined(USE_CLIP)","    if(u_enableClip)","    {","        float dPara = u_clipPlane.w;","        float testvalue = (dot(-vec3(vViewPosition.xyz),vec3(u_clipPlane.xyz))+dPara);","        if( testvalue<0.0)","        {","            discard;","        }","    }","#endif"].join("\n"),e.ShaderChunkStrings.clip_pars_fragment=["#if defined(USE_CLIP)","uniform vec4 u_clipPlane;","uniform bool u_enableClip;","//varying vec3 vViewPosition;","#endif "].join("\n"),e.ShaderChunkStrings.clip_pars_vertex=["#if defined(USE_CLIP) ","//varying vec3 vViewPosition;","#endif "].join("\n"),e.ShaderChunkStrings.common=["#define PI 3.14159265359","#define PI2 6.28318530718","#define PI_HALF 1.5707963267949","#define RECIPROCAL_PI 0.31830988618","#define RECIPROCAL_PI2 0.15915494","#define LOG2 1.442695","#define EPSILON 1e-6","#define saturate(a) clamp( a, 0.001, 1.0 )","#define whiteCompliment(a) ( 1.0 - saturate( a ) )","float pow2( const in float x ) { return x*x; }","float pow3( const in float x ) { return x*x*x; }","float pow4( const in float x ) { float x2 = x*x; return x2*x2; }","float average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }","// expects values in the range of [0,1]x[0,1], returns values in the [0,1] range.","// do not collapse into a single function per: http://byteblacksmith.com/improvements-to-the-canonical-one-liner-glsl-rand-for-opengl-es-2-0/","struct IncidentLight {","       vec3 color;","       vec3 direction;","       bool visible;","};","struct ReflectedLight {","       vec3 directDiffuse;","       vec3 directSpecular;","       vec3 indirectDiffuse;","       vec3 indirectSpecular;","};","struct GeometricContext {","       vec3 position;","       vec3 normal;","       vec3 viewDir;","};","vec3 transformDirection( in vec3 dir, in mat4 matrix ) {","       return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );","}","// http://en.wikibooks.org/wiki/GLSL_Programming/Applying_Matrix_Transformations","vec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {","       return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );","}","// https://en.wikipedia.org/wiki/Relative_luminance","float linearToRelativeLuminance( const in vec3 color ) {","       vec3 weights = vec3( 0.2126, 0.7152, 0.0722 );","       return dot( weights, color.rgb );","}"].join("\n"
),e.ShaderChunkStrings.defaultnormal_vertex=["vec3 transformedNormal = mat3(normalMatrix) * objectNormal;","#ifdef FLIP_SIDED","       transformedNormal = - transformedNormal;","#endif"].join("\n"),e.ShaderChunkStrings.lights_pars=[" uniform vec3 ambientLightColor;","vec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {","       vec3 irradiance = ambientLightColor;","       #ifndef PHYSICALLY_CORRECT_LIGHTS","               irradiance *= PI;","       #endif","       return irradiance;","}","#if NUM_DIR_LIGHTS > 0","       struct DirectionalLight {","               vec3 direction;","               vec3 color;","               int shadow;","               float shadowBias;","               float shadowRadius;","               vec2 shadowMapSize;","       };","       uniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];","#if defined(USE_LIGHT_MARK)","       uniform bool directionMark[ NUM_DIR_LIGHTS ];","#endif","       void getDirectionalDirectLightIrradiance( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight directLight ) {","               directLight.color = directionalLight.color;","               directLight.direction =normalize( vec3(/*viewMatrix**/vec4(directionalLight.direction,0.0)));","               directLight.visible = true;","       }","#endif","#if NUM_POINT_LIGHTS > 0","       struct PointLight {","               vec3 position;","               vec3 color;","               float distance;","               float decay;","               int shadow;","               float shadowBias;","               float shadowRadius;","               vec2 shadowMapSize;","               float shadowCameraNear;","               float shadowCameraFar;","       };","       uniform PointLight pointLights[ NUM_POINT_LIGHTS ];","#if defined(USE_LIGHT_MARK)","       uniform bool pointMark[ NUM_POINT_LIGHTS ];","#endif","       // directLight is an out parameter as having it as a return value caused compiler errors on some devices","       void getPointDirectLightIrradiance( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight directLight ) {","               vec3 lVector = vec3(/*viewMatrix**/vec4(pointLight.position,1.0)) - geometry.position;","               directLight.direction = normalize( lVector );","               float lightDistance = length( lVector );","               directLight.color = pointLight.color;","               directLight.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );","               directLight.visible = ( directLight.color != vec3( 0.0 ) );","       }","#endif","#if NUM_SPOT_LIGHTS > 0","       struct SpotLight {","               vec3 position;","               vec3 direction;","               vec3 color;","               float distance;","               float decay;","               float coneCos;","               float penumbraCos;","               int shadow;","               float shadowBias;","               float shadowRadius;","               vec2 shadowMapSize;","       };","       uniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];","#if defined(USE_LIGHT_MARK)","       uniform bool spotMark[ NUM_SPOT_LIGHTS ];","#endif","       // directLight is an out parameter as having it as a return value caused compiler errors on some devices","       void getSpotDirectLightIrradiance( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight directLight  ) {","               vec3 lVector = vec3(/*viewMatrix**/vec4(spotLight.position,1.0)) - geometry.position;","               directLight.direction = normalize( lVector );","               float lightDistance = length( lVector );","               float angleCos = dot( directLight.direction,normalize( vec3(/*viewMatrix**/vec4( spotLight.direction,0.0))) );","               if ( angleCos > spotLight.coneCos ) {","                       float spotEffect = smoothstep( spotLight.coneCos, spotLight.penumbraCos, angleCos );","                       directLight.color = spotLight.color;","                       directLight.color *= spotEffect * punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );","                       directLight.visible = true;","               } else {","                       directLight.color = vec3( 0.0 );","                       directLight.visible = false;","               }","       }","#endif","#if NUM_HEMI_LIGHTS > 0","		struct HemisphereLight {","				vec3 direction;","				vec3 skyColor;","				vec3 groundColor;","			};","			uniform HemisphereLight hemisphereLights[NUM_HEMI_LIGHTS];","			vec3 getHemisphereLightIrradiance(const in HemisphereLight hemiLight, const in GeometricContext geometry) {","				float dotNL = dot(geometry.normal, normalize(vec3(/*viewMatrix**/vec4(hemiLight.direction,0.0))));","				float hemiDiffuseWeight = 0.5 * dotNL + 0.5;","				vec3 irradiance = mix(hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight);","#ifndef PHYSICALLY_CORRECT_LIGHTS","				irradiance *= PI;","#endif","				return irradiance;","			}","#endif","#if defined( USE_ENV_TEXTURE ) && defined( PHYSICAL )","       vec3 getLightProbeIndirectIrradiance( /*const in SpecularLightProbe specularLightProbe,*/ const in GeometricContext geometry, const in int maxMIPLevel ) {","               vec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );","               #ifdef ENVTEXTURE_TYPE_CUBE","                       vec3 queryVec = vec3(  worldNormal.x, worldNormal.yz );","                       // TODO: replace with properly filtered cubemaps and access the irradiance LOD level, be it the last LOD level","                       // of a specular cubemap, or just the default level of a specially created irradiance cubemap.","                               // force the bias high to get the last LOD level as it is the most blurred.","                               vec4 envMapColor = textureCube( envDiffuseTexture, queryVec );","                       envMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;","               #else","                       vec4 envMapColor = vec4( 0.0 );","               #endif","               return PI * envMapColor.rgb * envMapIntensity;","       }","       // taken from here: http://casual-effects.blogspot.ca/2011/08/plausible-environment-lighting-in-two.html","       float getSpecularMIPLevel( const in float blinnShininessExponent, const in int maxMIPLevel ) {","               //float envMapWidth = pow( 2.0, maxMIPLevelScalar );","               //float desiredMIPLevel = log2( envMapWidth * sqrt( 3.0 ) ) - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );","               float maxMIPLevelScalar = float( maxMIPLevel );","               float desiredMIPLevel = maxMIPLevelScalar + 0.79248 - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );","               // clamp to allowable LOD ranges.","               return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );","       }","		float linRoughnessToMipmap(float roughnessLinear,const in int maxMIPLevel)","		{","           float maxMIPLevelScalar = float( maxMIPLevel );","			return sqrt(roughnessLinear)*(maxMIPLevelScalar - 1.0);","		}","       vec3 getLightProbeIndirectRadiance( /*const in SpecularLightProbe specularLightProbe,*/ const in GeometricContext geometry, const in float blinnShininessExponent, const in int maxMIPLevel ) {","               #ifdef ENVTEXTURE_MODE_REFLECTION","                       vec3 reflectVec = reflect( -geometry.viewDir, geometry.normal );","               #else","                       vec3 reflectVec = refract( -geometry.viewDir, geometry.normal, refractionRatio );","               #endif","               reflectVec = inverseTransformDirection( reflectVec, viewMatrix );","               float specularMIPLevel = linRoughnessToMipmap( blinnShininessExponent, maxMIPLevel );","#ifdef USE_LOCAL_CUBEMAP","reflectVec = GetParallaxCorrectedReflect( normalize(reflectVec), boxMax, boxMin, cubeMapWorldPosition, vWorldPosition);","#endif","               #ifdef ENVTEXTURE_TYPE_CUBE","                       vec3 queryReflectVec = vec3(  reflectVec.x, reflectVec.yz );","                       #ifdef TEXTURE_LOD_EXT","                               vec4 envMapColor = textureCubeLodEXT( envTexture, queryReflectVec, specularMIPLevel );","                       #else","                               vec4 envMapColor = textureCube( envTexture, queryReflectVec, specularMIPLevel );","                       #endif","                       envMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;","               #elif defined( ENVMAP_TYPE_EQUIREC )","                       vec2 sampleUV;","                       sampleUV.y = asin( clamp( reflectVec.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;","                       sampleUV.x = atan( reflectVec.z, reflectVec.x ) * RECIPROCAL_PI2 + 0.5;","                       #ifdef TEXTURE_LOD_EXT","                               vec4 envMapColor = texture2DLodEXT( envTexture, sampleUV, specularMIPLevel );","                       #else","                               vec4 envMapColor = texture2D( envTexture, sampleUV, specularMIPLevel );","                       #endif","                       envMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;","               #elif defined( ENVMAP_TYPE_SPHERE )","                       vec3 reflectView = normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0,0.0,1.0 ) );","                       #ifdef TEXTURE_LOD_EXT","                               vec4 envMapColor = texture2DLodEXT( envTexture, reflectView.xy * 0.5 + 0.5, specularMIPLevel );","                       #else","                               vec4 envMapColor = texture2D( envTexture, reflectView.xy * 0.5 + 0.5, specularMIPLevel );","                       #endif","                       envMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;","               #endif","               return envMapColor.rgb * envMapIntensity;","       }","#endif"].join("\n"),e.ShaderChunkStrings.lights_phong_fragment=["BlinnPhongMaterial material;","material.diffuseColor = diffuseColor.rgb;","material.specularColor = specular.rgb;","material.specularShininess = shininess;","material.specularStrength = specularStrength;"].join("\n"),e.ShaderChunkStrings.lights_phong_pars_fragment=["varying vec3 vViewPosition;","#ifndef FLAT_SHADED","       varying vec3 vNormal;","#endif","struct BlinnPhongMaterial {","       vec3    diffuseColor;","       vec3    specularColor;","       float   specularShininess;","       float   specularStrength;","};","void RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {","               float dotNL = saturate( dot( geometry.normal, directLight.direction ) );","               vec3 irradiance = dotNL * directLight.color;","        #ifndef PHYSICALLY_CORRECT_LIGHTS","             irradiance *= PI; // punctual light","        #endif","       reflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );","       reflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess ) * material.specularStrength;","}","void RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {","       reflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );","}"," #define RE_Direct                           RE_Direct_BlinnPhong"," #define RE_IndirectDiffuse          RE_IndirectDiffuse_BlinnPhong","#define Material_LightProbeLOD( material )     (0)"].join("\n"),e.ShaderChunkStrings.lights_template=["/**"," * This is a template that can be used to light a material, it uses pluggable"," * RenderEquations (RE)for specific lighting scenarios."," *"," * Instructions for use:"," * - Ensure that both RE_Direct, RE_IndirectDiffuse and RE_IndirectSpecular are defined"," * - If you have defined an RE_IndirectSpecular, you need to also provide a Material_LightProbeLOD. <---- ???"," * - Create a material parameter that is to be passed as the third parameter to your lighting functions."," *"," * TODO:"," * - Add area light support."," * - Add sphere light support."," * - Add diffuse light probe (irradiance cubemap) support."," */","GeometricContext geometry;","geometry.position = - vViewPosition;","geometry.normal = normal;","geometry.viewDir = normalize( vViewPosition );","IncidentLight directLight;","vec4 coord = vec4(1.0,0.0,0.0,1.0);","#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )","       PointLight pointLight;","       for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {","#if defined(USE_LIGHT_MARK)","               if(pointMark[ i ] == true){","#endif","			pointLights[ i ].position;","			pointLights[ i ].color;","			pointLights[ i ].distance;","			pointLights[ i ].decay;","			pointLights[ i ].shadow;","			pointLights[ i ].shadowBias;","			pointLights[ i ].shadowRadius;","			pointLights[ i ].shadowMapSize;","			pointLights[ i ].shadowCameraNear;","			pointLights[ i ].shadowCameraFar;","               pointLight = pointLights[ i ];","               getPointDirectLightIrradiance( pointLight, geometry, directLight );","//coord = vPointShadowCoord[i];","       #ifdef USE_SHADOWMAP","               vec3 lVector = pointLight.position - geometry.position;","               float bias = max(pointLight.shadowBias*10.0*(1.0-dot(normalize(lVector), geometry.normal)), pointLight.shadowBias);","               directLight.color *= bool(pointLight.shadow)?(getPointShadow(pointShadowMap[i],pointLight.shadowMapSize, bias, pointLight.shadowRadius, vPointShadowCoord[i],pointLight.shadowCameraNear, pointLight.shadowCameraFar)):1.0 ;","       #endif","               RE_Direct( directLight, geometry, material, reflectedLight );","#if defined(USE_LIGHT_MARK)","   }","#endif"," }","#endif","#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )","       SpotLight spotLight;","       for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {","			spotLights[ i ].position;","			spotLights[ i ].direction;","			spotLights[ i ].color;","			spotLights[ i ].distance;","			spotLights[ i ].decay;","			spotLights[ i ].coneCos;","			spotLights[ i ].penumbraCos;","			spotLights[ i ].shadow;","			spotLights[ i ].shadowBias;","			spotLights[ i ].shadowRadius;","			spotLights[ i ].shadowMapSize;","               spotLight = spotLights[ i ];","#if defined(USE_LIGHT_MARK)","               if(spotMark[ i ] == true){","#endif","               getSpotDirectLightIrradiance( spotLight, geometry, directLight );","       #ifdef USE_SHADOWMAP","               vec3 lVector = spotLight.position - geometry.position;","               float bias = max(spotLight.shadowBias*3.0*(1.0-dot(normalize(lVector), geometry.normal)), spotLight.shadowBias);","               directLight.color *= bool(spotLight.shadow)?(getShadow(spotShadowMap[i],spotLight.shadowMapSize, bias, spotLight.shadowRadius, vSpotShadowCoord[i])):1.0 ;","       #endif","               RE_Direct( directLight, geometry, material, reflectedLight );","#if defined(USE_LIGHT_MARK)","   }","#endif","}","#endif","float ss = 1.0;","#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )","       DirectionalLight directionalLight;","       for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {","             directionalLights[ i ] . direction;","             directionalLights[ i ] . color;","             directionalLights[ i ] . shadow;","             directionalLights[ i ] . shadowBias;","             directionalLights[ i ] . shadowRadius;","             directionalLights[ i ] . shadowMapSize;","               directionalLight = directionalLights[ i ];","#if defined(USE_LIGHT_MARK)","               if(directionMark[ i ] == true){","#endif","               getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );","        #ifdef USE_SHADOWMAP","               vec3 lVector = directionalLight.direction;","               float bias = max(directionalLight.shadowBias*10.0*(1.0-dot(normalize(lVector), geometry.normal)), directionalLight.shadowBias);","               directLight.color *=bool( directionalLight.shadow)?(getShadow(directionalShadowMap[i],directionalLight.shadowMapSize,bias, directionalLight.shadowRadius,    vDirectionalShadowCoord[i])):1.0 ;","        #endif","               RE_Direct( directLight, geometry, material, reflectedLight );","#if defined(USE_LIGHT_MARK)","   }","#endif","}","#endif","#if defined( RE_IndirectDiffuse )","       vec3 irradiance = getAmbientLightIrradiance( ambientLightColor );","#if ( NUM_HEMI_LIGHTS > 0 )","	for (int i = 0; i < NUM_HEMI_LIGHTS; i++) {","		hemisphereLights[i].direction;","		hemisphereLights[i].skyColor;","		hemisphereLights[i].groundColor;","		irradiance += getHemisphereLightIrradiance(hemisphereLights[i], geometry);","	}","#endif","       #if defined( USE_ENV_TEXTURE ) && defined( PHYSICAL )","               // TODO, replace 8 with the real maxMIPLevel","              // irradiance = vec3(0.0);","               irradiance += getLightProbeIndirectIrradiance( /*lightProbe,*/ geometry, 9 );","       #endif","       RE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );","#if defined(USE_MATCAPMAP) && !defined(PHYSICAL)","irradiance = GetMatcapIndirectLight(geometry);","reflectedLight.indirectDiffuse = (irradiance) /** (material.diffuseColor)*/;","#endif","#endif","#if defined( USE_ENV_TEXTURE ) && defined( RE_IndirectSpecular )","       // TODO, replace 8 with the real maxMIPLevel","       vec3 radiance = getLightProbeIndirectRadiance( /*specularLightProbe,*/ geometry, ( material.specularRoughness ), 9 );","   #ifndef STANDARD","   vec3 clearCoatRadiance = getLightProbeIndirectRadiance( /*specularLightProbe,*/ geometry, ( material.clearCoatRoughness ), 9 );","   #else","   vec3 clearCoatRadiance = vec3( 0.0 );","   #endif","   RE_IndirectSpecular( radiance, clearCoatRadiance, geometry, material, reflectedLight );","#endif"].join("\n"),e.ShaderChunkStrings.normalmap_pars_fragment=["#ifdef USE_NORMALMAP","uniform sampler2D normalMap;","uniform vec2 normalScale;","vec3 perturbNormal2Arb(vec3 eye_pos, vec3 surf_norm) {","	vec3 q0 = vec3(dFdx(eye_pos.x), dFdx(eye_pos.y), dFdx(eye_pos.z));","	vec3 q1 = vec3(dFdy(eye_pos.x), dFdy(eye_pos.y), dFdy(eye_pos.z));","	vec2 st0 = dFdx(vUv.st);","	vec2 st1 = dFdy(vUv.st);","	vec3 S = normalize(q0 * st1.t - q1 * st0.t);","	vec3 T = normalize(-q0 * st1.s + q1 * st0.s);","	vec3 N = normalize(surf_norm);","	vec3 mapN = texture2D(normalMap, vUv).xyz * 2.0 - 1.0;","	mapN.xy = normalScale * mapN.xy;","	mat3 tsn = mat3(S, T, N);","	return normalize(tsn * mapN);","}","#endif"].join("\n"),e.ShaderChunkStrings.normal_fragment=["#ifdef FLAT_SHADED","       // Workaround for Adreno/Nexus5 not able able to do dFdx( vViewPosition ) ...","       vec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );","       vec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );","       vec3 normal = normalize( cross( fdx, fdy ) );","#else","       vec3 normal = normalize( vNormal );","       #ifdef DOUBLE_SIDED","               normal = normal * ( float( gl_FrontFacing ) * 2.0 - 1.0 );","       #endif","#endif","#ifdef USE_NORMALMAP","       normal = perturbNormal2Arb( -vViewPosition, normal );","#elif defined( USE_BUMPMAP )","       normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );","#endif"].join("\n"),e.ShaderChunkStrings.project_vertex=["vec4 mvPosition = viewMatrix*modelMatrix * vec4( transformed, 1.0 );","gl_Position = projectionMatrix * mvPosition;"].join("\n"),e.ShaderChunkStrings.specularmap_fragment=["float specularStrength;","#ifdef USE_SPECULARMAP","       vec4 texelSpecular = texture2D( specularMap, vUv );","       specularStrength = texelSpecular.r;","#else","       specularStrength = 1.0;","#endif"].join("\n"),e.ShaderChunkStrings.specularmap_pars_fragment=["#ifdef USE_SPECULARMAP","       uniform sampler2D specularMap;","#endif"].join("\n"),e.ShaderChunkStrings.uv_pars_fragment=["#if defined( USE_DIFFUSEMAP) || defined(USE_AOMAP) || defined(USE_EMISSIVEMAP)||defined(USE_NORMALMAP)||defined(USE_SPECULARMAP)||defined(USE_METALLIC_ROUGHNESS_TEXTURE)","    varying vec2 vUv;   ","#endif"].join("\n"),e.ShaderChunkStrings.uv_pars_vertex=["#if defined( USE_DIFFUSEMAP) || defined(USE_AOMAP) || defined(USE_EMISSIVEMAP)||defined(USE_NORMALMAP)||defined(USE_SPECULARMAP)||defined(USE_METALLIC_ROUGHNESS_TEXTURE)","    varying vec2 vUv;","    uniform mat3 uvTransform;","#endif"].join("\n"),e.ShaderChunkStrings.worldpos_vertex=["#if defined( USE_ENV_TEXTURE ) ||defined ( DISTANCE ) ||defined ( USE_SHADOWMAP )","       vec4 worldPosition = modelMatrix * vec4( transformed, 1.0 );","#endif"].join("\n"),e.ShaderChunkStrings.uv_vertex=["#if defined( USE_DIFFUSEMAP ) || defined( USE_BUMP_TEXTURE ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHA_TEXTURE ) || defined( USE_EMISSIVEMAP ) || defined( USE_METALLIC_ROUGHNESS_TEXTURE )","       vUv = ( uvTransform* vec3( a_texCoords.xy,1.0) ).xy;","#endif"].join("\n"),e.ShaderChunkStrings.map_pars_fragment=["#ifdef USE_DIFFUSEMAP","       uniform sampler2D diffuseTexture;","#endif"].join("\n"),e.ShaderChunkStrings.map_fragment=["#ifdef USE_DIFFUSEMAP","       vec4 texelColor = texture2D( diffuseTexture, vUv );","       texelColor = mapTexelToLinear( texelColor );","       diffuseColor *= texelColor;","#endif"].join("\n"),e.ShaderChunkStrings.metallicRoughness_pars_fragment=["#ifdef USE_METALLIC_ROUGHNESS_TEXTURE","   uniform sampler2D metallicRoughnessTexture;","#endif"].join("\n"),e.ShaderChunkStrings.metallicRoughness_fragment=["float roughnessFactor = roughness;","float metalnessFactor = metalness;","#ifdef USE_METALLIC_ROUGHNESS_TEXTURE","vec4 mrSample = texture2D( metallicRoughnessTexture, vUv );","roughnessFactor *= mrSample.g;","metalnessFactor *= mrSample.b;","#endif"].join("\n"),e.ShaderChunkStrings.lights_physical_pars_fragment=["struct PhysicalMaterial {","       vec3    diffuseColor;","       float   specularRoughness;","       float   metalness;","       vec3    specularColor;","	    #ifndef STANDARD","       float clearCoat;","       float clearCoatRoughness;","       #endif","};","#define MAXIMUM_SPECULAR_COEFFICIENT 0.16","#define DEFAULT_SPECULAR_COEFFICIENT 0.04","// Clear coat directional hemishperical reflectance (this approximation should be improved)","float clearCoatDHRApprox( const in float roughness, const in float dotNL ) {","       float F0 = DEFAULT_SPECULAR_COEFFICIENT;	float Fc = pow(1.0 - dotNL, 5.0);	float F = Fc + (1.0 - Fc) * F0;   return F;","}","void RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {","       float dotNL = saturate( dot( geometry.normal, directLight.direction ) );","       vec3 irradiance = dotNL * directLight.color;","       #ifndef PHYSICALLY_CORRECT_LIGHTS","               irradiance *= PI; // punctual light","       #endif","       #ifndef STANDARD","  vec3 halfDir = normalize(directLight.direction + geometry.viewDir);"," float dotVH = saturate(dot(geometry.viewDir, halfDir));","       float clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotVH );","       #else","       float clearCoatDHR = 0.0;","       #endif","		vec3 ks = vec3(0.0);","       reflectedLight.directSpecular +=  ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Specular_GGX( directLight, geometry, material.specularColor, material.specularRoughness,ks);","       reflectedLight.directDiffuse +=  ( 1.0 - clearCoatDHR )*(1.0-ks) * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );","       #ifndef STANDARD","       reflectedLight.directSpecular += irradiance * material.clearCoat * BRDF_Specular_GGX(directLight, geometry, vec3(DEFAULT_SPECULAR_COEFFICIENT), material.clearCoatRoughness,ks);","       #endif","}","void RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {","       float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );","       vec3 ks = fresnelSchlickRoughness(dotNV,material.specularColor,material.specularRoughness);","       reflectedLight.indirectDiffuse += irradiance *(1.0-ks)* BRDF_Diffuse_Lambert( material.diffuseColor );","}","void RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 clearCoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {","       #ifndef STANDARD","       float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );","       float dotNL = dotNV;","       float clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );","       #else","               float clearCoatDHR = 0.0;","       #endif","       reflectedLight.indirectSpecular += ( 1.0 - clearCoatDHR )* radiance * BRDF_Specular_GGX_Environment_texture( geometry, material.specularColor, material.specularRoughness );","	    #ifndef STANDARD","       reflectedLight.indirectSpecular += clearCoatRadiance * material.clearCoat * BRDF_Specular_GGX_Environment_texture(geometry, vec3(DEFAULT_SPECULAR_COEFFICIENT), material.clearCoatRoughness);","       #endif","}","#define RE_Direct                              RE_Direct_Physical","#define RE_Direct_RectArea             RE_Direct_RectArea_Physical","#define RE_IndirectDiffuse             RE_IndirectDiffuse_Physical","#define RE_IndirectSpecular            RE_IndirectSpecular_Physical","#define Material_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.specularRoughness )","#define Material_ClearCoat_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.clearCoatRoughness )","// ref: https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf","float computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {","       return saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );","}"].join("\n"),e.ShaderChunkStrings.lights_physical_fragment=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );","material.specularRoughness = clamp( roughnessFactor, 0.04, 1.0 );","#ifdef STANDARD","material.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor.rgb, metalnessFactor );","#else","material.specularColor = mix( vec3( MAXIMUM_SPECULAR_COEFFICIENT * pow2( reflectivity ) ), diffuseColor.rgb, metalnessFactor );","material.clearCoat = saturate( clearCoat );","material.clearCoatRoughness = clamp( clearCoatRoughness, 0.04, 1.0 );","#endif","material.metalness = metalness;"].join("\n"),e.ShaderChunkStrings.envmap_pars_vertex=["#ifdef USE_ENV_TEXTURE","       #if defined( USE_BUMP_TEXTURE ) || defined( USE_NORMALMAP ) || defined( PHONG )","               varying vec3 vWorldPosition;","       #else","               varying vec3 vReflect;","               uniform float refractionRatio;","       #endif","#endif"].join("\n"),e.ShaderChunkStrings.envmap_vertex=["#ifdef USE_ENV_TEXTURE","       #if defined( USE_BUMP_TEXTURE ) || defined( USE_NORMALMAP ) || defined( PHONG )","               vWorldPosition = worldPosition.xyz;","       #else","               vec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );","               vec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );","               #ifdef ENVTEXTURE_MODE_REFLECTION","                       vReflect = reflect( cameraToVertex, worldNormal );","               #else","                       vReflect = refract( cameraToVertex, worldNormal, refractionRatio );","               #endif","       #endif","#endif"].join("\n"),e.ShaderChunkStrings.envmap_pars_fragment=["#if defined( USE_ENV_TEXTURE ) || defined( PHYSICAL )","       float reflectivity = 0.5;","       uniform float envMapIntensity;","#endif","#ifdef USE_ENV_TEXTURE","       #if ! defined( PHYSICAL ) && ( defined( USE_BUMP_TEXTURE ) || defined( USE_NORMALMAP ) || defined( PHONG ) )","               varying vec3 vWorldPosition;","       #endif","       #ifdef ENVTEXTURE_TYPE_CUBE","               uniform samplerCube envTexture;","               #if defined( PHYSICAL ) ","               uniform samplerCube envDiffuseTexture;","               #endif","       #else","               uniform sampler2D envTexture;","       #endif","       uniform float flipEnvMap;","       #if defined( USE_BUMP_TEXTURE ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( PHYSICAL )","               uniform float refractionRatio;","       #else","               varying vec3 vReflect;","       #endif","#endif"].join("\n"),e.ShaderChunkStrings.envmap_fragment=["#ifdef USE_ENV_TEXTURE","       #if defined( USE_BUMP_TEXTURE ) || defined( USE_NORMALMAP ) || defined( PHONG )","               vec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );","               // Transforming Normal Vectors with the Inverse Transformation","               vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );","               #ifdef ENVTEXTURE_MODE_REFLECTION","                       vec3 reflectVec = reflect( cameraToVertex, worldNormal );","               #else","                       vec3 reflectVec = refract( cameraToVertex, worldNormal, refractionRatio );","               #endif","       #else","               vec3 reflectVec = vReflect;","       #endif","       #ifdef ENVTEXTURE_TYPE_CUBE","               vec4 envColor = textureCube( envTexture, vec3(  reflectVec.x, reflectVec.yz ) );","       #elif defined( ENVMAP_TYPE_EQUIREC )","               vec2 sampleUV;","               reflectVec = normalize( reflectVec );","               sampleUV.y = asin( clamp( reflectVec.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;","               sampleUV.x = atan( reflectVec.z, reflectVec.x ) * RECIPROCAL_PI2 + 0.5;","               vec4 envColor = texture2D( envTexture, sampleUV );","       #elif defined( ENVMAP_TYPE_SPHERE )","               reflectVec = normalize( reflectVec );","               vec3 reflectView = normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0, 0.0, 1.0 ) );","               vec4 envColor = texture2D( envTexture, reflectView.xy * 0.5 + 0.5 );","       #else","               vec4 envColor = vec4( 0.0 );","       #endif","       envColor = envMapTexelToLinear( envColor );","       #ifdef ENVMAP_BLENDING_MULTIPLY","               outgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );","       #elif defined( ENVMAP_BLENDING_MIX )","               outgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );","       #elif defined( ENVMAP_BLENDING_ADD )","               outgoingLight += envColor.xyz * specularStrength * reflectivity;","       #endif","#endif"].join("\n"),e.ShaderChunkStrings.packing=["vec3 packNormalToRGB( const in vec3 normal ) {","       return normalize( normal ) * 0.5 + 0.5;","}","vec3 unpackRGBToNormal( const in vec3 rgb ) {","       return 2.0 * rgb.xyz - 1.0;","}","const float PackUpscale = 256. / 255.; // fraction -> 0..1 (including 1)","const float UnpackDownscale = 255. / 256.; // 0..1 -> fraction (excluding 1)","const vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );","const vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );","const float ShiftRight8 = 1. / 256.;","vec4 packDepthToRGBA( const in float v ) {","       vec4 r = vec4( fract( v * PackFactors ), v );","       r.yzw -= r.xyz * ShiftRight8; // tidy overflow","       return r * PackUpscale;","}","float unpackRGBAToDepth( const in vec4 v ) {","       return dot( v, UnpackFactors );","}","// NOTE: viewZ/eyeZ is < 0 when in front of the camera per OpenGL conventions","float viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {","       return ( viewZ + near ) / ( near - far );","}","float orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {","       return linearClipZ * ( near - far ) - near;","}","float viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {","       return (( near + viewZ ) * far ) / (( far - near ) * viewZ );"
,"}","float perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {","       return ( near * far ) / ( ( far - near ) * invClipZ - far );","}"].join("\n"),e.ShaderChunkStrings.shadowmap_vertex=["#ifdef USE_SHADOWMAP","       #if NUM_DIR_LIGHTS > 0","       for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {","               vDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * worldPosition;","       }","       #endif","       #if NUM_SPOT_LIGHTS > 0","       for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {","               vSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * worldPosition;","       }","       #endif","       #if NUM_POINT_LIGHTS > 0","       for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {","               vPointShadowCoord[ i ] = pointShadowMatrix[ i ] * worldPosition;","       }","       #endif","#endif"].join("\n"),e.ShaderChunkStrings.shadowmap_pars_vertex=["#ifdef USE_SHADOWMAP","       #if NUM_DIR_LIGHTS > 0","               uniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHTS ];","               varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];","       #endif","       #if NUM_SPOT_LIGHTS > 0","               uniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHTS ];","               varying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];","       #endif","       #if NUM_POINT_LIGHTS > 0","               uniform mat4 pointShadowMatrix[ NUM_POINT_LIGHTS ];","               varying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];","       #endif","#endif"].join("\n"),e.ShaderChunkStrings.shadowmap_pars_fragment=["#ifdef USE_SHADOWMAP","       #if NUM_DIR_LIGHTS > 0","               uniform sampler2D directionalShadowMap[ NUM_DIR_LIGHTS ];","               varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];","       #endif","       #if NUM_SPOT_LIGHTS > 0","               uniform sampler2D spotShadowMap[ NUM_SPOT_LIGHTS ];","               varying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];","       #endif","       #if NUM_POINT_LIGHTS > 0","               uniform sampler2D pointShadowMap[ NUM_POINT_LIGHTS ];","               varying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];","       #endif","       float texture2DCompare( sampler2D depths, vec2 uv, float compare ) {","               return step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );","       }","       float texture2DShadowLerp( sampler2D depths, vec2 size, vec2 uv, float compare ) {","               const vec2 offset = vec2( 0.0, 1.0 );","               vec2 texelSize = vec2( 1.0 ) / size;","               vec2 centroidUV = floor( uv * size + 0.5 ) / size;","               float lb = texture2DCompare( depths, centroidUV + texelSize * offset.xx, compare );","               float lt = texture2DCompare( depths, centroidUV + texelSize * offset.xy, compare );","               float rb = texture2DCompare( depths, centroidUV + texelSize * offset.yx, compare );","               float rt = texture2DCompare( depths, centroidUV + texelSize * offset.yy, compare );","               vec2 f = fract( uv * size + 0.5 );","               float a = mix( lb, lt, f.y );","               float b = mix( rb, rt, f.y );","               float c = mix( a, b, f.x );","               return c;","       }","       float getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {","               float shadow = 1.0;","               shadowCoord.xyz /= shadowCoord.w;","               shadowCoord.z -= shadowBias;","               // if ( something && something ) breaks ATI OpenGL shader compiler","               // if ( all( something, something ) ) using this instead","               bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","               bool inFrustum = all( inFrustumVec );","               bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );","               bool frustumTest = all( frustumTestVec );","               if ( frustumTest ) {","               #if defined( SHADOWMAP_TYPE_PCF )","                       vec2 texelSize = vec2( 1.0 ) / shadowMapSize;","                       float dx0 = - texelSize.x * shadowRadius;","                       float dy0 = - texelSize.y * shadowRadius;","                       float dx1 = + texelSize.x * shadowRadius;","                       float dy1 = + texelSize.y * shadowRadius;","                       shadow = (","                               texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +","                               texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +","                               texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +","                               texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +","                               texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +","                               texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +","                               texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +","                               texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +","                               texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )","                       ) * ( 1.0 / 9.0 );","               #elif defined( SHADOWMAP_TYPE_PCF_SOFT )","                       vec2 texelSize = vec2( 1.0 ) / shadowMapSize;","                       float dx0 = - texelSize.x * shadowRadius;","                       float dy0 = - texelSize.y * shadowRadius;","                       float dx1 = + texelSize.x * shadowRadius;","                       float dy1 = + texelSize.y * shadowRadius;","                       shadow = (","                               texture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +","                               texture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +","                               texture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +","                               texture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +","                               texture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy, shadowCoord.z ) +","                               texture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +","                               texture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +","                               texture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +","                               texture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )","                       ) * ( 1.0 / 9.0 );","               #else // no percentage-closer filtering:","                       shadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );","               #endif","               }","               if(shadowCoord.z>1.0)","               {","                   shadow = 1.0;","               ","               }","               return shadow;","       }","       // cubeToUV() maps a 3D direction vector suitable for cube texture mapping to a 2D","       // vector suitable for 2D texture mapping. This code uses the following layout for the","       // 2D texture:","       //","       // xzXZ","       //  y Y","       //","       // Y - Positive y direction","       // y - Negative y direction","       // X - Positive x direction","       // x - Negative x direction","       // Z - Positive z direction","       // z - Negative z direction","       //","       // Source and test bed:","       // https://gist.github.com/tschw/da10c43c467ce8afd0c4","       vec2 cubeToUV( vec3 v, float texelSizeY ) {","               // Number of texels to avoid at the edge of each square","               vec3 absV = abs( v );","               // Intersect unit cube","               float scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );","               absV *= scaleToCube;","               // Apply scale to avoid seams","               // two texels less per square (one texel will do for NEAREST)","               v *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );","               // Unwrap","               // space: -1 ... 1 range for each square","               //","               // #X##         dim    := ( 4 , 2 )","               //  # #         center := ( 1 , 1 )","               vec2 planar = v.xy;","               float almostATexel = 1.5 * texelSizeY;","               float almostOne = 1.0 - almostATexel;","               if ( absV.z >= almostOne ) {","                       if ( v.z > 0.0 )","                               planar.x = 4.0 - v.x;","               } else if ( absV.x >= almostOne ) {","                       float signX = sign( v.x );","                       planar.x = v.z * signX + 2.0 * signX;","               } else if ( absV.y >= almostOne ) {","                       float signY = sign( v.y );","                       planar.x = v.x + 2.0 * signY + 2.0;","                       planar.y = v.z * signY - 2.0;","               }","               // Transform to UV space","               // scale := 0.5 / dim","               // translate := ( center + 0.5 ) / dim","               return vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );","       }","       float getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {","               vec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );","               // for point lights, the uniform @vShadowCoord is re-purposed to hold","               // the vector from the light to the world-space position of the fragment.","               vec3 lightToPosition = shadowCoord.xyz;","               // dp = normalized distance from light to fragment position","               float  dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );","		        dp -= shadowBias;","               // bd3D = base direction 3D","               vec3 bd3D = normalize( lightToPosition );","               #if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT )","                       vec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;","                       return (","                               texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +","                               texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +","                               texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +","                               texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +","                               texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +","                               texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +","                               texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +","                               texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +","                               texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )","                       ) * ( 1.0 / 9.0 );","               #else // no percentage-closer filtering","                       return texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );","               #endif","       }","#endif"].join("\n"),e.ShaderChunkStrings.z_depth_pars_vert=["#ifdef USE_DEPTH_TEXTURE_CULL","uniform mat4 zMatrix;","varying vec4 zCoords;","#endif"].join("\n"),e.ShaderChunkStrings.z_depth_pars_frag=["#ifdef USE_DEPTH_TEXTURE_CULL","varying vec4 zCoords;","uniform sampler2D zDepth;","#endif"].join("\n"),e.ShaderChunkStrings.z_depth_vert=["#ifdef USE_DEPTH_TEXTURE_CULL","zCoords = zMatrix * worldPosition;","#endif"].join("\n"),e.ShaderChunkStrings.z_depth_frag=["#ifdef USE_DEPTH_TEXTURE_CULL","vec4 temZcoords = zCoords;","temZcoords.xyz /= temZcoords.w;","float zdepth =unpackRGBAToDepth(texture2D(zDepth, temZcoords.xy));","if(gl_FragCoord.z>zdepth+0.000005)","   discard;","#endif"].join("\n"),e.ShaderChunkStrings.tonemapping_pars_fragment=["uniform float toneMappingExposure;","#define Uncharted2Helper(x) max(((x * (0.15 * x + 0.10 * 0.50) + 0.20 * 0.02) / (x * (0.15 * x + 0.50) + 0.20 * 0.30)) - 0.02 / 0.30, vec3(0.0))","vec3 Uncharted2ToneMapping(vec3 color ) {"," color *= toneMappingExposure;"," return saturate(Uncharted2Helper(color) / Uncharted2Helper(vec3(1.0/*toneMappingWhitePoint*/)));","}","vec3 OptimizedCineonToneMapping(vec3 color ) {","   color *= toneMappingExposure;","  color = max(vec3(0.0), color - 0.004);","   return pow((color * (6.2 * color + 0.5)) / (color * (6.2 * color + 1.7) + 0.06), vec3(2.2));","}"].join("\n"),e.ShaderChunkStrings.tonemapping_fragment=["#if defined(TONE_MAPPING)","   gl_FragColor.rgb = OptimizedCineonToneMapping(gl_FragColor.rgb);","#endif"].join("\n"),e.ShaderChunkStrings.clip_pars_fragment=["#if defined(USE_CLIP)","uniform vec4 u_clipPlanes[3];","uniform bool u_enableClips[3];","uniform bool u_reverseClip;","#endif"].join("\n"),e.ShaderChunkStrings.clip_fragment=["#if defined(USE_CLIP)","if (u_reverseClip)","{","	int iEnableNum = 0;","	int iClipNum = 0;","	for (int i = 0; i < 3; i++)","	{","		if (u_enableClips[i])","		{","			iEnableNum++;","			float dPara = u_clipPlanes[i].w;","			if ((dot(-vec3(vViewPosition.xyz), vec3(u_clipPlanes[i].xyz)) + dPara) > 0.0)","			{","				iClipNum++;","			}","		}","	}","	if (iEnableNum == iClipNum && iEnableNum != 0)","	{","		discard;","	}","}","else","{","	for (int i = 0; i < 3; i++)","	{","		if (u_enableClips[i])","		{","			float dPara = u_clipPlanes[i].w;","			if ((dot(-vec3(vViewPosition.xyz), vec3(u_clipPlanes[i].xyz)) + dPara) < 0.0)","			{","				discard;","			}","		}","	}","}","#endif"].join("\n"),e.ShaderChunkStrings.displacementmap_pars_vertex=["#ifdef USE_DISPLACEMENTMAP","uniform sampler2D displacementMap;","uniform float displacementScale;","uniform float displacementBias;","#endif"].join("\n"),e.ShaderChunkStrings.displacementmap_vertex=["#ifdef USE_DISPLACEMENTMAP","transformed += normalize( objectNormal ) * ( texture2D( displacementMap, a_texCoords.xy ).x * displacementScale + displacementBias );","#endif"].join("\n"),e.ShaderChunkStrings.aomap_pars_fragment=["#ifdef USE_AOMAP","	uniform sampler2D aoMap;","	uniform float aoMapIntensity;","#endif"].join("\n"),e.ShaderChunkStrings.aomap_fragment=["#ifdef USE_AOMAP","		float ambientOcclusion = (texture2D(aoMap, vUv).r - 1.0) * aoMapIntensity + 1.0;","		reflectedLight.indirectDiffuse *= ambientOcclusion;","#if defined( USE_ENV_TEXTURE ) && defined( PHYSICAL )","		float dotNV = saturate(dot(geometry.normal, geometry.viewDir));","		reflectedLight.indirectSpecular *= computeSpecularOcclusion(dotNV, ambientOcclusion, material.specularRoughness);","#endif","#endif"].join("\n"),e.ShaderChunkStrings.emissivemap_fragment=["#ifdef USE_EMISSIVEMAP","		vec4 emissiveColor = texture2D(emissiveMap, vUv);","		emissiveColor.rgb = mapTexelToLinear(emissiveColor).rgb;","		totalEmissiveRadiance *= emissiveColor.rgb;","#endif"].join("\n"),e.ShaderChunkStrings.emissivemap_pars_fragment=["#ifdef USE_EMISSIVEMAP","		uniform sampler2D emissiveMap;","#endif"].join("\n"),e.ShaderChunkStrings.parallax_corrected_cubemap_pars_vertex=["#ifdef USE_LOCAL_CUBEMAP","               varying vec3 vWorldPosition;","#endif"].join("\n"),e.ShaderChunkStrings.parallax_corrected_cubemap_vertex=["#ifdef USE_LOCAL_CUBEMAP","               vWorldPosition = worldPosition.xyz;","#endif"].join("\n"),e.ShaderChunkStrings.parallax_corrected_cubemap_pars_fragment=["#ifdef USE_LOCAL_CUBEMAP"," uniform vec3 boxMax;"," uniform vec3 boxMin;"," uniform vec3 cubeMapWorldPosition;"," varying vec3 vWorldPosition;"," vec3 GetParallaxCorrectedReflect(vec3 originReflect,vec3 boxMax,vec3 boxMin,vec3 cubeMapWorldPosition,vec3 worldPosition)"," {"," vec3 rbmax = (boxMax - worldPosition) / originReflect;","vec3 rbmin = (boxMin - worldPosition) / originReflect;","vec3 rbminmax;","rbminmax.x = originReflect.x > 0.0 ? rbmax.x : rbmin.x;","rbminmax.y = originReflect.y > 0.0 ? rbmax.y : rbmin.y;","rbminmax.z = originReflect.z > 0.0 ? rbmax.z : rbmin.z;"," float fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);","vec3 posonbox = worldPosition + originReflect * fa;"," vec3 envBoxPos = (boxMin + boxMax) * 0.5;"," return posonbox - envBoxPos;"," }","vec3 fixSeams(vec3 vec, float mipmapIndex) {","float scale = 1.0 - exp2(mipmapIndex) / 256.0;","float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));","if (abs(vec.x) != M) vec.x *= scale;","if (abs(vec.y) != M) vec.y *= scale;","if (abs(vec.z) != M) vec.z *= scale;","return vec;","}","#endif"].join("\n"),e.ShaderChunkStrings.encodings_pars_fragment=["","vec4 LinearToLinear(in vec4 value) {","return value;","}","vec4 GammaToLinear(in vec4 value, in float gammaFactor) {","	return vec4(pow(value.xyz, vec3(gammaFactor)), value.w);","}","vec4 LinearToGamma(in vec4 value, in float gammaFactor) {","	return vec4(pow(value.xyz, vec3(1.0 / gammaFactor)), value.w);","}","vec4 sRGBToLinear(in vec4 value) {","	return vec4(mix(pow(value.rgb * 0.9478672986 + vec3(0.0521327014), vec3(2.4)), value.rgb * 0.0773993808, vec3(lessThanEqual(value.rgb, vec3(0.04045)))), value.w);","}","vec4 LinearTosRGB(in vec4 value) {","	return vec4(mix(pow(value.rgb, vec3(0.41666)) * 1.055 - vec3(0.055), value.rgb * 12.92, vec3(lessThanEqual(value.rgb, vec3(0.0031308)))), value.w);","}","vec4 RGBEToLinear(in vec4 value) {","	return vec4(value.rgb * exp2(value.a * 255.0 - 128.0), 1.0);","}","vec4 LinearToRGBE(in vec4 value) {","	float maxComponent = max(max(value.r, value.g), value.b);","	float fExp = clamp(ceil(log2(maxComponent)), -128.0, 127.0);","	return vec4(value.rgb / exp2(fExp), (fExp + 128.0) / 255.0);","}","vec4 RGBMToLinear(in vec4 value, in float maxRange) {","	return vec4(value.xyz * value.w * maxRange, 1.0);","}","vec4 LinearToRGBM(in vec4 value, in float maxRange) {","	float maxRGB = max(value.x, max(value.g, value.b));","	float M = clamp(maxRGB / maxRange, 0.0, 1.0);","	M = ceil(M * 255.0) / 255.0;","	return vec4(value.rgb / (M * maxRange), M);","}","vec4 RGBDToLinear(in vec4 value, in float maxRange) {","	return vec4(value.rgb * ((maxRange / 255.0) / value.a), 1.0);","}","vec4 LinearToRGBD(in vec4 value, in float maxRange) {","	float maxRGB = max(value.x, max(value.g, value.b));","	float D = max(maxRange / maxRGB, 1.0);","	D = min(floor(D) / 255.0, 1.0);","	return vec4(value.rgb * (D * (255.0 / maxRange)), D);","}","const mat3 cLogLuvM = mat3(0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969);","vec4 LinearToLogLuv(in vec4 value) {","	vec3 Xp_Y_XYZp = value.rgb * cLogLuvM;","	Xp_Y_XYZp = max(Xp_Y_XYZp, vec3(1e-6, 1e-6, 1e-6));","	vec4 vResult;","	vResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;","	float Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;","	vResult.w = fract(Le);","	vResult.z = (Le - (floor(vResult.w*255.0)) / 255.0) / 255.0;","	return vResult;","}","const mat3 cLogLuvInverseM = mat3(6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268);","vec4 LogLuvToLinear(in vec4 value) {","	float Le = value.z * 255.0 + value.w;","	vec3 Xp_Y_XYZp;","	Xp_Y_XYZp.y = exp2((Le - 127.0) / 2.0);","	Xp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;","	Xp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;","	vec3 vRGB = Xp_Y_XYZp.rgb * cLogLuvInverseM;","	return vec4(max(vRGB, 0.0), 1.0);","}"].join("\n"),e.ShaderChunkStrings.encodings_fragment=" gl_FragColor = linearToOutputTexel( gl_FragColor );",e.ShaderChunkStrings.ssao_par_fragment=["#ifdef SSAO"," uniform vec2 screenSize;"," uniform sampler2D ssaoMap;","vec2 CalcScreenTexCoord()","{","	return gl_FragCoord.xy / screenSize;","}","#endif"].join("\n"),e.ShaderChunkStrings.ssao_fragment=["#ifdef SSAO"," ssaoFactor = texture2D(ssaoMap,CalcScreenTexCoord()).r;","#endif"].join("\n"),e.ShaderChunkStrings.matcap_pars_fragment=["#if defined( USE_MATCAPMAP ) &&  !defined( PHYSICAL )","uniform sampler2D matcapMap;","vec3 GetMatcapIndirectLight( const in GeometricContext geometry)","{","  vec2 matcapCoords = -normalize(geometry.normal).xy*0.5+0.5;","  vec3 ret = texture2D(matcapMap,matcapCoords).xyz;"," return ret;","}","#endif"].join("\n")})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){this.gl=null,this.vertexShaderCode="",this.fragShaderCode="",this.vertexShader=null,this.fragShader=null,this.baseShaderProgram=null}return e.prototype.CompileShaer=function(){this.vertexShader=this.gl.createShader(WebGLRenderingContext.VERTEX_SHADER),this.fragShader=this.gl.createShader(WebGLRenderingContext.FRAGMENT_SHADER),this.gl.shaderSource(this.vertexShader,this.vertexShaderCode),this.gl.shaderSource(this.fragShader,this.fragShaderCode),this.gl.compileShader(this.vertexShader),this.gl.compileShader(this.fragShader),this.gl.getShaderParameter(this.vertexShader,this.gl.COMPILE_STATUS)===!1&&this.gl.getShaderInfoLog(this.vertexShader)!==""&&console.log("Shader Info: "+this.gl.getShaderInfoLog(this.vertexShader),this.vertexShaderCode),this.gl.getShaderParameter(this.fragShader,this.gl.COMPILE_STATUS)===!1&&this.gl.getShaderInfoLog(this.fragShader)!==""&&console.log("Shader Info: "+this.gl.getShaderInfoLog(this.fragShader),this.fragShaderCode),this.baseShaderProgram=this.gl.createProgram(),this.gl.attachShader(this.baseShaderProgram,this.vertexShader),this.gl.attachShader(this.baseShaderProgram,this.fragShader),this.gl.linkProgram(this.baseShaderProgram),this.gl.getProgramParameter(this.baseShaderProgram,this.gl.LINK_STATUS)===!1&&this.gl.getProgramInfoLog(this.baseShaderProgram)!==""&&console.log("Shader Info: "+this.gl.getProgramInfoLog(this.baseShaderProgram))},e.prototype.SetUniformInt=function(e,t){this.gl.uniform1i(this.gl.getUniformLocation(this.baseShaderProgram,e),t)},e}();e.ShaderTest=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){}return t.GetUniformListMaps=function(e){var t=null,n=this.m_uniformMaps[e];return n===null||n===undefined?(t={},this.m_uniformMaps[e]=t):t=n,t},t.UpdateUniform=function(n,r,i,s,o){var u=n.GetRenderContext().GetGLRenderContext(),a=n.GetScene().GetResourceManager(),f=a.GetDeffaultTextureObj(),l=a.GetDefaultCubeMap(),c=i.GetShaderUniformKeyValueArray();for(var h in o){var p=o[h],d=p.uniformType;if(p)if(d=="Texture2D"){var v=e.GLShapeDrawer.AllocTextureUnit();u.uniform1i(i.GetShaderUniformParameter(h).location,v);var m=p.value;if(m){var g=m.GetOGLObj(u);m.SetTextureUnit(v),g?(r[v]=e.GL.TEXTURE_2D,u.activeTexture(e.GL.TEXTURE0+v),u.bindTexture(e.GL.TEXTURE_2D,g)):(r[v]=e.GL.TEXTURE_2D,u.activeTexture(e.GL.TEXTURE0+v),u.bindTexture(e.GL.TEXTURE_2D,f))}}else if(d=="GeometryBuffer"){var v=e.GLShapeDrawer.AllocTextureUnit();u.uniform1i(i.GetShaderUniformParameter(h).location,v);var m=p.value;if(m){var g=m.GetOGLObj();g&&(r[v]=e.GL.TEXTURE_2D,u.activeTexture(e.GL.TEXTURE0+v),u.bindTexture(e.GL.TEXTURE_2D,g))}}else if(d=="GeometryBufferArray"){var y=p.value,b=[];for(var w=0,E=y.length;w<E;w++){var v=e.GLShapeDrawer.AllocTextureUnit();b.push(v);var m=y[w];if(m){var g=m.GetOGLObj(u);m.SetTextureUnit(v),g?(r[v]=e.GL.TEXTURE_2D,u.activeTexture(e.GL.TEXTURE0+v),u.bindTexture(e.GL.TEXTURE_2D,g)):(r[v]=e.GL.TEXTURE_2D,u.activeTexture(e.GL.TEXTURE0+v),u.bindTexture(e.GL.TEXTURE_2D,f))}}u.uniform1iv(i.GetShaderUniformParameter(h).location,b)}else if(d=="Texture2DArray"){var y=p.value,b=[];for(var w=0;w<y.length;w++){var v=e.GLShapeDrawer.AllocTextureUnit();b.push(v);var m=y[w];if(m){var g=m.GetOGLObj(u);m.SetTextureUnit(v),g?(r[v]=e.GL.TEXTURE_2D,u.activeTexture(e.GL.TEXTURE0+v),u.bindTexture(e.GL.TEXTURE_2D,g)):(r[v]=e.GL.TEXTURE_2D,u.activeTexture(e.GL.TEXTURE0+v),u.bindTexture(e.GL.TEXTURE_2D,f))}}u.uniform1iv(i.GetShaderUniformParameter(h).location,b)}else if(d=="TextureCube"){var v=e.GLShapeDrawer.AllocTextureUnit(),m=p.value;if(m){m.SetTextureUnit(v);var g=m.GetOGLObj(u);g?(r[v]=e.GL.TEXTURE_CUBE_MAP,u.activeTexture(e.GL.TEXTURE0+v),u.bindTexture(e.GL.TEXTURE_CUBE_MAP,g)):(r[v]=e.GL.TEXTURE_CUBE_MAP,u.activeTexture(e.GL.TEXTURE0+v),u.bindTexture(e.GL.TEXTURE_CUBE_MAP,l))}u.uniform1i(i.GetShaderUniformParameter(h).location,v),p.lastValue=v}else if(d=="Float"){var S=i.GetShaderUniformParameter(h);if(S.size>1){if(Array.isArray(p.value)){var x=p.value;u.uniform1fv(S.location,x)}}else{var x=p.value;u.uniform1f(S.location,x)}}else if(d=="Vector2"){var x=p.value,T=x.Data();u.uniform2f(i.GetShaderUniformParameter(h).location,T[0],T[1])}else if(d=="Vector3"){var x=p.value,T=x.ToArray();u.uniform3f(i.GetShaderUniformParameter(h).location,T[0],T[1],T[2])}else if(d=="Vector4"){var x=p.value,T=x.Data();u.uniform4f(i.GetShaderUniformParameter(h).location,T[0],T[1],T[2],T[3])}else if(d=="Bool")u.uniform1i(i.GetShaderUniformParameter(h).location,p.value);else if(d=="BoolArray"){var x=p.value;u.uniform1iv(i.GetShaderUniformParameter(h).location,x)}else if(d=="Matrix3"){var x=p.value;u.uniformMatrix3fv(i.GetShaderUniformParameter(h).location,!1,x.data)}else if(d=="Matrix4"){var x=p.value;u.uniformMatrix4fv(i.GetShaderUniformParameter(h).location,!1,x.data)}else if(d=="Matrix4Array"){var x=p.value;u.uniformMatrix4fv(i.GetShaderUniformParameter(h).location,!1,t.flatten(x,i.GetShaderUniformParameter(h).size,16))}}},t.flatten=function(e,t,n){var r;if(t===1)return e[0].data;r=new Float32Array(t*n);for(var i=0;i<t;i++)r.set(e[0].data,i*n);return r},t.SetUniformValueToMap=function(t,n,r,i){var s=t[n];if(s!==null&&s!==undefined)s.value=i;else{var o=new e.Uniform(r,i);t[n]=o}},t.m_uniformHelper={},t.m_uniformMaps={},t}();e.UniformHelper=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){this.m_sceneCameras=[]}return e.prototype.AddCamera=function(e){if(e){for(var t=0;t<this.m_sceneCameras.length;t++)if(this.m_sceneCameras[t]==e)return;this.m_sceneCameras.push(e)}},e.prototype.RemoveCamera=function(e){for(var t=0,n=this.m_sceneCameras.length;t<n;t++)if(this.m_sceneCameras[t]==e){this.m_sceneCameras[t]==null;return}},e.prototype.SetSceneManager=function(e){this.m_sceneManager=e},e.prototype.GetSceneManger=function(){return this.m_sceneManager},e.prototype.GetAllCameras=function(){return this.m_sceneCameras},e}();e.CameraManager=t;var n=function(t){function n(){var e=t.call(this)||this;return e.SetScene(null),e}return __extends(n,t),n.prototype.GetType=function(){return e.CAMERA_GROUP_NODE},n.prototype.Initialize=function(){},n.prototype.SetScene=function(e){this.m_scene=e},n.prototype.GetScene=function(){return this.m_scene},n.prototype.RayPick=function(e){t.prototype.RayPick.call(this,e);var n=this.m_scene.GetCameraManager(),r=n.GetAllCameras();for(var i=0;i<r.length;i++)r[i].RayPick(e)},n}(e.GroupNode);e.CameraGroup=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var e=t.call(this)||this;return e.SetScene(null),e}return __extends(n,t),n.prototype.RayPick=function(e){t.prototype.RayPick.call(this,e);var n=this.m_scene.GetLightManager(),r=n.GetAllLight();for(var i=0;i<r.length;i++)r[i].RayPick(e)},n.prototype.FindVisableObject=function(e){t.prototype.FindVisiableObject.call(this,e);var n=this.m_scene.GetLightManager(),r=n.GetAllLight();for(var i=0;i<r.length;i++)r[i].FindVisiableObject(e)},n.prototype.OnMarkedDirty=function(){t.prototype.OnMarkedDirty.call(this);if(this.m_scene){var e=this.m_scene.GetLightManager(),n=e.GetAllLight();for(var r=0;r<n.length;r++);}},n.prototype.GetScene=function(){return this.m_scene},n.prototype.Initialize=function(){},n.prototype.SetScene=function(e){this.m_scene=e},n.prototype.GetType=function(){return e.MEASURE_GROUP_NODE},n}(e.GroupNode);e.LightGroup=t})(M3D||(M3D={}));var M3D;(function(e){e.DEFAULT_OCTREE_SIZE=1e3,e.DEFAULT_OCTREE_LEVELS=6,e.RAYCASTS_PER_WORK_ITEM=4,e.NUM_OCTANTS=8,e.ROOT_INDEX=99999999999;var t=function(){function t(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];this.m_drawables=[],this.m_center=e.Vector3.ZERO(),this.m_halfSize=e.Vector3.ZERO(),this.m_parent=null,this.m_root=null;if(t.length==5){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4];this.m_level=i,this.m_numDrawables=0,this.m_parent=s,this.m_root=o,this.m_index=u,this.m_dirty=!0,this.Initialize(r),this.m_children=new Array(e.NUM_OCTANTS);for(var a=0;a<e.NUM_OCTANTS;++a)this.m_children[a]=null}}return t.prototype.Initialize=function(t){this.m_worldBoundingBox=t.Clone(),this.m_center=t.Center(),this.m_halfSize=t.Size().Multiply(.5),this.m_cullingBox=new e.BoundingBox(this.m_worldBoundingBox.min.Sub(this.m_halfSize),this.m_worldBoundingBox.max.Add(this.m_halfSize))},t.prototype.GetOrCreateChild=function(n){if(this.m_children[n]!==null)return this.m_children[n];var r=this.m_worldBoundingBox.min.Clone(),i=this.m_worldBoundingBox.max.Clone(),s=this.m_worldBoundingBox.Center().Clone();return n&1?r.x=s.x:i.x=s.x,n&2?r.y=s.y:i.y=s.y,n&4?r.z=s.z:i.z=s.z,this.m_children[n]=new t(new e.BoundingBox(r,i),this.m_level+1,this,this.m_root,n),this.m_children[n]},t.prototype.DeleteChild=function(t){t<e.NUM_OCTANTS&&this.m_children[t]!==null&&(this.m_children[t]=null)},t.prototype.GetWorldBoundingBox=function(){return this.m_worldBoundingBox},t.prototype.GetCullingBox=function(){return this.m_cullingBox},t.prototype.GetLevel=function(){return this.m_level},t.prototype.GetParent=function(){return this.m_parent},t.prototype.GetRoot=function(){return this.m_root},t.prototype.GetNumDrawables=function(){return this.m_numDrawables},t.prototype.IsEmpty=function(){return this.m_numDrawables==0},t.prototype.InsertDrawable=function(t){var n=t.GetWorldBoundingBox(),r;this===this.m_root?r=this.m_cullingBox.IsInside(n)!=e.INSIDE||this.CheckDrawableFit(n):r=this.CheckDrawableFit(n);if(r){var i=t.GetOctant();i!==this&&(this.AddDrawable(t),i!==null&&i.RemoveDrawable(t,!1))}else{var s=n.Center(),o=s.x<this.m_center.x?0:1,u=s.y<this.m_center.y?0:2,a=s.z<this.m_center.z?0:4;this.GetOrCreateChild(o+u+a).InsertDrawable(t)}this.m_dirty=!0},t.prototype.AddDrawable=function(e){e.SetOctant(this),this.m_drawables.push(e),this.IncDrawableCount()},t.prototype.IncDrawableCount=function(){++this.m_numDrawables,this.m_parent!==null&&this.m_parent.IncDrawableCount()},t.prototype.RemoveDrawable=function(e,t){t===void 0&&(t=!0);var n=!1,r;for(var i=0;i<this.m_drawables.length;i++){var s=this.m_drawables[i];if(s===e){r=i,n=!0;break}}this.m_drawables.splice(r,1),n&&(t&&e.SetOctant(null),this.DecDrawableCount()),this.m_dirty=!0},t.prototype.DecDrawableCount=function(){var e=this.m_parent;--this.m_numDrawables,this.m_numDrawables===0&&e!==null&&e.DeleteChild(this.m_index),e!==null&&e.DecDrawableCount()},t.prototype.Clear=function(){for(var t=0;t<this.m_drawables.length;++t)this.m_drawables[t]!==null&&this.m_drawables[t].SetOctant(null);this.m_drawables.length=0;for(var n=0;n<e.NUM_OCTANTS;++n)this.m_children[n]!==null&&this.m_children[n].Clear()},t.prototype.CheckDrawableFit=function(e){var t=e.Size();return this.m_level>=this.m_root.GetNumLevels()||t.x>=this.m_halfSize.x||t.y>=this.m_halfSize.y||t.z>=this.m_halfSize.z?!0:e.min.x<=this.m_worldBoundingBox.min.x-.5*this.m_halfSize.x||e.max.x>=this.m_worldBoundingBox.max.x+.5*this.m_halfSize.x||e.min.y<=this.m_worldBoundingBox.min.y-.5*this.m_halfSize.y||e.max.y>=this.m_worldBoundingBox.max.y+.5*this.m_halfSize.y||e.min.z<=this.m_worldBoundingBox.min.z-.5*this.m_halfSize.z||e.max.z>=this.m_worldBoundingBox.max.z+.5*this.m_halfSize.z?!0:!1},t.prototype.CompareByPlcWorldBoxLength=function(e,t){return e.GetWorldBoundingBox().Length()<t.GetWorldBoundingBox().Length()},t.prototype.GetDrawablesInternal=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length==2){var r=t[0],i=t[1];if(this!=this.m_root){var s=r.TestOctant(this.m_cullingBox,i);if(s===e.Intersection.INSIDE)i=!0;else if(s===e.Intersection.OUTSIDE)return}this.m_drawables.length>0&&(this.m_dirty&&(this.m_drawables=this.quickSort(this.m_drawables)),r.TestDrawables(this.m_drawables,i));for(var o=0;o<e.NUM_OCTANTS;++o)this.m_children[o]!==null&&this.m_children[o].GetDrawablesInternal(r,i)}else{var r=t[0],u=r.m_ray.HitDistance(this.m_cullingBox);if(u>=r.m_maxDistance)return;for(var o=0;o<e.NUM_OCTANTS;++o)this.m_children[o]&&this
.m_children[o].GetDrawablesInternal(r)}},t.prototype.GetDrawablesOnlyInternal=function(t,n){var r=t.m_ray.HitDistance(this.m_cullingBox);if(r>=e.INFINITY)return;if(this.m_drawables.length>0)for(var i=0;i<this.m_drawables.length;i++){var s=this.m_drawables[i];s.IsVisible()&&n.push(s)}for(var i=0;i<e.NUM_OCTANTS;++i)this.m_children[i]!==null&&this.m_children[i].GetDrawablesOnlyInternal(t,n)},t.prototype.quickSort=function(e){if(e.length<=1)return e;var t=(new Array).concat(e),n=Math.floor(t.length/2),r=t.splice(n,1)[0],i=[],s=[];for(var o=0;o<t.length;o++)this.CompareByPlcWorldBoxLength(r,t[o])?i.push(t[o]):s.push(t[o]);return this.quickSort(i).concat([r],this.quickSort(s))},t}();e.Octant=t;var n=function(t){function n(){var n=t.call(this,new e.BoundingBox(-e.DEFAULT_OCTREE_SIZE,e.DEFAULT_OCTREE_SIZE),0,null,null,e.ROOT_INDEX)||this;return n.m_drawableUpdates=[],n.m_root=n,n.m_numLevels=e.DEFAULT_OCTREE_LEVELS,n}return __extends(n,t),n.prototype.QueueUpdate=function(e){e.isOCtreeUpdated()||(this.m_drawableUpdates.push(e),e.SetOCTreeUpdated(!0))},n.prototype.GetNumLevels=function(){return this.m_numLevels},n.prototype.Clear=function(){this.m_drawableUpdates=new Array,this.m_drawableReinsertions=new Array,t.prototype.Clear.call(this);for(var n=0;n<e.NUM_OCTANTS;++n)this.m_children[n]!==null&&(this.m_children[n].Clear(),this.m_children[n]=null)},n.prototype.SetSize=function(t,n){for(var r=0;r<e.NUM_OCTANTS;++r)this.DeleteChild(r);this.Initialize(t),this.m_numDrawables=this.m_drawables.length,this.m_numLevels=n>1?n:1},n.prototype.Update=function(){if(this.m_drawableUpdates.length!=0){for(var t=0;t<this.m_drawableUpdates.length;++t){var n=this.m_drawableUpdates[t],r=n.GetOctant(),i=n.GetWorldBoundingBox();if(r===null||r.GetRoot()!==this)continue;if(r.GetCullingBox().IsInside(i)===e.INSIDE&&r.CheckDrawableFit(i))continue;this.InsertDrawable(n)}this.m_drawableUpdates=new Array}},n.prototype.AddManualDrawable=function(e){if(e===null)return;if(e.GetOctant()!==null)return;this.AddDrawable(e)},n.prototype.RemoveManualDrawable=function(e){if(e===null)return;var t=e.GetOctant();t!==null&&t.GetRoot()===this&&t.RemoveDrawable(e)},n.prototype.GetDrawables=function(e){e.m_result.length=0,this.GetDrawablesInternal(e,!1)},n.prototype.Raycast=function(e){},n.prototype.RaycastSingle=function(e){e.m_result.length=0,this.m_rayQuery=e,this.m_rayQueryDrawables=new Array,this.GetDrawablesOnlyInternal(e,this.m_rayQueryDrawables);for(var t=0,n=this.m_rayQueryDrawables;t<n.length;t++){var r=n[t];e.m_fastResult.push(r)}},n.prototype.RaycastSingleFast=function(e){e.m_result.length=0,this.m_rayQuery=e,this.m_rayQueryDrawables=new Array,this.GetDrawablesOnlyInternal(e,this.m_rayQueryDrawables);for(var t=0,n=this.m_rayQueryDrawables;t<n.length;t++){var r=n[t];e.m_fastResult.push(r)}},n}(t);e.Octree=n})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.RAY_AABB=0]="RAY_AABB",e[e.RAY_OBB=1]="RAY_OBB",e[e.RAY_TRIANGLE=2]="RAY_TRIANGLE",e[e.RAY_TRIANGLE_UV=3]="RAY_TRIANGLE_UV"})(t=e.RayQueryLevel||(e.RayQueryLevel={}));var n=function(){function e(){}return e}();e.OctreeQueryResult=n;var r=function(){function e(){}return e}();e.RayQueryResult=r;var i=function(){function e(e,t,n,r){this.m_result=[],this.m_fastResult=e,this.m_ray=t.Clone(),this.m_level=n,this.m_maxDistance=r}return e}();e.RayOctreeQuery=i;var s=function(){function e(e,t,n){this.m_result=e,this.m_drawableFlags=t,this.m_viewMask=n}return e.prototype.TestOctant=function(e,t){return 0},e.prototype.TestDrawables=function(e,t){},e.prototype.GetCamera=function(){return this.m_camera},e.prototype.SetCamera=function(e){this.m_camera=e},e.prototype.GetRenderAction=function(){return this.m_renderAction},e.prototype.SetRenderAction=function(e){this.m_renderAction=e},e}();e.OctreeQuery=s;var o=function(t){function n(){return t!==null&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.TestOctant=function(t,n){return e.Intersection.INSIDE},n.prototype.TestDrawables=function(e,t){},n}(s);e.AllContentOctreeQuery=o;var u=function(t){function n(e,n,r,i){var s=t.call(this,e,r,i)||this;return s.m_frustum=n,s}return __extends(n,t),n.prototype.TestOctant=function(t,n){return n?e.Intersection.INSIDE:this.m_frustum.IsInside(t)},n.prototype.TestDrawables=function(e,t){for(var n=0;n<e.length;n++){var r=e[n];if(this.m_renderAction&&this.m_camera){var i=this.m_renderAction.GetCullerHelper().IsLittleModel(r.GetWorldBoundingBox(),this.m_camera);if(i==2)return}this.m_result.push(r)}},n}(s);e.FrustumOctreeQuery=u;var a=function(t){function n(e,n,r,i){var s=t.call(this,e,r,i)||this;return s.m_box=n.Clone(),s}return __extends(n,t),n.prototype.TestOctant=function(t,n){return n?e.Intersection.INSIDE:this.m_box.IsInside(t)},n.prototype.TestDrawables=function(e,t){},n}(s);e.BoxOctreeQuery=a;var f=function(t){function n(e,n,r,i){var s=t.call(this,e,r,i)||this;return s.m_sphere=n,s}return __extends(n,t),n.prototype.TestOctant=function(t,n){return n?e.Intersection.INSIDE:this.m_sphere.IsInside(t)},n.prototype.TestDrawables=function(e,t){},n}(s);e.SphereOctreeQuery=f;var l=function(t){function n(e,n,r,i){var s=t.call(this,e,r,i)||this;return s.m_point=n,s}return __extends(n,t),n.prototype.TestOctant=function(t,n){return n?e.Intersection.INSIDE:t.IsInside(this.m_point)},n.prototype.TestDrawables=function(e,t){},n}(s);e.PointOctreeQuery=l})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var e=t.call(this)||this;return e.m_section=null,e.SetScene(null),e}return __extends(n,t),n.prototype.SetScene=function(e){this.m_scene=e},n.prototype.GetScene=function(){return this.m_scene},n.prototype.GetSection=function(){this.m_section==null&&(this.m_section=new e.Section),this.m_section.SetBox(this.GetScene().GetSceneBox());var t=this.GetScene().GetSceneBox();return t.ScaleBox(1.3),this.m_section.SetDrawRection(t),this.m_section},n.prototype.RayPick=function(e){},n.prototype.ComputeBox=function(){},n.prototype.GetPickType=function(){return e.PICKTYPE_MODEL},n.prototype.GetType=function(){return e.SECTION_NODE},n.prototype.OnMarkedDirty=function(){this.m_section&&this.m_section.SetTransform(this.GetWorldTransform())},n.prototype.FindVisiableObject=function(e){this.m_section&&this.m_section.FindVisiableObject(e)},n}(e.SceneNode);e.SectionNode=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){this.UpdatePercent=function(){},this.UpdateWorkTask=function(){},this.UpdateStopPlaying=function(){}}return e.prototype.OnExecute=function(e,t){},e.prototype.OnStopTask=function(e,t){this.UpdateStopPlaying()},e.prototype.OnTick=function(e,t){e instanceof r&&(this.UpdatePercent(),this.UpdateWorkTask())},e.prototype.OnActive=function(e,t){},e}();e.AnimationTaskLinstener=t;var n=function(){function e(){this._currentWorkTask=null,this._stoped=!1,this.canBegin=!1,this._manager=null}return e.prototype.SetManager=function(e){this._manager=e},e.prototype.Execute=function(){if(this._manager.workTaskList.length>0&&this.canBegin){if(this._currentWorkTask===null)this._currentWorkTask=this._manager.workTaskList[0],this._currentWorkTask.IsRun()||(this._currentWorkTask.Active(),this._manager.pausePos>=0&&(this._currentWorkTask.SetPercent(this._manager.pausePos),this._manager.pausePos=0),this._manager.hasCompleted=!1,this._currentWorkTask.Play(),this._manager.SetActiveTask(this._currentWorkTask));else if(!this._currentWorkTask.IsRun()){var e=this._manager.workTaskList.indexOf(this._currentWorkTask);e>-1&&this._manager.workTaskList.splice(e,1),this._manager.workTaskList.length>0&&(this._currentWorkTask=null)}for(var t=0;t<this._manager._animatinTaskListeners.length;t++)this._manager._animatinTaskListeners[t].OnTick(this._manager,this._manager.GetActiveTask);this._stoped=!1}else{this._currentWorkTask&&(this._manager.viewer.GetSimulationMgr().GetAnimationStepManager().GetCurrentProcessManager().CurProcessID=-1,this._currentWorkTask=null);if(this._stoped===!1){this._stoped=!0;for(var n=0;n<this._manager._animatinTaskListeners.length;n++)this._manager._animatinTaskListeners[n].OnStopTask(this._manager,this._manager.GetActiveTask);this._manager.viewer.GetSimulationMgr().GetAnimationStepManager().GetProcessManagerList().forEach(function(e){e.CurProcessID=-1});var r=this._manager.GetPercent();if(r>99.99||this._manager.workTaskList.length===0)this._manager.pausePos=0,this._manager.SetActiveTask(null),this._manager.IsLoop()&&(this._manager.Reset(),this._manager.PlayAll())}}},e}();e.HandlerTask=n;var r=function(){function t(e){this._animationTasksWithProcess=[],this._animationTasks=[],this._activeTask=null,this._speed=1,this.pausePos=0,this.temPausePos=0,this.viewer=null,this.workTaskList=[],this._animatinTaskListeners=[],this._handlerTask=new n,this.hasCompleted=!0,this.animationTimer=null,this.nativeAnimationTimer=null,this._isLoop=!1,this._autoWalkCamera=!1,this.animationEnd=function(){},this._handlerTask.SetManager(this),this.viewer=e}return t.prototype.AddTaskListener=function(e){var t=!1;return e!==null&&this._animatinTaskListeners.indexOf(e)===-1&&(this._animatinTaskListeners.push(e),t=!0),t},t.prototype.ClearTaskListeners=function(){var e=!1;return this._animatinTaskListeners=[],e=!0,e},t.prototype.RemoveTaskListeners=function(e){var t=!1;return e!=null&&this._animatinTaskListeners.indexOf(e)!==-1&&(this._animatinTaskListeners.splice(this._animatinTaskListeners.indexOf(e),1),t=!0),t},t.prototype.OpenFile=function(){this.viewer.AnimationIit(),this.ClearData(),this.SetupTasks()},t.prototype.ClearData=function(){this.CloseTaskList(),this._animationTasks=[],this._animationTasksWithProcess=[],this.SetActiveTask(null),this.pausePos=-1,this.temPausePos=0},t.prototype.CloseTaskList=function(){this._handlerTask.canBegin=!1,this._handlerTask.Execute(),this.workTaskList=[],this.GetActiveTask()!==null&&this.GetActiveTask().Pause()},t.prototype.SetActiveTask=function(e){this._activeTask=e;for(var t=0;t<this._animatinTaskListeners.length;t++)this._animatinTaskListeners[t].OnActive(this,this._activeTask)},t.prototype.SetupTasks=function(){this.ClearData();var e=this.viewer.AnimationGetInfo();for(var t=0;t<e.length;t++){this._animationTasksWithProcess.push(e[t]);var n=e[t].GetStepList();for(var r=0;r<n.length;r++)this._animationTasks.push(n[r]),this._animationTasksWithProcess.push(n[r])}},t.prototype.GetTaskList=function(){return this.viewer.AnimationGetInfo()},t.prototype.AnimationTask1=function(e){var t=e;t._handlerTask.Execute()},t.prototype.NativeAnimationTickTask=function(e){var t=e;t.viewer.OnAnimationTick()},t.prototype.ExecuteTaskList=function(){this._handlerTask.canBegin=!0,this.animationTimer===null&&(this.nativeAnimationTimer=new e.Timer,this.nativeAnimationTimer.SetTimer(this.NativeAnimationTickTask,this,10),this.nativeAnimationTimer.StartTimer(),this.animationTimer=new e.Timer,this.animationTimer.SetTimer(this.AnimationTask1,this,100),this.animationTimer.StartTimer())},t.prototype.Reset=function(){this.StopPlayer()},t.prototype.AddTask=function(e){e!==null&&e.GetType()===1&&this.workTaskList.push(e)},t.prototype.GetActiveTask=function(){return this._activeTask},t.prototype.GetPercent=function(){var e=0;if(this._animationTasks.length===1){var t=this.GetActiveTask();t!==null&&(e=t.Percent(),this.temPausePos=e)}else if(this._animationTasks.length>1){var t=this.GetActiveTask();if(t!==null){var n=this._animationTasks.indexOf(t),r=100/this._animationTasks.length,i=n*r;e=i+t.Percent()*r/100,this.temPausePos=t.Percent()}}return e},t.prototype.GetActiveTaskWithProcessIndex=function(){return this._animationTasksWithProcess.indexOf(this._activeTask)},t.prototype.SetPercent=function(e){if(this._animationTasks.length===1){var t=this.GetActiveTask();t!==null&&(this.GetActiveTask().SetPercent(e),this.pausePos=e)}else if(this._animationTasks.length>1){var n=100/this._animationTasks.length,r=Math.floor(e/n);if(r<this._animationTasks.length&&r>=0){var t=this._animationTasks[r];this.SetActiveTask(t);var i=(e-r*n)*100/n;this.pausePos=i}}},t.prototype.IsLoop=function(){return this._isLoop},t.prototype.SetLoop=function(e){this._isLoop=e,this.viewer!==null&&this.viewer.AnimationContinuousPlay(!1)},t.prototype.PlayNextAll=function(){this.CloseTaskList();if(this.GetActiveTask()===null){this.PlayAll();return}var e=this._animationTasks.indexOf(this.GetActiveTask());if(e<this._animationTasks.length){if(this.pausePos<100)this.Play(e,this._animationTasks.length);else{var t=e+1;this.Play(t===this._animationTasks.length?0:t,this._animationTasks.length)}return}this.ExecuteTaskList()},t.prototype.Play=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];if(e.length===0)this.CloseTaskList(),this.GetActiveTask()!=null&&this.AddTask(this.GetActiveTask()),this.ExecuteTaskList();else if(e.length===1)e[0]<this._animationTasks.length&&this.Play(e[0],this._animationTasks.length);else if(e.length===2){this.CloseTaskList();if(e[0]<e[1]&&e[0]>=0&&e[1]<=this._animationTasks.length)for(var n=e[0];n<e[1];n++)this.AddTask(this._animationTasks[n]);this.ExecuteTaskList()}},t.prototype.playAnimation=function(e,t){this._animationTasks.length===0&&this.OpenFile(),this.StopPlayer();var n=0;for(var r=0;r<this._animationTasks.length;r++){var i=this._animationTasks[r];if(t){if(i.GetProcessId()===e&&i.GetId()===t){n++,this.Play(r,r+n);break}}else i.GetProcessId()===e&&this.AddTask(i)}t||this.ExecuteTaskList()},t.prototype.GetSpeed=function(){return this._speed},t.prototype.SetSpeed=function(e){this._speed=e,this.viewer.AnimationPlaySpeed(e)},t.prototype.GetPreTask=function(e){var t=this._animationTasks.length-1;return e!=null&&(t=this._animationTasks.indexOf(e)),t--,t>=0?this._animationTasks[t]:this._animationTasks[0]},t.prototype.GetNextTask=function(e){var t=-1;return e!==null&&(t=this._animationTasks.indexOf(e)),t++,t<this._animationTasks.length?this._animationTasks[t]:this._animationTasks[0]},t.prototype.GetTaskPercent=function(){var e=0,t=this.GetActiveTask();return t!==null&&(e=this.GetActiveTask().Percent()),e},t.prototype.SetAutoWalkCamera=function(e){this._autoWalkCamera=e,this.viewer.AnimationPlayCamera(e)},t.prototype.GetAutoWalkCamera=function(){return this._autoWalkCamera},t.prototype.PlayAll=function(){this.CloseTaskList();for(var e=0;e<this._animationTasks.length;e++)this.AddTask(this._animationTasks[e]);this.ExecuteTaskList()},t.prototype.Pause=function(){this.GetPercent(),this.pausePos=this.temPausePos,this.CloseTaskList()},t.prototype.Resume=function(){this.PlayNextAll()},t.prototype.IsSingleAnimation=function(){var e=!0;return this._animationTasks.length>1&&(e=!1),e},t.prototype.PlayPre=function(){if(this.IsSingleAnimation()){var e=this.GetPercent(),t=e-5;t<0&&(t=0),this.SetPercent(t)}else this.PlayPreSeg()},t.prototype.PlayPreSeg=function(){this.CloseTaskList(),this.SetActiveTask(this.GetPreTask(this.GetActiveTask())),this.PlayNextAll()},t.prototype.PlayNext=function(){if(this.IsSingleAnimation()){var e=this.GetPercent(),t=e+5;t>100&&(t=0),this.SetPercent(t)}else this.PlayNextSeg()},t.prototype.PlayNextSeg=function(){this.CloseTaskList(),this.SetActiveTask(this.GetNextTask(this.GetActiveTask())),this.PlayNextAll()},t.prototype.StopPlayer=function(){this.CloseTaskList(),this.SetActiveTask(null),this.pausePos=-1,this.temPausePos=0,this.animationEnd(),this.animationTimer!==null&&(this.animationTimer.StopTimer(),this.animationTimer=null,this.nativeAnimationTimer.StopTimer(),this.nativeAnimationTimer=null)},t}();e.AnimationPlayer=r})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];this.modelShape=null,this.matrixCache=new e.Matrix3x4,this.boxCache=new e.BoundingBox;switch(t.length){case 3:this.modelShape=t[0],this.matrixCache=t[1],this.boxCache=t[2];break;case 0:}}return t.prototype.CopyFrom=function(e){this.modelShape=e.modelShape,this.matrixCache=e.matrixCache,this.boxCache=e.boxCache},t}();e.NodeState=t;var n;(function(e){e[e.NOEXPLOSIVE=-1]="NOEXPLOSIVE",e[e.AWAYFROMCENTER=0]="AWAYFROMCENTER",e[e.AWAYFROMCENTER_X=1]="AWAYFROMCENTER_X",e[e.AWAYFROMCENTER_Y=2]="AWAYFROMCENTER_Y",e[e.AWAYFROMCENTER_Z=3]="AWAYFROMCENTER_Z",e[e.AWAYFROMCENTER_X_LEFT=4]="AWAYFROMCENTER_X_LEFT",e[e.AWAYFROMCENTER_Y_FRONT=5]="AWAYFROMCENTER_Y_FRONT",e[e.AWAYFROMCENTER_Z_BOTTOM=6]="AWAYFROMCENTER_Z_BOTTOM",e[e.TOBALLSURFACE=9]="TOBALLSURFACE"})(n=e.ExplosiveStyle||(e.ExplosiveStyle={}));var r=function(){function n(e){this.explosiveViewOperator=null,this.explosiveViewOperator=e}return n.onExecute=function(t,n){if(n){var r=t.GetExplosiveLevel();if(r>=s.MAX_ASSEMBLY_LEVLE&&n!==null&&n instanceof e.ShapeNode)var i=n,o=i.GetWorldTransform()}},n.onExecuteModel=function(e,n){if(n){var r=e.GetExplosiveLevel();if(r>=s.MAX_ASSEMBLY_LEVLE&&n!==null){var i=n.GetModelShape();if(i&&i.GetBodys()&&i.GetBodys().length>0){var o=i.GetWorldTransform(),u=new t(i,o.Clone(),i.GetWorldBoundingBox().Clone());e.AddMatrix(n,u)}}}},n}(),i=function(){function r(e){this.explosiveViewOperator=null,this.explosiveViewOperator=e}return r.onExecute=function(e,t){},r.onExecuteModel=function(r,i){if(i){var o=!0,u=r.GetExplosiveLevel();if(o){var a=i.GetModelShape(),f=new e.Vector3,l=new e.Matrix3x4,c=new e.Matrix3x4,h=new t,p=r.GetMatrix(i,h);if(p){c=h.matrixCache.Clone();var d=h.boxCache.Clone(),v=d.Center().Clone(),m=new e.Vector3,g=v.Clone();r.explosiveStyle===n.AWAYFROMCENTER?f=r.topNodeCenter.Clone():r.explosiveStyle===n.AWAYFROMCENTER_X?(f=r.topNodeFront.Clone(),f.y=g.y,f.z=g.z):r.explosiveStyle===n.AWAYFROMCENTER_Y?(f=r.topNodeLeft.Clone(),f.x=g.x,f.z=g.z):r.explosiveStyle===n.AWAYFROMCENTER_Z?(f=r.topNodeBottom.Clone(),f.x=g.x,f.y=g.y):r.explosiveStyle===n.AWAYFROMCENTER_X_LEFT?(f=r.topNodeFront.Clone(),v=s.GetNewPos(d,c,n.AWAYFROMCENTER_X_LEFT),f.y=v.y,f.z=v.z):r.explosiveStyle===n.AWAYFROMCENTER_Y_FRONT?(f=r.topNodeLeft.Clone(),v=s.GetNewPos(d,c,n.AWAYFROMCENTER_Y_FRONT),f.x=v.x,f.z=v.z):r.explosiveStyle===n.AWAYFROMCENTER_Z_BOTTOM&&(f=r.topNodeBottom.Clone(),v=s.GetNewPos(d,c,n.AWAYFROMCENTER_Z_BOTTOM),f.x=v.x,f.y=v.y),r.explosivePercent>=0?m=v.Sub(f).Multiply(r.explosivePercent):m=f.Sub(v).Multiply(r.explosivePercent);if(m.x===m.x&&m.y===m.y&&m.z===m.z){var y=i.GetParent(),b=new e.Matrix3x4;b=c;var w=new e.Matrix3x4;w=y?y.GetWorldTransform().ToMatrix3x4():w;var E=new e.Matrix3x4;E.MultiTranslate(m);var S=w.Inverse().Multiply(E.Multiply(b));i.SetPlaceMatrix(S.ToMatrix4())}else e.LOGE("explosive move error : %s",m.Tostring())}}}},r}(),s=function(){function t(){this.view=null,this.explosiveStyle=-1,this.explosivePercent=-1,this.isUseAnimation=!1,this.isFirstOpen=!0,this.allNodeMatrixsCache=new e.Map,this.viewMatrix=new e.Matrix4,this.topNodeCenter=new e.Vector3,this.topNodeBottom=new e.Vector3,this.topNodeLeft=new e.Vector3,this.topNodeFront=new e.Vector3,this.screenDepth=-1,this.explosiveLevel=-1,this.SetExplosiveLevel(t.MAX_ASSEMBLY_LEVLE),this.Reset()}return t.prototype.SetView=function(e){this.view=e},t.prototype.GetView=function(){return this.view},t.prototype.SetPercentNoRestore=function(e,t,r,i){r===void 0&&(r=100),i===void 0&&(i=!0),this.isFirstOpen&&(this.Reset(),this.isFirstOpen=!1,this.CacheMatrixState());var s=!1;if(t!==this.explosiveStyle||r!==this.explosivePercent){this.explosiveStyle=t,this.explosivePercent=4*r/.5,this.view=e,this.isUseAnimation=i;switch(this.explosiveStyle){case n.AWAYFROMCENTER:this.ProcressAwayFromCenter();break;case n.AWAYFROMCENTER_X:this.ProcressAwayFromCenter();break;case n.AWAYFROMCENTER_Y:this.ProcressAwayFromCenter();break;case n.AWAYFROMCENTER_Z:this.ProcressAwayFromCenter();break;case n.AWAYFROMCENTER_X_LEFT:this.ProcressAwayFromCenter();break;case n.AWAYFROMCENTER_Y_FRONT:this.ProcressAwayFromCenter();break;case n.AWAYFROMCENTER_Z_BOTTOM:this.ProcressAwayFromCenter();break;case n.TOBALLSURFACE:this.ProcressAwayToBallSurface();break;default:}}return s},t.prototype.SetPercent=function(t,r,i,s){i===void 0&&(i=100),s===void 0&&(s=!0),this.isFirstOpen&&(this.Reset(),t!=null&&this.view.RestoreView(),this.isFirstOpen=!1,this.CacheMatrixState());var o=!1;if(r!==this.explosiveStyle||i!==this.explosivePercent){this.explosiveStyle=r,this.explosivePercent=4*i/.5,this.view=t,this.isUseAnimation=s;switch(this.explosiveStyle){case n.AWAYFROMCENTER:this.ProcressAwayFromCenter();break;case n.AWAYFROMCENTER_X:this.ProcressAwayFromCenter();break;case n.AWAYFROMCENTER_Y:this.ProcressAwayFromCenter();break;case n.AWAYFROMCENTER_Z:this.ProcressAwayFromCenter();break;case n.AWAYFROMCENTER_X_LEFT:this.ProcressAwayFromCenter();break;case n.AWAYFROMCENTER_Y_FRONT:this.ProcressAwayFromCenter();break;case n.AWAYFROMCENTER_Z_BOTTOM:this.ProcressAwayFromCenter();break;case n.TOBALLSURFACE:this.ProcressAwayToBallSurface();break;default:}}var u=t.GetSceneManager().GetSceneBox(),a=t.GetSceneManager().GetCamera().GetPosition().Clone();return u.IsInside(a)===e.INSIDE&&t.GetSceneManager().GetCamera().OnMarkedDirty(),o},t.prototype.Close=function(e){var t=!1;return this.SetPercent(e,this.explosiveStyle,0,!1),this.Reset(),e!==null,t},t.prototype.GetExplosiveLevel=function(){return this.explosiveLevel},t.prototype.SetExplosiveLevel=function(e){this.explosiveLevel=e},t.prototype.Reset=function(){this.explosiveStyle=n.NOEXPLOSIVE,this.explosivePercent=0,this.isUseAnimation=!1,this.isFirstOpen=!0,this.allNodeMatrixsCache.Clear()},t.prototype.ProcressAwayFromCenter=function(){var t=!1;if(this.view!==null){var n=this.view,r=new e.CallBackAction;r.SetActionData(this),r.SetActionFun(i.onExecute),r.SetActionFunModel(i.onExecuteModel),n.GetSceneManager().ExecuteAction(r),n.GetSceneManager().RequestUpdateWhenSceneBoxChanged()}return t},t.prototype.ProcressAwayToBallSurface=function(){},t.prototype.AwayFromCenter=function(e,t){},t.prototype.CacheMatrixState=function(){if(this.view!==null){var t=this.view,n=t.GetSceneManager().GetSceneBox();i;var s=n.max.Clone(),o=n.min.Clone();this.topNodeCenter=s.Add(o).Multiply(.5),this.topNodeBottom=o.Add(new e.Vector3(s.x,s.y,o.z)).Multiply(.5),this.topNodeFront=o.Add(new e.Vector3(o.x,s.y,s.z)).Multiply(.5),this.topNodeLeft=o.Add(new e.Vector3(s.x,o.y,s.z)).Multiply(.5);var u=new e.CallBackAction;u.SetActionData(this),u.SetActionFun(r.onExecute),u.SetActionFunModel(r.onExecuteModel),t.GetSceneManager().ExecuteAction(u)}},t.GetNewPos=function(t,r,i){var s=new e.Vector3,o=t.Clone(),u=o.max.Clone(),a=o.min.Clone();return i===n.AWAYFROMCENTER_Z_BOTTOM?s=a.Add(new e.Vector3(u.x,u.y,a.z)).Multiply(.5):i===n.AWAYFROMCENTER_Y_FRONT?s=a.Add(new e.Vector3(a.x,u.y,u.z)).Multiply(.5):i===n.AWAYFROMCENTER_X_LEFT&&(s=a.Add(new e.Vector3(u.x,a.y,u.z)).Multiply(.5)),s},t.prototype.GetMatrix=function(e,t){var n=!1,r=this.allNodeMatrixsCache.Get(e);return r!==null&&(t.CopyFrom(r),n=!0),n},t.prototype.AddMatrix=function(e,t){this.allNodeMatrixsCache.Put(e,t)},t.MAX_ASSEMBLY_LEVLE=96,t}();e.ExplosiveViewOperator=s})(M3D||(M3D={}));var SView;(function(e){var t=function(){function e(t){this.name="NO_NAME",this.iconSkin="icon01";if(t===null)return;this.id=t.GetID(),t.GetName()!==null&&(this.name=t.GetName()),this.checked=t.IsVisible();var n=t.GetSubModels();n.length>0&&(this.children=[],this.iconSkin="pIcon01");for(var r=0,i=n;r<i.length;r++){var s=i[r];s!==null&&this.children.push(new e(s))}}return e}();e.JSONAssembly=t})(SView||(SView={}));var M3D;(function(e){var t=function(){function e(){this.percent=0,this.fileName=""}return e}();e.LoadingEvent=t})(M3D||(M3D={}));var SView;(function(e){var t=function(){function e(){this._isAsyncExecute=!1,this.listeners=[]}return e.prototype.AddListener=function(e){this.listeners.push(e)},e.prototype.Close=function(){this.GetManager()!=null&&this.GetManager().Complete(this),this.FireListener(e.CmdCompletedMsg)},e.prototype.Cancle=function(){},e.prototype.Execute=function(){this.GetManager().Run(this)},e.prototype.GetManager=function(){return this._cmdMng},e.prototype.GetName=function(){return this._name==null?this.toString():this._name},e.prototype.isAsyncExecute=function(){return this._isAsyncExecute},e.prototype.OnTouchHandle=function(e,t){return!1},e.prototype.SetAsyncExecute=function(e){this._isAsyncExecute=e},e.prototype.SetManager=function(e){this._cmdMng=e},e.prototype.SetName=function(e){this._name=e},e.prototype.FireListener=function(e){for(var t=0,n=this.listeners;t<n.length;t++){var r=n[t];r.OnHandle(this,e)}},e.CmdCompletedMsg=1,e.CmdPromptMsg=2,e}();e.Command=t})(SView||(SView={}));var SView;(function(e){var t=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.isAsyncExecute=function(){return!0},t.prototype.OnExecute=function(){},t}(e.Command);e.AsyncCommand=t})(SView||(SView={}));var SView;(function(e){var t=function(){function e(){}return e.prototype.OnHandle=function(e,t){},e}();e.CommandListener=t})(SView||(SView={}));var SView;(function(e){var t=function(){function t(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];this._commandList=[],this._historyList=[],this._isBusy=!1,this._cmdListener=new e.CommandListener;if(t.length!==0){var r=t[0];this.setSView(r)}}return t.prototype.AddCommand=function(e){return e.SetManager(this),e},t.prototype.Complete=function(e){this._commandList.splice(this._commandList.indexOf(e),1),this._historyList.push(e.GetName())},t.prototype.GetCurCommand=function(){return this._commandList.length!==0?this._commandList[0]:null},t.prototype.GetHistories=function(){return this._historyList},t.prototype.getSView=function(){return this._sview},t.prototype.Redo=function(){},t.prototype.setSView=function(e){this._sview=e},t.prototype.Undo=function(){},t.prototype.InnerRun=function(e){e.isAsyncExecute()||e.OnExecute()},t.prototype.Run=function(e){this._commandList.indexOf(e)===-1&&(this._commandList.push(e),e.AddListener(this._cmdListener)),this.InnerRun(e)},t.prototype.IsBusy=function(){return this._isBusy},t.prototype.SetBusy=function(e){this._isBusy=e},t}();e.CommandManager=t;var n=function(){function e(e){this.cmd=e}return e}();e.AsyncExecuteCommandTask=n})(SView||(SView={}));var SView;(function(e){var t;(function(e){e[e.MEASURE_DIAMETER=3]="MEASURE_DIAMETER",e[e.MEASURE_LENGTH=1]="MEASURE_LENGTH",e[e.MEASURE_NONE=0]="MEASURE_NONE",e[e.MEASURE_RADIUS=2]="MEASURE_RADIUS",e[e.MEASURE_DISTANCE=5]="MEASURE_DISTANCE",e[e.MEASURE_ANGLE=6]="MEASURE_ANGLE",e[e.MEASURE_PROPERTY=7]="MEASURE_PROPERTY",e[e.MEASURE_NOTE=8]="MEASURE_NOTE",e[e.MEASURE_TEXT_NOTE=9]="MEASURE_TEXT_NOTE",e[e.MEASURE_VOICE_NOTE=10]="MEASURE_VOICE_NOTE",e[e.MEASURE_EDIT=11]="MEASURE_EDIT",e[e.MEASURE_CT_TEXT_NOTE=30]="MEASURE_CT_TEXT_NOTE",e[e.MEASURE_PROPERTYNew=12]="MEASURE_PROPERTYNew",e[e.MEASURE_SEQUENCE_NUM=13]="MEASURE_SEQUENCE_NUM"})(t=e.MeasureCommandType||(e.MeasureCommandType={}));var n=function(n){function r(e){var r=n.call(this)||this;return r.sview=null,r._measureCommandManager=null,r._clickflag=!1,r._priDragX=0,r._priDragY=0,r._measure=null,r.measureStep=0,r._touchDownSelectedShape=null,r._onDrag=!1,r.sview=e,r.SetCommandType(t.MEASURE_NONE),r}return __extends(r,n),r.prototype.Close=function(){this.sview.view.SetSelectType(M3D.ShapeType.SHAPE_MODEL),n.prototype.Close.call(this)},r.prototype.GetMeasureCommandManager=function(){return this._measureCommandManager},r.prototype.SetMeasureCommandManager=function(e){this._measureCommandManager=e},r.prototype.GetMeasure=function(){return this._measure},r.prototype.SetMeasure=function(e){this._measure=e},r.prototype.SaveMeasure=function(e){var t=this.sview.GetMeasureManager();t.Add(e)},r.prototype.ExecuteNew=function(){this.sview!=null&&this._measureCommandManager.ExcuateCmmand(this.GetCommandType(),this._measure.GetMeasureType())},r.prototype.SetCommandType=function(e){this.measureCommandType=e},r.prototype.GetCommandType=function(){return this.measureCommandType},r.prototype.OnAsyncExecute=function(e){},r.prototype.SelectedPnt=function(e,t,n){var r=0;return n&&(r=this.sview.view.SelectTempShape(e,t,M3D.ShapeType.SHAPE_FEATURE_COORDINATE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN)),r>0||(r=this.sview.view.SelectTempShape(e,t,M3D.ShapeType.SHAPE_COORDINATE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN)),r},r.prototype.IsUseFeaturePnt=function(){return this._useFeaturePnt},r.prototype.SetUseFeaturePnt=function(e){this._useFeaturePnt=e},r.prototype.IsSingleClick=function(t){var n=!1;switch(t.getEventType()){case e.TOUCH_MASK.TOUCH_DOWN:t.getTouchCount()==1&&(this._clickflag=!0),this._previousX=t.getX(),this._previousY=t.getY();break;case e.TOUCH_MASK.TOUCH_MOVE:break;case e.TOUCH_MASK.TOUCH_UP:this._clickflag&&(n=!0),this._clickflag=!1}return n},r.prototype.RemoveModelParent=function(e){var t=!1,n=e.GetParent();n&&(this.sview.GetSelector().Exist(n)?(t=!0,this.sview.GetSelector().Remove(n)):this.RemoveModelParent(e.GetParent()))},r.prototype.ProcessEditAndDrag=function(t,n){var r=0;switch(n.getEventType()){case e.TOUCH_MASK.TOUCH_DOWN:if(n.getTouchCount()==1){this._priDragX=n.getX(),this._priDragY=n.getY();var i=this.sview.view.SelectTempShape(this._priDragX,this._priDragY,M3D.ShapeType.SHAPE_MEASURE_BASE,0);i>0?this._touchDownSelectedShape=this.sview.GetNativeShapeManager().GetShape(i):this._touchDownSelectedShape=null}break;case e.TOUCH_MASK.TOUCH_MOVE:if(n.getTouchCount()==1&&this._touchDownSelectedShape!=null){var s=new M3D.Vector2(this._priDragX,this._priDragY),o=new M3D.Vector2(n.getX(),n.getY()),u=s.Sub(o).Length();return u>1e-7&&(this._onDrag=!0),this._priDragX=n.getX(),this._priDragY=n.getY(),this.sview.view.UpdateMeasureImagePos(this._touchDownSelectedShape,this._priDragX,this._priDragY),1}break;case e.TOUCH_MASK.TOUCH_UP:this._touchDownSelectedShape=null}if(this._onDrag==1)return this._onDrag=!1,1;if(!this.IsSingleClick(n))return 2;var a=n.getX(),f=n.getY(),l=this.sview.view.SelectTempShape(n.getX(),n.getY(),M3D.ShapeType.SHAPE_MEASURE_BASE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN);if(l>0){var c=this.sview.GetNativeShapeManager().GetShape(l);c!=null&&(this.sview.GetSelector().Exist(c)?this.sview.GetSelector().Remove(c):this.sview.GetSelector().Add(c),r=1)}else if(M3D.Parameters.Instance().canPickModel){var h=this.sview.view.SelectTempShape(this._priDragX,this._priDragY,M3D.ShapeType.SHAPE_MODEL,0);if(h>0){var p=this.sview.GetShpae(h);if(p.GetName()==="floor"){this.sview.GetSelector().Clear();return}this.sview.GetSelector().Exist(p)?this.sview.GetSelector().Remove(p):p.IsSelected()?this.RemoveModelParent(p):this.sview.GetSelector().Add(p)}else this.sview.GetSelector().Clear()}else this.sview.GetSelector().Clear();return r},r.prototype.getMeasureStep=function(){return this.measureStep},r.prototype.setMeasureStep=function(e){this.measureStep=e},r}(e.AsyncCommand);e.MeasureCommand=n})(SView||(SView={}));var SView;(function(e){var t=function(t){function n(n){var r=t.call(this,n)||this;return r.SetCommandType(e.MeasureCommandType.MEASURE_ANGLE),r}return __extends(n,t),n.prototype.OnTouchHandle=function(t,n){var r=!1,i=this.ProcessEditAndDrag(t,n);if(i==1)return!0;if(i==2)return!1;var s=this.GetMeasure();if(s==null)return!1;var o=s.GetMeasureType();return o==e.SMeasure.MEASURE_TYPE_LINE_LINE_ANGLE?(this.LineToLineAngle(n),r=!0):o==e.SMeasure.MEASURE_TYPE_LINE_FACE_ANGLE?(this.LineToFaceAngle(n),r=!0):o==e.SMeasure.MEASURE_TYPE_FACE_FACE_ANGLE?(this.FaceToFaceAngle(n),r=!0):o==e.SMeasure.MEASURE_TYPE_CURVE_CURVE_ANGLE&&(this.CurveToCurveAngle(n),r=!0),r},n.prototype.CurveToCurveAngle=function(e){this.getMeasureStep()==0?this.CurveToCurveAngleStep0(e):this.getMeasureStep()==1?this.CurveToCurveAngleStep1(e):this.getMeasureStep()==2&&this.CurveToCurveAngleStep2(e)},n.prototype.CurveToCurveAngleStep0=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_EDGE;if(n==M3D.ShapeType.SHAPE_EDGE){var r=0,i=e.getX(),s=e.getY();r=this.sview.view.SelectTempShape(i,s,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN);var o=this.sview.view.SelectTempShape(i,s,M3D.ShapeType.SHAPE_COORDINATE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN);if(r!=0&&o!=0){var u=t.GetView().GetSceneManager().GetShape(r),a=t.GetView().GetSceneManager().GetShape(o),f=a,l=f.GetPosition().Clone();if(u===null||u===undefined){this.sview.view.RemoveShape(o);return}var c=u,h=c.GetLineData(),p=h.GetRefLine().GetPoints(),d=0,v=0,m=new M3D.Vector3,g=new M3D.Line3D,y=void 0,b=p.slice(h.GetDataOffset(),h.GetDataOffset()+h.GetDataLength());for(var w=0;w<b.length-1;w+=2){var E=new M3D.Line3D(b[w],b[w+1]),S=new M3D.LineAttribute;S.SetID(E.GetID()),S.SetDirection(new M3D.Vector3(E.GetPosition().x-E.GetEndPoint().x,E.GetPosition().y-E.GetEndPoint().y,E.GetPosition().z-E.GetEndPoint().z)),S.SetStartPoint(E.GetEndPoint()),S.SetEndPoint(E.GetPosition()),S.SetCenterPoint(new M3D.Vector3(NaN,NaN,NaN));var x=M3D.ShapeHelper.GetShapeWorldMatrix(c);M3D.GeometryHelper.Transform(S,x),d=M3D.MeasureCalculateHelper.PntLineDistance(l,S,d,y,m),w===0?(v=d,g=new M3D.Line3D(b[w],b[w+1])):v>d&&(v=d,g=new M3D
.Line3D(b[w],b[w+1]))}g.SetType(M3D.ShapeType.SHAPE_EDGE),this.sview.view.PreSelect(r,!0),t.SetFirstCurveLine(g),t.SetFirstShape(r),this.setMeasureStep(this.getMeasureStep()+1)}this.sview.view.RemoveShape(o)}},n.prototype.CurveToCurveAngleStep1=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_EDGE;if(n==M3D.ShapeType.SHAPE_EDGE){var r=0,i=e.getX(),s=e.getY();r=this.sview.view.SelectTempShape(i,s,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN);var o=this.sview.view.SelectTempShape(i,s,M3D.ShapeType.SHAPE_COORDINATE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN);if(r!=0&&o!=0){var u=t.GetView().GetSceneManager().GetShape(r),a=t.GetView().GetSceneManager().GetShape(o),f=a,l=f.GetPosition().Clone();if(u===null||u===undefined){this.sview.view.RemoveShape(o);return}var c=u,h=c.GetLineData(),p=h.GetRefLine().GetPoints(),d=0,v=0,m=new M3D.Vector3,g=new M3D.Line3D,y=void 0,b=p.slice(h.GetDataOffset(),h.GetDataOffset()+h.GetDataLength());for(var w=0;w<b.length-1;w+=2){var E=new M3D.Line3D(b[w],b[w+1]),S=new M3D.LineAttribute;S.SetID(E.GetID()),S.SetDirection(new M3D.Vector3(E.GetPosition().x-E.GetEndPoint().x,E.GetPosition().y-E.GetEndPoint().y,E.GetPosition().z-E.GetEndPoint().z)),S.SetStartPoint(E.GetEndPoint()),S.SetEndPoint(E.GetPosition()),S.SetCenterPoint(new M3D.Vector3(NaN,NaN,NaN));var x=M3D.ShapeHelper.GetShapeWorldMatrix(c);M3D.GeometryHelper.Transform(S,x),d=M3D.MeasureCalculateHelper.PntLineDistance(l,S,d,y,m),w===0?(v=d,g=new M3D.Line3D(b[w],b[w+1])):v>d&&(v=d,g=new M3D.Line3D(b[w],b[w+1]))}g.SetType(M3D.ShapeType.SHAPE_EDGE),this.sview.view.PreSelect(r,!0),t.SetSecondCurveLine(g),t.SetSecondShape(r),this.setMeasureStep(this.getMeasureStep()+1)}this.sview.view.RemoveShape(o)}},n.prototype.CurveToCurveAngleStep2=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.CreateCurve()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},n.prototype.FaceToFaceAngle=function(e){this.getMeasureStep()==0?this.FaceToFaceAngleStep0(e):this.getMeasureStep()==1?this.FaceToFaceAngleStep1(e):this.getMeasureStep()==2&&this.FaceToFaceAngleStep2(e)},n.prototype.FaceToFaceAngleStep0=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_FACE;if(n==M3D.ShapeType.SHAPE_FACE){var r=0,i=e.getX(),s=e.getY();r=this.sview.view.SelectTempShape(i,s,M3D.ShapeType.SHAPE_FACE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN),r!=0&&(this.sview.view.PreSelect(r,!0),t.SetFirstShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},n.prototype.FaceToFaceAngleStep1=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_FACE;if(n==M3D.ShapeType.SHAPE_FACE){var r=0,i=e.getX(),s=e.getY();r=this.sview.view.SelectTempShape(i,s,M3D.ShapeType.SHAPE_FACE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN),r!=0&&(this.sview.view.PreSelect(r,!0),t.SetSecondShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},n.prototype.FaceToFaceAngleStep2=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},n.prototype.LineToFaceAngle=function(e){this.getMeasureStep()==0?this.LineToFaceAngleStep0(e):this.getMeasureStep()==1?this.LineToFaceAngleStep1(e):this.getMeasureStep()==2&&this.LineToFaceAngleStep2(e)},n.prototype.LineToFaceAngleStep0=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_EDGE;if(n==M3D.ShapeType.SHAPE_EDGE){var r=0,i=e.getX(),s=e.getY();r=this.sview.view.SelectTempShape(i,s,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN),r!=0&&(this.sview.view.PreSelect(r,!0),t.SetFirstShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},n.prototype.LineToFaceAngleStep1=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_FACE;if(n==M3D.ShapeType.SHAPE_FACE){var r=0,i=e.getX(),s=e.getY();r=this.sview.view.SelectTempShape(i,s,M3D.ShapeType.SHAPE_FACE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN),r!=0&&(this.sview.view.PreSelect(r,!0),t.SetSecondShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},n.prototype.LineToFaceAngleStep2=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},n.prototype.LineToLineAngle=function(e){this.getMeasureStep()==0?this.LineToLineAngleStep0(e):this.getMeasureStep()==1?this.LineToLineAngleStep1(e):this.getMeasureStep()==2&&this.LineToLineAngleStep2(e)},n.prototype.LineToLineAngleStep0=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_EDGE;if(n==M3D.ShapeType.SHAPE_EDGE){var r=0,i=e.getX(),s=e.getY();r=this.sview.view.SelectTempShape(i,s,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN),r!=0&&(this.sview.view.PreSelect(r,!0),t.SetFirstShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},n.prototype.LineToLineAngleStep1=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_EDGE;if(n==M3D.ShapeType.SHAPE_EDGE){var r=0,i=e.getX(),s=e.getY();r=this.sview.view.SelectTempShape(i,s,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN),r!=0&&(this.sview.view.PreSelect(r,!0),t.SetSecondShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},n.prototype.LineToLineAngleStep2=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},n.prototype.ProcessError=function(){this.Close(),this.ExecuteNew(),this.sview.MeasureError()},n.prototype.Close=function(){t.prototype.Close.call(this),this.ClearTmpSource()},n.prototype.ClearTmpSource=function(){var t=this.GetMeasure();this.setMeasureStep(0);if(t==null)return;var n=t.GetMeasureType();if(n==e.SMeasure.MEASURE_TYPE_LINE_LINE_ANGLE){var r=t,i=r.GetFirstShape(),s=r.GetSecondShape();i>0&&this.sview.view.PreSelect(i,!1),s>0&&this.sview.view.PreSelect(s,!1)}else if(n==e.SMeasure.MEASURE_TYPE_LINE_FACE_ANGLE){var r=t,i=r.GetFirstShape(),s=r.GetSecondShape();i>0&&this.sview.view.PreSelect(i,!1),s>0&&this.sview.view.PreSelect(s,!1)}else if(n==e.SMeasure.MEASURE_TYPE_FACE_FACE_ANGLE){var r=t,i=r.GetFirstShape(),s=r.GetSecondShape();i>0&&this.sview.view.PreSelect(i,!1),s>0&&this.sview.view.PreSelect(s,!1)}else if(n==e.SMeasure.MEASURE_TYPE_CURVE_CURVE_ANGLE){var r=t,i=r.GetFirstShape(),s=r.GetSecondShape();i>0&&this.sview.view.PreSelect(i,!1),s>0&&this.sview.view.PreSelect(s,!1)}},n}(e.MeasureCommand);e.MeasureAngleCommand=t})(SView||(SView={}));var SView;(function(e){var t=function(){function t(t){this._commandsMap=new M3D.Map,this._currentCommand=null,this._measureCommandType=e.MeasureCommandType.MEASURE_NONE,this._sview=null,this.SetSviewControl(t)}return t.prototype.GetCurrentCommand=function(){return this._currentCommand},t.prototype.SetCurrentCommand=function(e){this._currentCommand=e},t.prototype.CloseCurrentCommand=function(){this._currentCommand!=null&&(this._currentCommand.Close(),this._currentCommand=null)},t.prototype.SetSviewControl=function(e){this._sview=e},t.prototype.GetSviewControl=function(){return this._sview},t.prototype.ExecuteEditCommand=function(){this.CloseCurrentCommand(),this._sview.view.SetSelectType(M3D.ShapeType.SHAPE_NOTE_BASE),this.ExcuateCmmand(e.MeasureCommandType.MEASURE_EDIT,e.SMeasure.MEASURE_TYPE_BASE)},t.prototype.CloseAllCommand=function(){this._currentCommand=null,this._measureCommandType=e.MeasureCommandType.MEASURE_NONE;var t=this._commandsMap.Values();for(var n=0,r=t;n<r.length;n++){var i=r[n];i.Close()}this._commandsMap.Clear()},t.prototype.ExcuateCmmand=function(e,t){this._currentCommand=this.GetCommand(e);if(this._currentCommand!=null){this._measureCommandType=e,this.GetSviewControl().GetCommandManager().AddCommand(this._currentCommand);var n=this.CreateMeasure(e);n.SetMeasureType(t),this._currentCommand.SetMeasure(n),this._currentCommand.SetMeasureCommandManager(this),this._currentCommand.Execute()}},t.prototype.CreateMeasure=function(t){var n=null;switch(t){case e.MeasureCommandType.MEASURE_DISTANCE:n=new e.SMeasureDistance;break;case e.MeasureCommandType.MEASURE_ANGLE:n=new e.SMeasureAngle;break;case e.MeasureCommandType.MEASURE_PROPERTY:n=new e.SMeasureProperty;break;case e.MeasureCommandType.MEASURE_PROPERTYNew:break;case e.MeasureCommandType.MEASURE_TEXT_NOTE:n=new e.STextNote;break;case e.MeasureCommandType.MEASURE_CT_TEXT_NOTE:break;case e.MeasureCommandType.MEASURE_VOICE_NOTE:n=new e.SVoiceNote;break;case e.MeasureCommandType.MEASURE_SEQUENCE_NUM:n=new e.SSequenceNumberNote;break;case e.MeasureCommandType.MEASURE_EDIT:n=new e.SMeasure}return n!=null&&n.SetView(this.GetSviewControl().view),n},t.prototype.ExcuteCommand=function(e,t){this._currentCommand=this.GetCommand(e),this._currentCommand!=null&&(this._measureCommandType=e,this._sview.GetCommandManager().AddCommand(this._currentCommand),this._currentCommand.SetMeasure(t),this._currentCommand.Execute())},t.prototype.GetMeasureCommandType=function(){return this._measureCommandType},t.prototype.Undo=function(){this._currentCommand!=null},t.prototype.GetCommand=function(t){var n=null;this._commandsMap.ContainKey(t)||this._commandsMap.Put(t,null);switch(t){case e.MeasureCommandType.MEASURE_LENGTH:this._commandsMap.Size()==0||this._commandsMap.Get(t)==null;break;case e.MeasureCommandType.MEASURE_DIAMETER:this._commandsMap.Size()==0||this._commandsMap.Get(t)==null;break;case e.MeasureCommandType.MEASURE_RADIUS:this._commandsMap.Size()==0||this._commandsMap.Get(t)==null;break;default:case e.MeasureCommandType.MEASURE_DISTANCE:(this._commandsMap.Size()==0||this._commandsMap.Get(t)==null)&&this._commandsMap.Put(e.MeasureCommandType.MEASURE_DISTANCE,new e.MeasureDistanceCommand(this._sview));break;case e.MeasureCommandType.MEASURE_ANGLE:(this._commandsMap.Size()==0||this._commandsMap.Get(t)==null)&&this._commandsMap.Put(e.MeasureCommandType.MEASURE_ANGLE,new e.MeasureAngleCommand(this._sview));break;case e.MeasureCommandType.MEASURE_PROPERTY:(this._commandsMap.Size()==0||this._commandsMap.Get(t)==null)&&this._commandsMap.Put(e.MeasureCommandType.MEASURE_PROPERTY,new e.MeasurePorpertyCommand(this._sview));break;case e.MeasureCommandType.MEASURE_TEXT_NOTE:if(this._commandsMap.Size()==0||this._commandsMap.Get(t)==null){var r=new e.TextNoteCommand(this._sview);this._commandsMap.Put(e.MeasureCommandType.MEASURE_TEXT_NOTE,r)}break;case e.MeasureCommandType.MEASURE_VOICE_NOTE:if(this._commandsMap.Size()==0||this._commandsMap.Get(t)==null)this._commandsMap[e.MeasureCommandType.MEASURE_VOICE_NOTE]=new e.VoiceNoteCommand(this._sview);break;case e.MeasureCommandType.MEASURE_SEQUENCE_NUM:if(this._commandsMap.Size()==0||this._commandsMap.Get(t)==null){var r=new e.SequenceNumberNoteCommand(this._sview);this._commandsMap.Put(e.MeasureCommandType.MEASURE_SEQUENCE_NUM,r)}break;case e.MeasureCommandType.MEASURE_EDIT:if(this._commandsMap.Size()==0||this._commandsMap.Get(t)==null){var r=new e.MeasureEditCommand(this._sview);this._commandsMap.Put(e.MeasureCommandType.MEASURE_EDIT,r)}break;case e.MeasureCommandType.MEASURE_PROPERTYNew:this._commandsMap.Size()==0||this._commandsMap.Get(t)==null}return n=this._commandsMap.Get(t),n},t}();e.MeasureCommandManager=t})(SView||(SView={}));var SView;(function(e){var t=function(t){function n(n){var r=t.call(this,n)||this;return r.SetCommandType(e.MeasureCommandType.MEASURE_DISTANCE),r}return __extends(n,t),n.prototype.OnTouchHandle=function(t,n){var r=!1,i=this.ProcessEditAndDrag(t,n);if(i==1)return!0;if(i==2)return!1;var s=this.GetMeasure();if(s==null)return!1;var o=s.GetMeasureType();return o==e.SMeasure.MEASURE_TYPE_PNT_PNT_DISTANCE?(this.PntToPntDistance(n),r=!0):o==e.SMeasure.MEASURE_TYPE_PNT_LINE_DISTANCE?(this.PntToLineDistance(n),r=!0):o==e.SMeasure.MEASURE_TYPE_PNT_FACE_DISTANCE?(this.PntToFaceDistance(n),r=!0):o==e.SMeasure.MEASURE_TYPE_LINE_LINE_DISTANCE?(this.LineToLineDistance(n),r=!0):o==e.SMeasure.MEASURE_TYPE_LINE_FACE_DISTANCE?(this.LineToFaceDistance(n),r=!0):o==e.SMeasure.MEASURE_TYPE_FACE_FACE_DISTANCE&&(this.FaceToFaceDistance(n),r=!0),r},n.prototype.PntToPntDistance=function(e){this.getMeasureStep()==0?this.PntToPntStep0(e):this.getMeasureStep()==1?this.PntToPntStep1(e):this.getMeasureStep()==2&&this.PntToPntStep2(e)},n.prototype.PntToLineDistance=function(e){this.getMeasureStep()==0?this.PntToLineStep0(e):this.getMeasureStep()==1?this.PntToLineStep1(e):this.getMeasureStep()==2&&this.PntToLineStep2(e)},n.prototype.PntToFaceDistance=function(e){this.getMeasureStep()==0?this.PntToFaceStep0(e):this.getMeasureStep()==1?this.PntToFaceStep1(e):this.getMeasureStep()==2&&this.PntToFaceStep2(e)},n.prototype.LineToLineDistance=function(e){this.getMeasureStep()==0?this.LineToLineStep0(e):this.getMeasureStep()==1?this.LineToLineStep1(e):this.getMeasureStep()==2&&this.LineToLineStep2(e)},n.prototype.LineToFaceDistance=function(e){this.getMeasureStep()==0?this.LineToFaceStep0(e):this.getMeasureStep()==1?this.LineToFaceStep1(e):this.getMeasureStep()==2&&this.LineToFaceStep2(e)},n.prototype.FaceToFaceDistance=function(e){this.getMeasureStep()==0?this.FaceToFaceStep0(e):this.getMeasureStep()==1?this.FaceToFaceStep1(e):this.getMeasureStep()==2&&this.FaceToFaceStep2(e)},n.prototype.PntToPntStep2=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},n.prototype.PntToPntStep1=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_COORDINATE;if(n==M3D.ShapeType.SHAPE_COORDINATE&&n==M3D.ShapeType.SHAPE_COORDINATE){var r=0,i=e.getX(),s=e.getY();r=this.SelectedPnt(i,s,this.IsUseFeaturePnt()),r!=0&&(t.SetSecondShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},n.prototype.PntToPntStep0=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_COORDINATE;if(n==M3D.ShapeType.SHAPE_COORDINATE){var r=0,i=e.getX(),s=e.getY();r=this.SelectedPnt(i,s,this.IsUseFeaturePnt()),r!=0&&(t.SetFirstShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},n.prototype.PntToLineStep0=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_COORDINATE;if(n==M3D.ShapeType.SHAPE_COORDINATE){var r=0,i=e.getX(),s=e.getY();r=this.SelectedPnt(i,s,this.IsUseFeaturePnt()),r!=0&&(t.SetFirstShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},n.prototype.PntToLineStep1=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_EDGE;if(n==M3D.ShapeType.SHAPE_EDGE){var r=0,i=e.getX(),s=e.getY();r=this.sview.view.SelectTempShape(i,s,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN),r!=0&&(this.sview.view.PreSelect(r,!0),t.SetSecondShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},n.prototype.PntToLineStep2=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},n.prototype.PntToFaceStep0=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_COORDINATE;if(n==M3D.ShapeType.SHAPE_COORDINATE){var r=0,i=e.getX(),s=e.getY();r=this.SelectedPnt(i,s,this.IsUseFeaturePnt()),r!=0&&(t.SetFirstShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},n.prototype.PntToFaceStep1=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_FACE;if(n==M3D.ShapeType.SHAPE_FACE){var r=0,i=e.getX(),s=e.getY();r=this.sview.view.SelectTempShape(i,s,M3D.ShapeType.SHAPE_FACE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN),r!=0&&(this.sview.view.PreSelect(r,!0),t.SetSecondShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},n.prototype.PntToFaceStep2=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},n.prototype.LineToLineStep0=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_EDGE;if(n==M3D.ShapeType.SHAPE_EDGE){var r=0,i=e.getX(),s=e.getY(),o=this.sview.view.GetPickShape(i,s,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN);o&&(r=o.GetID()),r!=0&&(this.sview.view.PreSelect(r,!0),t.SetFirstShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},n.prototype.LineToLineStep1=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_EDGE;if(n==M3D.ShapeType.SHAPE_EDGE){var r=0,i=e.getX(),s=e.getY(),o=this.sview.view.GetPickShape(i,s,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN);o&&(r=o.GetID()),r!=0&&(this.sview.view.PreSelect(r,!0),t.SetSecondShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},n.prototype.LineToLineStep2=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},n.prototype.LineToFaceStep0=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_EDGE;if(n==M3D.ShapeType.SHAPE_EDGE){var r=0,i=e.getX(),s=e.getY();r=this.sview.view.SelectTempShape(i,s,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN),r!=0&&(this.sview.view.PreSelect(r,!0),t.SetFirstShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},n.prototype.LineToFaceStep1=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_FACE;if(n==M3D.ShapeType.SHAPE_FACE){var r=0,i=e.getX(),s=e.getY();r=this.sview.view.SelectTempShape(i,s,M3D.ShapeType.SHAPE_FACE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN),r!=0&&(this.sview.view.PreSelect(r,!0),t.SetSecondShape(r),this.setMeasureStep(this.getMeasureStep()+1))}},n.prototype.LineToFaceStep2=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},n.prototype.FaceToFaceStep0=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_FACE;if(n==M3D.ShapeType.SHAPE_FACE){var r=0,i=e.getX(),s=e.getY();r=this.sview.view.SelectTempShape(i,s,M3D.ShapeType.SHAPE_FACE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN);if(r!=0){var o=this.SelectedPnt(i,s,!1);o!=0&&(t.SetFristAnChorShape(o),this.sview.view.PreSelect(r,!0),t.SetFirstShape(r),this.setMeasureStep(this.getMeasureStep()+1))}}},n.prototype.FaceToFaceStep1=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_FACE;if(n==M3D.ShapeType.SHAPE_FACE){var r=0,i=e.getX(),s=e.getY();r=this.sview.view.SelectTempShape(i,s,M3D.ShapeType.SHAPE_FACE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN);if(r!=0){var o=this.SelectedPnt(i,s,!1);o!=0&&(t.SetSecondAnChorShape(o),this.sview.view.PreSelect(r,!0),t.SetSecondShape(r),this.setMeasureStep(this.getMeasureStep()+1))}}},n.prototype.FaceToFaceStep2=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},n.prototype.ProcessError=function(){this.Close(),this.ExecuteNew(),this.sview.MeasureError()},n.prototype.Close=function(){t.prototype.Close.call(this),this.ClearTmpSource()},n.prototype.ClearTmpSource=function(){var t=this.GetMeasure();this.setMeasureStep(0);if(t==null)return;var n=t.GetMeasureType();if(n==e.SMeasure.MEASURE_TYPE_PNT_PNT_DISTANCE&&t instanceof e.SMeasureDistance){var r=t,i=r.GetFirstShape(),s=r.GetSecondShape();i>0&&this.sview.view.RemoveShape(i),s>0&&this.sview.view.RemoveShape(s)}else if(n==e.SMeasure.MEASURE_TYPE_PNT_LINE_DISTANCE&&t instanceof e.SMeasureDistance){var r=t,i=r.GetFirstShape(),s=r.GetSecondShape();i>0&&this.sview.view.RemoveShape(i),s>0&&this.sview.view.PreSelect(s,!1)}else if(n==e.SMeasure.MEASURE_TYPE_PNT_FACE_DISTANCE&&t instanceof e.SMeasureDistance){var r=t,i=r.GetFirstShape(),s=r.GetSecondShape();i>0&&this.sview.view.RemoveShape(i),s>0&&this.sview.view.PreSelect(s,!1)}else if(n==e.SMeasure.MEASURE_TYPE_LINE_LINE_DISTANCE&&t instanceof e.SMeasureDistance){var r=t,i=r.GetFirstShape(),s=r.GetSecondShape();i>0&&this.sview.view.PreSelect(i,!1),s>0&&this.sview.view.PreSelect(s,!1)}else if(n==e.SMeasure.MEASURE_TYPE_LINE_FACE_DISTANCE&&t instanceof e.SMeasureDistance){var r=t,i=r.GetFirstShape(),s=r.GetSecondShape();i>0&&this.sview.view.PreSelect(i,!1),s>0&&this.sview.view.PreSelect(s,!1)}else if(n==e.SMeasure.MEASURE_TYPE_FACE_FACE_DISTANCE&&t instanceof e.SMeasureDistance){var r=t,i=r.GetFirstShape(),s=r.GetSecondShape(),o=r.GetFristAnChorShape(),u=r.GetSecondAnChorShape();i>0&&this.sview.view.PreSelect(i,!1),s>0&&this.sview.view.PreSelect(s,!1),o>0&&this.sview.view.RemoveShape(o),u>0&&this.sview.view.RemoveShape(u)}},n}(e.MeasureCommand);e.MeasureDistanceCommand=t})(SView||(SView={}));var SView;(function(e){var t=function(t){function n(n){var r=t.call(this,n)||this;return r.SetCommandType(e.MeasureCommandType.MEASURE_EDIT),n.view.SetSelectType(M3D.ShapeType.SHAPE_MEASURE_BASE),r}return __extends(n,t),n.prototype.OnTouchHandle=function(e,t){var n=!1,r=this.ProcessEditAndDrag(e,t);return r==1?!0:r==2?!1:r==0?!0:n},n}(e.MeasureCommand);e.MeasureEditCommand=t})(SView||(SView={}));var SView;(function(e){var t=function(){function t(){}return t.onTextNote=function(t){var n=t.GetMeasureCommandManager(),r=n.GetCurrentCommand();if(r!=null){var i=r.GetMeasure().GetMeasureType();i!=e.SMeasure.MEASURE_TEXT_NOTE?(n.CloseCurrentCommand(),n.ExcuateCmmand(e.MeasureCommandType.MEASURE_TEXT_NOTE,e.SMeasure.MEASURE_TEXT_NOTE)):n.ExecuteEditCommand()}else n.ExcuateCmmand(e.MeasureCommandType.MEASURE_TEXT_NOTE,e.SMeasure.MEASURE_TEXT_NOTE)},t.onVoiceNote=function(t){var n=t.GetMeasureCommandManager(),r=n.GetCurrentCommand();if(r!=null){var i=r.GetMeasure().GetMeasureType();i!=e.SMeasure.MEASURE_VOICE_NOTE?(n.CloseCurrentCommand(),n.ExcuateCmmand(e.MeasureCommandType.MEASURE_VOICE_NOTE,e.SMeasure.MEASURE_VOICE_NOTE)):n.ExecuteEditCommand()}else n.ExcuateCmmand(e.MeasureCommandType.MEASURE_VOICE_NOTE,e.SMeasure.MEASURE_VOICE_NOTE)},t.onSequenceNote=function(t){var n=t.GetMeasureCommandManager(),r=n.GetCurrentCommand();if(r!=null){var i=r.GetMeasure().GetMeasureType();i!=e.SMeasure.MEASURE_SEQUENCE_NUMBER_NOTE?(n.CloseCurrentCommand(),n.ExcuateCmmand(e.MeasureCommandType.MEASURE_SEQUENCE_NUM,e.SMeasure.MEASURE_SEQUENCE_NUMBER_NOTE)):n.ExecuteEditCommand()}else n.ExcuateCmmand(e.MeasureCommandType.MEASURE_SEQUENCE_NUM,e.SMeasure.MEASURE_SEQUENCE_NUMBER_NOTE)},t.onMeasureDistancePntToPnt=function(t){var n=t.GetMeasureCommandManager(),r=n.GetCurrentCommand();if(r!=null){var i=r.GetMeasure().GetMeasureType();i!=e.SMeasure.MEASURE_TYPE_PNT_PNT_DISTANCE?(n.CloseCurrentCommand(),n.ExcuateCmmand(e.MeasureCommandType.MEASURE_DISTANCE,e.SMeasure.MEASURE_TYPE_PNT_PNT_DISTANCE)):n.ExecuteEditCommand()}else n.ExcuateCmmand(e.MeasureCommandType.MEASURE_DISTANCE,e.SMeasure.MEASURE_TYPE_PNT_PNT_DISTANCE)},t.onMeasureDistancePntToLine=function(t){var n=t.GetMeasureCommandManager(),r=n.GetCurrentCommand();if(r!=null){var i=r.GetMeasure().GetMeasureType();i!=e.SMeasure.MEASURE_TYPE_PNT_LINE_DISTANCE?(n.CloseCurrentCommand(),n.ExcuateCmmand(e.MeasureCommandType.MEASURE_DISTANCE,e.SMeasure.MEASURE_TYPE_PNT_LINE_DISTANCE)):n.ExecuteEditCommand()}else n.ExcuateCmmand(e.MeasureCommandType.MEASURE_DISTANCE,e.SMeasure.MEASURE_TYPE_PNT_LINE_DISTANCE)},t.onMeasureDistancePntToFace=function(t){var n=t.GetMeasureCommandManager(),r=n.GetCurrentCommand();if(r!=null){var i=r.GetMeasure().GetMeasureType();i!=e.SMeasure.MEASURE_TYPE_PNT_FACE_DISTANCE?(n.CloseCurrentCommand(),n.ExcuateCmmand(e.MeasureCommandType.MEASURE_DISTANCE,e.SMeasure.MEASURE_TYPE_PNT_FACE_DISTANCE)):n.ExecuteEditCommand()}else n.ExcuateCmmand(e.MeasureCommandType.MEASURE_DISTANCE,e.SMeasure.MEASURE_TYPE_PNT_FACE_DISTANCE)},t.onMeasureDistanceLineToLine=function(t){var n=t.GetMeasureCommandManager(),r=n.GetCurrentCommand();if(r!=null){var i=r.GetMeasure().GetMeasureType();i!=e.SMeasure.MEASURE_TYPE_LINE_LINE_DISTANCE?(n.CloseCurrentCommand(),n.ExcuateCmmand(e.MeasureCommandType.MEASURE_DISTANCE,e.SMeasure.MEASURE_TYPE_LINE_LINE_DISTANCE)):n.ExecuteEditCommand()}else n.ExcuateCmmand(e.MeasureCommandType.MEASURE_DISTANCE,e.SMeasure.MEASURE_TYPE_LINE_LINE_DISTANCE)},t.onMeasureDistanceLineToFace=function(t){var n=t.GetMeasureCommandManager(),r=n.GetCurrentCommand();if(r!=null){var i=r.GetMeasure().GetMeasureType();i!=e.SMeasure.MEASURE_TYPE_LINE_FACE_DISTANCE?(n.CloseCurrentCommand(),n.ExcuateCmmand(e.MeasureCommandType.MEASURE_DISTANCE,e.SMeasure.MEASURE_TYPE_LINE_FACE_DISTANCE)):n.ExecuteEditCommand()}else n.ExcuateCmmand(e.MeasureCommandType.MEASURE_DISTANCE,e.SMeasure.MEASURE_TYPE_LINE_FACE_DISTANCE)},t.onMeasureDistanceFaceToFace=function(t){var n=t.GetMeasureCommandManager(),r=n.GetCurrentCommand();if(r!=null){var i=r.GetMeasure().GetMeasureType();i!=e.SMeasure.MEASURE_TYPE_FACE_FACE_DISTANCE?(n.CloseCurrentCommand(),n.ExcuateCmmand(e.MeasureCommandType.MEASURE_DISTANCE,e.SMeasure.MEASURE_TYPE_FACE_FACE_DISTANCE)):n.ExecuteEditCommand()}else n.ExcuateCmmand(e.MeasureCommandType.MEASURE_DISTANCE,e.SMeasure.MEASURE_TYPE_FACE_FACE_DISTANCE)},t.onMeasureAngleLineToLine=function(t){var n=t.GetMeasureCommandManager(),r=n.GetCurrentCommand();if(r!=null){var i=r.GetMeasure().GetMeasureType();i!=e.SMeasure.MEASURE_TYPE_LINE_LINE_ANGLE?(n.CloseCurrentCommand(),n.ExcuateCmmand(e.MeasureCommandType.MEASURE_ANGLE,e.SMeasure.MEASURE_TYPE_LINE_LINE_ANGLE)):n.ExecuteEditCommand()}else n.ExcuateCmmand(e.MeasureCommandType.MEASURE_ANGLE,e.SMeasure.MEASURE_TYPE_LINE_LINE_ANGLE)},t.onMeasureAngleLineToFace=function(t){var n=t.GetMeasureCommandManager(),r=n.GetCurrentCommand();if(r!=null){var i=r.GetMeasure().GetMeasureType();i!=e.SMeasure.MEASURE_TYPE_LINE_FACE_ANGLE?(n.CloseCurrentCommand(),n.ExcuateCmmand(e.MeasureCommandType.MEASURE_ANGLE,e.SMeasure.MEASURE_TYPE_LINE_FACE_ANGLE)):n.ExecuteEditCommand()}else n.ExcuateCmmand(e.MeasureCommandType.MEASURE_ANGLE,e.SMeasure.MEASURE_TYPE_LINE_FACE_ANGLE)},t.onMeasureAngleFaceToFace=function(t){var n=t.GetMeasureCommandManager(),r=n.GetCurrentCommand();if(r!=null){var i=r.GetMeasure().GetMeasureType();i!=e.SMeasure.MEASURE_TYPE_FACE_FACE_ANGLE?(n.CloseCurrentCommand(),n.ExcuateCmmand(e.MeasureCommandType.MEASURE_ANGLE,e.SMeasure.MEASURE_TYPE_FACE_FACE_ANGLE)):n.ExecuteEditCommand()}else n.ExcuateCmmand(e.MeasureCommandType.MEASURE_ANGLE,e.SMeasure.MEASURE_TYPE_FACE_FACE_ANGLE)},t.onMeasureAngleCurveToCurve=function(t){var n=t.GetMeasureCommandManager(),r=n.GetCurrentCommand();if(r!=null){var i=r.GetMeasure().GetMeasureType();i!=e.SMeasure.MEASURE_TYPE_CURVE_CURVE_ANGLE?(n.CloseCurrentCommand(),n.ExcuateCmmand(e.MeasureCommandType.MEASURE_ANGLE,e.SMeasure.MEASURE_TYPE_CURVE_CURVE_ANGLE)):n.ExecuteEditCommand()}else n.ExcuateCmmand(e.MeasureCommandType.MEASURE_ANGLE,e.SMeasure.MEASURE_TYPE_CURVE_CURVE_ANGLE)},t.onMeasurePropertyPnt=function(t){var n=t.GetMeasureCommandManager(),r=n.GetCurrentCommand();if(r!=null){var i=r.GetMeasure().GetMeasureType();i!=e.SMeasure.MEASURE_TYPE_PNT_COORD?(n.CloseCurrentCommand(),n.ExcuateCmmand(e.MeasureCommandType.MEASURE_PROPERTY,e.SMeasure.MEASURE_TYPE_PNT_COORD)):n.ExecuteEditCommand()}else n.ExcuateCmmand(e.MeasureCommandType.MEASURE_PROPERTY,e.SMeasure.MEASURE_TYPE_PNT_COORD)},t.onMeasurePropertyModel=function(t){var n=t.GetMeasureCommandManager(),r=n.GetCurrentCommand();if(r!=null){var i=r.GetMeasure().GetMeasureType();i!=e.SMeasure.MEASURE_TYPE_MODEL?(n.CloseCurrentCommand(),n.ExcuateCmmand(e.MeasureCommandType.MEASURE_PROPERTY,e.SMeasure.MEASURE_TYPE_MODEL)):n.ExecuteEditCommand()}else n.ExcuateCmmand(e.MeasureCommandType.MEASURE_PROPERTY,e.SMeasure.MEASURE_TYPE_MODEL)},t.onMeasurePropertyLine=function(t){var n=t.GetMeasureCommandManager(),r=n.GetCurrentCommand();if(r!=null){var i=r.GetMeasure().GetMeasureType();i!=e.SMeasure.MEASURE_TYPE_LENGTH?(n.CloseCurrentCommand(),n.ExcuateCmmand(e.MeasureCommandType.MEASURE_PROPERTY,e.SMeasure.MEASURE_TYPE_LENGTH)):n.ExecuteEditCommand()}else n.ExcuateCmmand(e.MeasureCommandType.MEASURE_PROPERTY,e.SMeasure.MEASURE_TYPE_LENGTH)},t.onMeasurePropertyFace=function(t){var n=t.GetMeasureCommandManager(),r=n.GetCurrentCommand();if(r!=null){var i=r.GetMeasure().GetMeasureType();i!=e.SMeasure.MEASURE_TYPE_CIRCLE?(n.CloseCurrentCommand(),n.ExcuateCmmand(e.MeasureCommandType.MEASURE_PROPERTY,e.SMeasure.MEASURE_TYPE_CIRCLE)):n.ExecuteEditCommand()}else n.ExcuateCmmand(e.MeasureCommandType.MEASURE_PROPERTY,e.SMeasure.MEASURE_TYPE_CIRCLE)},t.onNoteDelete=function(e){var t=e.GetSelector();if(t!=null){var n=new Array,r=t.GetAll();for(var i=0;i<r.length;i++)n.push(r[i]);n.length>0&&t.Clear();for(var i=0;i<n.length;i++){var s=n[i];e.GetNativeShapeManager().RemoveShape(s.GetID()),e.view.RemoveShape(s.GetID())}}},t.onMeasureExit=function(e){var t=e.GetMeasureCommandManager();t.CloseAllCommand(),e.GetMeasureManager().Clear()},t.onTextNoteDelete=function(e){var t=e.GetMeasureCommandManager()},t.onBase=function(t){var n=t.GetMeasureCommandManager(),r=n.GetCurrentCommand();r!=null?n.ExecuteEditCommand():n.ExcuateCmmand(e.MeasureCommandType.MEASURE_EDIT,e.SMeasure.MEASURE_TYPE_BASE)},t}();e.MeasureOperate=t})(SView||(SView={}));var SView;(function(e){var t=function(t){function n(n){var r=t.call(this,n)||this;return r.SetCommandType(e.MeasureCommandType.MEASURE_PROPERTY),r}return __extends(n,t),n.prototype.OnTouchHandle=function(t,n){var r=!1,i=this.ProcessEditAndDrag(t,n);if(i==1)return!0;if(i==2)return!1;var s=this.GetMeasure();if(s==null)return!1;var o=s.GetMeasureType();return o==e.SMeasure.MEASURE_TYPE_PNT_COORD?(this.CoordPorperty(n),r=!0):o==e.SMeasure.MEASURE_TYPE_LENGTH?(this.LengthPorperty(n),r=!0):o==e.SMeasure.MEASURE_TYPE_CIRCLE?(this.CirclePorperty(n),r=!0):o==e.SMeasure.MEASURE_TYPE_MODEL&&(this.ModelPorperty(n),r=!0),r},n.prototype.ModelPorperty=function(e){this.getMeasureStep()==0&&this.ModelPorpertyStep0(e)},n.prototype.ModelPorpertyStep0=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_MODEL;if(n==M3D.ShapeType.SHAPE_MODEL){this.UiShowBegin(t);var r=0,i=e.getX(),s=e.getY();r=this.sview.view.SelectTempShape(i,s,M3D.ShapeType.SHAPE_MODEL,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN),t.SetPropertyShape(r),r!=0&&this.sview.view.PreSelect(r,!0),this.UiShowEnd(t)}},n.prototype.ModelPorpertyStep1=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()&&(this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew())},n.prototype.CoordPorperty=function(e){this.getMeasureStep()==0?this.CoordPorpertyStep0(e):this.getMeasureStep()==1&&this.CoordPorpertyStep1(e)},n.prototype.LengthPorperty=function(e){this.getMeasureStep()==0?this.LengthPorpertyStep0(e):this.getMeasureStep()==1&&this.LengthPorpertyStep1(e)},n.prototype.CirclePorperty=function(e){this.getMeasureStep()==0?this.CirclePorpertyStep0(e):this.getMeasureStep()==1&&this.CirclePorpertyStep1(e)},n.prototype.CirclePorpertyStep0=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_FACE;if(n==M3D.ShapeType.SHAPE_FACE){this.UiShowBegin(t);var r=0,i=e.getX(),s=e.getY();r=this.sview.view.SelectTempShape(i,s,M3D.ShapeType.SHAPE_FACE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN),t.SetPropertyShape(r),r!=0&&(this.sview.view.PreSelect(r,!0),this.setMeasureStep(this.getMeasureStep()+1)),this.UiShowEnd(t)}},n.prototype.CirclePorpertyStep1=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()&&(this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew())},n.prototype.LengthPorpertyStep0=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_EDGE;if(n==M3D.ShapeType.SHAPE_EDGE){this.UiShowBegin(t);var r=0,i=e.getX(),s=e.getY();r=this.sview.view.SelectTempShape(i,s,M3D.ShapeType.SHAPE_EDGE,M3D.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN),t.SetPropertyShape(r),r!=0&&(this.sview.view.PreSelect(r,!0),this.setMeasureStep(this.getMeasureStep()+1)),this.UiShowEnd(t)}},n.prototype.LengthPorpertyStep1=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()&&(this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew())},n.prototype.CoordPorpertyStep0=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_COORDINATE;if(n==M3D.ShapeType
.SHAPE_COORDINATE){this.UiShowBegin(t);var r=0,i=e.getX(),s=e.getY();r=this.SelectedPnt(i,s,this.IsUseFeaturePnt()),r!=0&&(t.SetPropertyShape(r),this.setMeasureStep(this.getMeasureStep()+1)),this.UiShowEnd(t)}},n.prototype.CoordPorpertyStep1=function(e){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),t.Create()&&(this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew())},n.prototype.UiShowBegin=function(t){t.GetShowType()==e.SMeasureProperty.UI_SHOW&&this.ClearTmpSource()},n.prototype.UiShowEnd=function(t){if(t.GetShowType()==e.SMeasureProperty.UI_SHOW){if(t.Create()){this.setMeasureStep(0),this.ShowPropertiesDialog(t);return}t.GetPropertyShape()!=0&&(this.setMeasureStep(0),this.ShowPropertiesDialog(t))}else this.ClearTmpSource()},n.prototype.ShowPropertiesDialog=function(e){var t=e.GetMeasureProperties();t!=null&&t.length>0&&this.sview.MeasurePropertyStr(t)},n.prototype.ClearTmpSource=function(){var t=this.GetMeasure();this.setMeasureStep(0);if(t==null)return;var n=t.GetMeasureType();if(n==e.SMeasure.MEASURE_TYPE_PNT_COORD&&t instanceof e.SMeasureProperty){var r=t,i=r.GetPropertyShape();i>0&&this.sview.view.RemoveShape(i)}else{var r=t,i=r.GetPropertyShape();i>0&&this.sview.view.PreSelect(i,!1)}},n.prototype.Close=function(){t.prototype.Close.call(this),this.ClearTmpSource()},n}(e.MeasureCommand);e.MeasurePorpertyCommand=t})(SView||(SView={}));var SView;(function(e){var t;(function(e){e[e.TOUCH_DOWN=0]="TOUCH_DOWN",e[e.TOUCH_MOVE=1]="TOUCH_MOVE",e[e.TOUCH_UP=2]="TOUCH_UP",e[e.TOUCH_CANCELLED=3]="TOUCH_CANCELLED"})(t=e.TOUCH_MASK||(e.TOUCH_MASK={}));var n=function(){function e(e,t,n){this.touchCount=0,this.x=0,this.y=0,this.mouseEvent=e,this.x=t,this.y=n}return e.prototype.getEventType=function(){return this.eventType},e.prototype.setEventType=function(e){this.eventType=e},e.prototype.getMouseEvent=function(){return this.mouseEvent},e.prototype.setMouseEvent=function(e){this.mouseEvent=e},e.prototype.getX=function(){return this.x},e.prototype.setX=function(e){this.x=e},e.prototype.getY=function(){return this.y},e.prototype.setY=function(e){this.y=e},e.prototype.getTouchCount=function(){return this.touchCount},e.prototype.setTouchCount=function(e){this.touchCount=e},e}();e.MotionEvent=n})(SView||(SView={}));var M3D;(function(e){var t=function(){function t(e){this.view=null,this.view=e}return t.prototype.Traver=function(e,t){var n=e.GetSubModels();if(n.length>0)for(var r=0;r<n.length;r++)this.Traver(n[r],t);t(e)},t.prototype.OnlyDisplayCurrent=function(){var e=this.view.GetSelector(),t=e.GetAll(),n=this.view.model;if(t.length===0)return;this.Traver(n,function(e){e.SetVisible(!1)}),this.Traver(n,function(e){var n=!1;for(var r=0;r<t.length;r++)if(e===t[r]){e.SetVisible(!0);break}})},t.prototype.HideCurrent=function(){var t=this.view.GetSelector(),n=t.GetAll();for(var r=0,i=n;r<i.length;r++){var s=i[r];if(s!==null){s.SetVisible(!1),s.SetSelected(!1);var o=n.indexOf(s);e.Parameters.Instance().IsMulSelect||n.splice(o,1)}}e.Parameters.Instance().IsMulSelect&&n.splice(0,n.length),t.Clear()},t.prototype.ExchangeHidden=function(){var e=this.view.GetSelector(),t=e.GetAll(),n=this.view.model;this.Traver(n,function(e){if(e.IsVisible()&&e.GetSubModels().length===0){e.SetVisible(!1),e.SetSelected(!1);var n=t.indexOf(e);t.splice(n,1)}else e.GetSubModels().length===0&&e.SetVisible(!0)})},t.prototype.DisplayAll=function(){var e=this.view.model;e.SetVisible(!0)},t.prototype.DisplayInCenter=function(){var t=this.view.GetSelector(),n=t.GetAll(),r=n[0],i,s=this.view.GetSceneManager(),o=s.GetCamera(),u=o.GetViewPort(),a=u.GetRect();r?i=e.ModelTransformHelper.GetModelWorldBoundingBox(r).Center():i=s.GetSceneBox().Center();var f=new e.Vector2((a.left+a.right)/2,(a.bottom+a.top)/2),l=u.GetScreenRay(f.x,f.y),c=new e.Plane(l.GetDirection(),o.GetPosition()),h=c.Project(i);o.SetWorldPosition(h)},t.prototype.ContinuousRotation=function(){e.Parameters.Instance().IsConRotate?(e.Parameters.Instance().IsConRotate=!1,this.view.CloseSceneAnimation()):e.Parameters.Instance().IsConRotate=!0},t}();e.SelectionOperator=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(e){this.type=0,this.view=e,this.type=0}return e.prototype.GetId=function(){return this.id},e.prototype.SetId=function(e){this.id=Number(e)},e.prototype.GetName=function(){return this.name},e.prototype.SetName=function(e){this.name=e},e.prototype.GetType=function(){return this.type},e.prototype.TaskValid=function(){return!1},e.prototype.Play=function(){},e.prototype.Stop=function(){},e.prototype.Pause=function(){},e.prototype.Percent=function(){return 0},e.prototype.Active=function(){},e.prototype.SetPercent=function(e){},e.prototype.GetNativeTask=function(){return 0},e.prototype.SetNativeTask=function(e){},e.prototype.IsRun=function(){return this.view.AnimationIsPlaying()},e}();e.SAnimationTask=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(e){function t(t){var n=e.call(this,t)||this;return n.steplist=[],n.view=t,n.type=2,n}return __extends(t,e),t.prototype.AddStep=function(e){this.steplist.push(e)},t.prototype.GetStepList=function(){return this.steplist},t}(e.SAnimationTask);e.SAnimationProcess=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(e){function t(t){var n=e.call(this,t)||this;return n.process=null,n.type=1,n}return __extends(t,e),t.prototype.SetProcessId=function(e){this.processId=Number(e)},t.prototype.GetProcessId=function(){return this.processId},t.prototype.SetStepInfo=function(e){this.stepInfo=e},t.prototype.GetStepInfo=function(){return this.stepInfo},t.prototype.GetProcess=function(){return this.process},t.prototype.SetProcess=function(e){this.process=e},t.prototype.Play=function(){this.view&&this.view.AnimationPlay()},t.prototype.Stop=function(){this.view&&this.view.AnimationRewind()},t.prototype.Active=function(){this.view&&this.view.AnimationSetActiveStep(this.processId,this.id)},t.prototype.Pause=function(){this.view&&this.view.AnimationIsPlaying()&&this.view.AnimationPlay()},t.prototype.Percent=function(){var e=0;return this.view&&(e=this.view.AnimationGetTick()),e},t.prototype.SetPercent=function(e){this.view&&this.view.AnimationSetTick(e)},t}(e.SAnimationTask);e.SAnimationStep=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];this.PMIList=[],this.NoteList=[],this.SectionPlaneIDList=[],this.noteDataList=new e.Map,this.PLineColors=[],this.InstanceAttributeMap=new e.Map,this.appendInfo=new e.Map;if(n.length===0)this.ID=++t.MaxId,this.UpDataModel=!1,this.UpDataCamera=!1,this.ViewType=-1;else if(n.length===1){var i=n[0];t.MaxId++,this.ID=i.ID,this.Name=i.Name,this.Camera=i.Camera,this.PMIList=i.PMIList,this.NoteList=i.NoteList,this.SectionPlaneIDList=i.SectionPlaneIDList,this.UpDataCamera=i.UpDataCamera,this.UpDataModel=i.UpDataModel,this.noteDataList=i.noteDataList,this.PLineColors=i.PLineColors,this.InstanceAttributeMap=i.InstanceAttributeMap,this.SvlType=i.SvlType,this.ViewType=i.ViewType,this.appendInfo=i.appendInfo}}return t.prototype.SetModleView=function(e,t,n,r,i,s,o,u){this.SetID(e),this.SetName(t),this.SetCamera(r),this.SetPMIIds(i),this.SetNoteIds(s),this.SetSectionPlaneIDList(o),this.setInstanceAttributeMap(u),this.SetViewType(n),this.SetUpDataCamera(!0),this.SetUpDataModel(!0)},t.prototype.SetID=function(e){this.ID=e},t.prototype.SetViewType=function(e){this.ViewType=e},t.prototype.GetViewType=function(){return this.ViewType},t.prototype.AddSectionPlaneId=function(e){var t=!1;for(var n=0;n<this.SectionPlaneIDList.length;n++){var r=this.SectionPlaneIDList[n];if(r==e){t=!0;break}}t||this.SectionPlaneIDList.push(e)},t.prototype.ClearSectionPlaneId=function(){this.SectionPlaneIDList=[]},t.prototype.GetNoteList=function(){return this.NoteList},t.prototype.GetUpDataModelState=function(){return this.UpDataModel},t.prototype.SetUpDataModel=function(e){this.UpDataModel=e},t.prototype.GetUpDataCameraState=function(){return this.UpDataCamera},t.prototype.SetUpDataCamera=function(e){this.UpDataCamera=e},t.prototype.GetPMIList=function(){return this.PMIList},t.prototype.GetSectionPlaneIDList=function(){return this.SectionPlaneIDList},t.prototype.SetSectionPlaneIDList=function(e){this.SectionPlaneIDList=e},t.prototype.GetCamera=function(){return this.Camera},t.prototype.GetName=function(){return this.Name},t.prototype.GetID=function(){return this.ID},t.prototype.AddNoteId=function(e){this.NoteList.push(e)},t.prototype.SetNoteIds=function(e){this.NoteList=e},t.prototype.AddPMIId=function(e){this.PMIList.push(e)},t.prototype.SetPMIIds=function(e){this.PMIList=e},t.prototype.SetCamera=function(t){this.Camera=(new e.Camera).Clone(t)},t.prototype.SetName=function(e){this.Name=e},t.prototype.GetProperty=function(e){return this.appendInfo.Get(e)},t.prototype.SetProperty=function(e,t){this.appendInfo.Put(e,t)},t.prototype.ClearProperties=function(){this.appendInfo.Clear()},t.prototype.DeleteProperty=function(e){return this.appendInfo.Remove(e)},t.prototype.GetNoteDataList=function(e){if(this.noteDataList.Get(e)===null){var t=[];this.noteDataList.Put(e,t)}return this.noteDataList.Get(e)},t.prototype.ClearNoteDataList=function(){this.noteDataList.Clear()},t.prototype.SetNoteDataList=function(e,t){this.noteDataList.Put(e,t)},t.prototype.SetGestureNotePolyLineColors=function(e){this.PLineColors=e},t.prototype.GetGestureNotePolyLineColors=function(){return this.PLineColors},t.prototype.GetInstanceAttributeMap=function(){return this.InstanceAttributeMap},t.prototype.setInstanceAttributeMap=function(e){this.InstanceAttributeMap=e},t.prototype.ProcessXMLData=function(e){var t=e.getElementsByTagName("Views")},t.CreateByXml=function(e){var t=(new DOMParser).parseFromString(e,"application/xml");return SView.ViewManager.GetInstance().GetModleViewByXmlStr(t.documentElement)},t.prototype.ToXml=function(){return'<View ID="'+this.GetID()+'" Name="'+this.GetName()+'" Type="'+this.GetViewType()+'"> <Camera '+this.GetCamera().toString()+'/> <BackgroundColor/><Notes><GestureNote ID= "0" Created= "" UserID= "1" Layer= "0" > <ProjectMatrix/> <Polylines /> </GestureNote> </Notes>  <PMIs/>  <SectionPlanes/><Instances></Instances></View>'},t.prototype.ToJson=function(){var t="{";t+='"id":'+this.GetID()+',"name":"'+this.GetName()+'","usageType":'+this.GetViewType()+',"isActivated":false,"isDefault":false,"transparency":1.0,';var n=this.GetCamera();if(n){t+='"camera":{"projectType":'+n.GetOrthographic()+',"angle":1.0,"matix":"';var r=new e.Matrix4(n.GetRotation().RotationMatrix().Inverse());r.data[12]=n.GetPosition().x,r.data[13]=n.GetPosition().y,r.data[14]=n.GetPosition().z;var i=r.data;for(var s=0;s<i.length;s++)t+=i[s].toFixed(8),s<i.length-1?t+=" ":t+='"';t+="},"}var o=this.GetInstanceAttributeMap();t+='"insAttributes":{';for(var s=0;s<o.Keys().length;s++){var u=o.Keys()[s],a=o.Values()[s];t+='"'+e.PathHelper.SVLPathHexToDec(a.path)+'":{'+'"plcPath":'+u+',"visible":'+(a.visible?0:1)+',"matix":"'+a.placeMatrix.Tostring()+'"',a.hasColor?t+=',"color":"'+a.insColor.Tostring()+'"}':t+=',"color":"-1.00000000 -1.00000000 -1.000000000 -1.00000000"}',s<o.Keys().length-1&&(t+=",")}return t+="}}",t},t.MaxId=1e3,t}();e.ModleView=t;var n;(function(e){e[e.VIEW_USAGE_UNKNOWN=0]="VIEW_USAGE_UNKNOWN",e[e.VIEW_USAGE_GENERAL_VIEW=1]="VIEW_USAGE_GENERAL_VIEW",e[e.VIEW_USAGE_SV_BASE_VIEW=2]="VIEW_USAGE_SV_BASE_VIEW",e[e.VIEW_USAGE_SV_USER_VIEW=3]="VIEW_USAGE_SV_USER_VIEW",e[e.VIEW_USAGE_SV_USER_CLIPVIEW=4]="VIEW_USAGE_SV_USER_CLIPVIEW",e[e.VIEW_USAGE_SV_OTHER_VIEW=5]="VIEW_USAGE_SV_OTHER_VIEW",e[e.VIEW_USAGE_PROE_BASE_VIEW=6]="VIEW_USAGE_PROE_BASE_VIEW",e[e.VIEW_USAGE_PROE_USER_VIEW=7]="VIEW_USAGE_PROE_USER_VIEW",e[e.VIEW_USAGE_DEFAULT_VIEW=8]="VIEW_USAGE_DEFAULT_VIEW",e[e.VIEW_USAGE_USER_CLIPPLANE=9]="VIEW_USAGE_USER_CLIPPLANE"})(n=e.StkViewUsageEnum||(e.StkViewUsageEnum={}));var r;(function(e){e[e.Undefine=-1]="Undefine",e[e.DefaultView=0]="DefaultView",e[e.OrignalView=1]="OrignalView",e[e.UserView=2]="UserView"})(r=e.ViewTypeEnum||(e.ViewTypeEnum={}))})(M3D||(M3D={}));var SView;(function(e){var t=function(){function e(e){this.sviewControl=null,this.measures=[],this.sviewControl=e}return e.prototype.RemoveLastMeasure=function(e){var t=!1;for(var n=this.measures.length-1;n>=0;n--){var r=this.measures[n];if(e.indexOf(r.GetMeasureType())){var i=r.GetID();r.Delete(),this.sviewControl.GetNativeShapeManager().RemoveShape(i),r.GetMeasureObj()?this.sviewControl.GetSelector().Remove(r.GetMeasureObj()):this.sviewControl.GetSelector().Remove(r.GetNoteObj()),this.Remove(r);break}}return t},e.prototype.Add=function(e){var t=!1;return e!==null&&this.measures.indexOf(e)===-1&&(this.measures.push(e),t=!0),t},e.prototype.Remove=function(e){var t=!1,n=this.measures.indexOf(e);if(e!==null&&n!==-1){var r=e.GetID();this.sviewControl.GetNativeShapeManager().RemoveShape(r),e.GetMeasureObj()?this.sviewControl.GetSelector().Remove(e.GetMeasureObj()):this.sviewControl.GetSelector().Remove(e.GetNoteObj()),this.measures.splice(n,1),e.Delete(),t=!0}return t},e.prototype.Clear=function(){var e=!1;this.sviewControl.GetSelector().Clear();for(var t=0,n=this.measures;t<n.length;t++){var r=n[t],i=r.GetID();this.sviewControl.GetNativeShapeManager().RemoveShape(i),r.GetMeasureObj()?this.sviewControl.GetSelector().Remove(r.GetMeasureObj()):this.sviewControl.GetSelector().Remove(r.GetNoteObj()),r.Delete()}return this.measures.length=0,e},e.prototype.GetMeasures=function(e,t){var n=[];if(e!=null)for(var r=0,i=this.measures;r<i.length;r++){var s=i[r];s.GetMeasureType()==e&&n.push(s)}else for(var o=0,u=this.measures;o<u.length;o++){var s=u[o];t.indexOf(s.GetMeasureType())>0&&n.push(s)}return n},e.prototype.RemoveMeasuresByType=function(e){var t=!1,n=[];for(var r=0,i=this.measures;r<i.length;r++){var s=i[r];e.indexOf(s.GetMeasureType())&&n.push(s)}if(n.length>0){for(var o=0,u=this.measures;o<u.length;o++){var s=u[o];this.Remove(s)}t=!0}return t},e.prototype.GetMeasureByGUId=function(e){var t=null;return t},e.prototype.GetMeasureById=function(e){var t=null;for(var n=0,r=this.measures;n<r.length;n++){var i=r[n];if(i.GetID()==e){t=i;break}}return t},e.prototype.GetsView=function(){return this.sviewControl},e.prototype.SetsView=function(e){this.sviewControl=e},e}();e.MeasureManager=t})(SView||(SView={}));var SView;(function(e){var t=function(){function e(){this.nativeShapeCache=new M3D.Map}return e.prototype.Clear=function(){this.nativeShapeCache.Clear()},e.prototype.GetShape=function(e){return this.nativeShapeCache.ContainKey(e)?this.nativeShapeCache.Get(e):null},e.prototype.AddShape=function(e,t){t!==null&&!this.nativeShapeCache.ContainKey(e)&&this.nativeShapeCache.Put(e,t)},e.prototype.RemoveShape=function(e){this.nativeShapeCache.Remove(e)},e}();e.ShapeManager=t})(SView||(SView={}));var SView;(function(e){var t=function(){function e(){this.nativeMeasure=null,this.nativeNote=null,this.anchorX=-1,this.anchorY=-1,this.author="",this.view=null}return e.prototype.GetAnchorX=function(){return this.anchorX},e.prototype.SetAnchorX=function(e){this.anchorX=e},e.prototype.GetAnchorY=function(){return this.anchorY},e.prototype.SetAnchorY=function(e){this.anchorY=e},e.prototype.GetMeasureType=function(){return this.measureType},e.prototype.SetMeasureType=function(e){this.measureType=e},e.prototype.GetView=function(){return this.view},e.prototype.SetView=function(e){this.view=e},e.prototype.GetID=function(){return this.nativeMeasure!==null?this.nativeMeasure.GetID():this.nativeNote!==null?this.nativeNote.GetID():0},e.prototype.Create=function(){return!1},e.prototype.Delete=function(){return!1},e.prototype.Clear=function(){return!1},e.prototype.SetNativeMeasureObj=function(e){this.nativeMeasure=e},e.prototype.GetMeasureObj=function(){return this.nativeMeasure},e.prototype.SetNativeNoteObj=function(e){this.nativeNote=e},e.prototype.GetNoteObj=function(){return this.nativeNote},e.prototype.Init=function(){this.SetType(M3D.ShapeType.SHAPE_MEASURE_BASE)},e.prototype.SetType=function(e){this.type=e},e.prototype.GetType=function(){return this.type},e.MEASURE_TYPE_BASE=0,e.MEASURE_TYPE_ERROR=200,e.MEASURE_TYPE_PNT_PNT_DISTANCE=1,e.MEASURE_TYPE_PNT_LINE_DISTANCE=2,e.MEASURE_TYPE_PNT_FACE_DISTANCE=3,e.MEASURE_TYPE_LINE_LINE_DISTANCE=4,e.MEASURE_TYPE_LINE_FACE_DISTANCE=5,e.MEASURE_TYPE_FACE_FACE_DISTANCE=6,e.MEASURE_TYPE_POINT_MULTIPOINT_DISTANCE=7,e.MEASURE_TYPE_SUDISTANCE=8,e.MEASURE_TYPE_LINE_LINE_ANGLE=50,e.MEASURE_TYPE_FACE_FACE_ANGLE=51,e.MEASURE_TYPE_LINE_FACE_ANGLE=52,e.MEASURE_TYPE_CURVE_CURVE_ANGLE=53,e.MEASURE_TYPE_PNT_COORD=100,e.MEASURE_TYPE_LENGTH=101,e.MEASURE_TYPE_ARC=102,e.MEASURE_TYPE_CIRCLE=103,e.MEASURE_TYPE_HOLE=104,e.MEASURE_TYPE_MODEL=105,e.MEASURE_TEXT_NOTE=150,e.MEASURE_CT_TEXT_NOTE=152,e.MEASURE_VOICE_NOTE=151,e.MEASURE_SEQUENCE_NUMBER_NOTE=153,e.MEASURE_THREED_GESTURE_NOTE=154,e.MEASURE_FRIST_SHAPE_PNT=1,e.MEASURE_FRIST_SHAPE_LINE=2,e.MEASURE_FRIST_SHAPE_FACE=3,e.MEASURE_SECOND_SHAPE_PNT=4,e.MEASURE_SECOND_SHAPE_LINE=5,e.MEASURE_SECOND_SHAPE_FACE=6,e.MEASURE_SHAPE_PNT=7,e.MEASURE_SHAPE_LINE=8,e.MEASURE_SHAPE_FACE=9,e.MEASURE_SHAPE_ARC=10,e.MEASURE_SHAPE_HOLE=11,e.MEASURE_SHAPE_MODEL=12,e.WALKTHROUGH_TIPS=32,e.PUTBOX_TIPS=33,e.MEASURE_TIPS_CANCLE=500,e.MEASURE_SHOW_RESULT=501,e}();e.SMeasure=t})(SView||(SView={}));var SView;(function(e){var t=function(e){function t(){var t=e.call(this)||this;return t.fristAnChorShape=0,t.secondAnChorShape=0,t.firstShape=0,t.secondShape=0,t.firstCurveLine=new M3D.Line3D,t.secondCurveLine=new M3D.Line3D,t.Init(),t}return __extends(t,e),t.prototype.Create=function(){var e=!1,t=null,n=this.GetMeasureType(),r=this.firstShape,i=this.secondShape,s=this.GetAnchorX(),o=this.GetAnchorY(),u=new M3D.Vector2(s,o);return t=M3D.MeasureFactory.CreateAngleMeasure(r,i,n,u,this.view.GetSceneManager()),t&&(this.nativeMeasure=t,e=!0),e},t.prototype.CreateCurve=function(){var e=!1,t=null,n=this.GetMeasureType(),r=this.firstCurveLine,i=this.secondCurveLine,s=this.firstShape,o=this.secondShape,u=this.GetAnchorX(),a=this.GetAnchorY(),f=new M3D.Vector2(u,a);return t=M3D.MeasureFactory.CreateCurveAngleMeasure(s,o,r,i,n,f,this.view.GetSceneManager()),t&&(this.nativeMeasure=t,e=!0),e},t.prototype.Delete=function(){var e=!1;return this.GetID()>0&&(this.view.RemoveShape(this.GetID()),e=!0),!1},t.prototype.Clear=function(){return!1},t.prototype.GetFirstShape=function(){return this.firstShape},t.prototype.SetFirstShape=function(e){this.firstShape=e},t.prototype.GetFirstCurveLine=function(){return this.firstCurveLine},t.prototype.SetFirstCurveLine=function(e){this.firstCurveLine=e},t.prototype.GetSecondShape=function(){return this.secondShape},t.prototype.SetSecondShape=function(e){this.secondShape=e},t.prototype.GetSecondCurveLine=function(){return this.secondCurveLine},t.prototype.SetSecondCurveLine=function(e){this.secondCurveLine=e},t.prototype.GetFristAnChorShape=function(){return this.fristAnChorShape},t.prototype.SetFristAnChorShape=function(e){this.fristAnChorShape=e},t.prototype.GetSecondAnChorShape=function(){return this.secondAnChorShape},t.prototype.SetSecondAnChorShape=function(e){this.secondAnChorShape=e},t.prototype.Init=function(){this.SetType(M3D.ShapeType.SHAPE_MEASURE_ANGLE)},t}(e.SMeasure);e.SMeasureAngle=t})(SView||(SView={}));var SView;(function(e){var t=function(t){function n(){var e=t.call(this)||this;return e.fristAnChorShape=0,e.secondAnChorShape=0,e.firstShape=0,e.secondShape=0,e.Init(),e}return __extends(n,t),n.prototype.Create=function(){var t=!1,n=null,r=this.GetMeasureType(),i=this.firstShape,s=this.secondShape,o=this.GetAnchorX(),u=this.GetAnchorY(),a=new M3D.Vector2(o,u);if(r===e.SMeasure.MEASURE_TYPE_FACE_FACE_DISTANCE){var f=this.fristAnChorShape,l=this.secondAnChorShape;n=M3D.MeasureFactory.CreateFaceDistanceMeasure(i,s,f,l,r,a,this.view.GetSceneManager())}else n=M3D.MeasureFactory.CreateDistanceMeasure(i,s,r,a,this.view.GetSceneManager());return n&&(this.nativeMeasure=n,t=!0),t},n.prototype.Delete=function(){var e=!1;return this.GetID()>0&&(this.view.RemoveShape(this.GetID()),e=!0),!1},n.prototype.Clear=function(){return!1},n.prototype.GetFirstShape=function(){return this.firstShape},n.prototype.SetFirstShape=function(e){this.firstShape=e},n.prototype.GetSecondShape=function(){return this.secondShape},n.prototype.SetSecondShape=function(e){this.secondShape=e},n.prototype.GetFristAnChorShape=function(){return this.fristAnChorShape},n.prototype.SetFristAnChorShape=function(e){this.fristAnChorShape=e},n.prototype.GetSecondAnChorShape=function(){return this.secondAnChorShape},n.prototype.SetSecondAnChorShape=function(e){this.secondAnChorShape=e},n.prototype.Init=function(){this.SetType(M3D.ShapeType.SHAPE_MEASURE_DISTANCE)},n.CreateFromXML=function(e,t){var r=null;if(e!=null&&e.length!=0){r=new n;var i=M3D.MeasureFactory.CreateMeasureFromXMLElement(t.view.GetSceneManager(),t.ParseXmlString(e));if(i){r.SetView(t.view),r.SetNativeMeasureObj(i);var s=i.GetID()}return r}return},n}(e.SMeasure);e.SMeasureDistance=t})(SView||(SView={}));var SView;(function(e){var t=function(e){function t(){var n=e.call(this)||this;return n.fristAnChorShape=0,n.secondAnChorShape=0,n.propertyShape=0,n.showType=t.UI_SHOW,n.Init(),n}return __extends(t,e),t.prototype.Create=function(){var e=!1,n=null,r=this.GetMeasureType(),i=this.propertyShape,s=this.showType,o=this.GetAnchorX(),u=this.GetAnchorY(),a=new M3D.Vector2(o,u);if(s===t.GL_SHOW){var f=this.fristAnChorShape,l=this.secondAnChorShape;n=M3D.MeasureFactory.CreatePropertyMeasure(i,r,a,this.view.GetSceneManager())}else{var c=void 0;c=M3D.MeasureFactory.GetMeasureProperty(i,r,this.view.GetSceneManager(),c),this.SetMeasureProperties(c)}return n&&(this.nativeMeasure=n,e=!0),e},t.prototype.GetMeasurePropertiesWithMeasuerId=function(e,t){var n;return n=M3D.MeasureFactory.GetMeasureProperty(e,t,this.view.GetSceneManager(),n),this.SetMeasureProperties(n),this.GetMeasureProperties()},t.prototype.Delete=function(){var e=!1;return this.GetID()>0&&(this.view.RemoveShape(this.GetID()),e=!0),!1},t.prototype.Clear=function(){return!1},t.prototype.GetFristAnChorShape=function(){return this.fristAnChorShape},t.prototype.SetFristAnChorShape=function(e){this.fristAnChorShape=e},t.prototype.GetSecondAnChorShape=function(){return this.secondAnChorShape},t.prototype.SetSecondAnChorShape=function(e){this.secondAnChorShape=e},t.prototype.Init=function(){this.SetType(M3D.ShapeType.SHAPE_MEASURE_PROPERTY)},t.prototype.SetMeasureProperties=function(e){this.measureProperties=e},t.prototype.GetMeasureProperties=function(){return this.measureProperties},t.prototype.SetPropertyShape=function(e){this.propertyShape=e},t.prototype.GetPropertyShape=function(){return this.propertyShape},t.prototype.GetShowType=function(){return this.showType},t.prototype.SetShowType=function(e){this.showType=e},t.GL_SHOW=0,t.UI_SHOW=1,t}(e.SMeasure);e.SMeasureProperty=t})(SView||(SView={}));var SView;(function(SView_1){SView_1.CreateViewer=function(e){return new SView(e)},SView_1.GetLogger=function(){return M3D.Log===null&&(M3D.Log=new M3D.Logger),M3D.Log};var SView=function(){function SView(renderCanvas){this.view=null,this.curExplosiveStyle=0,this.curExplosivePercentage=0,this.curClipValue=0,this.curClipDirection=1,this.curIsShowCappingPlane=!1,this.curIsShowClipPlane=!1,this.CurIsShowCutPlane=!1,this.singleClickFlag=!1,this.inputConfig="",this.optionConfig='{ "pc": { "zoom": "", "traslation": "wheelkey", "rotating": "left","zoombearing":"up","pickup":"left" },"singletouch":{"rotating":"touch","traslation":"dbtouch","zoom":"longtouch","zoombearing":"left"} }',this.configJson=eval("("+this.optionConfig+")"),this.choiceSwitch=!0,this.isSinglePoint=!1,this.oneFinger=!1,this.touchDown=!1,this.clickUp=!1,this.isPickUp=!1,this.OperaType=SView.TOUCH_ROTATE,this.tempShapeList=[],this.touchPnts=new Array(10),this.renderCanvas=null,this.lastMousePosition=new M3D.Vector2,this.isMouseWheelStop=!1,this.width=0,this.height=0,this.isShowWireframe=!1,this.isOnlyShowWireframe=!1,this.IsShowEdgeLine=!0,this.IsOnlyShowEdgeLine=!1,this.IsShowTransparent=!1,this.readListeners=[],this.selectorListeners=[],this.isWheelPressing=!1,this.deviceRatio=1,this.curFileName="",this.joyStickOption={strightSpd:0,sideSpd:0,isJoysticPressing:!1},this.decryptoOptions={decryptoFile:!1,decryptoServer:""},this.pmiOptions={usePMI:!1,pmiServer:"http://localhost:8070/"},this.onAlert=function(e){},this.animationTaskLinstener=new M3D.AnimationTaskLinstener,this.animationPlayer=null,this.isPlaying=!1,this.assemblyTempModel=null,this.initAssemblyTreeFuc=function(e){},this.updateAssemblyTree=function(e){},this.addAssemblyOver=function(){},this.onSViewMouseDown=function(){},this.onSViewMouseMove=function(){},this.onSViewMouseUp=function(){},this.onRestoreViewEnd=function(){},this.openModelsEnd=function(e){},this.PorpertyMeasureCallBack=function(e){},this.MeasureError=function(){},this.inputTextNote=function(e){},this.showRightMenuInIos=function(e){},this.CloseRightMenuInIos=function(e){},this.DoubleTouchListener=function(e){},this.SHotSpotDescribeListener=function(e){},this.isControlDown=!1,this.mouseDownPoints=[],this.isFrameSelect=!1,this.isFrameSelctState=!1,this.isShowTextNoteAlert=!1,this.lastMouseTime=(new Date).getTime(),this.downPnts=new Array(10),this.isMultiSelect=!1,this.showRightMenu=!1,this.timeOutEvent=0,this.timeOutEventForMove=0,this.isDbTouch=!1,this.isLongTouch=!1,this.longTouchMenu=!1,this.lastTouchTime=(new Date).getTime(),this.touchStartPoints=[],this.readNextListener=null,this.mulitFileReadModels=[],this.readModelListener=null,this.joystickTimer=new M3D.Timer,this.explosiveTimer=new M3D.Timer,this.aniTimer=new M3D.Timer,this.explosivePercent=0,this.isRotateComplete=!1,this.explorsiveSpeed=1,this.isNeedRotate=!0,this.excStep1=!1,this.excStep2=!1,this.downTimer=null,this._commandManage=null,this._measureCommandManager=null,this._nativeShapeManager=new SView_1.ShapeManager,this._measureManager=null,this.modelSet=[],this.readCounts=0,this.allModels=new M3D.Model,this._firstLocation=new M3D.Vector2,this._endLocation=new M3D.Vector2,this.isCanvace2Dsingle=!1,this._isAixsCommand=!1,this._isRotationCommand=!1,SView_1.GetLogger();var message="{SView:'StartCreate'}";M3D.Log.Info(this,message),window.devicePixelRatio!=null&&window.devicePixelRatio!=undefined&&(this.deviceRatio=window.devicePixelRatio),this.view=new M3D.View,this.view.Initial(renderCanvas),this.renderCanvas=renderCanvas,this.resize(),this.InitRenderCavansEventListener(),this.animationPlayer=new M3D.AnimationPlayer(this.view),this.animationPlayer.AddTaskListener(this.animationTaskLinstener),message="{SView:'Create View Success'}",M3D.Log.Info(this,message),SView_1.LinkManager.Instance().view=this,SView_1.SHotSpotManager.Instance().view=this,M3D.Parameters.Instance().useBackGroundImage&&this.SetBackgroundImage(M3D.Parameters.Instance().backGroundImageUrl)}return SView.prototype.setConfig=function(inputConfig){this.configJson=eval("("+this.optionConfig+")"),this.inputConfig=inputConfig;var config=null;inputConfig!==null&&inputConfig.length>0&&(config=eval("("+this.inputConfig+")")),config.phone==null&&(config.phone=this.configJson.phone),config.pc==null&&(config.pc=this.configJson.pc),config.singletouch==null&&(config.singletouch=this.configJson.singletouch),this.configJson=config},SView.prototype.getConfig=function(){return this.configJson},SView.prototype.getOffsetLeftToBody=function(e){var t=e.offsetLeft;while(e=e.offsetParent)t+=e.offsetLeft;return t},SView.prototype.getOffsetTopToBody=function(e){var t=e.offsetTop;while(e=e.offsetParent)t+=e.offsetTop;return t},SView.prototype.openChoice=function(e){this.choiceSwitch=e},SView.prototype.setSinglePoint=function(e){this.isSinglePoint=e},SView.prototype.setOneFinger=function(e){this.oneFinger=e},SView.prototype.SetBackgroundImage=function(e){var t=this.view.GetSceneManager().GetResourceManager(),n=t.GetOrCreateTexture(e),r=t.GetImage(e);r===null&&(r=t.GetOrCreateImage(e,e)),n.AddImage(r),this.view.SetBackgroundTexture(n),this.view.SetBackgroundUseImage(!0)},SView.prototype.createMaterial=function(e){var t=this.getOrCreateMaterial(e.material_type);t.SetDisplayName(e.material_name);if(t instanceof M3D.Material&&e.material_type==1){var n=e.difusse_color,r=n.split(","),i=new M3D.Color(Number(r[0])/255,Number(r[1])/255,Number(r[2])/255);t.SetDiffuse(i);var s=e.specular_color,o=s.split(","),u=new M3D.Color(Number(o[0])/255,Number(o[1])/255,Number(o[2])/255);t.SetSpecular(u),t.SetShininess(e.brightness),t.Opacity(Number(e.transparency));var a=e.ambient_color,f=a.split(","),l=new M3D.Color(Number(f[0])/255,Number(f[1])/255,Number(f[2])/255);t.SetAmbient(l);var c=e.emissive_color,h=c.split(","),p=new M3D.Color(Number(h[0])/255,Number(h[1])/255,Number(h[2])/255);t.SetEmissive(p),t.SetUvRotate(Number(e.texture_coordinate_rotation)),t.SetUvScale(new M3D.Vector2(Number(e.texture_coor_scaling_u),Number(e.texture_coor_scaling_v))),t.SetUvTranslate(new M3D.Vector2(Number(e.texture_coor_rollover_u),Number(e.texture_coor_rollover_v)));if(e.diffuse_texture_img!=""){var d=this.GetOrCreateTexture(e.diffuse_texture_img);t.SetDiffuseMap(d)}if(e.specular_texture_img!=""){var d=this.GetOrCreateTexture(e.specular_texture_img);t.SetSpecularMap(d)}if(e.radiation_texture_img!=""){var d=this.GetOrCreateTexture(e.radiation_texture_img);t.SetEmissiveMap(d)}if(e.nomal_texture_img!=""){var d=this.GetOrCreateTexture(e.nomal_texture_img);t.SetNormalMap(d),t.NormalMapScale(new M3D.Vector2(Number(e.normal_texture_scaling_x),Number(e.normal_texture_scaling_y)))}}if(t instanceof M3D.PbrMaterial&&e.material_type==2){var n=e.difusse_color,r=n.split(","),i=new M3D.Color(Number(r[0])/255,Number(r[1])/255,Number(r[2])/255);t.SetAlbedoColor(i),t.SetOpacity(Number(e.transparency)),t.SetMetalnessFactor(Number(e.metallic_luster)),t.SetRougthnessFactor(Number(e.roughness)),t.SetUseClearCoat(e.is_remove_cover),t.SetClearCoat(Number(e.remove_cover)),t.SetClearCoatRoughness(Number(e.clear_rough_overlays)),t.SetUvRotate(Number(e.texture_coordinate_rotation)),t.SetUvScale(new M3D.Vector2(Number(e.texture_coor_scaling_u),Number(e.texture_coor_scaling_v))),t.SetUvTranslate(new M3D.Vector2(Number(e.texture_coor_rollover_u),Number(e.texture_coor_rollover_v)));if(e.rough_metal_texture_img!=""){var d=this.GetOrCreateTexture(e.rough_metal_texture_img);t.SetMetalnessRoughnessMap(d)}if(e.diffuse_texture_img!=""){var d=this.GetOrCreateTexture(e.diffuse_texture_img);t.SetEmissiveMap(d)}if(e.nomal_texture_img!=""){var d=this.GetOrCreateTexture(e.nomal_texture_img);t.SetNormalMap(d),t.SetNormalMapScale(new M3D.Vector2(Number(e.normal_texture_scaling_x),Number(e.normal_texture_scaling_y)))}}if(t instanceof M3D.MatCapMaterial&&e.material_type==4){var n=e.difusse_color,r=n.split(","),i=new M3D.Color(Number(r[0])/255,Number(r[1])/255,Number(r[2])/255);t.SetDiffuse(i),t.Opacity(Number(e.transparency));if(e.material_capture_texture_img!=""){var d=this.GetOrCreateTexture(e.material_capture_texture_img);t.SetMatcapMap(d)}if(e.nomal_texture_img!=""){var d=this.GetOrCreateTexture(e.nomal_texture_img);t.SetNormalMap(d),t.NormalMapScale(new M3D.Vector2(Number(e.normal_texture_scaling_x),Number(e.normal_texture_scaling_y)))}}console.log(this.view.GetSceneManager().GetResourceManager().MaterialToJSON())},SView.prototype.getOrCreateMaterial=function(e){var t=this.view.GetSceneManager().GetResourceManager(),n=t.getMaxMaterialKey()+1,r=null;return e==1&&(r=t.GetOrCreateMaterial(n,M3D.MaterialType.MaterialType_Phong)),e==2&&(r=t.GetOrCreateMaterial(n,M3D.MaterialType.MaterialType_Pbr)),e==4&&(r=t.GetOrCreateMaterial(n,M3D.MaterialType.MaterialType_MatCap)),r},SView.prototype.GetOrCreateTexture=function(e){var t=this.view.GetSceneManager().GetResourceManager(),n=t.GetOrCreateTexture(e),r=t.GetImage(e);return r===null&&(r=t.GetOrCreateImageById(e,t.getMaxImageId()+1,e)),n.AddImage(r),n},SView.prototype.SetMaterialToModel=function(e,t){if(t.GetSubModels().length==0){var n=t.GetModelShape().GetBodys();for(var r=0;r<n.length;r++){var i=n[r].GetFaces();for(var s=0;s<i.length;s++)i[s].SetMaterial(e)}}else for(var o=0;o<t.GetSubModels().length;o++)this.SetMaterialToModel(e,t.GetSubModels()[o])},SView.prototype.GetAnimationTaskLinstener=function(){return this.animationTaskLinstener},SView.prototype.GetAnimationPlayer=function(){return this.animationPlayer},SView.prototype.SetIsPlaying=function(e){this.isPlaying=e},SView.prototype.GetIsPlaying=function(){return this.isPlaying},SView.prototype.AnimationPlay=function(){this.isPlaying?this.Pause():this.Play()},SView.prototype.AnimationPre=function(){this.PlayPre()},SView.prototype.AnimationNext=function(){this.PlayNext()},SView.prototype.AnimationSetSliderValue=function(e){this.animationPlayer.SetPercent(e),this.SetIsPlaying(!0)},SView.prototype.AnimationGetSliderValue=function(){return this.
animationPlayer.GetPercent()},SView.prototype.AnimationAutoWalk=function(e){e?this.animationPlayer.SetAutoWalkCamera(!0):this.animationPlayer.SetAutoWalkCamera(!1)},SView.prototype.AnimationLoop=function(e){e?this.animationPlayer.SetLoop(!0):this.animationPlayer.SetLoop(!1)},SView.prototype.AnimationSetSpeed=function(e){this.animationPlayer.SetSpeed(e)},SView.prototype.AnimationOpenFile=function(){this.view.HasAnimations()&&this.animationPlayer.OpenFile()},SView.prototype.showShotSpotDescribe=function(e){this.SHotSpotDescribeListener(e)},SView.prototype.Pause=function(){this.animationPlayer.Pause(),this.SetIsPlaying(!1)},SView.prototype.Play=function(){this.animationPlayer.Resume(),this.animationPlayer.GetSpeed(),this.SetIsPlaying(!0)},SView.prototype.PlayPre=function(){this.animationPlayer.PlayPre(),this.SetIsPlaying(!0)},SView.prototype.PlayNext=function(){this.animationPlayer.PlayNext(),this.SetIsPlaying(!0)},SView.prototype.checkButton=function(e){if(e.buttons!=undefined)return e.buttons;if(e.button!=undefined){if(e.button===0)return 1;if(e.button===1)return 4}return-1},SView.prototype.AssemblyDelete=function(e){this.GetSelector().Remove(e),this.view.GetModelManager().Delete(e);var t=this.view.GetSceneManager().GetModel()},SView.prototype.AssemblyAdd=function(e){return this.AssemblyOpenFile(e)},SView.prototype.AssemblyMoveTo=function(e,t){var n=this.view.GetModelManager().MoveTo(e,t);return this.UpdateSceneBox(),n},SView.prototype.AssemblyCopyTo=function(e,t,n){var r=new M3D.Model,i=!1,s=[i,r];return s=this.view.GetModelManager().CopyTo(e,t),this.updateAssemblyTree(s[1]),this.UpdateSceneBox(),s[0]},SView.prototype.Move=function(e,t){return this.view.GetModelManager().Move(e,t)},SView.prototype.AssemblyRename=function(e,t){return this.view.GetModelManager().ReName(e,t)},SView.prototype.AssemblyOpenFile=function(e){var t=this;this.view.GetSelector().SetListeners(this.selectorListeners);var n=M3D.FileHelper.GetSuffix(e[0].name);if(n==="zip"||n==="svp"||n==="zsvl"){var r=new FileReader,i=this;return r.addEventListener("load",function(e){var t=e.target,n=t.result,r=new JSZip(n);i.AssemblyOpenZipFile(r,"","")},!1),r.readAsBinaryString(e[0]),"OK"}if(n==="svlx"){var s=new FileReader,o=this;return s.addEventListener("load",function(t){var n=t.target,r=n.result,i=new JSZip(r);o.AssemblyOpenZipFile(i,e[0].name,"svlx")},!1),s.readAsArrayBuffer(e[0]),"OK"}var u="ERROR",a=M3D.Reader.GetReader(e),f=a[0];if(f==null)return a[1];f.SetView(this.view);var l=new M3D.ReadListener;l.onReadEnd=function(e){var n=e.GetModel();t.readEnd(),t.RemoveReadListener(l)},this.AddReadListener(l),f.SetListeners(this.readListeners);var c=e[0].name,h=new FileReader,p=new FileReader,d,v,m=!0;return f instanceof M3D.JSvlReader?(h.addEventListener("load",function(e){var t=e.target;d=t.result},!1),p.addEventListener("load",function(e){var t=e.target;v=t.result;var n=f.ReadJSvl(d,v)},!1),h.readAsText(e[0]),p.readAsBinaryString(e[1])):f instanceof M3D.StlReader?(h.addEventListener("load",function(e){var t=e.target,n=t.result,r=f,i=r.ensureBinary(n);if(!r.isBinary(i)){m=!1;var s=r.parseASCII(r.ensureString(n));s!=null}},!1),p.addEventListener("load",function(e){if(!m)return;var t=e.target,n=t.result,r=f,i=r.ensureBinary(n);if(r.isBinary(i)){var s=r.parseBinary(i);s!=null}},!1),h.readAsText(e[0]),p.readAsBinaryString(e[0])):(h.addEventListener("load",function(e){var t=e.target,n=t.result,r=f.ReadFile(n);r!=null},!1),h.readAsText(e[0])),u="OK",u},SView.prototype.AppendOpenZipFile=function(e,t,n){if(n==="svlx"){var r=this;this.view.GetSelector().SetListeners(this.selectorListeners);var i=new M3D.ReadListener;i.onReadEnd=function(e){var t=e.GetModel();r.view.ReadModel(t),r.readEnd();var n=M3D.SimulationAnimationManager.Instance();n.view=r.view;var s=e.getAnimation();if(s){var o=s.indexOf("<");s=s.substr(o),M3D.SimulationAnimationManager.Instance().ProcessXMLData(r.ParseXmlString(s))}r.RemoveReadListener(i)},this.AddReadListener(i);var s=new M3D.SvlxReader;s.SetView(this.view),s.readNextListener=this.readNextListener,s.readModelListener=this.readModelListener,s.SetListeners(this.readListeners),s.OpenZipModel(e)}else{n=="svl"&&(n="jsvl"),this.view.GetSceneManager().GetResourceManager().SetZipFile(e);var o=this,u=this.GetNeedReadFile(e,t,n);if(u[0]==null)return;var a=u[0];n=u[4],this.view.GetSelector().SetListeners(this.selectorListeners),this.curFileName=t;var f=new M3D.ReadListener;f.onSingleFileReadEnd=function(e){var t=e.GetModel(),n=o.view.GetSceneManager().GetModel(),r;o.view.GetModelManager().AddTo(t,n,r)},this.AddReadListener(f);var l=void 0;if(n=="stl"){var c=new M3D.StlReader;c.SetView(this.view),c.SetListeners(this.readListeners),c.readNextListener=this.readNextListener;var h=c.ensureBinary(a.asBinary());c.isBinary(h)?l=c.parseBinary(h):l=c.parseASCII(c.ensureString(a.asText()))}else if(n=="jsvl"){var p=M3D.SimulationAnimationManager.Instance();p.view=this.view;var s=new M3D.JSvlReader;s.SetView(this.view),s.readNextListener=this.readNextListener,s.SetListeners(this.readListeners);var d=u[1];l=s.ReadJSvl(a.asText(),d.asBinary())}else if(n=="obj"){var s=new M3D.ObjReader;s.SetView(this.view),s.readNextListener=this.readNextListener,s.SetListeners(this.readListeners),l=s.ReadFile(a.asText())}}},SView.prototype.AssemblyOpenZipFile=function(e,t,n){if(n==="svlx"){var r=this;this.view.GetSelector().SetListeners(this.selectorListeners);var i=new M3D.ReadListener,s=r.view.GetSelector().Get();this.view.GetSceneManager().GetModelFillManager().openFileEnd=function(){r.RestoreView(),r.addAssemblyOver()},i.onReadEnd=function(e){var t=e.GetModel();t.SetModelExtInfo(r.view.GetSceneManager().GetExtendInfoManager(),!0);var n=r.view.GetSceneManager().GetModel(),o;r.view.GetModelManager().AddTo(t,s,o);var u=r.view.GetSceneManager().GetModel();r.view.GetSceneManager().GetSceneBox().Clear(),r.readEnd(),r.updateAssemblyTree(t),r.RemoveReadListener(i)},this.AddReadListener(i);var o=new M3D.SvlxReader;o.SetView(this.view),o.readNextListener=this.readNextListener,o.readModelListener=this.readModelListener,o.SetListeners(this.readListeners),o.OpenZipModel(e),o.currentFilesName=t}else{n=="svl"&&(n="jsvl"),this.view.GetSceneManager().GetResourceManager().SetZipFile(e);var u=this,a=this.GetNeedReadFile(e,t,n);if(a[0]==null)return;var f=a[0];n=a[4],this.view.GetSelector().SetListeners(this.selectorListeners),this.curFileName=t;var l=new M3D.ReadListener,c=u.view.GetSelector().Get();l.onReadEnd=function(e){var t=e.GetModel(),n=u.view.GetSceneManager().GetModel(),r;u.view.GetModelManager().AddTo(t,c,r);var i=u.view.GetSceneManager().GetModel();u.view.GetSceneManager().GetSceneBox().Clear(),u.readEnd(),u.updateAssemblyTree(t),u.RemoveReadListener(l),u.addAssemblyOver(),t.SetModelExtInfo(u.view.GetSceneManager().GetExtendInfoManager(),!0)},this.AddReadListener(l);var h=void 0;n=n.toLowerCase();var p=this;if(n=="stl"){var d=new M3D.StlReader;d.SetListeners(this.readListeners),d.SetView(this.view);var v=d.ensureBinary(f.asBinary());d.isBinary(v)?h=d.parseBinary(v):h=d.parseASCII(d.ensureString(f.asText())),d.currentFilesName=f.name}else if(n=="jsvl"){var m=M3D.SimulationAnimationManager.Instance();m.view=this.view;var o=new M3D.JSvlReader;o.SetView(this.view),o.SetListeners(this.readListeners);var g=a[1];h=o.ReadJSvl(f.asText(),g.asBinary()),o.currentFilesName=f.name}else if(n=="obj"){var o=new M3D.ObjReader;o.SetView(this.view),o.SetListeners(this.readListeners),h=o.ReadFile(f.asText()),o.currentFilesName=f.name}}},SView.prototype.setIsFrameSelect=function(e){this.isFrameSelect=e},SView.prototype.onMouseDown=function(e){var t=this;this.onSViewMouseDown(),this.showRightMenu=!1;if(this.isShowTextNoteAlert==1)return!1;this.longTouchMenu=!1,this.singleClickFlag=!1;if(this.checkButton(e)===1){e.ctrlKey&&this.GetCommandManager().GetCurCommand()==null&&(this.isCanvace2Dsingle||this.GetSelector().Clear(),this.setIsFrameSelect(!0),this.isFrameSelctState=!0,this._firstLocation=this.GetClientPnt(e).Clone()),this.isFrameSelect&&this.DrawSelectRectangle();var n=this.GetClientPnt(e);this.closeRightMenu(e),this.timeOutEvent==0&&(this.isSinglePoint||this.oneFinger)&&(this.timeOutEvent=window.setTimeout(function(){t.press(e)},1e3)),this.timeOutEventForMove==0&&(this.isSinglePoint||this.oneFinger)&&(this.timeOutEventForMove=window.setTimeout(function(){t.longTouchMove()},500));var r=(new Date).getTime();if(Number(r.toString())-Number(this.lastMouseTime.toString())<300){var i=new M3D.Vector2(this.touchStartPoints[0],this.touchStartPoints[1]),s=new M3D.Vector2(n.x,n.y),o=i.Sub(s).Length();o<50&&(this.isDbTouch=!0,console.log("doubleTouch!"),clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0)}this.lastMouseTime=r;var u=new SView_1.MotionEvent(e,n.x,n.y);u.setEventType(SView_1.TOUCH_MASK.TOUCH_DOWN),u.setTouchCount(1);if(this.OnCommandTouchHandle(this,u))return;this.lastMousePosition=new M3D.Vector2(n.x,n.y),this.touchPnts[0]=n.x,this.touchPnts[1]=n.y,this.mouseDownPoints[0]=this.touchPnts[0],this.mouseDownPoints[1]=this.touchPnts[1],this.downPnts[0]=n.x,this.downPnts[1]=n.y,this.view.TouchDown(this.touchPnts,1),this.touchStartPoints[0]=n.x,this.touchStartPoints[1]=n.y,this.touchDown=!0,this.configJson==null||this.configJson==undefined?this.isPickUp=!0:this.configJson.pc.pickup==="left"&&(this.isPickUp=!0),this.singleClickFlag=!0,this.view.SetRotationCenter(n.x,n.y)}else if(this.checkButton(e)===4){clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0,this.isWheelPressing=!0;var n=this.GetClientPnt(e),u=new SView_1.MotionEvent(e,n.x,n.y);u.setEventType(SView_1.TOUCH_MASK.TOUCH_DOWN),u.setTouchCount(1);if(this.OnCommandTouchHandle(this,u))return;this.lastMousePosition=new M3D.Vector2(n.x,n.y),this.touchPnts[0]=n.x,this.touchPnts[1]=n.y,this.mouseDownPoints[0]=this.touchPnts[0],this.mouseDownPoints[1]=this.touchPnts[1],this.downPnts[0]=n.x,this.downPnts[1]=n.y,this.touchDown=!0,(this.configJson!=null||this.configJson!=undefined)&&this.configJson.pc.pickup==="wheelkey"&&(this.isPickUp=!0),this.singleClickFlag=!0,this.view.TouchDown(this.touchPnts,1)}else if(this.checkButton(e)===2){clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0,e.ctrlKey&&this.GetCommandManager().GetCurCommand()==null&&(this.isCanvace2Dsingle||this.GetSelector().Clear(),this.setIsFrameSelect(!0),this.isFrameSelctState=!0,this._firstLocation=this.GetClientPnt(e).Clone()),this.isFrameSelect&&this.DrawSelectRectangle();var n=this.GetClientPnt(e),u=new SView_1.MotionEvent(e,n.x,n.y);u.setEventType(SView_1.TOUCH_MASK.TOUCH_DOWN),u.setTouchCount(1);if(this.OnCommandTouchHandle(this,u))return;this.lastMousePosition=new M3D.Vector2(n.x,n.y),this.touchPnts[0]=n.x,this.touchPnts[1]=n.y,this.mouseDownPoints[0]=this.touchPnts[0],this.mouseDownPoints[1]=this.touchPnts[1],this.downPnts[0]=n.x,this.downPnts[1]=n.y,this.view.TouchDown(this.touchPnts,1),this.touchDown=!0,(this.configJson!=null||this.configJson!=undefined)&&this.configJson.pc.pickup==="right"&&(this.isPickUp=!0),this.singleClickFlag=!0,this.view.SetRotationCenter(n.x,n.y)}this.isControlDown=!0,this.Refresh()},SView.prototype.onMouseMove=function(e){this.onSViewMouseMove();if(!this.isControlDown)return;if(this.checkButton(e)===1){this.isFrameSelect&&this.DrawSelectRectangle();if(this.touchDown){var t=this.GetClientPnt(e);if(this.lastMousePosition.x===t.x&&this.lastMousePosition.x===t.y)return;var n=new SView_1.MotionEvent(e,t.x,t.y);n.setEventType(SView_1.TOUCH_MASK.TOUCH_MOVE),n.setTouchCount(1);if(this.OnCommandTouchHandle(this,n))return;this.touchPnts[0]=t.x,this.touchPnts[1]=t.y;var r=new M3D.Vector2(this.mouseDownPoints[0],this.mouseDownPoints[1]),i=new M3D.Vector2(this.touchPnts[0],this.touchPnts[1]),s=r.Sub(i).Length();s>1e-5&&(this.singleClickFlag=!1,clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0),this.oneFinger?this.configJson.onefinger.operation==="rotating"?this.view.TouchMove(this.OperaType,this.touchPnts,1):this.configJson.onefinger.operation==="traslation"?this.view.TouchMove(2,this.touchPnts,1):this.configJson.onefinger.operation==="zoom"&&this.moveOperating(e,t):this.isSinglePoint?this.mouseSingleOperat(e,t):this.configJson==null||this.configJson==undefined?this.view.TouchMove(this.OperaType,this.touchPnts,1):this.configJson.pc.rotating==="left"?this.view.TouchMove(this.OperaType,this.touchPnts,1):this.configJson.pc.traslation==="left"?this.view.TouchMove(2,this.touchPnts,1):this.configJson.pc.zoom==="left"&&this.moveOperating(e,t),this.lastMousePosition=t.Clone()}this.SendMoving()}else if(this.checkButton(e)===4){if(this.touchDown){this.isWheelPressing=!0;var t=this.GetClientPnt(e);if(this.lastMousePosition.x===t.x&&this.lastMousePosition.x===t.y)return;var n=new SView_1.MotionEvent(e,t.x,t.y);n.setEventType(SView_1.TOUCH_MASK.TOUCH_MOVE),n.setTouchCount(1);if(this.OnCommandTouchHandle(this,n))return;this.touchPnts[0]=t.x,this.touchPnts[1]=t.y;var r=new M3D.Vector2(this.mouseDownPoints[0],this.mouseDownPoints[1]),i=new M3D.Vector2(this.touchPnts[0],this.touchPnts[1]),s=r.Sub(i).Length();s>1e-5&&(this.singleClickFlag=!1,clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0);if(this.configJson==null||this.configJson==undefined){var o=this.width,u=this.height,a=o*.001;this.touchPnts[0]=t.x+a,this.touchPnts[1]=t.y+a,this.view.TouchMove(2,this.touchPnts,1)}else this.configJson.pc.rotating==="wheelkey"?this.view.TouchMove(this.OperaType,this.touchPnts,1):this.configJson.pc.traslation==="wheelkey"?this.view.TouchMove(2,this.touchPnts,1):this.configJson.pc.zoom==="wheelkey"&&this.moveOperating(e,t)}this.SendMoving()}else if(this.checkButton(e)===2){if(this.touchDown){var t=this.GetClientPnt(e);if(this.lastMousePosition.x===t.x&&this.lastMousePosition.x===t.y)return;var n=new SView_1.MotionEvent(e,t.x,t.y);n.setEventType(SView_1.TOUCH_MASK.TOUCH_MOVE),n.setTouchCount(1);if(this.OnCommandTouchHandle(this,n))return;this.touchPnts[0]=t.x,this.touchPnts[1]=t.y;var r=new M3D.Vector2(this.mouseDownPoints[0],this.mouseDownPoints[1]),i=new M3D.Vector2(this.touchPnts[0],this.touchPnts[1]),s=r.Sub(i).Length();s>1e-5&&(this.singleClickFlag=!1,clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0),this.configJson!=null&&this.configJson!=undefined&&(this.configJson.pc.rotating==="right"?this.view.TouchMove(this.OperaType,this.touchPnts,1):this.configJson.pc.traslation==="right"?this.view.TouchMove(2,this.touchPnts,1):this.configJson.pc.zoom==="right"&&this.moveOperating(e,t))}this.SendMoving()}this.Refresh(),this.view.commonTouchHandler.twoOperateType=M3D.TwoOperateType.all},SView.prototype.moveOperating=function(e,t){var n=this.width,r=this.height;e.preventDefault(),e.stopPropagation();var i=n*.1,s=0;this.configJson.pc.zoombearing==="up"?s=1+(this.downPnts[1]-this.touchPnts[1])*.01:this.configJson.pc.zoombearing==="down"?s=1-(this.downPnts[1]-this.touchPnts[1])*.01:this.configJson.pc.zoombearing==="left"?s=1+(this.downPnts[0]-this.touchPnts[0])*.01:s=1-(this.downPnts[0]-this.touchPnts[0])*.01,this.isSinglePoint&&(this.configJson.singletouch.zoombearing==="up"?s=1+(this.downPnts[1]-this.touchPnts[1])*.01:this.configJson.singletouch.zoombearing==="down"?s=1-(this.downPnts[1]-this.touchPnts[1])*.01:this.configJson.singletouch.zoombearing==="left"?s=1+(this.downPnts[0]-this.touchPnts[0])*.01:s=1-(this.downPnts[0]-this.touchPnts[0])*.01),this.oneFinger&&(this.configJson.onefinger.zoombearing==="up"?s=1+(this.downPnts[1]-this.touchPnts[1])*.01:this.configJson.onefinger.zoombearing==="down"?s=1-(this.downPnts[1]-this.touchPnts[1])*.01:this.configJson.onefinger.zoombearing==="left"?s=1+(this.downPnts[0]-this.touchPnts[0])*.01:s=1-(this.downPnts[0]-this.touchPnts[0])*.01),this.touchPnts[0]=this.mouseDownPoints[0]+i,this.touchPnts[1]=this.mouseDownPoints[1]+i,this.touchPnts[2]=this.mouseDownPoints[0]-i,this.touchPnts[3]=this.mouseDownPoints[1]-i,this.touchPnts[4]=t.x,this.touchPnts[5]=t.y;if(this.view.workTouchHandler.HandleDragger([t.x,t.y],0,M3D.TouchHandler.TOUCHMOVE,0))return;this.view.TouchDown(this.touchPnts,2),this.touchPnts[0]=this.mouseDownPoints[0]+i*s,this.touchPnts[1]=this.mouseDownPoints[1]+i*s,this.touchPnts[2]=this.mouseDownPoints[0]-i*s,this.touchPnts[3]=this.mouseDownPoints[1]-i*s,this.touchPnts[4]=t.x,this.touchPnts[5]=t.y,this.view.TouchMove(3,this.touchPnts,2),this.view.TouchMove(3,this.touchPnts,2),this.downPnts[0]=t.x,this.downPnts[1]=t.y},SView.prototype.mouseSingleOperat=function(e,t){this.isLongTouch?this.configJson==null||this.configJson==undefined?this.moveOperating(e,t):this.configJson.singletouch.rotating==="longtouch"?this.view.TouchMove(this.OperaType,this.touchPnts,1):this.configJson.singletouch.traslation==="longtouch"?this.view.TouchMove(2,this.touchPnts,1):this.configJson.singletouch.zoom==="longtouch"&&this.moveOperating(e,t):this.isDbTouch?this.configJson==null||this.configJson==undefined?this.view.TouchMove(2,this.touchPnts,1):this.configJson.singletouch.rotating==="dbtouch"?this.view.TouchMove(this.OperaType,this.touchPnts,1):this.configJson.singletouch.traslation==="dbtouch"?this.view.TouchMove(2,this.touchPnts,1):this.configJson.singletouch.zoom==="dbtouch"&&this.moveOperating(e,t):this.configJson==null||this.configJson==undefined?this.view.TouchMove(this.OperaType,this.touchPnts,1):this.configJson.singletouch.rotating==="touch"?this.view.TouchMove(this.OperaType,this.touchPnts,1):this.configJson.singletouch.traslation==="touch"?this.view.TouchMove(2,this.touchPnts,1):this.configJson.singletouch.zoom==="touch"&&this.moveOperating(e,t)},SView.prototype.SetIsMultiSelect=function(e){this.isMultiSelect=e},SView.prototype.OnExecute=function(e,t){var n=this.view.GetPickShape(e,t,M3D.ShapeType.SHAPE_MODEL,0);if(n&&n.GetType()===M3D.ShapeType.SHAPE_MODEL){var r=n,i=SView_1.LinkManager.Instance().GetLink(r.GetSVLPath(),r.GetWorldTransform().Translation());i&&i.onExecute()}},SView.prototype.SelectShape=function(e,t){var n=this.view.GetSelector(),r=n.Get(),i=this.view.GetPickShape(e,t,M3D.ShapeType.SHAPE_MODEL,0);if(i!==null)if(!i.IsSelected()){if(!M3D.Parameters.Instance().IsMulSelect||this.view.GetUsingTouchHandlerType()==M3D.TouchHandlerType.HANDLER_DRAGGER)n.Clear(),this.SHotSpotDescribeListener("");if(i.IsVisible()&&i.GetSelectAble()){n.Add(i),this._isAixsCommand&&this.buttonBindAixs(),this._isRotationCommand&&this.buttonBindRotation();if(i instanceof M3D.ImageModel)for(var s=0,o=SView_1.SHotSpotManager.Instance().GetAllHotSpotList();s<o.length;s++){var u=o[s];i===u.GetHotSpotImage()&&u.onExecute()}}}else this.isFrameSelctState?(n.Clear(),this.SHotSpotDescribeListener(""),this.isFrameSelctState=!1):(n.Remove(i),this.SHotSpotDescribeListener(""));else n.Clear(),this.SHotSpotDescribeListener("")},SView.prototype.onMouseUp=function(e){this.onSViewMouseUp(),this.isControlDown=!1,this.isWheelPressing=!1,this.isFrameSelect=!1,clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0,this.isLongTouch=!1;if(this.checkButton(e)===0||this.checkButton(e)===1){var t=this.GetClientPnt(e),n=new SView_1.MotionEvent(e,t.x,t.y);n.setEventType(SView_1.TOUCH_MASK.TOUCH_UP),n.setTouchCount(1),this.touchDown=!1;if(this.singleClickFlag&&this.OnCommandTouchHandle(this,n))return;this.touchPnts[0]=t.x,this.touchPnts[1]=t.y;if(this.isDbTouch){var r=this.view.GetPickShape(t.x,t.y,M3D.ShapeType.SHAPE_MODEL,0);r&&r.GetType()===M3D.ShapeType.SHAPE_MODEL?this.DoubleTouchListener(r.GetSVLPath()):this.DoubleTouchListener(null)}this.view.TouchUp(this.touchPnts,1),!this.choiceSwitch&&this.singleClickFlag&&this.OnExecute(t.x,t.y),this.singleClickFlag&&this.isPickUp&&this.showRightMenu==0&&this.GetCommandManager().GetCurCommand()==null&&this.choiceSwitch&&(this.SelectShape(t.x,t.y),this.clickUp=!0)}else if(this.checkButton(e)===4){var t=this.GetClientPnt(e);this.lastMousePosition=new M3D.Vector2(t.x,t.y);var i=this.width,s=this.height,o=i*.001;this.touchPnts[0]=t.x+o,this.touchPnts[1]=t.y+o,this.touchPnts[2]=t.x-o,this.touchPnts[3]=t.y-o,this.view.TouchUp(this.touchPnts,2),this.touchDown=!1,this.singleClickFlag&&this.isPickUp&&this.showRightMenu==0&&this.GetCommandManager().GetCurCommand()==null&&this.choiceSwitch&&this.SelectShape(t.x,t.y),this.Refresh(),this.singleClickFlag=!1}else if(this.checkButton(e)===2){var t=this.GetClientPnt(e),n=new SView_1.MotionEvent(e,t.x,t.y);n.setEventType(SView_1.TOUCH_MASK.TOUCH_UP),n.setTouchCount(1);if(this.singleClickFlag&&this.OnCommandTouchHandle(this,n))return;this.touchPnts[0]=t.x,this.touchPnts[1]=t.y,this.view.TouchUp(this.touchPnts,1),this.touchDown=!1,this.singleClickFlag&&this.isPickUp&&this.showRightMenu==0&&this.GetCommandManager().GetCurCommand()==null&&this.choiceSwitch&&this.SelectShape(t.x,t.y)}this.isDbTouch=!1,this.touchPnts=new Array(10),this.isShowRightMenu(!1),this.isPickUp=!1},SView.prototype.GetClientPnt=function(e){var t=new M3D.Vector2;return t.x=e.offsetX*this.deviceRatio,t.y=e.offsetY*this.deviceRatio,t},SView.prototype.onMouseWheel=function(e){if(this.touchDown)return e.preventDefault(),!1;var t=!1;M3D.Parameters.Instance().IsConRotate&&(this.view.CloseSceneAnimation(),t=!0);var n=this.width,r=this.height;e.preventDefault(),e.stopPropagation();if(this.isWheelPressing)return!1;var i=this.GetClientPnt(e),s=1;e.wheelDelta?s=1-e.wheelDelta*5e-4:e.detail&&(s=1+e.detail*.01);var o=n*.1;this.touchPnts[0]=i.x+o,this.touchPnts[1]=i.y+o,this.touchPnts[2]=i.x-o,this.touchPnts[3]=i.y-o,this.view.TouchDown(this.touchPnts,2),this.touchPnts[0]=i.x+o*s,this.touchPnts[1]=i.y+o*s,this.touchPnts[2]=i.x-o*s,this.touchPnts[3]=i.y-o*s,this.view.TouchMove(SView.TOUCH_NORMAL,this.touchPnts,2),this.view.TouchMove(SView.TOUCH_NORMAL,this.touchPnts,2),this.SendMoving(),this.Refresh(),this.onSViewMouseMove()},SView.prototype.Refresh=function(){this.view.GetSceneManager().GetRenderManager().RequestRedraw()},SView.prototype.SendMoving=function(){},SView.prototype.OnKeyDown=function(e){},SView.prototype.OnKeyPress=function(e){var t=this.view.GetTouchHandler();if(!(t instanceof M3D.WalkthroughHandler))return!0;var n=t,r=M3D.CookieHelper.GetCookie("walkThroughSpeed")?M3D.CookieHelper.GetCookie("walkThroughSpeed"):"1x",i=Number(r.substr(0,r.length-1));switch(e.keyCode){case 119:n.MoveStraight(i);break;case 115:n.MoveStraight(-i);break;case 97:n.MoveSideways(i);break;case 100:n.MoveSideways(-i);break;case 113:n.MoveUpAndDown(i);break;case 101:n.MoveUpAndDown(-i)}e.ctrlKey},SView.prototype.OnKeyUp=function(e){},SView.prototype.GetTouchClientPnt=function(e){var t=new M3D.Vector2;return t.x=e[0].pageX-this.renderCanvas.offsetLeft,t.y=e[0].pageY-this.renderCanvas.offsetTop,t},SView.prototype.scaleToDeviceRatio=function(e){e.x=e.x*this.deviceRatio,e.y=e.y*this.deviceRatio},SView.prototype.force=function(e){var t=e;t.changedTouches[0].force==1&&!this.showRightMenu&&this.press(e)},SView.prototype.press=function(e){this.timeOutEvent=0,this.showRightMenuInIos(e),this.isShowRightMenu(!0),this.isLongTouch=!1,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0},SView.prototype.closeRightMenu=function(e){this.CloseRightMenuInIos(e)},SView.prototype.longTouchMove=function(){this.isLongTouch=!0,this.longTouchMenu=!0},SView.prototype.isShowRightMenu=function(e){this.showRightMenu=e},SView.prototype.touchstart=function(e){var t=this;this.singleClickFlag=!1,e.preventDefault(),e.stopPropagation();var n=window.hasOwnProperty("PointerEvent");switch(e.touches.length){case 1:this.showRightMenu=!1,this.longTouchMenu=!1,this.CloseRightMenuInIos(e),this.timeOutEvent==0&&(this.timeOutEvent=window.setTimeout(function(){t.press(e)},1e3)),this.timeOutEventForMove==0&&(this.timeOutEventForMove=window.setTimeout(function(){t.longTouchMove()},500));var r=new M3D.Vector2;r.x=e.touches[0].pageX-this.getOffsetLeftToBody(this.renderCanvas),r.y=e.touches[0].pageY-this.getOffsetTopToBody(this.renderCanvas),this.scaleToDeviceRatio(r);var i=(new Date).getTime();if(Number(i.toString())-Number(this.lastTouchTime.toString())<300){var s=new M3D.Vector2(this.touchStartPoints[0],this.touchStartPoints[1]),o=new M3D.Vector2(r.x,r.y),u=s.Sub(o).Length();u<50&&(this.isDbTouch=!0,console.log("doubleTouch!"),clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0)}this.lastTouchTime=i;var a=new SView_1.MotionEvent(e,r.x,r.y);a.setEventType(SView_1.TOUCH_MASK.TOUCH_DOWN),a.setTouchCount(1);if(this.OnCommandTouchHandle(this,a))return;this.lastMousePosition=new M3D.Vector2(r.x,r.y),this.touchPnts[0]=r.x,this.touchPnts[1]=r.y,this.mouseDownPoints[0]=this.touchPnts[0],this.mouseDownPoints[1]=this.touchPnts[1],this.downPnts[0]=r.x,this.downPnts[1]=r.y,this.touchStartPoints[0]=r.x,this.touchStartPoints[1]=r.y,this.view.TouchDown(this.touchPnts,1),this.touchDown=!0,this.singleClickFlag=!0;break;case 2:clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0;var f=new M3D.Vector2,l=new M3D.Vector2;f.x=e.touches[0].pageX-this.getOffsetLeftToBody(this.renderCanvas),f.y=e.touches[0].pageY-this.getOffsetTopToBody(this.renderCanvas),l.x=e.touches[1].pageX-this.getOffsetLeftToBody(this.renderCanvas),l.y=e.touches[1].pageY-this.getOffsetLeftToBody(this.renderCanvas),this.scaleToDeviceRatio(f),this.scaleToDeviceRatio(l),this.touchPnts[0]=f.x,this.touchPnts[1]=f.y,this.touchPnts[2]=l.x,this.touchPnts[3]=l.y,this.touchDown=!0,this.view.TouchDown(this.touchPnts,2)}},SView.prototype.touchmove=function(e){e.preventDefault(),e.stopPropagation(),this.touchDown&&console.log("Listener:TouchMoveLisener--------------"+e.touches.length);var t=window.hasOwnProperty("PointerEvent");switch(e.touches.length){case 1:if(this.touchDown){clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0;var n=new M3D.Vector2;n.x=e.touches[0].pageX-this.getOffsetLeftToBody(this.renderCanvas),n.y=e.touches[0].pageY-this.getOffsetTopToBody(this.renderCanvas),this.scaleToDeviceRatio(n);if(this.lastMousePosition.x===n.x&&this.lastMousePosition.x===n.y)return;var r=new SView_1.MotionEvent(e,n.x,n.y);r.setEventType(SView_1.TOUCH_MASK.TOUCH_MOVE),r.setTouchCount(1);if(this.OnCommandTouchHandle(this,r))return;var i=new M3D.Vector2(this.touchPnts[0],this.touchPnts[1]),s=new M3D.Vector2(n.x,n.y),o=i.Sub(s).Length();this.touchPnts[0]=n.x,this.touchPnts[1]=n.y,this.oneFinger?this.configJson.onefinger.operation==="rotating"?this.view.TouchMove(this.OperaType,this.touchPnts,1):this.configJson.onefinger.operation==="traslation"?this.view.TouchMove(2,this.touchPnts,1):this.configJson.onefinger.operation==="zoom"&&this.zoomOptionForTouch(e,n):this.isSinglePoint?this.touchSingleOpreation(e,n):this.configJson.phone?this.configJson.phone.rotating==="1"?this.view.TouchMove(this.OperaType,this.touchPnts,1):this.configJson.phone.traslation==="1"?this.view.TouchMove(2,this.touchPnts,1):this.configJson.phone.zoom==="1"&&this.zoomOptionForTouch(e,n):this.view.TouchMove(this.OperaType,this.touchPnts,1),this.lastMousePosition=n.Clone(),o>1e-5&&(this.singleClickFlag=!1,clearTimeout(this.timeOutEvent),this.timeOutEvent=0)}this.SendMoving();break;case 2:clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0;var u=new M3D.Vector2,a=new M3D.Vector2;u.x=e.touches[0].pageX-this.getOffsetLeftToBody(this.renderCanvas),u.y=e.touches[0].pageY-this.getOffsetTopToBody(this.renderCanvas),a.x=e.touches[1].pageX-this.getOffsetLeftToBody(this.renderCanvas),a.y=e.touches[1].pageY-this.getOffsetTopToBody(this.renderCanvas),this.scaleToDeviceRatio(u),this.scaleToDeviceRatio(a),this.touchPnts[0]=u.x,this.touchPnts[1]=u.y,this.touchPnts[2]=a.x,this.touchPnts[3]=a.y,this.configJson.phone?this.configJson.phone.rotating==="2"&&this.configJson.phone.traslation==="2"&&this.configJson.phone.zoom==="2"?this.view.TouchMove(0,this.touchPnts,2):this.configJson.phone.rotating==="2"&&this.configJson.phone.traslation==="2"?this.view.TouchMove(6,this.touchPnts,2):this.configJson.phone.rotating==="2"&&this.configJson.phone.zoom==="2"?this.view.TouchMove(7,this.touchPnts,2):this.configJson.phone.traslation==="2"&&this.configJson.phone.zoom==="2"?this.view.TouchMove(4,this.touchPnts,2):this.configJson.phone.rotating==="2"?this.view.TouchMove(this.OperaType,this.touchPnts,1):this.configJson.phone.traslation==="2"?this.view.TouchMove(2,this.touchPnts,2):this.configJson.phone.zoom==="2"&&this.view.TouchMove(3,this.touchPnts,2):this.view.TouchMove(0,this.touchPnts,2)}},SView.prototype.zoomOptionForTouch=function(e,t){var n=this.width,r=this.height;e.preventDefault(),e.stopPropagation();var i=n*.1,s=0;this.configJson.phone.zoombearing==="up"?s=1+(this.downPnts[1]-this.touchPnts[1])*.01:this.configJson.phone.zoombearing==="down"?s=1-(this.downPnts[1]-this.touchPnts[1])*.01:this.configJson.phone.zoombearing==="left"?s=1+(this.downPnts[0]-this.touchPnts[0])*.01:s=1-(this.downPnts[0]-this.touchPnts[0])*.01,this.isSinglePoint&&(this.configJson.singletouch.zoombearing==="up"?s=1+(this.downPnts[1]-this.touchPnts[1])*.01:this.configJson.singletouch.zoombearing==="down"?s=1-(this.downPnts[1]-this.touchPnts[1])*.01:this.configJson.singletouch.zoombearing==="left"?s=1+(this.downPnts[0]-this.touchPnts[0])*.01:s=1-(this.downPnts[0]-this.touchPnts[0])*.01),this.oneFinger&&(this.configJson.onefinger.zoombearing==="up"?s=1+(this.downPnts[1]-this.touchPnts[1])*.01:this.configJson.onefinger.zoombearing==="down"?s=1-(this.downPnts[1]-this.touchPnts[1])*.01:this.configJson.onefinger.zoombearing==="left"?s=1+(this.downPnts[0]-this.touchPnts[0])*.01:s=1-(this.downPnts[0]-this.touchPnts[0])*.01),this.touchPnts[0]=this.mouseDownPoints[0]+i,this.touchPnts[1]=this.mouseDownPoints[1]+i,this.touchPnts[2]=this.mouseDownPoints[0]-i,this.touchPnts[3]=this.mouseDownPoints[1]-i,this.touchPnts[4]=t.x,this.touchPnts[5]=t.y;if(this.view.workTouchHandler.HandleDragger([t.x,t.y],0,M3D.TouchHandler.TOUCHMOVE,0))return;this.view.TouchDown(this.touchPnts,2),this.touchPnts[0]=this.mouseDownPoints[0]+i*s,this.touchPnts[1]=this.mouseDownPoints[1]+i*s,this.touchPnts[2]=this.mouseDownPoints[0]-i*s,this.touchPnts[3]=this.mouseDownPoints[1]-i*s,this.touchPnts[4]=t.x,this.touchPnts[5]=t.y,this.view.TouchMove(3,this.touchPnts,2),this.view.TouchMove(3,this.touchPnts,2),this.downPnts[0]=t.x,this.downPnts[1]=t.y},SView.prototype.touchSingleOpreation=function(e,t){this.isLongTouch?this.configJson==null||this.configJson==undefined?this.zoomOptionForTouch(e,t):this.configJson.singletouch.rotating==="longtouch"?this.view.TouchMove(this.OperaType,this.touchPnts,1):this.configJson.singletouch.traslation==="longtouch"?this.view.TouchMove(2,this.touchPnts,1):this.configJson.singletouch.zoom==="longtouch"&&this.zoomOptionForTouch(e,t):this.isDbTouch?this.configJson==null||this.configJson==undefined?this.view.TouchMove(2,this.touchPnts,1):this.configJson.singletouch.rotating==="dbtouch"?this.view.TouchMove(this.OperaType,this.touchPnts,1):this.configJson.singletouch.traslation==="dbtouch"?this.view.TouchMove(2,this.touchPnts,1):this.configJson.singletouch.zoom==="dbtouch"&&this.zoomOptionForTouch(e,t):this.configJson==null||this.configJson==undefined?this.view.TouchMove(this.OperaType,this.touchPnts,1):this.configJson.singletouch.rotating==="touch"?this.view.TouchMove(this.OperaType,this.touchPnts,1):this.configJson.singletouch.traslation==="touch"?this.view.TouchMove(2,this.touchPnts,1):this.configJson.singletouch.zoom==="touch"&&this.zoomOptionForTouch(e,t)},SView.prototype.touchend=function(e){e.preventDefault(),e.stopPropagation();var t=window.hasOwnProperty("PointerEvent");switch(e.changedTouches.length){case 1:clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0;var n=new M3D.Vector2;n.x=e.changedTouches[0].pageX-this.getOffsetLeftToBody(this.renderCanvas),n.y=e.changedTouches[0].pageY-this.getOffsetTopToBody(this.renderCanvas),this.scaleToDeviceRatio(n);var r=new SView_1.MotionEvent(e,n.x,n.y);r.setEventType(SView_1.TOUCH_MASK.TOUCH_UP),r.setTouchCount(1);if(this.singleClickFlag&&this.OnCommandTouchHandle(this,r))return;if(this.isDbTouch){var i=this.view.GetPickShape(n.x,n.y,M3D.ShapeType.SHAPE_MODEL,0);i?this.DoubleTouchListener(i.GetSVLPath()):this.DoubleTouchListener(null)}this.touchPnts[0]=n.x,this.touchPnts[1]=n.y,this.view.TouchUp(this.touchPnts,1),this.touchDown=!1,!this.choiceSwitch&&this.singleClickFlag&&this.OnExecute(n.x,n.y),this.singleClickFlag&&
this.showRightMenu==0&&this.GetCommandManager().GetCurCommand()==null&&this.choiceSwitch&&!this.clickUp&&this.SelectShape(n.x,n.y);break;case 2:clearTimeout(this.timeOutEvent),this.timeOutEvent=0,clearTimeout(this.timeOutEventForMove),this.timeOutEventForMove=0;var s=new M3D.Vector2,o=new M3D.Vector2;s.x=e.changedTouches[0].pageX-this.getOffsetLeftToBody(this.renderCanvas),s.y=e.changedTouches[0].pageY-this.getOffsetTopToBody(this.renderCanvas),o.x=e.changedTouches[1].pageX-this.getOffsetLeftToBody(this.renderCanvas),o.y=e.changedTouches[1].pageY-this.getOffsetTopToBody(this.renderCanvas),this.scaleToDeviceRatio(s),this.scaleToDeviceRatio(o),this.touchPnts[0]=s.x,this.touchPnts[1]=s.y,this.touchPnts[2]=o.x,this.touchPnts[3]=o.y,this.view.TouchUp(this.touchPnts,2)}this.isDbTouch=!1,this.isLongTouch=!1,this.touchPnts=new Array(10)},SView.prototype.Draw=function(){this.view.OnDraw()},SView.prototype.resize=function(){this.renderCanvas!==null&&(this.renderCanvas.parentElement!=null&&this.renderCanvas.parentElement!=undefined?(this.renderCanvas.width=this.renderCanvas.parentElement.offsetWidth*this.deviceRatio,this.renderCanvas.height=this.renderCanvas.parentElement.offsetHeight*this.deviceRatio):SView_1.GetLogger().Error(this,"renderCanvas:resize error"),this.width=this.renderCanvas.width,this.height=this.renderCanvas.height,this.view.WindowSizeChange(this.width,this.height))},SView.prototype.IsPC=function(){var e=navigator.userAgent,t=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],n=!0;for(var r=0;r<t.length;r++)if(e.indexOf(t[r])>0){n=!1;break}return n},SView.prototype.InitRenderCavansEventListener=function(){var e=this;if(this.renderCanvas!==null){this.renderCanvas.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.IsPC()&&this.renderCanvas.addEventListener("mousemove",function(t){return e.onMouseMove(t)},!1);var t=window.hasOwnProperty("PointerEvent");this.IsPC()&&(t?(this.renderCanvas.addEventListener("pointerup",function(t){return e.onMouseUp(t)},!1),this.renderCanvas.addEventListener("pointerdown",function(t){return e.onMouseDown(t)},!1)):(this.renderCanvas.addEventListener("mouseup",function(t){return e.onMouseUp(t)},!1),this.renderCanvas.addEventListener("mousedown",function(t){return e.onMouseDown(t)},!1))),M3D.Parameters.Instance().onMouseWheel&&(this.renderCanvas.addEventListener("mousewheel",function(t){return e.onMouseWheel(t)},!1),this.renderCanvas.addEventListener("DOMMouseScroll",function(t){return e.onMouseWheel(t)},!1)),this.renderCanvas.addEventListener("touchstart",function(t){return e.touchstart(t)},!1),this.renderCanvas.addEventListener("touchend",function(t){return e.touchend(t)},!1),this.renderCanvas.addEventListener("touchmove",function(t){return e.touchmove(t)},!1),this.renderCanvas.addEventListener("touchforcechange",function(t){return e.force(t)},!1),window.addEventListener("keydown",function(t){return e.OnKeyDown(t)},!1),window.addEventListener("keypress",function(t){return e.OnKeyPress(t)},!1),window.addEventListener("resize",this.resize.bind(this),!1),this.resize()}},SView.prototype.closeCavansEventListener=function(e){e?this.renderCanvas!==null&&(this.renderCanvas.style.pointerEvents=""):this.renderCanvas!==null&&(this.renderCanvas.style.pointerEvents="none")},SView.prototype.RestoreView=function(){this.view.RestoreView(),this.CloseClipPlane(),this.ClearExplosive(),this.ClearRotateAndExplosive(),this.onRestoreViewEnd()},SView.prototype.SetPerspective=function(e){this.view.SetPerspective(e)},SView.prototype.AsyOpenRemotes=function(e,t,n){var r=0;if(e.length>0){var i=new M3D.ReadNextListener;this.readNextListener=i;var s=this;this.readNextListener.onReadEnd=function(o){s.readNextListener=null;var u=++r;u<e.length&&(s.readNextListener=i,i.allFilesCount=e.length,i.currentFileIndex=u,i.currentFilesName=M3D.FileHelper.GetFileNameFromUrl(e[u]),s.OpenSingleRemote(e[u],!0,!0,"",n));if(u==e.length){var a=new M3D.Model;a.SetName(t);for(var f=0;f<s.mulitFileReadModels.length;f++){var l=s.mulitFileReadModels[f];l.SetPlcId(f),a.AddSubModel(l)}var c=o;c.SetModel(a),s.view.ReadModel(a);for(var h=0,p=s.readListeners;h<p.length;h++){var d=p[h];d.onReadEnd(c)}}},i.allFilesCount=e.length,i.currentFileIndex=0,i.currentFilesName=M3D.FileHelper.GetFileNameFromUrl(e[0])}return this.OpenSingleRemote(e[0],!0,!0,"",n),null},SView.prototype.OpenSingleRemote=function(e,t,n,r,i){if(t){var s=this,o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="arraybuffer",o.addEventListener("loadend",function(e){var t=e.target.response,o=new JSZip(t);n?s.OpenZipFileOnlyGetModel(o,r,i):s.OpenZipFile(o,r,i)},!1),o.addEventListener("loadstart",function(e){var t=new M3D.LoadingEvent;for(var n=0,r=s.readListeners;n<r.length;n++){var i=r[n];i.onReadBegin(t)}},!1),o.addEventListener("progress",function(e){var t=new M3D.LoadingEvent;s.readNextListener!=null&&(t.fileName=s.readNextListener.currentFilesName),t.percent=e.loaded/e.total;for(var n=0,r=s.readListeners;n<r.length;n++){var i=r[n];i.onReading(t)}},!1),o.send(null)}else{var u=new XMLHttpRequest;u.overrideMimeType("text/plain"),u.open("GET",e,!0);var a=this;u.onreadystatechange=function(){u.readyState==4&&(u.status==200?console.log("成功"):console.log("不允许跨域请求"))},u.addEventListener("load",function(e){var t=e.target.response;t=t.replace(/(^\s*)|(\s*$)/g,""),t=JSON.parse(t);var n=t.zipFolder;t.reback!=0&&t.reback!="false"?a.OpenRemote(t.zipfilepath,!0,t.zipfilename,t.format):a.onAlert(t.errMsg),this.status===200?console.log("成功读取"):this.status===0},!1),u.addEventListener("error",function(e){},!1),u.send(null)}return null},SView.prototype.GetCurFileName=function(){return this.curFileName},SView.prototype.GetNeedReadFile=function(e,t,n){var r=null,i=null,s=null,o=null;if(t==null||t==undefined||t.length===0||n.toLowerCase()==="stl"||n.toLowerCase()==="obj"||n.toLowerCase()==="jsvl"){var u=void 0;n==null||n==undefined||n.length===0?u=new RegExp(".*.((jsvl)|(obj)|(stl))$","i"):u=new RegExp(".*."+n+"$","i");var a=e.file(u);if(a.length>0){r=a[0];var f=r.name,l=f.lastIndexOf(".");l>=0&&l<f.length-1&&(n=f.substr(l+1))}if(n=="jsvl"){var c=new RegExp(".*.jsvl_Mesh.bin$","i"),h=e.file(c);h.length>0&&(i=h[0]);var p=new RegExp(".*.sa$","i"),d=e.file(p);d.length>0&&(s=d[0]);var v=new RegExp(".*views$","i"),m=e.file(v);m.length>0&&(o=m[0]),console.log(v)}}else{var u=""+t+"."+n+"";r=e.file(u);if(n=="jsvl"){var g=""+t+"."+"jsvl_Mesh.bin";i=e.file(g);var p=""+t+"."+"sa",y=""+t+"."+"views";o=e.file(y),s=e.file(p)}}return n=n.toLocaleLowerCase(),[r,i,s,o,n]},SView.prototype.OpenZipFileOnlyGetModel=function(e,t,n){var r=this;this.readModelListener=new M3D.ReadModelListener,this.readModelListener.onReadEnd=function(e){var t=e.GetModel();r.mulitFileReadModels.push(t)},this.OpenSingleZipFile(e,t,n)},SView.prototype.AsyOpenSingleZipFile=function(e,t,n,r){r=!1,n=="svl"&&(n="jsvl"),this.view.GetSceneManager().GetResourceManager().ClearResource(),this.view.GetSceneManager().GetResourceManager().SetZipFile(e);var i=this.GetNeedReadFile(e,t,n);if(i[0]==null)return;var s=i[0];n=i[4],this.view.GetSelector().SetListeners(this.selectorListeners),this.curFileName=t;var o;if(n=="stl"){var u=new M3D.StlReader;u.SetView(this.view),u.SetListeners(this.readListeners),u.readNextListener=this.readNextListener,u.readModelListener=this.readModelListener;var a=u.ensureBinary(s.asBinary());u.isBinary(a)?o=u.parseBinary(a):o=u.parseASCII(u.ensureString(s.asText()))}else if(n=="jsvl"){var f=M3D.SimulationAnimationManager.Instance();f.view=this.view;var l=new M3D.JSvlReader;l.readNextListener=this.readNextListener,l.readModelListener=this.readModelListener,l.SetListeners(this.readListeners);var c=i[1];o=l.ReadJSvl(s.asText(),c.asBinary());var h=i[2],p=i[3];if(p){console.log(p);var d=p.asText(),v=d.indexOf("<");d=d.substr(v),console.log(this.ParseXmlString(d)),this.view.LoadModelViewList(this.ParseXmlString(d))}if(h){console.log(h);var d=h.asText(),v=d.indexOf("<");d=d.substr(v),M3D.SimulationAnimationManager.Instance().ProcessXMLData(this.ParseXmlString(d))}}else if(n=="obj"){var l=new M3D.ObjReader;l.readNextListener=this.readNextListener,l.readModelListener=this.readModelListener,l.SetListeners(this.readListeners);var m=s.asText();o=l.ReadFile(m)}},SView.prototype.OpenSingleZipFile=function(e,t,n){n=="svl"&&(n="jsvl"),this.view.GetSceneManager().GetResourceManager().ClearResource(),this.view.GetSceneManager().GetResourceManager().SetZipFile(e);var r=this.GetNeedReadFile(e,t,n);if(r[0]==null)return;var i=r[0];n=r[4],this.view.GetSelector().SetListeners(this.selectorListeners),this.curFileName=t;var s;if(n=="stl"){var o=new M3D.StlReader;o.SetListeners(this.readListeners),o.readNextListener=this.readNextListener,o.readModelListener=this.readModelListener;var u=o.ensureBinary(i.asBinary());o.SetView(this.view),o.isBinary(u)?s=o.parseBinary(u):s=o.parseASCII(o.ensureString(i.asText()))}else if(n=="jsvl"){var a=M3D.SimulationAnimationManager.Instance();a.view=this.view;var f=new M3D.JSvlReader;f.SetView(this.view),f.readNextListener=this.readNextListener,f.readModelListener=this.readModelListener,f.SetListeners(this.readListeners);var l=r[1];s=f.ReadJSvl(i.asText(),l.asBinary());var c=r[2],h=r[3];if(h){console.log(h);var p=h.asText(),d=p.indexOf("<");p=p.substr(d),console.log(this.ParseXmlString(p)),this.view.LoadModelViewList(this.ParseXmlString(p))}if(c){console.log(c);var p=c.asText(),d=p.indexOf("<");p=p.substr(d),M3D.SimulationAnimationManager.Instance().ProcessXMLData(this.ParseXmlString(p))}}else if(n=="obj"){var f=new M3D.ObjReader;f.SetView(this.view),f.readNextListener=this.readNextListener,f.readModelListener=this.readModelListener,f.SetView(this.view),f.SetListeners(this.readListeners),f.SetView(this.view),s=f.ReadFile(i.asText())}},SView.prototype.ParseXmlString=function(e){var t=null;if(window.hasOwnProperty("DOMParser"))try{var n=new DOMParser;t=n.parseFromString(e,"text/xml")}catch(r){}else if(window.hasOwnProperty("ActiveXObject")){var i=["MSXML2.DOMDocument","Microsoft.XMLDOM"];for(var s=0;s<i.length;s++)try{t=new ActiveXObject(i[s]),t.async=!1,t.loadXML(e);break}catch(r){continue}}return t},SView.prototype.CreatModleViewByXMlStr=function(e){return M3D.ModleView.CreateByXml(e)},SView.prototype.GetXMLStrByMV=function(e){return e.ToXml()},SView.prototype.GetXMLStrByMeasure=function(){var e=this._measureManager.GetMeasures(1),t=new Array;for(var n=0,r=e;n<r.length;n++){var i=r[n],s=M3D.MeasureFactory.MeasureToXMLElement(i.GetMeasureObj(),this.view.GetSceneManager());t.push(s)}return t},SView.prototype.GetXMLStrByTextNote=function(){var e=this._measureManager.GetMeasures(150),t=new Array;for(var n=0,r=e;n<r.length;n++){var i=r[n],s=M3D.NoteFactory.TextNoteToXMLElement(this.view.GetSceneManager(),i.GetNoteObj());t.push(s)}return t},SView.prototype.CreateTextNoteByXML=function(e){var t=SView_1.STextNote.CreateFromXML(e,this);this.GetNativeShapeManager().AddShape(t.GetID(),t.GetNoteObj()),this.GetMeasureManager().Add(t)},SView.prototype.CreateMeasureByXML=function(e){var t=SView_1.SMeasureDistance.CreateFromXML(e,this);this.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.GetMeasureManager().Add(t)},SView.prototype.OpenZipFile=function(e,t,n){var r=this,i=new M3D.ReadListener;i.onReadEnd=function(e){var t=e.GetModel();r.view.ReadModel(t),r.readEnd(),r.RemoveReadListener(i)},this.AddReadListener(i),this.OpenSingleZipFile(e,t,n)},SView.prototype.readEnd=function(){var e="{readSuccess:'true'}";M3D.Log.Info(this,e)},SView.prototype.OpenFile=function(e){var t=this,n=this;this.view.GetSceneManager().GetResourceManager().ClearResource(),this.view.GetSelector().SetListeners(this.selectorListeners);var r=M3D.FileHelper.GetSuffix(e[0].name);if(r==="zip"||r==="svp"||r==="zsvl"||r==="svlx"){var i=new FileReader,s=this;return i.addEventListener("load",function(e){var n=e.target,i=n.result,o=new JSZip(i);if(r!=="svlx")s.OpenZipFile(o,"","");else{var u=t;t.view.GetSelector().SetListeners(t.selectorListeners);var a=new M3D.ReadListener;a.onReadEnd=function(e){var t=e.GetModel();u.view.ReadModel(t),u.readEnd();var n=M3D.SimulationAnimationManager.Instance();n.view=u.view;var r=e.getAnimation();if(r){var i=r.indexOf("<");r=r.substr(i),M3D.SimulationAnimationManager.Instance().ProcessXMLData(u.ParseXmlString(r))}u.RemoveReadListener(a)},t.AddReadListener(a);var f=new M3D.SvlxReader;f.SetView(t.view),f.readNextListener=t.readNextListener,f.readModelListener=t.readModelListener,f.SetListeners(t.readListeners),f.OpenZipModel(o)}},!1),i.readAsBinaryString(e[0]),"OK"}var o="ERROR",u=M3D.Reader.GetReader(e),a=u[0];if(a==null)return u[1];var f=new M3D.ReadListener;f.onReadEnd=function(e){var t=e.GetModel();console.log("onReadEnd"+(new Date).toISOString()),n.view.ReadModel(t),n.readEnd(),n.RemoveReadListener(f)},this.AddReadListener(f),a.SetListeners(this.readListeners);var l=e[0].name,c=new FileReader,h=new FileReader,p,d,v=!0;return a instanceof M3D.JSvlReader?(c.addEventListener("load",function(e){var t=e.target;p=t.result},!1),h.addEventListener("load",function(e){var t=e.target;d=t.result;var n=a.ReadJSvl(p,d)},!1),c.readAsText(e[0]),h.readAsBinaryString(e[1])):a instanceof M3D.StlReader?(c.addEventListener("load",function(e){var t=e.target,r=t.result,i=a,s=i.ensureBinary(r);if(!i.isBinary(s)){v=!1;var o=i.parseASCII(i.ensureString(r));o!=null&&n.view.ReadModel(o)}},!1),h.addEventListener("load",function(e){if(!v)return;var t=e.target,r=t.result,i=a,s=i.ensureBinary(r);if(i.isBinary(s)){var o=i.parseBinary(s);o!=null&&n.view.ReadModel(o)}},!1),c.readAsText(e[0]),h.readAsBinaryString(e[0])):(c.addEventListener("load",function(e){var t=e.target,r=t.result,i=a.ReadFile(r);i!=null&&n.view.ReadModel(i)},!1),c.readAsText(e[0])),o="OK",o},SView.prototype.CloseFile=function(){this.view.CloseFile()},SView.prototype.setSelectType=function(e){M3D.Parameters.Instance().selectedStyle=e},SView.prototype.IsShowWireframe=function(){this.isShowWireframe?this.isShowWireframe=!1:(this.isShowWireframe=!0,this.isOnlyShowWireframe=!1),M3D.Parameters.Instance().IsShowTrilateralEdge=this.isShowWireframe,M3D.Parameters.Instance().IsOnlyShowTrilateralEdge=this.isOnlyShowWireframe,this.view.setDrawMode(4)},SView.prototype.setRenderMode=function(e){switch(e){case 0:this.IsShowEdgeLine=!0,this.IsOnlyShowEdgeLine=!1;break;case 1:this.IsShowEdgeLine=!1,this.IsOnlyShowEdgeLine=!1;break;case 2:this.IsOnlyShowEdgeLine=!0,this.IsShowEdgeLine=!0}M3D.Parameters.Instance().IsOnlyShowEdgeLine=this.IsOnlyShowEdgeLine,M3D.Parameters.Instance().IsShowEdgeLine=this.IsShowEdgeLine,this.view.setDrawMode(e)},SView.prototype.IsOnlyShowWireframe=function(){this.isOnlyShowWireframe?this.isOnlyShowWireframe=!1:(this.isOnlyShowWireframe=!0,this.isShowWireframe=!1),M3D.Parameters.Instance().IsShowTrilateralEdge=this.isShowWireframe,M3D.Parameters.Instance().IsOnlyShowTrilateralEdge=this.isOnlyShowWireframe},SView.prototype.ShowTransparent=function(){this.IsShowTransparent?this.IsShowTransparent=!1:this.IsShowTransparent=!0,M3D.Parameters.Instance().IsShowTransparent=this.IsShowTransparent;var e=this.view.getDrawMode();this.view.setDrawMode(e)},SView.prototype.GetFPS=function(){return this.view.GetSceneManager().GetRenderManager().GetFPS()},SView.prototype.SetClipPlane=function(e,t,n,r){this.view.SetClipPlane(e,t,n,r)},SView.prototype.SetClipValue=function(e){this.curClipValue=e,this.SetClipPlane(this.curClipDirection,this.curClipValue,!0,!0),this.view.GetSceneManager().GetSection().SetIsShowCappingPlane(this.curIsShowCappingPlane)},SView.prototype.SetClipDirection=function(e){this.curClipDirection=e,this.SetClipPlane(this.curClipDirection,this.curClipValue,!0,!0)},SView.prototype.SetOppositeDir=function(){this.curClipDirection=-1*this.curClipDirection,this.SetClipPlane(this.curClipDirection,this.curClipValue,!0,!0)},SView.prototype.CloseClipPlane=function(){this.view.ClearClipPlane(),this.curClipValue=0},SView.prototype.IsShowCappingPlane=function(){this.curIsShowCappingPlane?this.curIsShowCappingPlane=!1:this.curIsShowCappingPlane=!0,this.view.GetSceneManager().GetSection().SetIsShowCappingPlane(this.curIsShowCappingPlane)},SView.prototype.IsShowClipHelppingPlane=function(){M3D.Parameters.Instance().showSection?M3D.Parameters.Instance().showSection=!1:M3D.Parameters.Instance().showSection=!0},SView.prototype.AddSelectListener=function(e){return e!==null&&e!==undefined&&this.selectorListeners.indexOf(e)===-1&&this.selectorListeners.push(e),!0},SView.prototype.RemoveSelectListener=function(e){return e!==null&&e!==undefined&&this.selectorListeners.indexOf(e)!==-1&&this.selectorListeners.splice(this.selectorListeners.indexOf(e),1),!0},SView.prototype.AddReadListener=function(e){return e!==null&&e!==undefined&&this.readListeners.indexOf(e)===-1&&this.readListeners.push(e),!0},SView.prototype.RemoveReadListener=function(e){return e!==null&&e!==undefined&&this.readListeners.indexOf(e)!==-1&&this.readListeners.splice(this.readListeners.indexOf(e),1),!0},SView.prototype.GetShpae=function(e){var t=this.view.GetSceneManager().GetModel();return t!==null?t.GetModelById(e):null},SView.prototype.SetExplosiveStyle=function(e){this.curExplosiveStyle=e,this.view.SetExplosiveView(this.curExplosiveStyle,this.curExplosivePercentage,!1),this.view.SetPerspective(6)},SView.prototype.SetExplosiveStyleNoRestore=function(e){this.curExplosiveStyle=e,this.view.SetExplosiveViewNoRestore(this.curExplosiveStyle,this.curExplosivePercentage,!1)},SView.prototype.SetExplosivePersentageNoRestore=function(e){this.curExplosivePercentage=e,this.view.SetExplosiveViewNoRestore(this.curExplosiveStyle,this.curExplosivePercentage,!1)},SView.prototype.SetExplosivePersentage=function(e){this.curExplosivePercentage=e,this.view.SetExplosiveView(this.curExplosiveStyle,this.curExplosivePercentage,!1)},SView.prototype.SetExplosive=function(e,t){this.view.SetExplosiveView(e,t,!1),this.view.SetPerspective(6)},SView.prototype.ClearExplosive=function(){this.view.CloseExplosiveView(),this.curExplosivePercentage=0},SView.prototype.IsUseModelContextMenu=function(){var e=this.view.GetSelector(),t=e.GetAll();return t.length>0},SView.prototype.SetSelectModelColor=function(e,t,n){var r=this.view.GetSelector(),i=r.GetAll();for(var s=0,o=i;s<o.length;s++){var u=o[s];if(u!==null){var a=new M3D.Color(e,t,n);u.SetInitColor(a)}}},SView.prototype.SetDraggerMode=function(e){switch(e){case 0:this.view.draggerHandler.SetMode(M3D.OPEMODE.TRANSLATE);break;case 1:this.view.draggerHandler.SetMode(M3D.OPEMODE.ROTATE);break;case 2:this.view.draggerHandler.SetMode(M3D.OPEMODE.SCALE)}},SView.prototype.SetDraggerAxis=function(e){switch(e){case 0:this.view.draggerHandler.SetAxis(M3D.TRANSAXIS.AXIS_X);break;case 1:this.view.draggerHandler.SetAxis(M3D.TRANSAXIS.AXIS_Y);break;case 2:this.view.draggerHandler.SetAxis(M3D.TRANSAXIS.AXIS_Z);break;case 3:this.view.draggerHandler.SetAxis(M3D.TRANSAXIS.AXIS_FACE)}},SView.prototype.SetUsingTouchHandlerType=function(e){switch(e){case 0:this.view.SetUsingTouchHandlerType(M3D.TouchHandlerType.HANDLER_WALKTHROUGH);break;case 1:this.view.SetUsingTouchHandlerType(M3D.TouchHandlerType.HANDLER_COMMON);break;case 2:this.view.SetUsingTouchHandlerType(M3D.TouchHandlerType.HANDLER_ORBIT);break;case 3:this.view.SetUsingTouchHandlerType(M3D.TouchHandlerType.HANDLER_DRAGGER)}},SView.prototype.StartRotateBySelf=function(){this.view.GetTouchHandler().StartModelRotateOnFixedPoint()},SView.prototype.EndRotateBySelf=function(){this.view.GetTouchHandler().EndModelRotateOnFixedPoint()},SView.prototype.SetRotateAxis=function(e){this.view.GetTouchHandler().SetModelRotateAxis(e)},SView.prototype.SetRotateSpeed=function(e){this.explorsiveSpeed=e,this.view.GetTouchHandler().SetModelRotateSpeed(e)},SView.prototype.SetNeedCircleNumber=function(e){this.view.GetTouchHandler().SetNeedCircle(e)},SView.prototype.IsMatchCircleCount=function(){return this.view.GetTouchHandler().IsMatchCircleCount()},SView.prototype.ResetRotCircleCount=function(){this.view.GetTouchHandler().ResetRotCircleCount()},SView.prototype.StartRotateAndExplosive=function(){this.StartExplosiveTimer()},SView.prototype.EndRotateAndExplosive=function(){this.EndExplosiveTimer()},SView.prototype.ClearRotateAndExplosive=function(){this.explosivePercent=0,this.isRotateComplete=!1,this.isNeedRotate=!0,this.view.GetTouchHandler().ResetRotCircleCount(),this.EndRotateBySelf()},SView.prototype.JoystickControl=function(e,t){var n=this.view.GetTouchHandler();if(n instanceof M3D.WalkthroughHandler){var r=n;r.VirtualKeyMove(e,t)}},SView.prototype.StartJoystick=function(){this.joystickTimer.IsStart()&&this.joystickTimer.StopTimer(),this.joystickTimer.StartTimer(),this.joystickTimer.SetTimer(this.JoystickTask,this,41)},SView.prototype.EndJoystick=function(){this.joystickTimer.IsStart()&&this.joystickTimer.StopTimer()},SView.prototype.SetWalkingSpeed=function(e){this.view.GetTouchHandler().SetFirstPersionParameter(e)},SView.prototype.SetUpdirection=function(e){var t=new M3D.Vector3;switch(e){case 0:t=M3D.Vector3.RIGHT().Clone();break;case 1:t=M3D.Vector3.LEFT().Clone();break;case 2:t=M3D.Vector3.UP().Clone();break;case 3:t=M3D.Vector3.DOWN().Clone();break;case 4:t=M3D.Vector3.FORWARD().Clone();break;case 5:t=M3D.Vector3.BACK().Clone()}this.view.GetTouchHandler().SetUpDirection(t,this.view)},SView.prototype.SetCameraFov=function(e){var t=this.view.GetTouchHandler();return t instanceof M3D.WalkthroughHandler?(t.SetCameraFov(e),!0):!1},SView.prototype.JoystickTask=function(e){var t=e;t.joyStickOption.isJoysticPressing&&t.JoystickControl(t.joyStickOption.strightSpd,t.joyStickOption.sideSpd)},SView.prototype.StartAniTimer=function(){this.aniTimer.IsStart()&&this.aniTimer.StopTimer(),this.aniTimer.StartTimer(),this.aniTimer.SetTimer(this.AnimationTick,this,40)},SView.prototype.StopAniTimer=function(){this.aniTimer.IsStart()&&this.aniTimer.StopTimer()},SView.prototype.AnimationTick=function(e){var t=new Date;M3D.HTManager.GetHTManager().Tick(t.getTime()/1e3)},SView.prototype.StartExplosiveTimer=function(){this.explosiveTimer.IsStart()&&this.explosiveTimer.StopTimer(),this.explosiveTimer.StartTimer(),this.explosiveTimer.SetTimer(this.ExplosiveTimerTask,this,41)},SView.prototype.EndExplosiveTimer=function(){this.explosiveTimer.IsStart()&&this.explosiveTimer.StopTimer()},SView.prototype.ExplosiveTimerTask=function(e){var t=e,n=t.view.GetTouchHandler();t.isNeedRotate&&n.GetModelRotateOnFixedPointFunc(n);if(n.GetCircleNumber()===2){t.isNeedRotate=!1,t.isRotateComplete=!0,t.excStep1=!0;var r=Math.abs(Math.sin(t.explosivePercent))*.3;t.SetExplosivePersentageNoRestore(r),t.explosivePercent+=Math.PI/180*.3*t.explorsiveSpeed,t.explosivePercent>=Math.PI/2&&(t.isNeedRotate=!0,n.ResetRotCircleCount())}if(n.GetCircleNumber()===1&&t.isRotateComplete){t.isNeedRotate=!1,n.OnlyRotate(n);var r=Math.abs(Math.sin(t.explosivePercent))*.3;t.SetExplosivePersentageNoRestore(r),t.explosivePercent-=Math.PI/180*.3*t.explorsiveSpeed,t.explosivePercent<=0&&(t.isNeedRotate=!0,t.explosivePercent=0,t.SetExplosivePersentageNoRestore(0),t.isRotateComplete=!1,n.ResetRotCircleCount())}},SView.prototype.DelayRotateAndExplosive=function(){this.downTimer!==null&&(clearInterval(this.downTimer),this.EndRotateAndExplosive()),this.downTimer=setTimeout(this.StartRotateAndExplosive.bind(this),3e3)},SView.prototype.GetModelBySVLPath=function(e){var t=null;return this.view!=null?this.view.GetModelBySVLPath(e):t},SView.prototype.GetSelector=function(){var e=null;return this.view!=null?this.view.GetSelector():e},SView.prototype.FoucusViewToSCreenCenter=function(e,t){if(this.view!=null){var n=this.view.GetSceneManager().GetCamera().GetViewPort().GetRect().Center();return this.view.FoucusView(e,n,t)}return!1},SView.prototype.FoucusViewByModel=function(e,t){if(this.view!=null&&e!=null){var n=null,r=[];r=r.concat(e);for(var i=0;i<e.length;i++){var s=e[i];s.GetAllSubModels(r)}r.length>0;for(var i=0;i<r.length;i++){var s=r[i],o=s.GetWorldBoundingBox();o||(o=s.GetTotalWorldBoundingBox());if(i===0){n=o.Clone();continue}n.Merge(o.Clone())}if(n!=null){var u=this.view.GetSceneManager().GetCamera().GetViewPort().GetRect().Center();return this.view.FoucusView(n,u,t)}}return!1},SView.prototype.FoucusView=function(e,t,n){return this.view!=null?this.view.FoucusView(e,t,n):!1},SView.prototype.SetCurrentModelView=function(e){},SView.prototype.GetCurrentModelView=function(){},SView.prototype.GetDefaultModelView=function(){},SView.prototype.UpdateViewByCurrentScene=function(e){},SView.prototype.ShowModelView=function(e,t){},SView.prototype.onTextNote=function(){this.view!=null&&SView_1.MeasureOperate.onTextNote(this)},SView.prototype.onNoteDelete=function(){this.view!=null&&SView_1.MeasureOperate.onNoteDelete(this)},SView.prototype.onVoiceNote=function(){this.view!=null&&SView_1.MeasureOperate.onVoiceNote(this)},SView.prototype.onSequenceNote=function(){this.view!=null&&SView_1.MeasureOperate.onSequenceNote(this)},SView.prototype.onMeasureDistancePntToPnt=function(){this.view!=null&&SView_1.MeasureOperate.onMeasureDistancePntToPnt(this)},SView.prototype.onMeasureDistancePntToLine=function(){this.view!=null&&SView_1.MeasureOperate.onMeasureDistancePntToLine(this)},SView.prototype.onMeasureDistancePntToFace=function(){this.view!=null&&SView_1.MeasureOperate.onMeasureDistancePntToFace(this)},SView.prototype.onMeasureDistanceLineToLine=function(){this.view!=null&&SView_1.MeasureOperate.onMeasureDistanceLineToLine(this)},SView.prototype.onMeasureDistanceLineToFace=function(){this.view!=null&&SView_1.MeasureOperate.onMeasureDistanceLineToFace(this)},SView.prototype.onMeasureDistanceFaceToFace=function(){this.view!=null&&SView_1.MeasureOperate.onMeasureDistanceFaceToFace(this)},SView.prototype.onMeasureAngleLineToLine=function(){this.view!=null&&SView_1.MeasureOperate.onMeasureAngleLineToLine(this)},SView.prototype.onMeasureAngleCurveToCurve=function(){this.view!=null&&SView_1.MeasureOperate.onMeasureAngleCurveToCurve(this)},SView.prototype.onMeasureAngleLineToFace=function(){this.view!=null&&SView_1.MeasureOperate.onMeasureAngleLineToFace(this)},SView.prototype.onMeasureAngleFaceToFace=function(){this.view!=null&&SView_1.MeasureOperate.onMeasureAngleFaceToFace(this)},SView.prototype.onMeasurePropertyPoint=function(){this.view!=null&&SView_1.MeasureOperate.onMeasurePropertyPnt(this)},SView.prototype.onMeasurePropertyLine=function(){this.view!=null&&SView_1.MeasureOperate.onMeasurePropertyLine(this)},SView.prototype.onMeasurePropertyFace=function(){this.view!=null&&SView_1.MeasureOperate.onMeasurePropertyFace(this)},SView.prototype.onMeasurePropertyModel=function(){this.view!=null&&SView_1.MeasureOperate.onMeasurePropertyModel(this)},SView.prototype.onMeasureExit=function(){this.view!=null&&SView_1.MeasureOperate.onMeasureExit(this)},SView.prototype.loadMeasure=function(){this.view.GetSceneManager().ReIndexIDMapAfterAddModel(this.view.GetSceneManager().GetModel())},SView.prototype.removeMeasure=function(){this.view.GetSceneManager().ReIndexIDMapAfterDeleteModel(this.view.GetSceneManager().GetModel())},SView.prototype.onMeasureBase=function(){this.view!=null&&SView_1.MeasureOperate.onBase(this)},SView.prototype.UpdateNote=function(e,t){if(this.view!=null){var n=this.GetNativeShapeManager().GetShape(e);(n.GetType()==M3D.ShapeType.SHAPE_TEXT_NOTE||n.GetType()==M3D.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE)&&M3D.NoteFactory.UpdateNoteTextValue(n,t,this.view.GetSceneManager())}this.GetSelector().Clear()},SView.prototype.CanEditNote=function(){if(this.view!=null){var e=this.GetSelector().GetAll()[0].GetID(),t=this.GetNativeShapeManager().GetShape(e);if(t.GetType()==M3D.ShapeType.SHAPE_TEXT_NOTE||t.GetType()==M3D.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE)return!0}return!1},SView.prototype.editSequenceNote=function(){if(this.view!=null){var e=this.GetSelector().GetAll()[0].GetID(),t=this.GetNativeShapeManager().GetShape(e);if(t.GetType()==M3D.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE)return!0}return!1},SView.prototype.setIsMulSelect=function(e){M3D.Parameters.Instance().IsMulSelect=e},SView.prototype.setShowBox=function(e){M3D.Parameters.Instance().IsShowBox=e;var t=this.view.getDrawMode();this.view.setDrawMode(t)},SView.prototype.CheckLicence=function(){var e=new Date(this.atou("MjAxOSUyNTJGMDMlMjUyRjE1")),t=(e.getTime()-(new Date).getTime())/864e5;return t>0},SView.prototype.utoa=function(e){return window.btoa(encodeURI(encodeURIComponent(e)))},SView.prototype.ResetAllModel=function(){this.view.GetSceneManager().Reset(),this.GetSelector().Clear()},SView.prototype.GetCommandManager=function(){return this._commandManage!==null?this._commandManage:this._commandManage=new SView_1.CommandManager(this)},SView.prototype.GetMeasureCommandManager=function(){return this._measureCommandManager!==null?this._measureCommandManager:this._measureCommandManager=new SView_1.MeasureCommandManager(this)},SView.prototype.OnCommandTouchHandle=function(e,t){var n=this.GetCommandManager(),r=null;return n!=null&&(r=n.GetCurCommand(),r instanceof SView_1.TextNoteCommand&&(r.inputTextNoteString=function(t,n){var r=function(e,r){n(e,r,t)};e instanceof SView&&e.inputTextNote(r)})),r!==null&&r.OnTouchHandle(e,t)},SView.prototype.MeasurePropertyStr=function(e){this.PorpertyMeasureCallBack(e)},SView.prototype.GetNativeShapeManager=function(){return this._nativeShapeManager},SView.prototype.GetMeasureManager=function(){return this._measureManager!==null?this._measureManager:this._measureManager=new SView_1.MeasureManager(this)},SView.prototype.atou=function(e){return decodeURIComponent(decodeURI(window.atob(e)))},SView.prototype.OpenRemotes=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];if(!this.CheckLicence())return this.atou("JTI1RTglMjVBRiUyNTk1JTI1RTclMjU5NCUyNUE4JTI1RTUlMjVCNyUyNUIyJTI1RTglMjVCRiUyNTg3JTI1RTYlMjU5QyUyNTlGJTI1RUYlMjVCQyUyNThDJTI1RTglMjVBRiUyNUI3JTI1RTglMjU4MSUyNTk0JTI1RTclMjVCMyUyNUJCJTI1RTUlMjU4RCUyNThFJTI1RTUlMjVBNCUyNUE5JTI1RTglMjVCRCUyNUFGJTI1RTQlMjVCQiUyNUI2JTI1RTUlMjU4NSUyNUFDJTI1RTUlMjU4RiUyNUI4JTI1RTclMjU5NCUyNUIzJTI1RTglMjVBRiUyNUI3JTI1RTYlMjVBRCUyNUEzJTI1RTUlMjVCQyUyNThGJTI1RTclMjU4OSUyNTg4JTI1RTMlMjU4MCUyNTgy");if(e.length==2){var n=e[0];this.OpenSvlxFunc(n,0,this.OpenSvlxFunc.bind(this))}else if(e.length==3){var r=e[1],i=e[0],s=e[2],o=0;if(i.length>0){var u=new M3D.ReadNextListener;this.readNextListener=u;var a=this;this.readNextListener.onReadEnd=function(e){a.readNextListener=null;var t=++o;t<i.length&&(a.readNextListener=u,u.allFilesCount=i.length,u.currentFileIndex=t,u.currentFilesName=M3D.FileHelper.GetFileNameFromUrl(i[t]),a.OpenSingleRemote(i[t],!0,!0,"",s));if(t==i.length){var n=new M3D.Model;n.SetName(r);for(var f=0;f<a.mulitFileReadModels.length;f++){var l=a.mulitFileReadModels[f];l.SetPlcId(f),n.AddSubModel(l)}var c=e;c.SetModel(n),a.view.ReadModel(n);for(var h=0,p=a.readListeners;h<p.length;h++){var d=p[h];d.onReadEnd(c)}}},u.allFilesCount=i.length,u.currentFileIndex=0,u.currentFilesName=M3D.FileHelper.GetFileNameFromUrl(i[0])}this.OpenSingleRemote(i[0],!0,!0,"",s)}},SView.prototype.OpenRemote=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];SView.canvas=this;if(!this.CheckLicence())return this.atou("JTI1RTglMjVBRiUyNTk1JTI1RTclMjU5NCUyNUE4JTI1RTUlMjVCNyUyNUIyJTI1RTglMjVCRiUyNTg3JTI1RTYlMjU5QyUyNTlGJTI1RUYlMjVCQyUyNThDJTI1RTglMjVBRiUyNUI3JTI1RTglMjU4MSUyNTk0JTI1RTclMjVCMyUyNUJCJTI1RTUlMjU4RCUyNThFJTI1RTUlMjVBNCUyNUE5JTI1RTglMjVCRCUyNUFGJTI1RTQlMjVCQiUyNUI2JTI1RTUlMjU4NSUyNUFDJTI1RTUlMjU4RiUyNUI4JTI1RTclMjU5NCUyNUIzJTI1RTglMjVBRiUyNUI3JTI1RTYlMjVBRCUyNUEzJTI1RTUlMjVCQyUyNThGJTI1RTclMjU4OSUyNTg4JTI1RTMlMjU4MCUyNTgy");var n=this;M3D.ComText.option.useLocalFont=!1,M3D.ComText.option.pmiServer=this.pmiOptions.pmiServer,this.view.GetSceneManager().GetModelFillManager().openFileEnd=function(){n.view.GetSceneManager().RequestUpdateWhenSceneBoxChanged(),n.view.GetSceneManager().GetLightManager().GetAllLight().length===0&&n.view.GetSceneManager().GetLightManager().CreateDefaultLights(),n.openModelsEnd(n.view.GetModel())};if(e.length!=2){var f=e[0],r=e[1],l=e[2],c=e[3];return this.readNextListener=null,this.readModelListener=null,this.view.GetSceneManager().GetResourceManager().ClearResource(),this.OpenSingleRemote(f,r,!1,l,c)}var r=e[1],i=e[0];if(r){this.view.GetSelector().SetListeners(this.selectorListeners);var s=new M3D.ReadListener;s.onReadEnd=function(e){var t=e.GetModel();n.view.ReadModel(t),n.readEnd();var r=M3D.SimulationAnimationManager.Instance();r.view=n.view;var i=e.getAnimation();if(i){var o=i.indexOf("<");i=i.substr(o).replace(/&#xD;&#xA;/g,""),M3D.SimulationAnimationManager.Instance().ProcessXMLData(n.ParseXmlString(i))}n.RemoveReadListener(s)},this.AddReadListener(s);var o=new M3D.SvlxReader;o.SetView(this.view),o.readNextListener=this.readNextListener,o.readModelListener=this.readModelListener,o.SetListeners(this.readListeners
),o.option.readPMI=this.pmiOptions.usePMI,this.decryptoOptions.decryptoFile&&this.decryptoOptions.decryptoServer!==null?o.OpenUrl(i,this.svlxCallBack,this.decryptoOptions.decryptoServer):o.FillModelOnceTime(i,this.svlxCallBack)}else{var u=new XMLHttpRequest;u.overrideMimeType("text/plain"),u.open("GET",i,!0);var a=this;u.addEventListener("load",function(e){var t=e.target.response;t=t.replace(/(^\s*)|(\s*$)/g,""),t=JSON.parse(t);var n=t.zipFolder;t.reback!=0&&t.reback!="false"?a.OpenRemote(t.zipfilepath,!0):a.onAlert(t.errMsg),this.status===200?console.log("成功读取"):this.status===0},!1),u.addEventListener("error",function(e){},!1),u.send(null)}},SView.prototype.svlxCallBack=function(e){var t=new M3D.LoadingEvent;SView.canvas.readNextListener!=null&&(t.fileName=SView.canvas.readNextListener.currentFilesName),t.percent=e.loaded/e.total;for(var n=0,r=SView.canvas.readListeners;n<r.length;n++){var i=r[n];i.onReading(t)}},SView.prototype.OpenSvlxFunc=function(e,t,n){var r=this,i=new M3D.ReadListener;i.onReadEnd=function(s){var o=s.GetModel();r.modelSet.push(o);if(r.modelSet.length===e.length){for(var u=0;u<e.length;u++)r.allModels.AddSubModel(r.modelSet[u]);r.view.ReadModel(r.allModels),console.log("zsvl end time"+Date.now())}r.readEnd(),r.RemoveReadListener(i),t<e.length-1?n(e,t+1,n):r.openModelsEnd(r.view.GetModel())},r.AddReadListener(i);var s=new M3D.SvlxReader;s.SetView(r.view),s.readNextListener=r.readNextListener,s.readModelListener=r.readModelListener,s.SetListeners(r.readListeners),s.FillModelOnceTime(e[t],function(e){var t=new M3D.LoadingEvent;r.readNextListener!=null&&(t.fileName=r.readNextListener.currentFilesName),t.percent=e.loaded/e.total;for(var n=0,i=r.readListeners;n<i.length;n++){var s=i[n];s.onReading(t)}})},SView.prototype.RestoreSelectedModel=function(){var e=null,t=this.GetSelector(),n=t.GetAll();for(var r=0;r<n.length;r++){var i=n[r];i&&i.GetType()==M3D.ShapeType.SHAPE_MODEL&&(e=i),e&&e.ResetMovement()}},SView.prototype.DrawSelectRectangle=function(){function t(t){u.clearRect(0,0,i.width,i.height),e._endLocation=e.GetClientPnt(t).Clone();var n=e._endLocation.Sub(e._firstLocation);u.strokeStyle="red",u.setLineDash([12,5]),u.strokeRect(e._firstLocation.x,e._firstLocation.y,n.x,n.y)}function n(e){}function r(t){e._endLocation=e.GetClientPnt(t).Clone();if(e.isFrameSelect){var n=e._endLocation.Sub(e._firstLocation);n.x*n.x+n.y*n.y<450?(e.singleClickFlag=!0,e.singleClickFlag&&e.GetCommandManager().GetCurCommand()==null&&(e.SelectShape(e._endLocation.x,e._endLocation.y),e.isCanvace2Dsingle=!0)):(e.isCanvace2Dsingle=!1,e.FrameSelection(e._firstLocation,e._endLocation,1))}e.setIsFrameSelect(!1),i.style.visibility="hidden"}var e=this,i=document.getElementById("canvas2d");if(!i){i=document.createElement("canvas"),i.setAttribute("id","canvas2d"),i.style.zIndex="-1",i.style.position="absolute",i.style.width="100%",i.style.height="100%";var s=this.renderCanvas.parentElement;s.appendChild(i),i.addEventListener("mousemove",t.bind(this),!1);var o=window.hasOwnProperty("PointerEvent");o?(i.addEventListener("pointerup",r.bind(this),!1),i.addEventListener("pointerdown",n.bind(this),!1)):(i.addEventListener("mouseup",r.bind(this),!1),i.addEventListener("mousedown",n.bind(this),!1))}i.width=this.renderCanvas.width,i.height=this.renderCanvas.height,i.style.visibility="visible";var u=i.getContext("2d")},SView.prototype.FrameSelection=function(e,t,n){var r=this.view.FrameSelectShape(e,t,0,0,n);this.view.GetSelector().Add(r)},SView.prototype.UpdateSceneBox=function(){var e=this.view.GetSceneManager().GetSceneBox().Clear();this.view.GetSceneManager().GetSceneBox();var t=this.view.GetTouchHandler();t.SetRestoreCamera(!1),t.UpdateCamera(),t.SetRestoreCamera(!0)},SView.prototype.TranslateNote=function(e,t){var n=e.GetSceneNode(),r;n?r=n.GetWorldTransform().Clone():r=M3D.Matrix3x4.IDENTITY().Clone();var i=new M3D.Matrix3x4;i.MultiTranslate(t);var s=i.Multiply(r);n.SetPlcMatrix(s)},SView.prototype.Translate=function(e,t){var n=e.model,r=e.noteArray;M3D.ModelTransformHelper.TranslateModel(n,t);for(var i=0,s=r.length;i<s;i++){var o=r[i];this.TranslateNote(o,t)}},SView.prototype.getRenderCanvas=function(){return this.renderCanvas},SView.prototype.CreatePropertyNote=function(e,t,n,r){var i;return n==CreateType.HTML?i=M3D.NoteFactory.createPropertyTextNote(e,t,this.view.GetSceneManager(),!1,r):n==CreateType.Note&&(i=M3D.NoteFactory.createPropertyTextNote(e,t,this.view.GetSceneManager(),!0,r)),i&&this.GetNativeShapeManager().AddShape(i.GetID(),i),i},SView.prototype.GetModelsWithUserProperty=function(){return this.view.shapeProperties},SView.prototype.SetAxisNodeState=function(e){this.view.axisNode&&this.view.axisNode.SetVisible(e)},SView.prototype.unButtonBindAixs=function(){this.tranAxisDragger&&(this.view.draggerManager.UnBindDragger(this.tranAxisDragger),this.tranAxisDragger=null)},SView.prototype.buttonBindAixs=function(){this.tranAxisDragger&&(this.view.draggerManager.UnBindDragger(this.tranAxisDragger),this.tranAxisDragger=null);var e=this.view.GetModel(),t=this.GetSelector().Get();t&&(this.tranAxisDragger=this.view.draggerManager.BindDragger(t,1))},SView.prototype.unButtonBindRotation=function(){this.tranRotateDragger&&(this.view.draggerManager.UnBindDragger(this.tranRotateDragger),this.tranRotateDragger=null)},SView.prototype.buttonBindRotation=function(){this.tranRotateDragger&&(this.view.draggerManager.UnBindDragger(this.tranRotateDragger),this.tranRotateDragger=null);var e=this.view.GetModel(),t=this.GetSelector().Get();t&&(this.tranRotateDragger=this.view.draggerManager.BindDragger(t,2))},SView.prototype.buttonBindScale=function(){this.tranScaleDragger>0&&(this.view.draggerManager.UnBindDragger(this.tranScaleDragger),this.tranScaleDragger=0);var e=this.view.GetModel(),t=this.GetSelector().Get();t&&(this.tranScaleDragger=this.view.draggerManager.BindDragger(t,3))},SView.prototype.exitAnimation=function(){this.view.GetModel().ResetAlpha(),this.animationPlayer.Reset(),M3D.SimulationAnimationManager.Instance().pAnimationStepManager.GetCurrentProcessManager().CurProcessID=-1},SView.prototype.SetAixsCommandState=function(e){this._isAixsCommand=e,this.GetRotateCommandState()&&(this._isRotationCommand=!1,this.unButtonBindRotation()),e?this.buttonBindAixs():this.unButtonBindAixs()},SView.prototype.GetAixsCommandState=function(){return this._isAixsCommand},SView.prototype.SetRotationCommandState=function(e){this._isRotationCommand=e,this.GetAixsCommandState()&&(this._isAixsCommand=!1,this.unButtonBindAixs()),e?this.buttonBindRotation():this.unButtonBindRotation()},SView.prototype.GetRotateCommandState=function(){return this._isRotationCommand},SView.prototype.fillModelMaterial=function(e,t){e&&t&&M3D.MaterialReader.Instance().fillMaterial(this.view,e,t)},SView.prototype.setShadowState=function(e){M3D.Parameters.Instance().m_shadowMapEnabled=e},SView.prototype.getShadowState=function(){return M3D.Parameters.Instance().m_shadowMapEnabled},SView.prototype.setIBLFactor=function(e){e>=0&&e<=5&&(M3D.Parameters.Instance().IBLFactor[0]=e)},SView.prototype.SetSceneGamma=function(e){M3D.Parameters.Instance().m_gammaFactor=Number(e)},SView.prototype.SetAlpha=function(e){var t=this.GetSelector(),n=t.Get();if(n){var r=n.GetBodys();for(var i=0;i<r.length;i++){var s=r[i],o=s.GetFaces();for(var u=0;u<o.length;u++){var a=o[u];a.SetAlpha(e)}}}},SView.prototype.SetUserMaterial=function(e,t){var n=this.GetSelector(),r=n.Get();if(r){var i=r.GetBodys();for(var s=0;s<i.length;s++){var o=i[s],u=o.GetFaces();for(var a=0;a<u.length;a++){var f=u[a],l=f.GetMaterial();if(l&&l.GetMaterialType()===M3D.MaterialType.MaterialType_Pbr){var c=l;c.SetRougthnessFactor(e),c.SetMetalnessFactor(t)}}}}},SView.TOUCH_NORMAL=0,SView.TOUCH_ROTATE=1,SView.TOUCH_SELECT=5,SView.TOUCH_ZOOM=3,SView}();SView_1.SView=SView;var CreateType;(function(e){e[e.HTML=1]="HTML",e[e.Note=2]="Note"})(CreateType=SView_1.CreateType||(SView_1.CreateType={}))})(SView||(SView={}));var M3D;(function(e){var t=function(t){function n(e){var n=t.call(this,e)||this;return n.offset=0,n.dynamic=!1,n.bufferSize=0,n.bufferOffset=0,n.bufferType=0,n.webGLBuffer=null,n.cacheData=null,n}return __extends(n,t),n.prototype.SetSize=function(e,t){this.dynamic=t,this.bufferSize=e},n.prototype.SetData=function(e){},n.prototype.SetDataRange=function(e,t){return this.cacheData!==null&&e instanceof Int8Array&&this.cacheData.set(e,t),!0},n.prototype.SetOffset=function(e){this.bufferOffset=e},n.prototype.GetOffset=function(){return this.bufferOffset},n.prototype.Create=function(e,t){return this.bufferType=e,this.bufferSize=t,this.cacheData=new Float32Array(this.bufferSize),!0},n.prototype.Bind=function(){this.gl.bindBuffer(e.GL.ELEMENT_ARRAY_BUFFER,this.webGLBuffer)},n.prototype.UnBind=function(){this.gl.bindBuffer(e.GL.ELEMENT_ARRAY_BUFFER,null)},n.prototype.BufferType=function(){return this.bufferType},n.prototype.HasValue=function(){return this.webGLBuffer!==null},n.prototype.WriteBuffer=function(){this.webGLBuffer=this.gl.createBuffer(),this.Bind(),this.dynamic?this.gl.bufferData(e.GL.ELEMENT_ARRAY_BUFFER,this.cacheData,e.GL.DYNAMIC_DRAW):this.gl.bufferData(e.GL.ELEMENT_ARRAY_BUFFER,this.cacheData,e.GL.STATIC_DRAW),this.UnBind()},n.prototype.Init=function(){},n}(e.GPUObject);e.HardWareIndexBuffer=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n.viewPort=new e.Viewport,n.isAnimation=!1,n.origRotateCenter=new e.Vector3,n.rotateCenter=new e.Vector3,n.view=new e.Matrix3x4,n.projection=new e.Matrix4,n.projectionOffset=new e.Vector2,n.frustum=new e.Frustum,n.viewDirty=!0,n.projectionDirty=!0,n.frustumDirty=!0,n.orthographic=!0,n.nearClip=.001,n.farClip=1e4,n.fov=35,n.orthoSize=10,n.aspectRatio=1,n.zoom=1,n.lodBias=1,n.autoAspectRatio=!1,n.flipVertical=!1,n.focalLength=100,n.cameraMode=0,n.leftEyeMat=new e.Matrix3x4,n.rightEyeMat=new e.Matrix3x4,n.tempMatrix=new e.Matrix3x4,n.scene=null,n.viewPort.SetCamera(n),n}return __extends(n,t),n.prototype.SetCamera=function(e,t,n,r,i,s,o){this.SetPosition(e),this.SetRotation(t),this.SetZoom(n),this.SetOrthographic(r),this.SetNearClip(i),this.SetFarClip(s),this.SetFov(o)},n.prototype.Clone=function(e){var t=new n;return t.SetCamera(e.GetPosition(),e.GetRotation(),e.GetZoom(),e.GetOrthographic(),e.GetNearClip(),e.GetFarClip(),e.GetFov()),t},n.prototype.SetScale=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];typeof t[0]=="number"?t[0]>.001&&(this.zoom*=t[0]):t[0]instanceof e.Vector3&&(this.scale=t[0].Abs(),this.MarkDirty())},n.prototype.ReSet=function(){t.prototype.Reset.call(this),this.zoom=1,this.rotateCenter=this.origRotateCenter.Clone(),this.worldMatrix=e.Matrix3x4.IDENTITY().Clone()},n.prototype.Traverse=function(e){},n.prototype.ZoomView=function(e){e>.001&&(this.zoom*=e),this.projectionDirty=!0,this.frustumDirty=!0,this.viewDirty=!0,this.dirty=!0},n.prototype.GetOrthoSize=function(){return new e.Vector2(this.orthoSize*this.aspectRatio,this.orthoSize)},n.prototype.RotateAroundCenter=function(t,n){var r=t.Clone();switch(n){case e.SceneNode.TS_LOCAL:break;case e.SceneNode.TS_PARENT:break;case e.SceneNode.TS_WORLD:r=this.rotation.Multiply(t).MultiplyED(this.rotation.Inverse())}this.RotateAround(this.rotateCenter,r,n)},n.prototype.GetViewPort=function(){return this.viewPort},n.prototype.SetViewPort=function(t,n,r,i){var s=new e.IntRect(t,n,t+r,n+i);this.viewPort.SetRect(s),this.MarkDirty()},n.prototype.SetNearClip=function(t){this.nearClip=e.Max(t,e.MIN_NEARCLIP),this.frustumDirty=!0,this.projectionDirty=!0},n.prototype.SetFarClip=function(t){this.farClip=e.Max(t,e.MIN_NEARCLIP),this.frustumDirty=!0,this.projectionDirty=!0},n.prototype.SetFov=function(t){this.fov=e.Clamp(t,0,e.MAX_FOV),this.frustumDirty=!0,this.projectionDirty=!0},n.prototype.SetOrthoSize=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length===1)if(t[0]instanceof e.Vector2){var r=t[0];this.autoAspectRatio=!1,this.orthoSize=r.y,this.aspectRatio=r.x/r.y,this.frustumDirty=!0,this.projectionDirty=!0}else this.orthoSize=t[0],this.aspectRatio=1,this.frustumDirty=!0,this.projectionDirty=!0},n.prototype.SetAspectRatio=function(e){this.autoAspectRatio=!1,this.SetAspectRatioInternal(e)},n.prototype.SetAspectRatioInternal=function(e){this.aspectRatio=e,this.frustumDirty=!0,this.projectionDirty=!0},n.prototype.SetZoom=function(t){this.zoom=e.Max(t,e.EPSILON),this.viewDirty=!0,this.frustumDirty=!0,this.projectionDirty=!0},n.prototype.SetLodBias=function(e){},n.prototype.GetOrthographic=function(){return this.orthographic},n.prototype.SetOrthographic=function(e){this.orthographic=e,this.frustumDirty=!0,this.projectionDirty=!0},n.prototype.SetAutoAspectRatio=function(e){},n.prototype.SetProjectionOffset=function(e){},n.prototype.SetUseReflection=function(e){},n.prototype.GetFarClip=function(){return this.farClip},n.prototype.SetRotateCenter=function(e){this.rotateCenter=e},n.prototype.SetInitRotateCenter=function(e){this.origRotateCenter=e,this.rotateCenter=e},n.prototype.GetRotateCenter=function(){return this.rotateCenter},n.prototype.GetOrigRotateCenter=function(){return this.origRotateCenter},n.prototype.GetNearClip=function(){return this.orthographic?0:this.nearClip},n.prototype.GetHalfClip=function(){return(this.GetNearClip()+this.GetFarClip())/2},n.prototype.GetFov=function(){return this.fov},n.prototype.GetAspectRatio=function(){return this.aspectRatio},n.prototype.GetZoom=function(){return this.zoom},n.prototype.GetClipDis=function(){return this.GetFarClip()-this.GetNearClip()},n.prototype.IsOrthographic=function(){return this.orthographic},n.prototype.GetAutoAspectRatio=function(){return this.autoAspectRatio},n.prototype.GetFrustum=function(){if(this.frustumDirty){var e=this.GetEffectiveWorldTransform();this.orthographic?this.frustum.DefineOrtho(this.orthoSize,this.aspectRatio,this.zoom,this.GetNearClip(),this.farClip,e):this.frustum.Define(this.fov,this.aspectRatio,this.zoom,this.GetNearClip(),this.farClip,e),this.frustumDirty=!1}return this.frustum},n.prototype.GetProjection=function(){return this.projectionDirty&&(this.projection=this.GetProjection2(!0),this.projectionDirty=!1),this.projection},n.prototype.GetProjection2=function(t){var n=e.Matrix4.ZERO().Clone(),r=t;if(!this.orthographic){var i=this.GetNearClip(),s=1/Math.tan(this.fov*e.DEGTORAD*.5)*this.zoom,o=s/this.aspectRatio,u=void 0,a=void 0;r?(u=-(this.farClip+i)/(this.farClip-i),a=-2*this.farClip*i/(this.farClip-i)):(u=-this.farClip/(this.farClip-i),a=u*i),n.data[0]=o,n.data[2]=this.projectionOffset.x*2,n.data[5]=s,n.data[6]=this.projectionOffset.y*2,n.data[10]=u,n.data[11]=a,n.data[14]=-1}else{var s=1/(this.orthoSize*.5)*this.zoom,o=s/this.aspectRatio,u=void 0,a=void 0;r?(u=-2/this.farClip,a=-1):(u=-1/this.farClip,a=0),n.data[0]=o,n.data[3]=this.projectionOffset.x*2,n.data[5]=s,n.data[7]=this.projectionOffset.y*2,n.data[10]=u,n.data[11]=a,n.data[15]=1}return n},n.prototype.GetView=function(){if(this.viewDirty){this.view=this.GetEffectiveWorldTransform().Inverse(),this.viewDirty=!1;if(this.IsOrthographic()&&this.scene){var t=this.scene.GetSceneBox(),n=this.GetFrustum().planes[0];if(n.Distance(t.min)*n.Distance(t.max)<0){var r=this.GetPosition(),i=n.Project(t.Center()),s=r.Sub(t.Center()).Length(),o=this.GetView().ToMatrix3(),u=new e.Vector3(o.data[6],o.data[7],o.data[8]),a=new e.Plane(u,t.Center()),f=a.Distance(r);u.Normalize();var l=this,c=this.scene.GetDefaultFocusLength();this.SetNearClip(c*e.NEAR_CLIP_PLANE_FACTOR),this.SetFarClip(c*e.FAR_CLIP_PLANE_FACTOR);var h=r.Add(u.Multiply(c-f));this.isAnimation||l.SetWorldPosition(h)}}}return this.cameraMode==1?this.tempMatrix=this.leftEyeMat.Multiply(this.view):this.cameraMode==2?this.tempMatrix=this.rightEyeMat.Multiply(this.view):this.tempMatrix=this.view.Clone(),this.tempMatrix},n.prototype.GetFrustumSize=function(t,n){t.z=this.GetNearClip(),n.z=this.farClip;if(!this.orthographic){var r=Math.tan(this.fov*e.DEGTORAD*.5)/this.zoom;t.y=t.z*r,t.x=t.y*this.aspectRatio,n.y=n.z*r,n.x=n.y*this.aspectRatio}else{var r=this.orthoSize*.5/this.zoom;t.y=n.y=r,t.x=n.x=t.y*this.aspectRatio}this.flipVertical&&(t.y=-t.y,n.y=-n.y)},n.prototype.GetHalfViewSize=function(){return this.orthographic?this.orthoSize*.5/this.zoom:Math.tan(this.fov*e.DEGTORAD*.5)/this.zoom},n.prototype.GetEffectiveWorldTransform=function(){var t=new e.Matrix3x4(this.GetWorldPosition(),this.GetWorldRotation(),1);return t},n.prototype.GetScreenRay=function(t,n){var r=new e.Ray;if(!this.IsProjectionValid())return r.origin=this.GetWorldPosition(),r.direction=this.GetWorldDirection(),r;var i=this.GetProjection2(!1).Multiply(this.GetView()).Inverse();t=2*t-1,n=1-2*n;var s=new e.Vector3(t,n,0),o=new e.Vector3(t,n,1);return r.origin=i.Multiply(s),r.direction=i.Multiply(o).SubED(r.origin).NormalizedED(),r},n.prototype.WorldToScreenPoint=function(t){var n=this.GetView().Multiply(t),r=new e.Vector2;if(n.z<0){var i=this.GetProjection2(!1).Multiply(n);r.x=i.x,r.y=i.y}else r.x=-n.x>0?-1:1,r.y=-n.y>0?-1:1;return r.x=r.x/2+.5,r.y=1-(r.y/2+.5),r},n.prototype.ScreenToWorldPoint=function(e){var t=this.GetScreenRay(e.x,e.y);return t.origin.Add(t.direction.Multiply(e.z))},n.prototype.GetSceneManager=function(){return this.scene},n.prototype.GetDistance=function(e){return 0},n.prototype.GetDistanceSquared=function(e){return 0},n.prototype.IsProjectionValid=function(){return this.farClip>this.GetNearClip()},n.prototype.OnMarkedDirty=function(){this.frustumDirty=!0,this.viewDirty=!0,this.frustumDirty=!0},n.prototype.SetCameraMode=function(e){this.cameraMode=e},n.prototype.SetPupilDistance=function(t){this.leftEyeMat.SetTranslation(new e.Vector3(t,0,0)),this.rightEyeMat.SetTranslation(new e.Vector3(-t,0,0))},n.prototype.GetFitClip=function(){return this.GetWorldPosition().Sub(this.GetRotateCenter()).Length()-this.GetNearClip()},n.prototype.toString=function(){return'Position="'+this.GetPosition().toPlainString()+'"  Rotation="'+this.GetRotation().Tostring()+'" ZoomFactor="'+this.GetZoom()+'"  Orthographic="'+this.GetOrthographic()+'"  NearClip="'+this.GetNearClip()+'"  FarClip="'+this.GetFarClip()+'" FOV="'+this.GetFov()+'"'},n.prototype.SetSceneManager=function(e){this.scene=e},n.FRUSTUINTER=0,n.FRUSTUOUT=1,n.FRUSTUINER=2,n}(e.SceneNode);e.Camera=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(e){var n=t.call(this,e)||this;return n.offset=0,n.dynamic=!1,n.bufferSize=0,n.bufferOffset=0,n.bufferType=0,n.normalOffset=0,n.vertexOffset=0,n.textureCoordsOffset=0,n.centersOffset=0,n.webGLBuffer=null,n.cacheData=null,n}return __extends(n,t),n.prototype.SetSize=function(e,t){this.bufferSize=e,this.dynamic=t},n.prototype.SetData=function(e){},n.prototype.SetNormalOffset=function(e){this.normalOffset=e},n.prototype.GetNormalOffset=function(){return this.normalOffset},n.prototype.SetVertexOffset=function(e){this.vertexOffset=e},n.prototype.GetVertexOffset=function(){return this.vertexOffset},n.prototype.SetTextureCoordsOffset=function(e){this.textureCoordsOffset=e},n.prototype.GetTextureCoordsOffset=function(){return this.textureCoordsOffset},n.prototype.SetCentersCoordsOffset=function(e){this.centersOffset=e},n.prototype.GetCentersCoordsOffset=function(){return this.centersOffset},n.prototype.SetDataRange=function(e,t){return this.cacheData!==null&&e instanceof Float32Array&&this.cacheData.set(e,t),!0},n.prototype.SetOffset=function(e){this.bufferOffset=e},n.prototype.GetOffset=function(){return this.bufferOffset},n.prototype.Create=function(e,t){return e===void 0&&(e=0),t===void 0&&(t=0),this.bufferType=e,this.bufferSize=t,this.cacheData=new Float32Array(this.bufferSize),!0},n.prototype.Bind=function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.webGLBuffer)},n.prototype.UnBind=function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)},n.prototype.BufferType=function(){return this.bufferType},n.prototype.HasValue=function(){return this.webGLBuffer!==null},n.prototype.WriteBuffer=function(){this.webGLBuffer=this.gl.createBuffer(),this.Bind(),this.dynamic?this.gl.bufferData(e.GL.ARRAY_BUFFER,this.cacheData,e.GL.DYNAMIC_DRAW):this.gl.bufferData(e.GL.ARRAY_BUFFER,this.cacheData,e.GL.STATIC_DRAW),this.UnBind(),this.cacheData=null},n.prototype.Init=function(){},n}(e.GPUObject);e.HardWareVertexBuffer=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t!==null&&t.apply(this,arguments)||this;return n.color=new e.Color,n.position=new e.Vector4,n.spotDirection=new e.Vector3,n.ambient=new e.Color,n.diffuse=new e.Color,n.specular=new e.Color,n.lightModelAmbient=new e.Color,n}return __extends(n,t),n.prototype.InitProperties=function(){},n.prototype.TurnOn=function(){this.turnOn=!0},n.prototype.TurnOff=function(){this.turnOn=!1},n.prototype.ShowShape=function(){},n.prototype.HideShape=function(){},n.prototype.SetPerVertex=function(e){this.perVertex=e},n.prototype.SetColor=function(e){this.color=e},n.prototype.SetSpecularIntensity=function(e){this.intensity=e},n.prototype.SetBrightness=function(e){this.brightness=e},n.prototype.SetRange=function(e){this.range=e},n.prototype.SetFov=function(e){this.fov=e},n.prototype.SetAspectRatio=function(e){this.aspectRatio=e},n.prototype.GetLinearAttenuation=function(){return this.linearAttenuation},n.prototype.SetLinearAttenuation=function(e){this.linearAttenuation=e},n.prototype.GetAmbient=function(){return this.ambient},n.prototype.SetAmbient=function(e){this.ambient=e},n.prototype.GetConstantAttenuation=function(){return this.constantAttenuation},n.prototype.SetConstantAttenuation=function(e){this.constantAttenuation=e},n.prototype.GetDiffuse=function(){return this.diffuse},n.prototype.SetDiffuse=function(e){this.diffuse=e},n.prototype.GetLightModelAmbient=function(){return this.lightModelAmbient},n.prototype.SetLightModelAmbient=function(e){this.lightModelAmbient=e},n.prototype.GetQuadraticAttenuation=function(){return this.quadraticAttenuation},n.prototype.SetQuadraticAttenuation=function(e){this.quadraticAttenuation=e},n.prototype.GetSpecular=function(){return this.specular},n.prototype.SetSpecular=function(e){this.specular=e},n.prototype.GetSpotCosCutoff=function(){return this.spotCosCutoff},n.prototype.SetSpotCosCutoff=function(e){this.spotCosCutoff=e},n.prototype.GetSpotCutoff=function(){return this.spotCutoff},n.prototype.SetSpotCutoff=function(e){this.spotCutoff=e},n.prototype.GetSpotDirection=function(){return this.spotDirection},n.prototype.SetSpotDirection=function(e){this.spotDirection=e},n.prototype.GetSpotExponent=function(){return this.spotExponent},n.prototype.SetSpotExponent=function(e){this.spotExponent=e},n.prototype.GetPosition=function(){return this.position},n.prototype.SetPosition=function(e){this.position=e},n.prototype.GetPerVertex=function(){return this.perVertex},n.prototype.GetColor=function(){return this.color},n.prototype.GetSpecularIntensity=function(){return this.specularIntensity},n.prototype.GetBrightness=function(){return this.brightness},n.prototype.GetRange=function(){return this.range},n.prototype.GetFov=function(){return this.fov},n.prototype.GetAspectRatio=function(){return this.aspectRatio},n.prototype.LightState=function(){return this.turnOn},n}(e.Shape);e.Light=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n.planeList=[],n.drawBoxSize=new e.BoundingBox,n.isShowCappingPlane=!1,n}return __extends(n,t),n.prototype.GetType=function(){return e.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE},n.prototype.GetPlaneList=function(){return this.planeList},n.prototype.SetTransform=function(e){for(var t=0;t<this.planeList.length;t++){var n=this.planeList[t];n.SetTransform(e)}},n.prototype.FindVisiableObject=function(e){e&&(this.planeList.length>0?e.PrepareRenderSection(this):e.PrepareRenderSection(null))},n.prototype.AddPlane=function(t){var n=!0;if(!t)return!1;var r=new e.Color(.5,.5,0,.3),i=new e.Color(.7,.7,.7,1);for(var s=0;s<this.planeList.length;++s){var o=this.planeList[s];if(o.GetID()===t.GetID()){o.Copy(t);var u=t.GetEquation(),a=new e.Vector3(u[0],u[1],u[2]),f=new e.Plane(a,u[3]),l=this.drawBoxSize.Projected(f);return o.SetDrawPlane(l),o.SetFaceColor(r),o.SetEdgeColor(i),!1}}this.planeList.length>=3&&this.planeList.splice(0,1);var c=new e.SectionPlane;c.Copy(t);var h=t.GetEquation(),p=new e.Vector3(h[0],h[1],h[2]),d=new e.Plane(p,h[3]),v=this.drawBoxSize.Projected(d);return c.SetDrawPlane(v),c.SetFaceColor(r),c.SetEdgeColor(i),this.planeList.push(c),n},n.prototype.RemovePlane=function(e){var t=!1;for(var n=0;n<this.planeList.length;++n){var r=this.planeList[n];if(r.GetID()==e.GetID())return this.planeList.splice(n,1),!0}return t},n.prototype.ClearPlanes=function(){this.planeList.length=0},n.prototype.SetDrawRection=function(e){this.drawBoxSize=e.Clone()},n.prototype.SetIsShowCappingPlane=function(e){this.isShowCappingPlane=e},n.prototype.IsShowCappingPlane=function(){return this.isShowCappingPlane},n}(e.Shape);e.Section=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];this.equation=[0,0,0,0],this.id=-1,this.glClipPlaneID=-1,this.origin=new e.Vector3,this.normal=new e.Vector3,this.uDir=new e.Vector3,this.vDir=new e.Vector3,this.name="",this.enable=!1,this.showPlaneRect=!1,this.showCutPlane=!1,this.width=-1,this.height=-1,this.points=[],this.normals=[],this.uvs=[],this.edgePoints=[],this.dirty=!0,this.center=new e.Vector3,this.size=new e.Vector2,this.box=new e.BoundingBox,this.edgeColor=new e.Color,this.faceColor=new e.Color,this.facePositionVBO=null,this.edgePositionVBO=null,this.gl=null,this.isNeedUpdateFace=!0,this.isNeedUpdateEdge=!0;switch(n.length){case 0:this.id=t.maxId++,this.glClipPlaneID=-1,this.enable=!1,this.edgeColor=e.Color.GRAY().Clone(),this.faceColor=e.Color.GREEN().Clone(),this.faceColor.a=.5,this.Init();break;case 4:this.id=t.maxId++,this.glClipPlaneID=-1,this.enable=!1,this.origin=n[0].Clone(),this.normal=n[1].Clone(),this.uDir=n[2].Clone(),this.vDir=n[3].Clone(),this.GetParam(),this.Init()}this.transformEquation=new Array}return t.prototype.GetID=function(){return this.id},t.prototype.SetID=function(e){this.id=e},t.prototype.GetEnable=function(){return this.enable},t.prototype.SetEnable=function(e){this.enable=e},t.prototype.SetShowPlaneRect=function(e){this.showPlaneRect=e},t.prototype.SetShowCutPlane=function(e){this.showCutPlane=e},t.prototype.SetName=function(e){this.name=e},t.prototype.SetPlaneParam=function(e,t,n,r){this.equation[0]=e,this.equation[1]=t,this.equation[2]=n,this.equation[3]=r},t.prototype.SetDrawPlane=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];switch(e.length){case 1:this.box=e[0].Clone(),this.dirty=!0,this.UpdateDrawData(),this.isNeedUpdateEdge=!0,this.isNeedUpdateFace=!0;break;case 2:this.center=e[0].Clone(),this.size=e[1].Clone(),this.dirty=!0}},t.prototype.Copy=function(e){e&&(this.equation[0]=e.equation[0],this.equation[1]=e.equation[1],this.equation[2]=e.equation[2],this.equation[3]=e.equation[3]+this.box.Length()/1e4,this.id=e.id,this.enable=e.GetEnable())},t.prototype.GetEquation=function(){return this.equation},t.prototype.GetPointArray=function(){return this.points},t.prototype.GetNormalArray=function(){return this.normals},t.prototype.GetLinePointArray=function(){return this.edgePoints},t.prototype.GetFaceColor=function(){return this.faceColor},t.prototype.GetEdgeColor=function(){return this.edgeColor},t.prototype.SetFaceColor=function(e){this.faceColor.copyFrom(e)},t.prototype.SetEdgeColor=function(e){this.edgeColor.copyFrom(e)},t.prototype.SetCurrentGLContext=function(e){this.gl=e},t.prototype.GetFacePositionVBO=function(){if(this.gl===null)return null;this.facePositionVBO===null&&(this.facePositionVBO=new e.HardWareVertexBuffer(this.gl));if(this.isNeedUpdateFace){var t=e.ArrayHelper.ConvertToFloat32Array(this.points);this.facePositionVBO.Create(0,t.length),this.facePositionVBO.SetDataRange(t,0),this.facePositionVBO.WriteBuffer(),this.isNeedUpdateFace=!1}return this.facePositionVBO},t.prototype.GetEdgePositionVBO=function(){if(this.gl===null)return null;this.edgePositionVBO===null&&(this.edgePositionVBO=new e.HardWareVertexBuffer(this.gl));if(this.isNeedUpdateEdge){var t=e.ArrayHelper.ConvertToFloat32Array(this.edgePoints);this.edgePositionVBO.Create(0,t.length),this.edgePositionVBO.SetDataRange(t,0),this.edgePositionVBO.WriteBuffer(),this.isNeedUpdateEdge=!1}return this.edgePositionVBO},t.prototype.Init=function(){},t.prototype.SetTransform=function(t){var n=new e.Plane(new e.Vector3(this.equation[0],this.equation[1],this.equation[2]),this.equation[3]);n.Transform(t);var r=n.normal.x,i=n.normal.y,s=n.normal.z,o=n.d;this.SetTransformPlaneParam(r,i,s,o),this.dirty=!0,this.UpdateDrawData()},t.prototype.GetParam=function(){var e=this.normal.x,t=this.normal.y,n=this.normal.z,r=-(e*this.origin.x+t*this.origin.y+n*this.origin.z);this.equation[0]=e,this.equation[1]=t,this.equation[2]=n,this.equation[3]=r},t.prototype.SetTransformPlaneParam=function(e,t,n,r){this.transformEquation[0]=e,this.transformEquation[1]=t,this.transformEquation[2]=n,this.transformEquation[3]=r},t.prototype.UpdateDrawData=function(){if(this.dirty){this.points.length=0,this.normals.length=0,this.uvs.length=0,this.edgePoints.length=0;var t=this.box.GetTriangleArray(),n=this.box.min.Clone(),r=this.box.max.Clone(),i=[];i[0]=n,i[1]=new e.Vector3(r.x,n.y,n.z),i[2]=new e.Vector3(n.x,r.y,n.z),i[3]=new e.Vector3(r.x,r.y,n.z),i[4]=new e.Vector3(n.x,n.y,r.z),i[5]=new e.Vector3(r.x,n.y,r.z),i[6]=new e.Vector3(n.x,r.y,r.z),i[7]=r,this.points.push(i[1]),this.points.push(i[0]),this.points.push(i[2]),this.points.push(i[0]),this.points.push(i[3]),this.points.push(i[2]),this.points.push(i[0]),this.points.push(i[4]),this.points.push(i[3]),this.points.push(i[0]),this.points.push(i[5]),this.points.push(i[4]),this.points.push(i[7]),this.points.push(i[4]),this.points.push(i[5]),this.points.push(i[5]),this.points.push(i[6]),this.points.push(i[7]),this.points.push(i[6]),this.points.push(i[1]),this.points.push(i[7]),this.points.push(i[1]),this.points.push(i[2]),this.points.push(i[7]),this.points.push(i[6]),this.points.push(i[0]),this.points.push(i[1]),this.points.push(i[6]),this.points.push(i[5]),this.points.push(i[0]),this.points.push(i[3]),this.points.push(i[7]),this.points.push(i[2]),this.points.push(i[3]),this.points.push(i[4]),this.points.push(i[7]),this.edgePoints.push(i[0]),this.edgePoints.push(i[1]),this.edgePoints.push(i[1]),this.edgePoints.push(i[3]),this.edgePoints.push(i[2]),this.edgePoints.push(i[3]),this.edgePoints.push(i[0]),this.edgePoints.push(i[2]),this.edgePoints.push(i[4]),this.edgePoints.push(i[5]),this.edgePoints.push(i[5]),this.edgePoints.push(i[7]),this.edgePoints.push(i[6]),this.edgePoints.push(i[7]),this.edgePoints.push(i[4]),this.edgePoints.push(i[6]),this.edgePoints.push(i[0]),this.edgePoints.push(i[4]),this.edgePoints.push(i[2]),this.edgePoints.push(i[6]),this.edgePoints.push(i[3]),this.edgePoints.push(i[7]),this.edgePoints.push(i[1]),this.edgePoints.push(i[5]),this.dirty=!1}},t.prototype.GetTransformPlaneParam=function(){return this.transformEquation},t.maxId=0,t}();e.SectionPlane=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var e=t.call(this)||this;return e.delay=50,e.instanceCount=0,e.currentReadInstanceCount=0,e}return __extends(n,t),n.prototype.ReadJSvl=function(t,n){function r(e){e.BeginRead(),e.SetReadPercent(.02),setTimeout(i,e.delay,e)}function i(e){e.asm=JSON.parse(e.text),setTimeout(s,e.delay,e),e.SetReadPercent(.12)}function s(e){e.map=e.parseBinary(e.mapObj),e.SetReadPercent(.22),setTimeout(o,e.delay,e)}function o(e){e.proto=e.asm.ProtoTypes.TopProto!==undefined?e.asm.ProtoTypes.TopProto:e.asm.ProtoTypes,e.proto!==undefined&&e.proto.ChildIns!==undefined&&e.GetInstanceCount(e.asm,e.proto),e.SetReadPercent(.25),setTimeout(u,e.delay,e)}function u(t){t.topModel=new e.Model,t.topModel.SetName(t.proto.Name),t.topModel.SetPlcId(0);if(t.proto.ChildIns!==undefined)t.SearchInstance(t.asm,t.map,t.proto,t.topModel,t);else{var n=void 0,r=new e.Matrix4,i=t.proto.Name;if(t.map.contains(i)){var s=t.map.get(i);if(s!=""){var o=!1;t.AddMesh(t.topModel,s[0],s[1],s[2],s[3],o)}else n=new e.Body,t.topModel.AddBody(n)}else n=new e.Body,t.topModel.AddBody(n);t.topModel.SetPlaceMatrix(r)}setTimeout(a,t.delay,t)}function a(e){e.SetReadPercent(.9),e.EndRead()}return this.text=t,this.mapObj=n,r(this),null},n.prototype.ReadFile=function(t){var n=new e.Model;return n},n.prototype.GetInstanceCount=function(e,t){var n=t.ChildIns;this.instanceCount++;for(var r=0;r<n.length;r++){var i="ChildIns"+(r+1),s=n[r][i],o=s.PointProtoName,u=e.ProtoTypes[o];u!==undefined&&u.ChildIns!==undefined&&this.GetInstanceCount(e,u)}},n.prototype.SearchInstance=function(e,t,n,r,i){i.SetReadPercent(.25+.65*i.currentReadInstanceCount++/
i.instanceCount);var s=n.ChildIns;for(var o=0;o<s.length;o++){var u="ChildIns"+(o+1),a=s[o][u],f=i.CreateInstance(t,a);r.AddSubModel(f);var l=a.PointProtoName,c=e.ProtoTypes[l];c!==undefined&&c.ChildIns!==undefined&&i.SearchInstance(e,t,c,f,i),f=null}},n.prototype.CreateInstance=function(t,n){var r=new e.Model,i,s,o=!1,u=new e.Matrix4,a=n.InsName;r.SetName(a),r.SetPlcId(n.PlcID),n.HasColor==1&&(o=n.Color),i=n.PlcMatrix,i===undefined?console.log("Warning: the ProtoType "+a+" have not PlacementMatrix!"):u=new e.Matrix4(i[0],i[1],i[2],i[3],i[4],i[5],i[6],i[7],i[8],i[9],i[10],i[11],i[12],i[13],i[14],i[15]);var f=n.PointProtoName;if(t.contains(f)){var l=t.get(f);l!=""?this.AddMesh(r,l[0],l[1],l[2],l[3],o):(s=new e.Body,r.AddBody(s))}else s=new e.Body,r.AddBody(s);return r.SetPlaceMatrix(u),r},n.prototype.AddMesh=function(t,n,r,i,s,o){var u,a;if(!n||n&&n.length<3){console.log("vertex array length is too short!");return}var f=new e.Color(.5,.5,.5,1),l=0;if(i&&i.length>2){var c=void 0;for(var h=0,p=i.length;h<p;h+=1){o!==!1?o[0]>-0.00001&&o[0]<1.00001?c=new e.Color(o[0],o[1],o[2],1-o[3]):s.length>h/3*4&&s[h/3*4]>-0.00001&&s[h/3*4]<1.00001&&(c=new e.Color(s[h/3*4],s[h/3*4+1],s[h/3*4+2],1-s[h/3*4+3])):s.length>h/3*4&&s[h/3*4]>-0.00001&&s[h/3*4]<1.00001&&(c=new e.Color(s[h/3*4],s[h/3*4+1],s[h/3*4+2],1-s[h/3*4+3])),c||(c=new e.Color(.5,.5,.5,1));if(h==0)f=c,l=h;else if(!c.Equals(f)||h==i.length-1){var d=h-l;h==i.length-1&&++d,u=new Float32Array(d*3),r&&(a=new Float32Array(d*3));for(var v=0;v<d;++v)u[v*3]=n[i[v+l]*3],u[v*3+1]=n[i[v+l]*3+1],u[v*3+2]=n[i[v+l]*3+2],a&&(a[v*3]=r[i[v+l]*3],a[v*3+1]=r[i[v+l]*3+1],a[v*3+2]=r[i[v+l]*3+2]);var m=[],g=void 0,y=new e.VertexSet;y.SetUseIndex(!1),y.SetPositionArray(u);var b=new e.Body;a&&u.length==a.length?y.SetNormalArray(a):y.computeVertexNormals(),b.SetVertexSet(y);var w=new e.Face;if(f){var E=this.coverColorToMaterial(f);E&&w.SetMaterial(E)}w.SetInitColor(f),b.AddFace(w);var S=new e.Mesh(y),x=y.GetPositionArray().length/3;S.SetDataOffset(0),S.SetDataLength(x),w.SetMesh(S),t.AddBody(b),f=c,l=h}}}else{var T=new e.Color(.5,.5,.5,1),N=0,c=void 0;for(var h=0;h<n.length;++h){o!==!1?o[0]>-0.00001&&o[0]<1.00001?c=new e.Color(o[0],o[1],o[2],1-o[3]):s.length>h/9*4&&s[h/9*4]>-0.00001&&s[h/9*4]<1.00001&&(c=new e.Color(s[h/9*4],s[h/9*4+1],s[h/9*4+2],1-s[h/9*4+3])):s.length>h/9*4&&s[h/9*4]>-0.00001&&s[h/9*4]<1.00001&&(c=new e.Color(s[h/9*4],s[h/9*4+1],s[h/9*4+2],1-s[h/9*4+3])),c||(c=new e.Color(.5,.5,.5,1));if(h==0)T=c,N=h;else if(!c.Equals(T)||h==i.length-1){var d=h-N;h==i.length-1&&++d,u=new Float32Array(d),r&&(a=new Float32Array(d));for(var v=0;v<d;++v)u[v]=n[v+N],a&&(a[v]=r[v+N]);var m=[],g=void 0,y=new e.VertexSet;y.SetUseIndex(!1),y.SetPositionArray(u);var b=new e.Body;a&&u.length==a.length?y.SetNormalArray(a):y.computeVertexNormals(),b.SetVertexSet(y);var w=new e.Face;if(T){var E=this.coverColorToMaterial(T);E&&w.SetMaterial(E)}w.SetRenderColor(T),b.AddFace(w);var S=new e.Mesh(y),x=y.GetPositionArray().length/3;S.SetDataOffset(0),S.SetDataLength(x),w.SetMesh(S),t.AddBody(b),T=c,N=h}}}},n.prototype.parseBinary=function(t){var n=t.length,r=new e.Dictionary;if(n>552){var i=new e.Dictionary,s=void 0,o=void 0,u=0,a=0;while(u<n){a=u+24;var f=t.charCodeAt(a),l=t.charCodeAt(a+1)<<8,c=t.charCodeAt(a+2)<<16,h=t.charCodeAt(a+3)<<24,p=f|l|c|h;u+=p+28;if(u>n)return console.log("RangeError: offset is outside the bounds of the DataView!"),console.log("Failed to read the prototype name!"),i;a+=16;var d=t.slice(a,a+512);s=this.getProtoName(d),a=u,a+=24,f=t.charCodeAt(a),l=t.charCodeAt(a+1)<<8,c=t.charCodeAt(a+2)<<16,h=t.charCodeAt(a+3)<<24;var v=f|l|c|h;u+=v+28;if(u>n)return console.log("RangeError: offset is outside the bounds of the DataView!"),console.log("Failed to read the prototype MeshDate!"),i;a+=16,f=t.charCodeAt(a),l=t.charCodeAt(a+1)<<8,c=t.charCodeAt(a+2)<<16,h=t.charCodeAt(a+3)<<24;var m=f|l|c|h;if(m!==0){var g=0;o=new Array(4);var y=new Array(m*3);a+=4;for(var b=0;b<m;b++){var w=a+b*12,E=new ArrayBuffer(4),S=new Int8Array(E);S[0]=t.charCodeAt(w+0),S[1]=t.charCodeAt(w+1),S[2]=t.charCodeAt(w+2),S[3]=t.charCodeAt(w+3);var x=new DataView(E);y[g]=x.getFloat32(0,!0),S[0]=t.charCodeAt(w+4),S[1]=t.charCodeAt(w+5),S[2]=t.charCodeAt(w+6),S[3]=t.charCodeAt(w+7),x=new DataView(E),y[g+1]=x.getFloat32(0,!0),S[0]=t.charCodeAt(w+8),S[1]=t.charCodeAt(w+9),S[2]=t.charCodeAt(w+10),S[3]=t.charCodeAt(w+11),x=new DataView(E),y[g+2]=x.getFloat32(0,!0),g+=3}o[0]=y,g=0,a+=m*12,a+=12,a+=4;var T=new Array(m*3);for(var N=0;N<m;N++){var C=a+N*12,k=void 0,L=new ArrayBuffer(4),A=new Int8Array(L);A[0]=t.charCodeAt(C+0),A[1]=t.charCodeAt(C+1),A[2]=t.charCodeAt(C+2),A[3]=t.charCodeAt(C+3),k=new DataView(L),T[g]=k.getFloat32(0,!0),A[0]=t.charCodeAt(C+4),A[1]=t.charCodeAt(C+5),A[2]=t.charCodeAt(C+6),A[3]=t.charCodeAt(C+7),k=new DataView(L),T[g+1]=k.getFloat32(0,!0),A[0]=t.charCodeAt(C+8),A[1]=t.charCodeAt(C+9),A[2]=t.charCodeAt(C+10),A[3]=t.charCodeAt(C+11),k=new DataView(L),T[g+2]=k.getFloat32(0,!0),g+=3}o[1]=T,a+=m*12,a+=12;var O=void 0,M=new ArrayBuffer(4),_=new Int8Array(M);_[0]=t.charCodeAt(a+0),_[1]=t.charCodeAt(a+1),_[2]=t.charCodeAt(a+2),_[3]=t.charCodeAt(a+3),O=new DataView(M);var D=O.getUint32(0,!0);a+=4;var P=new Array(D);for(var H=0;H<D;H++){var B=a+H*4;_[0]=t.charCodeAt(B+0),_[1]=t.charCodeAt(B+1),_[2]=t.charCodeAt(B+2),_[3]=t.charCodeAt(B+3),O=new DataView(M),P[H]=O.getUint32(0,!0)}o[2]=P,g=0,a+=D*4,a+=12,_[0]=t.charCodeAt(a+0),_[1]=t.charCodeAt(a+1),_[2]=t.charCodeAt(a+2),_[3]=t.charCodeAt(a+3),O=new DataView(M);var j=O.getUint32(0,!0);a+=4;var F=new Array(D/3*4);for(var I=0;I<j;I++){var q=a+I*16;_[0]=t.charCodeAt(q+0),_[1]=t.charCodeAt(q+1),_[2]=t.charCodeAt(q+2),_[3]=t.charCodeAt(q+3),O=new DataView(M),F[g]=O.getFloat32(0,!0),_[0]=t.charCodeAt(q+4),_[1]=t.charCodeAt(q+5),_[2]=t.charCodeAt(q+6),_[3]=t.charCodeAt(q+7),O=new DataView(M),F[g+1]=O.getFloat32(0,!0),_[0]=t.charCodeAt(q+8),_[1]=t.charCodeAt(q+9),_[2]=t.charCodeAt(q+10),_[3]=t.charCodeAt(q+11),O=new DataView(M),F[g+2]=O.getFloat32(0,!0),_[0]=t.charCodeAt(q+12),_[1]=t.charCodeAt(q+13),_[2]=t.charCodeAt(q+14),_[3]=t.charCodeAt(q+15),O=new DataView(M),F[g+3]=O.getFloat32(0,!0),g+=4}o[3]=F}else o="";i.getOrAdd(s,o)}return o=null,i}return console.log("Warning: Not Find MeshData!!!"),""},n.prototype.getProtoName=function(e){var t="",n=String.fromCharCode(0);for(var r=0;r<e.length;r+=2){var i=String.fromCharCode(e.charCodeAt(r)|e.charCodeAt(r+1)<<8);if(i===n)break;t+=i}return t},n}(e.Reader);e.JSvlReader=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var e=t.call(this)||this;return e.lastName="",e.regexp={vertex_pattern:/^v\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,normal_pattern:/^vn\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,uv_pattern:/^vt\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,face_vertex:/^f\s+(-?\d+)\s+(-?\d+)\s+(-?\d+)(?:\s+(-?\d+))?/,face_vertex_uv:/^f\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+))?/,face_vertex_uv_normal:/^f\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+)\/(-?\d+))?/,face_vertex_normal:/^f\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)(?:\s+(-?\d+)\/\/(-?\d+))?/,object_pattern:/^[og]\s*(.+)?/,smoothing_pattern:/^s\s+(\d+|on|off)/,material_library_pattern:/^mtllib /,material_use_pattern:/^usemtl /},e.delay=50,e}return __extends(n,t),n.prototype._createParserState=function(){var e={objects:[],object:{smooth:!0,startMaterial:function(e,t){},currentMaterial:function(){return undefined}},vertices:[],normals:[],uvs:[],materialLibraries:[],startObject:function(e,t){if(this.object&&this.object.fromDeclaration===!1){this.object.name=e,this.object.fromDeclaration=t!==!1;return}this.object&&typeof this.object._finalize=="function"&&this.object._finalize();var n=this.object&&typeof this.object.currentMaterial=="function"?this.object.currentMaterial():undefined;this.object={name:e||"",fromDeclaration:t!==!1,geometry:{vertices:[],normals:[],uvs:[]},materials:[],smooth:!0,startMaterial:function(e,t){var n=this._finalize(!1);n&&(n.inherited||n.groupCount<=0)&&this.materials.splice(n.index,1);var r={index:this.materials.length,name:e||"",mtllib:Array.isArray(t)&&t.length>0?t[t.length-1]:"",smooth:n!==undefined?n.smooth:this.smooth,groupStart:n!==undefined?n.groupEnd:0,groupEnd:-1,groupCount:-1,inherited:!1,clone:function(e){return{index:typeof e=="number"?e:this.index,name:this.name,mtllib:this.mtllib,smooth:this.smooth,groupStart:this.groupEnd,groupEnd:-1,groupCount:-1,inherited:!1}}};return this.materials.push(r),r},currentMaterial:function(){return this.materials.length>0?this.materials[this.materials.length-1]:undefined},_finalize:function(e){var t=this.currentMaterial();return t&&t.groupEnd===-1&&(t.groupEnd=this.geometry.vertices.length/3,t.groupCount=t.groupEnd-t.groupStart,t.inherited=!1),e!==!1&&this.materials.length===0&&this.materials.push({name:"",smooth:this.smooth}),t}};if(n&&n.name&&typeof n.clone=="function"){var r=n.clone(0);r.inherited=!0,this.object.materials.push(r)}this.objects.push(this.object)},finalize:function(){this.object&&typeof this.object._finalize=="function"&&this.object._finalize()},parseVertexIndex:function(e,t){var n=parseInt(e,10);return(n>=0?n-1:n+t/3)*3},parseNormalIndex:function(e,t){var n=parseInt(e,10);return(n>=0?n-1:n+t/3)*3},parseUVIndex:function(e,t){var n=parseInt(e,10);return(n>=0?n-1:n+t/2)*2},addVertex:function(e,t,n){var r=this.vertices,i=this.object.geometry.vertices;i.push(r[e+0]),i.push(r[e+1]),i.push(r[e+2]),i.push(r[t+0]),i.push(r[t+1]),i.push(r[t+2]),i.push(r[n+0]),i.push(r[n+1]),i.push(r[n+2])},addVertexLine:function(e){var t=this.vertices,n=this.object.geometry.vertices;n.push(t[e+0]),n.push(t[e+1]),n.push(t[e+2])},addNormal:function(e,t,n){var r=this.normals,i=this.object.geometry.normals;i.push(r[e+0]),i.push(r[e+1]),i.push(r[e+2]),i.push(r[t+0]),i.push(r[t+1]),i.push(r[t+2]),i.push(r[n+0]),i.push(r[n+1]),i.push(r[n+2])},addUV:function(e,t,n){var r=this.uvs,i=this.object.geometry.uvs;i.push(r[e+0]),i.push(r[e+1]),i.push(r[t+0]),i.push(r[t+1]),i.push(r[n+0]),i.push(r[n+1])},addUVLine:function(e){var t=this.uvs,n=this.object.geometry.uvs;n.push(t[e+0]),n.push(t[e+1])},addFace:function(e,t,n,r,i,s,o,u,a,f,l,c){var h=this.vertices.length,p=this.parseVertexIndex(e,h),d=this.parseVertexIndex(t,h),v=this.parseVertexIndex(n,h),m;r===undefined?this.addVertex(p,d,v):(m=this.parseVertexIndex(r,h),this.addVertex(p,d,m),this.addVertex(d,v,m));if(i!==undefined){var g=this.uvs.length;p=this.parseUVIndex(i,g),d=this.parseUVIndex(s,g),v=this.parseUVIndex(o,g),r===undefined?this.addUV(p,d,v):(m=this.parseUVIndex(u,g),this.addUV(p,d,m),this.addUV(d,v,m))}if(a!==undefined){var y=this.normals.length;p=this.parseNormalIndex(a,y),d=a===f?p:this.parseNormalIndex(f,y),v=a===l?p:this.parseNormalIndex(l,y),r===undefined?this.addNormal(p,d,v):(m=this.parseNormalIndex(c,y),this.addNormal(p,d,m),this.addNormal(d,v,m))}},addLineGeometry:function(e,t){this.object.geometry.type="Line";var n=this.vertices.length,r=this.uvs.length;for(var i=0,s=e.length;i<s;i++)this.addVertexLine(this.parseVertexIndex(e[i],n));for(var o=0,s=t.length;o<s;o++)this.addUVLine(this.parseUVIndex(t[o],r))}};return e.startObject("",!1),e},n.prototype.parse=function(t){function f(){this.BeginRead(),this.SetReadPercent(.02),setTimeout(l.bind(this),this.delay,this)}function l(){var e="";for(var t=0,f=r.length;t<f;t++){i=r[t],i=i.trim(),u=i.length;if(u===0)continue;s=i.charAt(0);if(s==="#")continue;if(s==="v"){o=i.charAt(1);if(o===" "&&(a=this.regexp.vertex_pattern.exec(i))!==null)n.vertices.push(parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3]));else if(o==="n"&&(a=this.regexp.normal_pattern.exec(i))!==null)n.normals.push(parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3]));else{if(o!=="t"||(a=this.regexp.uv_pattern.exec(i))===null)throw new Error("Unexpected vertex/normal/uv line: '"+i+"'");n.uvs.push(parseFloat(a[1]),parseFloat(a[2]))}}else if(s==="f")if((a=this.regexp.face_vertex_uv_normal.exec(i))!==null)n.addFace(a[1],a[4],a[7],a[10],a[2],a[5],a[8],a[11],a[3],a[6],a[9],a[12]);else if((a=this.regexp.face_vertex_uv.exec(i))!==null)n.addFace(a[1],a[3],a[5],a[7],a[2],a[4],a[6],a[8],undefined,undefined,undefined,undefined);else if((a=this.regexp.face_vertex_normal.exec(i))!==null)n.addFace(a[1],a[3],a[5],a[7],undefined,undefined,undefined,undefined,a[2],a[4],a[6],a[8]);else{if((a=this.regexp.face_vertex.exec(i))===null)throw new Error("Unexpected face line: '"+i+"'");n.addFace(a[1],a[2],a[3],a[4],undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined)}else if(s==="l"){var l=i.substring(1).trim().split(" "),h=[],p=[];if(i.indexOf("/")===-1)h=l;else for(var d=0,v=l.length;d<v;d++){var m=l[d].split("/");m[0]!==""&&h.push(m[0]),m[1]!==""&&p.push(m[1])}n.addLineGeometry(h,p)}else if((a=this.regexp.object_pattern.exec(i))!==null){var g=a[0].substr(1).trim();e=g}else if(this.regexp.material_use_pattern.test(i)){if((a=this.regexp.material_use_pattern.exec(i))!==null){var y=a[0].substr(1).trim();n.startObject(e,undefined)}n.object.startMaterial(i.substring(7).trim(),n.materialLibraries)}else if(this.regexp.material_library_pattern.test(i))n.materialLibraries.push(i.substring(7).trim());else{if((a=this.regexp.smoothing_pattern.exec(i))===null){if(i==="\0")continue;throw new Error("Unexpected line: '"+i+"'")}var b=a[1].trim().toLowerCase();n.object.smooth=b==="1"||b==="on";var w=n.object.currentMaterial();w&&(w.smooth=n.object.smooth)}}setTimeout(c.bind(this),this.delay,this),this.SetReadPercent(.22)}function c(){n.finalize(),this.topModel.SetID(1),this.topModel.SetPlcId(0);for(var t=0,r=n.objects.length;t<r;t++){var i=new e.Model,s=new e.VertexSet,o=n.objects[t],u=o.geometry,a=o.materials,f=u.type==="Line",l=new Float32Array(u.vertices.length),c=void 0,p=void 0;if(u.vertices.length===0)continue;for(var d=0;d<u.vertices.length;d++)l[d]=u.vertices[d];if(u.normals.length>0){c=new Float32Array(u.normals.length);for(var d=0;d<u.normals.length;d++)c[d]=u.normals[d]}else s.computeVertexNormals();if(u.uvs.length>0){p=new Float32Array(u.uvs.length);for(var d=0;d<u.uvs.length;d++)d%2===0?p[d]=u.uvs[d]:p[d]=1-u.uvs[d]}else{p=new Float32Array(u.vertices.length/3*2);for(var d=0;d<p.length;d++)p[d]=-1}var v=void 0;if(a.length>0){var m=a[0].mtllib;if(m){if(m.charAt(0)!=="."||m.charAt(1)!=="\\"&&m.charAt(1)!=="/"){if(m.charAt(0)==="\\"||m.charAt(0)==="/")m=m.substr(1)}else m=m.substr(2);v=this.GetResourceManager().GetOrCreateMaterial(a[0].name,e.MaterialType.MaterialType_Phong,m)}}s.SetPositionArray(l),c!=null&&c.length==l.length?s.SetNormalArray(c):s.computeVertexNormals(),s.SetUVArray(p);var g=new e.Body;g.SetVertexSet(s);var y=new e.ModelShape;y.AddBody(g),i.SetModelShape(y),i.AddBody(g);var b=new e.Face;if(v)b.SetMaterial(v),b.SetInitColor(v.GetDiffuse());else{var w=this.coverColorToMaterial(e.Color.GRAY().Clone());w&&(b.SetMaterial(w),b.SetInitColor(e.Color.GRAY().Clone()))}g.AddFace(b);var E=new e.Mesh(s),S=s.GetPositionArray().length/3;E.SetDataOffset(0),E.SetDataLength(S),b.SetMesh(E),i.SetName(o.name),b.SetName(o.name),i.SetPlcId(0),this.topModel.AddSubModel(i)}this.SetReadPercent(.62),setTimeout(h.bind(this),this.delay,this)}function h(){this.SetReadPercent(.9),this.EndRead()}console.time("OBJLoader");var n=this._createParserState();t.indexOf("\\\r\n")!==-1&&(t=t.replace(/\\\r\n/g,"")),t.indexOf("\r\n")!==-1&&(t=t.replace("\r\n","\n"));var r=t.split("\n"),i="",s="",o="",u=0,a=[];return f.bind(this)(),this.topModel=new e.Model,null},n.prototype.ReadFile=function(e){return this.parse(e)},n.prototype.GetModel=function(){return this.topModel},n}(e.Reader);e.ObjReader=t})(M3D||(M3D={}));var M3D;(function(e){e.HEADER_SIZE=84;var t=function(t){function n(){var e=t.call(this)||this;return e.delay=50,e}return __extends(n,t),n.prototype.ReadFile=function(e){var t=this.ensureBinary(e);return this.isBinary(t)?this.parseBinary(t):this.parseASCII(this.ensureString(e))},n.prototype.GetModel=function(){return this.topModel},n.prototype.parseBinary=function(t){function p(){this.BeginRead(),this.SetReadPercent(.02),setTimeout(d.bind(this),this.delay,this)}function d(){for(var e=0;e<70;e++)n.getUint32(e,false)==1129270351&&n.getUint8(e+4)==82&&n.getUint8(e+5)==61&&(u=!0,a=new Float32Array(r*3*3),f=n.getUint8(e+6)/255,l=n.getUint8(e+7)/255,c=n.getUint8(e+8)/255,h=n.getUint8(e+9)/255);setTimeout(E.bind(this),this.delay,this),this.SetReadPercent(.42)}function E(){for(var e=0;e<r;e++){var t=v+e*m,a=n.getFloat32(t,!0),h=n.getFloat32(t+4,!0),p=n.getFloat32(t+8,!0);if(u){var d=n.getUint16(t+48,!0);(d&32768)===0?(i=(d&31)/31,s=(d>>5&31)/31,o=(d>>10&31)/31):(i=f,s=l,o=c)}for(var g=1;g<=3;g++){var E=t+g*12,x=n.getFloat32(E,!0),T=n.getFloat32(E+4,!0),N=n.getFloat32(E+8,!0);y[w+0]=x,y[w+1]=T,y[w+2]=N,b[w+0]=a,b[w+1]=h,b[w+2]=p,w+=3}}setTimeout(S.bind(this),this.delay,this),this.SetReadPercent(.62)}function S(){this.topModel=new e.Model;var t=new e.Body;g.SetPositionArray(y),g.SetNormalArray(b),t.SetVertexSet(g);var n=new e.Face,r=this.coverColorToMaterial(n.GetRenderColor());r&&n.SetMaterial(r),t.AddFace(n);var i=new e.Mesh(g),s=g.GetPositionArray().length/3;i.SetDataOffset(0),i.SetDataLength(s),n.SetMesh(i);var o=new e.ModelShape;o.AddBody(t),this.topModel.SetModelShape(o),this.topModel.AddBody(t),this.topModel.SetID(1),this.topModel.SetPlcId(0),setTimeout(x.bind(this),this.delay,this),this.SetReadPercent(.82)}function x(){this.SetReadPercent(.9),this.EndRead()}var n=new DataView(t),r=n.getUint32(80,!0),i,s,o,u=!1,a,f,l,c,h;p.bind(this)();var v=84,m=50,g=new e.VertexSet,y=new Float32Array(r*3*3),b=new Float32Array(r*3*3),w=0;return null},n.prototype.parseASCII=function(t){function d(){this.BeginRead(),this.SetReadPercent(.02),setTimeout(v.bind(this),this.delay,this)}function v(){while((a=s.exec(t))!==null){f=a[0],o=/normal[\s]+([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+/g;while((a=o.exec(f))!==null)h.push(parseFloat(a[1]),parseFloat(a[3]),parseFloat(a[5]));u=/vertex[\s]+([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+/g;while((a=u.exec(f))!==null)c.push(parseFloat(a[1]),parseFloat(a[3]),parseFloat(a[5]))}p=new Float32Array(c.length),setTimeout(m.bind(this),this.delay,this),this.SetReadPercent(.65)}function m(){for(var e=0;e<c.length;++e)p[e]=c[e];setTimeout(g.bind(this),this.delay,this),this.SetReadPercent(.72)}function g(){this.topModel=new e.Model;var t=new e.Body;l.SetPositionArray(p);if(c.length!=h.length)l.computeVertexNormals();else{var n=new Float32Array(h.length);for(var r=0;r<h.length;++r)n[r]=h[r];l.SetNormalArray(n)}t.SetVertexSet(l);var i=new e.Face,s=this.coverColorToMaterial(i.GetRenderColor());s&&i.SetMaterial(s),t.AddFace(i);var o=new e.Mesh(l),u=l.GetPositionArray().length/3;o.SetDataOffset(0),o.SetDataLength(u),i.SetMesh(o);var a=new e.ModelShape;a.AddBody(t),this.topModel.SetModelShape(a),this.topModel.AddBody(t),this.topModel.SetID(1),this.topModel.SetPlcId(0),setTimeout(y.bind(this),this.delay,this),this.SetReadPercent(.82)}function y(){this.SetReadPercent(.9),this.EndRead()}var n,r,i,s,o,u,a,f;s=/facet([\s\S]*?)endfacet/g;var l=new e.VertexSet;l.SetUseIndex(!1);var c=[],h=[],p;return d.bind(this)(),null},n.prototype.isBinary=function(e){var t,n,r,i;i=new DataView(e),n=50,r=i.getUint32(80,!0),t=84+r*n;if(t===i.byteLength)return!0;var s=i.byteLength;for(var o=0;o<s;o++)if(i.getUint8(o,!1)>127)return!0;return!1},n.prototype.ensureBinary=function(e){if(typeof e=="string"){var t=new Uint8Array(e.length);for(var n=0;n<e.length;n++)t[n]=e.charCodeAt(n)&255;return t.buffer||t}return e},n.prototype.ensureString=function(e){if(typeof e!="string"){var t=new Uint8Array(e),n="";for(var r=0;r<e.byteLength;r++)n+=String.fromCharCode(t[r]);return n}return e},n}(e.Reader);e.StlReader=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){return t.call(this)||this}return __extends(n,t),n.prototype.ReadFile=function(t){var n=new e.Model;return n},n.prototype.GetModel=function(){return new e.Model},n}(e.Reader);e.SvlReader=t})(M3D||(M3D={}));var M3D;(function(e){e.ROOT="M3D",e.MAINGROUP="M3D|MAIN",e.MAINMODELROOT="M3D|MAIN|PATH",e.MAINCAMERA="M3D|MAIN|CAMERA",e.MAINDIRTLIGHT="M3D|MAIN|DIRLIGHT",e.MAINPOTLIGHT="M3D|MAIN|POTLIGHT",e.MAINPOINTIGHT="M3D|MAIN|POINTLIGHT",e.AXIS="M3D|AIXS",e.FPS_FLAG="M3D|FPS",e.BACKGROUNDCOLOR="M3D|BACKGROUNDCOLOR",e.SCENEGROUND="M3D|SCENEGROUND",e.HANDLER_GROUPNODE="M3D|MAIN|HANDLER_GROUP",e.SECTION_GROUP_PATH="M3D|MAIN|SECTIONGROUPNODE",e.NOTE_GROUP_PATH="M3D|MAIN|NOTEGROUPNODE",e.MEASURE_GROUP_PATH="M3D|MAIN|MEASUREGROUPNODE",e.LIGHT_GROUP_PATH="M3D|MAIN|LIGHTGROUPNODE",e.CAMERA_GROUP_PATH="M3D|MAIN|CAMERAGOUPNODE",e.TRANSFORHANDLER_NODE="M3D|MAIN|TRANSFORHANDLER_NODE",e.ROTATECENTERNODE="M3D|MAIN|ROTATECENTERNODE",e.AXISHANDLENODE="M3D|MAIN|AXISHANDLENODE",e.PLANHANDLENODE="M3D|MAIN|PLANHANDLENODE",e.X_TRAN_HANDLER="X_TRAN_HANDLER",e.Y_TRAN_HANDLER="Y_TRAN_HANDLER",e.Z_TRAN_HANDLER="Z_TRAN_HANDLER",e.X_ROTATE_HANDLER="X_ROTATE_HANDLER",e.Y_ROTATE_HANDLER="Y_ROTATE_HANDLER",e.Z_ROTATE_HANDLER="Z_ROTATE_HANDLER",e.X_SCALE_HANDLER="X_SCALE_HANDLER",e.Y_SCALE_HANDLER="Y_SCALE_HANDLER",e.Z_SCALE_HANDLER="Z_SCALE_HANDLER",e.SCENE_NODE=0,e.LSCENE_NODE=2,e.LSHAPE_NODE=3,e.CAMERA_NODE_BEGIN=10,e.CAMERA_NODE=11,e.CAMERA_NODE_END=19,e.SHAPE_NODE_BEGIN=30,e.SHAPE_NODE=31,e.SHAPE_NODE_END=39,e.GROUP_NODE_BEGIN=40,e.GROUP_NODE=41,e.MODEL_NODE=42,e.GROUP_NODE_END=49,e.AND_NODE=51,e.SUB_NODE=61,e.HANDLER_NODE_BEGIN=70,e.HANDLER_NODE=71,e.HANDLER_NODE_VOICEANNOTATION=72,e.HANDLER_NODE_TEXTaNNOTATION=73,e.HANDLER_NODE_POINT=74,e.HANDLER_GROUP_NODE=75,e.HANDLER_NODE_ROTATECENTER=76,e.HANDLER_NODE_PLAN=77,e.NOTE_GROUP_NODE=78,e.MEASURE_GROUP_NODE=79,e.LIGHT_GROUP_NODE=80,e.CAMERA_GROUP_NODE=81,e.HANDLER_NODE_END=99,e.GRAPHICAL_MODEL=100,e.GRAPHICAL_PMI=101,e.HANDLER_SHAPE_BEGIN=150,e.HANDLER_SHAPE=e.HANDLER_SHAPE_BEGIN+1,e.HANDLER_ANNOTATION_VOICE=e.HANDLER_SHAPE_BEGIN+2,e.HANDLER_ANNOTATION_TEXT=e.HANDLER_SHAPE_BEGIN+3,e.HANDLER_ROTATECENTER=e.HANDLER_SHAPE_BEGIN+4,e.HANDLER_POINT=e.HANDLER_SHAPE_BEGIN+5,e.HANDLER_SHAPE_END=199,e.EXTERN_NODE_BEGIN=200,e.AXIS_NODE=201,e.BACKGROUNDCOLOR_NODE=202,e.SECTION_NODE=203,e.FPS_NODE=204,e.TEXT_NODE=205,e.INTERACTIVEINFO_NODE=206,e.SCENEGROUND_NODE=207,e.EXTERN_NODE_END=300,e.PICKTYPE_BASE=1e3,e.PICKTYPE_MODEL=1001,e.PICKTYPE_PMI=1002,e.PICKTYPE_NOTE=1003,e.PICKTYPE_FACE=1004,e.PICKTYPE_LINE=1005,e.PICKTYPE_POINT=1006,e.PICKTYPE_OTHER=1007,e.NOTE_NODE=2e3,e.PERSPECTIVE=1,e.ORTHO=2,e.NEAR_CLIP_PLANE_FACTOR=.001,e.FAR_CLIP_PLANE_FACTOR=10.5,e.NEAR_CLIP_PLANE_VALUE=.01,e.CAMERA_POSFACTOR=.8,e.DEFAULT_MATERIAL="m3d_default_material",e.DEFAULT_TEXTURE_PATH="images/default.png",e.BOTTOCOLOR_KEY="bottomColorKey",e.TOP_COLOR_KEY="topColorKey",e.ROTATE="rotate",e.MERGEFACE="mergeface",e.CATIA="catia",e.HIGHPERFORMANCE="highPerformance",e.USELOD="lod",e.USEPMI="pim",e.ROAMAUTOMATIC="roamAutomatic",e.LOOPPLAYBACK="loopPlayback",e.REMOVESMALLTHING="removeSmallThing",e.REMOVESMALLSIZE="removeSmallSize",e.MEASUREUNIT="measureUnit",e.LANGUAHEMACRO="languageType",e.SELECTTYPE="selectType",e.EDGECOLOR="selectedColor"})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.ERROR=-1]="ERROR",e[e.SUCCESS=0]="SUCCESS",e[e.SUCCESS_EXIST=1001]="SUCCESS_EXIST",e[e.LIC_ERROR=100]="LIC_ERROR",e[e.Read_OK=200]="Read_OK",e[e.Read_CANCEL=201]="Read_CANCEL",e[e.Read_NO_DEFINE_Error=202]="Read_NO_DEFINE_Error",e[e.Read_IO_ERROR=203]="Read_IO_ERROR",e[e.Read_OOM=204]="Read_OOM",e[e.Read_ANALYSIS_ERROR=205]="Read_ANALYSIS_ERROR"})(t=e.M3D_STATUS||(e.M3D_STATUS={}))})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var r=[];for(var i=0;i<arguments.length;i++)r[i]=arguments[i];var s=t.call(this)||this;s.vertexSet=null,s.faces=[],s.edges=[],s.model=null,s.polyLine=null,s.m_isDrawDataDirty=!0,s.origVisible=!1,s.dirty=!0,s.hardWareVertexBuffer=null;if(r.length===0)s.SetType(e.ShapeType.SHAPE_BODY);else if(r.length===1&&r[0]instanceof n){var o=r[0];s.AssignOperator(o)}return s.MarkDrawDataDirty(),s}return __extends(n,t),n.prototype.AssignOperator=function(n){if(this!==n){t.prototype.AssignOperator.call(this,n),this.SetModel(null),this.SetType(e.ShapeType.SHAPE_BODY),this.faces=[],this.polyLine=n.polyLine;for(var r=0;r<n.faces.length;r++){var i=new e.Face;i.AssignOperator(n.faces[r]),this.AddFace(i)}for(var s=0;s<n.edges.length;s++){var o=new e.Edge;o.AssignOperator(n.edges[s]),this.AddEdge(o)}this.MarkDrawDataDirty()}},n.prototype.MarkDrawDataDirty=function(){this.m_isDrawDataDirty=!0},n.prototype.FindVisiableObject=function(t){if(!this.IsVisible())return;t.StartMergeFace(),t.StartMergeEdge();var n=t.GetRenderEffect(),r=n.GetRenderableTypeFilter();if(r.Contain(e.RenderableType.RGT_SOLID)){if(this.m_isDrawDataDirty)for(var i=0;i<this.faces.length;i++)this.faces[i].FindVisiableObject(t);for(var i=0;i<this.faces.length;i++){var s=this.faces[i];s.GetRenderMeshData()&&(t.AddFaceToDrawQueue(s),r.Contain(e.RenderableType.RGT_TRILINE)&&t.FacePrepareLineMesh(s))}}if(r.Contain(e.RenderableType.RGT_EDGELINE)){var o=this.edges;for(var i=0;i<o.length;i++){var u=o[i];t.PrepareRenderEdges(u)}}this.m_isDrawDataDirty=!1,this.UpdateHardWareBuffer(t),t.FinishMergeFace()},n.prototype.SetVertexSet=function(e){this.vertexSet=e,this.MarkDrawDataDirty()},n.prototype.GetVertexSet=function(){return this.vertexSet},n.prototype.SetBodyExtInfo=function(){for(var e=0;e<this.faces.length;e++)this.faces[e].SetFaceExtInfo()},n.prototype.GetVertexCount=function(e){var t=0;for(var n=0;n<this.faces.length;n++)t+=this.faces[n].GetVertexCount(e);return t},n.prototype.RayPick=function(e){if(!this.IsVisible()||!e.CanPickShape(this.GetType())||!this.selectAble)return;if(e.Intersect(this.GetBoundingBox()))for(var t=0;t<this.faces.length;t++)this.faces[t].RayPick(e);if(this.edges)for(var t=0;t<this.edges.length;t++)this.edges[t].RayPick(e)},n.prototype.SetModel=function(e){this.model=e},n.prototype.GetModel=function(){return this.model},n.prototype.SetSelected=function(e){t.prototype.SetSelected.call(this,e);for(var n=0;n<this.faces.length;n++)this.faces[n].SetSelected(e);for(var n=0;n<this.edges.length;n++)this.edges[n].SetSelected(e);this.MarkDrawDataDirty()},n.prototype.SetVisible=function(e){t.prototype.SetVisible.call(this,e);for(var n=0;n<this.faces.length;n++)this.faces[n].SetVisible(e);this.MarkDrawDataDirty()},n.prototype.SetSelectAble=function(e){t.prototype.SetSelectAble.call(this,e);for(var n=0;n<this.faces.length;n++)this.faces[n].SetSelectAble(e);for(var n=0;n<this.edges.length;n++)this.edges[n].SetSelectAble(e)},n.prototype.AddFace=function(e){e!==null&&(e.SetBody(this),this.faces.push(e)),this.MarkDrawDataDirty()},n.prototype.AddEdge=function(e){e!==null&&(e.SetBody(this),this.edges.push(e)),this.MarkDrawDataDirty()},n.prototype.GetEdges=function(){return this.edges},n.prototype.ComputeBox=function(){this.BoundingBox.Clear();for(var e=0;e<this.faces.length;e++){var t=this.faces[e];t.GetBoundingBox().Defined()&&this.BoundingBox.Merge(t.GetBoundingBox())}},n.prototype.SetInitColor=function(e){for(var t=0;t<this.faces.length;t++)this.faces[t].SetInitColor(e);this.MarkDrawDataDirty()},n.prototype.SetColor=function(e){for(var t=0;t<this.faces.length;t++)this.faces[t].SetColor(e);this.MarkDrawDataDirty()},n.prototype.ResetColor=function(){for(var e=0;e<this.faces.length;e++)this.faces[e].ResetColor();this.MarkDrawDataDirty()},n.prototype.SetAlpha=function(e){this.Color.a=e;for(var t=0;t<this.faces.length;t++)this.faces[t].SetAlpha(e);this.MarkDrawDataDirty()},n.prototype.ResetAlpha=function(){for(var e=0;e<this.faces.length;e++)this.faces[e].ResetAlpha();this.MarkDrawDataDirty()},n.prototype.SetOrigVisible=function(e){this.origVisible=e,this.SetVisible(e)},n.prototype.IsOrigVisible=function(){return this.origVisible},n.prototype.Restore=function(){for(var e=0;e<this.faces.length;e++)this.faces[e].Restore();this.ResetColor(),this.SetVisible(this.IsOrigVisible()),this.SetSelected(!1)},n.prototype.GetFaces=function(){return this.faces},n.prototype.FramePick=function(e){t.prototype.FramePick.call(this,e)},n.prototype.GetPolyLine=function(){return this.polyLine},n.prototype.SetPolyLine=function(e){this.polyLine=e},n.prototype.GetHardWareVertexBuffer=function(){return this.hardWareVertexBuffer},n.prototype.UpdateHardWareBuffer=function(e){if(this.polyLine){var t=this.polyLine.GetPoints();this.dirty&&(this.dirty=!1,this.hardWareVertexBuffer===null&&t.length>0&&this.createVertexBuffer(e))}},n.prototype.GetVolumeAndArea=function(e,t){return 0},n.prototype.SetInitHightlight=function(e){for(var t=0;t<this.faces.length;t++)this.faces[t].SetInitHightlight(e);this.MarkDrawDataDirty()},n.prototype.SetInitAlpha=function(e){for(var t=0;t<this.faces.length;t++)this.faces[t].SetInitAlpha(e);this.MarkDrawDataDirty()},n.prototype.GetPoints=function(){return[]},n.prototype.createVertexBuffer=function(t){var n=t.GetRenderContext().GetGLRenderContext(),r=this.polyLine.GetPoints(),i=e.ArrayHelper.ConvertToFloat32Array(r);this.hardWareVertexBuffer=new e.HardWareVertexBuffer(n);var s=0,o=0,u=0,a=0,f=0,l=0,c=0;f=i.length,o=0,s=f;var h=0,p=this.hardWareVertexBuffer.Create(h,s);p?(this.hardWareVertexBuffer.SetDataRange(i,o),this.hardWareVertexBuffer.SetVertexOffset(o*4),this.hardWareVertexBuffer.WriteBuffer()):this.hardWareVertexBuffer=null},n}(e.Shape);e.Body=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){this.m_IsFirstGetProperties=!0}return e}();e.FaceExtInfo=t;var n=function(n){function r(){var t=n.call(this)||this;return t.origVisible=!1,t.renderIndexOffset=0,t.renderNormalOffset=0,t.renderVertexOffset=0,t.renderTextureCoordsOffset=0,t.renderCentersOffset=0,t.renderLength=0,t.renderColor=new e.Color(.5,.5,.5,1),t.useIndex=!1,t.index=0,t.body=null,t.color=e.Color.GRAY().Clone(),t.isHighlight=!1,t.m_linesIndex=0,t.SetType(e.ShapeType.SHAPE_FACE),t.m_svlId=-1,t.m_recesiveShadow=!0,t}return __extends(r,n),r.prototype.SetMaterial=function(e){this.material=e},r.prototype.GetMaterial=function(){return this.material},r.prototype.FindVisiableObject=function(e){this.mesh!=null&&e.PrepareRenderFace(this)},r.prototype.SetBody=function(e){this.body=e},r.prototype.GetBody=function(){return this.body},r.prototype.SetInitAlpha=function(e){this.color.a=e,this.body&&this.body.MarkDrawDataDirty()},r.prototype.RayPick=function(t){if(!this.IsVisible()||!t.CanPickShape(this.GetType()))return;t.Intersect(this.GetBoundingBox())&&t.CanPickShape(e.ShapeType.SHAPE_TRIMESH)&&(this.mesh.RayPick(t),t.AddShape(this))},r.prototype.SetSelected=function(e){n.prototype.SetSelected.call(this,e),this.body&&this.body.MarkDrawDataDirty()},r.prototype.SetVisible=function(e){n.prototype.SetVisible.call(this,e),this.body&&this.body.MarkDrawDataDirty()},r.prototype.SetFaceExtInfo=function(){this.m_FaceExtInfo||(this.m_FaceExtInfo=new t),this.m_FaceExtInfo.m_InitColor=this.Color,this.m_FaceExtInfo.m_origHighlight=this.isHighlight},r.prototype.ComputeBox=function(){this.BoundingBox.Clear();if(!this.BoundingBox.Defined()){var e=this.GetMesh();e!=null&&e.GetBoundingBox().Defined()&&this.BoundingBox.copyFrom(e.GetBoundingBox())}},r.prototype.ResetAlpha=function(){this.SetAlpha(this.initColor.a)},r.prototype.SetAlpha=function(t){this.Color.a=t;if(this.material)if(this.material.GetMaterialType()==e.MaterialType.MaterialType_Base||this.material.GetMaterialType()==e.MaterialType.MaterialType_Phong||this.material.GetMaterialType()==e.MaterialType.MaterialType_MatCap){var n=this.material;n.Opacity(t)}else if(this.material.GetMaterialType()==e.MaterialType.MaterialType_Pbr){var n=this.material;n.SetOpacity(t)}this.body&&this.body.MarkDrawDataDirty(),this.renderColor.a=t},r.prototype.SetInitColor=function(t){this.initColor.copyFrom(t),this.Color=t.Clone();if(this.material)if(this.material.GetMaterialType()==e.MaterialType.MaterialType_Base||this.material.GetMaterialType()==e.MaterialType.MaterialType_Phong||this.material.GetMaterialType()==e.MaterialType.MaterialType_MatCap){var n=this.material;n.SetDiffuse(t)}else if(this.material.GetMaterialType()==e.MaterialType.MaterialType_Pbr){var n=this.material;n.SetAlbedoColor(t)}this.body&&this.body.MarkDrawDataDirty(),this.renderColor.a=t.a},r.prototype.ResetColor=function(){this.Color=this.initColor.Clone();if(this.material)if(this.material.GetMaterialType()==e.MaterialType.MaterialType_Base||this.material.GetMaterialType()==e.MaterialType.MaterialType_Phong||this.material.GetMaterialType()==e.MaterialType.MaterialType_MatCap){var t=this.material;t.SetDiffuse(this.Color)}else if(this.material.GetMaterialType()==
e.MaterialType.MaterialType_Pbr){var t=this.material;t.SetAlbedoColor(this.Color)}this.body&&this.body.MarkDrawDataDirty()},r.prototype.SetColor=function(e){this.Color=e.Clone(),this.body&&this.body.MarkDrawDataDirty()},r.prototype.GetColor=function(){var e=n.prototype.GetColor.call(this).Clone();return e},r.prototype.SetRenderColor=function(e){this.Color.copyFrom(e),this.SetInitColor(e),this.renderColor.copyFrom(e)},r.prototype.GetColorAlpha=function(){return this.renderColor.a},r.prototype.SetMesh=function(e){this.mesh=e},r.prototype.GetMesh=function(){return this.mesh},r.prototype.GetRenderMeshData=function(){return this.m_drawCache},r.prototype.SetRenderMeshData=function(e){this.m_drawCache=e},r.prototype.SetRenderWorldMatrix=function(e){this.renderWorldMatrix=e},r.prototype.GetRenderWorldMatrix=function(){return this.renderWorldMatrix},r.prototype.GetRenderColor=function(){var e=this.GetDrawColor();return e},r.prototype.GetDrawColor=function(t){t===void 0&&(t=e.Parameters.Instance().selectedStyle===1?!1:!0);if(t){var r=n.prototype.GetDrawColor.call(this).Clone();return r}return this.Color},r.prototype.GetRenderMaterial=function(){return this.GetMaterial()},r.prototype.GetLinesModeVertexPos=function(){return this.m_linesVertexPos},r.prototype.SetRenderMesh=function(t){var n=t.GetDataOffset(),r=t.GetRefMesh();this.useIndex=r.UseIndex(),this.hardWareVertexBuffer=r.GetHardWareVertexBuffer(),this.hardWareIndexBuffer=r.GetHardWareIndexBuffer();if(this.hardWareVertexBuffer!=null&&this.hardWareVertexBuffer.HasValue())if(this.useIndex){if(this.hardWareIndexBuffer&&this.hardWareIndexBuffer.HasValue()){this.renderIndexOffset=this.hardWareIndexBuffer.GetOffset()+n*1,this.renderNormalOffset=this.hardWareVertexBuffer.GetNormalOffset(),this.renderVertexOffset=this.hardWareVertexBuffer.GetVertexOffset(),this.renderTextureCoordsOffset=this.hardWareVertexBuffer.GetTextureCoordsOffset();if(e.Parameters.Instance().IsShowTrilateralEdge){var i=r.GetLinesModeIndexArray();this.m_linesIndex=i.length+n*2,this.m_linesVertexPos=r.GetPositionArray()}}}else n*=e.Vector3.BYTE_SIZE,this.renderNormalOffset=this.hardWareVertexBuffer.GetNormalOffset()+n,this.renderVertexOffset=this.hardWareVertexBuffer.GetVertexOffset()+n,this.renderTextureCoordsOffset=this.hardWareVertexBuffer.GetTextureCoordsOffset()+n,this.renderCentersOffset=this.hardWareVertexBuffer.GetCentersCoordsOffset()+n,e.Parameters.Instance().IsShowTrilateralEdge&&(this.m_linesVertexPos=n*2);this.renderLength=t.GetDataLength()},r.prototype.GetLineModeIndex=function(){return this.m_linesIndex},r.prototype.MergeRenderMesh=function(e){this.renderLength+=e.GetDataLength()},r.prototype.GetRenderMesh=function(){return this.mesh},r.prototype.GetDataLength=function(){return this.renderLength},r.prototype.IsUseIndex=function(){return this.useIndex},r.prototype.SetIndexOffset=function(e){this.renderIndexOffset=e},r.prototype.GetIndexOffset=function(){return this.renderIndexOffset},r.prototype.SetNormalOffset=function(e){this.renderNormalOffset=e},r.prototype.GetNormalOffset=function(){return this.renderNormalOffset},r.prototype.SetVertexOffset=function(e){this.renderVertexOffset=e},r.prototype.GetVertexOffset=function(){return this.renderVertexOffset},r.prototype.SetTextureCoordsOffset=function(e){this.renderTextureCoordsOffset=e},r.prototype.GetTextureCoordsOffset=function(){return this.renderTextureCoordsOffset},r.prototype.SetCentersCoordsOffset=function(e){this.renderCentersOffset=e},r.prototype.GetCentersCoordsOffset=function(){return this.renderCentersOffset},r.prototype.GetHardWareVertexBuffer=function(){return this.hardWareVertexBuffer},r.prototype.GetHardWareIndexBuffer=function(){return this.hardWareIndexBuffer},r.prototype.SetOrigVisible=function(e){this.origVisible=e,this.SetVisible(e)},r.prototype.IsOrigVisible=function(){return this.origVisible},r.prototype.Restore=function(){this.ResetColor(),this.SetVisible(this.IsOrigVisible()),this.SetSelected(!1)},r.prototype.AssignOperator=function(e){n.prototype.AssignOperator.call(this,e),this.mesh=e.mesh,this.m_svlId=e.m_svlId,this.material=e.material},r.prototype.FramePick=function(e){n.prototype.FramePick.call(this,e)},r.prototype.IsHightlight=function(){return this.isHighlight||this.IsSelect},r.prototype.SetInitHightlight=function(e){this.isHighlight=e,this.m_FaceExtInfo||(this.m_FaceExtInfo=new t),this.m_FaceExtInfo.m_origHighlight=e,this.body&&this.body.MarkDrawDataDirty()},r.prototype.GetVertexCount=function(e){var t=0,n=this.GetMesh();return n!=null&&(t+=n.GetVertexCount()),t},r.prototype.GetSVLId=function(){return this.m_svlId},r.prototype.SetSVLId=function(e){this.m_svlId=e},r.prototype.GetGeoAttribute=function(){var e=this.GetMesh();if(e){var t=void 0;return this.GetSVLId()&&(this.GetBody()&&this.GetBody().GetModel()&&(t=this.GetBody().GetModel().GetExtendInfoManager().GetFaceGeoAttribute(this.GetBody().GetModel().GetProtoTypeId(),this.GetSVLId())),e.SetGeoAttribute(t)),t}return null},r.prototype.InitProperties=function(){var e="名称",t="ID",n="Color",r="LOD0PatchNumber",i="LOD1PatchNumber";this.AddProperty(t,String(this.Id));var s=String(this.Color.r)+","+String(this.Color.g)+","+String(this.Color.b)+","+String(this.Color.a);this.AddProperty(n,s),this.AddProperty(r,String(this.GetVertexCount(0)/3));var o="面积",u=0,a=0;this.AddProperty(o,String(a))},r.prototype.GetVolumeAndArea=function(e,t){var n=this.GetMesh();n&&n},r.prototype.GetEdges=function(){return[]},r.prototype.RecesiveShadow=function(){return this.m_recesiveShadow},r.prototype.SetRecesiveShadow=function(e){this.m_recesiveShadow=e},r}(e.Shape);e.Face=n})(M3D||(M3D={}));var M3D;(function(e){e.LOD_LODMAX=0,e.LOD_LODMIN=10;var t=function(){function e(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];t[0]instanceof e&&(this.m_data=t[0].m_data)}return e.prototype.GetData=function(e){var t=null;return e<this.GetCount()&&e>=0&&(t=this.m_data[e]),t},e.prototype.GetCount=function(){return this.m_data.length},e.prototype.AddData=function(e,t){if(t<this.GetCount()&&t>=0)this.m_data[t]=e;else{var n=this.m_data;this.m_data[t+1]=null;for(var r=0;r<n.length;r++)this.m_data[r]=n[r];this.m_data[t]=e}},e}();e.LOD=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(t){this.refMesh=null,this.geoAttribute=null,this.boudingBox=new e.BoundingBox,this.dataOffset=0,this.dataLength=0,this.SetRefMesh(t)}return t.prototype.GetBoundingBox=function(){if(!this.boudingBox.Defined()&&this.refMesh){var e=0,t=this.refMesh.UseIndex();if(t){var n=this.dataLength;e=n;var r=this.refMesh.GetPositionArray(),i=this.refMesh.GetIndexArray();for(var s=0;s<n;s++)this.boudingBox.Merge(r[i[this.dataOffset+s]*3],r[i[this.dataOffset+s]*3+1],r[i[this.dataOffset+s]*3+2])}else{e=this.dataLength;var o=this.refMesh.GetPositionArray();for(var s=0;s<e;s++)this.boudingBox.Merge(o[(this.dataOffset+s)*3],o[(this.dataOffset+s)*3+1],o[(this.dataOffset+s)*3+2])}}return this.boudingBox},t.prototype.RayPick=function(t){if(t.Intersect(this.GetBoundingBox())){var n=new e.Vector3,r=this.refMesh.UseIndex(),i=0,s=new e.Vector3,o=new e.Vector3,u=new e.Vector3;if(r){var a=this.dataLength;i=a;var f=this.refMesh.GetPositionArray(),l=this.refMesh.GetIndexArray(),c=0,h=0,p=0;for(var d=0;d<a/3;d++){c=l[a+d*3],h=l[a+d*3+1],p=l[a+d*3+2],s.x=f[c*3],s.y=f[c*3+1],s.z=f[c*3+2],o.x=f[h*3],o.y=f[h*3+1],o.z=f[h*3+2],u.x=f[p*3],u.y=f[p*3+1],u.z=f[p*3+2];if(t.IsintersectRayAndTriangle(s,o,u,n)){var v=new e.Vector3;v.copyFrom(n),t.AddIntersectPnt(v)}}}else{i=this.dataLength;var m=this.refMesh.GetPositionArray();for(var d=0;d<i/3;d++){var g=(this.dataOffset+d*3)*3,y=g+3,b=g+6;s.x=m[g],s.y=m[g+1],s.z=m[g+2],o.x=m[y],o.y=m[y+1],o.z=m[y+2],u.x=m[b],u.y=m[b+1],u.z=m[b+2];if(t.IsintersectRayAndTriangle(s,o,u,n)){var v=new e.Vector3;v.copyFrom(n),t.AddIntersectPnt(v)}}}}},t.prototype.Clear=function(){},t.prototype.GetVertexCount=function(){return this.dataLength},t.prototype.GetGeoAttribute=function(){return this.geoAttribute},t.prototype.SetGeoAttribute=function(e){this.geoAttribute=e},t.prototype.SetRefMesh=function(e){this.refMesh=e},t.prototype.GetRefMesh=function(){return this.refMesh},t.prototype.SetDataLength=function(e){this.dataLength=e},t.prototype.GetDataLength=function(){return this.dataLength},t.prototype.SetDataOffset=function(e){this.dataOffset=e},t.prototype.GetDataOffset=function(){return this.dataOffset},t.prototype.GetVolumeAndArea=function(e,t){},t}();e.Mesh=t})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.M3D_GEOATTR_TYPE_UNKNOWN=0]="M3D_GEOATTR_TYPE_UNKNOWN",e[e.M3D_GEOATTR_TYPE_PLANEFACE=1]="M3D_GEOATTR_TYPE_PLANEFACE",e[e.M3D_GEOATTR_TYPE_REVOLUTIONFACE=2]="M3D_GEOATTR_TYPE_REVOLUTIONFACE",e[e.M3D_GEOATTR_TYPE_CYLINDERFACE=3]="M3D_GEOATTR_TYPE_CYLINDERFACE",e[e.M3D_GEOATTR_TYPE_CONICALFACE=4]="M3D_GEOATTR_TYPE_CONICALFACE",e[e.M3D_GEOATTR_TYPE_SPHEREFACE=5]="M3D_GEOATTR_TYPE_SPHEREFACE",e[e.M3D_GEOATTR_TYPE_TOROIDALFACE=6]="M3D_GEOATTR_TYPE_TOROIDALFACE",e[e.M3D_GEOATTR_TYPE_LINE=7]="M3D_GEOATTR_TYPE_LINE",e[e.M3D_GEOATTR_TYPE_ELLIPSE=8]="M3D_GEOATTR_TYPE_ELLIPSE"})(t=e.GeoAttrTypeEnum||(e.GeoAttrTypeEnum={}));var n=function(){function e(){this.m_ID=0,this.m_eGeoAttrType=t.M3D_GEOATTR_TYPE_UNKNOWN}return e.prototype.GetID=function(){return this.m_ID},e.prototype.SetID=function(e){this.m_ID=e},e.prototype.GetGeoAttrType=function(){return this.m_eGeoAttrType},e.prototype.SetGeoAttrType=function(e){this.m_eGeoAttrType=e},e}();e.GeometryAttribute=n;var r=function(n){function r(){var r=n.call(this)||this;return r.m_eGeoAttrType=t.M3D_GEOATTR_TYPE_LINE,r.m_ID=0,r.m_fLength=0,r.m_pntStartPoint=e.Vector3.ZERO().Clone(),r.m_pntEndPoint=e.Vector3.ZERO().Clone(),r.m_pntCenterPoint=e.Vector3.ZERO().Clone(),r.m_dirDirection=e.Vector3.ZERO().Clone(),r}return __extends(r,n),r.prototype.GetLength=function(){return this.m_fLength},r.prototype.SetLength=function(e){this.m_fLength=e},r.prototype.GetStartPoint=function(){return this.m_pntStartPoint},r.prototype.SetStartPoint=function(e){this.m_pntStartPoint=e},r.prototype.GetEndPoint=function(){return this.m_pntEndPoint},r.prototype.SetEndPoint=function(e){this.m_pntEndPoint=e},r.prototype.GetCenterPoint=function(){return this.m_pntCenterPoint},r.prototype.SetCenterPoint=function(e){this.m_pntCenterPoint=e},r.prototype.GetDirection=function(){return this.m_dirDirection},r.prototype.SetDirection=function(e){this.m_dirDirection=e},r}(n);e.LineAttribute=r;var i=function(n){function r(){var r=n.call(this)||this;return r.m_eGeoAttrType=t.M3D_GEOATTR_TYPE_ELLIPSE,r.m_ID=0,r.m_pntStartPoint=e.Vector3.ZERO().Clone(),r.m_pntEndPoint=e.Vector3.ZERO().Clone(),r.m_pntCenterPoint=e.Vector3.ZERO().Clone(),r.m_fMajorRadius=0,r.m_fMinorRadius=0,r.m_dirX=e.Vector3.ZERO().Clone(),r}return __extends(r,n),r.prototype.GetXYZDir=function(e,t,n){e.copyFrom(this.m_dirX.Clone()),t.copyFrom(this.m_dirY.Clone()),n.copyFrom(this.m_dirZ.Clone())},r.prototype.SetXYZDir=function(e,t,n){this.m_dirX=e.Clone(),this.m_dirY=t.Clone(),this.m_dirZ=n.Clone()},r.prototype.GetCenterPoint=function(){return this.m_pntCenterPoint},r.prototype.SetCenterPoint=function(e){this.m_pntCenterPoint=e.Clone()},r.prototype.GetMajorRadius=function(){return this.m_fMajorRadius},r.prototype.GetMinorRadius=function(){return this.m_fMinorRadius},r.prototype.SetMinorRadius=function(e){this.m_fMinorRadius=e},r.prototype.SetMajorRadius=function(e){this.m_fMajorRadius=e},r.prototype.GetStartPoint=function(){return this.m_pntStartPoint},r.prototype.SetStartPoint=function(e){this.m_pntStartPoint=e.Clone()},r.prototype.GetEndPoint=function(){return this.m_pntEndPoint},r.prototype.SetEndPoint=function(e){this.m_pntEndPoint=e.Clone()},r.prototype.ConvertToLine=function(){var t=new e.Line3D;return t.StartPoint=this.m_pntStartPoint.Clone(),t.EndPoint=this.m_pntEndPoint.Clone(),t},r}(n);e.EllipseAttribute=i;var s=function(n){function r(){var r=n.call(this)||this;return r.m_eGeoAttrType=t.M3D_GEOATTR_TYPE_PLANEFACE,r.m_ID=0,r.m_dirNormal=e.Vector3.ZERO().Clone(),r.m_pntOrigin=e.Vector3.ZERO().Clone(),r}return __extends(r,n),r.prototype.SetNormal=function(e){this.m_dirNormal=e.Clone()},r.prototype.GetNormal=function(){return this.m_dirNormal},r.prototype.SetOrigin=function(e){this.m_pntOrigin=e},r.prototype.GetOrigin=function(){return this.m_pntOrigin},r}(n);e.PlaneFaceAttribute=s;var o=function(n){function r(){var r=n.call(this)||this;return r.m_eGeoAttrType=t.M3D_GEOATTR_TYPE_REVOLUTIONFACE,r.m_ID=0,r.m_dRadius=0,r.m_dirRevoAxis=e.Vector3.ZERO().Clone(),r.m_pntAxisOrigin=e.Vector3.ZERO().Clone(),r}return __extends(r,n),r.prototype.SetRadius=function(e){this.m_dRadius=e},r.prototype.GetRadius=function(){return this.m_dRadius},r.prototype.SetRevoAxis=function(e){this.m_dirRevoAxis=e},r.prototype.GetRevoAxis=function(){return this.m_dirRevoAxis},r.prototype.SetAxisOrigin=function(e){this.m_pntAxisOrigin=e},r.prototype.GetAxisOrigin=function(){return this.m_pntAxisOrigin},r}(n);e.RevolutionFaceAttribute=o;var u=function(n){function r(){var r=n.call(this)||this;return r.m_eGeoAttrType=t.M3D_GEOATTR_TYPE_CYLINDERFACE,r.m_ID=0,r.m_dRadius=0,r.m_dirRevoAxis=e.Vector3.ZERO().Clone(),r.m_pntAxisOrigin=e.Vector3.ZERO().Clone(),r}return __extends(r,n),r}(o);e.CylinderFaceAttribute=u;var a=function(n){function r(){var r=n.call(this)||this;return r.m_eGeoAttrType=t.M3D_GEOATTR_TYPE_CONICALFACE,r.m_ID=0,r.m_dirRevoAxis=e.Vector3.ZERO(),r.m_pntAxisOrigin=e.Vector3.ZERO(),r}return __extends(r,n),r}(o);e.ConicalFaceAttribute=a;var f=function(n){function r(){var r=n.call(this)||this;return r.m_eGeoAttrType=t.M3D_GEOATTR_TYPE_SPHEREFACE,r.m_ID=0,r.m_dRadius=0,r.m_dirRevoAxis=e.Vector3.ZERO(),r.m_pntAxisOrigin=e.Vector3.ZERO(),r}return __extends(r,n),r}(o);e.SphereFaceAttribute=f;var l=function(n){function r(){var r=n.call(this)||this;return r.m_eGeoAttrType=t.M3D_GEOATTR_TYPE_TOROIDALFACE,r.m_ID=0,r.m_dRadius=0,r.m_dirRevoAxis=e.Vector3.ZERO(),r.m_pntAxisOrigin=e.Vector3.ZERO(),r.m_fMajorRadius=0,r.m_fMinorRadius=0,r}return __extends(r,n),r.prototype.GetMajorRadius=function(){return this.m_fMajorRadius},r.prototype.SetMajorRaius=function(e){this.m_fMajorRadius=e},r.prototype.GetMinorRadius=function(){return this.m_fMinorRadius},r.prototype.SetMinorRadius=function(e){this.m_fMinorRadius=e},r}(o);e.ToroidalFaceAttribute=l})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){}return e}();e.InstanceAttribute=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){this.IndexArray=[],this.m_linesModeIndexArray=[],this.hardWareVertexBuffer=null,this.hardWareIndexBuffer=null,this.dirty=!0,this.positionArray=new Float32Array(0),this.NormalArray=new Float32Array(0),this.textureCoords=new Float32Array(0),this.m_linesModepositionArray=new Float32Array(0)}return t.prototype.GetBoundingBox=function(){return new e.BoundingBox},t.prototype.GetPositionArray=function(){return this.positionArray},t.prototype.SetPositionArray=function(e){this.positionArray=e},t.prototype.SetUVArray=function(e){this.textureCoords=e},t.prototype.GetUVArray=function(){return this.textureCoords},t.prototype.GetNormalArray=function(){return this.NormalArray},t.prototype.SetNormalArray=function(e){this.NormalArray=e},t.prototype.GetTextureCoordArray=function(){return this.positionArray},t.prototype.GetIndexArray=function(){return this.IndexArray},t.prototype.IsDirty=function(){return this.dirty},t.prototype.MarkDirty=function(){this.dirty=!0},t.prototype.SetUseIndex=function(e){this.useIndex=e},t.prototype.UseIndex=function(){return this.useIndex},t.prototype.GetHardWareVertexBuffer=function(){return this.hardWareVertexBuffer},t.prototype.GetHardWareIndexBuffer=function(){return this.hardWareIndexBuffer},t.prototype.GetLinesModeIndexArray=function(){if(this.m_linesModeIndexArray.length===0&&this.UseIndex){var e=this.IndexArray.length/3;this.m_linesModeIndexArray=new Array(e*6);for(var t=0;t<e;t++)this.m_linesModeIndexArray.push(this.IndexArray[t*3]),this.m_linesModeIndexArray.push(this.IndexArray[t*3+1]),this.m_linesModeIndexArray.push(this.IndexArray[t*3+1]),this.m_linesModeIndexArray.push(this.IndexArray[t*3+2]),this.m_linesModeIndexArray.push(this.IndexArray[t*3+2]),this.m_linesModeIndexArray.push(this.IndexArray[t*3])}return this.m_linesModeIndexArray},t.prototype.GetLinesModePointArray=function(){if(this.m_linesModepositionArray.length===0&&!this.useIndex){var e=this.positionArray.length;this.m_linesModepositionArray=new Float32Array(e*2);for(var t=0;t<e;t+=9){var n=t*2;this.m_linesModepositionArray[n]=this.positionArray[t],this.m_linesModepositionArray[n+1]=this.positionArray[t+1],this.m_linesModepositionArray[n+2]=this.positionArray[t+2],this.m_linesModepositionArray[n+3]=this.positionArray[t+3],this.m_linesModepositionArray[n+4]=this.positionArray[t+4],this.m_linesModepositionArray[n+5]=this.positionArray[t+5],this.m_linesModepositionArray[n+6]=this.positionArray[t+3],this.m_linesModepositionArray[n+7]=this.positionArray[t+4],this.m_linesModepositionArray[n+8]=this.positionArray[t+5],this.m_linesModepositionArray[n+9]=this.positionArray[t+6],this.m_linesModepositionArray[n+10]=this.positionArray[t+7],this.m_linesModepositionArray[n+11]=this.positionArray[t+8],this.m_linesModepositionArray[n+12]=this.positionArray[t+6],this.m_linesModepositionArray[n+13]=this.positionArray[t+7],this.m_linesModepositionArray[n+14]=this.positionArray[t+8],this.m_linesModepositionArray[n+15]=this.positionArray[t+0],this.m_linesModepositionArray[n+16]=this.positionArray[t+1],this.m_linesModepositionArray[n+17]=this.positionArray[t+2]}}return this.m_linesModepositionArray},t.prototype.UpdateHardWareBuffer=function(e){this.dirty&&(this.dirty=!1,this.hardWareVertexBuffer===null&&this.positionArray.length>0&&this.createVertexBuffer(e),this.hardWareIndexBuffer===null&&this.IndexArray.length>0&&this.createIndexBuffer(e))},t.prototype.createVertexBuffer=function(t){var n=t.GetRenderContext().GetGLRenderContext();this.hardWareVertexBuffer=new e.HardWareVertexBuffer(n);var r=0,i=0,s=0,o=0,u=0,a=0,f=0,l=[1,0,0,0,1,0,0,0,1];u=this.positionArray.length,a=this.NormalArray.length,f=this.textureCoords.length;var c=new Float32Array(u);for(var h=0,p=0;h<u-2;h+=3,p+=3)p===9&&(p=0),c[h+0]=l[p+0],c[h+1]=l[p+1],c[h+2]=l[p+2];var d=c.length;i=0,s=i+u,o=s+a;var v=o+f;r=u+a+f+d;var m=0,g=this.hardWareVertexBuffer.Create(m,r);g?(this.hardWareVertexBuffer.SetDataRange(this.positionArray,i),this.hardWareVertexBuffer.SetDataRange(this.NormalArray,s),this.hardWareVertexBuffer.SetDataRange(this.textureCoords,o),this.hardWareVertexBuffer.SetDataRange(c,v),this.hardWareVertexBuffer.SetVertexOffset(i*4),this.hardWareVertexBuffer.SetNormalOffset(s*4),this.hardWareVertexBuffer.SetTextureCoordsOffset(o*4),this.hardWareVertexBuffer.SetCentersCoordsOffset(v*4),this.hardWareVertexBuffer.WriteBuffer()):this.hardWareVertexBuffer=null},t.prototype.createIndexBuffer=function(t){var n=t.GetRenderContext().GetGLRenderContext();this.hardWareIndexBuffer=new e.HardWareIndexBuffer(n);var r=0;r+=this.IndexArray.length;var i=0,s=this.hardWareIndexBuffer.Create(i,r);if(!s)this.hardWareIndexBuffer=null;else{this.hardWareIndexBuffer.SetDataRange(e.ArrayHelper.ConvertToInt8Array(this.IndexArray),r);var o=0;this.hardWareIndexBuffer.SetOffset(o),this.hardWareIndexBuffer.WriteBuffer()}},t.prototype.computeVertexNormals=function(){if(this.positionArray){var t=this.positionArray;this.NormalArray=new Float32Array(this.positionArray.length);var n=this.NormalArray,r=void 0,i=void 0,s=void 0,o=new e.Vector3,u=new e.Vector3,a=new e.Vector3,f=new e.Vector3,l=new e.Vector3;for(var c=0,h=t.length;c<h;c+=9){o=new e.Vector3(t[c],t[c+1],t[c+2]),u=new e.Vector3(t[c+3],t[c+4],t[c+5]),a=new e.Vector3(t[c+6],t[c+7],t[c+8]);var p=a.Sub(u),d=o.Sub(u);p.CrossProductED(d).NormalizedED(),n[c+0]=p.x,n[c+1]=p.y,n[c+2]=p.z,n[c+3]=p.x,n[c+4]=p.y,n[c+5]=p.z,n[c+6]=p.x,n[c+7]=p.y,n[c+8]=p.z}}},t}();e.VertexSet=t})(M3D||(M3D={}));var M3D;(function(e){e.GL=null;var t=function(){function t(e){this.gl=null,this.gl=e}return t.GetRenderContext=function(n){if(n!==null){var r=n.getContext("webgl",{stencil:!0});r===null&&(r=n.getContext("experimental-webgl",{stencil:!0})),e.GL=r,console.log(e.GL===r);if(r!==null){var i=new t(r);i.GetGLRenderContext().getExtension("OES_standard_derivatives");var s=i.GetGLRenderContext().getExtension("EXT_shader_texture_lod");return i.GetGLRenderContext().getExtension("OES_standard_derivatives"),t.hasSRGB=i.GetGLRenderContext().getExtension("EXT_SRGB"),t.hasSRGB=null,t.maxTextures=i.GetGLRenderContext().getParameter(e.GL.MAX_TEXTURE_IMAGE_UNITS),t.maxVertexTextures=i.GetGLRenderContext().getParameter(e.GL.MAX_VERTEX_TEXTURE_IMAGE_UNITS),i}return null}},t.GetExtension=function(e,n){if(t.extensions[n]!==undefined)return t.extensions[n];var r;switch(n){case"WEBGL_depth_texture":r=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":r=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":r=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":r=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;case"WEBGL_compressed_texture_etc1":r=e.getExtension("WEBGL_compressed_texture_etc1");break;default:r=e.getExtension(n)}return r===null&&console.warn(n+" extension not supported."),t.extensions[n]=r,r},t.prototype.GetGLRenderContext=function(){return this.gl},t.prototype.SetViewMatrix=function(e){this.viewMatrix=e},t.prototype.SetProjectMatrix=function(e){this.projectMatrix=e},t.prototype.GetViewMatrix=function(){return this.viewMatrix},t.prototype.GetProjectMatrix=function(){return this.projectMatrix},t.hasSRGB=null,t.maxTextures=6,t.maxVertexTextures=0,t.extensions={},t}();e.RenderContext=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){}return t.DrawAxis=function(t,n){var r=n.GetRenderContext().GetGLRenderContext(),i=t;if(!i)return;i.SetCurrentGLContext(r);var s=n.GetShaderMananger();if(!s)return;var o=s.GetEffect(e.ShaderManager.Axis);if(!o)return;r.disable(e.GL.DEPTH_TEST),r.viewport(i.iViewX,i.iViewY,i.iW,i.iW);var u=i.GetGLWorldTransform(),a=new e.Matrix4;a.Ortho(i.ProArray[0],i.ProArray[1],i.ProArray[2],i.ProArray[3],i.ProArray[4],i.ProArray[5]),o.UseProgram();var f=o.GetShaderAttributeParameter(e.VSP_POSITION),l=f.location,c=u.Multiply(a.Transpose());o.SetUniformValue(e.VSP_MVPMAT,c),o.EnableAttributeArray(l);var h=i.GetPositionVBO();h.Bind(),o.SetUniformValue(e.VSP_UCOLOR,i.xColor),o.SetVertexAttribPointer(l,3,e.GL.FLOAT,0,0),r.drawArrays(e.GL.TRIANGLES,0,i.iPntXNum/3),o.SetUniformValue(e.VSP_UCOLOR,i.yColor),o.SetVertexAttribPointer(l,3,e.GL.FLOAT,0,i.yOffset*4),r.drawArrays(e.GL.TRIANGLES,0,i.iPntYNum/3),o.SetUniformValue(e.VSP_UCOLOR,i.zColor),o.SetVertexAttribPointer(l,3,e.GL.FLOAT,0,i.zOffset*4),r.drawArrays(e.GL.TRIANGLES,0,i.iPntZNum/3),o.SetUniformValue(e.VSP_UCOLOR,i.oColor),o.SetVertexAttribPointer(l,3,e.GL.FLOAT,0,i.oOffset*4),r.drawArrays(e.GL.TRIANGLES,0,i.iPntONum/3),o.DisableAttributeArray(l),h.UnBind(),o.ReleaseShaderProgram(),r.enable(e.GL.DEPTH_TEST)},t.DrawRenderPassGroup=function(t){var n=t.GetRenderContext().GetGLRenderContext();this.ApplyCamera(t),this.DoSection(t,!0)&&(n.clearStencil(0),n.enable(e.GL.STENCIL_TEST),n.clear(e.GL.STENCIL_BUFFER_BIT),n.stencilFunc(e.GL.ALWAYS,0,1),n.stencilOp(e.GL.KEEP,e.GL.INVERT,e.GL.INVERT),n.stencilMask(1),n.colorMask(!1,!1,!1,!1),n.disable(e.GL.DEPTH_TEST),n.depthMask(!1),this.DrawSampleModelPassGroug(t),n.colorMask(!0,!0,!0,!0),n.enable(e.GL.DEPTH_TEST),n.depthMask(!0),n.stencilFunc(e.GL.EQUAL,1,1),n.stencilOp(e.GL.KEEP,e.GL.KEEP,e.GL.KEEP),this.DrawCapPolygon(t),n.clearStencil(0),n.clear(e.GL.STENCIL_BUFFER_BIT),n.stencilOp(e.GL.KEEP,e.GL.KEEP,e.GL.KEEP),n.stencilFunc(e.GL.EQUAL,0,65535),n.disable(e.GL.STENCIL_TEST)),this.DoSection(t,!0);var r=t.GetRenderManager().GetGlobalEffect(),i=t.GetRenderManager().GetEffectManager().getEffect(r);i!==null?i.Render():this.DrawPhongPass(t),this.DoSection(t,!1),this.DrawDraggerPass(t)},t.DrawSolidRenderPassGroup=function(t,n){var r=t.GetRenderContext().GetGLRenderContext();r.enable(e.GL.DEPTH_TEST),r.enable(e.GL.POLYGON_OFFSET_FILL),r.depthMask(!0),r.polygonOffset(.1,.1),this.isSVLX?this.RenderFaces(t,n):this.DrawPhongPassGroup(t,n),r.polygonOffset(0,0),r.disable(e.GL.POLYGON_OFFSET_FILL),r.enable(e.GL.DEPTH_TEST)},t.DrawTranRenderPassGroup=function(t,n){if(n.GetRenderableArray().length==0)return;var r=t.GetRenderContext().GetGLRenderContext(),i=t.GetCamera();r.enable(e.GL.DEPTH_TEST),r.enable(e.GL.POLYGON_OFFSET_FILL),r.enable(e.GL.BLEND),r.polygonOffset(.1,.1);var s=i.GetProjection(),o=i.GetView(),u=[],a=n.GetRenderableArray();for(var f=0;f<a.length;f++)var l=a[f],c=l,h=c.GetBody().GetModel().GetWorldBoundingBox().Center(),p=new e.Vector4(h,1),d=s.Multiply(o).Multiply(p);this.isSVLX?this.RenderFaces(t,n):this.DrawPhongPassGroup(t,n),r.disable(e.GL.CULL_FACE),r.depthMask(!0),r.polygonOffset(0,0),r.disable(e.GL.BLEND),r.disable(e.GL.POLYGON_OFFSET_FILL),r.enable(e.GL.DEPTH_TEST)},t.DrawTriLineRenderPassGroup=function(t,n){if(n.GetRenderableArray().length===0)return;var r=t.GetCamera(),i=t.GetRenderContext(),s=i.GetGLRenderContext();if(!r)return;var o=new e.Matrix4,u=new e.Matrix4,a=new e.Matrix4;u=r.GetProjection().Transpose(),o=r.GetView().ToMatrix4().Transpose();var f=t.GetShaderMananger(),l=f.GetEffect(e.ShaderManager.Edge);l.UseProgram();var c=l.GetShaderAttributeParameter(e.VSP_POSITION);l.EnableAttributeArray(c.location),l.SetUniformValue(e.VSP_VIEWMAT,i.GetViewMatrix()),l.SetUniformValue(e.VSP_PROJECTIONMAT,i.GetProjectMatrix()),s.lineWidth(2);var h=n.GetRenderableArray();for(var p=0,d=h;p<d.length;p++){var v=d[p],m=v,g=m.GetDataLength()/3;if(g){var y=m.IsUseIndex(),b=new e.Matrix4;b=b.Multiply(m.GetRenderWorldMatrix()),l.SetUniformValue(e.VSP_MODELMAT,b);var w=m.GetRenderMesh().GetRefMesh().GetLinesModePointArray();if(w==null)continue;var E=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,E),s.bufferData(s.ARRAY_BUFFER,w,s.STATIC_DRAW),l.SetVertexAttribPointer(c.location,3,e.GL.FLOAT,0,0);var S=void 0;m.IsSelected()?S=m.GetRenderColor():S=e.Color.YELLOW().Clone(),l.SetUniformValue(e.FSP_DIFFUSE,S);if(g>0)if(y){var x=m.GetLineModeIndex();s.drawElements(e.GL.LINES,g,e.GL.FLOAT,x)}else s.drawArrays(e.GL.LINES,0,w.length/3)}}l.DisableAttributeArray(c.location),l.ReleaseShaderProgram()},t.DrawEdgesRenderPassGroup=function(t,n){if(n.GetRenderableArray().length===0)return;var r=t.GetRenderContext().GetGLRenderContext(),i=t.GetRenderContext(),s=t.GetCamera(),o=t.GetShaderMananger(),u=o.GetEffect(e.ShaderManager.Edge);u.UseProgram();var a=new e.Vector4(t.clipPlane[0].Clone());a=s.GetView().ToMatrix4().Inverse().Transpose().Multiply(a),u.SetUniformValue(e.FSP_CLIPPLANE,a);var f=new Int32Array([t.enableClip[0]]);u.SetUniformValue(e.FSP_ENABLECLIP,f);var l,c,h,p;c=s.GetProjection().Transpose(),l=s.GetView().ToMatrix4().Transpose();var d=u.GetShaderAttributeParameter(e.VSP_POSITION);u.EnableAttributeArray(d.location),u.SetUniformValue(e.VSP_VIEWMAT,i.GetViewMatrix()),u.SetUniformValue(e.VSP_PROJECTIONMAT,i.GetProjectMatrix());var v=n.GetRenderableArray();h=new e.Matrix4;for(var m=0,g=v;m<g.length;m++){var y=g[m],b=y,w=b.GetDataLength(),E=b.GetRenderColor(),S=b.GetBody().GetHardWareVertexBuffer();if(!S)return;S.Bind(),h=b.GetRenderWorldMatrix(),u.SetUniformValue(e.VSP_MODELMAT,h),u.SetUniformValue(e.FSP_DIFFUSE,E),u.SetVertexAttribPointer(d.location,3,e.GL.FLOAT,0,b.vertexPos),r.drawArrays(r.LINES,0,w),S.UnBind()}u.DisableAttributeArray(d.location),u.ReleaseShaderProgram()},t.DrawPointPassGroup=function(n,r){if(r.GetRenderableArray().length==0)return;var i=n.GetCamera();if(!i)return;var s=n.GetRenderContext().GetGLRenderContext(),o=n.GetShaderMananger(),u=[];s.disable(e.GL.DEPTH_TEST),s.depthMask(!0),s.enable(e.GL.BLEND);var a=r.GetRenderableArray();for(var f=0,l=a;f<l.length;f++){var c=l[f],h=c;h.IsFrontShow()?u.push(h):t.DrawPoint(h,o,i)}if(u.length>0){s.disable(e.GL.DEPTH_TEST),s.depthMask(!0),s.enable(e.GL.BLEND);for(var p=0;p<u.length;p++){var h=u[p];t.DrawPoint(h,o,i)}}},t.DrawPoint=function(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];if(n.length===3){var i=n[0],s=n[1],o=n[2],u=void 0;u=i.GetRenderWorldMatrix();var a=i.GetRenderColor(),f=s.GetCurrentAction(),l=i.GetDrawType();if(l==1||l==2||l==3||l==4){var c=s.GetEffect(e.ShaderManager.Image);c.UseProgram();var h=new e.Vector4(f.clipPlane[0].Clone());h=o.GetView().ToMatrix4().Inverse().Transpose().Multiply(h),c.SetUniformValue(e.FSP_CLIPPLANE,h);var p=new Int32Array([f.enableClip[0]]);c.SetUniformValue(e.FSP_ENABLECLIP,p),t.DrawImageBoard(i.GetImageboard(),o,u,c),c.ReleaseShaderProgram()}else if(l==0){var c=s.GetEffect(e.ShaderManager.Edge);c.UseProgram();var h=new e.Vector4(f.clipPlane[0].Clone());h=o.GetView().ToMatrix4().Inverse().Transpose().Multiply(h),c.SetUniformValue(e.FSP_CLIPPLANE,h);var p=new Int32Array([f.enableClip[0]]);c.SetUniformValue(e.FSP_ENABLECLIP,p),t.DrawMeshBoard(i.GetMeshBoard(),o,u,c),c.ReleaseShaderProgram()}}else if(n.length===4){var i=n[0],s=n[1],o=n[2],d=n[3],u=void 0;u=i.GetRenderWorldMatrix().Multiply(d);var a=i.GetRenderColor(),f=s.GetCurrentAction(),l=i.GetDrawType();if(l==1||l==2||l==3||l==4){var c=s.GetEffect(e.ShaderManager.Image);c.UseProgram();var h=new e.Vector4(f.clipPlane[0].Clone());h=o.GetView().ToMatrix4().Inverse().Transpose().Multiply(h),c.SetUniformValue(e.FSP_CLIPPLANE,h);var p=new Int32Array([f.enableClip[0]]);c.SetUniformValue(e.FSP_ENABLECLIP,p),t.DrawImageBoard(i.GetImageboard(),o,u,c),c.ReleaseShaderProgram()}else if(l==0){var c=s.GetEffect(e.ShaderManager.Edge);c.UseProgram();var h=new e.Vector4(f.clipPlane[0].Clone());h=o.GetView().ToMatrix4().Inverse().Transpose().Multiply(h),c.SetUniformValue(e.FSP_CLIPPLANE,h);var p=new Int32Array([f.enableClip[0]]);c.SetUniformValue(e.FSP_ENABLECLIP,p),t.DrawMeshBoard(i.GetMeshBoard(),o,u,c),c.ReleaseShaderProgram()}}},t.DrawImageBoard=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length===4){var r=t[0],i=t[1],s=t[2],o=t[3];if(r===null)return;var u=r.GetTexture();if(u===null)return;var a=o.GetGLRenderContext();a.enable(e.GL.BLEND),a.disable(e.GL.DEPTH_TEST);var f=void 0,l=void 0,c=void 0,h=void 0;l=i.GetProjection().Transpose(),f=i.GetView().ToMatrix4().Transpose();var p=u.GetOGLObj(a);if(p){c=r.GetRenderWorldMatrix().Multiply(s);var d=r.GetRenderColor();r.GetHardWareVertexBuffer().Bind();var v=o.GetShaderAttributeParameter(e.VSP_POSITION);o.SetVertexAttribPointer(v.location,3,e.GL.FLOAT,0,r.GetVertexOffset()),o.EnableAttributeArray(v.location);var m=o.GetShaderAttributeParameter(e.VSP_TEXCOORDS);o.SetVertexAttribPointer(m.location,2,e.GL.FLOAT,0,r.GetTextureCoordsOffset()),o.EnableAttributeArray(m.location);var g=new Int32Array([0]);o.SetUniformValue(e.FSP_SAMPLER0,g),o.SetUniformValue(e.FSP_DIFFUSE,d),o.SetUniformValue(e.VSP_MODELMAT,c),o.SetUniformValue(e.VSP_VIEWMAT,f),o.SetUniformValue(e.VSP_PROJECTIONMAT,l),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,p),a.drawArrays(a.TRIANGLES,0,6),a.bindTexture(a.TEXTURE_2D,null),r.GetHardWareVertexBuffer().UnBind(),o.DisableAttributeArray(v.location),o.DisableAttributeArray(m.location),a.disable(e.GL.BLEND)}else e.LOGI("Draw Point Error texObj is null")}else{var r=t[0],f=t[1],l=t[2],s=t[3],o=t[4],y=t[5];if(!r)return;var u=r.GetTexture();if(!u)return;var a=o.GetGLRenderContext();a.enable(e.GL.BLEND);var b=0,w=o.GetShaderUniformParameter("u_useMinDepth");y?(a.enable(e.GL.DEPTH_TEST),w&&(b=1,o.SetUniformValue("u_useMinDepth",w.location,b))):(a.disable(e.GL.DEPTH_TEST),w&&(b=0,o.SetUniformValue("u_useMinDepth",w.location,b)));var p=u.GetOGLObj(a);if(p){var c=new e.Matrix4,h=new e.Matrix4;c=s.Multiply(r.GetRenderWorldMatrix());var d=r.GetRenderColor();r.SetCurrentGLContext(a),r.GetHardWareVertexBuffer().Bind();var v=o.GetShaderAttributeParameter(e.VSP_POSITION);o.SetVertexAttribPointer(v.location,3,e.GL.FLOAT,0,r.GetVertexOffset()),o.EnableAttributeArray(v.location);var m=o.GetShaderAttributeParameter(e.VSP_TEXCOORDS);o.SetVertexAttribPointer(m.location,2,e.GL.FLOAT,0,r.GetTextureCoordsOffset()),o.EnableAttributeArray(m.location);var g=0;o.SetUniformValue(e.FSP_SAMPLER0,1,g),o.SetUniformValue(e.FSP_DIFFUSE,d),o.SetUniformValue(e.VSP_MODELMAT,c),o.SetUniformValue(e.VSP_VIEWMAT,f),o.SetUniformValue(e.VSP_PROJECTIONMAT,l),a.activeTexture(e.GL.TEXTURE0),a.bindTexture(e.GL.TEXTURE_2D,p),a.drawArrays(e.GL.TRIANGLES,0,6),a.bindTexture(e.GL.TEXTURE_2D,null),o
.DisableAttributeArray(v.location),o.DisableAttributeArray(m.location),a.disable(e.GL.BLEND)}}},t.DrawMeshBoard=function(t,n,r,i){if(t===null)return;var s=i.GetGLRenderContext(),o,u,a,f;u=n.GetProjection().Transpose(),o=n.GetView().ToMatrix4().Transpose(),a=t.GetRenderWorldMatrix().Multiply(r),t.GetHardWareVertexBuffer().Bind();var l=i.GetShaderAttributeParameter(e.VSP_POSITION);i.SetVertexAttribPointer(l.location,3,e.GL.FLOAT,0,t.GetVertexOffset()),i.EnableAttributeArray(l.location);var c=t.GetRenderColor();i.SetUniformValue(e.FSP_DIFFUSE,c),i.SetUniformValue(e.VSP_MODELMAT,a),i.SetUniformValue(e.VSP_VIEWMAT,o),i.SetUniformValue(e.VSP_PROJECTIONMAT,u),s.drawArrays(e.GL.LINES,0,4),t.GetHardWareVertexBuffer().UnBind(),i.DisableAttributeArray(l.location)},t.DrawPointHandler=function(e,n,r,i){if(!e&&!e.IsVisible())return;var s=e.GetPoint();t.DrawPoint(s,n,r,i)},t.DrawMeshHandler=function(e){},t.DrawBoxRenderPassGroup=function(t,n){if(n.GetRenderableArray().length===0)return;var r=t.GetRenderContext().GetGLRenderContext(),i=t.GetRenderContext(),s=t.GetCamera(),o=t.GetShaderMananger();r.lineWidth(2);var u=o.GetEffect(e.ShaderManager.Edge);u.UseProgram();var a=new e.Vector4(t.clipPlane[0].Clone());a=s.GetView().ToMatrix4().Inverse().Transpose().Multiply(a),u.SetUniformValue(e.FSP_CLIPPLANE,a);var f=new Int32Array([t.enableClip[0]]);u.SetUniformValue(e.FSP_ENABLECLIP,f);var l,c,h,p;c=s.GetProjection().Transpose(),l=s.GetView().ToMatrix4().Transpose();var d=u.GetShaderAttributeParameter(e.VSP_POSITION);u.EnableAttributeArray(d.location),u.SetUniformValue(e.VSP_VIEWMAT,i.GetViewMatrix()),u.SetUniformValue(e.VSP_PROJECTIONMAT,i.GetProjectMatrix());var v=n.GetRenderableArray();for(var m=0,g=v;m<g.length;m++)var y=g[m];u.DisableAttributeArray(d.location),u.ReleaseShaderProgram()},t.DrawRenderActionBox=function(n){if(n.GetRenderBox().Defined()){var r=n.GetRenderContext().GetGLRenderContext(),i=n.GetRenderContext(),s=n.GetCamera(),o=n.GetShaderMananger();r.lineWidth(2);var u=o.GetEffect(e.ShaderManager.Edge);u.UseProgram();var a=new e.Vector4(n.clipPlane[0].Clone());a=s.GetView().ToMatrix4().Inverse().Transpose().Multiply(a),u.SetUniformValue(e.FSP_CLIPPLANE,a);var f=new Int32Array([n.enableClip[0]]);u.SetUniformValue(e.FSP_ENABLECLIP,f);var l=void 0,c=void 0,h=void 0,p=void 0;c=s.GetProjection().Transpose(),l=s.GetView().ToMatrix4().Transpose(),h=e.Matrix4.IDENTITY();var d=u.GetShaderAttributeParameter(e.VSP_POSITION);u.EnableAttributeArray(d.location),u.SetUniformValue(e.VSP_VIEWMAT,i.GetViewMatrix()),u.SetUniformValue(e.VSP_PROJECTIONMAT,i.GetProjectMatrix()),t.DrawShapeBox(n.GetRenderBox(),!1,d,u,h),u.DisableAttributeArray(d.location),u.ReleaseShaderProgram()}},t.DrawShapeBox=function(t,n,r,i,s){var o=i.GetGLRenderContext(),u=!1,a=new e.Color;n?a=e.Parameters.Instance().SelectedColor:a=e.Parameters.Instance().BoxColor;var f=s.Clone();if(t.Defined()){var l=t.GetVertexs(),c=e.BoundingBox.boxIndexs(),h=e.ArrayHelper.ConvertToUInt8Array(c),p=o.createBuffer();o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,p),o.bufferData(o.ELEMENT_ARRAY_BUFFER,h,o.STATIC_DRAW);var d=o.createBuffer();o.bindBuffer(o.ARRAY_BUFFER,d),o.bufferData(o.ARRAY_BUFFER,l,o.STATIC_DRAW),i.SetVertexAttribPointer(r.location,3,e.GL.FLOAT,0,0),i.SetUniformValue(e.FSP_DIFFUSE,a),i.SetUniformValue(e.VSP_MODELMAT,f),o.drawElements(o.LINES,24,o.UNSIGNED_BYTE,0),o.bindBuffer(o.ARRAY_BUFFER,null),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),o.deleteBuffer(p),o.deleteBuffer(d)}},t.DrawNoteRenderPassGroup=function(n,r){if(r.GetRenderableArray().length===0)return;var i=n.GetCamera();if(!i)return;var s=n.GetShaderMananger(),o=r.GetRenderableArray();for(var u=0,a=o;u<a.length;u++){var f=a[u],l=f,c=l.GetType(),h=l.GetRenderWorldMatrix();switch(c){case e.ShapeType.SHAPE_VOICE_NOTE:var p=s.GetEffect(e.ShaderManager.Image);p.UseProgram();var d=new e.Vector4(n.clipPlane[0].Clone());d=i.GetView().ToMatrix4().Inverse().Transpose().Multiply(d),p.SetUniformValue(e.FSP_CLIPPLANE,d);var v=new Int32Array([n.enableClip[0]]);p.SetUniformValue(e.FSP_ENABLECLIP,v);break;case e.ShapeType.SHAPE_TEXT_NOTE:case e.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE:case e.ShapeType.SHAPE_NOTE:t.DrawNote(l,i,s,h);break;case e.ShapeType.SHAPE_MEASURE_BASE:case e.ShapeType.SHAPE_MEASURE_DISTANCE:case e.ShapeType.SHAPE_MEASURE_ANGLE:case e.ShapeType.SHAPE_MEASURE_PROPERTY:t.DrawNote(l,i,s,h)}}},t.DrawNote=function(n,r,i,s){var o=i.GetEffect(e.ShaderManager.Edge);o.UseProgram();var u=i.GetCurrentAction(),a=u.GetRenderContext().GetGLRenderContext(),f=new e.Vector4(u.clipPlane[0].Clone());f=r.GetView().ToMatrix4().Inverse().Transpose().Multiply(f),o.SetUniformValue(e.FSP_CLIPPLANE,f);var l=new Int32Array([u.enableClip[0]]);o.SetUniformValue(e.FSP_ENABLECLIP,l);var c,h,p,d;h=r.GetProjection().Transpose(),c=r.GetView().ToMatrix4().Transpose(),p=s.Clone();var v=o.GetShaderAttributeParameter(e.VSP_POSITION);o.EnableAttributeArray(v.location),o.SetUniformValue(e.VSP_MODELMAT,p),o.SetUniformValue(e.VSP_VIEWMAT,c),o.SetUniformValue(e.VSP_PROJECTIONMAT,h),e.Parameters.Instance().IsShowBox,n.IsFrontShow()?a.disable(e.GL.DEPTH_TEST):a.enable(e.GL.DEPTH_TEST),a.depthMask(!0),a.enable(e.GL.BLEND);var m=n.GetDrawColor();a.lineWidth(4);var g;for(var y=0;y<n.LineList.length;y++){var b=[],w=n.LineList[y];g=w.GetDrawColor();var E=w.GetLineWidth();a.lineWidth(E),w.GetName()==="exLine"&&a.lineWidth(2);var S=2,x=2,T=[w.StartPoint.x,w.StartPoint.y,w.StartPoint.z,w.EndPoint.x,w.EndPoint.y,w.EndPoint.z];b.push(w.StartPoint.x),b.push(w.StartPoint.y),b.push(w.StartPoint.z),b.push(w.EndPoint.x),b.push(w.EndPoint.y),b.push(w.EndPoint.z),w.GetName()==="exLine"&&a.lineWidth(4);var N=a.createBuffer();a.bindBuffer(e.GL.ARRAY_BUFFER,N),a.bufferData(e.GL.ARRAY_BUFFER,e.ArrayHelper.ConvertToFloat32Array(b),e.GL.STATIC_DRAW),o.SetUniformValue(e.FSP_DIFFUSE,g),o.EnableAttributeArray(v.location),o.SetVertexAttribPointer(v.location,3,e.GL.FLOAT,0,0),a.drawArrays(e.GL.LINES,0,b.length/3),o.DisableAttributeArray(v.location),a.deleteBuffer(N)}var C=n.PointList.length;if(C>0){for(var y=0;y<C;y++){var k=n.PointList[y];t.DrawPoint(k,i,r)}o.UseProgram()}var L=n.imageBoardList.length;o.DisableAttributeArray(v.location),o.ReleaseShaderProgram();if(L>0){var A=i.GetEffect(e.ShaderManager.Image);A.UseProgram(),A.SetUniformValue(e.FSP_CLIPPLANE,f),A.SetUniformValue(e.FSP_ENABLECLIP,l);for(var y=0;y<n.imageBoardList.length;y++){var O=n.imageBoardList[y];t.DrawImageBoard(O,r,s,A)}A.ReleaseShaderProgram()}},t.DrawBasePass=function(n,r){var i=n.GetShaderMananger();if(!i)return;var s=n.GetRenderContext().GetGLRenderContext(),o=i.GetEffect(e.ShaderManager.Dragger);if(!o)return;var u=n.GetCamera(),a=u.GetProjection().Transpose(),f=u.GetView().ToMatrix4().Transpose();o.UseProgram(),r.GetRenderableArray().forEach(function(n){var r=n.GetDataLength();if(r>0){var i=n.IsUseIndex(),u=n.GetHardWareVertexBuffer(),l=n.GetHardWareIndexBuffer(),c=u.Bind(),h=o.GetShaderAttributeParameter(e.VSP_POSITION),p=o.GetShaderAttributeParameter(e.VSP_NORMAL),d=n.GetRenderWorldMatrix();o.SetUniformValue(e.VSP_MODELMAT,d),o.SetUniformValue(e.VSP_VIEWMAT,f),o.SetUniformValue(e.VSP_PROJECTIONMAT,a);var v=n.GetRenderColor();o.SetUniformValue(e.VSP_UCOLOR,v);var m=n.GetVertexOffset(),g=n.GetNormalOffset(),y=n.GetTextureCoordsOffset();o.SetVertexAttribPointer(h.location,3,e.GL.FLOAT,0,m),o.SetVertexAttribPointer(p.location,3,e.GL.FLOAT,0,g),o.EnableAttributeArray(h.location),o.EnableAttributeArray(p.location);if(i){var b=n.GetIndexOffset();t.DrawTriWithIndex(s,u,l,r,b)}else t.DrawTriNoIndex(s,u,r);o.DisableAttributeArray(h.location)}}),o.ReleaseShaderProgram()},t.DrawDraggerLinePass=function(t,n){if(n.GetRenderableArray().length===0)return;var r=t.GetRenderContext().GetGLRenderContext();r.lineWidth(2);var i=t.GetShaderMananger();if(!i)return;var s=i.GetEffect(e.ShaderManager.Dragger);s.UseProgram();var o=t.GetCamera(),u=o.GetProjection().Transpose(),a=o.GetView().ToMatrix4().Transpose();s.SetUniformValue(e.VSP_VIEWMAT,a),s.SetUniformValue(e.VSP_PROJECTIONMAT,u);var f=[],l=new e.Matrix4,c=s.GetShaderAttributeParameter(e.VSP_POSITION);s.EnableAttributeArray(c.location);var h=n.GetRenderableArray();for(var p=0;p<h.length;p++){var d=h[p],v=d.GetRenderColor(),m=d.GetHardWareVertexBuffer(),g=d.GetHardWareIndexBuffer();l=l.Multiply(d.GetRenderWorldMatrix());var y=void 0;y=v;var b=d.GetDataLength();if(b){s.SetVertexAttribPointer(c.location,3,e.GL.FLOAT,0,d.GetVertexOffset()),s.SetUniformValue(e.VSP_MODELMAT,l),s.SetUniformValue(e.VSP_UCOLOR,y);var w=d.GetIndexOffset();r.drawArrays(e.GL.LINES,0,b)}}s.DisableAttributeArray(c.location),s.ReleaseShaderProgram()},t.DrawDraggerPass=function(n){n.SetSection(null);var r=n.GetRenderEffect(),i=r.GetRenderableTypeFilter(),s=r.GetRenderQueuePriority(),o=s.GetData(),u=null,a=n.GetDraggerRenderQueueGroup();for(var f=0;f<o.length;f++){u=o[f];var l=a.get(u.GetRenderGroupType().GetType());if(l){l.SetRenderTech(u);var c=l.GetType().GetType();c==e.RenderableType.RGT_SOLID?t.DrawBasePass(n,l):c==e.RenderableType.RGT_TRANSPARENT?t.DrawBasePass(n,l):c==e.RenderableType.RGT_EDGELINE?t.DrawDraggerLinePass(n,l):c==e.RenderableType.RGT_HANDLER&&t.DrawHandlerRenderPassGroup(n,l)}}},t.GetDepthMaterial=function(n,r,i){return t.depthMaterial||(t.depthMaterial=r.GetOrCreateMaterial("DepthMaterial",e.MaterialType.MaterialType_Depth),t.depthMaterial.SetAcceptLight(!1)),t.depthMaterial},t.ShadowRender=function(n,r){if(r.GetRenderableArray().length==0)return;var i=n.GetScene().GetResourceManager(),s=n.GetRenderContext().GetGLRenderContext(),o=n.GetScene().GetLightManager();for(var u=0,a=o.GetAllLight().length;u<a;u++){var f=o.GetAllLight()[u];if(!f.CastShadow())continue;var l=f.GetLightShadow(),c=l.GetCamera();if(!l.RenderTarget()){var h=new e.HardWareFrameBuffer(s);h.SetParameters(1,!1,!1,!0,!1,!1,4),h.setSize(l.GetMapSize().x,l.GetMapSize().y),h.setResourceManager(i),l.SetRenderTarget(h),t.rendT=l.RenderTarget()}var p=0;if(f.GetLightSourceType()==e.LightType.LightType_Directional){p=n.GetScene().GetSceneBox().Length();var d=l;d.SetCameraInfo(p,p*e.NEAR_CLIP_PLANE_FACTOR,p*e.FAR_CLIP_PLANE_FACTOR*3)}var v=l.RenderTarget();t.renderTarget=v,v.reShape(),v.bind(),s.enable(e.GL.DEPTH_TEST),s.depthFunc(e.GL.LEQUAL),s.clearColor(0,0,0,1),s.clear(e.GL.DEPTH_BUFFER_BIT|e.GL.COLOR_BUFFER_BIT|e.GL.STENCIL_BUFFER_BIT);var m=f.GetLightSourceType()===e.LightType.LightType_Point?6:1,g=f.GetLightSourceType()===e.LightType.LightType_Point;for(var y=0;y<m;y++){g||l.Update(f,n.GetCamera(),1),g||s.viewport(0,0,l.GetMapSize().x,l.GetMapSize().x);var b=l.Matrix();s.enable(e.GL.CULL_FACE),s.cullFace(e.GL.FRONT);var w=t.GetDepthMaterial(f,i,g);t.m_currentCamera=null,t.m_currentMaterial=null;var E=r.GetRenderableArray();if(E.length==0)return;for(var S=0;S<E.length;S++){var x=E[S],T=x.GetBody().GetModel().GetWorldBoundingBox();if(c.GetFrustum().IsInsideFast(T)===e.Intersection.OUTSIDE)continue;t.RenderFace(n,x,c,w)}s.disable(e.GL.CULL_FACE)}s.disableVertexAttribArray(0),s.disableVertexAttribArray(1),s.disableVertexAttribArray(2),v.unbind()}var N=n.GetScene().GetCamera(),C=N.GetViewPort().GetRect();s.viewport(C.left,C.top,C.right,C.bottom)},t.DrawHandlerRenderPassGroup=function(n,r){if(r.GetRenderableArray().length===0)return;var i=n.GetRenderContext().GetGLRenderContext();i.enable(e.GL.BLEND),i.disable(e.GL.DEPTH_TEST),i.depthMask(!0);var s=n.GetCamera();if(!s)return;var o=n.GetShaderMananger(),u=r.GetRenderableArray();for(var a=0,f=u;a<f.length;a++){var l=f[a],c=l,h=c.GetType(),p=c.GetRenderWorldMatrix();if(h===e.ShapeType.SHAPE_POINT_HANDLE){var d=c;t.DrawPointHandler(d,o,s,p)}else(h==e.ShapeType.SHAPE_PLANE_HANDLE||h==e.ShapeType.SHAPE_AXIS_HANDLE||h==e.ShapeType.SHAPE_ROTATE_HANDLE||h==e.ShapeType.SHAPE_ROTATECENTER)&&t.DrawMeshHandler(c)}i.disable(e.GL.BLEND),i.depthMask(!0),i.enable(e.GL.DEPTH_TEST)},t.DrawPMISRenderPassGroup=function(n,r){if(r.GetRenderableArray().length==0)return;var i=n.GetCamera();if(!i)return;var s=n.GetShaderMananger(),o=n.GetRenderContext().GetGLRenderContext();o.disable(e.GL.CULL_FACE),o.disable(e.GL.BLEND),o.enable(e.GL.DEPTH_TEST),o.depthMask(!0),o.lineWidth(2);var u=r.GetRenderableArray();for(var a=0,f=u;a<f.length;a++){var l=f[a],c=l,h=c.GetRenderWorldMatrix();t.DrawPMINew(n,c,i,h)}},t.DrawPMINew=function(t,n,r,i){if(n.IsVisible()==0)return;var s=t.GetRenderContext().GetGLRenderContext(),o=t.GetShaderMananger(),u=o.GetEffect(e.ShaderManager.Edge);u.UseProgram();var a,f,l,c;f=r.GetProjection().Transpose(),a=r.GetView().ToMatrix4().Transpose(),l=i.Clone();var h=n.GetDrawColor(),p=u.GetShaderAttributeParameter(e.VSP_POSITION);u.EnableAttributeArray(p.location),u.SetUniformValue(e.VSP_MODELMAT,l),u.SetUniformValue(e.VSP_VIEWMAT,a),u.SetUniformValue(e.VSP_PROJECTIONMAT,f);var d=t.clipPlane[0];d=r.GetView().ToMatrix4().Inverse().Transpose().Multiply(d),u.SetUniformValue(e.FSP_CLIPPLANE,d);var v=new Int32Array([t.enableClip[0]]);u.SetUniformValue(e.FSP_ENABLECLIP,v);if(n.PolyLines.length>0){s.lineWidth(4);var m=[];for(var g=0;g<n.PolyLines.length;g++){var y=n.PolyLines[g];for(var b=0;b<y.GetPoints().length;b++){if(b==0)continue;if(b>0){var w=b-1,E=y.GetPoints()[w];m.push(E.x),m.push(E.y),m.push(E.z)}var S=y.GetPoints()[b];m.push(S.x),m.push(S.y),m.push(S.z)}}var x=s.createBuffer();s.bindBuffer(e.GL.ARRAY_BUFFER,x),s.bufferData(e.GL.ARRAY_BUFFER,e.ArrayHelper.ConvertToFloat32Array(m),e.GL.STATIC_DRAW),u.SetUniformValue(e.FSP_DIFFUSE,h),u.EnableAttributeArray(p.location),u.SetVertexAttribPointer(p.location,3,e.GL.FLOAT,0,0),s.drawArrays(e.GL.LINES,0,m.length/3),u.DisableAttributeArray(p.location),s.deleteBuffer(x)}n.IsParallelScreen&&(l=n.OutFrameMatrix.Multiply(l),u.SetUniformValue(e.VSP_MODELMAT,l)),n.IsParallelScreen?s.disable(e.GL.DEPTH_TEST):s.enable(e.GL.DEPTH_TEST);var T=n.ComTexts;for(var g=0;g<T.length;g++){var N=T[g];if(!N.IsVisible())continue;var C=N.GetMesh(),k=C.GetDataLength()/3;if(k==0)continue;var L=C.GetRefMesh().UseIndex(),A=C.GetRefMesh().GetPositionArray().subarray(C.GetDataOffset(),C.GetDataOffset()+C.dataLength),O=s.createBuffer();s.bindBuffer(e.GL.ARRAY_BUFFER,O),s.bufferData(e.GL.ARRAY_BUFFER,A,e.GL.STATIC_DRAW),u.SetUniformValue(e.FSP_DIFFUSE,h),u.SetUniformValue(e.VSP_MODELMAT,l),u.EnableAttributeArray(p.location),u.SetVertexAttribPointer(p.location,3,e.GL.FLOAT,0,0);if(L){var M=e.ArrayHelper.ConvertToInt16Array(C.GetRefMesh().GetIndexArray()),_=s.createBuffer();s.bindBuffer(e.GL.ELEMENT_ARRAY_BUFFER,_),s.bufferData(e.GL.ELEMENT_ARRAY_BUFFER,M,e.GL.STATIC_DRAW),s.drawElements(e.GL.TRIANGLES,k,e.GL.UNSIGNED_SHORT,0),s.bindBuffer(e.GL.ELEMENT_ARRAY_BUFFER,null)}else s.drawArrays(e.GL.TRIANGLES,0,k);s.bindBuffer(e.GL.ARRAY_BUFFER,null),u.DisableAttributeArray(p.location),s.deleteBuffer(O)}},t.DoSection=function(t,n){var r=t.clipPlane,i=t.enableClip,s=t.GetSection();if(!s)return!1;var o=s.GetPlaneList();if(n){var u=0;for(var a=0;a<o.length;++a,++u){if(!o[a].GetEnable())continue;var f=o[a].GetEquation();r[u].x=f[0],r[u].y=f[1],r[u].z=f[2],r[u].w=f[3],i[u]=1,e.Parameters.Instance().clipPlaneMode==1&&(i[u]=0)}}else{var u=0;for(var a=0;a<o.length;++a,++u)i[u]=0;if(e.Parameters.Instance().showSection)for(var a=0;a<o.length;++a){if(!o[a].GetEnable())continue;this.DrawSectionPlane(t,o[a])}}return s.IsShowCappingPlane()?!0:!1},t.DrawSectionPlane=function(t,n){if(n){var r=t.GetRenderContext().GetGLRenderContext(),i=t.GetCamera();if(!i)return;n.SetCurrentGLContext(r),r.enable(e.GL.DEPTH_TEST),r.lineWidth(1),r.enable(e.GL.BLEND),r.depthMask(!1);var s=void 0,o=void 0,u=new e.Matrix4,a=void 0;o=i.GetProjection().Transpose(),s=i.GetView().ToMatrix4().Transpose();var f=t.GetShaderMananger(),l=f.GetEffect(e.ShaderManager.Edge);l.UseProgram(),l.SetUniformValue(e.VSP_VIEWMAT,s),l.SetUniformValue(e.VSP_PROJECTIONMAT,o),l.SetUniformValue(e.VSP_MODELMAT,u);var c=t.clipPlane[0].Clone();l.SetUniformValue(e.FSP_CLIPPLANE,c);var h=new Int32Array([0]);l.SetUniformValue(e.FSP_ENABLECLIP,h);var p=l.GetShaderAttributeParameter(e.VSP_POSITION);l.EnableAttributeArray(p.location);var d=n.GetFacePositionVBO();d.Bind();var v=n.GetFaceColor();l.SetVertexAttribPointer(p.location,3,e.GL.FLOAT,0,0),l.SetUniformValue(e.FSP_DIFFUSE,v),r.drawArrays(e.GL.TRIANGLES,0,36),d.UnBind(),r.disable(e.GL.BLEND),r.depthMask(!0);var m=n.GetEdgePositionVBO();m.Bind();var g=n.GetEdgeColor();l.SetVertexAttribPointer(p.location,3,e.GL.FLOAT,0,0),l.SetUniformValue(e.FSP_DIFFUSE,g),r.drawArrays(e.GL.LINES,0,24),m.UnBind(),l.DisableAttributeArray(p.location),l.ReleaseShaderProgram()}},t.DrawBackGround=function(t,n){var r=n.GetRenderContext().GetGLRenderContext(),i=t;i.SetCurrentGLContext(r);var s=n.GetShaderMananger();if(!s)return;var o=s.GetEffect(e.ShaderManager.Background);if(!o)return;var u=n.GetCamera(),a=u.GetViewPort().GetRect();u.cameraMode==1?(u.SetAspectRatio(a.Width()/2/a.Height()),r.scissor(a.left,a.top,a.Width()/2,a.Height()),r.viewport(a.left,a.top,a.Width()/2,a.Height())):u.cameraMode==2?(u.SetAspectRatio(a.Width()/2/a.Height()),r.scissor(a.left+a.Width()/2,a.top,a.Width()/2,a.Height()),r.viewport(a.left+a.Width()/2,a.top,a.Width()/2,a.Height())):(u.SetAspectRatio(a.Width()/a.Height()),r.viewport(a.left,a.top,a.Width(),a.Height()));var f=new e.Matrix4,l=new e.Matrix4,c=new e.Matrix4;l.Ortho(i.ProArray[0],i.ProArray[1],i.ProArray[2],i.ProArray[3],i.ProArray[4],i.ProArray[5]),f.ToIdentity(),c.ToIdentity(),r.disable(e.GL.DEPTH_TEST),r.disable(e.GL.BLEND);if(i.IsUseColor()||i.IsUseImage()==0&&i.IsUseSkyBox()==0){o.UseProgram();var h=o.GetShaderAttributeParameter(e.VSP_POSITION),p=o.GetShaderAttributeParameter(e.VSP_COLOR);o.EnableAttributeArray(h.location),o.EnableAttributeArray(p.location);var d=i.GetPositionVBO(),v=i.GetColorVBO();d.Bind(),o.SetVertexAttribPointer(h.location,3,e.GL.FLOAT,0,0),v.Bind(),o.SetVertexAttribPointer(p.location,4,e.GL.FLOAT,0,0);var m=l.Multiply(f);o.SetUniformValue(e.VSP_MVPMAT,m),r.drawArrays(e.GL.TRIANGLES,0,6),d.UnBind(),v.UnBind(),o.DisableAttributeArray(h.location),o.DisableAttributeArray(p.location),o.ReleaseShaderProgram()}else if(i.IsUseSkyBox()||e.Parameters.Instance().cubeMode){r.enable(e.GL.DEPTH_TEST),r.depthMask(!1),o=s.GetEffect(e.ShaderManager.CubeMap),o.UseProgram();var g=n.GetCamera(),y=i.GetSkyBoxTexture();if(!y)return;if(y){var b=y.GetOGLObj(r);if(b){var h=o.GetShaderAttributeParameter(e.VSP_POSITION);o.EnableAttributeArray(h.location);var d=i.GetSkyBoxVertexVBO();d.Bind(),o.SetVertexAttribPointer(h.location,3,e.GL.FLOAT,0,0);var w=new Int32Array([0]),E=new e.Matrix4(g.GetView().ToMatrix3()),S=new e.Camera;S.SetFov(90),S.SetNearClip(.1),S.SetFarClip(100),S.SetAspectRatio(g.GetAspectRatio()),S.SetOrthographic(!1);var x=S.GetProjection().Clone();x.TransposeED(),o.SetUniformValue(e.FSP_SAMPLERCUBE0,w),o.SetUniformValue(e.VSP_MODELMAT,c),o.SetUniformValue(e.VSP_VIEWMAT,E.Transpose()),o.SetUniformValue(e.VSP_PROJECTIONMAT,x),r.activeTexture(e.GL.TEXTURE0),r.bindTexture(e.GL.TEXTURE_CUBE_MAP,b),r.drawArrays(e.GL.TRIANGLES,0,36),r.bindTexture(e.GL.TEXTURE_CUBE_MAP,null),o.DisableAttributeArray(h.location),o.ReleaseShaderProgram()}}r.depthMask(!0),r.disable(e.GL.DEPTH_TEST)}else if(i.IsUseImage()){o=s.GetEffect(e.ShaderManager.Image),o.UseProgram();var y=i.GetTexture(n);if(y){var b=y.GetOGLObj(r);if(b){var T=new e.Color(1,1,1,1),h=o.GetShaderAttributeParameter(e.VSP_POSITION),N=o.GetShaderAttributeParameter(e.VSP_TEXCOORDS);o.EnableAttributeArray(h.location),o.EnableAttributeArray(N.location);var d=i.GetBackImagePositionVBO(),C=i.GetTexCoordsVBO();d.Bind(),o.SetVertexAttribPointer(h.location,3,e.GL.FLOAT,0,0),C.Bind(),o.SetVertexAttribPointer(N.location,2,e.GL.FLOAT,0,0);var w=new Int32Array([0]);o.SetUniformValue(e.FSP_SAMPLER0,w),o.SetUniformValue(e.FSP_DIFFUSE,T),o.SetUniformValue(e.VSP_MODELMAT,c),o.SetUniformValue(e.VSP_VIEWMAT,f),o.SetUniformValue(e.VSP_PROJECTIONMAT,l),r.activeTexture(e.GL.TEXTURE0),r.bindTexture(e.GL.TEXTURE_2D,b),r.drawArrays(e.GL.TRIANGLES,0,6),r.bindTexture(e.GL.TEXTURE_2D,null),o.DisableAttributeArray(h.location),o.DisableAttributeArray(N.location),o.ReleaseShaderProgram()}}}r.disable(e.GL.BLEND),r.enable(e.GL.DEPTH_TEST)},t.ApplyCamera=function(e){var t=e.GetRenderContext(),n,r,i=e.GetCamera();if(!i)return;var s=i.GetViewPort().rect,o=t.GetGLRenderContext();i.cameraMode==1?(i.SetAspectRatio(s.Width()/2/s.Height()),o.scissor(s.left,s.top,s.Width()/2,s.Height()),o.viewport(s.left,s.top,s.Width()/2,s.Height())):i.cameraMode==2?(i.SetAspectRatio(s.Width()/2/s.Height()),o.scissor(s.left+s.Width()/2,s.top,s.Width()/2,s.Height()),o.viewport(s.left+s.Width()/2,s.top,s.Width()/2,s.Height())):(i.SetAspectRatio(s.Width()/s.Height()),o.viewport(s.left,s.top,s.Width(),s.Height())),n=i.GetProjection().Transpose(),r=i.GetView().ToMatrix4().TransposeED(),t.SetProjectMatrix(n),t.SetViewMatrix(r)},t.DrawTriWithIndex=function(t,n,r,i,s){r.Bind(),t.drawElements(e.GL.TRIANGLES,i,e.GL.UNSIGNED_SHORT,s),r.UnBind()},t.DrawTriNoIndex=function(t,n,r){t.drawArrays(e.GL.TRIANGLES,0,r)},t.DrawPhongPass=function(n){var r=n.GetRenderEffect(),i=r.GetRenderableTypeFilter(),s=r.GetRenderQueuePriority(),o=s.GetData(),u=n.GetRenderQueueGroup();for(var a=0,f=o;a<f.length;a++){var l=f[a],c=u.get(l.GetRenderGroupType().GetType());if(c!==undefined){c.SetRenderTech(l);var h=c.GetType().GetType();h===e.RenderableType.RGT_SHADOW?e.Parameters.Instance().m_shadowMapEnabled&&t.ShadowRender(n,c):h===e.RenderableType.RGT_SOLID?t.DrawSolidRenderPassGroup(n,c):h===e.RenderableType.RGT_POINT?t.DrawPointPassGroup(n,c):h===e.RenderableType.RGT_TRANSPARENT?t.DrawTranRenderPassGroup(n,c):h===e.RenderableType.RGT_EDGELINE?t.DrawEdgesRenderPassGroup(n,c):h!==e.RenderableType.RGT_EDGELINEINTOP&&(h===e.RenderableType.RGT_PMI?t.DrawPMISRenderPassGroup(n,c):h===e.RenderableType.RGT_TRILINE?t.DrawTriLineRenderPassGroup(n,c):h===e.RenderableType.RGT_NOTE?t.DrawNoteRenderPassGroup(n,c):h!==e.RenderableType.RGT_MEASURE&&(h===e.RenderableType.RGT_HANDLER?t.DrawHandlerRenderPassGroup(n,c):h===e.RenderableType.RGT_INTOP&&(e.Parameters.Instance().selectedStyle===1?t.DrawOutlinePassGroup(n,c):e.Parameters.Instance().selectedStyle===2?t.DrawINTOPRenderPassGroup(n,c):e.Parameters.Instance().selectedStyle===3)))}}t.DrawImageBoardQueue(n),t.DrawRenderActionBox(n)},t.GetResourceManager=function(e){return e.GetScene().GetResourceManager()},t.DrawINTOPRenderPassGroup1=function(n,r){if(r.GetRenderableArray().length===0)return;var i=n.GetRenderContext(),s=i.GetGLRenderContext(),o=n.GetCamera(),u=o.GetViewPort().GetRect(),a=n.GetShaderMananger().GetEffect(e.ShaderManager.Outline);a.UseProgram();var f=a.GetShaderAttributeParameter(e.VSP_POSITION),l=a.GetShaderAttributeParameter(e.VSP_NORMAL);a.EnableAttributeArray(f.location),a.SetUniformValue(e.VSP_VIEWMAT,i.GetViewMatrix()),a.SetUniformValue(e.VSP_PROJECTIONMAT,i.GetProjectMatrix());var c=n.clipPlane[0].Clone(),h=i.GetViewMatrix();c=h.Inverse().Multiply(c),a.SetUniformValue(e.FSP_CLIPPLANE,c);var p=new Int32Array([n.enableClip[0]]);a.SetUniformValue(e.FSP_ENABLECLIP,p);var d=new e.Matrix4,v=r.GetRenderableArray(),m=i.GetViewMatrix(),g=new e.Matrix4,y=new e.Matrix4;s.colorMask(!1,!1,!1,!1),s.enable(e.GL.STENCIL_TEST),s.clearStencil(0),s.stencilFunc(e.GL.ALWAYS,1,1),s.stencilOp(e.GL.KEEP,e.GL.KEEP,e.GL.REPLACE),s.disable(e.GL.DEPTH_TEST);for(var b=-2;b<4;b+=4)for(var w=0,E=v;w<E.length;w++){var S=E[w],x=S.GetDataLength(),T=S.IsUseIndex(),N=S.GetHardWareVertexBuffer(),C=S.GetHardWareIndexBuffer();d=S.GetRenderWorldMatrix(),d.MultiplyMat4(m,g),y=g.InverseED().TransposeED(),N.Bind();var k=S.GetVertexOffset(),L=S.GetNormalOffset(),A=S.GetTextureCoordsOffset(),O=S.GetCentersCoordsOffset(),M=S.GetRenderColor();a.SetVertexAttribPointer(f.location,3,e.GL.FLOAT,0,k),a.SetUniformValue(e.VSP_MODELMAT,d),a.SetUniformValue(e.VSP_NORMALMAT,y),s.viewport(u.left+b,u.top,u.Width()+b,u.Height());if(x>0){a.SetUniformValue(e.FSP_DIFFUSE,M);if(T){var _=S.GetIndexOffset();t.DrawTriWithIndex(s,N,C,x,_)}else t.DrawTriNoIndex(s,N,x)}}for(var b=-2;b<4;b+=4)for(var D=0,P=v;D<P.length;D++){var S=P[D],x=S.GetDataLength(),T=S.IsUseIndex(),N=S.GetHardWareVertexBuffer(),C=S.GetHardWareIndexBuffer();d=S.GetRenderWorldMatrix(),d.MultiplyMat4(m,g),y=g.InverseED().TransposeED(),N.Bind();var k=S.GetVertexOffset(),L=S.GetNormalOffset(),A=S.GetTextureCoordsOffset(),O=S.GetCentersCoordsOffset(),M=S.GetRenderColor();a.SetVertexAttribPointer(f.location,3,e.GL.FLOAT,0,k),a.SetUniformValue(e.VSP_MODELMAT,d),a.SetUniformValue(e.VSP_NORMALMAT,y);for(var H=-2;H<4;H+=4){s.viewport(u.left,u.top+H,u.Width(),u.Height()+H);if(x>0){a.SetUniformValue(e.FSP_DIFFUSE,M);if(T){var _=S.GetIndexOffset();t.DrawTriWithIndex(s,N,C,x,_)}else t.DrawTriNoIndex(s,N,x)}}}s.viewport(u.left,u.top,u.Width(),u.Height()),s.stencilFunc(e.GL.ALWAYS,0,0);for(var B=0,j=v;B<j.length;B++){var S=j[B],x=S.GetDataLength(),T=S.IsUseIndex(),N=S.GetHardWareVertexBuffer(),C=S.GetHardWareIndexBuffer();d=S.GetRenderWorldMatrix(),d.MultiplyMat4(m,g),y=g.InverseED().TransposeED(),N.Bind();var k=S.GetVertexOffset(),L=S.GetNormalOffset(),A=S.GetTextureCoordsOffset(),O=S.GetCentersCoordsOffset(),M=S.GetRenderColor();a.SetVertexAttribPointer(f.location,3,e.GL.FLOAT,0,k),a.SetUniformValue(e.VSP_MODELMAT,d),a.SetUniformValue(e.VSP_NORMALMAT,y);if(x>0){a.SetUniformValue(e.FSP_DIFFUSE,M);if(T){var _=S.GetIndexOffset();t.DrawTriWithIndex(s,N,C,x,_)}else t.DrawTriNoIndex(s,N,x)}}s.colorMask(!0,!0,!0,!0),s.stencilFunc(e.GL.EQUAL,1,1),t.DrawQuad(n),s.enable(e.GL.DEPTH_TEST),s.disable(e.GL.STENCIL_TEST),a.DisableAttributeArray(f.location),a.ReleaseShaderProgram(),s.polygonOffset(0,0),s.disable(e.GL.POLYGON_OFFSET_FILL),s.disable(e.GL.CULL_FACE),s.enable(e.GL.DEPTH_TEST)},t.DrawOutlinePassGroup=function(t,n){if(n.GetRenderableArray().length===0)return;var r=t.GetRenderManager().GetEffectManager(),i=r.getEffect("OUTLINEEFFECT");i.Render(n);var s=i.GetOutlineTexture(),o=t.GetRenderContext(),u=o.GetGLRenderContext();u.disable(e.GL.DEPTH_TEST),u.enable(e.GL.BLEND),u.blendEquationSeparate(u.FUNC_ADD,u.FUNC_ADD),u.blendFuncSeparate(e.GL.ONE,e.GL.ONE_MINUS_SRC_ALPHA,u.ONE,u.ONE_MINUS_SRC_ALPHA);var a=t.GetCamera(),f=a.GetViewPort().GetRect();u.viewport(f.left,f.top,f.right,f.bottom);var l=1/f.right,c=1/f.bottom,h=t.GetShaderMananger().GetEffect(e.ShaderManager.CombineOutline);h.UseProgram();var p=h.GetShaderAttributeParameter(e.VSP_POSITION),d=r.GetQuadVBO().vertex;u.bindBuffer(u.ARRAY_BUFFER,d),h.EnableAttributeArray(p.location),h.SetVertexAttribPointer(p.location,3,e.GL.FLOAT,0,0);var v=h.GetShaderAttributeParameter(e.VSP_TEXCOORDS),m=r.GetQuadVBO().texcoords;u.bindBuffer(u.ARRAY_BUFFER,m),h.EnableAttributeArray(v.location),h.SetVertexAttribPointer(v.location,2,e.GL.FLOAT,0,0);var g=new e.Matrix4,y=new e.Matrix4,b=new e.Matrix4,w=new Int32Array([0]);h.SetUniformValue(e.FSP_SAMPLER0,w),u.activeTexture(u.TEXTURE0),s&&u.bindTexture(u.TEXTURE_2D,s.GetOGLObj(u)),u.drawArrays(e.GL.TRIANGLE_STRIP,0,4),u.activeTexture(e.GL.TEXTURE0),u.bindTexture(u.TEXTURE_2D,null),h.DisableAttributeArray(p.location),h.DisableAttributeArray(v.location),h.ReleaseShaderProgram(),u.bindBuffer(e.GL.ARRAY_BUFFER,null),u.disable(e.GL.BLEND),u.blendEquationSeparate(u.FUNC_ADD,u.FUNC_ADD),u.blendFuncSeparate(u.SRC_ALPHA,u.ONE_MINUS_SRC_ALPHA,u.ONE,u.ONE_MINUS_SRC_ALPHA),u.enable(e.GL.DEPTH_TEST)},t.DrawINTOPRenderPassGroup=function(n,r){if(r.GetRenderableArray().length===0)return;var i=n.GetRenderContext(),s=i.GetGLRenderContext(),o=n.GetCamera(),u=o.GetViewPort().GetRect(),a=n.GetShaderMananger().GetEffect(e.ShaderManager.Edge);a.UseProgram();var f=a.GetShaderAttributeParameter(e.VSP_POSITION);a.EnableAttributeArray(f.location),a.SetUniformValue(e.VSP_VIEWMAT,i.GetViewMatrix()),a.SetUniformValue(e.VSP_PROJECTIONMAT,i.GetProjectMatrix());var l=n.clipPlane[0].Clone(),c=i.GetViewMatrix();l=c.Inverse().Multiply(l),a.SetUniformValue(e.FSP_CLIPPLANE,l);var h=new Int32Array([n.enableClip[0]]);a.SetUniformValue(e.FSP_ENABLECLIP,h);var p=new e.Matrix4,d=r.GetRenderableArray(),v=i.GetViewMatrix(),m=new e.Matrix4,g=new e.Matrix4;s.disable(e.GL.DEPTH_TEST),s.depthFunc(e.GL.LEQUAL),s.enable(s.BLEND);for(var y=0,b=d;y<b.length;y++){var w=b[y],E=w.GetDataLength(),S=w.IsUseIndex(),x=w.GetHardWareVertexBuffer(),T=w.GetHardWareIndexBuffer();p=w.GetRenderWorldMatrix(),p.MultiplyMat4(v,m),g=m.InverseED().TransposeED(),x.Bind();var N=w.GetVertexOffset(),C=w.GetRenderColor();a.SetVertexAttribPointer(f.location,3,e.GL.FLOAT,0,N),a.SetUniformValue(e.VSP_MODELMAT,p);var k=new e.Color(C.r,C.g,C.b,.3);if(E>0){a.SetUniformValue(e.FSP_DIFFUSE,k);if(S){var L=w.GetIndexOffset();t.DrawTriWithIndex(s,x,T,E,L)}else t.DrawTriNoIndex(s,x,E)}}a.DisableAttributeArray(f.location),a.ReleaseShaderProgram(),s.enable(e.GL.DEPTH_TEST),s.disable(s.BLEND)},t.RenderFaces=function(n,r,i){if(r.GetRenderableArray().length==0)return;t.m_currentCamera=null,t.m_currentMaterial=null;var s=n.GetRenderContext(),o=s.GetGLRenderContext(),u=n.GetScene().GetResourceManager(),a=n.GetScene().GetLightManager(),f=n.GetCamera();a.SetUp(f);var l=r.GetRenderableArray();for(var c=0;c<l.length;c++){var h=l[c];this.RenderFace(n,h,f,null)}o.disableVertexAttribArray(0),o.disableVertexAttribArray(1),o.disableVertexAttribArray(2),t.m_shadowState=e.Parameters.Instance().m_shadowMapEnabled},t.SetProgram=function(n,r,i,s,o){t._usedTextureUnits=0;var u=n.GetScene(),a=u.GetLightManager(),f=!1,l=!1,c=!1,h=o;h.NeedUpdate()||(h.GetProgram()?h.AcceptLight()&&h.LightHash()!==a.GetState().hash&&h.SetNeedUpdate(!0):h.SetNeedUpdate(!0)),t.m_shadowState!=e.Parameters.Instance().m_shadowMapEnabled&&h.SetNeedUpdate(!0),h.NeedUpdate()&&(this.InitMaterial(n,h,n.GetShaderMananger()),h.SetNeedUpdate(!1),f=!0);var p=null;p=h.GetProgram(),p&&p.UseProgram();var d=e.UniformHelper.GetUniformListMaps(p.GetName()),v=n.GetRenderContext();t.m_currentProgram!=p&&(l=!0,c=!0,f=!0,t.m_currentProgram=p),h!=t.m_currentMaterial&&(c=!0,t.m_currentMaterial=h);var m=s.GetView().ToMatrix4().Transpose(),g=s.GetProjection().Transpose(),y=n.clipPlane[0].Clone(),b=m.Clone();y=b.Inverse().Multiply(y);var w=n.enableClip[0];e.UniformHelper.SetUniformValueToMap(d,e.FSP_ENABLECLIP,"Bool",w),e.UniformHelper.SetUniformValueToMap(d,e.FSP_CLIPPLANE,"Vector4",y);var E=p.GetShaderUniformParameter(e.FSP_REVERSECLIP);E&&p.SetUniformValue(e.FSP_REVERSECLIP,E.location,n.m_bReverseClip?1:0),p.SetUniformValue(e.VIEW_MATRXI,m),p.SetUniformValue(e.PROJECTION_MATRXI,g);if(l||s!=t.m_currentCamera){t.m_currentCamera=s,c=!0,f=!0;if(h.GetMaterialType()==e.MaterialType.MaterialType_Shader||h.GetMaterialType()==e.MaterialType.MaterialType_Phong||h.GetMaterialType()==e.MaterialType.MaterialType_Pbr||h.GetMaterialType()==e.MaterialType.MaterialType_MatCap){var S=s.GetPosition();p.SetUniformValue(e.CAMERA_POSITION,S)}}if(c){var x=r;if(h.GetUseLight()&&f){var T=a.GetAllLight(),N=a.GetState(),C=0,k=0,L=0,A=0;p.SetUniformValue(e.AMBIENT_LIGHT_COLOR,N.ambient);if(e.Parameters.Instance().m_shadowMapEnabled){if(d.directionalShadowMap!==undefined&&d.directionalShadowMap!==null){var O=d.directionalShadowMap.value;O=[],e.UniformHelper.SetUniformValueToMap(d,"directionalShadowMap","Texture2DArray",O)}if(d.directionalShadowMatrix!==undefined&&d.directionalShadowMatrix!==null){var O=d.directionalShadowMatrix.value;O=[],e.UniformHelper.SetUniformValueToMap(d,"directionalShadowMatrix","Matrix4Array",O)}}for(var M=0,_=T.length;M<_;M++){var D=T[M];if(!D.IsTurnOn())continue;var P=D.GetLightSourceType(),H=null,B=D.GetIntensity(),j=D.GetLightColor();if(P==e.LightType.LightType_Directional){var F=D.GetLightShadow();H=N.directional[C];var I=H,q="directionalLights["+C.toString()+"]";p.SetUniformValue(q+".color",I.color),p.SetUniformValue(q+".direction",I.direction),p.SetUniformValue(q+".shadow",I.shadow===0?!1:!0);if(D.CastShadow()&&e.Parameters.Instance().m_shadowMapEnabled){p.SetUniformValue(q+".shadowBias",I.shadowBias),p.SetUniformValue(q+".shadowRadius",I.shadowRadius),p.SetUniformValue(q+".shadowMapSize",I.shadowMapSize);if(d.directionalShadowMap===undefined||d.directionalShadowMap===null){var O=[];F.RenderTarget()&&O.push(F.RenderTarget().GetColorTarget(0)),e.UniformHelper.SetUniformValueToMap(d,"directionalShadowMap","Texture2DArray",O)}else{var O=d.directionalShadowMap.value;F.RenderTarget()&&O.push(F.RenderTarget().GetColorTarget(0)),e.UniformHelper.SetUniformValueToMap(d,"directionalShadowMap","Texture2DArray",O)}if(d.directionalShadowMatrix===undefined||d.directionalShadowMatrix===null){var O=[];F.Matrix()&&O.push(F.Matrix().Transpose()),e.UniformHelper.SetUniformValueToMap(d,"directionalShadowMatrix","Matrix4Array",O)}else{var O=d.directionalShadowMatrix.value;F.Matrix()&&O.push(F.Matrix().Transpose()),e.UniformHelper.SetUniformValueToMap(d,"directionalShadowMatrix","Matrix4Array",O)}}D.SetNeedUpdateInfo(!1),C++}else if(P==e.LightType.LightType_Point){H=N.point[k];var R=H,q="pointLights["+k.toString()+"]"
;p.SetUniformValue(q+".color",R.color),p.SetUniformValue(q+".position",R.position),p.SetUniformValue(q+".distance",R.distance),p.SetUniformValue(q+".decay",R.decay),p.SetUniformValue(q+".shadow",R.shadow===0?!1:!0),D.SetNeedUpdateInfo(!1),k++}else if(P==e.LightType.LightType_Spot){H=N.spot[L];var U=H,q="spotLights["+L.toString()+"]";p.SetUniformValue(q+".color",U.color),p.SetUniformValue(q+".position",U.position),p.SetUniformValue(q+".direction",U.direction),p.SetUniformValue(q+".distance",U.distance),p.SetUniformValue(q+".decay",U.decay),p.SetUniformValue(q+".coneCos",U.coneCos),p.SetUniformValue(q+".penumbraCos",U.penumbraCos),p.SetUniformValue(q+".shadow",U.shadow===0?!1:!0),D.SetNeedUpdateInfo(!1),L++}else if(P==e.LightType.LightType_Hemisphere){H=N.hemisphere[A];var z=H,q="hemisphereLights["+A.toString()+"]";p.SetUniformValue(q+".skyColor",z.skyColor),p.SetUniformValue(q+".groundColor",z.groundColor),p.SetUniformValue(q+".direction",z.direction),D.SetNeedUpdateInfo(!1),A++}}}if(h.GetMaterialType()==e.MaterialType.MaterialType_Phong||h.GetMaterialType()==e.MaterialType.MaterialType_Pbr){var W=h,X=W.GetUvTransform().Transpose();p.SetUniformValue(e.UV_TRANSFORM_MATRIX,X)}h.GetMaterialType()==e.MaterialType.MaterialType_Phong&&t.RefreshUniformsPhong(n,d,h),h.GetMaterialType()==e.MaterialType.MaterialType_Pbr?t.RefreshUniformsPbr(n,d,h):h.GetMaterialType()==e.MaterialType.MaterialType_MatCap&&t.RefreshUniformsMatCap(n,d,h),e.Parameters.Instance().m_useSSAO,h.GetProgram().SetUniformValue(e.OPACITY,x.GetColorAlpha()),e.UniformHelper.UpdateUniform(n,i,p,p.GetShaderUniformMap(),d)}var V=r.GetRenderWorldMatrix().Clone(),$=V.Multiply(s.GetView().ToMatrix4().Transpose()).Inverse().Transpose();p.SetUniformValue(e.MODEL_MATRXI,V),p.SetUniformValue(e.NORMAL_MATRXI,$);var J=r.GetAlpha(),K=new e.Color(1,1,1,J),Q=r,G=Q.GetDrawColor();return h.GetProgram().SetUniformValue(e.DIFFUSE,G),!e.Parameters.Instance().IsShowBox&&Q.IsSelected()&&e.Parameters.Instance().selectedStyle!==1?(K=new e.Color(e.Color.SelectColor().r,e.Color.SelectColor().g,e.Color.SelectColor().b,J),p.SetUniformValue("selected",1)):p.SetUniformValue("selected",0),p.SetUniformValue(e.FSP_SELECTCOLOR,K),p},t.InitMaterial=function(t,n,r){var i=t.GetScene().GetResourceManager(),s=t.GetRenderContext(),o=s.GetGLRenderContext(),u=t.GetScene().GetLightManager();r.CreateParameters(n,u);var a=r.GetProgramCode(n),f=n.GetProgram(),l=!0;!f||(f.GetName()!=a?n.SetProgram(null):l=!1);var c="",h="",p="";if(l){if(n.GetMaterialType()==e.MaterialType.MaterialType_Shader){var d=n;h=d.VertexShader(),p=d.FragmentShader()}else c=n.GetMaterialType()==e.MaterialType.MaterialType_Phong?"PhongMaterial":n.GetMaterialType()==e.MaterialType.MaterialType_Pbr?"PbrMaterial":n.GetMaterialType()==e.MaterialType.MaterialType_MatCap?"MatCapMaterial":n.GetMaterialType()==e.MaterialType.MaterialType_Depth?"DepthMaterial":null,h=e.ShaderLib[c].VertexShader,p=e.ShaderLib[c].FragmentShader;n.SetLightHash(u.GetState().hash),f=r.AcquireProgram(n,h,p,a),n.SetProgram(f)}},t.RefreshUniformsMatCap=function(t,n,r){r&&n&&(r.GetProgram().SetUniformValue(e.SPECULAR,r.GetSpecular()),r.GetProgram().SetUniformValue(e.EMISSIVE,r.GetEmissive()),r.GetProgram().SetUniformValue(e.SHININESS,r.GetShininess()),r.GetNormalMap()&&(e.UniformHelper.SetUniformValueToMap(n,e.NORMAL_MAP,"Texture2D",r.GetNormalMap()),e.UniformHelper.SetUniformValueToMap(n,e.NORMAL_MAP_SCALE,"Vector2",r.GetNormalMapScale())),r.GetMatcapMap()&&e.UniformHelper.SetUniformValueToMap(n,e.MATCAP_MAP,"Texture2D",r.GetMatcapMap()))},t.RefreshUniformsPhong=function(t,n,r){r&&n&&(r.GetProgram().SetUniformValue(e.SPECULAR,r.GetSpecular()),r.GetProgram().SetUniformValue(e.EMISSIVE,r.GetEmissive()),r.GetProgram().SetUniformValue(e.SHININESS,r.GetShininess()),r.GetEmissiveMap()&&e.UniformHelper.SetUniformValueToMap(n,e.EMISSIVE_MAP,"Texture2D",r.GetEmissiveMap()),r.GetDiffuseMap()&&e.UniformHelper.SetUniformValueToMap(n,e.DIFFUSE_TEXTURE,"Texture2D",r.GetDiffuseMap()),r.GetSpecularMap()&&e.UniformHelper.SetUniformValueToMap(n,e.SPECULAR_MAP,"Texture2D",r.GetSpecularMap()),r.GetNormalMap()&&(e.UniformHelper.SetUniformValueToMap(n,e.NORMAL_MAP,"Texture2D",r.GetNormalMap()),e.UniformHelper.SetUniformValueToMap(n,e.NORMAL_MAP_SCALE,"Vector2",r.GetNormalMapScale())),r.GetDisplacementMap()&&(e.UniformHelper.SetUniformValueToMap(n,e.DISPLACEMENT_MAP,"Texture2D",r.GetDisplacementMap()),e.UniformHelper.SetUniformValueToMap(n,e.DISPLACEMENT_SCALE,"Float",r.GetDisplacementScale()),e.UniformHelper.SetUniformValueToMap(n,e.DISPLACEMENT_BIAS,"Float",r.GetDisplacementBias())))},t.RefreshUniformsPbr=function(t,n,r){var i=t.GetScene().GetResourceManager();if(r&&n){var s=t.GetScene().GetSceneBox(),o=s.Center(),u=s.min,a=s.max,f=s.Length(),l=new e.Vector3(f/2,f/2,f/2),c=o.Sub(l),h=o.Add(l);r.GetProgram().SetUniformValue("cubeMapWorldPosition",o),r.GetProgram().SetUniformValue("boxMin",c),r.GetProgram().SetUniformValue("boxMax",h),r.GetProgram().SetUniformValue(e.EMISSIVE,r.EmissiveColor()),r.GetProgram().SetUniformValue(e.ROUGHNESS,r.RougthnessFactor()),r.GetProgram().SetUniformValue(e.METALNESS,r.MetalnessFactor()),r.GetProgram().SetUniformValue(e.GAMMA,e.Parameters.Instance().m_gammaFactor),r.GetProgram().SetUniformValue(e.TONE_MAPPING_EXPOSURE,e.Parameters.Instance().m_toneMappingExposure),r.UseClearCoat()&&(r.GetProgram().SetUniformValue(e.CLEARCOAT,r.ClearCoat()),r.GetProgram().SetUniformValue(e.CLEARCOATROUGHNESS,r.ClearCoatRoughness())),r.AlbedoMap()&&e.UniformHelper.SetUniformValueToMap(n,e.DIFFUSE_TEXTURE,"Texture2D",r.AlbedoMap());if(r.EnvMap())e.UniformHelper.SetUniformValueToMap(n,e.ENV_TEXTURE,"TextureCube",r.EnvMap()),e.UniformHelper.SetUniformValueToMap(n,e.ENV_MAP_INTENSITY,"Float",r.EnvMapIntensity());else{var p=i.GetDefaultPBRSpecularTexture();r.SetEnvMap(p),e.UniformHelper.SetUniformValueToMap(n,e.ENV_TEXTURE,"TextureCube",p),e.UniformHelper.SetUniformValueToMap(n,e.ENV_MAP_INTENSITY,"Float",r.EnvMapIntensity())}if(r.EnvIrradianceMap())e.UniformHelper.SetUniformValueToMap(n,e.ENV_DIFFUSE_TEXTURE,"TextureCube",r.EnvIrradianceMap());else{var p=i.GetDefaultPBRDiffuseTexture();r.SetEnvIrradianceMap(p),e.UniformHelper.SetUniformValueToMap(n,e.ENV_DIFFUSE_TEXTURE,"TextureCube",p)}r.EmissiveMap()&&e.UniformHelper.SetUniformValueToMap(n,e.EMISSIVE_MAP,"Texture2D",r.EmissiveMap()),r.AmbientOcclusiontMap()&&(r.GetProgram().SetUniformValue(e.AO_MAP_INTENSITY,r.AoMapIntensity()),e.UniformHelper.SetUniformValueToMap(n,e.AO_MAP,"Texture2D",r.AmbientOcclusiontMap())),r.NormalMap()&&(e.UniformHelper.SetUniformValueToMap(n,e.NORMAL_MAP,"Texture2D",r.NormalMap()),e.UniformHelper.SetUniformValueToMap(n,e.NORMAL_MAP_SCALE,"Vector2",r.NormalMapScale())),r.DisplacementMap()&&(e.UniformHelper.SetUniformValueToMap(n,e.DISPLACEMENT_MAP,"Texture2D",r.DisplacementMap()),e.UniformHelper.SetUniformValueToMap(n,e.DISPLACEMENT_SCALE,"Float",r.DisplacementScale()),e.UniformHelper.SetUniformValueToMap(n,e.DISPLACEMENT_BIAS,"Float",r.DisplacementBias())),r.MetalnessRoughnessMap()&&e.UniformHelper.SetUniformValueToMap(n,e.METALLIC_ROUGHNESS_TEXTURE,"Texture2D",r.MetalnessRoughnessMap()),e.UniformHelper.SetUniformValueToMap(n,e.LUT,"Texture2D",i.GetDefaultPBRLUTTexture())}},t.RenderFace=function(n,r,i,s){var o=n.GetRenderContext(),u=o.GetGLRenderContext(),a=r,f=s===null||s===undefined?a.GetMaterial():s,l={},c=this.SetProgram(n,r,l,i,f),h=c.GetShaderAttributeParameter(e.VSP_POSITION),p=c.GetShaderAttributeParameter(e.VSP_NORMAL),d=c.GetShaderAttributeParameter(e.VSP_TEXCOORDS);c.EnableAttributeArray(h.location),p&&c.EnableAttributeArray(p.location),d&&c.EnableAttributeArray(d.location);var v=r.GetDataLength(),m=r.IsUseIndex(),g=r.GetHardWareVertexBuffer(),y=r.GetHardWareIndexBuffer();g.Bind();var b=r.GetVertexOffset(),w=r.GetNormalOffset(),E=r.GetTextureCoordsOffset();!E&&d&&c.DisableAttributeArray(d.location),c.SetVertexAttribPointer(h.location,3,e.GL.FLOAT,0,b),p&&c.SetVertexAttribPointer(p.location,3,e.GL.FLOAT,0,w),d&&E&&c.SetVertexAttribPointer(d.location,3,e.GL.FLOAT,0,E);if(m){var S=r.GetIndexOffset();t.DrawTriWithIndex(u,g,y,v,S)}else t.DrawTriNoIndex(u,g,v);g.UnBind();if(f!=t.m_currentMaterial)for(var x in l){var T=l[x];u.activeTexture(e.GL.TEXTURE0+parseInt(x)),u.bindTexture(T,null)}},t.DrawPhongPassGroup=function(n,r){if(r.GetRenderableArray().length===0)return;var i=n.GetRenderContext(),s=i.GetGLRenderContext(),o=n.GetCamera(),u=n.GetShaderMananger().GetEffect(e.ShaderManager.MeshPhong);u.UseProgram();var a=u.GetShaderAttributeParameter(e.VSP_POSITION),f=u.GetShaderAttributeParameter(e.VSP_NORMAL),l=u.GetShaderAttributeParameter(e.VSP_TEXCOORDS),c=u.GetShaderAttributeParameter(e.VSP_CENTER);u.EnableAttributeArray(a.location),u.EnableAttributeArray(f.location),u.EnableAttributeArray(l.location),e.Parameters.Instance().IsShowTrilateralEdge?(u.EnableAttributeArray(c.location),u.SetUniformValue(e.FSP_ENABLE_WRIEFRAME,new Int32Array([1]))):e.Parameters.Instance().IsOnlyShowTrilateralEdge&&(u.EnableAttributeArray(c.location),u.SetUniformValue(e.FSP_ENABLE_ONLY_WRIEFRAME,new Int32Array([1]))),u.SetUniformValue(e.VSP_VIEWMAT,i.GetViewMatrix()),u.SetUniformValue(e.VSP_PROJECTIONMAT,i.GetProjectMatrix());var h=o.GetWorldPosition();u.SetUniformValue(e.VSP_EYEPOSITION,h);var p=new e.Vector4(.1,.1,.1,1),d=new e.Vector4(.7,.7,.7,1),v=new Float32Array([10]),m=new e.Color(1,1,1,1);u.SetUniformValue("u_lights.ambient",new e.Color(1,1,1,1)),u.SetUniformValue("u_lights.diffuse",new e.Color(1,1,1,1)),u.SetUniformValue("u_lights.specular",new e.Color(.5,.5,.5,1));var g=n.clipPlane[0].Clone(),y=i.GetViewMatrix();g=y.Inverse().Multiply(g),u.SetUniformValue(e.FSP_CLIPPLANE,g);var b=new Int32Array([n.enableClip[0]]);u.SetUniformValue(e.FSP_ENABLECLIP,b);var w=new e.Matrix4,E=!1,S=!1,x=!1,T=!1,N=r.GetRenderableArray();u.SetUniformValue(e.VSP_LIGHTPOSITION,new e.Vector3(0,0,1));var C=i.GetViewMatrix(),k=new e.Matrix4,L=new e.Matrix4,A=new Int32Array([0]),O=new Int32Array([0]),M=new Int32Array([0]),_=new Int32Array([1]),D=new Int32Array([0]),P=new Int32Array([2]);for(var H=0,B=N;H<B.length;H++){var j=B[H];m=e.Color.WHITE();var F=j.GetDataLength(),I=j.IsUseIndex(),q=j.GetHardWareVertexBuffer(),R=j.GetHardWareIndexBuffer();w=j.GetRenderWorldMatrix(),w.MultiplyMat4(C,k),L=k.InverseED().TransposeED();if(!q){var U=q;continue}q.Bind();var z=j.GetVertexOffset(),W=j.GetNormalOffset(),X=j.GetTextureCoordsOffset(),V=j.GetCentersCoordsOffset(),$=j.GetRenderColor();u.SetVertexAttribPointer(a.location,3,e.GL.FLOAT,0,z),u.SetVertexAttribPointer(f.location,3,e.GL.FLOAT,0,W),u.SetVertexAttribPointer(l.location,2,e.GL.FLOAT,0,X),(e.Parameters.Instance().IsShowTrilateralEdge||e.Parameters.Instance().IsOnlyShowTrilateralEdge)&&u.SetVertexAttribPointer(c.location,3,e.GL.FLOAT,0,V),u.SetUniformValue(e.VSP_MODELMAT,w),u.SetUniformValue(e.VSP_NORMALMAT,L),u.SetUniformValue(e.VSP_TEXTUREMAT,e.Matrix4.IDENTITY());if(F>0){var J=this.GetResourceManager(n).GetDeffaultTextureObj();M=new Int32Array([1]),s.activeTexture(s.TEXTURE1),s.bindTexture(s.TEXTURE_2D,J),u.SetUniformValue(e.FSP_USEAMBIENTTEX,M),u.SetUniformValue(e.FSP_SAMPLER1,_);var K=this.GetResourceManager(n).GetDefaultCubeMap();s.activeTexture(e.GL.TEXTURE2),s.bindTexture(e.GL.TEXTURE_CUBE_MAP,K),D=new Int32Array([1]),u.SetUniformValue(e.FSP_USECUBEMAPTEX,D),u.SetUniformValue(e.FSP_SAMPLERCUBE0,P);var Q=j.GetRenderMaterial();if(Q){var G=Q.GetAmbientMap(),Y=null;G&&(Y=G.GetOGLObj(s));if(!Y){var Z=Q.GetDiffuseMap();Y=this.GetResourceManager(n).GetDeffaultTextureObj()}Y&&(s.activeTexture(s.TEXTURE1),s.bindTexture(s.TEXTURE_2D,Y),M=new Int32Array([1]),u.SetUniformValue(e.FSP_USEAMBIENTTEX,M),u.SetUniformValue(e.FSP_SAMPLER1,_));if(e.Parameters.Instance().LightingMode==600){var et=new e.Color(1,0,0,$.a);u.SetUniformValue(e.FSP_MATERIAL_DIFFUSE,et)}var tt=new e.Color(1,1,1,1);$==e.Color.SelectColor().Clone()&&(tt=$),u.SetUniformValue(e.FSP_SELECTCOLOR,tt);if(e.Parameters.Instance().LightingMode==400||Q.GetReflectiveTextureTexture()){var nt=null;Q.GetReflectiveTextureTexture()?nt=Q.GetReflectiveTextureTexture().GetOGLObj(s):nt=this.GetResourceManager(n).GetDefaultCubeMap(),nt&&(s.activeTexture(e.GL.TEXTURE2),s.bindTexture(e.GL.TEXTURE_CUBE_MAP,nt),D=new Int32Array([1]),u.SetUniformValue(e.FSP_USECUBEMAPTEX,D),u.SetUniformValue(e.FSP_SAMPLERCUBE0,P))}var rt=Q.GetDiffuseMap();if(rt&&rt.GetName()!==e.DEFAULT_TEXTURE_PATH){u.EnableAttributeArray(l.location);var it=rt.GetOGLObj(s);if(it){A=new Int32Array([1]),u.SetUniformValue(e.FSP_USEDIFFUSETEX,A),u.SetUniformValue(e.FSP_SAMPLER0,O),$.Equals(e.Color.SelectColor())&&(tt=$.Clone()),u.SetUniformValue(e.FSP_MATERIAL_DIFFUSE,e.Color.WHITE()),u.SetUniformValue(e.FSP_DIFFUSE,$),u.SetUniformValue(e.FSP_SELECTCOLOR,tt),u.SetUniformValue(e.FSP_MATERIAL_AMBIENT,Q.GetAmbient()),u.SetUniformValue(e.FSP_MATERIAL_SPECULAR,Q.GetSpecular()),u.SetUniformValue(e.FSP_MATERIAL_SHININESS,v),s.activeTexture(e.GL.TEXTURE0),s.bindTexture(e.GL.TEXTURE_2D,it);if(I){var st=j.GetIndexOffset();t.DrawTriWithIndex(s,q,R,F,st)}else t.DrawTriNoIndex(s,q,F);s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,null),s.activeTexture(s.TEXTURE1),s.bindTexture(s.TEXTURE_2D,null),s.activeTexture(s.TEXTURE2),s.bindTexture(s.TEXTURE_CUBE_MAP,null)}}else{u.DisableAttributeArray(l.location),$.Equals(e.Color.SelectColor())?(tt=$.Clone(),u.SetUniformValue(e.FSP_MATERIAL_DIFFUSE,$)):u.SetUniformValue(e.FSP_MATERIAL_DIFFUSE,Q.GetDiffuse()),u.SetUniformValue(e.FSP_DIFFUSE,$),u.SetUniformValue(e.FSP_SELECTCOLOR,tt),u.SetUniformValue(e.FSP_MATERIAL_AMBIENT,Q.GetAmbient()),u.SetUniformValue(e.FSP_MATERIAL_SPECULAR,Q.GetSpecular()),u.SetUniformValue(e.FSP_MATERIAL_SHININESS,v),this.GetResourceManager(n).CreateDeffaultTextureObj();var it=this.GetResourceManager(n).GetDeffaultTextureObj();A=new Int32Array([1]),u.SetUniformValue(e.FSP_USEDIFFUSETEX,A),u.SetUniformValue(e.FSP_SAMPLER0,O),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,it),s.activeTexture(s.TEXTURE1),s.bindTexture(s.TEXTURE_2D,Y);if(I){var st=j.GetIndexOffset();t.DrawTriWithIndex(s,q,R,F,st)}else t.DrawTriNoIndex(s,q,F);s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,null),s.activeTexture(s.TEXTURE1),s.bindTexture(s.TEXTURE_2D,null),s.activeTexture(s.TEXTURE2),s.bindTexture(s.TEXTURE_CUBE_MAP,null)}}else{u.DisableAttributeArray(l.location),$.Equals(e.Color.SelectColor())&&(m=$.Clone()),u.SetUniformValue(e.FSP_MATERIAL_DIFFUSE,$),u.SetUniformValue(e.FSP_DIFFUSE,$),u.SetUniformValue(e.FSP_SELECTCOLOR,m),u.SetUniformValue(e.FSP_MATERIAL_AMBIENT,p),u.SetUniformValue(e.FSP_MATERIAL_SPECULAR,d),u.SetUniformValue(e.FSP_MATERIAL_SHININESS,v);var it=this.GetResourceManager(n).GetDeffaultTextureObj();A=new Int32Array([1]),u.SetUniformValue(e.FSP_USEDIFFUSETEX,A),u.SetUniformValue(e.FSP_SAMPLER0,O),M=new Int32Array([1]),u.SetUniformValue(e.FSP_USEAMBIENTTEX,M),u.SetUniformValue(e.FSP_SAMPLER1,_);var nt=this.GetResourceManager(n).GetDefaultCubeMap();D=new Int32Array([1]),u.SetUniformValue(e.FSP_USECUBEMAPTEX,D),u.SetUniformValue(e.FSP_SAMPLERCUBE0,P),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,it),s.activeTexture(s.TEXTURE1),s.bindTexture(s.TEXTURE_2D,it),s.activeTexture(e.GL.TEXTURE2),s.bindTexture(e.GL.TEXTURE_CUBE_MAP,nt);if(I){var st=j.GetIndexOffset();t.DrawTriWithIndex(s,q,R,F,st)}else t.DrawTriNoIndex(s,q,F);s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,null),s.activeTexture(s.TEXTURE1),s.bindTexture(s.TEXTURE_2D,null),s.activeTexture(s.TEXTURE2),s.bindTexture(s.TEXTURE_CUBE_MAP,null)}s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,null),s.activeTexture(s.TEXTURE1),s.bindTexture(s.TEXTURE_2D,null),s.activeTexture(s.TEXTURE2),s.bindTexture(s.TEXTURE_CUBE_MAP,null)}q.UnBind()}u.DisableAttributeArray(a.location),u.DisableAttributeArray(f.location),u.DisableAttributeArray(l.location);if(e.Parameters.Instance().IsShowTrilateralEdge||e.Parameters.Instance().IsOnlyShowTrilateralEdge)u.DisableAttributeArray(c.location),u.SetUniformValue(e.FSP_ENABLE_WRIEFRAME,new Int32Array([0])),u.SetUniformValue(e.FSP_ENABLE_ONLY_WRIEFRAME,new Int32Array([0]));u.ReleaseShaderProgram()},t.DrawPhongPassSampleGroup=function(n,r){if(r.GetRenderableArray().length===0)return;var i=n.GetRenderContext(),s=i.GetGLRenderContext(),o=n.GetCamera(),u=n.GetShaderMananger().GetEffect(e.ShaderManager.Base);u.UseProgram();var a=u.GetShaderAttributeParameter(e.VSP_POSITION),f=u.GetShaderAttributeParameter(e.VSP_NORMAL),l=u.GetShaderAttributeParameter(e.VSP_CENTER);u.EnableAttributeArray(a.location),u.EnableAttributeArray(f.location),e.Parameters.Instance().IsShowTrilateralEdge?(u.EnableAttributeArray(l.location),u.SetUniformValue(e.FSP_ENABLE_WRIEFRAME,new Int32Array([1]))):e.Parameters.Instance().IsOnlyShowTrilateralEdge&&(u.EnableAttributeArray(l.location),u.SetUniformValue(e.FSP_ENABLE_ONLY_WRIEFRAME,new Int32Array([1]))),u.SetUniformValue(e.VSP_VIEWMAT,i.GetViewMatrix()),u.SetUniformValue(e.VSP_PROJECTIONMAT,i.GetProjectMatrix());var c=n.clipPlane[0].Clone(),h=i.GetViewMatrix();c=h.Inverse().Multiply(c),u.SetUniformValue(e.FSP_CLIPPLANE,c);var p=new Int32Array([n.enableClip[0]]);u.SetUniformValue(e.FSP_ENABLECLIP,p);var d=new e.Matrix4,v=r.GetRenderableArray(),m=new e.Vector4(.1,.1,.1,1),g=new e.Vector4(.7,.7,.7,1),y=new Float32Array([10]),b=new e.Color(1,1,1,1);u.SetUniformValue(e.VSP_LIGHTPOSITION,new e.Vector3(0,0,1));var w=i.GetViewMatrix(),E=new e.Matrix4,S=new e.Matrix4;for(var x=0,T=v;x<T.length;x++){var N=T[x],C=N.GetDataLength(),k=N.IsUseIndex(),L=N.GetHardWareVertexBuffer(),A=N.GetHardWareIndexBuffer();d=N.GetRenderWorldMatrix(),d.MultiplyMat4(w,E),S=E.InverseED().TransposeED(),L.Bind();var O=N.GetVertexOffset(),M=N.GetNormalOffset(),_=N.GetTextureCoordsOffset(),D=N.GetCentersCoordsOffset(),P=N.GetRenderColor();u.SetVertexAttribPointer(a.location,3,e.GL.FLOAT,0,O),u.SetVertexAttribPointer(f.location,3,e.GL.FLOAT,0,M),(e.Parameters.Instance().IsShowTrilateralEdge||e.Parameters.Instance().IsOnlyShowTrilateralEdge)&&u.SetVertexAttribPointer(l.location,3,e.GL.FLOAT,0,D),u.SetUniformValue(e.VSP_MODELMAT,d),u.SetUniformValue(e.VSP_NORMALMAT,S);if(C>0){b=P,u.SetUniformValue(e.FSP_DIFFUSE,P),u.SetUniformValue(e.FSP_AMBIENT,m),u.SetUniformValue(e.FSP_SPECULAR,g),u.SetUniformValue(e.FSP_SHININESS,1,y);if(k){var H=N.GetIndexOffset();t.DrawTriWithIndex(s,L,A,C,H)}else t.DrawTriNoIndex(s,L,C)}}u.DisableAttributeArray(a.location),u.DisableAttributeArray(f.location);if(e.Parameters.Instance().IsShowTrilateralEdge||e.Parameters.Instance().IsOnlyShowTrilateralEdge)u.DisableAttributeArray(l.location),u.SetUniformValue(e.FSP_ENABLE_WRIEFRAME,new Int32Array([0])),u.SetUniformValue(e.FSP_ENABLE_ONLY_WRIEFRAME,new Int32Array([0]));u.ReleaseShaderProgram()},t.DrawCapPolygon=function(t){var n=t.clipPlane,r=t.enableClip,i=t.GetSection();if(!i)return;var s=i.GetPlaneList(),o=0;for(var u=0;u<s.length;++u,++o)r[o]=0;for(var u=0;u<s.length;++u){var a=s[u];if(a){var f=t.GetRenderContext().GetGLRenderContext(),l=t.GetCamera();if(!l)return;a.SetCurrentGLContext(f),f.enable(e.GL.DEPTH_TEST),f.lineWidth(1),f.enable(e.GL.BLEND),f.depthMask(!0);var c=void 0,h=void 0,p=new e.Matrix4,d=void 0;h=l.GetProjection().Transpose(),c=l.GetView().ToMatrix4().Transpose();var v=t.GetShaderMananger(),m=v.GetEffect(e.ShaderManager.Edge);m.UseProgram(),m.SetUniformValue(e.VSP_VIEWMAT,c),m.SetUniformValue(e.VSP_PROJECTIONMAT,h),m.SetUniformValue(e.VSP_MODELMAT,p);var g=m.GetShaderAttributeParameter(e.VSP_POSITION);m.EnableAttributeArray(g.location);var y=a.GetFacePositionVBO();y.Bind();var b=new e.Color(.6,.3,0);m.SetVertexAttribPointer(g.location,3,e.GL.FLOAT,0,0),m.SetUniformValue(e.FSP_DIFFUSE,b),f.drawArrays(e.GL.TRIANGLES,0,36),y.UnBind(),f.depthMask(!0),m.DisableAttributeArray(g.location),m.ReleaseShaderProgram()}}},t.DrawSampleModelPassGroug=function(n){var r=n.GetRenderEffect(),i=r.GetRenderableTypeFilter(),s=r.GetRenderQueuePriority(),o=s.GetData(),u=n.GetRenderQueueGroup(),a=[];for(var f=0,l=o;f<l.length;f++){var c=l[f],h=u.get(c.GetRenderGroupType().GetType());if(h!==undefined){h.SetRenderTech(c);var p=h.GetType().GetType();(p===e.RenderableType.RGT_SOLID||p===e.RenderableType.RGT_TRANSPARENT)&&a.push(h)}}var d=n.GetRenderContext(),v=d.GetGLRenderContext();v.enable(e.GL.DEPTH_TEST);var m=n.GetCamera(),g=n.GetShaderMananger().GetEffect(e.ShaderManager.Edge);g.UseProgram();var y=g.GetShaderAttributeParameter(e.VSP_POSITION);g.EnableAttributeArray(y.location),g.SetUniformValue(e.VSP_VIEWMAT,d.GetViewMatrix()),g.SetUniformValue(e.VSP_PROJECTIONMAT,d.GetProjectMatrix());var b=n.clipPlane[0].Clone(),w=d.GetViewMatrix();b=w.Inverse().Multiply(b),g.SetUniformValue(e.FSP_CLIPPLANE,b);var E=new Int32Array([n.enableClip[0]]);g.SetUniformValue(e.FSP_ENABLECLIP,E);var S=new e.Matrix4,x=d.GetViewMatrix(),T=new e.Matrix4;for(var N=0;N<a.length;N++){var C=a[N].GetRenderableArray();for(var k=0,L=C;k<L.length;k++){var A=L[k],O=A.GetDataLength(),M=A.IsUseIndex(),_=A.GetHardWareVertexBuffer(),D=A.GetHardWareIndexBuffer();S=A.GetRenderWorldMatrix(),S.MultiplyMat4(x,T),_.Bind();var P=A.GetVertexOffset(),H=A.GetRenderColor();g.SetVertexAttribPointer(y.location,3,e.GL.FLOAT,0,P),g.SetUniformValue(e.VSP_MODELMAT,S);if(O>0){g.SetUniformValue(e.FSP_DIFFUSE,H);if(M){var B=A.GetIndexOffset();t.DrawTriWithIndex(v,_,D,O,B)}else t.DrawTriNoIndex(v,_,O)}}}g.DisableAttributeArray(y.location),g.ReleaseShaderProgram()},t.InitialGL=function(t){if(t!=null){var n=t.GetRenderContext().GetGLRenderContext();n.enable(e.GL.DEPTH_TEST),n.depthFunc(e.GL.LEQUAL),n.blendEquationSeparate(n.FUNC_ADD,n.FUNC_ADD),n.blendFuncSeparate(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA,n.ONE,n.ONE_MINUS_SRC_ALPHA),n.disable(e.GL.BLEND),n.depthMask(!0),n.clearColor(.92,.94,.929,1),n.frontFace(e.GL.CCW),n.clearStencil(0),n.clear(e.GL.DEPTH_BUFFER_BIT|e.GL.COLOR_BUFFER_BIT|e.GL.STENCIL_BUFFER_BIT)}},t.DrawQuad=function(t){var n=t.GetRenderContext(),r=n.GetGLRenderContext(),i=t.GetCamera(),s=[-1,1,-1,-1,-1,-1,1,1,-1,1,-1,-1],o=[0,1,0,0,1,1,1,0],u=i.GetViewPort().GetRect();r.viewport(u.left,u.top,u.right,u.bottom);var a=1/u.right,f=1/u.bottom,l=t.GetShaderMananger().GetEffect(e.ShaderManager.Quad);l.UseProgram();var c=l.GetShaderAttributeParameter(e.VSP_POSITION),h=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,h),r.bufferData(r.ARRAY_BUFFER,new Float32Array(s),r.STATIC_DRAW),l.EnableAttributeArray(c.location),l.SetVertexAttribPointer(c.location,3,e.GL.FLOAT,0,0),l.SetUniformValue(e.FSP_DIFFUSE,new e.Color(1,0,0)),r.drawArrays(e.GL.TRIANGLE_STRIP,0,4),l.DisableAttributeArray(c.location),l.ReleaseShaderProgram(),r.bindBuffer(e.GL.ARRAY_BUFFER,null),r.deleteBuffer(h)},t.SetFocalLength=function(t){var n=t.GetScene(),r=n.GetCamera(),i=n.GetSceneBox().Clone(),s=r.GetWorldPosition().Sub(i.Center()).Length(),o=i.Length();if(i.IsInside(r.GetWorldPosition())==e.OUTSIDE)r.SetPupilDistance(s*.03);else{var u=0,a=r.GetView().ToMatrix3(),f=new e.Vector3(a.Data()[6],0,a.Data()[8]),l=new e.Vector3(a.Data()[0],0,a.Data()[2]);f=f.Multiply(-1),f.Normalize(),l=l.Multiply(-1),l.Normalize();var c=l.Add(f),h=e.Abs(c.DotProduct(e.Vector3.RIGHT()));h>.7071?u=i.GetXLength():u=i.GetZLength(),u=u/4*.03,r.SetPupilDistance(u)}},t.DrawFrameBufferDebug=function(n){var r=n.GetRenderContext(),i=r.GetGLRenderContext(),s=n.GetCamera(),o={},u=[-1,1,-1,-1,-1,-1,1,1,-1,1,-1,-1],a=[0,1,0,0,1,1,1,0],f=s.GetViewPort().GetRect();i.viewport(f.left,f.top,f.right,f.bottom);var l=1/f.right,c=1/f.bottom,h=n.GetShaderMananger().GetEffect(e.ShaderManager.FBODebug);h.UseProgram();var p={};t._usedTextureUnits=0;var d=h.GetShaderAttributeParameter(e.VSP_POSITION),v=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,v),i.bufferData(i.ARRAY_BUFFER,new Float32Array(u),i.STATIC_DRAW),h.EnableAttributeArray(d.location),h.SetVertexAttribPointer(d.location,3,e.GL.FLOAT,0,0);var m=h.GetShaderAttributeParameter(e.VSP_TEXCOORDS),g=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,g),i.bufferData(i.ARRAY_BUFFER,new Float32Array(a),i.STATIC_DRAW),h.EnableAttributeArray(m.location),h.SetVertexAttribPointer(m.location,2,e.GL.FLOAT,0,0);var y=new e.Matrix4,b=new e.Matrix4,w=new e.Matrix4;p[e.VSP_MODELMAT]=new e.Uniform("Matrix4",w),p[e.VSP_VIEWMAT]=new e.Uniform("Matrix4",y),p[e.VSP_PROJECTIONMAT]=new e.Uniform("Matrix4",b),p[e.FSP_SAMPLER0]=new e.Uniform("Texture2D",t.rendT.getColorTarget(0));var E=h.GetShaderUniformMap();e.UniformHelper.UpdateUniform(n,o,h,E,p),i.drawArrays(e.GL.TRIANGLE_STRIP,0,4);for(var S in o){var x=o[S];i.activeTexture(e.GL.TEXTURE0+parseInt(S)),i.bindTexture(x,null)}h.DisableAttributeArray(d.location),h.DisableAttributeArray(m.location),h.ReleaseShaderProgram(),i.deleteBuffer(v),i.deleteBuffer(g)},t.DrawImageBoardQueue=function(n){var r=n.GetRenderImageBoards();if(r.length>0){var i=n.GetCamera(),s=i.GetView().ToMatrix4(),o=i.GetProjection().Transpose(),u=i.GetView().ToMatrix4().Transpose(),a=n.GetShaderMananger();if(!a)return;var f=a.GetEffect(e.ShaderManager.Image);f.UseProgram();var l=new e.Vector4(n.clipPlane[0].Clone());l=i.GetView().ToMatrix4().Inverse().Transpose().Multiply(l);var c=new Int32Array([n.enableClip[0]]);f.SetUniformValue(e.FSP_ENABLECLIP,c);var h=f.GetShaderUniformParameter(e.FSP_REVERSECLIP);f.SetUniformValue(e.FSP_REVERSECLIP,h.location,n.m_bReverseClip?1:0);var p=e.Matrix4.IDENTITY().Clone();for(var d=0;d<r.length;d++){var v=r[d];v&&v.GetAllowClip()&&f.SetUniformValue(e.FSP_ENABLECLIP,3,c),t.DrawImageBoard(v,u,o,p,f,!v.IsFrontShow())}f.ReleaseShaderProgram()}},t.AllocTextureUnit=function(){var e=t._usedTextureUnits;return t._usedTextureUnits+=1,e},t.isSVLX=!0,t._usedTextureUnits=0,t.m_ssaoLastState=!1,t.depthMaterial=null,t.rendT=null,t.m_shadowState=!1,t.renderTarget=null,t}();e.GLShapeDrawer=t})(M3D||(M3D={}));var M3D;(function(e){e.VSP_POSITION="a_position",e.VSP_NORMAL="a_normal",e.VSP_COLOR="a_color",e.VSP_CENTER="a_center",e.VSP_UCOLOR="u_color",e.VSP_TEXCOORDS="a_texCoords",e.VSP_MODELMAT="u_modelMat",e.VSP_VIEWMAT="u_viewMat",e.VSP_PROJECTIONMAT="u_projectionMat",e.VSP_NORMALMAT="u_normalMat",e.VSP_LIGHTMAT="u_lightMat",e.VSP_LIGHTPROJECT="u_lightProject",e.VSP_BAIS="u_bais",e.VSP_MODELVIEWMAT="u_modelViewMat",e.VSP_MVPMAT="u_MVPMat",e.VSP_TEXTUREMAT="u_textureMat",e.VSP_LIGHTPOSITION="u_lightPosition",e.VSP_EYEPOSITION="u_eyePosition",e.FSP_AMBIENT="u_ambient",e.FSP_DIFFUSE="u_diffuse",e.FSP_SPECULAR="u_specular",e.FSP_SHININESS="u_shininess",e.FSP_SAMPLER0="u_sampler0",e.FSP_SAMPLER1="u_sampler1",e.FSP_SAMPLER2="u_sampler2",e.FSP_SAMPLERCUBE0="u_samplerCube0",e.FSP_USETEX="u_useTex",e.FSP_FRESNEL0="u_fresnel0",e.FSP_ROUGHNESS="u_roughness",e.FSP_CLIPPLANE="u_clipPlanes",e.FSP_ENABLECLIP="u_enableClips",e.FSP_REVERSECLIP="u_reverseClip",e.FSP_ENABLE_WRIEFRAME="u_enableWireframe",e.FSP_ENABLE_ONLY_WRIEFRAME="u_enableOnlyWireframe",e.FSP_ENABLELIGHTS="u_enbleLights",e.FSP_LIGHTMODEL_AMBIENT="u_lightModel.ambient",e.FSP_LIGHT_0_AMBIENT="u_lights[0].ambient",e.FSP_LIGHT_0_DIFFUSE="u_lights[0].diffuse",e.FSP_LIGHT_0_SPECULAR="u_lights[0].specular",e.FSP_LIGHT_0_POSITION="u_lights[0].position",e.FSP_LIGHT_0_SPOT_DIRECTION="u_lights[0].spotDirection",e.FSP_LIGHT_0_SPOT_EXPONENT="u_lights[0].spotExponent",e.FSP_LIGHT_0_SPOT_CUTOFF="u_lights[0].spotCutoff",e.FSP_LIGHT_0_SPOT_COSCUTOFF="u_lights[0].spotCosCutoff",e.FSP_LIGHT_0_CONST_ATTENUATION="u_lights[0].constant",e.FSP_LIGHT_0_LINEAR_ATTENUATION="u_lights[0].linear",e.FSP_LIGHT_0_QUAD_ATTENUATION="u_lights[0].quadratic",e.FSP_LIGHT_0_INTENSITY="u_lights[0].intensity",e.FSP_LIGHT_1_AMBIENT="u_lights[1].ambient",e.FSP_LIGHT_1_DIFFUSE="u_lights[1].diffuse",e.FSP_LIGHT_1_SPECULAR="u_lights[1].specular",e.FSP_LIGHT_1_POSITION="u_lights[1].position",e.FSP_LIGHT_1_SPOT_DIRECTION="u_lights[1].spotDirection",e.FSP_LIGHT_1_SPOT_EXPONENT="u_lights[1].spotExponent",e.FSP_LIGHT_1_SPOT_CUTOFF="u_lights[1].spotCutoff",e.FSP_LIGHT_1_SPOT_COSCUTOFF="u_lights[1].spotCosCutoff",e.FSP_LIGHT_1_CONST_ATTENUATION="u_lights[1].constant",e.FSP_LIGHT_1_LINEAR_ATTENUATION="u_lights[1].linear",e.FSP_LIGHT_1_QUAD_ATTENUATION="u_lights[1].quadratic",e.FSP_LIGHT_1_INTENSITY="u_lights[1].intensity",e.FSP_MATERIAL_EMISSION="u_materials.emission",e.FSP_MATERIAL_AMBIENT="u_materials.ambient",e.FSP_MATERIAL_DIFFUSE="u_materials.diffuse",e.FSP_MATERIAL_SPECULAR="u_materials.specular",e.FSP_MATERIAL_SHININESS="u_materials.shininess",e.FSP_USEAMBIENTTEX="u_useAmbientTex",e.FSP_USECUBEMAPTEX="u_useCubeMapTex",e.FSP_USEDIFFUSETEX="u_useDiffuseTex",e.FSP_SELECTCOLOR="u_selectColor",e.FSP_SHADOW_LIGHTPOS="u_shadowLPos",e.SHADOW_X_PIXEL_OFFSET="u_xPixelOffset",e.SHADOW_Y_PIXEL_OFFSET="u_yPixelOffset",e.VSP_LIGHT_NORMALMAT="u_lightNormalMat",e.FSP_EDGEDETEC="u_edgeDetecColor",e.MODEL_MATRXI="modelMatrix",e.VIEW_MATRXI="viewMatrix",e.NORMAL_MATRXI="normalMatrix",e.PROJECTION_MATRXI="projectionMatrix",e.UV_TRANSFORM_MATRIX="uvTransform",e.DIFFUSE="diffuse",e.SPECULAR="specular",e.EMISSIVE="emissive",e.SHININESS="shininess",e.DIFFUSE_TEXTURE="diffuseTexture",e.SPECULAR_MAP="specularMap",e.NORMAL_MAP="normalMap",e.MATCAP_MAP="matcapMap",e.NORMAL_MAP_SCALE="normalScale",e.DISPLACEMENT_MAP="displacementMap",e.DISPLACEMENT_SCALE="displacementScale",e.DISPLACEMENT_BIAS="displacementBias",e.EMISSIVE_MAP="emissiveMap",e.AO_MAP="aoMap",e.AO_MAP_INTENSITY="aoMapIntensity",e.ENV_TEXTURE="envTexture",e.ENV_DIFFUSE_TEXTURE="envDiffuseTexture",e.ROUGHNESS="roughness",e.METALNESS="metalness",e.METALLIC_ROUGHNESS_TEXTURE="metallicRoughnessTexture",e.GAMMA="gamma",e.ENV_MAP_INTENSITY="envMapIntensity",e.LUT="lut",e.CAMERA_POSITION="cameraPosition",e.AMBIENT_LIGHT_COLOR="ambientLightColor",e.SPOT_LIGHT_0_COLOR="spotLights[0].color",e.SPOT_LIGHT_0_POSITION="spotLights[0].position",e.SPOT_LIGHT_0_DIRECTION="spotLights[0].direction",e.SPOT_LIGHT_0_DISTANCE="spotLights[0].distance",e.SPOT_LIGHT_0_DECAY="spotLights[0].decay",e.SPOT_LIGHT_0_CONECOS="spotLights[0].coneCos",e.SPOT_LIGHT_0_PENUMBRACOS="spotLights[0].penumbraCos",e.SPOT_LIGHT_0_SHADOW="spotLights[0].shadow",e.TONE_MAPPING_EXPOSURE="toneMappingExposure",e.CLEARCOAT="clearCoat",e.CLEARCOATROUGHNESS="clearCoatRoughness",e.OPACITY="opacity"})(M3D||(M3D={}));var M3D;(function(e){var t=function(e){function t(t,n){var r=e.call(this,t)||this;return r.isCompiled=!1,r.shader=null,r.type=n,r.gl=t,r}return __extends(t,e),t.prototype.AddLineNumbers=function(e){var t=e.split("\n");for(var n=0;n<t.length;n++)t[n]=n+1+": "+t[n];return t.join("\n")},t.prototype.CompileSourceCode=function(e){var t=!0,n=this.gl.createShader(this.type);return this.gl.shaderSource(n,e),this.gl.compileShader(n),this.isCompiled=!0,this.gl.getShaderParameter(n,this.gl.COMPILE_STATUS)===!1&&(this.gl.getShaderInfoLog(n)!==""&&console.log(this.type,"M3DJS Shader Info: "+this.gl.getShaderInfoLog(n),this.AddLineNumbers(e)),this.isCompiled=!1,t=!1),this.shader=n,t},t.prototype.IsCompiled=function(){return this.isCompiled},t.prototype.ShaderObject=function(){return this.shader},t.prototype.DeleteShader=function(){this.isCompiled&&this.gl.deleteShader(this.shader)},t.prototype.GetShaderType=function(){return this.type},t}(e.GPUObject);e.Shader=t})(M3D||(M3D={}));var M3D;(function(e){e.ShaderStrings={},e.ShaderStrings.BaseVert=["precision highp  float;","attribute vec3 a_position;","attribute vec3 a_normal;","attribute vec3 a_center;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","uniform mat4 u_normalMat;","uniform mat4 u_textureMat;","uniform vec3 u_lightPosition;","varying vec3 v_viewDirection;","varying vec3 v_lightDirection;","varying vec3 v_normal;","varying vec3 v_position;","varying vec3 v_center;","void main() { ","gl_Position = u_projectionMat * u_viewMat*u_modelMat* vec4(a_position,1.0);","vec4 fvObjectPosition = u_viewMat*u_modelMat* vec4(a_position,1.0);","v_position = fvObjectPosition.xyz/fvObjectPosition.w;","v_viewDirection  = normalize( -fvObjectPosition.xyz);","v_lightDirection = normalize(u_lightPosition-fvObjectPosition.xyz);"," v_normal         = normalize(vec3((u_normalMat * vec4(a_normal,0.0))));","v_center = a_center;","}"].join("\n"),e.ShaderStrings.BaseFrag=["#extension GL_OES_standard_derivatives : enable \n","precision highp  float;","uniform vec4 u_ambient;","uniform vec4 u_diffuse;","uniform vec4 u_specular;","uniform float u_shininess;","uniform bool u_enableWireframe;","uniform bool u_enableOnlyWireframe;","uniform vec4 u_clipPlane;","uniform bool u_enableClip;","varying vec3 v_viewDirection;","varying vec3 v_lightDirection;","varying vec3 v_normal;","varying vec3 v_position;","varying vec3 v_center;","const vec4 ambientColor = vec4(1.0, 1.0, 1.0,1.0);","const vec4 diffuseColor = vec4(1.0, 1.0, 1.0,1.0);","const vec4 specularColor = vec4(0.5,0.5,0.5,1.0);","float edgeFactorTri() {"," vec3 d = fwidth(v_center.xyz);","vec3 a3 = smoothstep(vec3(0.000001), d * 1.5, v_center.xyz);","  return min(min(a3.x, a3.y), a3.z);"," }","void main() { "
,"    if(u_enableClip)","    {","       float dPara = u_clipPlane.w;","		float testvalue = (dot(vec3(v_position.xyz),vec3(u_clipPlane.xyz))+dPara);","        if( testvalue<0.0)","        {","            discard;","        }","    }","float fNDotL =0.000001;","vec3 	halfvector;","float fNDotH;"," vec3  fvNormal ;","if(gl_FrontFacing){"," fvNormal         = normalize( v_normal );","}","else {"," fvNormal         = normalize( -v_normal );","}"," fNDotL           = clamp(abs(dot( fvNormal, v_lightDirection )),0.2,1.0);","halfvector        =normalize(v_lightDirection+ v_viewDirection );"," fNDotH            = max(0.000001,dot(fvNormal,halfvector));","vec4  fvTotalAmbient   = u_ambient * ambientColor;","vec4  fvTotalDiffuse   = u_diffuse * fNDotL * diffuseColor; ","vec4  fvTotalSpecular  = u_specular * specularColor *( pow( max(fNDotH,0.000001), u_shininess ) );","vec4 colorLinear = fvTotalAmbient + fvTotalDiffuse + fvTotalSpecular;","if(u_enableWireframe){","gl_FragColor = vec4(colorLinear.xyz,u_diffuse.a)*vec4(vec3(mix( vec3( 0.000001 ), vec3( 1.0 ), edgeFactorTri() )),1.0);","}","else if(u_enableOnlyWireframe){","gl_FragColor = vec4(colorLinear.xyz,u_diffuse.a)*vec4(1.0, 1.0, 1.0,(1.0-edgeFactorTri())*0.95);","}","else{","gl_FragColor = vec4(colorLinear.xyz,u_diffuse.a);","}","}"].join("\n"),e.ShaderStrings.BackgroundVert=["precision highp float;","attribute vec3 a_position;","attribute vec4 a_color;","uniform mat4 u_MVPMat;","varying vec4 v_color;","void main() { ","gl_Position = u_MVPMat * vec4(a_position,1.0);","v_color = a_color;","}"].join("\n"),e.ShaderStrings.BackgroundFrag=["precision highp float;","varying vec4 v_color;","void main() { ","gl_FragColor = v_color;","}"].join("\n"),e.ShaderStrings.EdgeVert=["precision highp float;","attribute vec3 a_position;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","varying vec3 v_position;","#ifdef DEPTH_EDGE","varying vec4 v_projectPos;","#endif","void main(){","gl_Position = u_projectionMat *u_viewMat*u_modelMat*vec4(a_position,1.0);","#ifdef DEPTH_EDGE","v_projectPos = u_projectionMat *u_viewMat*u_modelMat*vec4(a_position,1.0);","#endif","vec4 fvObjectPosition = u_viewMat*u_modelMat* vec4(a_position,1.0);","v_position = fvObjectPosition.xyz;","gl_PointSize = 3.0;","}"].join("\n"),e.ShaderStrings.EdgeFrag=["precision highp float;","uniform vec4 u_diffuse;","uniform vec4 u_clipPlanes[3];","uniform bool u_enableClips[3];","uniform bool u_reverseClip;","#ifdef DEPTH_EDGE","uniform sampler2D u_sampler0;","varying vec4 v_projectPos;","#endif","varying vec3 v_position;","void main() { ","if (u_reverseClip) {","int iEnableNum = 0; ","int iClipNum = 0; ","for (int i = 0; i < 3; i++) {","if (u_enableClips[i]) {","iEnableNum++; ","float dPara = u_clipPlanes[i].w; ","if ((dot(vec3(v_position.xyz), vec3(u_clipPlanes[i].xyz)) + dPara) > 0.0) {","iClipNum++; ","}","}","}","if (iEnableNum == iClipNum && iEnableNum != 0) {","discard; ","}","}","else {","for (int i = 0; i < 3; i++) {","if (u_enableClips[i]) {","float dPara = u_clipPlanes[i].w; ","if ((dot(vec3(v_position.xyz), vec3(u_clipPlanes[i].xyz)) + dPara) < 0.0) {","discard; ","}","}","}","}","#ifdef DEPTH_EDGE","vec3 proj =v_projectPos.xyz/v_projectPos.w;","   proj = proj *0.5+0.5;","float priDepth = texture2D(u_sampler0,proj.xy).x;","if(priDepth<proj.z) discard;","#endif","gl_FragColor = u_diffuse;","}"].join("\n"),e.ShaderStrings.AxisVert=["precision highp float;","attribute vec3 a_position;","uniform vec4 u_color;","uniform mat4 u_MVPMat;","varying vec4 v_color;","void main() { ","gl_Position = u_MVPMat * vec4(a_position,1.0);","v_color = u_color;","}"].join("\n"),e.ShaderStrings.AxisFrag=["precision highp float;","varying vec4 v_color;","void main() { ","gl_FragColor = v_color;","}"].join("\n"),e.ShaderStrings.ImageVert=["precision highp float;","attribute vec3 a_position;","attribute vec2 a_texCoords;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","varying vec2 v_texCoords;","varying vec3 v_position;","void main(){","gl_Position = u_projectionMat *u_viewMat*u_modelMat*vec4(a_position,1.0);","vec4 fvObjectPosition = u_viewMat*u_modelMat* vec4(a_position,1.0);","v_position = fvObjectPosition.xyz;","v_texCoords = a_texCoords;","}"].join("\n"),e.ShaderStrings.ImageFrag=["precision highp float;","uniform sampler2D u_sampler0;","uniform vec4 u_diffuse;","uniform vec4 u_clipPlanes[3];","uniform bool u_enableClips[3];","uniform bool u_reverseClip;","varying vec2 v_texCoords;","varying vec3 v_position;","void main() { ","if (u_reverseClip) {","int iEnableNum = 0; ","int iClipNum = 0; ","for (int i = 0; i < 3; i++) {","if (u_enableClips[i]) {","iEnableNum++; ","float dPara = u_clipPlanes[i].w; ","if ((dot(vec3(v_position.xyz), vec3(u_clipPlanes[i].xyz)) + dPara) > -0.0001) {","iClipNum++; ","}","}","}","if (iEnableNum == iClipNum && iEnableNum != 0) {","discard; ","}","}","else {","for (int i = 0; i < 3; i++) {","if (u_enableClips[i]) {","float dPara = u_clipPlanes[i].w; ","if ((dot(vec3(v_position.xyz), vec3(u_clipPlanes[i].xyz)) + dPara) < 0.0001) {","discard; ","}","}","}","}","vec4 pcolor = texture2D(u_sampler0,v_texCoords);","vec4 tcolor = pcolor*u_diffuse;","gl_FragColor = vec4(tcolor.xyz,pcolor.a);","}"].join("\n"),e.ShaderStrings.CubeMapVert=["precision highp float;","attribute vec3 a_position;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","varying vec3 v_cubeTexCoords;","void main(){","gl_Position = u_projectionMat *u_viewMat*u_modelMat*vec4(a_position,1.0);","v_cubeTexCoords = a_position;","}"].join("\n"),e.ShaderStrings.CubeMapFrag=["precision highp float;","uniform samplerCube u_samplerCube0;","varying vec3 v_cubeTexCoords;","void main() { ","vec4 pcolor = textureCube(u_samplerCube0,v_cubeTexCoords);","gl_FragColor = pcolor;","}"].join("\n"),e.ShaderStrings.MultilightVert=["precision highp float;","//#define FBO ","struct Light","{","    vec4 ambient;","    vec4 diffuse;","    vec4 specular;","    vec4 position;","    vec3 intensity;","    vec3 spotDirection;","    float spotExponent;","    float spotCutoff; // (range: [0.0,90.0], 180.0)","    float spotCosCutoff; // (range: [1.0,0.0],-1.0)","    float constant;","    float linear;","    float quadratic;","};","","struct LightModel","{","    vec4 ambient;    // Acs","};","","struct Materials","{","    vec4 emission;","    vec4 ambient;","    vec4 diffuse;","    vec4 specular;","    float shininess;","};","attribute vec3 a_position;","attribute vec3 a_normal;","attribute vec3 a_texCoords;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","uniform mat4 u_normalMat;","#ifdef FBO ","uniform mat4 u_lightMat;","uniform mat4 u_lightProject;","#endif ","uniform mat4 u_textureMat;","uniform vec3 u_eyePosition;","","//varying","varying vec3 v_position;","varying vec4 v_texCoords;","varying vec3 v_diffuseColor;","varying vec3 v_specularColor;","varying vec3 v_diffuseColorN;","varying vec3 v_specularColorN;","varying vec3 v_normal;","varying vec3 v_cubeTexCoords;","#ifdef FBO ","varying vec4 v_lightSpacePos;","varying vec3 v_worldNormal;","varying vec3 v_worldPos;","uniform vec3 u_shadowLPos;","#endif ","//scene ambient","uniform LightModel u_lightModel ;","const int numberOfLights = 1;","uniform Light u_lights[1];","uniform int u_enbleLights[1];","//Materials","uniform Materials u_materials;","void main(void)","{","    gl_Position = u_projectionMat * u_viewMat*u_modelMat* vec4(a_position,1.0);","    vec3 lightDirection;","    float attenuation=1.0;","    vec3 totalLighting = vec3(u_materials.emission)+ vec3(u_lightModel.ambient) * vec3(u_materials.ambient);","    vec3 totalAmbient= vec3(0.0,0.0,0.0);","    vec3 totalDiffuse = vec3(0.0,0.0,0.0);","    vec3 totalSpecular = vec3(0.0,0.0,0.0);","    vec3 totalAmbientBack= vec3(0.0,0.0,0.0);","    vec3 totalDiffuseBack = vec3(0.0,0.0,0.0);","    vec3 totalSpecularBack = vec3(0.0,0.0,0.0);","    vec4 fvObjectPosition = u_viewMat*u_modelMat* vec4(a_position,1.0);","#ifdef FBO ","    v_lightSpacePos = u_lightProject*u_lightMat *u_modelMat* vec4(a_position,1.0);","    v_worldNormal = a_normal;","#endif ","    vec4 tempCoords = u_textureMat*vec4(a_texCoords.xyz,1.0);","    v_position = fvObjectPosition.xyz/fvObjectPosition.w;","    v_texCoords = tempCoords;","    vec3 vNormal= normalize(vec3((u_normalMat * vec4(a_normal,0.0))));","    v_normal = vNormal;","    vec4 worldPos = u_modelMat * vec4(a_position,1.0);","    vec3 worldPosT = worldPos.xyz;","    v_cubeTexCoords =reflect(normalize(worldPosT -u_eyePosition), normalize(a_normal));","#ifdef FBO","   v_worldPos = worldPosT;","#endif","    for(int index = 0;index<numberOfLights;index++)","    {","        if(u_enbleLights[index] == 1)","        {","","            if (0.0 == u_lights[index].position.w) // directional light?","            {","                attenuation = 1.0; // no attenuation","                lightDirection = normalize(vec3(u_lights[index].position));","            }","            else // point light or spotlight (or other kind of light)","            {","                vec3 positionToLightSource = vec3(u_lights[index].position) - fvObjectPosition.xyz ;","                float distance = length(positionToLightSource);","                lightDirection = normalize(positionToLightSource);","                float tempA= u_lights[index].constant + u_lights[index].linear * distance + u_lights[index].quadratic * distance * distance;","                attenuation = 1.0 / tempA;","                if (u_lights[index].spotCutoff <= 90.0) // spotlight?","                {","                    float clampedCosine = max(0.0001, dot(lightDirection, -normalize(u_lights[index].spotDirection)));","                    if (clampedCosine < u_lights[index].spotCosCutoff) // outside of spotlight cone?","                    {","                        attenuation = 0.0;","                    }","                    else","                    {","                        attenuation = attenuation * pow(clampedCosine, u_lights[index].spotExponent);","//attenuation *= clamp((clampedCosine-cos(radians(15.0)) ) / (cos(radians(10.0)) - cos(radians(15.0))), 0.0, 1.0);","                    }","                }","            }","","         //a side","        float fNDotL= clamp(abs(dot( vNormal, lightDirection )),0.3,1.0);","        vec3 diffuseReflection = attenuation","            * vec3(u_lights[index].diffuse) * vec3(u_materials.diffuse)","            * fNDotL;","        //the othor","        fNDotL= clamp(abs(dot( -vNormal, lightDirection )),0.3,1.0);","        vec3 diffuseReflectionBack = attenuation","            * vec3(u_lights[index].diffuse) * vec3(u_materials.diffuse)","            * fNDotL;","","         totalAmbient =vec3(totalAmbient) + vec3(u_lights[index].ambient) * vec3(u_materials.ambient);","		  float intensity = u_lights[index].intensity.x;","         totalDiffuse = totalDiffuse + diffuseReflection*intensity;","         totalDiffuseBack = totalDiffuseBack + diffuseReflectionBack*intensity;","","        vec3 eyeDirection = normalize(- fvObjectPosition.xyz );","        vec3 halfVector = normalize(lightDirection+ eyeDirection);","","		vec3 tempsp = vec3(u_lights[index].specular);","		float spv =  tempsp.x*tempsp.x+tempsp.y*tempsp.y+tempsp.z*tempsp.z;","			if(spv>0.0){","        //a side","        float fNDotH = max(0.0, abs(dot(vNormal,halfVector)));","        vec3 specularReflection = attenuation * vec3(u_lights[index].specular) * vec3(u_materials.specular)","               * pow(fNDotH, u_materials.shininess);","        //the other","        fNDotH = max(0.0, abs(dot(-vNormal,halfVector)));","        vec3 specularReflectionBack = attenuation * vec3(u_lights[index].specular) * vec3(u_materials.specular)","               * pow(fNDotH, u_materials.shininess);","","         totalSpecular = totalSpecular + specularReflection*intensity;","         totalSpecularBack = totalSpecularBack + specularReflectionBack*intensity;","			}","        }","    }","    v_diffuseColor = min(totalLighting+totalAmbient+totalDiffuse,vec3(1.0));","    v_specularColor = min(totalSpecular,vec3(1.0));","","    v_diffuseColorN = min(totalLighting+totalAmbient+totalDiffuseBack,vec3(1.0));","    v_specularColorN = min(totalSpecularBack,vec3(1.0));"," }"].join("\n"),e.ShaderStrings.MultilightFrag=["precision highp float;","//#define FBO ","uniform vec4 u_clipPlane;","uniform bool u_enableClip;","uniform bool u_useTex;","uniform bool u_useAmbientTex;","uniform bool u_useCubeMapTex;","uniform sampler2D u_sampler0;","uniform sampler2D u_sampler1;","uniform sampler2D u_sampler2;","uniform samplerCube u_samplerCube0;","uniform vec4 u_diffuse;","uniform vec4 u_selectColor;","varying vec3 v_position;","varying vec4 v_texCoords;","varying vec3 v_diffuseColor;","varying vec3 v_specularColor;","varying vec3 v_diffuseColorN;","varying vec3 v_specularColorN;","varying vec3 v_normal;","varying vec3 v_cubeTexCoords;","#ifdef FBO ","varying vec4 v_lightSpacePos;","varying vec3 v_worldNormal;","varying vec3 v_worldPos;","uniform vec3 u_shadowLPos;","uniform float u_xPixelOffset;","uniform float u_yPixelOffset;","#endif ","vec4 switchColor = vec4(1.0,1.0,1.0,1.0);","vec4 environment = vec4(1.0);","#ifdef FBO ","float ShadowCalculate(sampler2D sampler,vec4 fragPosLightSpace)","{","   float shadow = 1.0;","	vec3 proj =fragPosLightSpace.xyz/fragPosLightSpace.w;","   proj = proj *0.5+0.5;","   float currentDepth = proj.z;","   vec3 normal = normalize(v_worldNormal);","   vec3 lightDir = normalize(u_shadowLPos-v_worldPos);","   float bias = max(0.05*(1.0-dot(normal,lightDir)),0.005);","   for(int y=-1; y<=1;y++)","   {","       for(int x=-1; x<=1;x++)","        {","  				 float closeDepth = texture2D(sampler,(proj+vec3(float(x)*u_xPixelOffset,float(y)*u_yPixelOffset,0.05)).xy).x; ","                shadow += (closeDepth<(currentDepth-bias))?0.5:1.0;","         }","    }","   shadow /=16.0;","   shadow += 0.2;","   return shadow;","}","#endif ","vec2 sphereMap(vec3 normal, vec3 ecPosition3)","{","   float m;","   vec3 r;","   vec3 u;","   u = normalize(ecPosition3);","   r = reflect(u, normal);","   m = 2.0 * sqrt(r.x * r.x + r.y * r.y + (r.z + 1.0) * (r.z + 1.0))+0.0001;","   return vec2 (r.x / m + 0.5, r.y / m + 0.5);","}","","void main(void)","{","    if(u_enableClip)","    {","       float dPara = u_clipPlane.w;","		float testvalue = (dot(vec3(v_position.xyz),vec3(u_clipPlane.xyz))+dPara);","        if( testvalue<0.0)","        {","            discard;","        }","    }","    if(u_useTex)","    {","        switchColor = texture2D( u_sampler0, v_texCoords.xy );","    }","    if(u_useAmbientTex)","    {","        vec2 sphereCoords = sphereMap(v_normal,v_position);","        environment = texture2D(u_sampler1,sphereCoords.xy);","    }","    if(u_useCubeMapTex)","    {","        environment = textureCube(u_samplerCube0,v_cubeTexCoords.xyz);","    }","    vec4 texColor = switchColor *environment;"," 	float shadow = 1.0;","#ifdef FBO ","	 shadow = ShadowCalculate(u_sampler2,v_lightSpacePos);","#endif ","	float alpha = u_diffuse.a;","   if(u_selectColor.y < 0.8)","{","	alpha = 0.3;","}","    if(gl_FrontFacing)","    {","        gl_FragColor = vec4(vec3(texColor)*v_diffuseColor*(shadow)*vec3(u_selectColor)+vec3(v_specularColor)*(shadow),alpha);","    }","    else","    {","        gl_FragColor = vec4(vec3(texColor)*v_diffuseColorN*(shadow)*vec3(u_selectColor)+vec3(v_specularColorN)*(shadow),alpha);","    }","}",""].join("\n"),e.ShaderStrings.MeshPhongVert=["precision highp  float;","attribute vec3 a_position;","attribute vec3 a_normal;","attribute vec3 a_texCoords;","attribute vec3 a_center;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","uniform mat4 u_normalMat;","uniform mat4 u_textureMat;","uniform vec3 u_eyePosition;\n","uniform vec3 u_lightPosition;","varying vec3 v_viewDirection;","varying vec3 v_lightDirection;","varying vec3 v_normal;","varying vec3 v_position;","varying vec4 v_texCoords;","varying vec3 v_center;","varying vec3 v_cubeTexCoords;\n","void main() { ","gl_Position = u_projectionMat * u_viewMat*u_modelMat* vec4(a_position,1.0);","vec4 fvObjectPosition = u_viewMat*u_modelMat* vec4(a_position,1.0);","v_position = fvObjectPosition.xyz/fvObjectPosition.w;","v_texCoords = u_textureMat*vec4(a_texCoords.xy,1.0,1.0);;","v_viewDirection  =vec3(0,0,1)/* normalize( -fvObjectPosition.xyz)*/;","v_lightDirection = normalize(u_lightPosition/*-fvObjectPosition.xyz*/);"," v_normal         = normalize(vec3((u_normalMat * vec4(a_normal,0.0))));"," vec4 worldPos = u_modelMat * vec4(a_position,1.0);\n"," vec3 worldPosT = worldPos.xyz;\n","v_cubeTexCoords =reflect(normalize(worldPosT -u_eyePosition), normalize(a_normal));\n","v_center = a_center;","}"].join("\n"),e.ShaderStrings.MeshPhongFrag=["#extension GL_OES_standard_derivatives : enable \n","precision highp  float;","struct Light","{","    vec4 ambient;","    vec4 diffuse;","    vec4 specular;","    vec4 position;","    vec3 intensity;","};","","struct Materials","{","    vec4 emission;","    vec4 ambient;","    vec4 diffuse;","    vec4 specular;","    float shininess;","};","uniform Light u_lights;","//Materials","uniform Materials u_materials;","uniform vec4 u_diffuse;","uniform bool u_useDiffuseTex;","uniform bool u_useAmbientTex;","uniform bool u_useCubeMapTex;\n","uniform bool u_enableWireframe;","uniform bool u_enableOnlyWireframe;","uniform vec4 u_clipPlane;","uniform bool u_enableClip;","uniform sampler2D u_sampler0;","uniform sampler2D u_sampler1;","uniform samplerCube u_samplerCube0;\n","uniform vec4 u_selectColor;","varying vec3 v_viewDirection;","varying vec3 v_lightDirection;","varying vec3 v_normal;","varying vec3 v_position;","varying vec4 v_texCoords;","varying vec3 v_center;","varying vec3 v_cubeTexCoords;\n","vec4 diffuseTexColor = vec4(1.0,1.0,1.0,1.0);","vec4 environment = vec4(1.0,1.0,1.0,1.0);","vec2 sphereMap(vec3 normal, vec3 ecPosition3)","{","   float m;","   vec3 r;","   vec3 u;","   u = normalize(ecPosition3);","   r = reflect(u, normal);","   m = 2.0 * sqrt(r.x * r.x + r.y * r.y + (r.z + 1.0) * (r.z + 1.0))+0.0001;","   return vec2 (r.x / m + 0.5, r.y / m + 0.5);","}","float edgeFactorTri() {"," vec3 d = fwidth(v_center.xyz);","vec3 a3 = smoothstep(vec3(0.000001), d * 0.8, v_center.xyz);","  return min(min(a3.x, a3.y), a3.z);"," }","void main() { ","    if(u_enableClip)","    {","       float dPara = u_clipPlane.w;","		float testvalue = (dot(vec3(v_position.xyz),vec3(u_clipPlane.xyz))+dPara);","        if( testvalue<0.0)","        {","            discard;","        }","    }","float fNDotL =0.000001;","vec3 	halfvector;","float fNDotH;"," vec3  fvNormal ;","if(gl_FrontFacing){"," fvNormal         = normalize( v_normal );","}","else {"," fvNormal         = normalize( -v_normal );","}"," fNDotL           = clamp((dot( fvNormal, v_lightDirection )),0.2,1.0);","halfvector        =normalize(v_lightDirection+ v_viewDirection );"," fNDotH            = max(0.0,dot(fvNormal,halfvector));","vec3  fvTotalAmbient   = vec3(u_lights.ambient * u_materials.ambient);","vec3  fvTotalDiffuse   = vec3(u_lights.diffuse * fNDotL * u_materials.diffuse); ","vec3  fvTotalSpecular  = vec3(u_lights.specular * u_materials.specular) *( pow( max(fNDotH,0.0), u_materials.shininess));","if(u_useDiffuseTex == true){","   diffuseTexColor = texture2D( u_sampler0, v_texCoords.xy );","}","if(u_useAmbientTex == true)","{","  vec2 sphereCoords = sphereMap(v_normal,v_position);","  environment *= texture2D(u_sampler1,sphereCoords.xy);","}","if(u_useCubeMapTex)\n","{\n","    environment *= textureCube(u_samplerCube0,v_cubeTexCoords.xyz);\n","}\n","diffuseTexColor = diffuseTexColor*environment;","vec4 colorLinear = vec4(min((fvTotalAmbient + fvTotalDiffuse),vec3(1.0))*vec3(diffuseTexColor)*vec3(u_selectColor) + fvTotalSpecular,1.0);","if(u_enableWireframe){","gl_FragColor = vec4(colorLinear.xyz,u_diffuse.a)*vec4(vec3(mix( vec3( 0.0 ), vec3( 1.0 ), edgeFactorTri() )),1.0);","}","else if(u_enableOnlyWireframe){","gl_FragColor = vec4(colorLinear.xyz,u_diffuse.a)*vec4(1.0, 1.0, 1.0,(1.0-edgeFactorTri())*0.95);","}","else{","gl_FragColor = vec4(colorLinear.xyz,u_diffuse.a);","}","}"].join("\n"),e.ShaderStrings.MeshPhongFragMediump=["#extension GL_OES_standard_derivatives : enable \n","precision mediump  float;","precision mediump  int;","struct Light","{","    vec4 ambient;","    vec4 diffuse;","    vec4 specular;","    vec4 position;","    vec3 intensity;","};","","struct Materials","{","    vec4 emission;","    vec4 ambient;","    vec4 diffuse;","    vec4 specular;","    float shininess;","};","uniform Light u_lights;","//Materials","uniform Materials u_materials;","uniform vec4 u_diffuse;","uniform bool u_useDiffuseTex;","uniform bool u_useAmbientTex;","uniform bool u_enableWireframe;","uniform bool u_enableOnlyWireframe;","uniform vec4 u_clipPlane;","uniform bool u_enableClip;","uniform sampler2D u_sampler0;","uniform sampler2D u_sampler1;","uniform vec4 u_selectColor;","varying vec3 v_viewDirection;","varying vec3 v_lightDirection;","varying vec3 v_normal;","varying vec3 v_position;","varying vec4 v_texCoords;","varying vec3 v_center;","vec4 diffuseTexColor = vec4(1.0,1.0,1.0,1.0);","vec4 environment = vec4(1.0,1.0,1.0,1.0);","vec2 sphereMap(vec3 normal, vec3 ecPosition3)","{","   float m;","   vec3 r;","   vec3 u;","   u = normalize(ecPosition3);","   r = reflect(u, normal);","   m = 2.0 * sqrt(r.x * r.x + r.y * r.y + (r.z + 1.0) * (r.z + 1.0))+0.0001;","   return vec2 (r.x / m + 0.5, r.y / m + 0.5);","}","float edgeFactorTri() {"," vec3 d = fwidth(v_center.xyz);","vec3 a3 = smoothstep(vec3(0.0), d * 1.5, v_center.xyz);","  return min(min(a3.x, a3.y), a3.z);"," }","void main() { ","    if(u_enableClip)","    {","       float dPara = u_clipPlane.w;","		float testvalue = (dot(vec3(v_position.xyz),vec3(u_clipPlane.xyz))+dPara);","        if( testvalue<0.0)","        {","            discard;","        }","    }","float fNDotL =0.0;","vec3 	halfvector;","float fNDotH;"," vec3  fvNormal ;","if(gl_FrontFacing){"," fvNormal         = normalize( v_normal );","}","else {"," fvNormal         = normalize( -v_normal );","}"," fNDotL           = clamp((dot( fvNormal, v_lightDirection )),0.2,1.0);","halfvector        =normalize(v_lightDirection+ v_viewDirection );"," fNDotH            = max(0.0,dot(fvNormal,halfvector));","vec3  fvTotalAmbient   = vec3(u_lights.ambient) * vec3(u_materials.ambient);","vec3  fvTotalDiffuse   = vec3(u_lights.diffuse) * fNDotL * vec3(u_materials.diffuse); ","vec3  fvTotalSpecular  = vec3(u_lights.specular) * vec3(u_materials.specular) *( pow( max(fNDotH,0.0), u_materials.shininess) );","if(u_useDiffuseTex == true){","   diffuseTexColor = texture2D( u_sampler0, v_texCoords.xy );","}","if(u_useAmbientTex == true)","{","  vec2 sphereCoords = sphereMap(v_normal,v_position);","  environment = texture2D(u_sampler1,sphereCoords.xy);","}","diffuseTexColor = diffuseTexColor*environment;","vec4 colorLinear = vec4(min((fvTotalAmbient + fvTotalDiffuse),vec3(1.0))*diffuseTexColor*u_selectColor + fvTotalSpecular,1.0);","if(u_enableWireframe){","gl_FragColor = vec4(colorLinear.xyz,u_diffuse.a)*vec4(vec3(mix( vec3( 0.0 ), vec3( 1.0 ), edgeFactorTri() )),1.0);","}","else if(u_enableOnlyWireframe){","gl_FragColor = vec4(colorLinear.xyz,u_diffuse.a)*vec4(1.0, 1.0, 1.0,(1.0-edgeFactorTri())*0.95);","}","else{","gl_FragColor = vec4(colorLinear.xyz,u_diffuse.a);","}","}"].join("\n"),e.ShaderStrings.JewelFrontVert=["attribute vec3 a_position;","attribute vec3 a_normal;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","uniform mat4 u_normalMat;","uniform vec3 u_eyePosition;","uniform vec3 u_lightPosition;","uniform mat4 u_worldNormalMat;","varying vec3 v_position;","varying vec3 v_normal;","varying vec3 v_cubeRefractCoords;","varying vec4 fvObjectPosition;","varying vec3 eyeWorldDirection;","varying vec3 lightWorldDirection;","varying vec3 v_worldNormal;"," void main(void)","{","    gl_Position = u_projectionMat * u_viewMat * u_modelMat * vec4(a_position, 1.0);","    fvObjectPosition = u_viewMat * u_modelMat * vec4(a_position, 1.0);","   //vec4 tempCoords = u_textureMat*vec4(a_texCoords.xyz,1.0);","   v_position = fvObjectPosition.xyz;","    v_normal = normalize(vec3((u_normalMat * vec4(a_normal, 0.0))));","   vec4 worldPos = u_modelMat * vec4(a_position, 1.0);","    vec3 worldPosT = worldPos.xyz;","    eyeWorldDirection = normalize(u_eyePosition - worldPosT);","    lightWorldDirection = normalize(u_lightPosition - worldPosT);","    vec3 worldNormal = vec3(u_worldNormalMat * vec4(a_normal, 0.0));","    v_worldNormal = worldNormal;","    v_cubeRefractCoords = reflect(normalize(worldPosT - u_eyePosition), normalize(worldNormal));","}"].join("\n"),e.ShaderStrings.JewelFrontFrag=["precision highp float;","uniform bool u_useFrontTexture;","uniform bool u_useHighlightTexture;","uniform bool u_useFrontCubeTexture;","uniform sampler2D frontTexture;","uniform sampler2D highlightTexture;","uniform samplerCube frontCubeTexture;","uniform sampler2D depthTexture;","uniform bool u_keepDirection;","uniform vec4 u_diffuse;","uniform vec4 u_selectColor;","varying vec3 v_position;","//varying vec4 v_texCoords;","varying vec3 v_normal;","varying vec3 v_cubeRefractCoords;","varying vec4 fvObjectPosition;","varying vec3 eyeWorldDirection;","varying vec3 lightWorldDirection;","varying vec3 v_worldNormal;","vec4 switchColor = vec4(1.0, 1.0, 1.0, 1.0);","vec4 environment = vec4(1.0, 1.0, 1.0, 1.0);","vec4 environment1 = vec4(1.0, 1.0, 1.0, 1.0);","vec4 environment2 = vec4(1.0, 1.0, 1.0, 1.0);","vec4 highLightColor = vec4(0.0, 0.0, 0.0, 1.0);","vec2 sphereMap(vec3 normal, vec3 ecPosition3)","{","	float m;","	vec3 r;","	vec3 u;","	u = normalize(ecPosition3);","	r = reflect(u, normal);","	m = 2.0 * sqrt(r.x * r.x + r.y * r.y + (r.z + 1.0) * (r.z + 1.0)) + 0.0001;","	return vec2(r.x / m + 0.5, r.y / m + 0.5);","}","","void main(void)","{","	vec3 totalAmbient = vec3(0.0, 0.0, 0.0);","	vec3 totalDiffuse = vec3(0.0, 0.0, 0.0);","	vec3 totalSpecular = vec3(0.0, 0.0, 0.0);","	vec3 lightDirection;","	float attenuation = 1.0;","	vec3 diffuseColor;","	vec3 specularColor;","	vec3 vNormal;","	if (gl_FrontFacing)","	{","		vNormal = normalize(v_normal);","	}","	else","	{","		vNormal = normalize(-v_normal);","	}","	if (u_useFrontTexture == true)","	{","		vec2 sphereCoords = vec2(1.0, 1.0);","		vec2 matCapCoords = vec2(1.0, 1.0);","		if (u_keepDirection == true)","		{","			sphereCoords = sphereMap(normalize(v_worldNormal), v_position);","			matCapCoords = v_worldNormal.xy;","		}","		else","		{","			sphereCoords = sphereMap(normalize(v_normal), v_position);","			matCapCoords = v_normal.xy;","		}","		matCapCoords = matCapCoords * 0.5 + 0.5;","		environment1 = texture2D(frontTexture, matCapCoords.xy);","	}","	if (u_useHighlightTexture == true)","	{","		vec2 sphereCoords = sphereMap(normalize(v_normal), v_position);","		highLightColor = texture2D(highlightTexture, sphereCoords.xy);","	}","	if (u_useFrontCubeTexture == true)","	{","		environment2 = textureCube(frontCubeTexture, v_cubeRefractCoords.xyz);","		environment2.rbg = pow(environment2.rbg, vec3(1.0 / 1.7));","	}","	vec4 texColor = switchColor * environment1 * environment2;","	lightDirection = lightWorldDirection;","	float fNDotL = clamp(abs(dot(vNormal, lightDirection)), 0.3, 1.0);","	vec3 diffuseReflection =","		vec3(1.0, 1.0, 1.0) * fNDotL;","	totalDiffuse = diffuseReflection;","	vec3 eyeDirection = eyeWorldDirection;","	vec3 halfVector = normalize(lightDirection + eyeDirection);","	float fNDotH = max(0.0, abs(dot(vNormal, halfVector)));","	vec3 specularReflection = vec3(1.0) * pow(fNDotH, 10.0);","	vec3 lightDirection1 = normalize(vec3(vec4(1.0, 0.0, 0.0, 0.0)) - v_position);","	vec3 lightDirection2 = normalize(vec3(vec4(0.0, -1.0, 0.0, 0.0)) - v_position);","	vec3 lightDirection3 = normalize(vec3(vec4(0.0, 0.0, 1.0, 0.0)) - v_position);","	vec3 eyeDirection1 = vec3(0.0, 0.0, 0.0) - v_position;","	vec3 halfVector1 = normalize(lightDirection1 + eyeDirection1);","	float fNDotH1 = max(0.0, (dot(vNormal, halfVector1)));","	vec3 specularReflection1 = vec3(1.0) * pow(fNDotH1, 50.0);","	vec3 eyeDirection2 = eyeDirection1;","	vec3 halfVector2 = normalize(lightDirection2 + eyeDirection2);","	float fNDotH2 = max(0.0, (dot(vNormal, halfVector2)));","	vec3 specularReflection2 = vec3(1.0) * pow(fNDotH2, 50.0);","	vec3 eyeDirection3 = eyeDirection1;","	vec3 halfVector3 = normalize(lightDirection3 + eyeDirection3);","	float fNDotH3 = max(0.0, (dot(vNormal, halfVector3)));","	vec3 specularReflection3 = vec3(1.0) * pow(fNDotH3, 50.0);","	totalSpecular = totalSpecular + (specularReflection + specularReflection1 + specularReflection2 + specularReflection3);","	diffuseColor = min(totalDiffuse, vec3(1.0));","	specularColor = min(totalSpecular, vec3(1.0));","	if (u_useFrontTexture || u_useFrontCubeTexture)","	{","		if (u_useHighlightTexture == true)","		{","			gl_FragColor = vec4(vec3(texColor) * u_diffuse.xyz * vec3(u_selectColor) + highLightColor.rgb, u_diffuse.a);","		}","		else","		{","			gl_FragColor = vec4(vec3(texColor) * u_diffuse.xyz * vec3(u_selectColor), u_diffuse.a);","		}","		gl_FragColor.rbg = pow(gl_FragColor.rbg, vec3(1.0 / 1.2));","	}","	else","	{","		gl_FragColor = vec4(vec3(texColor) * diffuseColor * vec3(u_selectColor) + vec3(specularColor), u_diffuse.a);","	}","}"].join("\n"),e.ShaderStrings.FBODebugVert=["attribute vec3 a_position;","attribute vec2 a_texCoords;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","varying vec2 v_texCoords;","void main()","{","	gl_Position = u_projectionMat * u_viewMat * u_modelMat * vec4(a_position, 1.0);","	v_texCoords = a_texCoords;","}"].join("\n"),e.ShaderStrings.FBODebugFrag=["precision highp float;","uniform sampler2D u_sampler0;","varying vec2 v_texCoords;","varying vec3 v_position;","void main()","{","	vec4 pcolor = texture2D(u_sampler0, v_texCoords);","	vec4 tcolor = pcolor;","	gl_FragColor = tcolor;","}"].join("\n"),e.ShaderStrings.DepthVert=["attribute vec3 a_position;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","void main()","{","    gl_Position = u_projectionMat * u_viewMat * u_modelMat * vec4(a_position, 1.0);","}"].join("\n"),e.ShaderStrings.DepthFrag=["precision highp float;","const float PackUpscale = 256. / 255.; // fraction -> 0..1 (including 1)","const vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );","const float ShiftRight8 = 1. / 256.;","vec4 packDepthToRGBA( const in float v ) {","	vec4 r = vec4( fract( v * PackFactors ), v );","	r.yzw -= r.xyz * ShiftRight8; // tidy overflow","	return r * PackUpscale;","}","","void main()","{","    gl_FragColor = packDepthToRGBA( gl_FragCoord.z );","}"].join("\n"),e.ShaderStrings.JewelBackVert=["attribute vec3 a_position;","attribute vec3 a_normal;","//attribute vec3 a_texCoords;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","uniform mat4 u_normalMat;","//uniform mat4 u_textureMat;","uniform vec3 u_eyePosition;","uniform vec3 u_lightPosition;","uniform mat4 u_worldNormalMat;","varying vec3 v_position;","//varying vec4 v_texCoords;","varying vec3 v_normal;","varying vec3 v_cubeRefractCoords;","varying vec4 fvObjectPosition;","varying vec3 eyeWorldDirection;","varying vec3 lightWorldDirection;","varying vec3 v_worldNormal;","void main(void)","{","	gl_Position = u_projectionMat * u_viewMat * u_modelMat * vec4(a_position, 1.0);","	fvObjectPosition = u_viewMat * u_modelMat * vec4(a_position, 1.0);","	// vec4 tempCoords = u_textureMat*vec4(a_texCoords.xyz,1.0);","	v_position = fvObjectPosition.xyz;","	// v_texCoords = tempCoords;","	v_normal = normalize(vec3((u_normalMat * vec4(a_normal, 0.0))));","	vec4 worldPos = u_modelMat * vec4(a_position, 1.0);","	vec3 worldPosT = worldPos.xyz;","	eyeWorldDirection = normalize(u_eyePosition - worldPosT);","	lightWorldDirection = normalize(u_lightPosition - worldPosT);","	vec3 worldNormal = vec3(u_worldNormalMat * vec4(a_normal, 0.0));","	v_worldNormal = worldNormal;","	v_cubeRefractCoords = reflect(normalize(worldPosT - u_eyePosition), normalize(worldNormal));","}"].join("\n"),e.ShaderStrings.JewelBackFrag=["precision highp float;","uniform bool u_useBackTexture;","uniform bool u_useHighlightTexture;","uniform bool u_useBackCubeTexture;","uniform sampler2D backTexture;","uniform sampler2D highlightTexture;","uniform samplerCube backCubeTexture;","uniform sampler2D depthTexture;","uniform bool u_keepDirection;","uniform vec4 u_diffuse;","uniform vec4 u_selectColor;","varying vec3 v_position;","//varying vec4 v_texCoords;","varying vec3 v_normal;"
,"varying vec3 v_cubeRefractCoords;","varying vec4 fvObjectPosition;","varying vec3 eyeWorldDirection;","varying vec3 lightWorldDirection;","varying vec3 v_worldNormal;","vec4 switchColor = vec4(1.0, 1.0, 1.0, 1.0);","vec4 environment = vec4(1.0, 1.0, 1.0, 1.0);","vec4 environment1 = vec4(1.0, 1.0, 1.0, 1.0);","vec4 environment2 = vec4(1.0, 1.0, 1.0, 1.0);","vec4 highLightColor = vec4(0.0, 0.0, 0.0, 1.0);","vec2 sphereMap(vec3 normal, vec3 ecPosition3)","{","	float m;","	vec3 r;","	vec3 u;","	u = normalize(ecPosition3);","	r = reflect(u, normal);","	m = 2.0 * sqrt(r.x * r.x + r.y * r.y + (r.z + 1.0) * (r.z + 1.0)) + 0.0001;","	return vec2(r.x / m + 0.5, r.y / m + 0.5);","}","","void main(void)","{","	vec3 totalAmbient = vec3(0.0, 0.0, 0.0);","	vec3 totalDiffuse = vec3(0.0, 0.0, 0.0);","	vec3 totalSpecular = vec3(0.0, 0.0, 0.0);","	vec3 lightDirection;","	float attenuation = 1.0;","	vec3 diffuseColor;","	vec3 specularColor;","	vec3 vNormal;","	if (gl_FrontFacing)","	{","		vNormal = normalize(v_normal);","	}","	else","	{","		vNormal = normalize(-v_normal);","	}","	if (u_useBackTexture == true)","	{","		vec2 sphereCoords = vec2(1.0, 1.0);","		vec2 matCapCoords = vec2(1.0, 1.0);","		if (u_keepDirection == true)","		{","			sphereCoords = sphereMap(normalize(v_worldNormal), v_position);","			matCapCoords = v_worldNormal.xy;","		}","		else","		{","			sphereCoords = sphereMap(normalize(v_normal), v_position);","			matCapCoords = v_normal.xy;","		}","		matCapCoords = matCapCoords * 0.5 + 0.5;","		environment1 = texture2D(backTexture, matCapCoords.xy);","	}","	if (u_useHighlightTexture == true)","	{","		vec2 sphereCoords = sphereMap(normalize(v_normal), v_position);","		highLightColor = texture2D(highlightTexture, sphereCoords.xy);","	}","	if (u_useBackCubeTexture == true)","	{","		environment2 = textureCube(backCubeTexture, v_cubeRefractCoords.xyz);","		environment2.rbg = pow(environment2.rbg, vec3(1.0 / 1.7));","	}","	vec4 texColor = switchColor * environment1 * environment2;","	lightDirection = lightWorldDirection;","	float fNDotL = clamp(abs(dot(vNormal, lightDirection)), 0.3, 1.0);","	vec3 diffuseReflection =","		vec3(1.0, 1.0, 1.0) * fNDotL;","	totalDiffuse = diffuseReflection;","	vec3 eyeDirection = eyeWorldDirection;","	vec3 halfVector = normalize(lightDirection + eyeDirection);","	float fNDotH = max(0.0, abs(dot(vNormal, halfVector)));","	vec3 specularReflection = vec3(1.0) * pow(fNDotH, 10.0);","	vec3 lightDirection1 = normalize(vec3(vec4(1.0, 0.0, 0.0, 0.0)) - v_position);","	vec3 lightDirection2 = normalize(vec3(vec4(0.0, -1.0, 0.0, 0.0)) - v_position);","	vec3 lightDirection3 = normalize(vec3(vec4(0.0, 0.0, 1.0, 0.0)) - v_position);","	vec3 eyeDirection1 = vec3(0.0, 0.0, 0.0) - v_position;","	vec3 halfVector1 = normalize(lightDirection1 + eyeDirection1);","	float fNDotH1 = max(0.0, (dot(vNormal, halfVector1)));","	vec3 specularReflection1 = vec3(1.0) * pow(fNDotH1, 50.0);","	vec3 eyeDirection2 = eyeDirection1;","	vec3 halfVector2 = normalize(lightDirection2 + eyeDirection2);","	float fNDotH2 = max(0.0, (dot(vNormal, halfVector2)));","	vec3 specularReflection2 = vec3(1.0) * pow(fNDotH2, 50.0);","	vec3 eyeDirection3 = eyeDirection1;","	vec3 halfVector3 = normalize(lightDirection3 + eyeDirection3);","	float fNDotH3 = max(0.0, (dot(vNormal, halfVector3)));","	vec3 specularReflection3 = vec3(1.0) * pow(fNDotH3, 50.0);","	totalSpecular = totalSpecular + (specularReflection + specularReflection1 + specularReflection2 + specularReflection3);","	diffuseColor = min(totalDiffuse, vec3(1.0));","	specularColor = min(totalSpecular, vec3(1.0));","	if (u_useBackTexture || u_useBackCubeTexture)","	{","		if (u_useHighlightTexture == true)","		{","			gl_FragColor = vec4(vec3(texColor) * vec3(u_diffuse) * vec3(u_selectColor) + highLightColor.rgb, u_diffuse.a);","		}","		else","		{","			gl_FragColor = vec4(vec3(texColor) * vec3(u_diffuse) * vec3(u_selectColor), u_diffuse.a);","		}","		gl_FragColor.rbg = pow(gl_FragColor.rbg, vec3(1.0 / 1.2));","	}","	else","	{","		gl_FragColor = vec4(vec3(texColor) * diffuseColor * vec3(u_selectColor) + vec3(specularColor), u_diffuse.a);","	}","}"].join("\n"),e.ShaderStrings.RingVert=["attribute vec3 a_position;","attribute vec3 a_normal;","//attribute vec3 a_texCoords;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","uniform mat4 u_normalMat;","//uniform mat4 u_textureMat;","uniform vec3 u_eyePosition;","uniform vec3 u_lightPosition;","uniform mat4 u_worldNormalMat;","varying vec3 v_position;","//varying vec4 v_texCoords;","varying vec3 v_normal;","varying vec3 v_cubeRefractCoords;","varying vec4 fvObjectPosition;","varying vec3 eyeWorldDirection;","varying vec3 lightWorldDirection;","varying vec3 v_worldNormal;","void main(void)","{","	gl_Position = u_projectionMat * u_viewMat * u_modelMat * vec4(a_position, 1.0);","	fvObjectPosition = u_viewMat * u_modelMat * vec4(a_position, 1.0);","	v_position = fvObjectPosition.xyz;","	v_normal = normalize(vec3((u_normalMat * vec4(a_normal, 0.0))));","	vec4 worldPos = u_modelMat * vec4(a_position, 1.0);","	vec3 worldPosT = worldPos.xyz;","	eyeWorldDirection = normalize(u_eyePosition - worldPosT);","	lightWorldDirection = normalize(u_lightPosition - worldPosT);","	vec3 worldNormal = vec3(u_worldNormalMat * vec4(a_normal, 0.0));","	v_worldNormal = worldNormal;","	v_cubeRefractCoords = reflect(normalize(worldPosT - u_eyePosition), normalize(worldNormal));","}"].join("\n"),e.ShaderStrings.RingFrag=["precision highp float;","uniform bool u_useFrontTexture;","uniform bool u_useFrontCubeTexture;","uniform sampler2D frontTexture;","uniform samplerCube frontCubeTexture;","uniform bool u_useHighlightTexture;","uniform sampler2D highlightTexture;","uniform sampler2D depthTexture;","uniform vec4 u_diffuse;","uniform vec4 u_selectColor;","varying vec3 v_position;","//varying vec4 v_texCoords;","varying vec3 v_normal;","varying vec3 v_cubeRefractCoords;","varying vec4 fvObjectPosition;","varying vec3 eyeWorldDirection;","varying vec3 lightWorldDirection;","varying vec3 v_worldNormal;","vec4 switchColor = vec4(1.0, 1.0, 1.0, 1.0);","vec4 environment = vec4(1.0, 1.0, 1.0, 1.0);","vec4 environment1 = vec4(1.0, 1.0, 1.0, 1.0);","vec4 environment2 = vec4(1.0, 1.0, 1.0, 1.0);","vec4 highLightColor = vec4(0.0, 0.0, 0.0, 1.0);","vec2 sphereMap(vec3 normal, vec3 ecPosition3)","{","	float m;","	vec3 r;","	vec3 u;","	u = normalize(ecPosition3);","	r = reflect(u, normal);","	m = 2.0 * sqrt(r.x * r.x + r.y * r.y + (r.z + 1.0) * (r.z + 1.0)) + 0.0001;","	return vec2(r.x / m + 0.5, r.y / m + 0.5);","}","","void main(void)","{","	vec3 totalAmbient = vec3(0.0, 0.0, 0.0);","	vec3 totalDiffuse = vec3(0.0, 0.0, 0.0);","	vec3 totalSpecular = vec3(0.0, 0.0, 0.0);","	vec3 lightDirection;","	float attenuation = 1.0;","	vec3 diffuseColor;","	vec3 specularColor;","	vec3 vNormal;","	if (gl_FrontFacing)","	{","		vNormal = normalize(v_normal);","	}","	else","	{","		vNormal = normalize(-v_normal);","	}","	if (u_useFrontTexture == true)","	{","		vec2 matCapCoords = vec2(1.0, 1.0);","		matCapCoords = vNormal.xy;","		matCapCoords = matCapCoords * 0.5 + 0.5;","		environment1 = texture2D(frontTexture, matCapCoords.xy);","	}","	if (u_useFrontCubeTexture == true)","	{","		environment2 = textureCube(frontCubeTexture, v_cubeRefractCoords.xyz);","		environment2.rbg = pow(environment2.rbg, vec3(1.0 / 1.7));","	}","	if (u_useHighlightTexture == true)","	{","		vec2 matCapCoords = vec2(1.0, 1.0);","		matCapCoords = vNormal.xy;","		matCapCoords = matCapCoords * 0.5 + 0.5;","		highLightColor = texture2D(highlightTexture, matCapCoords.xy);","	}","	vec4 texColor = switchColor * environment1 * environment2;","	if (u_useFrontCubeTexture || u_useFrontTexture)","	{","		if (u_useHighlightTexture == true)","		{","			gl_FragColor = vec4(vec3(texColor) * vec3(u_diffuse) * vec3(u_selectColor) + highLightColor.rgb, u_diffuse.a);","		}","		else","		{","			gl_FragColor = vec4(vec3(texColor) * vec3(u_diffuse) * vec3(u_selectColor), u_diffuse.a);","		}","		gl_FragColor.rbg = pow(gl_FragColor.rbg, vec3(1.0 / 1.2));","	}","	else","	{","		gl_FragColor = vec4(vec3(texColor) * diffuseColor * vec3(u_selectColor) + vec3(specularColor), u_diffuse.a);","	}","}"].join("\n"),e.ShaderStrings.JewelTypeVert=["attribute vec3 a_position;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","","void main(void)","{","	gl_Position = u_projectionMat * u_viewMat * u_modelMat * vec4(a_position, 1.0);","}"].join("\n"),e.ShaderStrings.JewelTypeFrag=["precision highp float;","uniform float mixFactor;","void main(void)","{","	gl_FragColor = vec4(0.0, 0.0, 0.0, mixFactor);","}"].join("\n"),e.ShaderStrings.JewelHighLightVert=["attribute vec3 a_position;","attribute vec3 a_normal;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","uniform mat4 u_normalMat;","varying vec3 v_position;","varying vec3 v_normal;","void main(void)","{","	gl_Position = u_projectionMat * u_viewMat * u_modelMat * vec4(a_position, 1.0);","	vec4 fvObjectPosition = u_viewMat * u_modelMat * vec4(a_position, 1.0);","	v_position = fvObjectPosition.xyz / fvObjectPosition.w;","	v_normal = normalize(vec3((u_normalMat * vec4(a_normal, 0.0))));","}"].join("\n"),e.ShaderStrings.JewelHighLightFrag=["precision highp float;","varying vec3 v_position;","varying vec3 v_normal;","uniform vec3 u_specular;","vec3 lightPoss[4];","vec3 lightSpecular[4];","void main()","{","	lightPoss[0] = normalize(vec3(-1.0, 0.0, 1.0));","	lightPoss[1] = normalize(vec3(0.0, 1.0, 0.0));","	lightPoss[2] = normalize(vec3(1.0, 0.0, 1.0));","	lightPoss[3] = normalize(vec3(0.0, -1.0, 0.0));","	lightSpecular[0] = vec3(0.9, 0.9, 0.9);","	lightSpecular[1] = vec3(0.9, 0.9, 0.9);","	lightSpecular[2] = vec3(0.9, 0.9, 0.9);","	lightSpecular[3] = vec3(0.9, 0.9, 0.9);","	vec3 totalAmbient = vec3(0.0, 0.0, 0.0);","	vec3 totalDiffuse = vec3(0.0, 0.0, 0.0);","	vec3 totalSpecular = vec3(0.0, 0.0, 0.0);","	vec3 lightDirection;","	float attenuation = 1.0;","	vec3 diffuseColor;","	vec3 specularColor;","	vec3 vNormal;","	if (gl_FrontFacing)","	{","		vNormal = normalize(v_normal);","	}","	else","	{","		vNormal = normalize(-v_normal);","	}","	vec3 viewDir = normalize(v_position);","	for (int i = 0; i < 4; i++)","	{","		vec3 H = normalize(lightPoss[i] - viewDir);","		float specular_bsdf = pow(max(dot(vNormal, H), 0.0), 30.0);","		totalSpecular += lightSpecular[i] * specular_bsdf;","	}","	vec3 fragcolor = vec3(0.0);","	fragcolor = totalSpecular * u_specular.rgb;","	gl_FragColor = vec4(fragcolor, 1.0);","}"].join("\n"),e.ShaderStrings.JewelBlendQuadVert=["attribute vec3 a_position;","attribute vec2 a_texCoords;","varying vec2 v_texCoords;","","void main(void)","{","	gl_Position = vec4(a_position, 1.0);","	v_texCoords = a_texCoords;","}"].join("\n"),e.ShaderStrings.JewelBlendQuadFrag=["precision highp float;","uniform sampler2D u_sampler0;","uniform sampler2D u_sampler1;","uniform sampler2D u_sampler2;","uniform sampler2D u_sampler3;","varying vec2 v_texCoords;","void main()","{","	vec4 frontColor = texture2D(u_sampler0, v_texCoords);","	vec4 backColor = texture2D(u_sampler1, v_texCoords);","	vec4 jewelType = texture2D(u_sampler2, v_texCoords);","	vec4 highlight = texture2D(u_sampler3, v_texCoords);","	vec4 FragColor = vec4(0.0);","	FragColor = vec4(mix(frontColor.rgb, backColor.rgb, jewelType.a) + highlight.rgb * 0.40, 1.0);","	gl_FragColor = FragColor;","}"].join("\n"),e.ShaderStrings.JewelFinalQuadVert=["attribute vec3 a_position;","attribute vec2 a_texCoords;","varying vec2 v_texCoords;","","void main(void)","{","	gl_Position = vec4(a_position, 1.0);","	v_texCoords = a_texCoords;","}"].join("\n"),e.ShaderStrings.JewelFinalQuadFrag=["precision highp float;","uniform sampler2D u_sampler0;","uniform sampler2D u_sampler1;","uniform sampler2D u_sampler2;","uniform sampler2D u_sampler3;","varying vec2 v_texCoords;","","","const float UnpackDownscale = 255. / 256.; // 0..1 -> fraction (excluding 1)","","const vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );","const vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );","float unpackRGBAToDepth( const in vec4 v ) {","	return dot( v, UnpackFactors );","}","","void main()","{","	vec4 blendColor = texture2D(u_sampler0, v_texCoords);","	float jewelDepth = unpackRGBAToDepth(texture2D(u_sampler1,v_texCoords)); ","	vec4 ringArmColor = texture2D(u_sampler2, v_texCoords);","	float ringArmDepth = unpackRGBAToDepth(texture2D(u_sampler3,v_texCoords)); ","	vec4 FragColor = vec4(0.0);","   if(jewelDepth<ringArmDepth)","   {","      FragColor = vec4(blendColor.rgb,1.0); ","   }","   else","   {","    FragColor = vec4(ringArmColor.rgb,1.0);","   }","	gl_FragColor = vec4(FragColor.rgb,1.0);","}"].join("\n"),e.ShaderStrings.OutlineVert=["precision highp  float;","attribute vec3 a_position;","attribute vec3 a_normal;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","uniform mat4 u_normalMat;","varying vec3 v_position;","void main() { ","   gl_Position = u_projectionMat * u_viewMat*u_modelMat* vec4(a_position,1.0);","   vec4 fvObjectPosition = u_viewMat*u_modelMat* vec4(a_position,1.0);","   v_position = fvObjectPosition.xyz/fvObjectPosition.w;","}"].join("\n"),e.ShaderStrings.OutlineFrag=["#extension GL_OES_standard_derivatives : enable \n","precision highp  float;","uniform vec4 u_diffuse;","uniform vec4 u_clipPlane;","uniform bool u_enableClip;","varying vec3 v_position;","void main() { ","    if(u_enableClip)","    {","       float dPara = u_clipPlane.w;","		float testvalue = (dot(vec3(v_position.xyz),vec3(u_clipPlane.xyz))+dPara);","        if( testvalue<0.0)","        {","            discard;","        }","    }","   gl_FragColor =u_diffuse;","}"].join("\n"),e.ShaderStrings.QuadVert=["attribute vec3 a_position;","","void main(void)","{","	gl_Position = vec4(a_position, 1.0);","}"].join("\n"),e.ShaderStrings.QuadFrag=["precision highp float;","uniform vec4 u_diffuse;","void main()","{","	gl_FragColor = u_diffuse;","}"].join("\n"),e.ShaderStrings.GaussianBlurVert=["attribute  vec3 a_position;","attribute  vec2 a_texCoords;","varying  vec2 v_texCoords;","","void main(void)","{","    gl_Position = vec4(a_position,1.0);","    v_texCoords = a_texCoords;","}"].join("\n"),e.ShaderStrings.GaussianBlurFrag=["precision highp float;","","varying vec2 v_texCoords;","","uniform sampler2D image;","","uniform bool horizontal;","","uniform float tex_offset;","","void main()","{","float weight[5];","weight[0] = 0.227027;","weight[1] = 0.1945946;","weight[2] = 0.1216216;","weight[3] = 0.054054;","weight[4] = 0.016216;","   ","    vec4 result = texture2D(image, v_texCoords) * weight[0]; // current fragment's contribution","    if (horizontal)","    {","      result += texture2D(image, v_texCoords + vec2(tex_offset * 1.0, 0.0)) * weight[1];","      result += texture2D(image, v_texCoords - vec2(tex_offset * 1.0, 0.0)) * weight[1];","      result += texture2D(image, v_texCoords + vec2(tex_offset * 2.0, 0.0)) * weight[2];","      result += texture2D(image, v_texCoords - vec2(tex_offset * 2.0, 0.0)) * weight[2];","      result += texture2D(image, v_texCoords + vec2(tex_offset * 3.0, 0.0)) * weight[3];","     result += texture2D(image, v_texCoords - vec2(tex_offset * 3.0, 0.0)) * weight[3];","      result += texture2D(image, v_texCoords + vec2(tex_offset * 4.0, 0.0)) * weight[4];","      result += texture2D(image, v_texCoords - vec2(tex_offset * 4.0, 0.0)) * weight[4];","    }","    else","    {","      result += texture2D(image, v_texCoords + vec2(0.0, tex_offset * 1.0)) * weight[1];","      result += texture2D(image, v_texCoords - vec2(0.0, tex_offset * 1.0)) * weight[1];","      result += texture2D(image, v_texCoords + vec2(0.0, tex_offset * 2.0)) * weight[2];","      result += texture2D(image, v_texCoords - vec2(0.0, tex_offset * 2.0)) * weight[2];","      result += texture2D(image, v_texCoords + vec2(0.0, tex_offset * 3.0)) * weight[3];","     result += texture2D(image, v_texCoords - vec2(0.0, tex_offset * 3.0)) * weight[3];","      result += texture2D(image, v_texCoords + vec2(0.0, tex_offset * 4.0)) * weight[4];","     result += texture2D(image, v_texCoords - vec2(0.0, tex_offset * 4.0)) * weight[4];","    }","    gl_FragColor = vec4(result);","}"].join("\n"),e.ShaderStrings.GaussianBlurOutlineVert=["attribute vec3 a_position;","attribute  vec2 a_texCoords;","varying  vec2 v_texCoords;","","void main(void)","{","	gl_Position = vec4(a_position, 1.0);","    v_texCoords = a_texCoords;","}"].join("\n"),e.ShaderStrings.GaussianBlurOutlineFrag=["precision highp float;","uniform sampler2D height;","uniform sampler2D model;","varying  vec2 v_texCoords;","void main()","{","   vec4 gaussianColor = texture2D(height, v_texCoords);","   vec4 modelColor = texture2D(model, v_texCoords);","  vec4 final = (gaussianColor - modelColor);","  if(final.r<0.0) final.r = 0.0;\n","  if(final.g<0.0) final.g = 0.0;\n","  if(final.b<0.0) final.b = 0.0;\n","  if(final.a<0.0) final.a = 0.0;\n"," ","	gl_FragColor = vec4(final.rgb*4.0,final.a*4.0);","}"].join("\n"),e.ShaderStrings.CombineOutlineVert=["attribute vec3 a_position;","attribute  vec2 a_texCoords;","varying  vec2 v_texCoords;","","void main(void)","{","	gl_Position = vec4(a_position, 1.0);","    v_texCoords = a_texCoords;","}"].join("\n"),e.ShaderStrings.CombineOutlineFrag=["precision highp float;","uniform sampler2D u_sampler0;","varying  vec2 v_texCoords;","void main()","{","   vec4 gaussianColor = texture2D(u_sampler0, v_texCoords);","  float alpha = 1.0;"," //  if(gaussianColor.r<=0.0 &&gaussianColor.g<=0.0&&gaussianColor.b<=0.0 ) alpha = 0.0;","	gl_FragColor = gaussianColor;","}"].join("\n"),e.ShaderStrings.Phong_vert=["#define PHONG","varying vec3 vViewPosition;","varying vec3 vNormal;","#include <common>","#include <uv_pars_vertex>","#include <displacementmap_pars_vertex>","#include <shadowmap_pars_vertex>","#include <clip_pars_vertex>","void main(){","  #include <uv_vertex>","  #include <beginnormal_vertex>","  #include <defaultnormal_vertex>","vNormal = normalize( transformedNormal );","  #include <begin_vertex>","#include <displacementmap_vertex>","  #include <project_vertex>","vViewPosition = - mvPosition.xyz;","  #include <worldpos_vertex>","#include <shadowmap_vertex>","}"].join("\n"),e.ShaderStrings.Phong_frag=["#define PHONG","uniform vec4 diffuse;","uniform vec4 emissive;","uniform vec4 specular;","uniform float shininess;","uniform float opacity;","uniform float selected;","#include <common>","#include <packing>","#include <clip_pars_fragment>","#include <uv_pars_fragment>","#include <map_pars_fragment>","#include <ssao_par_fragment>","#include <emissivemap_pars_fragment>","#include <bsdfs>","#include <lights_pars>","#include <matcap_pars_fragment>","#include <lights_phong_pars_fragment>","#include <normalmap_pars_fragment>","#include <specularmap_pars_fragment>","#include <shadowmap_pars_fragment>\n","void main(){","   #include <clip_fragment>","   vec4 diffuseColor = vec4( diffuse.xyz, diffuse.a );","   ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","   vec3 totalEmissiveRadiance = emissive.rgb;","   #include <map_fragment>","   #include <specularmap_fragment>","   #include <normal_fragment>","   #include <emissivemap_fragment>","	#include <lights_phong_fragment>","   #include <lights_template>","	float ssaoFactor = 1.0;","	#include <ssao_fragment>","	vec3 outgoingLight = ssaoFactor*(reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular)+ totalEmissiveRadiance ;","   gl_FragColor = vec4(outgoingLight, opacity);","   #include <encodings_fragment>","   if(selected == 0.0){","       gl_FragColor.rgb = gl_FragColor.rgb;","   }else{","       gl_FragColor.rgb = gl_FragColor.rgb * u_selectColor.rgb;","   }","}"].join("\n"),e.ShaderStrings.PBR_vert=["#define PHYSICAL","#define USE_LOCAL_CUBEMAP","uniform float gamma;","varying vec3 vViewPosition;","varying vec3 vNormal;","#include <common>","#include <uv_pars_vertex>","#include <parallax_corrected_cubemap_pars_vertex>","#include <displacementmap_pars_vertex>","#include <shadowmap_pars_vertex>","#include <clip_pars_vertex>","#include <z_depth_pars_vert>","void main(){","  #include <uv_vertex>","  #include <beginnormal_vertex>","  #include <defaultnormal_vertex>","vNormal = normalize( transformedNormal );","  #include <begin_vertex>","#include <displacementmap_vertex>","  #include <project_vertex>","vViewPosition = - mvPosition.xyz;","  #include <worldpos_vertex>"," #include <parallax_corrected_cubemap_vertex>","   #include <shadowmap_vertex>","   #include <z_depth_vert>","}"].join("\n"),e.ShaderStrings.PBR_frag=["#define PHYSICAL","#define USE_LOCAL_CUBEMAP","#define TONE_MAPPING","uniform vec4 diffuse;","uniform vec4 emissive;","uniform float roughness;","vec4 testColor = vec4(0.0);","uniform float metalness;","uniform float opacity;","uniform float gamma;","uniform sampler2D lut;","vec3 test = vec3(1.0,1.0,1.0);","#ifndef STANDARD","uniform float clearCoat;","uniform float clearCoatRoughness;","#endif","varying vec3 vViewPosition;","varying vec3 vNormal;","#include <common>","#include <packing>","#include <clip_pars_fragment>","#include <uv_pars_fragment>","#include <map_pars_fragment>","#include <aomap_pars_fragment>","#include <ssao_par_fragment>","#include <emissivemap_pars_fragment>","#include <parallax_corrected_cubemap_pars_fragment>","#include <envmap_pars_fragment>","#include <bsdfs>","#include <lights_pars>","#include <lights_physical_pars_fragment>","#include <normalmap_pars_fragment>","#include <shadowmap_pars_fragment>","#include <z_depth_pars_frag>","#include <tonemapping_pars_fragment>","#include <metallicRoughness_pars_fragment>","void main(){","#include <z_depth_frag>","   #include <clip_fragment>","   vec4 diffuseColor = vec4( diffuse.xyz, diffuse.a );","   ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","vec3 totalEmissiveRadiance = emissive.rgb;","   #include <map_fragment>","   #include <metallicRoughness_fragment>","   #include <normal_fragment>","#include <emissivemap_fragment>","	#include <lights_physical_fragment>","   #include <lights_template>","#include <aomap_fragment>","float ssaoFactor = 1.0;","#include <ssao_fragment>","	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular+ totalEmissiveRadiance ;","//   outgoingLight =OptimizedCineonToneMapping(outgoingLight);","   gl_FragColor = vec4(outgoingLight, opacity);","#include <tonemapping_fragment>","#include <encodings_fragment>","gl_FragColor.rgb = gl_FragColor.rgb*u_selectColor.rgb;","}"].join("\n"),e.ShaderStrings.MatCap_vert=["#define PHONG","varying vec3 vViewPosition;","varying vec3 vNormal;","#include <common>","#include <uv_pars_vertex>","#include <displacementmap_pars_vertex>","#include <shadowmap_pars_vertex>","#include <clip_pars_vertex>","void main(){","  #include <uv_vertex>","  #include <beginnormal_vertex>","  #include <defaultnormal_vertex>","vNormal = normalize( transformedNormal );","  #include <begin_vertex>","#include <displacementmap_vertex>","  #include <project_vertex>","vViewPosition = - mvPosition.xyz;","  #include <worldpos_vertex>","#include <shadowmap_vertex>","}"].join("\n"),e.ShaderStrings.MatCap_frag=["#define PHONG","uniform vec4 diffuse;","uniform vec4 emissive;","uniform vec4 specular;","uniform float shininess;","uniform float opacity;","#include <common>","#include <packing>","#include <clip_pars_fragment>","#include <uv_pars_fragment>","#include <map_pars_fragment>","#include <ssao_par_fragment>","#include <bsdfs>","#include <lights_pars>","#include <matcap_pars_fragment>","#include <lights_phong_pars_fragment>","#include <normalmap_pars_fragment>","#include <specularmap_pars_fragment>","#include <shadowmap_pars_fragment>","void main(){","   #include <clip_fragment>","   vec4 diffuseColor = vec4( diffuse.xyz, diffuse.a );","   ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","vec3 totalEmissiveRadiance = emissive.rgb;","   #include <map_fragment>","   #include <specularmap_fragment>","   #include <normal_fragment>","	#include <lights_phong_fragment>","   #include <lights_template>","	float ssaoFactor = 1.0;","	#include <ssao_fragment>","	vec3 outgoingLight = ssaoFactor*(reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular)+ totalEmissiveRadiance  ;","   gl_FragColor = vec4(outgoingLight, opacity );","#include <encodings_fragment>","gl_FragColor.rgb = gl_FragColor.rgb*u_selectColor.rgb;","}"].join("\n"),e.ShaderStrings.Depth_vert=["varying vec3 vViewPosition;","#include <common>","#include <clip_pars_vertex>","void main()","{","    #include <begin_vertex>","    #include <project_vertex>","vViewPosition = - mvPosition.xyz;","}"].join("\n"),e.ShaderStrings.Depth_frag=["varying vec3 vViewPosition;","#include <common>","#include <packing>","#include <clip_pars_fragment>","void main()","{","   #include <clip_fragment>","    gl_FragColor = packDepthToRGBA(gl_FragCoord.z);","}"].join("\n"),e.ShaderStrings.Distance_vert=["#include <common>","#include <z_depth_pars_vert>","varying vec3 vWorldPosition;","void main()","{","    #include <begin_vertex>","    #include <project_vertex>","    #include <worldpos_vertex>","    vWorldPosition = worldPosition.xyz;","   #include <z_depth_vert>","}"].join("\n"),e.ShaderStrings.Distance_frag=["#define DISTANCE","uniform vec3 referencePosition;","uniform float nearDistance;","uniform float farDistance;","varying vec3 vWorldPosition;","#include <common>","#include <packing>","#include <z_depth_pars_frag>","","void main()","{","#include <z_depth_frag>","    vec4 diffuseColor = vec4( 1.0 );","float dist = length(vWorldPosition - referencePosition);","dist = (dist - nearDistance) / (farDistance - nearDistance);","dist = saturate(dist); // clamp to [ 0, 1 ]","gl_FragColor = packDepthToRGBA(dist);","}"].join("\n"),e.ShaderStrings.EarlyZCulling_vert=["#include <common>","void main()","{","    #include <begin_vertex>","    #include <project_vertex>","}"].join("\n"),e.ShaderStrings.EarlyZCulling_frag=["#include <common>","","void main()","{","gl_FragColor =vec4(0.0,0.0,0.0,1.0);","}"].join("\n"),e.ShaderStrings.DraggerVert=["//precision highp  float;","attribute vec3 a_position;","attribute vec3 a_normal;","uniform vec4 u_color;","uniform mat4 u_modelMat;","uniform mat4 u_viewMat;","uniform mat4 u_projectionMat;","uniform mat4 u_normalMat;","varying vec4 v_color;","varying vec3 v_normal;","varying vec3 v_position;","void main() { ","gl_Position = u_projectionMat*u_viewMat*u_modelMat*vec4(a_position,1.0);","v_color = u_color;","gl_Position.z = -gl_Position.w;","v_normal = vec3(u_normalMat*vec4(a_normal,0));","v_position = vec3(gl_Position);","}"].join("\n"),e.ShaderStrings.DraggerFrag=["precision mediump  float;","varying vec4 v_color;","varying vec3 v_normal;","varying vec3 v_position;","void main() { ","const vec3 lightPos =  vec3(10.0,10.0,10.0);","const vec3 lightColor =  vec3(1.0,1.0,1.0);","vec3 norm = normalize(v_normal);","vec3 lightDir = normalize(lightPos - v_position);","float diff = max(dot(norm, lightDir), 0.0);","vec3 diffuse = (diff +0.5) * lightColor;","vec4 result = vec4(diffuse.xyz,1.0) * v_color;","gl_FragColor =vec4(result.xyzw);","}"].join("\n"),e.ShaderLib={Base:{VertexShader:e.ShaderStrings.BaseVert,FragmentShader:e.ShaderStrings.BaseFrag},Dragger:{VertexShader:e.ShaderStrings.DraggerVert,FragmentShader:e.ShaderStrings.DraggerFrag},Background:{VertexShader:e.ShaderStrings.BackgroundVert,FragmentShader:e.ShaderStrings.BackgroundFrag},Multilight:{VertexShader:e.ShaderStrings.MultilightVert,FragmentShader:e.ShaderStrings.MultilightFrag},Axis:{VertexShader:e.ShaderStrings.AxisVert,FragmentShader:e.ShaderStrings.AxisFrag},Edge:{VertexShader:e.ShaderStrings.EdgeVert,FragmentShader:e.ShaderStrings.EdgeFrag},Image:{VertexShader:e.ShaderStrings.ImageVert,FragmentShader:e.ShaderStrings.ImageFrag},CubeMap:{VertexShader:e.ShaderStrings.CubeMapVert,FragmentShader:e.ShaderStrings.CubeMapFrag},MeshPhong:{VertexShader:e.ShaderStrings.MeshPhongVert,FragmentShader:e.ShaderStrings.MeshPhongFrag,FragmentShaderMedium:e.ShaderStrings.MeshPhongFragMediump},JewelFront:{VertexShader:e.ShaderStrings.JewelFrontVert,FragmentShader:e.ShaderStrings.JewelFrontFrag},JewelBack:{VertexShader:e.ShaderStrings.JewelBackVert,FragmentShader:e.ShaderStrings.JewelBackFrag},Ring:{VertexShader:e.ShaderStrings.RingVert,FragmentShader:e.ShaderStrings.RingFrag},JewelType:{VertexShader:e.ShaderStrings.JewelTypeVert,FragmentShader:e.ShaderStrings.JewelTypeFrag},JewelHighLight:{VertexShader:e.ShaderStrings.JewelHighLightVert,FragmentShader:e.ShaderStrings.JewelHighLightFrag},JewelBlendQuad:{VertexShader:e.ShaderStrings.JewelBlendQuadVert,FragmentShader:e.ShaderStrings.JewelBlendQuadFrag},JewelFinalQuad:{VertexShader:e.ShaderStrings.JewelFinalQuadVert,FragmentShader:e.ShaderStrings.JewelFinalQuadFrag},FBODebug:{VertexShader:e.ShaderStrings.FBODebugVert,FragmentShader:e.ShaderStrings.FBODebugFrag},Depth:{VertexShader:e.ShaderStrings.DepthVert,FragmentShader:e.ShaderStrings.DepthFrag},Outline:{VertexShader:e.ShaderStrings.OutlineVert,FragmentShader:e.ShaderStrings.OutlineFrag},Quad:{VertexShader:e.ShaderStrings.QuadVert,FragmentShader:e.ShaderStrings.QuadFrag},GaussianBlur:{VertexShader:e.ShaderStrings.GaussianBlurVert,FragmentShader:e.ShaderStrings.GaussianBlurFrag},GaussianBlurOutline:{VertexShader:e.ShaderStrings.GaussianBlurOutlineVert,FragmentShader:e.ShaderStrings.GaussianBlurOutlineFrag},CombineOutline:{VertexShader:e.ShaderStrings.CombineOutlineVert,FragmentShader:e.ShaderStrings.CombineOutlineFrag},PBR:{VertexShader:e.ShaderStrings.PBRVert,FragmentShader:e.ShaderStrings.PBRFrag},PhongMaterial:{VertexShader:e.ShaderStrings.Phong_vert,FragmentShader:e.ShaderStrings.Phong_frag},PbrMaterial:{VertexShader:e.ShaderStrings.PBR_vert,FragmentShader:e.ShaderStrings.PBR_frag},MatCapMaterial:{VertexShader:e.ShaderStrings.MatCap_vert,FragmentShader:e.ShaderStrings.MatCap_frag},DepthMaterial:{VertexShader:e.ShaderStrings.Depth_vert,FragmentShader:e.ShaderStrings.Depth_frag},DistanceMaterial:{VertexShader:e.ShaderStrings.Distance_vert,FragmentShader:e.ShaderStrings.Distance_frag},EarlyZCullingMaterial:{VertexShader:e.ShaderStrings.EarlyZCulling_vert,FragmentShader:e.ShaderStrings.EarlyZCulling_frag}}})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(r){var i=t.call(this,r)||this;i.shaderList=new e.StringDictionary,i.currentAction=null,i.m_shaderStrMap={},i.m_SMTMap={},i.m_currentParameters={},i.m_prefixParameters=[];var s=i.getMaxPrecision("highp");if(s!=="highp"){console.warn("Shader:","highp","not supported, using",s,"instead.");var o=e.ShaderLib.MeshPhong.FragmentShader;o=o.replace(/highp/,s);var u=e.ShaderLib.Image.FragmentShader;u=u.replace(/highp/,s);var a=e.ShaderLib.Background.FragmentShader;a=a.replace(/highp/,s);var f=e.ShaderLib.Axis.FragmentShader;f=f.replace(/highp/,s),i.CreateShaderProgramFrmCde(n.MeshPhong,e.ShaderLib.MeshPhong.VertexShader,o),i.CreateShaderProgramFrmCde(n.Image,e.ShaderLib.Image.VertexShader,u),i.CreateShaderProgramFrmCde(n.Background,e.ShaderLib.Background.VertexShader,a),i.CreateShaderProgramFrmCde(n.Axis,e.ShaderLib.Axis.VertexShader,f)}else i.CreateShaderProgramFrmCde(n.MeshPhong,e.ShaderLib.MeshPhong.VertexShader,e.ShaderLib.MeshPhong.FragmentShader),i.CreateShaderProgramFrmCde(n.Background,e.ShaderLib.Background.VertexShader,e.ShaderLib.Background.FragmentShader),i.CreateShaderProgramFrmCde(n.Axis,e.ShaderLib.Axis.VertexShader,e.ShaderLib.Axis.FragmentShader),i.CreateShaderProgramFrmCde(n.Image,e.ShaderLib.Image.VertexShader,e.ShaderLib.Image.FragmentShader);i.CreateShaderProgramFrmCde(n.Image,e.ShaderLib.Dragger.VertexShader,e.ShaderLib.Dragger.FragmentShader);var l=["shaderType","precision","emissiveMap","ambientMap","diffuseMap","specularMap","normalMap","displacementMap","envMap","albedoMap","metallicRoughnessMap","ambientOcclusiontMap","envIrradianceMap","numAllLights","numDirectionalLights","numPointLights","numSpotLights","numHemisphereLights","shadowMapEnabled","shadowMapType","doubleSided","outputEncoding","diffuseMapEncoding","envMapEncoding","ssao","matcapMap","useClearCoat"];for(var c=0;c<27;c++)i.m_prefixParameters.push(l[c]),i.m_currentParameters[l[c]]="N";return i}return __extends(n,t),n.prototype.GetEffect=function(t){var n=this.shaderList.get(t);if(n!==undefined)return n;if(e.ShaderLib.hasOwnProperty(t)){var r=this.CreateShaderProgramFrmCde
(t,e.ShaderLib[t].VertexShader,e.ShaderLib[t].FragmentShader);return r}return null},n.prototype.CreateShaderProgramFrmCde=function(t,n,r){var i=this.shaderList.get(t);if(i!==undefined)return i;var s=new e.Shader(this.gl,this.gl.VERTEX_SHADER),o=new e.Shader(this.gl,this.gl.FRAGMENT_SHADER);s.CompileSourceCode(n),o.CompileSourceCode(r);var u=new e.ShaderProgram(this.gl,s,o);if(u.LinkProgram())return this.shaderList.add(t,u),u.SetName(name),u;console.log("End: "+t)},n.prototype.GetCurrentAction=function(){return this.currentAction},n.prototype.SetCurrentAction=function(e){this.currentAction=e},n.prototype.getMaxPrecision=function(t){if(t==="highp"){if(this.gl.getShaderPrecisionFormat(e.GL.VERTEX_SHADER,e.GL.HIGH_FLOAT).precision>0&&this.gl.getShaderPrecisionFormat(e.GL.FRAGMENT_SHADER,e.GL.HIGH_FLOAT).precision>0)return"highp";t="mediump"}return t==="mediump"&&this.gl.getShaderPrecisionFormat(e.GL.VERTEX_SHADER,e.GL.MEDIUM_FLOAT).precision>0&&this.gl.getShaderPrecisionFormat(e.GL.FRAGMENT_SHADER,e.GL.MEDIUM_FLOAT).precision>0?"mediump":"lowp"},n.prototype.FilterEmptyLine=function(e){return e!==""},n.prototype.GenerateExtensions=function(t){var n=[t.envMap==="Y"&&e.RenderContext.GetExtension(this.gl,"EXT_shader_texture_lod")?"#extension GL_EXT_shader_texture_lod : enable":"",t.normalMap==="Y"?"#extension GL_OES_standard_derivatives : enable":""];return n.filter(this.FilterEmptyLine).join("\n")},n.prototype.ReplaceLightNums=function(e,t){return e.replace(/NUM_DIR_LIGHTS/g,t.numDirectionalLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemisphereLights)},n.prototype.ParseIncludes=function(t){var n=this,r=/^[ \t]*#include +<([\w\d.]+)>/gm,i=function(t,r){var i=e.ShaderChunkStrings[r];if(i===undefined)throw new Error("Can not resolve #include <"+r+">");return n.ParseIncludes(i)};return t.replace(r,i)},n.prototype.GetProgramCode=function(t){var n=t.GetMaterialType(),r=[];r.push(t.GetMaterialTypeStr(n));if(n===e.MaterialType.MaterialType_Shader){var i=t;r.push(i.VertexShader()),r.push(i.FragmentShader())}for(var s=0,o=this.m_prefixParameters;s<o.length;s++){var u=o[s];r.push(this.m_currentParameters[u])}return r.join(",")},n.prototype.AcquireProgram=function(e,t,n,r){var i=null;i=this.shaderList.get(r);if(i===null||i===undefined)i=this.CreateShaderProgram(this.gl,e,t,n,r);return i},n.prototype.GenerateDefines=function(e){var t=[];for(var n in e){var r=e[n];if(r===!1)continue;t.push(r)}return t.join("\n")},n.prototype.CreateShaderProgram=function(e,t,n,r,i){var s=n,o=r,u="ENVTEXTURE_TYPE_CUBE",a="ENVTEXTURE_MODE_REFLECTION",f={envTextureTypeDefine:u,envTextureModeDefine:a};this.SetEnvTexture(t,u,a);var l=2.2,c=this.GenerateExtensions(this.m_currentParameters),h=this.GenerateDefines(t.Define()),p=this.GetPrefixShader(this.m_currentParameters,l,h,c,f);s=this.ParseIncludes(s),s=this.ReplaceLightNums(s,this.m_currentParameters),o=this.ParseIncludes(o),o=this.ReplaceLightNums(o,this.m_currentParameters);var d=p.prefixVertex+s,v=p.prefixFragment+"\n"+o,m=this.CreateShaderProgramFrmCdeNew(i,d,v);return m},n.prototype.GetEncodingCompents=function(t){var n=[];switch(t){case e.TextureEncodingType.TEXEL_ENCODING_TYPE_LINEAR:n.push("Linear"),n.push("( value )");case e.TextureEncodingType.TEXEL_ENCODING_TYPE_SRGB:n.push("sRGB"),n.push("( value )");case e.TextureEncodingType.TEXEL_ENCODING_TYPE_RGBE:n.push("RGBE"),n.push("( value )");case e.TextureEncodingType.TEXEL_ENCODING_TYPE_RGBM7:n.push("RGBM"),n.push("( value, 7.0 )");case e.TextureEncodingType.TEXEL_ENCODING_TYPE_RGBM16:n.push("RGBM"),n.push("( value, 16.0 )");case e.TextureEncodingType.TEXEL_ENCODING_TYPE_RGBD:n.push("RGBD"),n.push("( value, 256.0 )");case e.TextureEncodingType.TEXEL_ENCODING_TYPE_GAMMA:n.push("Gamma"),n.push("( value, float( GAMMA_FACTOR ) )");default:return n}},n.prototype.GetTexelDecodingFunction=function(e,t){var n=this.GetEncodingCompents(t);return"vec4 "+e+"( vec4 value )\n{\n return "+n[0]+"ToLinear"+n[1]+";\n}\n"},n.prototype.GetTexelEncodingFunction=function(e,t){var n=this.GetEncodingCompents(t);return"vec4 "+e+"( vec4 value )\n{\n return LinearTo"+n[0]+n[1]+";\n}\n"},n.prototype.CreateShaderProgramFrmCdeNew=function(t,n,r){var i=this.shaderList.get(t);if(i!==undefined)return i;var s=new e.Shader(this.gl,this.gl.VERTEX_SHADER),o=new e.Shader(this.gl,this.gl.FRAGMENT_SHADER);s.CompileSourceCode(n),o.CompileSourceCode(r);var u=new e.ShaderProgram(this.gl,s,o);if(u.LinkProgram())return this.shaderList.add(t,u),u.SetName(t),u;console.log("End: "+t)},n.prototype.GetPrefixShader=function(t,n,r,i,s){var o,u,a=e.Parameters.Instance().m_shadowMapType==2?"SHADOWMAP_TYPE_PCF\n":e.Parameters.Instance().m_shadowMapType==1?" SHADOWMAP_TYPE_BASE\n":"SHADOWMAP_TYPE_PCF_SOFT\n";return o=["precision "+t.precision+" float;\n","precision "+t.precision+" int;\n","#define SHADER_NAME "+t.shaderType,i,r,"#define GAMMA_FACTOR "+n,t["diffuseMap"]!="N"||t["albedoMap"]!="N"?"#define USE_DIFFUSEMAP\n":"",t["envMap"]!="N"?"#define USE_ENV_TEXTURE\n":"",t["envMap"]!="N"?"#define "+s.envTextureModeDefine+"\n":"",t["ambientOcclusiontMap"]!="N"?"#define USE_AOMAP\n":"",t["emissiveMap"]!="N"?"#define USE_EMISSIVEMAP\n":"",t["normalMap"]!="N"?"#define USE_NORMALMAP\n":"",t["displacementMap"]!="N"?"#define USE_DISPLACEMENTMAP\n":"",t["specularMap"]!="N"?"#define USE_SPECULARMAP\n":"",t["metallicRoughnessMap"]!="N"?"#define USE_METALLIC_ROUGHNESS_TEXTURE\n":"",(t["doubleSided"]!="N"?"#define DOUBLE_SIDED\n":"")+(t["shadowMapEnabled"]!="N"&&t["numAllLights"]!="0"?"#define USE_SHADOWMAP\n":""),t["shadowMapEnabled"]!="N"&&t["numAllLights"]!="0"?"#define "+a+"\n":"","uniform mat4 modelMatrix;\n","uniform mat4 u_worldNormalMat;\n","uniform mat4 projectionMatrix;\n","uniform mat4 viewMatrix;\n","uniform mat4 normalMatrix;\n","uniform mat4 u_textureMat;\n","uniform vec3 cameraPosition;\n","attribute vec3 a_position;\n","attribute vec3 a_normal;\n","attribute vec3 a_texCoords;\n","attribute vec3 a_center;\n"].filter(this.FilterEmptyLine).join("\n"),u=[i,"precision "+t.precision+" float;","precision "+t.precision+" int;",r,"#define USE_CLIP","#define SHADER_NAME "+t.shaderType,"#define GAMMA_FACTOR "+n,t["diffuseMap"]!="N"||t["albedoMap"]!="N"?"#define USE_DIFFUSEMAP\n":"",t["envMap"]!="N"?"#define USE_ENV_TEXTURE\n":"",t["envMap"]!="N"?"#define "+s.envTextureTypeDefine+"\n":"",t["envMap"]!="N"?"#define "+s.envTextureModeDefine+"\n":"",t["ambientOcclusiontMap"]!="N"?"#define USE_AOMAP\n":"",t["emissiveMap"]!="N"?"#define USE_EMISSIVEMAP\n":"",t["normalMap"]!="N"?"#define USE_NORMALMAP\n":"",t["matcapMap"]!="N"?"#define USE_MATCAPMAP\n":"",t["specularMap"]!="N"?"#define USE_SPECULARMAP\n":"",t["metallicRoughnessMap"]!="N"?"#define USE_METALLIC_ROUGHNESS_TEXTURE\n":"",t["doubleSided"]!="N"?"#define DOUBLE_SIDED\n":"",t["ssao"]!="N"?"#define SSAO\n":"",t["shadowMapEnabled"]!="N"&&t["numAllLights"]!="0"?"#define USE_SHADOWMAP\n":"",t["shadowMapEnabled"]!="N"&&t["numAllLights"]!="0"?"#define "+a+"\n":"",t["envMap"]!="N"&&e.RenderContext.GetExtension(this.gl,"EXT_shader_texture_lod")?"#define TEXTURE_LOD_EXT\n":"",t["outputEncoding"]!="N"||t["diffuseMapEncoding"]!="N"||t["envMap"]!="N"?e.ShaderChunkStrings.encodings_pars_fragment:"",t["diffuseMapEncoding"]!="N"?this.GetTexelDecodingFunction("mapTexelToLinear",parseInt(t.diffuseMapEncoding)):"",t["envMap"]!="N"?this.GetTexelDecodingFunction("envMapTexelToLinear",parseInt(t.envMapEncoding)):"",t["outputEncoding"]!="N"?this.GetTexelEncodingFunction("linearToOutputTexel",parseInt(t.outputEncoding)):"","uniform vec3 cameraPosition;","uniform vec4 u_selectColor;","uniform mat4 viewMatrix;","uniform bool u_enableWireframe;","uniform bool u_enableOnlyWireframe;"].filter(this.FilterEmptyLine).join("\n"),{prefixVertex:o,prefixFragment:u}},n.prototype.ResetParameters=function(){for(var e=0,t=this.m_prefixParameters.length;e<t;e++)this.m_currentParameters[this.m_prefixParameters[e]]="N"},n.prototype.CreateParameters=function(t,n){this.ResetParameters();var r=t.GetMaterialType(),i="";this.m_currentParameters.shaderType=r.toString();switch(r){case e.MaterialType.MaterialType_Phong:var s=t;s&&(this.m_currentParameters.outputEncoding=this.GetTextureEncodingFromMap(null,s.IsGammaOutpute()).toString(),this.m_currentParameters.ambientMap=s.GetAmbientMap()?"Y":"N",this.m_currentParameters.diffuseMap=s.GetDiffuseMap()?"Y":"N",this.m_currentParameters.specularMap=s.GetSpecularMap()?"Y":"N",this.m_currentParameters.displacementMap=s.GetDisplacementMap()?"Y":"N",this.m_currentParameters.emissiveMap=s.GetEmissiveMap()?"Y":"N",this.m_currentParameters.normalMap=s.GetNormalMap()?"Y":"N",this.m_currentParameters.matcapMap=s.GetMatcapMap()?"Y":"N",this.m_currentParameters.envMap=s.GetEvnMap()?"Y":"N",s.GetDiffuseMap()?this.m_currentParameters.diffuseMapEncoding=this.GetTextureEncodingFromMap(s.GetDiffuseMap(),s.GetDiffuseMap().GetOGLObj()?s.GetDiffuseMap().IsGammaInput():!1).toString():this.m_currentParameters.diffuseMapEncoding="0",s.GetEvnMap()?this.m_currentParameters.envMapEncoding=this.GetTextureEncodingFromMap(s.GetEvnMap(),s.GetEvnMap()?s.GetEvnMap().IsGammaInput():!1).toString():this.m_currentParameters.envMapEncoding="0");break;case e.MaterialType.MaterialType_Pbr:var o=t;o&&(this.m_currentParameters.outputEncoding=this.GetTextureEncodingFromMap(null,o.IsGammaOutpute()).toString(),this.m_currentParameters.albedoMap=o.AlbedoMap()?"Y":"N",this.m_currentParameters.metallicRoughnessMap=o.MetalnessRoughnessMap()?"Y":"N",this.m_currentParameters.emissiveMap=o.EmissiveMap()?"Y":"N",this.m_currentParameters.normalMap=o.NormalMap()?"Y":"N",this.m_currentParameters.displacementMap=o.DisplacementMap()?"Y":"N",this.m_currentParameters.envIrradianceMap=o.EnvIrradianceMap()||!0?"Y":"N",this.m_currentParameters.envMap=o.EnvMap()||!0?"Y":"N",this.m_currentParameters.ambientOcclusiontMap=o.AmbientOcclusiontMap()?"Y":"N",this.m_currentParameters.diffuseMapEncoding=this.GetTextureEncodingFromMap(o.AlbedoMap(),o.AlbedoMap()?o.AlbedoMap().IsGammaInput():!0).toString(),this.m_currentParameters.envMapEncoding=this.GetTextureEncodingFromMap(o.EnvMap(),o.EnvMap()?o.EnvMap().IsGammaInput():!0).toString(),this.m_currentParameters.useClearCoat=o.UseClearCoat()?"Y":"N");break;case e.MaterialType.MaterialType_MatCap:var u=t;this.m_currentParameters.outputEncoding=this.GetTextureEncodingFromMap(null,u.IsGammaOutpute()).toString(),this.m_currentParameters.normalMap=u.GetNormalMap()?"Y":"N",this.m_currentParameters.matcapMap=u.GetMatcapMap()?"Y":"N",this.m_currentParameters.diffuseMapEncoding=this.GetTextureEncodingFromMap(u.GetDiffuseMap(),u.GetDiffuseMap()?u.GetDiffuseMap().IsGammaInput():!1).toString(),this.m_currentParameters.envMapEncoding=this.GetTextureEncodingFromMap(u.GetEvnMap(),u.GetEvnMap()?u.GetEvnMap().IsGammaInput():!0).toString()}this.m_currentParameters.numDirectionalLights=n.DirectionalLightNumber().toString(),this.m_currentParameters.numPointLights=n.PointLightNumber().toString(),this.m_currentParameters.numSpotLights=n.SpotLightNumber().toString(),this.m_currentParameters.numHemisphereLights=n.HemisphereLightNumber().toString(),this.m_currentParameters.numAllLights=(n.DirectionalLightNumber()+n.PointLightNumber()+n.SpotLightNumber()+n.HemisphereLightNumber()).toString(),this.m_currentParameters.shadowMapEnabled=e.Parameters.Instance().m_shadowMapEnabled?"Y":"N",this.m_currentParameters.doubleSided=e.Parameters.Instance().m_doubleSided?"Y":"N",this.m_currentParameters.precision="highp",this.m_currentParameters.ssao=e.Parameters.Instance().m_useSSAO?"Y":"N"},n.prototype.GetTextureEncodingFromMap=function(t,n){var r=e.TextureEncodingType.TEXEL_ENCODING_TYPE_GAMMA;return t?t&&(r=t.TextureEncoding()):r=e.TextureEncodingType.TEXEL_ENCODING_TYPE_LINEAR,r==e.TextureEncodingType.TEXEL_ENCODING_TYPE_LINEAR&&n&&(r=e.TextureEncodingType.TEXEL_ENCODING_TYPE_GAMMA),r},n.prototype.SetEnvTexture=function(t,n,r){if(this.m_currentParameters.envMap==="Y")if(t.GetMaterialType()==e.MaterialType.MaterialType_Phong){var i=t;switch(i.GetEnvTextureMapping()){case e.EnvTextureMappingType.CubeReflectionMapping:case e.EnvTextureMappingType.CubeRefractionMapping:n.envMapTypeDefine="ENVTEXTURE_TYPE_CUBE";break;case e.EnvTextureMappingType.CubeUVReflectionMapping:case e.EnvTextureMappingType.CubeUVRefractionMapping:n.envMapTypeDefine="ENVTEXTURE_TYPE_CUBE_UV";break;case e.EnvTextureMappingType.EquirectangularReflectionMapping:case e.EnvTextureMappingType.EquirectangularRefractionMapping:n.envMapTypeDefine="ENVTEXTURE_TYPE_EQUIREC";break;case e.EnvTextureMappingType.SphericalReflectionMapping:n.envMapTypeDefine="ENVTEXTURE_TYPE_SPHERE"}switch(i.GetEnvTextureMapping()){case e.EnvTextureMappingType.CubeRefractionMapping:case e.EnvTextureMappingType.EquirectangularRefractionMapping:r.envMapModeDefine="ENVTEXTURE_MODE_REFRACTION"}}else if(t.GetMaterialType()==e.MaterialType.MaterialType_Pbr){var s=t;switch(s.EnvTextureMapping()){case e.EnvTextureMappingType.CubeReflectionMapping:case e.EnvTextureMappingType.CubeRefractionMapping:n.envMapTypeDefine="ENVTEXTURE_TYPE_CUBE";break;case e.EnvTextureMappingType.CubeUVReflectionMapping:case e.EnvTextureMappingType.CubeUVRefractionMapping:n.envMapTypeDefine="ENVTEXTURE_TYPE_CUBE_UV";break;case e.EnvTextureMappingType.EquirectangularReflectionMapping:case e.EnvTextureMappingType.EquirectangularRefractionMapping:n.envMapTypeDefine="ENVTEXTURE_TYPE_EQUIREC";break;case e.EnvTextureMappingType.SphericalReflectionMapping:n.envMapTypeDefine="ENVTEXTURE_TYPE_SPHERE"}switch(s.EnvTextureMapping()){case e.EnvTextureMappingType.CubeRefractionMapping:case e.EnvTextureMappingType.EquirectangularRefractionMapping:r.envMapModeDefine="ENVTEXTURE_MODE_REFRACTION"}}},n.Base="Base",n.MeshPhong="MeshPhong",n.BaseVertex="BaseVertex",n.Background="Background",n.Wireframe="Wireframe",n.Edge="Edge",n.Brdf="Brdf",n.LightWithoutTexture="LightWithoutTexture",n.LightWithTexture="LightWithTexture",n.Axis="Axis",n.Dragger="Dragger",n.Image="Image",n.Multilight="Multilight",n.CubeMap="CubeMap",n.DepthMap="DepthMap",n.FBODebug="FBODebug",n.PlaneShadow="PlaneShadow",n.Blur="Blur",n.Specular="Specular",n.EdgeDetection="EdgeDetection",n.JewelFront="JewelFront",n.JewelBack="JewelBack",n.JewelType="JewelType",n.JewelHighLight="JewelHighLight",n.JewelBlendQuad="JewelBlendQuad",n.JewelFinalQuad="JewelFinalQuad",n.Ring="Ring",n.Depth="Depth",n.Outline="Outline",n.Quad="Quad",n.GaussianBlur="GaussianBlur",n.GaussianBlurOutline="GaussianBlurOutline",n.CombineOutline="CombineOutline",n.SceneGround="SceneGround",n.SsaoEffect="SsaoEffect",n.SsaoBlur="SsaoBlur",n}(e.GPUObject);e.ShaderManager=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(e,t,n,r){r===void 0&&(r=1),this.location=0,this.name="",this.size=1,this.location=e,this.type=t,this.name=n,this.size=r}return e}();e.ShaderParameter=t})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.SMT_MultiLight=0]="SMT_MultiLight",e[e.SMT_Brdf=1]="SMT_Brdf",e[e.SMT_DepthMap=2]="SMT_DepthMap",e[e.SMT_Image=3]="SMT_Image",e[e.SMT_FBODebug=4]="SMT_FBODebug",e[e.SMT_CubeMap=5]="SMT_CubeMap",e[e.SMT_BaseVertex=6]="SMT_BaseVertex",e[e.SMT_Background=7]="SMT_Background",e[e.SMT_Axis=8]="SMT_Axis",e[e.SMT_Dragger=9]="SMT_Dragger",e[e.SMT_Edge=10]="SMT_Edge",e[e.SMT_PlaneShadow=11]="SMT_PlaneShadow",e[e.SMT_Blur=12]="SMT_Blur",e[e.SMT_Specular=13]="SMT_Specular",e[e.SMT_EdgeDetection=14]="SMT_EdgeDetection",e[e.SMT_Quad=15]="SMT_Quad",e[e.SMT_MultilightPerFrag=16]="SMT_MultilightPerFrag",e[e.SMT_NoteEdge=17]="SMT_NoteEdge",e[e.SMT_NoteImage=18]="SMT_NoteImage",e[e.SMT_CapPlane=19]="SMT_CapPlane",e[e.SMT_JewelFront=20]="SMT_JewelFront",e[e.SMT_JewelBack=21]="SMT_JewelBack",e[e.SMT_JewelFinalQuad=22]="SMT_JewelFinalQuad",e[e.SMT_Ring=23]="SMT_Ring",e[e.SMT_JewelType=24]="SMT_JewelType",e[e.SMT_JewelHighLight=25]="SMT_JewelHighLight",e[e.SMT_JewelBlendQuad=26]="SMT_JewelBlendQuad",e[e.SMT_Outline=27]="SMT_Outline",e[e.SMT_GaussianBlur=28]="SMT_GaussianBlur",e[e.SMT_GaussianBlurOutline=29]="SMT_GaussianBlurOutline",e[e.SMT_CombineOutline=30]="SMT_CombineOutline",e[e.SMT_SceneGround=31]="SMT_SceneGround",e[e.SMT_SsaoEffect=32]="SMT_SsaoEffect",e[e.SMT_SsaoBlur=33]="SMT_SsaoBlur"})(t=e.ShaderMaterialType||(e.ShaderMaterialType={}));var n=function(t){function n(n,r,i){var s=t.call(this,n)||this;return s.program=null,s.vsh=null,s.fsh=null,s.dirty=!1,s.shaderUniformMap=new e.StringDictionary,s.shaderAttributeMap=new e.StringDictionary,s.isLinked=!1,s.shaderUniformKeyArry=[],s.shaderUniformValueArray=[],s.CreateShaderProgram(),s.vsh=r,s.fsh=i,s.AddShader(r),s.AddShader(i),s}return __extends(n,t),n.prototype.GetShaderUniformKeyValueArray=function(){var e=this,t={key:this.shaderUniformKeyArry,value:this.shaderUniformValueArray};return this.shaderUniformKeyArry.length>0?t:(this.shaderUniformMap.forEach(function(t,n){e.shaderUniformKeyArry.push(t),e.shaderUniformValueArray.push(n)}),t)},n.prototype.GetShaderUniformMap=function(){return this.shaderUniformMap},n.prototype.IsDirty=function(){return this.dirty},n.prototype.MakeDirty=function(){this.dirty=!0},n.prototype.AddShader=function(e){var t=!1;return e.IsCompiled()?(this.program!==null&&(this.gl.attachShader(this.program,e.ShaderObject()),this.gl.VERTEX_SHADER===e.GetShaderType()?this.vsh=e:this.gl.FRAGMENT_SHADER===e.GetShaderType()&&(this.fsh=e),t=!0),t):(t=!1,t)},n.prototype.GetShaderProgram=function(){return this.program},n.prototype.LinkProgram=function(){if(this.vsh===null&&this.fsh===null&&!this.vsh.IsCompiled()&&!this.fsh.IsCompiled())return this.isLinked=!1,this.isLinked;this.gl.linkProgram(this.program);var e=this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS);return e?(this.isLinked=!0,this.MakeDirty()):this.gl.getProgramInfoLog(this.program)!==""&&(console.log("M3DJS Program Info: ",this.gl.getProgramInfoLog(this.program)),this.isLinked=!1,this.gl.deleteProgram(this.program)),this.vsh.DeleteShader(),this.fsh.DeleteShader(),this.isLinked},n.prototype.UseProgram=function(){if(!this.IsDirty()){this.gl.useProgram(this.program);return}var t=256,n="",r=0;this.shaderAttributeMap.clear(),this.shaderUniformMap.clear();if(this.isLinked){this.gl.useProgram(this.program);var i=this.gl.FLOAT,s=void 0,o=void 0,u=void 0,a=void 0,f;r=this.gl.getProgramParameter(this.program,this.gl.ACTIVE_UNIFORMS);for(var l=0;l<r;l++){s=this.gl.getActiveUniform(this.program,l),o=s.name,u=o.indexOf("[0]"),a=o.indexOf("."),u!==-1&&a===-1&&(o=o.substring(0,u)),f=this.gl.getUniformLocation(this.program,o);var c=new e.ShaderParameter(f,s.type,o);this.shaderUniformMap.add(o,c)}r=0,i=this.gl.FLOAT,r=this.gl.getProgramParameter(this.program,this.gl.ACTIVE_ATTRIBUTES);for(var h=0;h<r;h++){s=this.gl.getActiveAttrib(this.program,h),o=s.name,u=o.indexOf("[0]"),a=o.indexOf("."),u!==-1&&a===-1&&(o=o.substring(0,u)),f=this.gl.getAttribLocation(this.program,o);var c=new e.ShaderParameter(f,s.type,o);this.shaderAttributeMap.add(o,c)}this.dirty=!1}},n.prototype.CreateShaderProgram=function(){this.program=this.gl.createProgram()},n.prototype.ReleaseShaderProgram=function(){this.gl.useProgram(null)},n.prototype.DeleteShaderProgram=function(){this.isLinked=!1},n.prototype.GetAttributeLocation=function(e){return this.gl.getAttribLocation(this.program,e)},n.prototype.GetUniformLocation=function(e){return this.gl.getUniformLocation(this.program,e)},n.prototype.BindAttributeLocation=function(e,t){this.gl.bindAttribLocation(this.program,t,e)},n.prototype.EnableAttributeArray=function(e){this.gl.enableVertexAttribArray(e)},n.prototype.DisableAttributeArray=function(e){this.gl.disableVertexAttribArray(e)},n.prototype.SetVertexAttribPointer=function(e,t,n,r,i){this.gl.vertexAttribPointer(e,t,n,!1,r,i)},n.prototype.GetShaderUniformParameter=function(e){var t=this.shaderUniformMap.get(e);return t},n.prototype.GetShaderAttributeParameter=function(e){var t=this.shaderAttributeMap.get(e);return t},n.prototype.SetUniformValue=function(t){var n=[];for(var r=1;r<arguments.length;r++)n[r-1]=arguments[r];if(n.length===1){if(n[0]instanceof Float32Array){if(this.program!==null){var i=this.GetShaderUniformParameter(t);if(i!==undefined)switch(i.type){case this.gl.FLOAT:this.gl.uniform1f(i.location,n[0][0]);break;case this.gl.FLOAT_VEC2:this.gl.uniform2f(i.location,n[0][0],n[0][1]);break;case this.gl.FLOAT_VEC3:this.gl.uniform3f(i.location,n[0][0],n[0][1],n[0][2]);break;case this.gl.FLOAT_VEC4:this.gl.uniform4f(i.location,n[0][0],n[0][1],n[0][2],n[0][3]);break;default:}}}else if(n[0]instanceof Int32Array){if(this.program!==null){var i=this.GetShaderUniformParameter(t);if(i!==undefined)switch(i.type){case this.gl.INT:case this.gl.SAMPLER_2D:case this.gl.SAMPLER_CUBE:this.gl.uniform1i(i.location,n[0][0]);break;case this.gl.INT_VEC2:this.gl.uniform2i(i.location,n[0][0],n[0][1]);break;case this.gl.INT_VEC3:this.gl.uniform3i(i.location,n[0][0],n[0][1],n[0][2]);break;case this.gl.INT_VEC4:this.gl.uniform4i(i.location,n[0][0],n[0][1],n[0][2],n[0][3]);break;case this.gl.BOOL:this.gl.uniform1i(i.location,n[0][0]);break;case this.gl.BOOL_VEC2:this.gl.uniform2i(i.location,n[0][0],n[0][1]);break;case this.gl.BOOL_VEC3:this.gl.uniform3i(i.location,n[0][0],n[0][1],n[0][2]);break;case this.gl.BOOL_VEC4:this.gl.uniform4i(i.location,n[0][0],n[0][1],n[0][2],n[0][3]);default:}}}else if(n[0]instanceof e.Color)this.SetUniformValue(t,1,n[0].Data());else if(n[0]instanceof e.Vector2)this.SetUniformValue(t,1,n[0].Data());else if(n[0]instanceof e.Vector3)this.SetUniformValue(t,1,n[0].Data());else if(n[0]instanceof e.Vector4)this.SetUniformValue(t,1,n[0].Data());else if(n[0]instanceof e.Matrix3)this.SetUniformValue(t,1,!1,n[0].Data());else if(n[0]instanceof e.Matrix4)this.SetUniformValue(t,1,!1,n[0].Data());else if(n[0]instanceof e.Matrix3x4){var s=new e.Matrix4;s.data[0]=n[0].data[0],s.data[1]=n[0].data[1],s.data[2]=n[0].data[2],s.data[3]=n[0].data[3],s.data[4]=n[0].data[4],s.data[5]=n[0].data[5],s.data[6]=n[0].data[6],s.data[7]=n[0].data[7],s.data[8]=n[0].data[8],s.data[9]=n[0].data[9],s.data[10]=n[0].data[10],s.data[11]=n[0].data[11],this.SetUniformValue(t,s)}else if(typeof n[0]=="number"){var o=this.GetShaderUniformParameter(t);o&&this.gl.uniform1f(o.location,n[0])}else if(typeof n[0]=="boolean"){var o=this.GetShaderUniformParameter(t);o&&this.gl.uniform1i(o.location,n[0]?1:0)}}else if(n.length===2){if(typeof n[0]=="number")if(n[1]instanceof Float32Array){if(this.program!==null){var i=this.GetShaderUniformParameter(t);if(i!==undefined){var u=void 0;switch(i.type){case this.gl.FLOAT:u=new Float32Array(1),u[0]=n[1][0],this.gl.uniform1fv(i.location,u);break;case this.gl.FLOAT_VEC2:u=new Float32Array(2),u[0]=n[1][0],u[1]=n[1][1],this.gl.uniform2fv(i.location,u);break;case this.gl.FLOAT_VEC3:u=new Float32Array(3),u[0]=n[1][0],u[1]=n[1][1],u[2]=n[1][2],this.gl.uniform3fv(i.location,u);break;case this.gl.FLOAT_VEC4:u=new Float32Array(4),u[0]=n[1][0],u[1]=n[1][1],u[2]=n[1][2],u[3]=n[1][3],this.gl.uniform4fv(i.location,u);break;default:}}}}else if(n[1]instanceof Int32Array){if(this.program!==null){var i=this.GetShaderUniformParameter(t);if(i!==undefined)switch(i.type){case this.gl.INT:this.gl.uniform1iv(i.location,n[1]);break;case this.gl.INT_VEC2:this.gl.uniform2iv(i.location,n[1]);break;case this.gl.INT_VEC3:this.gl.uniform3iv(i.location,n[1]);break;case this.gl.INT_VEC4:this.gl.uniform4iv(i.location,n[1]);break;default:}}}else if(typeof n[1]=="number"&&this.program!==null){var i=this.GetShaderUniformParameter(t);if(i!==undefined)switch(i.type){case this.gl.FLOAT:this.gl.uniform1fv(i.location,n[1]);break;case this.gl.FLOAT_VEC2:this.gl.uniform2fv(i.location,n[1]);break;case this.gl.FLOAT_VEC3:this.gl.uniform3fv(i.location,n[1]);break;case this.gl.FLOAT_VEC4:this.gl.uniform4fv(i.location,n[1]);break;default:}}}else if(n.length===3&&this.program!==null){var i=this.GetShaderUniformParameter(t);if(i!==undefined)switch(i.type){case this.gl.FLOAT_MAT2:this.gl.uniformMatrix2fv(i.location,n[1],n[2]);break;case this.gl.FLOAT_MAT3:this.gl.uniformMatrix3fv(i.location,n[1],n[2]);break;case this.gl.FLOAT_MAT4:this.gl.uniformMatrix4fv(i.location,n[1],n[2]);break;default:}}},n.prototype.SetName=function(e){this.name=e},n.prototype.GetName=function(){return this.name},n.prototype.GetType=function(){return this.m_type},n.prototype.SetType=function(e){this.m_type=e},n}(e.GPUObject);e.ShaderProgram=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(t){this.maxFPS=30,this.sceneMgr=null,this.fps=0,this.evenFPS=15,this.renderEffect=null,this.showRotateCenter=!0,this.excludeSmallModel=!0,this.lodLevel=-1,this.cullerHelper=new e.CullerHelper,this.useLowQuality=!1,this.allowRedraw=!0,this.iScreenWidth=100,this.iScreenHeigh=100,this.FRAME_BUFFER_COUNT=20,this.renderCanvas=null,this.BufferCounter=1,this.allowDraw=!0,this.rameCount=0,this.frameCount=0,this.lastTime=0,this.lastEventFPSTime=0,this.effectManager=null,this.globalEffect="",this.sceneMgr=t,this.renderAction=new e.RenderAction(this),this.renderAction.SetScene(this.sceneMgr),this.allowDraw=!1,this.renderEffect=null,this.effectManager=new e.EffectManager(this.renderAction),this.Reset()}return t.prototype.ClearDelayDrawList=function(){this.renderAction&&this.renderAction.ClearDelayDraw()},t.prototype.Reset=function(){this.lodLevel=-1,this.useLowQuality=!1},t.prototype.GetRenderEffect=function(){return this.renderEffect},t.prototype.SetRenderEffect=function(e){this.renderEffect=e},t.prototype.CalculateFPS=function(){this.evenFPS=60;var e=new Date,t=e.getTime()-this.lastEventFPSTime;t>0&&(this.lastEventFPSTime=e.getTime(),this.evenFPS=1e3/t);var n=e.getTime()-this.lastTime;this.frameCount++,n>=1e3&&(this.fps=this.frameCount,this.lastTime=e.getTime(),this.frameCount=0)},t.prototype.GetFPS=function(){return this.fps},t.prototype.SetGLVersion=function(e){this.renderCanvas=e},t.prototype.GetGLVersion=function(){return this.renderCanvas},t.prototype.GetMaxLimitFPS=function(){return this.maxFPS},t.prototype.SetMaxLimitFPS=function(e){this.maxFPS=e},t.prototype.InitRenderEffect=function(){var t=new e.RenderEffect(e.RenderEffect.RENDER_NORMALEFFCT);t.GetRenderQueuePriority().InitialNormalEffect(),this.renderEffect=t},t.prototype.LimitDrawFPS=function(){var e=!1;return e},t.prototype.Render=function(){var t=this.sceneMgr.GetSceneRoot(),n=this.renderAction;if(n!==null){this.CalculateFPS(),n.SetRenderContext(this.GLContext),n.SetCamera(this.sceneMgr.GetCamera()),n.SetSection(this.sceneMgr.GetSection()),n.SetLights(this.sceneMgr.GetLights()),n.Optimize(),n.SetFPS(this.GetFPS()),n.SetRenderEffect(this.renderEffect),n.Begin();var r=this.sceneMgr.GetSceneRoot();for(var i=0;i<r.Size();i++){var s=r.GetChild(i);s.GetName()!==e.MAINGROUP&&s.FindVisiableObject(n)}this.FindVisiableObject(n),n.Execute(),n.End()}},t.prototype.FindVisiableObject=function(t){if(this.sceneMgr.GetOcTree()!==null){var n=t.GetCamera(),r=n.GetFrustum(),i=this.sceneMgr.GetFrustumQueryResulets(),s=new e.FrustumOctreeQuery(i,r,0,0);s.SetRenderAction(t),s.SetCamera(n),this.sceneMgr.GetOcTree().GetDrawables(s);var o=e.Parameters.Instance().IsShowBox,u=t.GetRenderEffect(),a=u.GetRenderableTypeFilter();a.Contain(e.RenderableType.RGT_BOX)&&(o=!0);for(var f=0;f<i.length;++f){var l=i[f],c=t.GetCullerHelper().IsLittleModel(l.GetWorldBoundingBox(),n);c!=2&&l.FindVisiableObjectFast(t,c),o&&l.GetModel().IsSelected()&&l.GetModel().IsVisible()&&t.PrepareRenderBox(l)}this.sceneMgr.GetExtendInfoManager().FindVisiableObject(t)}},t.prototype.IsExcludeSmallModel=function(){return this.excludeSmallModel},t.prototype.ExcludeSmallModel=function(e){this.excludeSmallModel=e},t.prototype.CloseRenderActionThread=function(){},t.prototype.ShowRotationCenter=function(e){this.showRotateCenter=e},t.prototype.IsShowRotationCenter=function(){return this.showRotateCenter},t.prototype.GetLodLevel=function(){return this.lodLevel},t.prototype.SetLodLevel=function(e){this.lodLevel=e},t.prototype.UseLowQuality=function(t){this.useLowQuality=t;var n=this.sceneMgr.GetCamera();n!==null&&this.cullerHelper.AllowCuller(n,this.useLowQuality),this.useLowQuality===!0?(this.SetLodLevel(e.LOD_LODMIN),this.renderAction.ClearDelayDraw()):this.SetLodLevel(e.LOD_LODMAX)},t.prototype.GetCullerHelper=function(){return this.cullerHelper},t.prototype.InitialRender=function(t){this.GLContext=e.RenderContext.GetRenderContext(t),this.InitRenderEffect(),this.sceneMgr.GetResourceManager().SetRenderContext(this.GLContext.GetGLRenderContext()),this.sceneMgr.GetResourceManager().CreateDeffaultTextureObj(),this.sceneMgr.GetResourceManager().CreateDeffaultTextureObj(!0),this.sceneMgr.GetResourceManager().CreateDefaultCubeMap(),this.sceneMgr.GetResourceManager().GeneratePBRSpecularTextures(),this.sceneMgr.GetResourceManager().GeneratePBRDiffuseTextures(),this.sceneMgr.GetResourceManager().GeneratePBRLUTTexture(),this.sceneMgr.GetResourceManager().GeneratePbrTextures()},t.prototype.OnDraw=function(){this.sceneMgr.UpdateScene();var e=this.sceneMgr.GetCamera();e!==null&&this.cullerHelper.AllowCuller(e,!1),this.Render()},t.prototype.IsNeedRedraw=function(){return this.BufferCounter<1?!1:(this.BufferCounter--,!0)},t.prototype.WindowSizeChanged=function(t,n){this.iScreenWidth=t,this.iScreenHeigh=n;var r=this.sceneMgr.GetCamera(),i=this.GetWindowHeight(),s=this.GetWindowWidth();r.SetViewPort(0,0,s,i);if(r){var o=this.sceneMgr.GetSceneBox();i<=s?(t=o.Length(),n=t*i/s):(n=o.Length(),t=n*s/i),this.GetCullerHelper().SetModelLength(o.Length()),r.SetOrthoSize(new e.Vector2(t*2,n*2))}var u=this.sceneMgr.GetSceneRoot(),a=u.Search(e.BACKGROUNDCOLOR);a!==null&&a.SetBackgroundSize(this.iScreenWidth,this.iScreenHeigh);var f=u.Search(e.AXIS);f!==null&&f.SetViewSize(this.iScreenWidth,this.iScreenHeigh,.25),this.renderAction&&this.renderAction.ResizeFBOs(this.iScreenWidth,this.iScreenHeigh),this.effectManager&&this.effectManager.setSize(this.iScreenWidth,this.iScreenHeigh),this.RequestRedraw()},t.prototype.GetWindowWidth=function(){return this.iScreenWidth},t.prototype.GetWindowHeight=function(){return this.iScreenHeigh},t.prototype.AllowRedraw=function(e){this.allowRedraw=e},t.prototype.RequestRedraw=function(){this.BufferCounter=this.FRAME_BUFFER_COUNT},t.prototype.ClearGLResource=function(){this.renderAction&&this.renderAction.ClearGLResource()},t.prototype.GetQualityStatus=function(){return this.useLowQuality},t.prototype.GetEventFPS=function(){return this.evenFPS},t.prototype.GetRenderAction=function(){return this.renderAction},t.prototype.SetRenderAction=function(e){this.renderAction=e},t.prototype.GetEffectManager=function(){return this.effectManager},t.prototype.GetGlobalEffect=function(){return this.globalEffect},t.prototype.SetGlobalEffect=function(e){this.globalEffect=e},t.prototype.RequestUpdateWhenSceneBoxChanged=function(){var t=this.sceneMgr.GetCamera(),n=this.GetWindowHeight(),r=this.GetWindowWidth();t.SetViewPort(0,0,r,n);if(t){var i=this.sceneMgr.GetSceneBox(),s=i.Length()>0,o=this.iScreenWidth,u=this.iScreenHeigh,a=o;s&&n<=r?(o=i.Length(),u=o*n/r,a=i.Length()):s&&(u=i.Length(),o=u*r/n,a=i.Length()),this.GetCullerHelper().SetModelLength(a),t.SetOrthoSize(new e.Vector2(o*2,u*2))}},t}();e.RenderManager=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){this.allTextures=new e.Map,this.allOGLTextures=new e.Map,this.allImages=new e.Map,this.allMaterials={},this.modelMap=new e.Map,this.gl=null,this.glVBOCache=[],this.glTextureCache=[],this.diffaultTexture=null,this.diffaultImage=null,this.diffaultTexObj=null,this.defaultBlackObj=null,this.m_cubeMappingTextures=new Array,this.VoiceImagePath=null,this.PntImagePath="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAMAAACdt4HsAAAAV1BMVEUAAAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AABpj0HLAAAAHHRSTlMA0PHftyyWF6db5/hlgApzPTcgh22uU0sQwJ+Lt8SbIQAAAj5JREFUWMPtl9mWoyAQQNkERFDjmtj1/985B5AG7STC5MzLnL5PKFVSGwWif4ZYzIxVAwAEM15XZdrViOGE4muudqsxPEUZkaM+KXhJwy8/sdIojeU4aT2Z7UEgQLq36ncZBLHp04lhYt8zb+J5o/sy/ImQ6PbZRp+9DoO68QLjK0f1Hh6evlwIzH40+Vk2vInw6GVmFLEfre2g89Y7+y69ZPGNDbC09rsJellxdx9NiQL2mSDU+wjnVAp3oqMbB8tvQjn9O0LZX1hD2dsHw5z9AuUhXbSCNLWq7k3+jsMhFdEgl4uqY3TLcWMgiRNLKFHpy+QLZVA7jb04GjggUQ7M2+x4wIElr+UkJhiIUN6XZMIL92Grz3pA2dysyhYT+TA3VAZ2JeypdVumHEsY/T2DD8IHfNld/RFDhX75JVINn+mz0MbKie2g2IZzZ+jK9dq6Tk5HXLqqsZ2U+oetsDMMerZrnnqizI0YpxAxyUGVt7cXOPBIjhmW38wjTZuYUOe1MYuS+HgKrXZMhpzcbZR1lbc5vW7NUJTKymWBxkQiQUoyIagLmkljvwaDMrhjFwdxLOEx+wvC6Te9L2F2ShC7X/rvC6neVUi6qy30oqa1r+Iu1I9CkRkcY/tmGzAvMwWryfLz/gdKv/J+3G/j3zV3Xkt7AaCdeOI8J3DpZYVhh02HwuzN94x8H+cu+bt5bMb+8owSNxCg62WaeQMvUVObUylGPVfH+Tehlasf2mPpz2vNGSY2aQrPZhHo/+UP36VVNHxLFh8AAAAASUVORK5CYII=",this.PointOImagePath="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALoAAAC6AgMAAABkYL9iAAAACVBMVEUAAAD/8gDtHCQuHbtOAAAAAXRSTlMAQObYZgAAAuVJREFUaN7tmkFuq0AQRBFLjsJ98MJHmFNwiWxYzcaImVP+iMQuWmWmui1Zyo9S65ehqiCx6U73TH39VO68GuuXZh9eH8o+HMpuM15LQ7UigJqx2oR5UhZuSOJ4UhbHk8TxpKzL0RXhVrFmfby+ANKyfGkTEgfswJC2U1qGakNZ2CFDys70qVSh9s36mHZdECGTHYvjB04MDQbnHzi3U4AjAz1DNiqERk/s3yx/RQCyn3A8X4Ds43i6AAeAe9KzAD0dTxfYmC843l4ggUfcFd1bJQ484tayLhzYpCVR4J4fBTa0WX6FHTa03nnEXWqq04m+fgts3FRghw0lE5huFt2yxQSmNrlR8KhnOpUtaGi2iUaPfDL2KYDhR9hvBpiP/FKnhgwP++0AGfUsbJ8DbOCr4C8HfkBcEdjwU1MHfkRcEXi+82tNgr+WB4+4LR6FIq4IHOa3e/2J6iGBRz2qoO27/uLk686jnnZB4NcIP6IeWdD8Gr+gznah+ft2rR5+efDJc37C+ahf832E33a+oP6Grg++vpMfcLscN2znVz8fOj8ZXup4/uTk6XET/Bzhl513+0n1wZf/lc/7r1eQr0uQrzcPf/3j//jfyRc3/8P+Pvw8PvJ5Eee7N/Pxz+s+wm9R/v3fT7oIH//+FufHV/jqfdzi/BD4vt2F+fj7Re/l4+9HcR7vd4p//f1xdPMzePk+C35w8x14VVAC33sK4vnDh3f+gEJ1nVSQqgd8EXHBDzowzZfUvAg8BjR6nOMdGKVnfNXjJR546fEVAt/kOM0GLk07zFc9DuSBox43InA5sY+4CCznvTSvFvPkZ3zR42E9gK6Ii8By3j4bfpDzfNpHIDGlhX29MEiwLxcSvI7gALWx7tALlXS6oGrvg3InFki8PtILKuCb2McVeCc7bIg1x/eJLLEeDBiK7lvD+9zYBV7ZRwcSx/fp8gKpfTwkjo/+v4GO3CmRGyXClQhXoudGqT9v5h9X3BzxJAP6gAAAAABJRU5ErkJggg=="
,this.PntR2ImagePath="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAH0AAAB2AgMAAACYKXR1AAAADFBMVEUAAAD///8AAADtHCSzlY10AAAAAnRSTlMAPFn8sb8AAAHSSURBVEjHndfBTQMxEIXh5EAJaNtJCTmAOKYU+jEHSkgTpInccwGBsSZafqGn9wzZKxbzzRvHu978fraP+0187vpbXrD0S15w6J+79Pftc+/7TOgZsYwFl12ocOidGqYCNUyFnhodFT76aDQ1eS5EILTjQATCV3sdiEB4by+F8ITWCuEJrRCB0AoRCA2EIYAwhFHDIJaqcK1xMYRzq2dFKKFdn2MhhFBNgnCEFbGTChBoVJsEITWWH4JJ+wCBtDVni4AAwhBAOAIIQwBhCCAMAYQjgAgERq4EGTmj5pF9x6h5CqG7TRHsNkWc1gVPELRRbVLTpkmTNjmbtMlZEYYAAoJBQDAICA4BwSAgGAQEg4BgEUXwNcYCKmiNWkAFrfHH/9BbMpgu2LizHKZJzmcxn2beD/MdNd+TIPxP6z7/LvhxK+HBHA/k7A8YjhgaNYcUjZomadSeH6StTRoEOXsEBBCekE97EI7AezcQSNu9vTmNNWcada8TRq6j1kYh/PvzgLS1SdI2OYMwOYPwBBAQDAKCQUBQxKjhCaRdOUOQkUvOMnJG7RrVUecP7/zpnj/+8/UhX0BuvsJwCQoIQ+BjBYKtcbr1Mpivk/lCmq+000vxN1tb70YRF3RqAAAAAElFTkSuQmCC",this.defaultSkyBoxObj=null,this.defaultPBRSpecularTextures=[],this.defaultPBRDiffuseTextures=[]}return t.prototype.ClearResource=function(){this.zipFile=null,this.allTextures.Clear(),this.allOGLTextures.Clear(),this.allImages.Clear(),this.allMaterials={},this.modelMap.Clear(),this.glVBOCache=[],this.glTextureCache=[],this.m_cubeMappingTextures=new Array},t.prototype.GetDeffaultTextureObj=function(e){return e===void 0&&(e=!1),e?this.defaultBlackObj:this.diffaultTexObj},t.prototype.CreateDeffaultTextureObj=function(t){t===void 0&&(t=!1);if(!t){if(!this.diffaultTexObj){this.diffaultTexture=new e.Texture2D,this.diffaultImage=new e.ImageM3D;var n=new Image;n.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIcAAACICAIAAABC02+IAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAE5SURBVHhe7dExAQAADMOg+Tfd2eAIFrjF04qoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRtSJqRdSKqBVRK6JWRK2IWhG1ImpF1IqoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRtSJqRdSKqBVRK6JWRK2IWhG1ImpF1IqoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRtSJqRdSKqBVRK6JWRK2IWhG1ImpF1IqoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRtSJqRdSKqBVRK6JWRK2IWhG1ImpF1IqoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRtSJqRdSKqBVRK6JWRK2IWhG1ImpF1IqoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRteLZHuaXXWPcIIy2AAAAAElFTkSuQmCC";var r=this;n.onload=function(){var t=e.ImageLoader.createPowerTwoImage(n);r.diffaultTexObj=r.gl.createTexture(),r.gl.bindTexture(e.GL.TEXTURE_2D,r.diffaultTexObj),r.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_MAG_FILTER,e.GL.LINEAR),r.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_MIN_FILTER,e.GL.LINEAR),r.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_WRAP_S,e.GL.CLAMP_TO_EDGE),r.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_WRAP_T,e.GL.CLAMP_TO_EDGE),r.gl.texImage2D(e.GL.TEXTURE_2D,0,e.GL.RGBA,e.GL.RGBA,e.GL.UNSIGNED_BYTE,t),r.gl.bindTexture(e.GL.TEXTURE_2D,null)}}}else if(!this.defaultBlackObj){var i=new Image;i.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAATSURBVDhPYxgFo2AUjIIhCxgYAATEAAHN+RzrAAAAAElFTkSuQmCC";var s=this;i.onload=function(){var t=e.ImageLoader.createPowerTwoImage(i);s.defaultBlackObj=s.gl.createTexture(),s.gl.bindTexture(e.GL.TEXTURE_2D,s.defaultBlackObj),s.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_MAG_FILTER,e.GL.LINEAR),s.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_MIN_FILTER,e.GL.LINEAR),s.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_WRAP_S,e.GL.CLAMP_TO_EDGE),s.gl.texParameteri(e.GL.TEXTURE_2D,e.GL.TEXTURE_WRAP_T,e.GL.CLAMP_TO_EDGE),s.gl.texImage2D(e.GL.TEXTURE_2D,0,e.GL.RGBA,e.GL.RGBA,e.GL.UNSIGNED_BYTE,t),s.gl.bindTexture(e.GL.TEXTURE_2D,null)}}},t.prototype.SetZipFile=function(e){this.zipFile=e},t.prototype.SetRenderContext=function(e){this.gl=e},t.prototype.GetRenderContext=function(){return this.gl},t.prototype.SetSourcePath=function(e){this.sourcePath=e},t.prototype.GetTexture=function(e){var t=null;return t=this.allTextures.Get(e),t},t.prototype.GetOrCreateTexture=function(t,n){n===void 0&&(n=1);var r=this.GetTexture(t);if(!r){switch(n){case e.Texture.TEXTURE_BASE:r=new e.Texture2D;break;case e.Texture.TEXTURE_2D:r=new e.Texture2D;break;case e.Texture.TEXTURE_CUBE:r=new e.TextureCube;break;case e.Texture.TEXTURE_GEO:r=new e.TextureTarget;break;default:}r.SetResourceManager(this),r.SetName(t),this.AddTexture(t,r)}return r},t.prototype.AddTexture=function(e,t){var n=!1,r=this.allTextures.Get(e);return r||(this.allTextures.Put(e,t),n=!0),n},t.prototype.RemoveTexture=function(e){return this.allTextures.Remove(e)},t.prototype.GetMaterial=function(e){var t=this.allMaterials[e];return t},t.prototype.getMaxMaterialKey=function(){var e=0;for(var t in this.allMaterials)Number(t)>e&&(e=Number(t));return e},t.prototype.GetOrCreateMaterial=function(t,n,r){var i=this.GetMaterial(t);if(!i){switch(n){case e.MaterialType.MaterialType_Base:i=new e.BaseMaterial;break;case e.MaterialType.MaterialType_Phong:i=new e.Material;break;case e.MaterialType.MaterialType_MatCap:i=new e.MatCapMaterial;break;case e.MaterialType.MaterialType_Pbr:i=new e.PbrMaterial;break;case e.MaterialType.MaterialType_Inner:i=new e.InnerMaterial;break;case e.MaterialType.MaterialType_Depth:i=new e.DepthMaterial;break;case e.MaterialType.MaterialType_Shader:case 101:case 102:case 103:case 104:i=new e.ShaderMaterial;break;default:i=new e.Material}i.setResourceManager(this),i.SetName(t),this.AddMaterial(t,i);if(this.zipFile&&r){var s=this.zipFile.file(r);s&&e.MaterialReader.Instance().LoadMtl(s.asText(),this)}}return i},t.prototype.AddMaterial=function(e,t){var n=!1;if(this.allMaterials[e]===null||this.allMaterials[e]===undefined)this.allMaterials[e]=t,t.setResourceManager(this),n=!0;return n},t.prototype.RemoveMaterial=function(e){delete this.allMaterials[e]},t.prototype.GetOrCreateImage=function(t,n){var r=this.allImages.Get(t);if(!r){r=new e.ImageM3D,this.allImages.Put(t,r);if(n)r.SetSourceMode(e.ImageSource.FromURL),r.SetImagePath(n);else{r.SetSourceMode(e.ImageSource.FromeZip);if(this.zipFile){var i=this.zipFile.file(t);if(i){var s=t.lastIndexOf("."),o=void 0;s>=0&&s<t.length&&(o=t.substr(s+1));var u=new Blob([i.asArrayBuffer()],{type:"application/octet-binary"}),a=URL.createObjectURL(u);r.SetImagePath(a)}}}}return r},t.prototype.GetOrCreateImageById=function(t,n,r){var i=this.allImages.Get(t);if(!i){i=new e.ImageM3D,i.SetId(n),this.allImages.Put(t,i);if(r)i.SetSourceMode(e.ImageSource.FromURL),i.SetImagePath(r);else{i.SetSourceMode(e.ImageSource.FromeZip);if(this.zipFile){var s=this.zipFile.file(t);if(s){var o=t.lastIndexOf("."),u=void 0;o>=0&&o<t.length&&(u=t.substr(o+1));var a=new Blob([s.asArrayBuffer()],{type:"application/octet-binary"}),f=URL.createObjectURL(a);i.SetImagePath(f)}}}}return i},t.prototype.getMaxImageId=function(){var e=0;for(var t=0;t<this.allImages.elements.length;t++){var n=this.allImages.elements[t].value;n&&n.GetId()&&n.GetId()>e&&(e=n.GetId())}return e},t.prototype.GetImage=function(e){var t=this.allImages.Get(e);return t},t.prototype.GetOGLTexture=function(e){var t=null;return t=this.allOGLTextures.Get(e),t},t.prototype.AddOGLTexture=function(e,t){var n=!1,r=this.allOGLTextures.Get(e);return r||(this.allOGLTextures.Put(e,t),n=!0),n},t.prototype.RemoveOGLTexture=function(e){return this.allOGLTextures.Remove(e)},t.DefaultVoiceImage=function(){return t.defaultVoiceImage===null&&(t.defaultVoiceImage=new e.Texture),t.defaultVoiceImage},t.prototype.getDefaultPointTexture=function(e){var t=null;if(e===1){var n=this.GetOrCreateImage("PointOImagePath",this.PointOImagePath),r=this.GetOrCreateTexture("PointOImagePath");r.AddImage(n),t=r}else if(e===2){var n=this.GetOrCreateImage("PntImagePath",this.PntImagePath),r=this.GetOrCreateTexture("PntImagePath");r.AddImage(n),t=r}else if(e===3){var n=this.GetOrCreateImage("PntR2ImagePath",this.PntR2ImagePath),r=this.GetOrCreateTexture("PntR2ImagePath");r.AddImage(n),t=r}return t},t.DefaultPntTexture=function(){return t.defaultPntTexture===null&&(t.defaultPntTexture=new e.Texture),t.defaultPntTexture},t.DefaultPntTextureO=function(){return t.defaultPntTextureO===null&&(t.defaultPntTextureO=new e.Texture),t.defaultPntTextureO},t.DefaultPntTexturer2=function(){return t.defaultPntTexturer2===null&&(t.defaultPntTexturer2=new e.Texture),t.defaultPntTexturer2},t.DefaultSphereTexture=function(){return t.defaultSphereTexture===null&&(t.defaultSphereTexture=new e.Texture),t.defaultSphereTexture},t.DefaultCubeMapTexture=function(){return t.defaultCubeMapTexture===null&&(t.defaultCubeMapTexture=new e.Texture),t.defaultCubeMapTexture},t.prototype.GetDefaultVoiceImage=function(){if(!t.defaultVoiceImage){var n=e.Parameters.Instance().appWorkPath+this.VoiceImagePath;t.defaultVoiceImage=this.GetOrCreateTexture(n)}return t.defaultVoiceImage},t.prototype.GetDefaultPointTexture=function(e){},t.prototype.GetDefaultSphereMap=function(){},t.prototype.GetDefaultCubeMap=function(){return this.defaultSkyBoxObj},t.prototype.CreateDefaultCubeMap=function(){if(!this.defaultSkyBoxObj){var t=new Image;t.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIcAAACICAIAAABC02+IAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAE5SURBVHhe7dExAQAADMOg+Tfd2eAIFrjF04qoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRtSJqRdSKqBVRK6JWRK2IWhG1ImpF1IqoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRtSJqRdSKqBVRK6JWRK2IWhG1ImpF1IqoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRtSJqRdSKqBVRK6JWRK2IWhG1ImpF1IqoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRtSJqRdSKqBVRK6JWRK2IWhG1ImpF1IqoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRtSJqRdSKqBVRK6JWRK2IWhG1ImpF1IqoFVErolZErYhaEbUiakXUiqgVUSuiVkStiFoRteLZHuaXXWPcIIy2AAAAAElFTkSuQmCC";var n=this;t.onload=function(){var r=e.ImageLoader.createPowerTwoImage(t);n.defaultSkyBoxObj=n.gl.createTexture(),n.gl.bindTexture(e.GL.TEXTURE_CUBE_MAP,n.defaultSkyBoxObj),n.gl.texParameteri(e.GL.TEXTURE_CUBE_MAP,e.GL.TEXTURE_MAG_FILTER,e.GL.LINEAR),n.gl.texParameteri(e.GL.TEXTURE_CUBE_MAP,e.GL.TEXTURE_MIN_FILTER,e.GL.LINEAR),n.gl.texParameteri(e.GL.TEXTURE_CUBE_MAP,e.GL.TEXTURE_WRAP_S,e.GL.CLAMP_TO_EDGE),n.gl.texParameteri(e.GL.TEXTURE_CUBE_MAP,e.GL.TEXTURE_WRAP_T,e.GL.CLAMP_TO_EDGE);for(var i=0;i<6;i++)n.gl.texImage2D(n.gl.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,e.GL.RGBA,e.GL.RGBA,n.gl.UNSIGNED_BYTE,r);n.gl.bindTexture(e.GL.TEXTURE_CUBE_MAP,null)}}},t.prototype.GeneratePBRSpecularTextures=function(){var t="./textures/papermill/specular/",n=["0","1","2","3","4","5"],r=this.GetOrCreateTexture(t,e.Texture.TEXTURE_CUBE);r.IsUseMipMap=!0;if(e.RenderContext.hasSRGB){var i=new e.TextureParameter;i.internalrFromat=e.RenderContext.hasSRGB.SRGB_EXT,i.format=e.RenderContext.hasSRGB.SRGB_EXT,r.SetTextureParameter(i)}for(var s=0;s<1;s+=1){var o=[],u="";for(var a=0;a<6;a++){var f="specular_"+n[a]+".jpg";u+=f;var l=t+f,c=this.GetImage(f);c===null&&(c=this.GetOrCreateImage(f,l)),o.push(c)}r.AddImages(o)}r.SetIsGammaInput(!0),this.defaultPBRSpecularTextures.push(r)},t.prototype.GeneratePbrTextures=function(){var t="./textures/papermill/specular/",n=["right","left","top","bottom","front","back"],r=[],i="";for(var s=0;s<6;s++){var o="specular_"+n[s]+".jpg",u=t+o;r.push(u),i+=o}this.defaultPBRSpecularTexture=this.GetOrCreateCubeMappingTexture(i,r),this.defaultPBRSpecularTexture.SetMipMap(!0),this.defaultPBRSpecularTexture.SetMinFliter(e.GL.LINEAR_MIPMAP_LINEAR),this.defaultPBRSpecularTexture.SetWrapS(e.GL.CLAMP_TO_EDGE),this.defaultPBRSpecularTexture.SetWrapT(e.GL.CLAMP_TO_EDGE),this.defaultPBRSpecularTexture.SetIsGammaInput(!0),t="./textures/papermill/diffuse/",r=[],i="";for(var s=0;s<6;s++){var a="diffuse_"+n[s]+".bmp",u=t+a;r.push(u),i+=a}this.defaultPBRDiffuseTexture=this.GetOrCreateCubeMappingTexture(i,r),this.defaultPBRDiffuseTexture.SetIsGammaInput(!0)},t.prototype.GetOrCreateCubeMappingTexture=function(t,n){var r=null,i=this.m_cubeMappingTextures[t];if(!i){var s=new e.TextureCube,o=[];for(var u=0;u<n.length;u++){var a=n[u],f=this.GetImage(a);f||(f=this.GetOrCreateImage(a,a)),o.push(f)}return s.AddImages(o),this.m_cubeMappingTextures[t]=s,s.SetResourceManager(this),r=s,r.SetResourceManager(this),r}return i},t.prototype.GeneratePBRDiffuseTextures=function(){var t="./textures/papermill/diffuse/",n=["0","1","2","3","4","5"];for(var r=0;r<2;r+=2){var i=[],s="";for(var o=0;o<6;o++){var u="diffuse_"+n[o]+".bmp";s+=u;var a=t+u,f=this.GetImage(u);f===null&&(f=this.GetOrCreateImage(u,a)),i.push(f)}var l=this.GetOrCreateTexture(s,e.Texture.TEXTURE_CUBE);l.AddImages(i),l.IsUseMipMap=!1;if(e.RenderContext.hasSRGB){var c=new e.TextureParameter;c.internalrFromat=e.RenderContext.hasSRGB.SRGB_EXT,c.format=e.RenderContext.hasSRGB.SRGB_EXT,l.SetTextureParameter(c)}this.defaultPBRDiffuseTextures.push(l)}},t.prototype.GeneratePBRLUTTexture=function(){var t="./textures/papermill/brdfLUT.png",n="brdfLUT.png",r=this.GetImage(n);r===null&&(r=this.GetOrCreateImage(n,t));var i=this.GetOrCreateTexture(t),s=new e.TextureParameter;e.RenderContext.hasSRGB&&(s.internalrFromat=e.RenderContext.hasSRGB.SRGB_EXT,s.format=e.RenderContext.hasSRGB.SRGB_EXT),s.wrapS=e.GL.CLAMP_TO_EDGE,s.wrapT=e.GL.CLAMP_TO_EDGE,i.SetTextureParameter(s),i.AddImage(r),i.IsUseMipMap=!1,this.defaultPBRLUTTexture=i},t.prototype.GetDefaultPBRSpecularTexture=function(){return this.defaultPBRSpecularTextures[0]},t.prototype.GetDefaultPBRDiffuseTexture=function(){return this.defaultPBRDiffuseTextures[0]},t.prototype.GetDefaultPBRLUTTexture=function(){return this.defaultPBRLUTTexture},t.prototype.GetPreMaterial=function(e){var t=1,r=1,i=1;switch(e){case n.Wood:t=1,r=.04;break;case n.Wall:t=.8,r=.04;break;case n.Pottery:t=.2,r=.04;break;case n.Metal:t=.35,r=.74;break;case n.FrostedMetal:t=.5,r=.8;break;case n.Plastic:t=.1,r=.1;break;case n.FrostedPlastic:t=.5,r=.1;break;case n.Glass:t=.1,r=.04,i=.5;break;default:t=.5,r=.5}return{roughness:t,metalness:r,alpha:i}},t.prototype.MaterialToJSON=function(){var e='{"materials":[',t=[];for(var n in this.allMaterials){var r=this.allMaterials[n];e+='{"id":'+n+",";if(r.GetMaterialType()===1){e+='"type": 1,',r.GetDisplayName()&&(e+='"name":"'+r.GetDisplayName()+'",');var i=r.GetDiffuse();i&&(e+='"diffuseColor":['+i.r+","+i.g+","+i.b+","+i.a+"],");var s=r.GetAmbient();s&&(e+='"ambientColor":['+s.r+","+s.g+","+s.b+","+s.a+"],");var o=r.GetSpecular();o&&(e+='"specularColor":['+o.r+","+o.g+","+o.b+","+o.a+"],");var u=r.GetEmissive();u&&(e+='"emissiveColor":['+u.r+","+u.g+","+u.b+","+u.a+"],"),r.GetShininess()&&(e+='"shininess":'+r.GetShininess()+","),r.GetNormalMapScale()&&(e+='"normalMapScale":['+r.GetNormalMapScale().x+","+r.GetNormalMapScale().y+"],"),r.GetOpacity()&&(e+='"transparency":'+r.GetOpacity()+",");var a=r.GetDiffuseMap();if(a){e+='"diffuseTexture":{"ref":[';var f=a.GetImageArray();for(var l=0;l<f.length;l++){e+=f[l].GetId()+",";var c=this.GetImageKeyById(f[l].GetId()),h='{"uri":"'+(c?c:a.GetName())+'","id":'+f[l].GetId()+"}";t.push(h)}e=e.substring(0,e.length-1),e+="]},"}var p=r.GetNormalMap();if(p){e+='"normalMap":{"ref":[';var f=p.GetImageArray();for(var l=0;l<f.length;l++){e+=f[l].GetId()+",";var c=this.GetImageKeyById(f[l].GetId()),h='{"uri":"'+(c?c:p.GetName())+'","id":'+f[l].GetId()+"}";t.push(h)}e=e.substring(0,e.length-1),e+="]},"}var d=r.GetMatcapMap();if(d){e+='"matcapMap":{"ref":[';var f=d.GetImageArray();for(var l=0;l<f.length;l++){e+=f[l].GetId()+",";var c=this.GetImageKeyById(f[l].GetId()),h='{"uri":"'+(c?c:d.GetName())+'","id":'+f[l].GetId()+"}";t.push(h)}e=e.substring(0,e.length-1),e+="]},"}r.GetUvTranslate()&&(e+='"uvTranslate":['+r.GetUvTranslate().x+","+r.GetUvTranslate().y+"],"),r.GetUvScale()&&(e+='"uvScale":['+r.GetUvScale().x+","+r.GetUvScale().y+"],"),r.GetUvRotate()?e+='"uvRotate":'+r.GetUvRotate()+"},":(e=e.substring(0,e.length-1),e+="},")}else if(r.GetMaterialType()===2){r.GetDisplayName()&&(e+='"name":"'+r.GetDisplayName()+'",'),e+='"type":2,';var v=r.AlbedoColor();v&&(e+='"diffuseColor":['+v.r+","+v.g+","+v.b+"],"),r.Opacity()&&(e+='"transparency":'+r.Opacity()+","),r.MetalnessFactor()&&(e+='"metalnessFactor":'+r.MetalnessFactor()+","),r.RougthnessFactor()&&(e+='"roughnessFactor":'+r.RougthnessFactor()+","),e+='"useClearCoat":'+r.UseClearCoat()+",",r.ClearCoat()&&(e+='"clearCoat":'+r.ClearCoat()+","),r.ClearCoatRoughness()&&(e+='"clearCoatRoughness":'+r.ClearCoatRoughness()+",");var a=r.AlbedoMap();if(a){e+='"diffuseTexture":{"ref":[';var f=a.GetImageArray();for(var l=0;l<f.length;l++){e+=f[l].GetId()+",";var c=this.GetImageKeyById(f[l].GetId()),h='{"uri":"'+(c?c:a.GetName())+'","id":'+f[l].GetId()+"}";t.push(h)}e=e.substring(0,e.length-1),e+="]},"}var p=r.NormalMap();if(p){e+='"normalMap":{"ref":[';var f=p.GetImageArray();for(var l=0;l<f.length;l++){e+=f[l].GetId()+",";var c=this.GetImageKeyById(f[l].GetId()),h='{"uri":"'+(c?c:p.GetName())+'","id":'+f[l].GetId()+"}";t.push(h)}e=e.substring(0,e.length-1),e+="]},"}var m=r.MetalnessRoughnessMap();if(m){e+='"metalnessRoughnessMap":{"ref":[';var f=m.GetImageArray();for(var l=0;l<f.length;l++){e+=f[l].GetId()+",";var c=this.GetImageKeyById(f[l].GetId()),h='{"uri":"'+(c?c:m.GetName())+'","id":'+f[l].GetId()+"}";t.push(h)}e=e.substring(0,e.length-1),e+="]},"}r.NormalMapScale()&&(e+='"normalMapScale":['+r.NormalMapScale().x+","+r.NormalMapScale().y+"],"),r.GetUvTranslate()&&(e+='"uvTranslate":['+r.GetUvTranslate().x+","+r.GetUvTranslate().y+"],"),r.GetUvScale()&&(e+='"uvScale":['+r.GetUvScale().x+","+r.GetUvScale().y+"],"),r.GetUvRotate()?e+='"uvRotate":'+r.GetUvRotate()+"},":(e=e.substring(0,e.length-1),e+="},")}else if(r.GetMaterialType()===4){e+='"name":"'+r.GetDisplayName()+'",',e+='"type":4,';var g=r.GetSpecular();g&&(e+='"specularColor":['+g.r+","+g.g+","+g.b+"],"),r.GetShininess()&&(e+='"shininess":'+r.GetShininess()+",");var p=r.GetNormalMap();if(p){e+='"normalMap":{"ref":[';var f=p.GetImageArray();for(var l=0;l<f.length;l++){e+=f[l].GetId()+",";var c=this.GetImageKeyById(f[l].GetId()),h='{"uri":"'+(c?c:p.GetName())+'","id":'+f[l].GetId()+"}";t.push(h)}e=e.substring(0,e.length-1),e+="]},"}var d=r.GetMatcapMap();if(d){e+='"matcapMap":{"ref":[';var f=d.GetImageArray();for(var l=0;l<f.length;l++){e+=f[l].GetId()+",";var c=this.GetImageKeyById(f[l].GetId()),h='{"uri":"'+(c?c:d.GetName())+'","id":'+f[l].GetId()+"}";t.push(h)}e=e.substring(0,e.length-1),e+="]},"}var v=r.GetDiffuse();v&&(e+='"diffuseColor":['+v.r+","+v.g+","+v.b+"],"),r.GetOpacity()?e+='"transparency":'+r.GetOpacity()+"},":(e=e.substring(0,e.length-1),e+="},")}}return e=e.substring(0,e.length-1),e+="]",t=this.arrayUnique(t),e+=',"images":['+t+"]}",e},t.prototype.arrayUnique=function(e){var t=[];for(var n=0;n<e.length;n++)t.indexOf(e[n])==-1&&t.push(e[n]);return t},t.prototype.GetImageKeyById=function(e){var t;for(var n=0;n<this.allImages.elements.length;n++){var r=this.allImages.elements[n].value;if(r&&r.GetId()&&r.GetId()===e){t=this.allImages.elements[n].key;break}}return t},t.defaultVoiceImage=null,t.defaultPntTexture=null,t.defaultPntTextureO=null,t.defaultPntTexturer2=null,t.defaultSphereTexture=null,t.defaultCubeMapTexture=null,t}();e.ResourceManager=t;var n;(function(e){e[e.Wood=0]="Wood",e[e.Wall=1]="Wall",e[e.Pottery=2]="Pottery",e[e.Metal=3]="Metal",e[e.FrostedMetal=4]="FrostedMetal",e[e.Plastic=5]="Plastic",e[e.FrostedPlastic=6]="FrostedPlastic",e[e.Glass=7]="Glass"})(n=e.PreMaterialType||(e.PreMaterialType={}))})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(e){this.scene=null,this.scene=e}return e.onExecute=function(e,t){t!==null&&t.Reset()},e.onExecuteModel=function(e,t){t!==null&&t.Restore(!1)},e}(),n=function(){function t(e){this.scene=null,this.scene=e}return t.onExecute=function(t,n){if(n!==null&&n!==null&&n instanceof e.ShapeNode){var r=t.sceneBox,i=n.GetWorldBoundingBox();i!==null&&i.Defined()&&r.Merge(i)}},t.onExecuteModel=function(t,n){if(n!==null&&n!==null&&n instanceof e.Model){var r=t.sceneBox,i=n.GetWorldBoundingBox();i!==null&&i.Defined()&&r.Merge(i)}},t}(),r=function(){function t(e){this.scene=null,this.scene=e}return t.onExecute=function(t,n){if(n!==null&&n!==null&&n instanceof e.ShapeNode)var r=t.sceneBox},t}(),i=function(){function e(e){this.nodesmap=null,this.nodesmap=e}return e.onExecute=function(e,t){var n=e[t.GetName()];n?n=t:e[t.GetName()]=t},e.onExecuteModel=function(e,t){var n=e[t.GetSVLPath()];n?n=t:e[t.GetSVLPath()]=t},e}(),s=function(){function r(){this.pSceneRoot=null,this.camera=null,this.sceneBox=new e.BoundingBox,this.RenderMgr=null,this.iSelectType=0,this.TopModel=null,this.lights=[],this.noteGroup=null,this.measureGroup=null,this.resourceMgr=null,this.nodesMap={},this.shapesIDMap={},this.isModelDirty=!0,this.glueObj=null,this.frustumQueryResulets=[],this.modelFillMgr=null,this.RenderMgr=new e.RenderManager(this),this.Init()}return r.prototype.GetFrustumQueryResulets=function(){return[]},r.prototype.GetOcTree=function(){return this.ocTree},r.prototype.GetNearrestPickPoint=function(){return this.nearRestPickPoint},r.prototype.SetNearrestPickPoint=function(e){this.nearRestPickPoint=e},r.prototype.GetResourceManager=function(){return this.resourceMgr==null&&(this.resourceMgr=new e.ResourceManager),this.resourceMgr},r.prototype.GetSceneRoot=function(){return this.pSceneRoot},r.prototype.Init=function(){this.TopModel=null,this.pSceneRoot=new e.GroupNode,this.glueObj=new e.GlueObj,this.isModelDirty=!1,this.ocTree=new e.Octree,this.extendinfoMgr=new e.ExtendInfoManager},r.prototype.RemoveModel=function(){this.GetRenderManager().ClearDelayDrawList(),this.SetModel(null),this.ocTree&&this.ocTree.Clear(),this.ClearModelAndHandles(),this.GetRenderManager().ClearGLResource(),this.GetRenderManager().RequestRedraw()},r.prototype.OptimizeScene=function(){this.Reset(),this.sceneBox.Clear(),this.UpdataNodePathMap(),this.isModelDirty=!0,this.RequestUpdateWhenSceneBoxChanged()},r.prototype.UpdateScene=function(){this.UpdateHardwareBuffer(),this.ocTree&&this.ocTree.Update()},r.prototype.UpdateSceneByModel=function(t){var n=!1;if(!t)return n;var r=new e.BoundingBox;return r=t.GetWorldBoundingBox(),this.sceneBox.IsInside(r)!=e.INSIDE&&(this.sceneBox.Merge(r),this.RequestUpdateWhenSceneBoxChanged(),n=!0),n},r.prototype.UpdateHardwareBuffer=function(){this.isModelDirty&&(this.isModelDirty=!1)},r.prototype.GetExtendInfoManager=function(){return this.extendinfoMgr==null&&(this.extendinfoMgr=new e.ExtendInfoManager),this.extendinfoMgr},r.prototype.AsynRemoveModelFromeScene=function(e,t){var n=!1;return e&&t&&(this.GetRenderManager().ClearDelayDrawList(),this.AsynUpdateModelCacheInfo(t,!1),e.RemoveSubModel(t),this.RequestUpdateWhenSceneBoxChanged(),n=!0),n},r.prototype.Reset=function(){var n=new e.CallBackAction;n.SetActionData(this),n.SetActionFun(t.onExecute),n.SetActionFunModel(t.onExecuteModel),this.ExecuteAction(n),this.GetRenderManager().RequestRedraw()},r.prototype.GetModelFillManager=function(){return this.modelFillMgr==null&&(this.modelFillMgr=new e.ModelFillManager(this)),this.modelFillMgr},r.prototype.RayOctreeAction=function(t){var n=!1;if(t&&this.ocTree){var r=this.ocTree,i=t.GetData().GetCameraRay(),s=[],o=new e.RayOctreeQuery(s,i,e.RayQueryLevel.RAY_AABB,.001);this.ocTree.RaycastSingleFast(o);for(var u=0;u<s.length;u++){var a=s[u];a!==null&&a.RayPick(t)}this.GetNoteGroup().RayPick(t),this.GetMeasureGroup().RayPick(t),this.GetExtendInfoManager().RayPick(t),n=!0}return n},r.prototype.FrameOctreeAction=function(t){var n=!1;if(t&&this.ocTree){var r=this.ocTree,i=t.GetData().GetCameraRay(),s=t.GetData().GetFramePickFrustum(),o=[],u=new e.FrustumOctreeQuery(o,s,0,0);r.GetDrawables(u);for(var a=0;a<o.length;a++){var f=o[a];f&&f.FramePick(t)}n=!0}return n},r.prototype.FrustumOctreeAction=function(t){var n=!1;if(t&&this.ocTree){var r=this.GetCamera(),i=r.GetFrustum(),s=[],o=new e.FrustumOctreeQuery(s,i,0,0);this.ocTree.GetDrawables(o);for(var u=0;u<s.length;++u)var a=s[u]}return n},r.prototype.ExecuteAction=function(t){if(t!==null){var n=this.pSceneRoot.Search(e.MAINMODELROOT);n!==null&&n.Traverse(t)}},r.prototype.SetRenderManager=function(e){this.RenderMgr=e},r.prototype.GetSectionNode=function(){if(!this.sectionNode){var t=this.GetSceneRoot(),n=new e.SectionNode;n.SetScene(this),n.SetName(e.SECTION_GROUP_PATH),t.AddChild(n),this.sectionNode=n}return this.sectionNode},r.prototype.GetCamera=function(){return this.camera},r.prototype.SetCamera=function(e){this.camera=e},r.prototype.GetLights=function(){return null},r.prototype.GetModel=function(){return this.TopModel},r.prototype.AddModel=function(e,t){if(e===null)return;var n=null;t===null||t.length===0?n=this.TopModel:n=this.GetShape(t),n.GetSubModels().push(e),this.OptimizeScene(),this.RenderMgr.RequestRedraw()},r.prototype.SetModel=function(t){if(t!==null&&this.TopModel===t)return;this.TopModel=t;if(this.TopModel!==null){if(e.Parameters.Instance().OptimizeBigModel){var n=this.TopModel.GetPlaceMatrix();n.SetScale(.001),this.TopModel.SetPlaceMatrix(n)}var r=new e.ShapeNode;r.SetName(e.MAINMODELROOT),r.SetShape(this.TopModel);var i=this.GetSceneRoot().Search(e.MAINGROUP);i.AddChild(r),this.TopModel.SetModelExtInfo(this.extendinfoMgr,!0),this.OptimizeScene(),this.RenderMgr.RequestRedraw()}},r.prototype.GetHandlerGroup=function(){var t=this.pSceneRoot.Search(e.HANDLER_GROUPNODE);return t},r.prototype.GetNoteGroup=function(){if(this.noteGroup==null||this.noteGroup==undefined){var t=this.GetSceneRoot(),n=new e.NoteGroup;n.SetName(e.NOTE_GROUP_PATH),t.AddChild(n),this.noteGroup=n}return this.noteGroup},r.prototype.GetMeasureGroup=function(){if(!this.measureGroup){var t=this.GetSceneRoot(),n=new e.MeasureGroup;n.SetScene(this),n.SetName(e.MEASURE_GROUP_PATH),t.AddChild(n),this.measureGroup=n}return this.measureGroup},r.prototype.RestoreRotationCenter=function(){var e=this.GetSceneBox();return this.SetRotationCenter(e.Center()),!1},r.prototype.SetRotationCenterByScreenPnt=function(t,n){var r=1.2,i=new e.Vector3,s=new e.Vector2(t,n);return this.GetCamera().GetZoom()>r&&e.Parameters.Instance().isSpecifiedRotation?this.GetPickPoint(s,i,!0)||(i=this.GetSceneBox().Center()):i=this.GetSceneBox().Center(),this.SetRotationCenter(i),!0},r.prototype.SetRotationCenter=function(t){var n=this.camera;return n!==null?(n.SetRotateCenter(t),!0):(e.LOGI("SetRotationCenter Camera is null"),this.GetRenderManager().RequestRedraw(),!1)},r.prototype.GetPickShape=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length===4){var r=new e.RayPickAction(this);r.SetPickShapeType(t[2]),r.SetPickGeoType(t[3]),r.SetRay(t[0],t[1]);if(!this.RayOctreeAction(r)){var i=this.pSceneRoot;i.Traverse(r)}var s=this.GetSceneRoot();for(var o=0;o<s.Size();o++){var u=s.GetChild(o);u.GetName()!=e.MAINGROUP&&u.RayPick(r)}var a=r.GetNearPickShape();return a&&(a.GetType(),this.AddShapeIDToMap(a),this.SetNearrestPickPoint(r.GetNearestPickPoint())),a}return this.GetPickShape(t[0].x,t[0].y,t[1],t[2])},r.prototype.GetPickPoint=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];switch(t.length){case 2:var r=new e.Vector3,i=new e.RayPickAction(this);i.SetPickShapeType(e.ShapeType.SHAPE_MODEL),i.SetPickGeoType(e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN),i.SetRay(t[0],t[1]),this.pSceneRoot.Traverse(i);var s=i.GetNearPickPoint(r);if(!s){var o=i.GetData().GetCameraRay(),u=new e.Vector3,a=this.GetSceneBox();u.copyFrom(a.Center());var f=o.direction.LengthSquared(),l=u.Sub(o.origin).DotProduct(o.direction)*(1/f);r=o.direction.Multiply(l).Add(o.origin)}return this.GetRenderManager().RequestRedraw(),r;case 3:var c=!1,r=new e.Vector3,i=new e.RayPickAction(this);i.SetPickShapeType(e.ShapeType.SHAPE_MODEL),i.SetPickGeoType(e.GeoAttrTypeEnum.M3D_GEOATTR_TYPE_UNKNOWN),i.SetRay(t[0]),this.pSceneRoot.Traverse(i);var s=i.GetNearPickPoint(r);if(!s&&!t[2]){var o=i.GetData().GetCameraRay(),u=new e.Vector3,a=this.GetSceneBox();u.copyFrom(a.Center());var f=o.direction.LengthSquared(),l=u.Sub(o.origin).DotProduct(o.direction)*(1/f);r=o.direction.Multiply(l).Add(o.origin),c=!0}else s&&(c=!0);return this.GetRenderManager().RequestRedraw(),t[1].copyFrom(r),c}},r.prototype.SetSelectType=function(e){this.iSelectType=e},r.prototype.GetNodes=function(e,t){var n=this.nodesMap[t];while(n!=null){if(n.GetType()===e)return n;n=n.GetParent()}return n},r.prototype.SetMatrixByPlcPath=function(t,n){var r="M3D|MAIN|"+t,i=this.GetNode(r);if(i!==null){var s=new e.Matrix3x4(n);i.GetPlaceMatrix(s)}},r.prototype.GetMatrixByPlcPath=function(t,n){var r="M3D|MAIN|"+t,i=this.GetNode(r);if(i!==null){var s=i.GetPlaceMatrix();n=e.Matrix4.IDENTITY().Data(),n=s.Data()}},r.prototype.AddHandle=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length===3){var r=t[0],i=t[1],s=t[2],o=this.GetPickPoint(r,i),u=this.CreateShape(o,s);return this.GetRenderManager().RequestRedraw(),u.GetID()}var r=t[0],i=t[1],a=t[2],s=t[3],f=new e.Vector3(r,i,a),u=this.CreateShape(f,s);return this.GetRenderManager().RequestRedraw(),u.GetID()},r.prototype.AddShape=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t.length===3){var r=t[0],i=t[1],s=t[2],o=this.GetPickPoint(r,i),u=this.CreateShape(o,s);return u?u.GetID():-1}var r=t[0],i=t[1],a=t[2],s=t[3],f=new e.Vector3(r,i,a),u=this.CreateShape(f,s);return u?u.GetID():-1},r.prototype.CreateShape=function(t,n){var r=null;switch(n){case e.ShapeType.SHAPE_POINT_HANDLE:break;case e.ShapeType.SHAPE_VOICE_NOTE:break;case e.ShapeType.SHAPE_NOTE:break;default:}return r?(this.shapesIDMap[r.GetID()]=r,r):null},r.prototype.GetRenderManager=function(){return this.RenderMgr},r.prototype.GetShapePos=function(e,t,n){var r=this.GetShape(e);if(r!==null&&t!==0&&t===1){var i=r.GetSceneNode();i!==null&&(n=i.GetPosition())}},r.prototype.GetShapeColor=function(t,n){var r=new e.Color,i=this.GetShape(t);return i!==null?r=i.GetColor():e.LOGE(" GetShapeColor error: shape is null!"),r},r.prototype.GetSceneBox=function(){if(!this.sceneBox.Defined()){var t=new e.CallBackAction;t.SetActionData(this),t.SetActionFun(r.ComputeLBox),t.SetActionFunModel(n.onExecuteModel),this.ExecuteAction(t)}return this.sceneBox},r.ComputeLBox=function(t,n){if(n!==null&&(n.GetType()==e.ShapeType.SHAPE_MODEL||n.GetType()==e.ShapeType.IMAGEMODEL_SHAPE)){var r=t,i=r.sceneBox,s=n.GetWorldBoundingBox();s&&s.Defined()&&i.Merge(s)}},r.prototype.SetSceneBox=function(e){this.sceneBox=e},r.prototype.GetNode=function(e){var t=this.nodesMap[e];return t},r.prototype.UpdataNodePathMap=function(){this.nodesMap={},this.shapesIDMap={};var t=new e.CallBackAction;t.SetActionData(this.nodesMap),t.SetActionFun(i.onExecute),t.SetActionFunModel(i.onExecuteModel),this.pSceneRoot.Traverse(t)},r.prototype.RemoveShape=function(e){var t=this.shapesIDMap[e];if(t){var n=t.GetSceneNode().GetParent();n.DeleteChild(t.GetSceneNode()),t=null,delete this.shapesIDMap[e]}return!0},r.prototype.AddShapeIDToMap=function(e){e&&(this.shapesIDMap[e.GetID()]=e)},r.prototype.RemoveShapeIDFromMap=function(e){e&&delete this.shapesIDMap[e.GetID()]},r.prototype.ReIndexIDMapAfterAddModel=function(t){if(t!==null&&t instanceof e.Model){var n=t;this.AddShapeIDToMap(n);var r=n.GetBodys();for(var i=0;i<r.length;i++){var s=r[i];this.AddShapeIDToMap(s);var o=s.GetFaces();for(var u=0;u<o.length;u++){var a=o[u];this.AddShapeIDToMap(a);var f=a.GetEdges();for(var l=0;l<f.length;l++){var c=f[l];this.AddShapeIDToMap(c)}}var h=s.GetEdges();for(var l=0;l<h.length;l++){var c=h[l];this.AddShapeIDToMap(c)}var p=s.GetPoints();for(var l=0;l<p.length;l++){var d=p[l];this.AddShapeIDToMap(d)}}var v=n.GetSubModels();for(var i=0;i<v.length;i++)this.ReIndexIDMapAfterAddModel(v[i])}},r.prototype.ReIndexIDMapAfterAddSingleModel=function(t){if(t!=null){if(t.GetType()==e.ShapeType.SHAPE_MODEL){var n=t;this.AddShapeIDToMap(n);if(e.Parameters.Instance().useBodyObject){var r=n.GetBodys();if(r)for(var i=0;i<r.length;i++){var s=r[i];this.AddShapeIDToMap(s);var o=s.GetFaces();for(var u=0;u<o.length;u++){var a=o[u];this.AddShapeIDToMap(a);var f=a.GetEdges();if(f)for(var l=0;l<f.length;l++){var c=f[l];this.AddShapeIDToMap(c)}}var h=s.GetEdges();if(h)for(var l=0;l<h.length;l++){var c=h[l];this.AddShapeIDToMap(c)}var p=s.GetPoints();if(p)for(var l=0;l<p.length;l++){var d=p[l];this.AddShapeIDToMap(d)}}}}this.GetRenderManager().RequestRedraw()}},r.prototype.RemoveModelCachePath=function(e){e&&this.GetNode(e.GetPlcPath())&&delete this.nodesMap[e.GetPlcPath()]},r.prototype.ReIndexIDMapAfterDeleteModel=function(t){if(t!==null&&t instanceof e.Model){var n=t;this.RemoveShapeIDFromMap(n),e.Parameters.Instance().useSimplePath&&this.RemoveModelCachePath(n);if(e.Parameters.Instance().useBodyObject){var r=n.GetBodys();for(var i=0;i<r.length;i++){var s=r[i];this.RemoveShapeIDFromMap(s);var o=s.GetFaces();for(var u=0;u<o.length;u++){var a=o[u];this.RemoveShapeIDFromMap(a);var f=a.GetEdges();if(f)for(var l=0;l<f.length;l++){var c=f[l];this.RemoveShapeIDFromMap(c)}}var h=s.GetEdges();for(var l=0;l<h.length;l++){var c=h[l];this.RemoveShapeIDFromMap(c)}var p=s.GetPoints();for(var l=0;l<p.length;l++){var d=p[l];this.RemoveShapeIDFromMap(d)}}}var v=n.GetSubModels();for(var i=0;i<v.length;i++)this.ReIndexIDMapAfterDeleteModel(v[i])}},r.prototype.SetGluObj=function(e){this.glueObj=e},r.prototype.GetGlueObj=
function(){return this.glueObj},r.prototype.CreateModelNodes=function(t,n,r){var i=""+t.GetPlcId().toString(16),s=n+"|"+i,o=new e.ModelNode;o.SetName(s),o.SetOrigPlcMatrix(t.GetPlaceMatrix().ToMatrix3x4());var u=new e.ShapeNode;u.SetName(s+"|"+"ShapeModel"),t.SetSceneNode(u),u.SetShape(t),o.SetShapeNode(u);var a=t.GetSubModels();for(var f=0;f<a.length;f++)o.AddChild(this.CreateModelNodes(a[f],s,t.GetID()));return o},r.prototype.ClearModelAndHandles=function(){e.LOGE("clear start");var t=this.GetSceneRoot().Search(e.MAINGROUP);this.nodesMap={},t.DeleteAllChildren(),e.LOGE("clear end")},r.prototype.GetFitViewSceneBox=function(){return this.GetSceneBox(),this.sceneBox},r.prototype.GetOcTreeWorldBoundingBox=function(){var t=this.GetSceneBox().Length()/2,n=this.GetSceneBox().Center(),r=n.Sub(new e.Vector3(t,t,t)),i=n.Add(new e.Vector3(t,t,t));return new e.BoundingBox(r,i)},r.prototype.GetShape=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(typeof t[0]=="number"){var r=t[0];return this.shapesIDMap[r]}var i=t[0],s=null,o=this.GetNode(i);return o===null?(e.LOGE("GetShape null"),null):o},r.prototype.ShowRotationCenter=function(e){this.RenderMgr!==null&&(this.RenderMgr.ShowRotationCenter(e),this.GetRenderManager().RequestRedraw())},r.prototype.setSectionEnable=function(e){var t=this.GetSectionNode().GetSection();t.SetVisible(e),this.GetRenderManager().RequestRedraw()},r.prototype.SetSections=function(e){if(e.length>0){var t=this.GetSection();t.AddPlane(e[0])}this.GetRenderManager().RequestRedraw()},r.prototype.AsynUpdateModelCacheInfo=function(e,t){e&&(this.GetShape(e.GetID())||(t?this.ReIndexIDMapAfterAddSingleModel(e):this.ReIndexIDMapAfterDeleteModel(e)))},r.prototype.GetSection=function(){var t=this.GetSceneRoot().Search(e.MAINGROUP),n=t.Search("SectionNode"),r=null;if(n!==null)r=n.GetShape(),r===null&&(r=new e.Section,n.SetShape(r));else{r=new e.Section;var i=new e.ShapeNode;i.SetShape(r),i.SetName("SectionNode"),t.AddChild(i)}r.SetBox(this.GetSceneBox());var s=this.GetSceneBox().Clone();return s.ScaleBox(1.3),r.SetDrawRection(s),r},r.prototype.GetDefaultZoom=function(){var t=this.GetCamera(),n=t.GetViewPort(),r=n.GetRect().Height(),i=n.GetRect().Width(),s=e.Parameters.Instance().DefaultZoomFactor;return s=s*r/i,r>i&&(s=s*.5*(i*1/r)),s},r.prototype.GetDefaultFocusLength=function(){var e=this.GetSceneBox();return e.Length()*1.5},r.prototype.GetFramePickShape=function(t,n,r,i,s){var o=new e.RayPickAction(this);o.SetPickShapeType(r),o.SetPickGeoType(i),o.SetFramePickSection(t,n),o.SetFramePickType(s);if(!this.FrameOctreeAction(o)){var u=this.pSceneRoot;u.Traverse(o)}var a=o.GetFramePickShapes();return a},r.prototype.RequestUpdateWhenSceneBoxChanged=function(){if(this.ocTree!==null){this.GetSceneBox().Clear();var t=this.ocTree.GetWorldBoundingBox(),n=this.GetOcTreeWorldBoundingBox();this.ocTree.Clear(),this.ocTree.SetSize(n,8);var i=new e.CallBackAction;i.SetActionData(this),i.SetActionFun(null),i.SetActionFunModel(r.AddNodeToOCTree),this.ExecuteAction(i),this.RenderMgr.GetRenderAction().SetSceneBoxChanged(!0)}},r.prototype.AddNodeToOCTree=function(t){if(t.GetType()===e.ShapeType.SHAPE_MODEL){var n=t.GetModelShape();if(n!==null&&this.ocTree!==null){var r=n.GetWorldBoundingBox();r!==null&&r.Defined()&&(this.ocTree.InsertDrawable(n),n.SetOctree(this.ocTree))}}},r.AddNodeToOCTree=function(t,n){var r=t;r!==null&&n.GetType()==e.ShapeType.SHAPE_MODEL&&r.AddNodeToOCTree(n)},r.prototype.OptimizeCameraView=function(t){var n=this.GetCamera();t&&this.GetRenderManager().RequestUpdateWhenSceneBoxChanged();var r=this.GetSceneBox(),i=r.Length();i=this.GetDefaultFocusLength();if(n.IsOrthographic()){var s=this.GetSceneBox(),o=n.GetPosition().Clone();if(s.IsInside(o)==e.INSIDE){var u=n.GetView().ToMatrix3(),a=new e.Vector3(u.data[6],u.data[7],u.data[8]);a.Normalize();var f=o.Add(a.Multiply(s.Length()));n.SetWorldPosition(f)}}n.SetNearClip(i*e.NEAR_CLIP_PLANE_FACTOR),n.SetFarClip(i*e.FAR_CLIP_PLANE_FACTOR),n.SetInitRotateCenter(r.Center())},r.prototype.GetLightManager=function(){return this.m_lightManager||(this.m_lightManager=new e.LightManager,this.m_lightManager.SetSceneManager(this),this.GetLightGroup()),this.m_lightManager},r.prototype.GetCameraManager=function(){return this.m_cameraManager||(this.m_cameraManager=new e.CameraManager,this.m_cameraManager.SetSceneManager(this),this.GetCameraGroup()),this.m_cameraManager},r.prototype.GetLightGroup=function(){if(!this.m_lightGroup){var t=this.GetSceneRoot();this.m_lightGroup=new e.LightGroup,this.m_lightGroup.SetName(e.LIGHT_GROUP_PATH),t.AddChild(this.m_lightGroup),this.m_lightGroup.SetScene(this)}return this.m_lightGroup},r.prototype.GetCameraGroup=function(){if(!this.m_cameraGroup){var t=this.GetSceneRoot();this.m_cameraGroup=new e.CameraGroup,this.m_cameraGroup.SetName(e.CAMERA_GROUP_PATH),t.AddChild(this.m_cameraGroup),this.m_cameraGroup.SetScene(this)}return this.m_cameraGroup},r}();e.SceneManager=s})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var r=t.call(this)||this;return r.iPntXNum=1062,r.iPntYNum=1062,r.iPntZNum=1062,r.iPntONum=3240,r.ProArray=[-10,10,-10,10,-10,10],r.iViewX=0,r.iViewY=0,r.iWidth=1600,r.iHeight=1e3,r.iW=500,r.xColor=e.Color.RED(),r.yColor=e.Color.GREEN(),r.zColor=e.Color.BLUE(),r.oColor=e.Color.YELLOW(),r.xOffset=0,r.yOffset=0,r.zOffset=0,r.oOffset=0,r.gl=null,r.positionBuffer=null,r.colorBuffer=null,r.SetAxisPosition(n.LEFTDOWN),r}return __extends(n,t),n.prototype.SetViewSize=function(e,t,r){r===void 0&&(r=.3),this.axisPosition=n.NONE,this.iWidth=e*r,this.iHeight=t*r,this.iWidth>this.iHeight?this.iWidth=this.iHeight:this.iHeight=this.iWidth,this.srcWidth=e,this.srcHeigh=t,this.iW=this.iWidth>=this.iHeight?this.iHeight:this.iWidth},n.prototype.FindVisiableObject=function(t){if(!this.IsVisible())t.SetAxisNode(null);else{var n=t.GetCamera(),r=n.GetRotation().RotationMatrix().Inverse(),i=new e.Quaternion(r);this.SetRotation(i),t.SetAxisNode(this)}},n.prototype.SetAxisPosition=function(e){this.axisPosition=e;if(this.axisPosition!==e){this.axisPosition=e;var t=this.srcWidth,r=this.srcHeigh;e===n.LEFTTOP?(this.iViewX=0,this.iViewY=r-this.iHeight):e===n.LEFTDOWN?(this.iViewX=0,this.iViewY=0):e===n.RIGHTTOP?(this.iViewX=t-this.iWidth,this.iViewY=r-this.iHeight):e===n.RIGHTDOWN?(this.iViewX=t-this.iWidth,this.iViewY=0):(this.iViewX=0,this.iViewY=0)}},n.prototype.GetPositionVBO=function(){if(this.gl===null)return null;if(this.positionBuffer!==null)return this.positionBuffer;this.positionBuffer=new e.HardWareVertexBuffer(this.gl);var t=new Float32Array(n.axisPntX),r=new Float32Array(n.axisPntY),i=new Float32Array(n.axisPntZ),s=new Float32Array(n.axisPntO);return this.positionBuffer.Create(0,t.length+r.length+i.length+s.length),this.xOffset=0,this.positionBuffer.SetDataRange(t,0),this.yOffset=t.length,this.positionBuffer.SetDataRange(r,this.yOffset),this.zOffset=this.yOffset+r.length,this.positionBuffer.SetDataRange(i,this.zOffset),this.oOffset=this.zOffset+i.length,this.positionBuffer.SetDataRange(s,this.oOffset),this.positionBuffer.WriteBuffer(),this.positionBuffer},n.prototype.GetColorVBO=function(){if(this.gl===null)return null;if(this.colorBuffer!==null)return this.colorBuffer;var t=new Float32Array(n.axisPntX.length);for(var r=0;r<t.length-2;r+=3)t[r]=1,t[r+1]=0,t[r+2]=0;var i=new Float32Array(n.axisPntY.length);for(var s=0;s<i.length-2;s+=3)i[s]=0,i[s+1]=1,i[s+2]=0;var o=new Float32Array(n.axisPntZ.length);for(var u=0;u<o.length-2;u+=3)o[u]=0,o[u+1]=0,o[u+2]=1;var a=new Float32Array(n.axisPntO.length);for(var f=0;f<a.length-2;f+=3)a[f]=1,a[f+1]=1,a[f+2]=0;this.colorBuffer=new e.HardWareVertexBuffer(this.gl),this.colorBuffer.Create(0,t.length+i.length+o.length+a.length);var l=0;this.colorBuffer.SetDataRange(t,0);var c=t.length;this.colorBuffer.SetDataRange(i,c);var h=this.yOffset+i.length;this.colorBuffer.SetDataRange(o,h);var p=this.zOffset+o.length;return this.colorBuffer.SetDataRange(a,p),this.colorBuffer.WriteBuffer(),this.colorBuffer},n.prototype.SetCurrentGLContext=function(e){this.gl=e},n.axisPntX=[0,-0.046352549,.14265847,0,.046352549,.14265847,0,.088167787,.12135254,0,-0.14265847,-0.046352549,0,-0.046352549,-0.14265847,0,-0.088167787,-0.12135254,0,-0.14265847,-0.046352549,0,.046352549,-0.14265847,0,0,-0.15,0,-0.046352549,.14265847,0,0,.15,0,.046352549,.14265847,0,.12135254,.088167787,0,-0.12135254,.088167787,0,-0.088167787,.12135254,0,.046352549,-0.14265847,0,-0.14265847,-0.046352549,0,-0.15,0,0,0,-0.15,0,-0.046352549,-0.14265847,0,-0.14265847,-0.046352549,0,-0.14265847,.046352549,0,.12135254,.088167787,0,.14265847,.046352549,0,-0.088167787,.12135254,0,-0.046352549,.14265847,0,.12135254,.088167787,0,-0.088167787,-0.12135254,0,-0.12135254,-0.088167787,0,-0.14265847,-0.046352549,0,-0.14265847,.046352549,0,.12135254,-0.088167787,0,.088167787,-0.12135254,0,.14265847,.046352549,0,.15,0,0,-0.14265847,.046352549,0,.12135254,.088167787,0,-0.14265847,.046352549,0,-0.12135254,.088167787,0,.088167787,-0.12135254,0,.046352549,-0.14265847,0,-0.14265847,.046352549,0,.088167787,.12135254,0,.12135254,.088167787,0,-0.046352549,.14265847,0,-0.14265847,.046352549,0,.14265847,-0.046352549,0,.12135254,-0.088167787,0,-0.15,0,0,-0.14265847,.046352549,0,.046352549,-0.14265847,0,.15,0,0,.14265847,-0.046352549,0,-0.14265847,.046352549,0,.046352549,-0.14265847,5,.046352549,-0.14265847,5,0,-0.15,0,.088167787,-0.12135254,5,.088167787,-0.12135254,5,.046352549,-0.14265847,0,.12135254,-0.088167787,5,.12135254,-0.088167787,5,.088167787,-0.12135254,0,.14265847,-0.046352549,5,.14265847,-0.046352549,5,.12135254,-0.088167787,0,.15,0,5,.15,0,5,.14265847,-0.046352549,0,.14265847,.046352549,5,.14265847,.046352549,5,.15,0,0,.12135254,.088167787,5,.12135254,.088167787,5,.14265847,.046352549,0,.088167787,.12135254,5,.088167787,.12135254,5,.12135254,.088167787,0,.046352549,.14265847,5,.046352549,.14265847,5,.088167787,.12135254,0,0,.15,5,0,.15,5,.046352549,.14265847,0,-0.046352549,.14265847,5,-0.046352549,.14265847,5,0,.15,0,-0.088167787,.12135254,5,-0.088167787,.12135254,5,-0.046352549,.14265847,0,-0.12135254,.088167787,5,-0.12135254,.088167787,5,-0.088167787,.12135254,0,-0.14265847,.046352549,5,-0.14265847,.046352549,5,-0.12135254,.088167787,0,-0.15,0,5,-0.15,0,5,-0.14265847,.046352549,0,-0.14265847,-0.046352549,5,-0.14265847,-0.046352549,5,-0.15,0,0,-0.12135254,-0.088167787,5,-0.12135254,-0.088167787,5,-0.14265847,-0.046352549,0,-0.088167787,-0.12135254,5,-0.088167787,-0.12135254,5,-0.12135254,-0.088167787,0,-0.046352549,-0.14265847,5,-0.046352549,-0.14265847,5,-0.088167787,-0.12135254,0,0,-0.15,5,0,-0.15,5,-0.046352549,-0.14265847,5,-0.046352549,-0.14265847,0,-0.046352549,-0.14265847,0,0,-0.15,5,-0.088167787,-0.12135254,0,-0.088167787,-0.12135254,0,-0.046352549,-0.14265847,5,-0.12135254,-0.088167787,0,-0.12135254,-0.088167787,0,-0.088167787,-0.12135254,5,-0.14265847,-0.046352549,0,-0.14265847,-0.046352549,0,-0.12135254,-0.088167787,5,-0.15,0,0,-0.15,0,0,-0.14265847,-0.046352549,5,-0.14265847,.046352549,0,-0.14265847,.046352549,0,-0.15,0,5,-0.12135254,.088167787,0,-0.12135254,.088167787,0,-0.14265847,.046352549,5,-0.088167787,.12135254,0,-0.088167787,.12135254,0,-0.12135254,.088167787,5,-0.046352549,.14265847,0,-0.046352549,.14265847,0,-0.088167787,.12135254,5,0,.15,0,0,.15,0,-0.046352549,.14265847,5,.046352549,.14265847,0,.046352549,.14265847,0,0,.15,5,.088167787,.12135254,0,.088167787,.12135254,0,.046352549,.14265847,5,.12135254,.088167787,0,.12135254,.088167787,0,.088167787,.12135254,5,.14265847,.046352549,0,.14265847,.046352549,0,.12135254,.088167787,5,.15,0,0,.15,0,0,.14265847,.046352549,5,.14265847,-0.046352549,0,.14265847,-0.046352549,0,.15,0,5,.12135254,-0.088167787,0,.12135254,-0.088167787,0,.14265847,-0.046352549,5,.088167787,-0.12135254,0,.088167787,-0.12135254,0,.12135254,-0.088167787,5,.046352549,-0.14265847,0,.046352549,-0.14265847,0,.088167787,-0.12135254,5,0,-0.15,0,0,-0.15,0,.046352549,-0.14265847,5,.15450849,.47552825,5,.046352549,.14265847,5,0,.15,5,.29389262,.40450849,5,.088167787,.12135254,5,.046352549,.14265847,5,.40450849,.29389262,5,.12135254,.088167787,5,.088167787,.12135254,5,.40450849,.29389262,5,.47552825,.15450849,5,.14265847,.046352549,5,-0.15450849,-0.47552825,5,-0.046352549,-0.14265847,5,0,-0.15,5,-0.29389262,-0.40450849,5,-0.088167787,-0.12135254,5,-0.046352549,-0.14265847,5,.046352549,.14265847,5,.15450849,.47552825,5,.29389262,.40450849,5,.14265847,.046352549,5,.12135254,.088167787,5,.40450849,.29389262,5,.5,0,5,.15,0,5,.14265847,.046352549,5,.47552825,-0.15450849,5,.14265847,-0.046352549,5,.15,0,5,-0.046352549,-0.14265847,5,-0.15450849,-0.47552825,5,-0.29389262,-0.40450849,5,-0.40450849,-0.29389262,5,-0.12135254,-0.088167787,5,-0.088167787,-0.12135254,5,-0.47552825,-0.15450849,5,-0.14265847,-0.046352549,5,-0.12135254,-0.088167787,5,-0.5,0,5,-0.15,0,5,-0.14265847,-0.046352549,5,-0.47552825,.15450849,5,-0.14265847,.046352549,5,-0.15,0,5,-0.40450849,.29389262,5,-0.12135254,.088167787,5,-0.14265847,.046352549,5,.088167787,.12135254,5,.29389262,.40450849,5,.40450849,.29389262,5,.15,0,5,.5,0,5,.47552825,-0.15450849,5,.40450849,-0.29389262,5,.12135254,-0.088167787,5,.14265847,-0.046352549,5,.29389262,-0.40450849,5,.088167787,-0.12135254,5,.12135254,-0.088167787,5,-0.088167787,-0.12135254,5,-0.29389262,-0.40450849,5,-0.40450849,-0.29389262,5,-0.14265847,-0.046352549,5,-0.47552825,-0.15450849,5,-0.5,0,5,-0.14265847,.046352549,5,-0.47552825,.15450849,5,-0.40450849,.29389262,5,-0.29389262,.40450849,5,-0.088167787,.12135254,5,-0.12135254,.088167787,5,.14265847,.046352549,5,.47552825,.15450849,5,.5,0,5,.12135254,-0.088167787,5,.40450849,-0.29389262,5,.29389262,-0.40450849,5,.15450849,-0.47552825,5,.046352549,-0.14265847,5,.088167787,-0.12135254,5,0,-0.5,5,0,-0.15,5,.046352549,-0.14265847,5,-0.12135254,-0.088167787,5,-0.40450849,-0.29389262,5,-0.47552825,-0.15450849,5,-0.12135254,.088167787,5,-0.40450849,.29389262,5,-0.29389262,.40450849,5,-0.15450849,.47552825,5,-0.046352549,.14265847,5,-0.088167787,.12135254,5,0,.5,5,0,.15,5,-0.046352549,.14265847,5,.14265847,-0.046352549,5,.47552825,-0.15450849,5,.40450849,-0.29389262,5,.046352549,-0.14265847,5,.15450849,-0.47552825,5,0,-0.5,5,-0.15,0,5,-0.5,0,5,-0.47552825,.15450849,5,-0.046352549,.14265847,5,-0.15450849,.47552825,5,0,.5,5,.088167787,-0.12135254,5,.29389262,-0.40450849,5,.15450849,-0.47552825,5,-0.088167787,.12135254,5,-0.29389262,.40450849,5,-0.15450849,.47552825,5,0,-0.15,5,0,-0.5,5,-0.15450849,-0.47552825,5,0,.15,5,0,.5,5,.15450849,.47552825,5,0,-0.5,5,.15450849,-0.47552825,7,0,0,5,.15450849,-0.47552825,5,.29389262,-0.40450849,7,0,0,5,.29389262,-0.40450849,5,.40450849,-0.29389262,7,0,0,5,.40450849,-0.29389262,5,.47552825,-0.15450849,7,0,0,5,.47552825,-0.15450849,5,.5,0,7,0,0,5,.5,0,5,.47552825,.15450849,7,0,0,5,.47552825,.15450849,5,.40450849,.29389262,7,0,0,5,.40450849,.29389262,5,.29389262,.40450849,7,0,0,5,.29389262,.40450849,5,.15450849,.47552825,7,0,0,5,.15450849,.47552825,5,0,.5,7,0,0,5,0,.5,5,-0.15450849,.47552825,7,0,0,5,-0.15450849,.47552825,5,-0.29389262,.40450849,7,0,0,5,-0.29389262,.40450849,5,-0.40450849,.29389262,7,0,0,5,-0.40450849,.29389262,5,-0.47552825,.15450849,7,0,0,5,-0.47552825,.15450849,5,-0.5,0,7,0,0,5,-0.5,0,5,-0.47552825,-0.15450849,7,0,0,5,-0.47552825,-0.15450849,5,-0.40450849,-0.29389262,7,0,0,5,-0.40450849,-0.29389262,5,-0.29389262,-0.40450849,7,0,0,5,-0.29389262,-0.40450849,5,-0.15450849,-0.47552825,7,0,0,5,-0.15450849,-0.47552825,5,0,-0.5,7,0,0],n.axisPntY=[.12135254,0,-0.088167787,.12135254,0,.088167787,.088167787,0,.12135254,-0.14265847,0,.046352549,-0.14265847,0,-0.046352549,-0.12135254,0,-0.088167787,.12135254,0,-0.088167787,.14265847,0,.046352549,.12135254,0,.088167787,.14265847,0,.046352549,.12135254,0,-0.088167787,.14265847,0,-0.046352549,-0.14265847,0,.046352549,-0.15,0,0,-0.14265847,0,-0.046352549,-0.088167787,0,-0.12135254,-0.088167787,0,.12135254,-0.12135254,0,.088167787,.12135254,0,-0.088167787,.046352549,0,.14265847,0,0,.15,.14265847,0,-0.046352549,.15,0,0,.14265847,0,.046352549,-0.046352549,0,.14265847,-0.088167787,0,-0.12135254,-0.046352549,0,-0.14265847,-0.12135254,0,.088167787,-0.14265847,0,.046352549,-0.088167787,0,-0.12135254,.088167787,0,.12135254,.046352549,0,.14265847,.12135254,0,-0.088167787,-0.046352549,0,-0.14265847,0,0,-0.15,-0.046352549,0,.14265847,-0.088167787,0,-0.12135254,-0.046352549,0,.14265847,-0.088167787,0,.12135254,-0.046352549,0,.14265847,.088167787,0,-0.12135254,.12135254,0,-0.088167787,-0.12135254,0,-0.088167787,-0.088167787,0,-0.12135254,-0.14265847,0,.046352549,-0.046352549,0,.14265847,.046352549,0,-0.14265847,.088167787,0,-0.12135254,0,0,.15,-0.046352549,0,.14265847,.12135254,0,-0.088167787,0,0,-0.15,.046352549,0,-0.14265847,-0.046352549,0,.14265847,.14265847,0,-0.046352549,.14265847,5,-0.046352549,.15,5,0,.12135254,0,-0.088167787,.12135254,5,-0.088167787,.14265847,5,-0.046352549,.088167787,0,-0.12135254,.088167787,5,-0.12135254,.12135254,5,-0.088167787,.046352549,0,-0.14265847,.046352549,5,-0.14265847,.088167787,5,-0.12135254,0,0,-0.15,0,5,-0.15,.046352549,5,-0.14265847,-0.046352549,0,-0.14265847,-0.046352549,5,-0.14265847,0,5,-0.15,-0.088167787,0,-0.12135254,-0.088167787,5,-0.12135254,-0.046352549,5,-0.14265847,-0.12135254,0,-0.088167787,-0.12135254,5,-0.088167787,-0.088167787,5,-0.12135254,-0.14265847,0,-0.046352549,-0.14265847,5,-0.046352549,-0.12135254,5,-0.088167787,-0.15,0,0,-0.15,5,0,-0.14265847,5,-0.046352549,-0.14265847,0,.046352549,-0.14265847,5,.046352549,-0.15,5,0,-0.12135254,0,.088167787,-0.12135254,5,.088167787,-0.14265847,5,.046352549,-0.088167787,0,.12135254,-0.088167787,5,.12135254,-0.12135254,5,.088167787,-0.046352549,0,.14265847,-0.046352549,5,.14265847,-0.088167787,5,.12135254,0,0,.15,0,5,.15,-0.046352549,5,.14265847,.046352549,0,.14265847,.046352549,5,.14265847,0,5,.15,.088167787,0,.12135254,.088167787,5,.12135254,.046352549,5,.14265847,.12135254,0,.088167787,.12135254,5,.088167787,.088167787,5,.12135254,.14265847,0,.046352549,.14265847,5,.046352549,.12135254,5,.088167787,.15,0,0,.15,5,0,.14265847,5,.046352549,.14265847,5,.046352549,.14265847,0,.046352549,.15,0,0,.12135254,5,.088167787,.12135254,0,.088167787,.14265847,0,.046352549,.088167787,5,.12135254,.088167787,0,.12135254,.12135254,0,.088167787,.046352549,5,.14265847,.046352549,0,.14265847,.088167787,0,.12135254,0,5,.15,0,0,.15,.046352549,0,.14265847,-0.046352549,5,.14265847,-0.046352549,0,.14265847,0,0,.15,-0.088167787,5,.12135254,-0.088167787,0,.12135254,-0.046352549,0,.14265847,-0.12135254,5,.088167787,-0.12135254,0,.088167787,-0.088167787,0,.12135254,-0.14265847,5,.046352549,-0.14265847,0,.046352549,-0.12135254,0,.088167787,-0.15,5,0,-0.15,0,0,-0.14265847,0,.046352549,-0.14265847,5,-0.046352549,-0.14265847,0,-0.046352549,-0.15,0,0,-0.12135254,5,-0.088167787,-0.12135254,0,-0.088167787,-0.14265847,0,-0.046352549,-0.088167787,5,-0.12135254,-0.088167787,0,-0.12135254,-0.12135254,0,-0.088167787,-0.046352549,5,-0.14265847,-0.046352549,0,-0.14265847,-0.088167787,0,-0.12135254,0,5,-0.15,0,0,-0.15,-0.046352549,0,-0.14265847,.046352549,5,-0.14265847,.046352549,0,-0.14265847,0,0,-0.15,.088167787,5,-0.12135254,.088167787,0,-0.12135254,.046352549,0,-0.14265847,.12135254,5,-0.088167787,.12135254,0,-0.088167787,.088167787,0,-0.12135254,.14265847,5,-0.046352549,.14265847,0,-0.046352549,.12135254,0,-0.088167787,.15,5,0,.15,0,0,.14265847,0,-0.046352549,.29389262,5,-0.40450849,.088167787,5,-0.12135254,.046352549,5,-0.14265847,.40450849,5,-0.29389262,.12135254,5,-0.088167787,.088167787,5,-0.12135254,.47552825,5,.15450849,.14265847,5,.046352549,.15,5,0,.40450849,5,.29389262,.12135254,5,.088167787,.14265847,5,.046352549,.088167787,5,-0.12135254,.29389262,5,-0.40450849,.40450849,5,-0.29389262,.47552825,5,-0.15450849,.14265847,5,-0.046352549,.12135254,5,-0.088167787,.14265847,5,.046352549,.47552825,5,.15450849,.40450849,5,.29389262,.29389262,5,.40450849,.088167787,5,.12135254,.12135254,5,.088167787,.15450849,5,.47552825,.046352549,5,.14265847,.088167787,5,.12135254,0,5,.5,0,5,.15,.046352549,5,.14265847,-0.15450849,5,.47552825,-0.046352549,5,.14265847,0,5,.15,-0.29389262,5,.40450849,-0.088167787,5,.12135254,-0.046352549,5,.14265847,-0.47552825,5,.15450849,-0.14265847,5,.046352549,-0.12135254,5,.088167787,-0.5,5,0,-0.15,5,0,-0.14265847,5,.046352549,-0.47552825,5,-0.15450849,-0.14265847,5,-0.046352549,-0.15,5,0,-0.40450849,5,-0.29389262,-0.12135254,5,-0.088167787,-0.14265847,5,-0.046352549,.15450849,5,-0.47552825,.046352549,5,-0.14265847,0,5,-0.15,.12135254,5,-0.088167787,.40450849,5,-0.29389262,.47552825,5,-0.15450849,.12135254,5,.088167787,.40450849,5,.29389262,.29389262,5,.40450849,.046352549,5,.14265847,.15450849,5,.47552825,0,5,.5,-0.046352549,5,.14265847,-0.15450849,5,.47552825,-0.29389262,5,.40450849,-0.40450849,5,.29389262,-0.12135254,5,.088167787,-0.088167787,5,.12135254,-0.14265847,5,.046352549,-0.47552825,5,.15450849,-0.5,5,0,-0.14265847,5,-0.046352549,-0.47552825,5,-0.15450849,-0.40450849,5,-0.29389262,-0.29389262,5,-0.40450849,-0.088167787,5,-0.12135254,-0.12135254,5,-0.088167787,-0.29389262,5,-0.40450849,-0.15450849,5,-0.47552825,-0.046352549,5,-0.14265847,.046352549,5,-0.14265847,.15450849,5,-0.47552825,.29389262,5,-0.40450849,.5,5,0,.15,5,0,.14265847,5,-0.046352549,.088167787,5,.12135254,.29389262,5,.40450849,.15450849,5,.47552825,-0.088167787,5,.12135254,-0.29389262,5,.40450849,-0.40450849,5,.29389262,-0.15,5,0,-0.5,5,0,-0.47552825,5,-0.15450849,-0.046352549,5,-0.14265847,-0.088167787,5,-0.12135254,-0.29389262,5,-0.40450849,.14265847,5,-0.046352549,.47552825,5,-0.15450849,.5,5,0,0,5,.15,0,5,.5,-0.15450849,5,.47552825,-0.12135254,5,-0.088167787,-0.40450849,5,-0.29389262,-0.29389262,5,-0.40450849,0,5,-0.5,0,5,-0.15,-0.046352549,5,-0.14265847,.15,5,0,.5,5,0,.47552825,5,.15450849,-0.046352549,5,-0.14265847,-0.15450849,5,-0.47552825,0,5,-0.5,-0.12135254,5,.088167787,-0.40450849,5,.29389262,-0.47552825,5,.15450849,0,5,-0.15,0,5,-0.5,.15450849,5,-0.47552825,.5,5,0,.47552825,5,-0.15450849,0,7,0,.47552825,5,-0.15450849,.40450849,5,-0.29389262,0,7,0,.40450849,5,-0.29389262,.29389262,5,-0.40450849,0,7,0,.29389262,5,-0.40450849,.15450849,5,-0.47552825,0,7,0,.15450849,5,-0.47552825,0,5,-0.5,0,7,0,0,5,-0.5,-0.15450849,5,-0.47552825,0,7,0,-0.15450849,5,-0.47552825,-0.29389262,5,-0.40450849,0,7,0,-0.29389262,5,-0.40450849,-0.40450849,5,-0.29389262,0,7,0,-0.40450849,5,-0.29389262,-0.47552825,5,-0.15450849,0,7,0,-0.47552825,5,-0.15450849,-0.5,5,0,0,7,0,-0.5,5,0,-0.47552825,5,.15450849,0,7,0,-0.47552825,5,.15450849,-0.40450849,5,.29389262,0,7,0,-0.40450849,5,.29389262,-0.29389262,5,.40450849,0,7,0,-0.29389262,5,.40450849,-0.15450849,5,.47552825,0,7,0,-0.15450849,5,.47552825,0,5,.5,0,7,0,0,5,.5,.15450849,5,.47552825,0,7,0,.15450849,5,.47552825,.29389262,5,.40450849,0,7,0,.29389262,5,.40450849,.40450849,5,.29389262,0,7,0,.40450849,5,.29389262,.47552825,5,.15450849,0,7,0,.47552825,5,.15450849,.5,5,0,0,7,0],n.axisPntZ=[-0.14265847,-0.046352549,0,-0.14265847,.046352549,0,-0.12135254,.088167787,0,.046352549,-0.14265847,0,.14265847,-0.046352549,0,.12135254,-0.088167787,0,.046352549,-0.14265847,0,.14265847,.046352549,0,.15,0,0,-0.14265847,-0.046352549,0,-0.15,0,0,-0.14265847,.046352549,0,-0.088167787,.12135254,0,-0.088167787,-0.12135254,0,-0.12135254,-0.088167787,0,.14265847,.046352549,0,.046352549,-0.14265847,0,0,-0.15,0,.15,0,0,.14265847,-0.046352549,0,.046352549,-0.14265847,0,-0.046352549,-0.14265847,0,-0.088167787,.12135254,0,-0.046352549,.14265847,0,-0.12135254,-0.088167787,0,-0.14265847,-0.046352549,0,-0.088167787,.12135254,0,.12135254,-0.088167787,0,.088167787,-0.12135254,0,.046352549,-0.14265847,0,-0.046352549,-0.14265847,0,.088167787,.12135254,0,.12135254,.088167787,0,-0.046352549,.14265847,0,0,.15,0,-0.046352549,-0.14265847,0,-0.088167787,.12135254,0,-0.046352549,-0.14265847,0,-0.088167787,-0.12135254,0,.12135254,.088167787,0,.14265847,.046352549,0,-0.046352549,-0.14265847,0,-0.12135254,.088167787,0,-0.088167787,.12135254,0,-0.14265847,-0.046352549,0,-0.046352549,-0.14265847,0,.046352549,.14265847,0,.088167787,.12135254,0,0,-0.15,0,-0.046352549,-0.14265847,0,.14265847,.046352549,0,0,.15,0,.046352549,.14265847,0,-0.046352549,-0.14265847,0,.14265847,.046352549,0,.14265847,.046352549,5,.15,0,5,.12135254,.088167787,0,.12135254,.088167787,5,.14265847,.046352549,5,.088167787,.12135254,0,.088167787,.12135254,5,.12135254,.088167787,5,.046352549,.14265847,0,.046352549,.14265847,5,.088167787,.12135254,5,0,.15,0,0,.15,5,.046352549,.14265847,5,-0.046352549,.14265847,0,-0.046352549,.14265847,5,0,.15,5,-0.088167787,.12135254,0,-0.088167787,.12135254,5,-0.046352549,.14265847,5,-0.12135254,.088167787,0,-0.12135254,.088167787,5,-0.088167787,.12135254,5,-0.14265847,.046352549,0,-0.14265847,.046352549,5,-0.12135254,.088167787,5,-0.15,0,0,-0.15,0,5,-0.14265847,.046352549,5,-0.14265847,-0.046352549,0,-0.14265847,-0.046352549,5,-0.15,0,5,-0.12135254,-0.088167787,0,-0.12135254,-0.088167787,5,-0.14265847,-0.046352549,5,-0.088167787,-0.12135254,0,-0.088167787,-0.12135254,5,-0.12135254,-0.088167787,5,-0.046352549,-0.14265847,0,-0.046352549,-0.14265847,5,-0.088167787,-0.12135254,5,0,-0.15,0,0,-0.15,5,-0.046352549,-0.14265847,5,.046352549,-0.14265847,0,.046352549,-0.14265847,5,0,-0.15,5,.088167787,-0.12135254,0,.088167787,-0.12135254,5,.046352549,-0.14265847,5,.12135254,-0.088167787,0,.12135254,-0.088167787,5,.088167787,-0.12135254,5,.14265847,-0.046352549,0,.14265847,-0.046352549,5,.12135254,-0.088167787,5,.15,0,0,.15,0,5,.14265847,-0.046352549,5,.14265847,-0.046352549,5,.14265847,-0.046352549,0,.15,0,0,.12135254,-0.088167787,5,.12135254,-0.088167787,0,.14265847,-0.046352549,0,.088167787,-0.12135254,5,.088167787,-0.12135254,0,.12135254,-0.088167787,0,.046352549,-0.14265847,5,.046352549,-0.14265847,0,.088167787,-0.12135254,0,0,-0.15,5,0,-0.15,0,.046352549,-0.14265847,0,-0.046352549,-0.14265847,5,-0.046352549,-0.14265847,0,0,-0.15,0,-0.088167787,-0.12135254,5,-0.088167787,-0.12135254,0,-0.046352549,-0.14265847,0,-0.12135254,-0.088167787,5,-0.12135254,-0.088167787,0,-0.088167787,-0.12135254,0,-0.14265847,-0.046352549,5,-0.14265847,-0.046352549,0,-0.12135254,-0.088167787,0,-0.15,0,5,-0.15,0,0,-0.14265847,-0.046352549,0,-0.14265847,.046352549,5,-0.14265847,.046352549,0,-0.15,0,0,-0.12135254,.088167787,5,-0.12135254,.088167787,0,-0.14265847,.046352549,0,-0.088167787,.12135254,5,-0.088167787,.12135254,0,-0.12135254,.088167787,0,-0.046352549,.14265847,5,-0.046352549,.14265847,0,-0.088167787,.12135254,0,0,.15,5,0,.15,0,-0.046352549,.14265847,0,.046352549,.14265847,5,.046352549,.14265847,0,0,.15,0,.088167787,.12135254,5,.088167787,.12135254,0,.046352549,.14265847,0,.12135254,.088167787,5,.12135254,.088167787,0,.088167787,.12135254,0,.14265847,.046352549,5,.14265847,.046352549,0,.12135254,.088167787,0,.15,0,5,.15,0,0,.14265847,.046352549,0,-0.47552825,.15450849,5,-0.14265847,.046352549,5,-0.15,0,5,-0.40450849,.29389262,5,-0.12135254,.088167787,5,-0.14265847,.046352549,5,-0.29389262,.40450849,5,-0.088167787,.12135254,5,-0.12135254,.088167787,5,-0.29389262,.40450849,5,-0.15450849,.47552825,5,-0.046352549,.14265847,5,.47552825,-0.15450849,5,.14265847,-0.046352549,5,.15,0,5,.40450849,-0.29389262,5,.12135254,-0.088167787,5,.14265847,-0.046352549,5,-0.14265847,.046352549,5,-0.47552825,.15450849,5,-0.40450849,.29389262,5,-0.046352549,.14265847,5,-0.088167787,.12135254,5,-0.29389262,.40450849,5,0,.5,5,0,.15,5,-0.046352549,.14265847,5,.15450849,.47552825,5,.046352549,.14265847,5,0,.15,5,.14265847,-0.046352549,5,.47552825,-0.15450849,5,.40450849,-0.29389262,5,.29389262,-0.40450849,5,.088167787,-0.12135254,5,.12135254,-0.088167787,5,.15450849,-0.47552825,5,.046352549,-0.14265847,5,.088167787,-0.12135254,5,0,-0.5,5,0,-0.15,5,.046352549,-0.14265847,5,-0.15450849,-0.47552825,5,-0.046352549,-0.14265847,5,0,-0.15,5,-0.29389262,-0.40450849,5,-0.088167787,-0.12135254,5,-0.046352549,-0.14265847,5,-0.12135254,.088167787,5,-0.40450849,.29389262,5,-0.29389262,.40450849,5,0,.15,5,0,.5,5,.15450849,.47552825,5,.29389262,.40450849,5,.088167787,.12135254,5,.046352549,.14265847,5,.40450849,.29389262,5,.12135254,.088167787,5,.088167787,.12135254,5,.12135254,-0.088167787,5,.40450849,-0.29389262,5,.29389262,-0.40450849,5,.046352549,-0.14265847,5,.15450849,-0.47552825,5,0,-0.5,5,-0.046352549,-0.14265847,5,-0.15450849,-0.47552825,5,-0.29389262,-0.40450849,5,-0.40450849,-0.29389262,5,-0.12135254,-0.088167787,5,-0.088167787,-0.12135254,5,-0.046352549,.14265847,5,-0.15450849,.47552825,5,0,.5,5,.088167787,.12135254,5,.29389262,.40450849,5,.40450849,.29389262,5,.47552825,.15450849,5,.14265847,.046352549,5,.12135254,.088167787,5,.5,0,5,.15,0,5,.14265847,.046352549,5,.088167787,-0.12135254,5,.29389262,-0.40450849,5,.15450849,-0.47552825,5,-0.088167787,-0.12135254,5,-0.29389262,-0.40450849,5,-0.40450849,-0.29389262,5,-0.47552825,-0.15450849,5,-0.14265847,-0.046352549,5,-0.12135254,-0.088167787,5,-0.5,0,5,-0.15,0,5,-0.14265847,-0.046352549,5,.046352549,.14265847,5,.15450849,.47552825,5,.29389262,.40450849,5,.14265847,.046352549,5,.47552825,.15450849,5,.5,0,5,0,-0.15,5,0,-0.5,5,-0.15450849,-0.47552825,5,-0.14265847,-0.046352549,5,-0.47552825,-0.15450849,5,-0.5,0,5,.12135254,.088167787,5,.40450849,.29389262,5,.47552825,.15450849,5,-0.12135254,-0.088167787,5,-0.40450849,-0.29389262,5,-0.47552825,-0.15450849,5,.15,0,5,.5,0,5,.47552825,-0.15450849,5,-0.15,0,5,-0.5,0,5,-0.47552825,.15450849,5,.5,0,5,.47552825,.15450849,5,0,0,7,.47552825,.15450849,5,.40450849,.29389262,5,0,0,7,.40450849,.29389262,5,.29389262,.40450849,5,0,0,7,.29389262,.40450849,5,.15450849,.47552825,5,0,0,7,.15450849,.47552825,5,0,.5,5,0,0,7,0,.5,5,-0.15450849,.47552825,5,0,0,7,-0.15450849,.47552825,5,-0.29389262,.40450849,5,0,0,7,-0.29389262,.40450849,5,-0.40450849,.29389262,5,0,0,7,-0.40450849,.29389262,5,-0.47552825,.15450849,5,0,0,7,-0.47552825,.15450849,5,-0.5,0,5,0,0,7,-0.5,0,5,-0.47552825,-0.15450849,5,0,0,7,-0.47552825,-0.15450849,5,-0.40450849,-0.29389262,5,0,0,7,-0.40450849,-0.29389262,5,-0.29389262,-0.40450849,5,0,0,7,-0.29389262,-0.40450849,5,-0.15450849,-0.47552825,5,0,0,7,-0.15450849,-0.47552825,5,0,-0.5,5,0,0,7,0,-0.5,5,.15450849,-0.47552825,5,0,0,7,.15450849,-0.47552825,5,.29389262,-0.40450849,5,0,0,7,.29389262,-0.40450849,5,.40450849,-0.29389262,5,0,0,7,.40450849,-0.29389262,5,.47552825,-0.15450849,5,0,0,7,.47552825,-0.15450849,5,.5,0,5,0,0,7],n.axisPntO=[.15450849,0,-0.47552825,.14694631,.047745751,-0.47552825,.27950849,.090817816,-0.40450849,.14694631,.047745751,-0.47552825,.125,.090817816,-0.47552825,.23776412,.17274575,-0.40450849,.125,.090817816,-0.47552825,.090817816,.125,-0.47552825,.17274575,.23776412,-0.40450849,.090817816,.125,-0.47552825,.047745751,.14694631,-0.47552825,.090817816,.27950849,-0.40450849,.047745751,.14694631,-0.47552825,0,.15450849,-0.47552825,0,.29389262,-0.40450849,0,.15450849,-0.47552825,-0.047745751,.14694631,-0.47552825,-0.090817816,.27950849,-0.40450849,-0.047745751,.14694631,-0.47552825,-0.090817816,.125,-0.47552825,-0.17274575,.23776412,-0.40450849,-0.090817816,.125,-0.47552825,-0.125,.090817816,-0.47552825,-0.23776412,.17274575,-0.40450849,-0.125,.090817816,-0.47552825,-0.14694631,.047745751,-0.47552825,-0.27950849,.090817816,-0.40450849,-0.14694631,.047745751,-0.47552825,-0.15450849,0,-0.47552825,-0.29389262,0,-0.40450849,-0.15450849,0,-0.47552825,-0.14694631,-0.047745751,-0.47552825,-0.27950849,-0.090817816,-0.40450849,-0.14694631,-0.047745751,-0.47552825,-0.125,-0.090817816,-0.47552825,-0.23776412,-0.17274575,-0.40450849,-0.125,-0.090817816,-0.47552825,-0.090817816,-0.125,-0.47552825,-0.17274575,-0.23776412,-0.40450849,-0.090817816,-0.125,-0.47552825,-0.047745751,-0.14694631,-0.47552825,-0.090817816,-0.27950849,-0.40450849,-0.047745751,-0.14694631,-0.47552825,0,-0.15450849,-0.47552825,0,-0.29389262,-0.40450849,0,-0.15450849,-0.47552825,.047745751,-0.14694631,-0.47552825,.090817816,-0.27950849,-0.40450849,.047745751,-0.14694631,-0.47552825,.090817816,-0.125,-0.47552825,.17274575,-0.23776412,-0.40450849,.090817816,-0.125,-0.47552825,.125,-0.090817816,-0.47552825,.23776412,-0.17274575,-0.40450849,.125,-0.090817816,-0.47552825,.14694631,-0.047745751,-0.47552825,.27950849,-0.090817816,-0.40450849,.14694631,-0.047745751,-0.47552825,.15450849,0,-0.47552825,.29389262,0,-0.40450849,.29389262,0,-0.40450849,.27950849,.090817816,-0.40450849,.38471044,.125,-0.29389262,.27950849,.090817816,-0.40450849,.23776412,.17274575,-0.40450849,.32725424,.23776412,-0.29389262,.23776412,.17274575,-0.40450849,.17274575,.23776412,-0.40450849,.23776412,.32725424,-0.29389262,.17274575,.23776412,-0.40450849,.090817816,.27950849,-0.40450849,.125,.38471044,-0.29389262,.090817816,.27950849,-0.40450849,0,.29389262,-0.40450849,0,.40450849,-0.29389262,0,.29389262,-0.40450849,-0.090817816,.27950849,-0.40450849,-0.125,.38471044,-0.29389262,-0.090817816,.27950849,-0.40450849,-0.17274575,.23776412,-0.40450849,-0.23776412,.32725424,-0.29389262,-0.17274575,.23776412,-0.40450849
,-0.23776412,.17274575,-0.40450849,-0.32725424,.23776412,-0.29389262,-0.23776412,.17274575,-0.40450849,-0.27950849,.090817816,-0.40450849,-0.38471044,.125,-0.29389262,-0.27950849,.090817816,-0.40450849,-0.29389262,0,-0.40450849,-0.40450849,0,-0.29389262,-0.29389262,0,-0.40450849,-0.27950849,-0.090817816,-0.40450849,-0.38471044,-0.125,-0.29389262,-0.27950849,-0.090817816,-0.40450849,-0.23776412,-0.17274575,-0.40450849,-0.32725424,-0.23776412,-0.29389262,-0.23776412,-0.17274575,-0.40450849,-0.17274575,-0.23776412,-0.40450849,-0.23776412,-0.32725424,-0.29389262,-0.17274575,-0.23776412,-0.40450849,-0.090817816,-0.27950849,-0.40450849,-0.125,-0.38471044,-0.29389262,-0.090817816,-0.27950849,-0.40450849,0,-0.29389262,-0.40450849,0,-0.40450849,-0.29389262,0,-0.29389262,-0.40450849,.090817816,-0.27950849,-0.40450849,.125,-0.38471044,-0.29389262,.090817816,-0.27950849,-0.40450849,.17274575,-0.23776412,-0.40450849,.23776412,-0.32725424,-0.29389262,.17274575,-0.23776412,-0.40450849,.23776412,-0.17274575,-0.40450849,.32725424,-0.23776412,-0.29389262,.23776412,-0.17274575,-0.40450849,.27950849,-0.090817816,-0.40450849,.38471044,-0.125,-0.29389262,.27950849,-0.090817816,-0.40450849,.29389262,0,-0.40450849,.40450849,0,-0.29389262,.40450849,0,-0.29389262,.38471044,.125,-0.29389262,.45225424,.14694631,-0.15450849,.38471044,.125,-0.29389262,.32725424,.23776412,-0.29389262,.38471044,.27950849,-0.15450849,.32725424,.23776412,-0.29389262,.23776412,.32725424,-0.29389262,.27950849,.38471044,-0.15450849,.23776412,.32725424,-0.29389262,.125,.38471044,-0.29389262,.14694631,.45225424,-0.15450849,.125,.38471044,-0.29389262,0,.40450849,-0.29389262,0,.47552825,-0.15450849,0,.40450849,-0.29389262,-0.125,.38471044,-0.29389262,-0.14694631,.45225424,-0.15450849,-0.125,.38471044,-0.29389262,-0.23776412,.32725424,-0.29389262,-0.27950849,.38471044,-0.15450849,-0.23776412,.32725424,-0.29389262,-0.32725424,.23776412,-0.29389262,-0.38471044,.27950849,-0.15450849,-0.32725424,.23776412,-0.29389262,-0.38471044,.125,-0.29389262,-0.45225424,.14694631,-0.15450849,-0.38471044,.125,-0.29389262,-0.40450849,0,-0.29389262,-0.47552825,0,-0.15450849,-0.40450849,0,-0.29389262,-0.38471044,-0.125,-0.29389262,-0.45225424,-0.14694631,-0.15450849,-0.38471044,-0.125,-0.29389262,-0.32725424,-0.23776412,-0.29389262,-0.38471044,-0.27950849,-0.15450849,-0.32725424,-0.23776412,-0.29389262,-0.23776412,-0.32725424,-0.29389262,-0.27950849,-0.38471044,-0.15450849,-0.23776412,-0.32725424,-0.29389262,-0.125,-0.38471044,-0.29389262,-0.14694631,-0.45225424,-0.15450849,-0.125,-0.38471044,-0.29389262,0,-0.40450849,-0.29389262,0,-0.47552825,-0.15450849,0,-0.40450849,-0.29389262,.125,-0.38471044,-0.29389262,.14694631,-0.45225424,-0.15450849,.125,-0.38471044,-0.29389262,.23776412,-0.32725424,-0.29389262,.27950849,-0.38471044,-0.15450849,.23776412,-0.32725424,-0.29389262,.32725424,-0.23776412,-0.29389262,.38471044,-0.27950849,-0.15450849,.32725424,-0.23776412,-0.29389262,.38471044,-0.125,-0.29389262,.45225424,-0.14694631,-0.15450849,.38471044,-0.125,-0.29389262,.40450849,0,-0.29389262,.47552825,0,-0.15450849,.47552825,0,-0.15450849,.45225424,.14694631,-0.15450849,.47552825,.15450849,0,.45225424,.14694631,-0.15450849,.38471044,.27950849,-0.15450849,.40450849,.29389262,0,.38471044,.27950849,-0.15450849,.27950849,.38471044,-0.15450849,.29389262,.40450849,0,.27950849,.38471044,-0.15450849,.14694631,.45225424,-0.15450849,.15450849,.47552825,0,.14694631,.45225424,-0.15450849,0,.47552825,-0.15450849,0,.5,0,0,.47552825,-0.15450849,-0.14694631,.45225424,-0.15450849,-0.15450849,.47552825,0,-0.14694631,.45225424,-0.15450849,-0.27950849,.38471044,-0.15450849,-0.29389262,.40450849,0,-0.27950849,.38471044,-0.15450849,-0.38471044,.27950849,-0.15450849,-0.40450849,.29389262,0,-0.38471044,.27950849,-0.15450849,-0.45225424,.14694631,-0.15450849,-0.47552825,.15450849,0,-0.45225424,.14694631,-0.15450849,-0.47552825,0,-0.15450849,-0.5,0,0,-0.47552825,0,-0.15450849,-0.45225424,-0.14694631,-0.15450849,-0.47552825,-0.15450849,0,-0.45225424,-0.14694631,-0.15450849,-0.38471044,-0.27950849,-0.15450849,-0.40450849,-0.29389262,0,-0.38471044,-0.27950849,-0.15450849,-0.27950849,-0.38471044,-0.15450849,-0.29389262,-0.40450849,0,-0.27950849,-0.38471044,-0.15450849,-0.14694631,-0.45225424,-0.15450849,-0.15450849,-0.47552825,0,-0.14694631,-0.45225424,-0.15450849,0,-0.47552825,-0.15450849,0,-0.5,0,0,-0.47552825,-0.15450849,.14694631,-0.45225424,-0.15450849,.15450849,-0.47552825,0,.14694631,-0.45225424,-0.15450849,.27950849,-0.38471044,-0.15450849,.29389262,-0.40450849,0,.27950849,-0.38471044,-0.15450849,.38471044,-0.27950849,-0.15450849,.40450849,-0.29389262,0,.38471044,-0.27950849,-0.15450849,.45225424,-0.14694631,-0.15450849,.47552825,-0.15450849,0,.45225424,-0.14694631,-0.15450849,.47552825,0,-0.15450849,.5,0,0,.5,0,0,.47552825,.15450849,0,.45225424,.14694631,.15450849,.47552825,.15450849,0,.40450849,.29389262,0,.38471044,.27950849,.15450849,.40450849,.29389262,0,.29389262,.40450849,0,.27950849,.38471044,.15450849,.29389262,.40450849,0,.15450849,.47552825,0,.14694631,.45225424,.15450849,.15450849,.47552825,0,0,.5,0,0,.47552825,.15450849,0,.5,0,-0.15450849,.47552825,0,-0.14694631,.45225424,.15450849,-0.15450849,.47552825,0,-0.29389262,.40450849,0,-0.27950849,.38471044,.15450849,-0.29389262,.40450849,0,-0.40450849,.29389262,0,-0.38471044,.27950849,.15450849,-0.40450849,.29389262,0,-0.47552825,.15450849,0,-0.45225424,.14694631,.15450849,-0.47552825,.15450849,0,-0.5,0,0,-0.47552825,0,.15450849,-0.5,0,0,-0.47552825,-0.15450849,0,-0.45225424,-0.14694631,.15450849,-0.47552825,-0.15450849,0,-0.40450849,-0.29389262,0,-0.38471044,-0.27950849,.15450849,-0.40450849,-0.29389262,0,-0.29389262,-0.40450849,0,-0.27950849,-0.38471044,.15450849,-0.29389262,-0.40450849,0,-0.15450849,-0.47552825,0,-0.14694631,-0.45225424,.15450849,-0.15450849,-0.47552825,0,0,-0.5,0,0,-0.47552825,.15450849,0,-0.5,0,.15450849,-0.47552825,0,.14694631,-0.45225424,.15450849,.15450849,-0.47552825,0,.29389262,-0.40450849,0,.27950849,-0.38471044,.15450849,.29389262,-0.40450849,0,.40450849,-0.29389262,0,.38471044,-0.27950849,.15450849,.40450849,-0.29389262,0,.47552825,-0.15450849,0,.45225424,-0.14694631,.15450849,.47552825,-0.15450849,0,.5,0,0,.47552825,0,.15450849,.47552825,0,.15450849,.45225424,.14694631,.15450849,.38471044,.125,.29389262,.45225424,.14694631,.15450849,.38471044,.27950849,.15450849,.32725424,.23776412,.29389262,.38471044,.27950849,.15450849,.27950849,.38471044,.15450849,.23776412,.32725424,.29389262,.27950849,.38471044,.15450849,.14694631,.45225424,.15450849,.125,.38471044,.29389262,.14694631,.45225424,.15450849,0,.47552825,.15450849,0,.40450849,.29389262,0,.47552825,.15450849,-0.14694631,.45225424,.15450849,-0.125,.38471044,.29389262,-0.14694631,.45225424,.15450849,-0.27950849,.38471044,.15450849,-0.23776412,.32725424,.29389262,-0.27950849,.38471044,.15450849,-0.38471044,.27950849,.15450849,-0.32725424,.23776412,.29389262,-0.38471044,.27950849,.15450849,-0.45225424,.14694631,.15450849,-0.38471044,.125,.29389262,-0.45225424,.14694631,.15450849,-0.47552825,0,.15450849,-0.40450849,0,.29389262,-0.47552825,0,.15450849,-0.45225424,-0.14694631,.15450849,-0.38471044,-0.125,.29389262,-0.45225424,-0.14694631,.15450849,-0.38471044,-0.27950849,.15450849,-0.32725424,-0.23776412,.29389262,-0.38471044,-0.27950849,.15450849,-0.27950849,-0.38471044,.15450849,-0.23776412,-0.32725424,.29389262,-0.27950849,-0.38471044,.15450849,-0.14694631,-0.45225424,.15450849,-0.125,-0.38471044,.29389262,-0.14694631,-0.45225424,.15450849,0,-0.47552825,.15450849,0,-0.40450849,.29389262,0,-0.47552825,.15450849,.14694631,-0.45225424,.15450849,.125,-0.38471044,.29389262,.14694631,-0.45225424,.15450849,.27950849,-0.38471044,.15450849,.23776412,-0.32725424,.29389262,.27950849,-0.38471044,.15450849,.38471044,-0.27950849,.15450849,.32725424,-0.23776412,.29389262,.38471044,-0.27950849,.15450849,.45225424,-0.14694631,.15450849,.38471044,-0.125,.29389262,.45225424,-0.14694631,.15450849,.47552825,0,.15450849,.40450849,0,.29389262,.40450849,0,.29389262,.38471044,.125,.29389262,.27950849,.090817816,.40450849,.38471044,.125,.29389262,.32725424,.23776412,.29389262,.23776412,.17274575,.40450849,.32725424,.23776412,.29389262,.23776412,.32725424,.29389262,.17274575,.23776412,.40450849,.23776412,.32725424,.29389262,.125,.38471044,.29389262,.090817816,.27950849,.40450849,.125,.38471044,.29389262,0,.40450849,.29389262,0,.29389262,.40450849,0,.40450849,.29389262,-0.125,.38471044,.29389262,-0.090817816,.27950849,.40450849,-0.125,.38471044,.29389262,-0.23776412,.32725424,.29389262,-0.17274575,.23776412,.40450849,-0.23776412,.32725424,.29389262,-0.32725424,.23776412,.29389262,-0.23776412,.17274575,.40450849,-0.32725424,.23776412,.29389262,-0.38471044,.125,.29389262,-0.27950849,.090817816,.40450849,-0.38471044,.125,.29389262,-0.40450849,0,.29389262,-0.29389262,0,.40450849,-0.40450849,0,.29389262,-0.38471044,-0.125,.29389262,-0.27950849,-0.090817816,.40450849,-0.38471044,-0.125,.29389262,-0.32725424,-0.23776412,.29389262,-0.23776412,-0.17274575,.40450849,-0.32725424,-0.23776412,.29389262,-0.23776412,-0.32725424,.29389262,-0.17274575,-0.23776412,.40450849,-0.23776412,-0.32725424,.29389262,-0.125,-0.38471044,.29389262,-0.090817816,-0.27950849,.40450849,-0.125,-0.38471044,.29389262,0,-0.40450849,.29389262,0,-0.29389262,.40450849,0,-0.40450849,.29389262,.125,-0.38471044,.29389262,.090817816,-0.27950849,.40450849,.125,-0.38471044,.29389262,.23776412,-0.32725424,.29389262,.17274575,-0.23776412,.40450849,.23776412,-0.32725424,.29389262,.32725424,-0.23776412,.29389262,.23776412,-0.17274575,.40450849,.32725424,-0.23776412,.29389262,.38471044,-0.125,.29389262,.27950849,-0.090817816,.40450849,.38471044,-0.125,.29389262,.40450849,0,.29389262,.29389262,0,.40450849,.29389262,0,.40450849,.27950849,.090817816,.40450849,.14694631,.047745751,.47552825,.27950849,.090817816,.40450849,.23776412,.17274575,.40450849,.125,.090817816,.47552825,.23776412,.17274575,.40450849,.17274575,.23776412,.40450849,.090817816,.125,.47552825,.17274575,.23776412,.40450849,.090817816,.27950849,.40450849,.047745751,.14694631,.47552825,.090817816,.27950849,.40450849,0,.29389262,.40450849,0,.15450849,.47552825,0,.29389262,.40450849,-0.090817816,.27950849,.40450849,-0.047745751,.14694631,.47552825,-0.090817816,.27950849,.40450849,-0.17274575,.23776412,.40450849,-0.090817816,.125,.47552825,-0.17274575,.23776412,.40450849,-0.23776412,.17274575,.40450849,-0.125,.090817816,.47552825,-0.23776412,.17274575,.40450849,-0.27950849,.090817816,.40450849,-0.14694631,.047745751,.47552825,-0.27950849,.090817816,.40450849,-0.29389262,0,.40450849,-0.15450849,0,.47552825,-0.29389262,0,.40450849,-0.27950849,-0.090817816,.40450849,-0.14694631,-0.047745751,.47552825,-0.27950849,-0.090817816,.40450849,-0.23776412,-0.17274575,.40450849,-0.125,-0.090817816,.47552825,-0.23776412,-0.17274575,.40450849,-0.17274575,-0.23776412,.40450849,-0.090817816,-0.125,.47552825,-0.17274575,-0.23776412,.40450849,-0.090817816,-0.27950849,.40450849,-0.047745751,-0.14694631,.47552825,-0.090817816,-0.27950849,.40450849,0,-0.29389262,.40450849,0,-0.15450849,.47552825,0,-0.29389262,.40450849,.090817816,-0.27950849,.40450849,.047745751,-0.14694631,.47552825,.090817816,-0.27950849,.40450849,.17274575,-0.23776412,.40450849,.090817816,-0.125,.47552825,.17274575,-0.23776412,.40450849,.23776412,-0.17274575,.40450849,.125,-0.090817816,.47552825,.23776412,-0.17274575,.40450849,.27950849,-0.090817816,.40450849,.14694631,-0.047745751,.47552825,.27950849,-0.090817816,.40450849,.29389262,0,.40450849,.15450849,0,.47552825,0,0,.5,.14694631,-0.047745751,.47552825,.15450849,0,.47552825,0,0,.5,.125,-0.090817816,.47552825,.14694631,-0.047745751,.47552825,0,0,.5,.090817816,-0.125,.47552825,.125,-0.090817816,.47552825,0,0,.5,.047745751,-0.14694631,.47552825,.090817816,-0.125,.47552825,0,0,.5,0,-0.15450849,.47552825,.047745751,-0.14694631,.47552825,0,0,.5,-0.047745751,-0.14694631,.47552825,0,-0.15450849,.47552825,0,0,.5,-0.090817816,-0.125,.47552825,-0.047745751,-0.14694631,.47552825,0,0,.5,-0.125,-0.090817816,.47552825,-0.090817816,-0.125,.47552825,0,0,.5,-0.14694631,-0.047745751,.47552825,-0.125,-0.090817816,.47552825,0,0,.5,-0.15450849,0,.47552825,-0.14694631,-0.047745751,.47552825,0,0,.5,-0.14694631,.047745751,.47552825,-0.15450849,0,.47552825,0,0,.5,-0.125,.090817816,.47552825,-0.14694631,.047745751,.47552825,0,0,.5,-0.090817816,.125,.47552825,-0.125,.090817816,.47552825,0,0,.5,-0.047745751,.14694631,.47552825,-0.090817816,.125,.47552825,0,0,.5,0,.15450849,.47552825,-0.047745751,.14694631,.47552825,0,0,.5,.047745751,.14694631,.47552825,0,.15450849,.47552825,0,0,.5,.090817816,.125,.47552825,.047745751,.14694631,.47552825,0,0,.5,.125,.090817816,.47552825,.090817816,.125,.47552825,0,0,.5,.14694631,.047745751,.47552825,.125,.090817816,.47552825,0,0,.5,.15450849,0,.47552825,.14694631,.047745751,.47552825,.15450849,0,.47552825,.14694631,-0.047745751,.47552825,.27950849,-0.090817816,.40450849,.14694631,-0.047745751,.47552825,.125,-0.090817816,.47552825,.23776412,-0.17274575,.40450849,.125,-0.090817816,.47552825,.090817816,-0.125,.47552825,.17274575,-0.23776412,.40450849,.090817816,-0.125,.47552825,.047745751,-0.14694631,.47552825,.090817816,-0.27950849,.40450849,.047745751,-0.14694631,.47552825,0,-0.15450849,.47552825,0,-0.29389262,.40450849,0,-0.15450849,.47552825,-0.047745751,-0.14694631,.47552825,-0.090817816,-0.27950849,.40450849,-0.047745751,-0.14694631,.47552825,-0.090817816,-0.125,.47552825,-0.17274575,-0.23776412,.40450849,-0.090817816,-0.125,.47552825,-0.125,-0.090817816,.47552825,-0.23776412,-0.17274575,.40450849,-0.125,-0.090817816,.47552825,-0.14694631,-0.047745751,.47552825,-0.27950849,-0.090817816,.40450849,-0.14694631,-0.047745751,.47552825,-0.15450849,0,.47552825,-0.29389262,0,.40450849,-0.15450849,0,.47552825,-0.14694631,.047745751,.47552825,-0.27950849,.090817816,.40450849,-0.14694631,.047745751,.47552825,-0.125,.090817816,.47552825,-0.23776412,.17274575,.40450849,-0.125,.090817816,.47552825,-0.090817816,.125,.47552825,-0.17274575,.23776412,.40450849,-0.090817816,.125,.47552825,-0.047745751,.14694631,.47552825,-0.090817816,.27950849,.40450849,-0.047745751,.14694631,.47552825,0,.15450849,.47552825,0,.29389262,.40450849,0,.15450849,.47552825,.047745751,.14694631,.47552825,.090817816,.27950849,.40450849,.047745751,.14694631,.47552825,.090817816,.125,.47552825,.17274575,.23776412,.40450849,.090817816,.125,.47552825,.125,.090817816,.47552825,.23776412,.17274575,.40450849,.125,.090817816,.47552825,.14694631,.047745751,.47552825,.27950849,.090817816,.40450849,.14694631,.047745751,.47552825,.15450849,0,.47552825,.29389262,0,.40450849,.29389262,0,.40450849,.27950849,-0.090817816,.40450849,.38471044,-0.125,.29389262,.27950849,-0.090817816,.40450849,.23776412,-0.17274575,.40450849,.32725424,-0.23776412,.29389262,.23776412,-0.17274575,.40450849,.17274575,-0.23776412,.40450849,.23776412,-0.32725424,.29389262,.17274575,-0.23776412,.40450849,.090817816,-0.27950849,.40450849,.125,-0.38471044,.29389262,.090817816,-0.27950849,.40450849,0,-0.29389262,.40450849,0,-0.40450849,.29389262,0,-0.29389262,.40450849,-0.090817816,-0.27950849,.40450849,-0.125,-0.38471044,.29389262,-0.090817816,-0.27950849,.40450849,-0.17274575,-0.23776412,.40450849,-0.23776412,-0.32725424,.29389262,-0.17274575,-0.23776412,.40450849,-0.23776412,-0.17274575,.40450849,-0.32725424,-0.23776412,.29389262,-0.23776412,-0.17274575,.40450849,-0.27950849,-0.090817816,.40450849,-0.38471044,-0.125,.29389262,-0.27950849,-0.090817816,.40450849,-0.29389262,0,.40450849,-0.40450849,0,.29389262,-0.29389262,0,.40450849,-0.27950849,.090817816,.40450849,-0.38471044,.125,.29389262,-0.27950849,.090817816,.40450849,-0.23776412,.17274575,.40450849,-0.32725424,.23776412,.29389262,-0.23776412,.17274575,.40450849,-0.17274575,.23776412,.40450849,-0.23776412,.32725424,.29389262,-0.17274575,.23776412,.40450849,-0.090817816,.27950849,.40450849,-0.125,.38471044,.29389262,-0.090817816,.27950849,.40450849,0,.29389262,.40450849,0,.40450849,.29389262,0,.29389262,.40450849,.090817816,.27950849,.40450849,.125,.38471044,.29389262,.090817816,.27950849,.40450849,.17274575,.23776412,.40450849,.23776412,.32725424,.29389262,.17274575,.23776412,.40450849,.23776412,.17274575,.40450849,.32725424,.23776412,.29389262,.23776412,.17274575,.40450849,.27950849,.090817816,.40450849,.38471044,.125,.29389262,.27950849,.090817816,.40450849,.29389262,0,.40450849,.40450849,0,.29389262,.40450849,0,.29389262,.38471044,-0.125,.29389262,.45225424,-0.14694631,.15450849,.38471044,-0.125,.29389262,.32725424,-0.23776412,.29389262,.38471044,-0.27950849,.15450849,.32725424,-0.23776412,.29389262,.23776412,-0.32725424,.29389262,.27950849,-0.38471044,.15450849,.23776412,-0.32725424,.29389262,.125,-0.38471044,.29389262,.14694631,-0.45225424,.15450849,.125,-0.38471044,.29389262,0,-0.40450849,.29389262,0,-0.47552825,.15450849,0,-0.40450849,.29389262,-0.125,-0.38471044,.29389262,-0.14694631,-0.45225424,.15450849,-0.125,-0.38471044,.29389262,-0.23776412,-0.32725424,.29389262,-0.27950849,-0.38471044,.15450849,-0.23776412,-0.32725424,.29389262,-0.32725424,-0.23776412,.29389262,-0.38471044,-0.27950849,.15450849,-0.32725424,-0.23776412,.29389262,-0.38471044,-0.125,.29389262,-0.45225424,-0.14694631,.15450849,-0.38471044,-0.125,.29389262,-0.40450849,0,.29389262,-0.47552825,0,.15450849,-0.40450849,0,.29389262,-0.38471044,.125,.29389262,-0.45225424,.14694631,.15450849,-0.38471044,.125,.29389262,-0.32725424,.23776412,.29389262,-0.38471044,.27950849,.15450849,-0.32725424,.23776412,.29389262,-0.23776412,.32725424,.29389262,-0.27950849,.38471044,.15450849,-0.23776412,.32725424,.29389262,-0.125,.38471044,.29389262,-0.14694631,.45225424,.15450849,-0.125,.38471044,.29389262,0,.40450849,.29389262,0,.47552825,.15450849,0,.40450849,.29389262,.125,.38471044,.29389262,.14694631,.45225424,.15450849,.125,.38471044,.29389262,.23776412,.32725424,.29389262,.27950849,.38471044,.15450849,.23776412,.32725424,.29389262,.32725424,.23776412,.29389262,.38471044,.27950849,.15450849,.32725424,.23776412,.29389262,.38471044,.125,.29389262,.45225424,.14694631,.15450849,.38471044,.125,.29389262,.40450849,0,.29389262,.47552825,0,.15450849,.47552825,0,.15450849,.45225424,-0.14694631,.15450849,.47552825,-0.15450849,0,.45225424,-0.14694631,.15450849,.38471044,-0.27950849,.15450849,.40450849,-0.29389262,0,.38471044,-0.27950849,.15450849,.27950849,-0.38471044,.15450849,.29389262,-0.40450849,0,.27950849,-0.38471044,.15450849,.14694631,-0.45225424,.15450849,.15450849,-0.47552825,0,.14694631,-0.45225424,.15450849,0,-0.47552825,.15450849,0,-0.5,0,0,-0.47552825,.15450849,-0.14694631,-0.45225424,.15450849,-0.15450849,-0.47552825,0,-0.14694631,-0.45225424,.15450849,-0.27950849,-0.38471044,.15450849,-0.29389262,-0.40450849,0,-0.27950849,-0.38471044,.15450849,-0.38471044,-0.27950849,.15450849,-0.40450849,-0.29389262,0,-0.38471044,-0.27950849,.15450849,-0.45225424,-0.14694631,.15450849,-0.47552825,-0.15450849,0,-0.45225424,-0.14694631,.15450849,-0.47552825,0,.15450849,-0.5,0,0,-0.47552825,0,.15450849,-0.45225424,.14694631,.15450849,-0.47552825,.15450849,0,-0.45225424,.14694631,.15450849,-0.38471044,.27950849,.15450849,-0.40450849,.29389262,0,-0.38471044,.27950849,.15450849,-0.27950849,.38471044,.15450849,-0.29389262,.40450849,0,-0.27950849,.38471044,.15450849,-0.14694631,.45225424,.15450849,-0.15450849,.47552825,0,-0.14694631,.45225424,.15450849,0,.47552825,.15450849,0,.5,0,0,.47552825,.15450849,.14694631,.45225424,.15450849,.15450849,.47552825,0,.14694631,.45225424,.15450849,.27950849,.38471044,.15450849,.29389262,.40450849,0,.27950849,.38471044,.15450849,.38471044,.27950849,.15450849,.40450849,.29389262,0,.38471044,.27950849,.15450849,.45225424,.14694631,.15450849,.47552825,.15450849,0,.45225424,.14694631,.15450849,.47552825,0,.15450849,.5,0,0,.5,0,0,.47552825,-0.15450849,0,.45225424,-0.14694631,-0.15450849,.47552825,-0.15450849,0,.40450849,-0.29389262,0,.38471044,-0.27950849,-0.15450849,.40450849,-0.29389262,0,.29389262,-0.40450849,0,.27950849,-0.38471044,-0.15450849,.29389262,-0.40450849,0,.15450849,-0.47552825,0,.14694631,-0.45225424,-0.15450849,.15450849,-0.47552825,0,0,-0.5,0,0,-0.47552825,-0.15450849,0,-0.5,0,-0.15450849,-0.47552825,0,-0.14694631,-0.45225424,-0.15450849,-0.15450849,-0.47552825,0,-0.29389262,-0.40450849,0,-0.27950849,-0.38471044,-0.15450849,-0.29389262,-0.40450849,0,-0.40450849,-0.29389262,0,-0.38471044,-0.27950849,-0.15450849,-0.40450849,-0.29389262,0,-0.47552825,-0.15450849,0,-0.45225424,-0.14694631,-0.15450849,-0.47552825,-0.15450849,0,-0.5,0,0,-0.47552825,0,-0.15450849,-0.5,0,0,-0.47552825,.15450849,0,-0.45225424,.14694631,-0.15450849,-0.47552825,.15450849,0,-0.40450849,.29389262,0,-0.38471044,.27950849,-0.15450849,-0.40450849,.29389262,0,-0.29389262,.40450849,0,-0.27950849,.38471044,-0.15450849,-0.29389262,.40450849,0,-0.15450849,.47552825,0,-0.14694631,.45225424,-0.15450849,-0.15450849,.47552825,0,0,.5,0,0,.47552825,-0.15450849,0,.5,0,.15450849,.47552825,0,.14694631,.45225424,-0.15450849,.15450849,.47552825,0,.29389262,.40450849,0,.27950849,.38471044,-0.15450849,.29389262,.40450849,0,.40450849,.29389262,0,.38471044,.27950849,-0.15450849,.40450849,.29389262,0,.47552825,.15450849,0,.45225424,.14694631,-0.15450849,.47552825,.15450849,0,.5,0,0,.47552825,0,-0.15450849,.47552825,0,-0.15450849,.45225424,-0.14694631,-0.15450849,.38471044,-0.125,-0.29389262,.45225424,-0.14694631,-0.15450849,.38471044,-0.27950849,-0.15450849,.32725424,-0.23776412,-0.29389262,.38471044,-0.27950849,-0.15450849,.27950849,-0.38471044,-0.15450849,.23776412,-0.32725424,-0.29389262,.27950849,-0.38471044,-0.15450849,.14694631,-0.45225424,-0.15450849,.125,-0.38471044,-0.29389262,.14694631,-0.45225424,-0.15450849,0,-0.47552825,-0.15450849,0,-0.40450849,-0.29389262,0,-0.47552825,-0.15450849,-0.14694631,-0.45225424,-0.15450849,-0.125,-0.38471044,-0.29389262,-0.14694631,-0.45225424,-0.15450849,-0.27950849,-0.38471044,-0.15450849,-0.23776412,-0.32725424,-0.29389262,-0.27950849,-0.38471044,-0.15450849,-0.38471044,-0.27950849,-0.15450849,-0.32725424,-0.23776412,-0.29389262,-0.38471044,-0.27950849,-0.15450849,-0.45225424,-0.14694631,-0.15450849,-0.38471044,-0.125,-0.29389262,-0.45225424,-0.14694631,-0.15450849,-0.47552825,0,-0.15450849,-0.40450849,0,-0.29389262,-0.47552825,0,-0.15450849,-0.45225424,.14694631,-0.15450849,-0.38471044,.125,-0.29389262,-0.45225424,.14694631,-0.15450849,-0.38471044,.27950849,-0.15450849,-0.32725424,.23776412,-0.29389262,-0.38471044,.27950849,-0.15450849,-0.27950849,.38471044,-0.15450849,-0.23776412,.32725424,-0.29389262,-0.27950849,.38471044,-0.15450849,-0.14694631,.45225424,-0.15450849,-0.125,.38471044,-0.29389262,-0.14694631,.45225424,-0.15450849,0,.47552825,-0.15450849,0,.40450849,-0.29389262,0,.47552825,-0.15450849,.14694631,.45225424,-0.15450849,.125,.38471044,-0.29389262,.14694631,.45225424,-0.15450849,.27950849,.38471044,-0.15450849,.23776412,.32725424,-0.29389262,.27950849,.38471044,-0.15450849,.38471044,.27950849,-0.15450849,.32725424,.23776412,-0.29389262,.38471044,.27950849,-0.15450849,.45225424,.14694631,-0.15450849,.38471044,.125,-0.29389262,.45225424,.14694631,-0.15450849,.47552825,0,-0.15450849,.40450849,0,-0.29389262,.40450849,0,-0.29389262,.38471044,-0.125,-0.29389262,.27950849,-0.090817816,-0.40450849,.38471044,-0.125,-0.29389262,.32725424,-0.23776412,-0.29389262,.23776412,-0.17274575,-0.40450849,.32725424,-0.23776412,-0.29389262,.23776412,-0.32725424,-0.29389262,.17274575,-0.23776412,-0.40450849,.23776412,-0.32725424,-0.29389262,.125,-0.38471044,-0.29389262,.090817816,-0.27950849,-0.40450849,.125,-0.38471044,-0.29389262,0,-0.40450849,-0.29389262,0,-0.29389262,-0.40450849,0,-0.40450849,-0.29389262,-0.125,-0.38471044,-0.29389262,-0.090817816,-0.27950849,-0.40450849,-0.125,-0.38471044,-0.29389262,-0.23776412,-0.32725424,-0.29389262,-0.17274575,-0.23776412,-0.40450849,-0.23776412,-0.32725424,-0.29389262,-0.32725424,-0.23776412,-0.29389262,-0.23776412,-0.17274575,-0.40450849,-0.32725424,-0.23776412,-0.29389262,-0.38471044,-0.125,-0.29389262,-0.27950849,-0.090817816,-0.40450849,-0.38471044,-0.125,-0.29389262,-0.40450849,0,-0.29389262,-0.29389262,0,-0.40450849,-0.40450849,0,-0.29389262,-0.38471044,.125,-0.29389262,-0.27950849,.090817816,-0.40450849,-0.38471044,.125,-0.29389262,-0.32725424,.23776412,-0.29389262,-0.23776412,.17274575,-0.40450849,-0.32725424,.23776412,-0.29389262,-0.23776412,.32725424,-0.29389262,-0.17274575,.23776412,-0.40450849,-0.23776412,.32725424,-0.29389262,-0.125,.38471044,-0.29389262,-0.090817816,.27950849,-0.40450849,-0.125,.38471044,-0.29389262,0,.40450849,-0.29389262,0,.29389262,-0.40450849,0,.40450849,-0.29389262,.125,.38471044,-0.29389262,.090817816,.27950849,-0.40450849,.125,.38471044,-0.29389262,.23776412,.32725424,-0.29389262,.17274575,.23776412,-0.40450849,.23776412,.32725424,-0.29389262,.32725424,.23776412,-0.29389262,.23776412,.17274575,-0.40450849,.32725424,.23776412,-0.29389262,.38471044,.125,-0.29389262,.27950849,.090817816,-0.40450849,.38471044,.125,-0.29389262,.40450849,0,-0.29389262,.29389262,0,-0.40450849,.29389262,0,-0.40450849,.27950849,-0.090817816,-0.40450849,.14694631,-0.047745751,-0.47552825,.27950849,-0.090817816,-0.40450849,.23776412,-0.17274575,-0.40450849,.125,-0.090817816,-0.47552825,.23776412,-0.17274575,-0.40450849,.17274575,-0.23776412,-0.40450849,.090817816,-0.125,-0.47552825,.17274575,-0.23776412,-0.40450849,.090817816,-0.27950849,-0.40450849,.047745751,-0.14694631,-0.47552825,.090817816,-0.27950849,-0.40450849,0,-0.29389262,-0.40450849,0,-0.15450849,-0.47552825,0,-0.29389262,-0.40450849,-0.090817816,-0.27950849,-0.40450849,-0.047745751,-0.14694631,-0.47552825,-0.090817816,-0.27950849,-0.40450849,-0.17274575,-0.23776412,-0.40450849,-0.090817816,-0.125,-0.47552825,-0.17274575,-0.23776412,-0.40450849,-0.23776412,-0.17274575,-0.40450849,-0.125,-0.090817816,-0.47552825,-0.23776412,-0.17274575,-0.40450849,-0.27950849,-0.090817816,-0.40450849,-0.14694631,-0.047745751,-0.47552825,-0.27950849,-0.090817816,-0.40450849,-0.29389262,0,-0.40450849,-0.15450849,0,-0.47552825,-0.29389262,0,-0.40450849,-0.27950849,.090817816,-0.40450849,-0.14694631,.047745751,-0.47552825,-0.27950849,.090817816,-0.40450849,-0.23776412,.17274575,-0.40450849,-0.125,.090817816,-0.47552825,-0.23776412,.17274575,-0.40450849,-0.17274575,.23776412,-0.40450849,-0.090817816,.125,-0.47552825,-0.17274575,.23776412,-0.40450849,-0.090817816,.27950849,-0.40450849,-0.047745751,.14694631,-0.47552825,-0.090817816,.27950849,-0.40450849,0,.29389262,-0.40450849,0,.15450849,-0.47552825,0,.29389262,-0.40450849,.090817816,.27950849,-0.40450849,.047745751,.14694631,-0.47552825,.090817816,.27950849,-0.40450849,.17274575,.23776412,-0.40450849,.090817816,.125,-0.47552825,.17274575,.23776412,-0.40450849,.23776412,.17274575,-0.40450849,.125,.090817816,-0.47552825,.23776412,.17274575,-0.40450849,.27950849,.090817816,-0.40450849,.14694631,.047745751,-0.47552825,.27950849,.090817816,-0.40450849,.29389262,0,-0.40450849,.15450849,0,-0.47552825,.15450849,0,-0.47552825,.14694631,-0.047745751,-0.47552825,0,0,-0.5,.14694631,-0.047745751,-0.47552825,.125,-0.090817816,-0.47552825,0,0,-0.5,.125,-0.090817816,-0.47552825,.090817816,-0.125,-0.47552825,0,0,-0.5,.090817816,-0.125,-0.47552825,.047745751,-0.14694631,-0.47552825,0,0,-0.5,.047745751,-0.14694631,-0.47552825,0,-0.15450849,-0.47552825,0,0,-0.5,0,-0.15450849,-0.47552825,-0.047745751,-0.14694631,-0.47552825,0,0,-0.5,-0.047745751,-0.14694631,-0.47552825,-0.090817816,-0.125,-0.47552825,0,0,-0.5,-0.090817816,-0.125,-0.47552825,-0.125,-0.090817816,-0.47552825,0,0,-0.5,-0.125,-0.090817816,-0.47552825,-0.14694631,-0.047745751,-0.47552825,0,0,-0.5,-0.14694631,-0.047745751,-0.47552825,-0.15450849,0,-0.47552825,0,0,-0.5,-0.15450849,0,-0.47552825,-0.14694631,.047745751,-0.47552825,0,0,-0.5,-0.14694631,.047745751,-0.47552825,-0.125,.090817816,-0.47552825,0,0,-0.5,-0.125,.090817816,-0.47552825,-0.090817816,.125,-0.47552825,0,0,-0.5,-0.090817816,.125,-0.47552825,-0.047745751,.14694631,-0.47552825,0,0,-0.5,-0.047745751,.14694631,-0.47552825,0,.15450849,-0.47552825,0,0,-0.5,0,.15450849,-0.47552825,.047745751,.14694631,-0.47552825,0,0,-0.5,.047745751,.14694631,-0.47552825,.090817816,.125,-0.47552825,0,0,-0.5,.090817816,.125,-0.47552825,.125,.090817816,-0.47552825,0,0,-0.5,.125,.090817816,-0.47552825,.14694631,.047745751,-0.47552825,0,0,-0.5,.14694631,.047745751,-0.47552825,.15450849,0,-0.47552825,0,0,-0.5],n.NONE=0,n.LEFTTOP=1,n.LEFTDOWN=2,n.RIGHTTOP=3,n.RIGHTDOWN=4,n.CENTER=5,n}(e.SceneNode);e.AxisNode=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.SetSceneHeight=function(e){},t}(e.SceneNode);e.FPSNode=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n.isNeedUpdate=!0,n.topColor=new e.Color,n.bottomColor=new e.Color,n.ProArray=new Array(6),n.backColor=new Float32Array(24),n.backPnt=new Float32Array(18),n.points=new Float32Array(18),n.textCoords=new Float32Array(12),n.skyBoxPosition=null,n.cubeImagePath=[],n.gl=null,n.vertexBuffer=null,n.colorBuffer=null,n.texCoordsBuffer=null,n.imagePositionBuffer=null,n.skyBoxPositionBuffer=null,n.texture=null,n.cubeTexture=null,n.skyBoxTexture={},n.isUseSkyBox=!1,n.isUseColor=!0,n.Initial(),n}return __extends(n,t),n.prototype.FindVisiableObject=function(e){this.IsVisible()?e.SetBackGroundNode(this):e.SetBackGroundNode(null)},n.prototype.SetBackgroundSize=function(e,t){this.iWidth=e,this.iHeight=t},n.prototype.SetTopColor=function(e){this.topColor!==e&&(this.topColor=e,this.UpdateTopColor())},n.prototype.SetBottomColor=function(e){this.bottomColor!==e&&(this.bottomColor=e,this.UpdateBottomColor())},n.prototype.GetTopColor=function(e){e.r=this.backColor[0],e.g=this.backColor[1],e.b=this.backColor[2],e.a=this.backColor[3],e.r=this.backColor[12],e.g=this.backColor[13],e.b=this.backColor[14],e.a=this.backColor[15],e.r=this.backColor[20],e.g=this.backColor[21],e.b=this.backColor[22],e.a=this.backColor[23]},n.prototype.GetBottomColor=function(e){e.r=this.backColor[4],e.g=this.backColor[5],e.b=this.backColor[6],e.a=this.backColor[7],e.r=this.backColor[8],e.g=this.backColor[9],e.b=this.backColor[10],e.a=this.backColor[11],e.r=this.backColor[16],e.g=this.backColor[17],e.b=this.backColor[18],e.a=this.backColor[19]},n.prototype.GetVertexs=function(){},n.prototype.InitVertexs=function(){var t=1,n=1,r=new e.Vector3;this.points[0]=-1,this.points[1]=-1,this.points[2]=0,this.points[3]=1,this.points[4]=-1,this.points[5]=0,this.points[6]=-1,this.points[7]=1,this.points[8]=0,this.points[9]=-1,this.points[10]=1,this.points[11]=0,this.points[12]=1,this.points[13]=-1,this.points[14]=0,this.points[15]=1,this.points[16]=1,this.points[17]=0},n.prototype.GetTextureCoords=function(){},n.prototype.InitTextureCoords=function(){var t=new e.Rect(new e.Vector2(0,0),new e.Vector2(1,1)),n=t.min,r=t.max;this.textCoords[0]=0,this.textCoords[1]=1,this.textCoords[2]=1,this.textCoords[3]=1,this.textCoords[4]=0,this.textCoords[5]=0,this.textCoords[6]=0,this.textCoords[7]=0,this.textCoords[8]=1,this.textCoords[9]=1,this.textCoords[10]=1,this.textCoords[11]=0},n.prototype.InitSkyBoxVertexs=function(){var e=[-1,1,-1,-1,-1,-1,1,-1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,-1,1,-1,1,1,1,1,1,1,1,1,1,-1,1,-1,-1,-1,-1,1,-1,1,1,1,1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,1,-1,1,1,1,1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1];this.skyBoxPosition=new Float32Array(e)},n.prototype.SetImage=function(e){e.length>0&&(this.imagePath=e,this.isImageDirty=!0)},n.prototype.SetCubeImage=function(e){e.length>0&&(this.cubeImagePath=e,this.isCubeImageDirty=!0)},n.prototype.SetUseImage=function(e){this.isUseImage=e,e&&(this.isUseColor=!1,this.isUseSkyBox=!1)},n.prototype.IsUseImage=function(){return this.isUseImage},n.prototype.SetTexture=function(e){e&&this.texture!==e&&(this.texture&&(this.texture.ClearResource(),this.texture=null),this.texture=e,this.isImageDirty=!1)},n.prototype.GetTexture=function(t){if(this.isImageDirty||this.texture===null){this.texture&&(this.texture=null),this.texture=new e.Texture2D;var n=t.GetScene().GetResourceManager().GetOrCreateImage(this.imagePath);this.texture.AddImage(n),this.isImageDirty=!1}return this.texture},n.prototype.GetCubeTexture=function(t){if(this.isCubeImageDirty||this.cubeTexture===null){this.cubeTexture&&(this.cubeTexture=null),this.cubeTexture=new e.TextureCube;for(var n=0;n<this.cubeImagePath.length;n++){var r=t.GetScene().GetResourceManager().GetOrCreateImage(this.cubeImagePath[n]);this.cubeTexture.AddImage(r)}this.isCubeImageDirty=!1}return this.cubeTexture},n.prototype.AddSkyBoxTexture=function(e,t){this.skyBoxTexture[e]=t},n.prototype.GetSkyBoxTexture=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t]
;if(e.length===1){var n=e[0];return this.skyBoxTexture[n]}if(e.length===0){var r=Object.getOwnPropertyNames(this.skyBoxTexture);return this.skyBoxTexture[r[0]]}},n.prototype.IsUseSkyBox=function(){return this.isUseSkyBox},n.prototype.SetUseSkyBox=function(e){this.isUseSkyBox=e,e&&(this.isUseColor=!1,this.isUseImage=!1)},n.prototype.IsUseColor=function(){return this.isUseColor},n.prototype.SetUseColor=function(e){this.isUseColor=e,e&&(this.isUseImage=!1,this.isUseSkyBox=!1)},n.prototype.Initial=function(){this.iViewX=0,this.iViewY=0,this.iWidth=1600,this.iHeight=1e3,this.UpdateTopColor(),this.UpdateBottomColor(),this.ProArray=new Array(6),this.ProArray[0]=-1,this.ProArray[1]=1,this.ProArray[2]=-1,this.ProArray[3]=1,this.ProArray[4]=-1,this.ProArray[5]=1,this.fAspectRatio=1,this.backPnt[0]=-1,this.backPnt[1]=1,this.backPnt[2]=1,this.backPnt[3]=-1,this.backPnt[4]=-1,this.backPnt[5]=1,this.backPnt[6]=1,this.backPnt[7]=-1,this.backPnt[8]=1,this.backPnt[9]=-1,this.backPnt[10]=1,this.backPnt[11]=1,this.backPnt[12]=1,this.backPnt[13]=-1,this.backPnt[14]=1,this.backPnt[15]=1,this.backPnt[16]=1,this.backPnt[17]=1,this.isUseImage=!1,this.imagePath="",this.InitVertexs(),this.InitTextureCoords(),this.InitSkyBoxVertexs()},n.prototype.UpdateTopColor=function(){this.backColor[0]=this.topColor.r,this.backColor[1]=this.topColor.g,this.backColor[2]=this.topColor.b,this.backColor[3]=this.topColor.a,this.backColor[12]=this.topColor.r,this.backColor[13]=this.topColor.g,this.backColor[14]=this.topColor.b,this.backColor[15]=this.topColor.a,this.backColor[20]=this.topColor.r,this.backColor[21]=this.topColor.g,this.backColor[22]=this.topColor.b,this.backColor[23]=this.topColor.a,this.isNeedUpdate=!0},n.prototype.UpdateBottomColor=function(){this.backColor[4]=this.bottomColor.r,this.backColor[5]=this.bottomColor.g,this.backColor[6]=this.bottomColor.b,this.backColor[7]=this.bottomColor.a,this.backColor[8]=this.bottomColor.r,this.backColor[9]=this.bottomColor.g,this.backColor[10]=this.bottomColor.b,this.backColor[11]=this.bottomColor.a,this.backColor[16]=this.bottomColor.r,this.backColor[17]=this.bottomColor.g,this.backColor[18]=this.bottomColor.b,this.backColor[19]=this.bottomColor.a,this.isNeedUpdate=!0},n.prototype.SetCurrentGLContext=function(e){this.gl=e},n.prototype.GetPositionVBO=function(){return this.gl===null?null:this.vertexBuffer!==null?this.vertexBuffer:(this.vertexBuffer=new e.HardWareVertexBuffer(this.gl),this.vertexBuffer.Create(0,this.backPnt.length),this.vertexBuffer.SetDataRange(this.backPnt,0),this.vertexBuffer.WriteBuffer(),this.vertexBuffer)},n.prototype.GetColorVBO=function(){if(this.gl===null)return null;if(this.colorBuffer!==null&&!this.isNeedUpdate)return this.colorBuffer;if(this.isNeedUpdate)return this.colorBuffer||(this.colorBuffer=new e.HardWareVertexBuffer(this.gl)),this.colorBuffer.Create(0,this.backColor.length),this.colorBuffer.SetDataRange(this.backColor,0),this.colorBuffer.WriteBuffer(),this.isNeedUpdate=!1,this.colorBuffer},n.prototype.GetTexCoordsVBO=function(){return this.gl===null?null:this.texCoordsBuffer!==null?this.texCoordsBuffer:(this.texCoordsBuffer=new e.HardWareVertexBuffer(this.gl),this.texCoordsBuffer.Create(0,this.textCoords.length),this.texCoordsBuffer.SetDataRange(this.textCoords,0),this.texCoordsBuffer.WriteBuffer(),this.texCoordsBuffer)},n.prototype.GetBackImagePositionVBO=function(){return this.gl===null?null:this.imagePositionBuffer!==null?this.imagePositionBuffer:(this.imagePositionBuffer=new e.HardWareVertexBuffer(this.gl),this.imagePositionBuffer.Create(0,this.points.length),this.imagePositionBuffer.SetDataRange(this.points,0),this.imagePositionBuffer.WriteBuffer(),this.imagePositionBuffer)},n.prototype.GetSkyBoxVertexVBO=function(){return this.gl===null?null:this.skyBoxPositionBuffer!==null?this.skyBoxPositionBuffer:(this.skyBoxPositionBuffer=new e.HardWareVertexBuffer(this.gl),this.skyBoxPositionBuffer.Create(0,this.skyBoxPosition.length),this.skyBoxPositionBuffer.SetDataRange(this.skyBoxPosition,0),this.skyBoxPositionBuffer.WriteBuffer(),this.skyBoxPositionBuffer)},n}(e.SceneNode);e.BackgroundNode=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(e){function t(){var t=e.call(this)||this;return t.scene=null,t}return __extends(t,e),t.prototype.SetScene=function(e){this.scene=e},t}(e.GroupNode);e.MeasureGroup=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(e){function t(){return e.call(this)||this}return __extends(t,e),t}(e.GroupNode);e.NoteGroup=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(e){var n=t.call(this)||this;return n.updateDraggerModelBoundingbox=!0,n.scene=e,n.Initialize(),n.m_PointHandlers=new Array,n.m_svlTools={},n}return __extends(n,t),n.prototype.Initialize=function(){this.m_rotateCenterPoint=null,this.m_rotateCenterSize=1,this.m_TransformHandlerNode=null,this.m_RotateCylinderAxisDragger=null,this.m_ScaleAxisDragger=null},n.prototype.Clear=function(){this.RemoveAllTools(),this.RemoveRotateCenter(),this.DeleteAllChildren()},n.prototype.RemoveRotateCenter=function(){this.m_rotateCenterPoint&&(this.scene&&this.RemoveRotateCenterHandler(this.m_rotateCenterPoint,this.scene),this.m_rotateCenterPoint=null)},n.prototype.RemoveRotateCenterHandler=function(e,t){if(e!=null){var n=e.GetSceneNode().GetParent();n.DeleteChild(e.GetSceneNode())}},n.prototype.RemoveAllTools=function(){for(var e in this.m_svlTools)var t=this.m_svlTools[e];this.m_svlTools={}},n.prototype.GetType=function(){return e.HANDLER_GROUP_NODE},n.prototype.CreatePointHandler=function(t,n,r,i){var s=null;if(i==null)return s;s=new e.HandlerPoint(t,n),s.SetDrawType(r);var o=new e.ShapeNode;o.SetShape(s),s.SetSceneNode(o);var u="";return u=o.GetID().toString(),o.SetName(this.GetName()+"|"+u),this.AddChild(o),i.AddShapeIDToMap(s),s},n.prototype.CreateRotateCenterHandler=function(t,n,r){var i=0,s=null;if(r==null)return s;s=new e.HandlerPoint(t,n),s.SetDrawType(i);var o=new e.ShapeNode;return o.SetShape(s),this.AddChild(o),s},n.prototype.Traverse=function(e){t.prototype.Traverse.call(this,e)},n.prototype.HandleDragger=function(e){if(!e.getHandled()&&this.m_TransformHandlerNode&&this.m_TransformHandlerNode.IsVisible()){var t=this.m_TransformHandlerNode;t.handle(e)}if(!e.getHandled()&&this.m_RotateCylinderAxisDragger&&this.m_RotateCylinderAxisDragger.IsVisible()){var t=this.m_RotateCylinderAxisDragger;t.handle(e)}if(!e.getHandled()&&this.m_ScaleAxisDragger&&this.m_ScaleAxisDragger.IsVisible()){var t=this.m_ScaleAxisDragger;t.handle(e)}},n.prototype.GetDraggerTotalBoundingBox=function(t){var n=new e.BoundingBox;for(var r=0,i=t._draggerList;r<i.length;r++){var s=i[r],o=s._drawModel;if(!o)return this.updateDraggerModelBoundingbox=!0,new e.BoundingBox;var u=o.GetModelShape().GetWorldBoundingBox();u&&u.Defined()&&n.Merge(u)}return this.updateDraggerModelBoundingbox=!1,n},n.prototype.FindVisiableObject=function(n){var r=4.5;if(this.m_TransformHandlerNode&&this.m_TransformHandlerNode.IsVisible()){if(n.GetSceneBoxChanged()||this.m_TransformHandlerNode.GetNeedScale()||this.updateDraggerModelBoundingbox){var i=e.ShapeHelper.GetCommonSize(n.GetScene(),new e.Vector2(r,r));if(e.Parameters.Instance().dynamicSetDraggerPercentage){var s=this.GetDraggerTotalBoundingBox(this.m_TransformHandlerNode),o=s.max.Sub(s.min).Length(),u=this.m_TransformHandlerNode.getDraggerCallbacks()[0];if(u.m_draggerModels.length>0){var a=u.m_draggerModels[0],f=a.GetModelShape().GetWorldBoundingBox(),l=f.max.Sub(f.min).Length();if(i.x<l){var c=1+(e.Parameters.Instance().draggerPercentage*l-i.x)/l;i.x=i.x*c}}}this.m_TransformHandlerNode.SetOrigScale(new e.Vector3(i.x,i.x,i.x)),this.m_TransformHandlerNode.SetNeedScale(!1)}var h=this.m_TransformHandlerNode.GetWorldTransform().Multiply(new e.Vector3(0,0,0)).Clone(),p=e.Billboard.GetFitShowScale(n,h)/.4,d=new e.Vector3(p,p,p),v=this.m_TransformHandlerNode.GetOrigScale();v=v.Multiply(d).Clone(),this.m_TransformHandlerNode.SetScale(v)}if(this.m_RotateCylinderAxisDragger&&this.m_RotateCylinderAxisDragger.IsVisible()){if(n.GetSceneBoxChanged()||this.m_RotateCylinderAxisDragger.GetNeedScale()){var i=e.ShapeHelper.GetCommonSize(n.GetScene(),new e.Vector2(r,r));this.m_RotateCylinderAxisDragger.SetOrigScale(new e.Vector3(i.x,i.x,i.x)),this.m_RotateCylinderAxisDragger.SetNeedScale(!1)}var h=this.m_RotateCylinderAxisDragger.GetWorldTransform().Multiply(new e.Vector3(0,0,0)),p=e.Billboard.GetFitShowScale(n,h)/.4,d=new e.Vector3(p,p,p),v=this.m_RotateCylinderAxisDragger.GetOrigScale();v=v.Multiply(d).Clone(),this.m_RotateCylinderAxisDragger.SetScale(v)}if(this.m_ScaleAxisDragger&&this.m_ScaleAxisDragger.IsVisible()){if(n.GetSceneBoxChanged()||this.m_ScaleAxisDragger.GetNeedScale()){var i=e.ShapeHelper.GetCommonSize(n.GetScene(),new e.Vector2(r,r));this.m_ScaleAxisDragger.SetOrigScale(new e.Vector3(i.x,i.x,i.x)),this.m_ScaleAxisDragger.SetNeedScale(!1)}var h=this.m_ScaleAxisDragger.GetWorldTransform().Multiply(new e.Vector3(0,0,0)),p=e.Billboard.GetFitShowScale(n,h)/.4,d=new e.Vector3(p,p,p),v=this.m_ScaleAxisDragger.GetOrigScale();v=v.Multiply(d).Clone(),this.m_ScaleAxisDragger.SetScale(v)}var m=n.GetWorkingRenderQueueGroup(),g=n.GetDraggerRenderQueueGroup();n.SetWorkingRenderQueueGroup(g),t.prototype.FindVisiableObject.call(this,n),n.SetWorkingRenderQueueGroup(m);var y=!0;for(var b in this.m_svlTools)y=!1;if(!y)for(var w in this.m_svlTools){var a=this.m_svlTools[w];for(var E=0;E<a.length;E++)a[E].FindVisiableObject(n)}n.SetHandlerGroupNode(this)},n.prototype.RayPick=function(e){t.prototype.RayPick.call(this,e);var n=!0;for(var r in this.m_svlTools)n=!1;if(!n)for(var i in this.m_svlTools){var s=this.m_svlTools[i];for(var o=0;o<s.length;o++)s[o].IsVisible()&&s[o].RayPick(e)}},n.prototype.GetSVLTool=function(e){var t=null;return t=this.m_svlTools[e],t},n.prototype.AddSVLTool=function(t,r){if(this.m_svlTools[r]==null){this.m_svlTools[r]=[],this.m_svlTools[r].push(t);var i=new e.CallBackAction;i.SetActionFun(n.CacheNodeToMap),i.SetActionData(this.scene.nodesMap),t.Traverse(i)}else{this.m_svlTools[r].push(t);var i=new e.CallBackAction;i.SetActionFun(n.CacheNodeToMap),i.SetActionData(this.scene.nodesMap),t.Traverse(i)}},n.prototype.RemoveSVLTool=function(e){this.m_svlTools[e]!==null&&delete this.m_svlTools[e]},n.prototype.ShowSVLTool=function(e){if(this.m_svlTools[e]!==null){var t=this.m_svlTools[e];for(var n=0;n<t.length;n++)t[n].SetVisible(!0)}},n.prototype.HideAllSVLTools=function(){for(var e in this.m_svlTools){var t=this.m_svlTools[e];for(var n=0;n<t.length;n++)t[n].SetVisible(!1)}},n.prototype.HideSVLTool=function(e){if(this.m_svlTools[e]!==null){var t=this.m_svlTools[e];for(var n=0;n<t.length;n++)t[n].SetVisible(!1)}},n.prototype.SetRotateCenterVisible=function(e){this.m_rotateCenterPoint&&this.m_rotateCenterPoint.SetVisible(e)},n.prototype.GetRotateCenterVisible=function(){var e=!1;return this.m_rotateCenterPoint&&(e=this.m_rotateCenterPoint.IsVisible()),e},n.prototype.UpdateRotateCenterPos=function(e){this.m_rotateCenterPos.Equals(e)||(this.m_rotateCenterPos=e,this.RemoveRotateCenter(),this.m_rotateCenterPoint=this.CreateRotateCenterHandler(this.m_rotateCenterPos,this.m_rotateCenterSize,this.scene))},n.prototype.UpdateRoteateCenterSize=function(e){this.m_rotateCenterSize=e,this.RemoveRotateCenter(),this.m_rotateCenterPoint=this.CreatePointHandler(this.m_rotateCenterPos,this.m_rotateCenterSize,2,this.scene)},n.prototype.GetRotateCenter=function(){return this.m_rotateCenterPoint},n.prototype.GetTransformHandler=function(){return this.m_TransformHandlerNode==null&&(this.m_TransformHandlerNode=new e.TranslateAxisDragger,this.m_TransformHandlerNode.setupDefaultGeometry(),this.AddChild(this.m_TransformHandlerNode)),this.m_TransformHandlerNode},n.CacheNodeToMap=function(e,t){var n=e;e[t.GetName()]==null&&(n[t.GetName()]=t)},n.prototype.GetHandlerSize=function(t){var n=1,r=1;if(t){var i=t.GetCamera(),s=i.GetAspectRatio();r=i.GetOrthoSize().y,n=r*s,n/=40}return new e.Vector2(n,n)},n.prototype.GetScaleAxisDragger=function(){return this.m_ScaleAxisDragger==null&&(this.m_ScaleAxisDragger=new e.ScaleAxisDragger,this.m_ScaleAxisDragger.setupDefaultGeometry(),this.AddChild(this.m_ScaleAxisDragger)),this.m_ScaleAxisDragger},n.prototype.GetRotateCylinderAxisDragger=function(){return this.m_RotateCylinderAxisDragger==null&&(this.m_RotateCylinderAxisDragger=new e.RotateCylinderAxisDragger,this.m_RotateCylinderAxisDragger.setupDefaultGeometry(),this.AddChild(this.m_RotateCylinderAxisDragger)),this.m_RotateCylinderAxisDragger},n}(e.GroupNode);e.HandlerGroup=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var e=t.call(this)||this;return e.shapeNode=null,e}return __extends(n,t),n.prototype.GetType=function(){return e.MODEL_NODE},n.prototype.Traverse=function(e){if(e.IsFinish())return;e.Apply(this);var t=this.shapeNode;t!==null&&t.Traverse(e);for(var n=0,r=this.pChildrenList;n<r.length;n++){var i=r[n];i.Traverse(e)}},n.prototype.RayPick=function(e){var t=this.shapeNode;t!==null&&t.RayPick(e);for(var n=0,r=this.pChildrenList;n<r.length;n++){var i=r[n];i.RayPick(e)}},n.prototype.FindVisiableObject=function(e){var t=this.shapeNode;t!==null&&t.FindVisiableObject(e);for(var n=0,r=this.pChildrenList;n<r.length;n++){var i=r[n];i.FindVisiableObject(e)}},n.prototype.ComputeBox=function(){if(!this.bdBox.Defined()){var t=new e.BoundingBox,n=this.shapeNode;n!=null&&t.Merge(n.GetBoundingBox());for(var r=0;r<this.pChildrenList.length;r++){var i=this.pChildrenList[r].GetBoundingBox();i.Defined()&&t.Merge(i.Transformed(this.pChildrenList[r].GetLocalTransform()))}t.Defined()&&(this.bdBox=t)}},n.prototype.OnMarkedDirty=function(){var e=this.shapeNode;e!==null&&e!==undefined&&e.MarkDirty(),t.prototype.OnMarkedDirty.call(this)},n.prototype.GetShapeNode=function(){return this.shapeNode},n.prototype.SetShapeNode=function(e){e.SetParent(this),this.shapeNode=e},n.prototype.UpdateName=function(){if(this.shapeNode){var n=this.shapeNode.GetShape();if(n&&n instanceof e.Model){var r=this.GetParent(),i=n,s=i.GetPlcId().toString(16),o=r.GetName()+"|"+s;this.SetName(o),this.shapeNode.UpdateName()}}return t.prototype.UpdateName.call(this),!0},n}(e.GroupNode);e.ModelNode=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var e=t.call(this)||this;return e.shape=null,e}return __extends(n,t),n.prototype.SetShape=function(e){this.shape=e,this.shape.SetSceneNode(this)},n.prototype.GetType=function(){return e.SHAPE_NODE},n.prototype.GetShape=function(){return this.shape},n.prototype.Traverse=function(e){if(e.IsFinish())return;t.prototype.Traverse.call(this,e),this.shape!==null&&this.shape.Traverse(e)},n.prototype.RayPick=function(t){if(this.shape!==null)if(t.IsPickAll())t.FramePick(this.shape);else if(!this.shape.AllowExculding()||t.GetData().GetCameraRay().HitDistance(this.GetWorldBoundingBox())!==e.INFINITY)t.UpdataModelRay(this.GetWorldTransform()),t.RayPick(this.shape)},n.prototype.FindVisiableObject=function(t){if(this.shape===null||!this.shape.IsVisible())return;if(this.shape!=null&&!this.shape.AllowExculding()){t.SetWorldMatrix(this.GetWorldTransform()),t.SetGLWorldMatrix(this.GetGLWorldTransform()),this.shape.FindVisiableObject(t);return}var n=t.GetCullerHelper().IsLittleModel(this.GetWorldBoundingBox(),t.GetCamera());if(n===2)return;var r=t.GetCullerHelper().InViewPort(this.GetWorldBoundingBox(),t.GetCamera());r!==e.OUTSIDE&&this.shape!=null&&(t.SetWorldMatrix(this.GetWorldTransform()),t.SetGLWorldMatrix(this.GetGLWorldTransform()),n==0&&this.shape.FindVisiableObject(t))},n.prototype.ComputeBox=function(){if(!this.bdBox.Defined()){var e=this.GetShape();if(e!==null){var t=e.GetBoundingBox();t.Defined()&&this.bdBox.copyFrom(t)}}},n.prototype.OnMarkedDirty=function(){if(this.shape){this.shape.GetBoundingBox().Clear();if(this.shape.GetType()==e.ShapeType.SHAPE_MODEL){var t=this.shape;t.SetOrigPlcMatrix(this.GetWorldTransform())}}},n.prototype.UpdateName=function(){var e=this.GetParent().GetName();return this.SetName(e+"|"+"ShapeModel"),!0},n}(e.SceneNode);e.ShapeNode=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){}return t.FRONT_MVMATRIX=function(){return t._FRONT_MVMATRIX==null&&(t._FRONT_MVMATRIX=new e.ControlInfo(1,0,0,0)),t._FRONT_MVMATRIX},t.BACK_MVMATRIX=function(){return t._BACK_MVMATRIX==null&&(t._BACK_MVMATRIX=new e.ControlInfo(0,0,1,0)),t._BACK_MVMATRIX},t.LEFT_MVMATRIX=function(){return t._LEFT_MVMATRIX==null&&(t._LEFT_MVMATRIX=new e.ControlInfo(.70710677,0,-0.70710677,0)),t._LEFT_MVMATRIX},t.RIGHT_MVMATRIX=function(){return t._RIGHT_MVMATRIX==null&&(t._RIGHT_MVMATRIX=new e.ControlInfo(.70710677,0,.70710677,0)),t._RIGHT_MVMATRIX},t.TOP_MVMATRIX=function(){return t._TOP_MVMATRIX==null&&(t._TOP_MVMATRIX=new e.ControlInfo(.70710677,-0.70710677,0,0)),t._TOP_MVMATRIX},t.BOTTOMVMATRIX=function(){return t._BOTTOMVMATRIX==null&&(t._BOTTOMVMATRIX=new e.ControlInfo(.70710677,.70710677,0,0)),t._BOTTOMVMATRIX},t.ISOMETRIC_MVMATRIX=function(){return t._ISOMETRIC_MVMATRIX==null&&(t._ISOMETRIC_MVMATRIX=new e.ControlInfo(.88047838,.36470398,-0.27984396,-0.11591448)),t._ISOMETRIC_MVMATRIX},t.DEFAULT_MVMATRIX=function(){return t._DEFAULT_MVMATRIX==null&&(t._DEFAULT_MVMATRIX=new e.ControlInfo(.88047838,.36470398,-0.27984396,-0.11591448)),t._DEFAULT_MVMATRIX},t.FRONT=0,t.BACK=1,t.LEFT=2,t.RIGHT=3,t.TOP=4,t.BOTTOM=5,t.ISOMETRIC=6,t.DEFAULT=7,t.CUSTOM=9,t.DISTRI=0,t}();e.PerspectiveData=t})(M3D||(M3D={}));var M3D;(function(e){var t=30,n=500,r=function(){function r(){this.Initialize()}return r.prototype.Initialize=function(){this.SetAnimationState(!1),this.animationTo=new e.ControlInfo,this.animationmvMatrix=new e.ControlInfo,this.animationdistimvMatrix=new e.ControlInfo,this.newAnimationTo=new e.ControlInfo,this.slerpCount=60,this.midRotation=[],this.midTran=[],this.midScale=[];for(var n=0;n<this.slerpCount;++n)this.midRotation.push(new e.Quaternion),this.midTran.push(new e.Vector3),this.midScale.push(0);this.timer=new e.Timer,this.pMatrix=new Float32Array(16),this.animationKeepMsecond=t},r.prototype.SetAnimationState=function(e){this.isAnimation=e},r.GetInstance=function(){return r.Instance==null&&(r.Instance=new r),r.Instance},r.prototype.Show=function(e,t,n,r,i){n===void 0&&(n=!0),r===void 0&&(r=!1),i===void 0&&(i=!1),this.Apply(e,t,n,r,i)},r.prototype.Apply=function(e,t,n,r,i){n===void 0&&(n=!0),r===void 0&&(r=!1),i===void 0&&(i=!1),this.pView=e,this.pSelectedNodes=this.pView.GetWorkNodes(),this.iViewType=t,this.bAllowRotate=n,this.bAllowScale=r,this.bAllowTran=i,this.HandleStandardView()},r.prototype.HandleStandardView=function(){switch(this.iViewType){case e.PerspectiveData.FRONT:this.CreatePerspectiveAnimation(e.PerspectiveData.FRONT_MVMATRIX());break;case e.PerspectiveData.BACK:this.CreatePerspectiveAnimation(e.PerspectiveData.BACK_MVMATRIX());break;case e.PerspectiveData.LEFT:this.CreatePerspectiveAnimation(e.PerspectiveData.LEFT_MVMATRIX());break;case e.PerspectiveData.RIGHT:this.CreatePerspectiveAnimation(e.PerspectiveData.RIGHT_MVMATRIX());break;case e.PerspectiveData.TOP:this.CreatePerspectiveAnimation(e.PerspectiveData.TOP_MVMATRIX());break;case e.PerspectiveData.BOTTOM:this.CreatePerspectiveAnimation(e.PerspectiveData.BOTTOMVMATRIX());break;case e.PerspectiveData.ISOMETRIC:this.CreatePerspectiveAnimation(e.PerspectiveData.ISOMETRIC_MVMATRIX());break;case e.PerspectiveData.DEFAULT:this.CreatePerspectiveAnimation(e.PerspectiveData.DEFAULT_MVMATRIX());break;default:}},r.prototype.GetAnimationState=function(){return this.timer.IsStart()},r.prototype.CreatePerspectiveAnimation=function(t){this.GetAnimationState()&&this.FinishAnimation(),this.currentAniFrame=0,this.animationTo=t,e.Trackball.ISMOVING=!0,this.pSelectedNodes.GetMVMatrix(this.animationmvMatrix,this.animationdistimvMatrix),this.animationdistimvMatrix.rotation=t.rotation,this.StartAnimation(),e.Trackball.ISMOVING=!1},r.prototype.ExecuteCommonCameraAnimation=function(t,n,r,i,s,o,u){this.GetAnimationState()&&this.FinishAnimation(),this.currentAniFrame=0,this.bAllowRotate=o,this.bAllowScale=u,this.bAllowTran=s;var a=t.GetSceneManager().GetCamera();this.animationmvMatrix.moveVector=a.GetWorldPosition().Clone(),this.animationmvMatrix.rotation=a.GetRotation().Clone(),this.animationmvMatrix.scaleFactor=a.GetZoom(),this.newAnimationTo.moveVector=n.Clone(),this.newAnimationTo.rotation=r.Clone(),this.newAnimationTo.scaleFactor=i.x,e.Trackball.ISMOVING=!0,this.StartCommonAnimation(),e.Trackball.ISMOVING=!1},r.prototype.StartAnimation=function(){var t=this.animationmvMatrix,n=this.animationTo;return e.M3DTOOLS.RotationSlerp(t.rotation,n.rotation,this.slerpCount,this.midRotation),e.M3DTOOLS.FloatSlerp(t.scaleFactor,n.scaleFactor,this.slerpCount,this.midScale),e.M3DTOOLS.VecSlerp(t.moveVector,n.moveVector,this.slerpCount,this.midTran),this.starttime=(new Date).getTime(),this.timer.SetTimer(this.timerTask,this,this.animationKeepMsecond),this.timer.StartTimer(),!0},r.prototype.StartCommonAnimation=function(){var t=this.animationmvMatrix,n=this.newAnimationTo;return e.M3DTOOLS.RotationSlerp(t.rotation,n.rotation,this.slerpCount,this.midRotation),e.M3DTOOLS.FloatSlerp(t.scaleFactor,n.scaleFactor,this.slerpCount,this.midScale),e.M3DTOOLS.VecSlerp(t.moveVector,n.moveVector,this.slerpCount,this.midTran),this.starttime=(new Date).getTime(),this.timer.SetTimer(this.commonTimerTask,this,this.animationKeepMsecond),this.timer.StartTimer(),!0},r.prototype.timerTask=function(t){var r=t,i=r.bAllowRotate,s=r.bAllowTran,o=r.bAllowScale,u=r.midRotation,a=r.midScale,f=r.midTran,l=(new Date).getTime(),c=Math.round(r.slerpCount*(l-r.starttime)/n),h=c;if(l-r.starttime>n||e.Parameters.Instance().ignoreRestoreAnimation===!0)h=r.slerpCount-1;i&&u[h]&&r.ApplyRotationToSelectedNode(u[h]),o&&a[h]&&r.ApplyScaleToSelectedNode(a[h]),s&&f[h]&&r.ApplyMovementToSelectedNode(f[h]),r.pView.OnDraw(),h>=r.slerpCount-1&&r.FinishAnimation()},r.prototype.commonTimerTask=function(t){var r=t,i=r.bAllowRotate,s=r.bAllowTran,o=r.bAllowScale,u=r.midRotation,a=r.midScale,f=r.midTran,l=(new Date).getTime(),c=Math.round(r.slerpCount*(l-r.starttime)/n),h=c;if(l-r.starttime>n||e.Parameters.Instance().ignoreRestoreAnimation===!0)h=r.slerpCount-1;var p=r.pView,d=p.GetSceneManager().GetCamera();i&&u[h]&&d.SetRotation(u[h].Clone()),o&&a[h]&&d.SetZoom(a[h]),s&&f[h]&&d.SetWorldPosition(f[h].Clone()),r.pView.OnDraw(),h>=r.slerpCount-1&&r.FinishAnimation()},r.prototype.FinishAnimation=function(){return this.timer.IsStart()&&this.timer.StopTimer(),this.currentAniFrame=0,this.animationKeepMsecond=t,!0},r.prototype.ApplyRotationToSelectedNode=function(e){this.pSelectedNodes.SetRotationAroundCenter(e)},r.prototype.ApplyMovementToSelectedNode=function(e){this.pSelectedNodes.SetPosition(e)},r.prototype.ApplyScaleToSelectedNode=function(e){this.pSelectedNodes.SetZoom(e)},r}();e.PerspectiveOperator=r})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){}return e.X=1,e.Y=2,e.Z=3,e}();e.Direction=t;var n=function(){function n(){this.direction=-1,this.fPercentage=-1,this.isShowClipPlane=!1,this.isShowCutPlane=!1,this.pView=null,this.pSceneManager=null,this.pModelNode=null,this.pCurSectionPlane=null,this.model=null}return n.GetSectionInfo=function(e,n,r,i){var s=e.GetSceneManager(),o=s.GetSceneBox(),u=0,a=0,f=0,l=o.min.Clone(),c=0,h=0,p=0,d=0,v=0,m=0;switch(n){case-t.X:u=o.GetXLength()*r,a=l.x+u,p=-1,m=a;break;case t.X:u=o.GetXLength()*r,a=l.x+u,p=1,m=-a;break;case-t.Y:u=o.GetYLength()*r,a=l.y+u,d=-1,m=a;break;case t.Y:u=o.GetYLength()*r,a=l.y+u,d=1,m=-a;break;case-t.Z:u=o.GetZLength()*r,a=l.z+u,v=-1,m=a;break;case t.Z:u=o.GetZLength()*r,a=l.z+u,v=1,m=-a}i.SetPlaneParam(p,d,v,m)},n.Show=function(e,t,r,i,s){n.Instance===null&&(n.Instance=new n),n.Instance.Init(e,t,r,i,s);var o=e.GetSceneManager();n.Instance.Handle()},n.Clear=function(e){var t=n.Instance,r=e.GetSceneManager();n.Instance!==null&&r.GetSection().ClearPlanes(),r.GetRenderManager().RequestRedraw()},n.prototype.Init=function(t,n,r,i,s){this.pView=t;var o=t.GetSceneManager();this.model=o.GetModel(),this.pSceneManager=o,this.direction=n,this.fPercentage=r,Math.abs(r-1)<.01&&(this.fPercentage=1.01),Math.abs(r)<.01&&(this.fPercentage=-0.01),this.isShowClipPlane=i,this.isShowCutPlane=s;var u=1001;this.pCurSectionPlane===null&&(this.pCurSectionPlane=new e.SectionPlane),this.pCurSectionPlane.SetID(u)},n.prototype.Handle=function(){this.CreateSectionPlane(this.model,this.direction,this.fPercentage,this.pCurSectionPlane),this.pView.GetSceneManager().GetSection().AddPlane(this.pCurSectionPlane),this.pView.GetSceneManager().GetRenderManager().RequestRedraw()},n.prototype.RequestDraw=function(){},n.prototype.CreateSectionPlane=function(e,t,r,i){n.GetSectionInfo(this.pView,t,r,i),i.SetEnable(!0),i.SetShowPlaneRect(this.isShowClipPlane),i.SetShowCutPlane(this.isShowCutPlane)},n.prototype.GetModel=function(){return this.model},n.Instance=null,n}();e.SectionOperator=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){this.workNodesMap=new e.StringDictionary}return t.prototype.AddNode=function(e,t){var n=this.workNodesMap.get(e);n!==undefined?n=t:this.workNodesMap.add(e,t)},t.prototype.RemoveNode=function(e){var t=this.workNodesMap.get(e);t!==undefined&&this.workNodesMap.remove(e)},t.prototype.Size=function(){return this.workNodesMap.count},t.prototype.SetPosition=function(t){var n=this.workNodesMap.get(e.MAINCAMERA);if(n!==undefined){var r=n;r.SetWorldPosition(t)}},t.prototype.SetZoom=function(t){var n=this.workNodesMap.get(e.MAINCAMERA);if(n!==undefined){var r=n;r.SetZoom(1/t)}},t.prototype.GetMVMatrix=function(t,n){var r=this.workNodesMap.get(e.MAINCAMERA);if(r!==undefined){var i=r;t.rotation=i.GetRotation(),t.moveVector=i.GetPosition(),t.scaleFactor=i.GetZoom(),n.rotation=i.GetOldRotation(),n.moveVector=i.GetOldPosition(),n.scaleFactor=i.GetZoom()}},t.prototype.SetRotationAroundCenter=function(t){var n=this.workNodesMap.get(e.AXIS);n!==undefined&&n.SetRotation(t.Inverse()),n=this.workNodesMap.get(e.MAINCAMERA);if(n!==undefined){var r=n,i=t.Inverse();i=r.GetRotation().Inverse().MultiplyED(i),r.RotateAroundCenter(i,e.SceneNode.TS_WORLD)}},t.prototype.SetRotation=function(t){var n=this.workNodesMap.get(e.AXIS);n!==undefined&&n.SetRotation(t.Inverse()),n=this.workNodesMap.get(e.MAINCAMERA);if(n!==undefined){var r=n;r.SetRotation(t)}},t.prototype.GetRotaton=function(t){var n=this.workNodesMap.get(e.MAINCAMERA);if(n!==undefined){var r=n;t=r.GetRotation()}},t.prototype.RotateAroundCenter=function(t){var n=t,r=this.workNodesMap.get(e.MAINCAMERA);if(r!==undefined){var i=r;i.RotateAroundCenter(n,e.SceneNode.TS_WORLD)}r=this.workNodesMap.get(e.AXIS),r!==undefined&&r.Rotate(n)},t.prototype.Rotate=function(t){var n=t,r=this.workNodesMap.get(e.MAINCAMERA),i=1;if(r!==undefined){var s=r;s.Rotate(n,e.SceneNode.TS_WORLD)}r=this.workNodesMap.get(e.AXIS),r!==undefined&&r.Rotate(n)},t.prototype.Translate=function(e,t){},t.prototype.Zoom=function(e){},t}();e.WorkNodes=t})(M3D||(M3D={}));var M3D;(function(e){var t;(function(e){e[e.all=0]="all",e[e.move=1]="move",e[e.zoom=2]="zoom",e[e.translate=3]="translate",e[e.movezoom=4]="movezoom",e[e.movetranslate=5]="movetranslate",e[e.zoomtranslate=6]="zoomtranslate"})(t=e.TwoOperateType||(e.TwoOperateType={}));var n=function(n){function r(){var r=n.call(this)||this;return r.twoOperateType=t.all,r.touchHandlerType=e.TouchHandlerType.HANDLER_COMMON,r}return __extends(r,n),r.prototype.OnUpDataTouchIntent=function(){var n=this.trackBall.mvMatrix.rotation.Inverse(),r=this.sceneManager.GetCamera();r.RotateAroundCenter(n,e.SceneNode.TS_WORLD),(this.twoOperateType===t.all||this.twoOperateType===t.move||this.twoOperateType===t.movezoom||this.twoOperateType===t.movetranslate)&&r.Translate(this.trackBall.mvMatrix.moveVector.Multiply(-1),e.SceneNode.TS_LOCAL),(this.twoOperateType===t.all||this.twoOperateType===t.zoom||this.twoOperateType===t.movezoom||this.twoOperateType===t.zoomtranslate)&&r.ZoomView(1/this.trackBall.mvMatrix.scaleFactor)},r.prototype.UpdateCamera=function(){n.prototype.InitCamera.call(this)},r.prototype.InitCamera=function(){n.prototype.InitCamera.call(this),this.GetRestoreCamera()&&this.pView&&e.PerspectiveOperator.GetInstance().Show(this.pView,this.GetDefaultView(),!0,!1,!1)},r.prototype.OptimizeCamera=function(){},r.prototype.OnTouchUp=function(t,n){if(e.Parameters.Instance().IsConRotate)if(1==n)if(this.trackBall.angle>3){var r=this.trackBall.angle;r>0?r=Math.min(r,15):r=Math.max(r,-15),Math.abs(this.trackBall.angle)>14&&this.trackBall.mvMatrix.rotation.FromAngleAxis(r,this.trackBall.axis),this.StartKeepState()}else this.EndKeepState();else 2==n?this.trackBall.TwoPointsUp(t,n):3==n;else 1===n?(this.EndKeepState(),this.trackBall.OnePointUp(t,n)):2===n?this.trackBall.TwoPointsUp(t,n):3===n,this.trackBall.Reset();this.UpdateRenderQuality(!1),this.UpDataTouchIntent()},r.prototype.OnTouchMove=function(e,n,r){this.OptimizeCamera(),1===r?e===1?this.trackBall.OnePointRotate(n,r):e===2?this.trackBall.OnePointsMove(n,r):e===3&&this.trackBall.OnePointsScale(n,r):2===r?(e===1?this.twoOperateType=t.translate:e===2?this.twoOperateType=t.move:e===3?this.twoOperateType=t.zoom:e===0?this.twoOperateType=t.all:e===4?this.twoOperateType=t.movezoom:e===6?this.twoOperateType=t.movetranslate:e===7&&(this.twoOperateType=t.zoomtranslate),this.trackBall.TwoPointsMove(n,r),(this.twoOperateType===t.all||this.twoOperateType===t.translate||this.twoOperateType===t.movetranslate||this.twoOperateType===t.zoomtranslate)&&this.TwoFingersRotate(n,r),this.PriPointTwo1.x=n[0],this.PriPointTwo1.y=n[1],this.PriPointTwo2.x=n[2],this.PriPointTwo2.y=n[3],this.twoOperateType=t.all):3===r,this.StateChanged()&&this.UpDataTouchIntent(),this.UpdateRenderQuality(!0)},r.prototype.OnTouchDown=function(e,t){this.trackBall.Reset(),1===t?this.trackBall.OnePointStart(e,t):2===t?(this.PriPointTwo1.x=e[0],this.PriPointTwo1.y=e[1],this.PriPointTwo2.x=e[2],this.PriPointTwo2.y=e[3],this.trackBall.TwoPointsStart(e,t)):3===t},r.prototype.ResetViewCamera=function(){if(this.sceneManager!=null){var t=this.sceneManager.GetCamera(),n=t.GetWorldPosition().Clone(),r=this.sceneManager.GetSceneBox(),i=t.GetViewPort(),s=i.rect.Height(),o=i.rect.Width();this.sceneManager.GetRenderManager().WindowSizeChanged(o,s);var u=r.Length(),a=r.Center(),f=n.Sub(a).Normalized(),l=a.Add(f.Multiply(r.Length()*e.CAMERA_POSFACTOR));t.SetWorldPosition(l),u=this.sceneManager.GetDefaultFocusLength(),t.SetNearClip(u*e.NEAR_CLIP_PLANE_FACTOR),t.SetFarClip(u*e.FAR_CLIP_PLANE_FACTOR),t.SetZoom(this.sceneManager.GetDefaultZoom()),t.SetInitRotateCenter(r.Center()),t.LookAt(r.Center(),new e.Vector3(0,1,0),e.SceneNode.TS_WORLD),this.trackBall.SetRotateSpeed(2);var c=t.GetViewPort().rect,h=c.Width()>c.Height()?c.Height():c.Width();this.trackBall.SetTrackWindow(h,h)}},r}(e.TouchHandler);e.CommonTouchHandler=n})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n.PirDistance=0,n.CurrDistance=0,n.cachePriPoint=e.Vector3.ZERO().Clone(),n.cacheCurPointNear=e.Vector3.ZERO().Clone(),n.cacheCurPointFar=e.Vector3.ZERO().Clone(),n.cameraToCenterDis=0,n.movSpeed=0,n.oldDirectionVector=e.Vector3.UP().Clone(),n.insideBoundingBox=!1,n.speedControlValue=1,n.isUpDirection=!1,n.transMat=e.Matrix4.IDENTITY().Clone(),n.lastDepthPos=e.Vector3.ZERO().Clone(),n.needMoveValue=e.Vector3.ZERO().Clone(),n.useOribit=!1,n.oribitControlOffset=e.Vector3.ZERO().Clone(),n.isOribteRotateState=!1,n.deltaPhi=1,n.insectPoint=e.Vector3.ZERO().Clone(),n.phi=0,n.virtualKeyTarget=e.Vector3.ZERO().Clone(),n.cameraToCenterDis=1e-4,n.movSpeed=1e-5,n.firstPersionSpeed=1,n.changeDisOnRotate=!0,n.modelRotation=e.Quaternion.IDENTITY().Clone(),n.insideBoundingBox=!1,n.isUpDirection=!1,n.speedControlValue=1,n.standardSpeed=1,n.isOribteRotateState=!0,n.trackBall.SetRotateSpeed(.3),n.useOribit=!0,n.phi=0,n.virtualKeyTarget=e.Vector3.ZERO().Clone(),n}return __extends(n,t),n.prototype.UpdateCamera=function(){t.prototype.InitCamera.call(this)},n.prototype.InitCamera=function(){t.prototype.InitCamera.call(this),this.GetRestoreCamera()&&this.pView&&(e.PerspectiveOperator.GetInstance().Show(this.pView,e.PerspectiveData.FRONT,!0,!1,!1),this.SetUpDirection(this.upDirection,this.pView))},n.prototype.InitModelViewCamera=function(){if(!this.sceneManager)return;var t=this.sceneManager,n=t.GetCamera();n.ReSet(),n.SetOrthographic(!1);var r=t.GetSceneBox(),i=n.GetViewPort(),s=i.GetRect().Height(),o=i.GetRect().Width();this.sceneManager.GetRenderManager().WindowSizeChanged(o,s);var u=r.Length(),a=r.Center();n.IsOrthographic()?a.z+=r.Length()*8.5:a.z+=r.Length()*1.5,n.SetWorldPosition(a),n.SetNearClip(u*.005),n.SetFarClip(u*2.5);var f=e.Parameters.Instance().DefaultZoomFactor;f=f*s/o,s>o&&(f=f*.5*(o*1/s)),n.SetZoom(f),n.SetInitRotateCenter(r.Center()),n.LookAt(r.Center(),e.Vector3.UP().Clone(),e.Camera.TS_WORLD)},n.prototype.SetFirstPersionParameter=
function(e){this.firstPersionSpeed=e},n.prototype.GetFirstPersionParameter=function(){return this.firstPersionSpeed},n.prototype.OptimizeCamera=function(){if(!this.sceneManager)return;if(this.controlLockXY||this.oribitMode)this.insideBoundingBox?this.useOribit=!1:this.useOribit=!0;var t=this.sceneManager,n=t.GetCamera(),r=t.GetSceneBox();this.cameraToCenterDis=n.GetWorldPosition().Sub(r.Center()).Length();var i=r.Length();r.IsInside(n.GetWorldPosition())==e.OUTSIDE?(this.useOribit||n.SetRotateCenter(r.Center()),this.movSpeed=Math.min(this.cameraToCenterDis*.5*this.firstPersionSpeed,r.Length()/100),this.trackBall.SetRotateSpeed(.5),this.insideBoundingBox=!1,n.SetNearClip(e.Min(5,i*.1)),n.SetFarClip(i*30.5)):(this.useOribit||n.SetRotateCenter(n.GetPosition()),n.SetNearClip(e.Min(1,i*.05)),n.SetFarClip(i*2.5),this.trackBall.SetRotateSpeed(.5),this.insideBoundingBox=!0)},n.prototype.RotateAroundAxis=function(){var t=this.sceneManager.GetCamera(),n=t.GetWorldPosition(),r=n.Sub(this.oribitControlTarget),i=this.trackBall.mvMatrix.rotation,s=i.EulerAngles(),o=s,u=new e.Quaternion(-s.y*1.5,e.Vector3.UP().Clone()),a=e.Matrix4.IDENTITY().Clone(),f=e.Matrix4.IDENTITY().Clone(),l=e.Matrix4.IDENTITY().Clone(),c=e.Matrix4.IDENTITY().Clone(),h=e.Matrix4.IDENTITY().Clone();a.MultiTranslate(this.oribitControlTarget.Multiply(-1)),f.MultiRotatiton(u),l.MultiTranslate(this.oribitControlTarget),h=l.Multiply(f).Multiply(a);var p=t.GetView().ToMatrix4(),d=p.Multiply(h).Multiply(p.Inverse());t.Translate(d.Translation(),e.Camera.TS_LOCAL),t.Rotate(d.Rotation()),t.ZoomView(this.trackBall.mvMatrix.scaleFactor)},n.prototype.FreeViewRotate=function(){this.useOribit=!1;var t=this.trackBall.mvMatrix.rotation.Inverse(),n=this.sceneManager.GetCamera();n.RotateAroundCenter(t,e.Camera.TS_WORLD),n.Translate(this.trackBall.mvMatrix.moveVector,e.Camera.TS_LOCAL),n.ZoomView(this.trackBall.mvMatrix.scaleFactor)},n.prototype.OnUpDataTouchIntent=function(){t.prototype.OnUpDataTouchIntent.call(this)},n.prototype.TwoPointsUp=function(e,t){this.Reset()},n.prototype.TwoPointsDis=function(e){var t=e[0]-e[2],n=e[1]-e[3];return Math.sqrt(t*t+n*n)},n.prototype.TwoPointsStart=function(e,t){this.PriPointTwo1.x=e[0],this.PriPointTwo1.y=e[1],this.PriPointTwo2.x=e[2],this.PriPointTwo2.y=e[3];var n=this.PriPointTwo1.Add(this.PriPointTwo2).Divide(2);this.PirDistance=this.TwoPointsDis(e);if(this.sceneManager!=null){var r=this.sceneManager.GetCamera();this.cachePriPoint=r.GetView().Multiply(r.GetViewPort().ScreenToWorldPoint(n.x,n.y,this.screenDepth))}this.insectPoint=this.cachePriPoint.Clone()},n.prototype.ControlCloseRangeByScreenCenter=function(){this.OptimizeCamera();var t=this.sceneManager.GetCamera().GetViewPort(),n=t.GetRect(),r=new e.Vector2((n.left+n.right)/2,(n.bottom+n.top)/2),i=this.sceneManager.GetCamera(),s=i.GetViewPort().ScreenToWorldPoint(r.x,r.y,.5);this.oribitControlTarget=s.Clone()},n.prototype.VirtualKeyControlSpeed=function(){var t=this.sceneManager.GetCamera().GetViewPort(),n=t.GetRect(),r=new e.Vector2((n.left+n.right)/2,(n.bottom+n.top)/2);if(this.insideBoundingBox){var i=new e.Vector2(r.x,r.y),s=new e.Vector3,o=this.sceneManager.GetPickPoint(i,s,!1);this.virtualKeyTarget=s;var u=this.sceneManager.GetCamera(),a=u.GetPosition().Sub(s).Length(),f=a/this.movSpeed,l=a/8;this.movSpeed=e.Max(this.standardSpeed*.1,l)}},n.prototype.IsNeedUpdateSpeed=function(e){var t=!1,n=this.sceneManager.GetCamera(),r=n.GetPosition(),i=this.virtualKeyTarget.Sub(r);i.Normalize();var s=i.DotProduct(e);return s<.966&&(t=!0),t},n.prototype.VirtualKeyControlTask=function(e){var t=e;return t.VirtualKeyControlSpeed(),null},n.prototype.StartVirtualKeyControlTask=function(){this.virtualKeyControlTimer.IsStart()&&this.virtualKeyControlTimer.StopTimer(),this.virtualKeyControlTimer.StartTimer(),this.virtualKeyControlTimer.SetTimer(this.VirtualKeyControlTask,this,33)},n.prototype.EndVirtualKeyControlTask=function(){this.virtualKeyControlTimer.IsStart()&&this.virtualKeyControlTimer.StopTimer()},n.prototype.VirtualKeyMove=function(t,n){if(e.Abs(t)<.01&&e.Abs(n)<.01)return;this.ControlCloseRangeByScreenCenter();var r=this.sceneManager.GetCamera(),i=r.GetPosition(),s=r.GetView().ToMatrix3(),o=new e.Vector3(s.Value(2,0),0,s.Value(2,2)),u=new e.Vector3(s.Value(0,0),0,s.Value(0,2));o=o.Multiply(-1),o.Normalize(),u=u.Multiply(-1),u.Normalize();var a=o.Add(u),f;if(this.insideBoundingBox){var l=this.GetDirectionDistance(a,0);this.movSpeed=l/400,this.movSpeed=this.movSpeed*this.firstPersionSpeed,f=i.Add(o.Multiply(t*this.movSpeed*.3)).Add(u.Multiply(n*this.movSpeed*.3))}else this.movSpeed=this.movSpeed*this.firstPersionSpeed,f=i.Add(o.Multiply(t*this.movSpeed).Add(u.Multiply(n*this.movSpeed)));r.SetWorldPosition(f),this.isOribteRotateState=!1},n.prototype.ControlCloseRangeSpeed=function(t){var n=this.sceneManager.GetCamera(),r=this.insectPoint,i=new e.Vector2(t.x,t.y),s=n.GetView().ToMatrix3(),o=new e.Vector3(s.Value(2,0),0,s.Value(2,2));o=o.Multiply(-1),o.Normalize();var u;if(this.insideBoundingBox){var a=this.GetDirectionDistance(o,0);this.movSpeed=e.Min(this.movSpeed,a/800)}else{var a=this.GetDirectionDistance(o,0);this.movSpeed=e.Min(this.movSpeed,a/10)}this.useOribit&&this.updateOribitControlTarget()},n.prototype.TwoPointsMove=function(t,n){this.CurrDistance=this.TwoPointsDis(t);var r=this.PirDistance/this.CurrDistance;this.trackBall.mvMatrix.rotation=e.Quaternion.IDENTITY().Clone(),this.trackBall.mvMatrix.moveVector=e.Vector3.ZERO().Clone();if(Math.abs(this.PriPointTwo1.x-t[0])>1||Math.abs(this.PriPointTwo1.y-t[1])>1||Math.abs(this.PriPointTwo2.x-t[2])>1||Math.abs(this.PriPointTwo2.y-t[3])>1)if(this.sceneManager!=null){var i=this.sceneManager.GetCamera();if(!i.IsOrthographic()){e.Trackball.ISMOVING=!0,e.Trackball.KEEPINGSTATETIMES=e.Trackball.TIMES;var s=new e.Vector2((t[0]+t[2])/2,(t[1]+t[3])/2),o=this.PriPointTwo1.Add(this.PriPointTwo2).Divide(2),u=new e.Vector2(t[0],t[1]),a=new e.Vector2(t[2],t[3]),f=this.PriPointTwo1.Sub(this.PriPointTwo2).Length(),l=u.Sub(a).Length(),c=Math.abs(f-l),h=Math.abs(l-this.PirDistance);this.ControlCloseRangeSpeed(s);if(h>10){var p=i.GetViewPort().ScreenToWorldPoint(s.x,s.y,this.screenDepth),d=i.GetPosition(),v=this.movSpeed*r*(r>1?-1:1);i.SetWorldPosition(d.Add(p.Sub(d).Normalized().Multiply(v))),this.PirDistance=this.CurrDistance}else if(c<8){var m=new e.Vector2(o.x,o.y),g=this.insectPoint,y=this.sceneManager.GetSceneBox(),b=y.Center(),d=i.GetPosition(),w=i.GetViewPort().ScreenToWorldPoint(o.x,o.y,this.screenDepth),E=i.GetViewPort().ScreenToWorldPoint(s.x,s.y,this.screenDepth),S=i.GetViewPort().ScreenToWorldPoint(o.x,o.y,this.screenDepth/2),x=i.GetViewPort().ScreenToWorldPoint(s.x,s.y,this.screenDepth/2),T=d.Sub(w).Length(),N=d.Sub(g).Length(),C=w.Sub(E).Length(),k=C*N/T,L=E.Sub(w).Normalized();i.SetWorldPosition(d.Sub(L.Multiply(k))),this.needMoveValue=L.Multiply(-k)}this.trackBall.mvMatrix.scaleFactor=1}}this.PriPointTwo1.x=t[0],this.PriPointTwo1.y=t[1],this.PriPointTwo2.x=t[2],this.PriPointTwo2.y=t[3]},n.prototype.LimitCamera=function(){if(this.sceneManager!=null){var e=this.sceneManager.GetCamera();!e.IsOrthographic()}},n.prototype.TwoPointsRotate=function(t,n,r,i){var s=t.GetViewPort().ScreenToWorldPoint(r.x,r.y,this.screenDepth),o=t.GetViewPort().ScreenToWorldPoint(i.x,i.y,this.screenDepth),u=t.GetPosition();u=t.GetWorldPosition();var a=new e.Vector2(n[0],n[1]),f=new e.Vector2(n[2],n[3]),l,c=e.Matrix4.IDENTITY().Clone();this.GetTwoPointsRotateMatrix(this.PriPointTwo1,this.PriPointTwo2,a,f,this.sceneManager,s.Add(o).Divide(2),c,this.screenDepth),c=c.Inverse(),t.Translate(c.Translation(),e.Camera.TS_WORLD),t.Rotate(c.Rotation(),e.Camera.TS_WORLD)},n.prototype.LockPointer=function(){if(this.upDirection!=e.Vector3.ZERO().Clone()){var t=this.sceneManager,n=t.GetCamera(),r=n.GetPosition(),i=t.GetSceneBox(),s=i.Center(),o=n.GetWorldRotation(),u=o.EulerAngles(),a=u.x;a=e.Max(-85,e.Min(85,a));if(this.controlLockXY){var f=new e.Quaternion(this.phi,u.y,0);n.SetRotation(f)}else{var f=new e.Quaternion(a,u.y,0);n.SetRotation(f)}}var l=this.trackBall.mvMatrix.rotation.Inverse(),c=this.sceneManager.GetCamera();c.RotateAroundCenter(l,e.Camera.TS_WORLD),c.Translate(this.trackBall.mvMatrix.moveVector,e.Camera.TS_WORLD),c.ZoomView(this.trackBall.mvMatrix.scaleFactor)},n.prototype.ConstraintMode=function(e){if(e){var t=this.sceneManager,n=t.GetCamera(),r=n.GetPosition(),i=t.GetSceneBox(),s=i.Center(),o=n.GetWorldRotation(),u=o.EulerAngles(),a=u.x;this.phi=a,this.oribitMode=!1,this.freeViewMode=!1}this.controlLockXY=e},n.prototype.OribitMode=function(e){e&&(this.controlLockXY=!1,this.freeViewMode=!1),this.oribitMode=e},n.prototype.FreeViewMode=function(e){e&&(this.oribitMode=!1,this.controlLockXY=!1),this.freeViewMode=e},n.prototype.TwoPointsRotateAngle=function(t,n,r,i,s,o,u,a){var f,l,c,h;t.x<n.x?(f=t,l=n):(f=n,l=t),r.x<i.x?(c=r,h=i):(c=i,h=r);var p=s.GetViewPort().ScreenToWorldPoint(f.x,f.y,u),d=s.GetViewPort().ScreenToWorldPoint(l.x,l.y,u),v=s.GetViewPort().ScreenToWorldPoint(c.x,c.y,u),m=s.GetViewPort().ScreenToWorldPoint(h.x,h.y,u),g=d.Sub(p);g.Normalize();var y=m.Sub(v);y.Normalize();var b=e.Acos(g.DotProduct(y));a=b<90?b:180-b,o=g.CrossProduct(y).Normalized()},n.prototype.TwoPointsRotate2=function(t,n,r,i,s,o,u,a,f){var l=0,c,h,p=u.Sub(o);this.TwoPointsRotateAngle(t,n,r,i,s,h,f,l),c.FromAngleAxis(l,h),c.Normalize();var d=new e.Quaternion(0,p.x,p.y,p.z),v=c.Multiply(d).Multiply(c).Inverse(),m=new e.Vector3(v.x,v.y,v.z);a=m.Add(o)},n.prototype.GetTwoPointsRotateMatrix=function(t,n,r,i,s,o,u,a){var f=0,l,c,h=s.GetCamera();this.TwoPointsRotateAngle(t,n,r,i,h,c,a,f);var p=new e.Vector3,d=new e.Vector2(r.Add(i).x/2,r.Add(i).y/2),v=s.GetPickPoint(d,p,!0);if(v){var m=void 0;m.SetTranslation(-p),l.FromAngleAxis(f,c),m.MultiRotatiton(l),m.MultiTranslate(p),u=m}},n.prototype.OrbitControl=function(){var t=this.sceneManager.GetCamera(),n=t.GetWorldPosition(),r,i,s=e.Quaternion.IDENTITY().Clone();s.Normalize();var o=n.Sub(this.oribitControlTarget);o=s.Multiply(o),r=Math.atan2(o.x,o.z),i=Math.atan2(Math.sqrt(o.x*o.x+o.z*o.z),o.y);var u=this.trackBall.mvMatrix.rotation,a=u.EulerAngles(),f=a;r-=f.y,this.oribitMode&&(i-=f.x,i=e.Max(.1,e.Min(179.9,i)));var l=o.Length();o.x=l*Math.sin(i)*Math.sin(r),o.y=l*Math.cos(i),o.z=l*Math.sin(i)*Math.sin(r),o=s.Inverse().Multiply(o),n=this.oribitControlTarget.Add(o),t.SetWorldPosition(n),t.LookAt(this.oribitControlTarget,s.Multiply(e.Vector3.UP()),e.Camera.TS_WORLD)},n.prototype.MoveStraight=function(t){if(Math.abs(t)<.01)return;this.ControlCloseRangeByScreenCenter();var n=this.sceneManager.GetCamera(),r=n.GetPosition(),i=n.GetView().ToMatrix3(),s=new e.Vector3(i.Value(2,0),0,i.Value(2,2));s=s.Multiply(-1),s.Normalize();var o;if(this.insideBoundingBox){var u=this.GetDirectionDistance(s,0);this.movSpeed=u/400,this.movSpeed=this.movSpeed*this.firstPersionSpeed,o=r.Add(s.Multiply(t*this.movSpeed*.3))}else o=r.Add(s.Multiply(t*this.movSpeed));n.SetWorldPosition(o),this.isOribteRotateState=!1},n.prototype.MoveSideways=function(t){if(Math.abs(t)<.01)return;this.ControlCloseRangeByScreenCenter();var n=this.sceneManager.GetCamera(),r=n.GetPosition(),i=n.GetView().ToMatrix3(),s=new e.Vector3(i.Value(0,0),0,i.Value(0,2));s=s.Multiply(-1),s.Normalize();var o;if(this.insideBoundingBox){var u=this.GetDirectionDistance(s,0);this.movSpeed=u/400,this.movSpeed=this.movSpeed*this.firstPersionSpeed,o=r.Add(s.Multiply(t*this.movSpeed*.3))}else o=r.Add(s.Multiply(t*this.movSpeed));n.SetWorldPosition(o),this.isOribteRotateState=!1},n.prototype.MoveUpAndDown=function(t){if(Math.abs(t)<.01)return;this.ControlCloseRangeByScreenCenter();var n=this.sceneManager.GetCamera(),r=n.GetPosition(),i=n.GetView().ToMatrix3(),s=e.Vector3.UP().Clone();s=s.Multiply(-1),s.Normalize();var o;if(this.insideBoundingBox){var u=this.GetDirectionDistance(s,0);this.movSpeed=u/800*this.firstPersionSpeed,o=r.Add(s.Multiply(t*this.movSpeed*.3))}else o=r.Add(s.Multiply(t*this.movSpeed));n.SetWorldPosition(o),this.isOribteRotateState=!1},n.prototype.RotateUpAndDown=function(t){if(e.Abs(t)<.01)return;var n=this.sceneManager.GetCamera(),r=n.GetView().ToMatrix3(),i=new e.Vector3(r.Value(1,0),r.Value(1,1),r.Value(1,2)),s=n.GetWorldRotation(),o=s.EulerAngles(),u=o.x+t;u=e.Max(-85,e.Min(85,u));var a=new e.Quaternion(u,o.y,0);n.SetRotation(a)},n.prototype.RotateSideways=function(t){if(e.Abs(t)<.01)return;var n=this.sceneManager.GetCamera(),r=n.GetView().ToMatrix3(),i=new e.Vector3(r.Value(1,0),r.Value(1,1),r.Value(1,2)),s=n.GetWorldRotation(),o=s.EulerAngles(),u=o.y-t,a=new e.Quaternion(o.x,u,0);n.SetRotation(a)},n.prototype.updateOribitControlTarget=function(){var t=this.sceneManager.GetCamera().GetViewPort(),n=t.GetRect(),r=new e.Vector2((n.left+n.right)/2,(n.bottom+n.top)/2),i=new e.Vector3,s=this.sceneManager.GetPickPoint(r,i,!1);this.oribitControlTarget=i.Clone()},n.prototype.SetCameraFov=function(e){var t=this.sceneManager,n=t.GetCamera();n.SetFov(e)},n.prototype.GetCameraFov=function(){var e=this.sceneManager,t=e.GetCamera();return t.GetFov()},n.prototype.GetDirectionDistance=function(t,n){var r=0,i=this.sceneManager.GetSceneBox();switch(n){case 0:var s=Math.abs(t.DotProduct(e.Vector3.RIGHT().Clone()));s>.7071?r=i.GetXLength():r=i.GetZLength();break;case 3:var o=Math.abs(t.DotProduct(e.Vector3.FORWARD().Clone()));o>.7071?r=i.GetZLength():r=i.GetXLength()}return r},n}(e.CommonTouchHandler);e.WalkthroughHandler=t})(M3D||(M3D={}));var SView;(function(e){var t;(function(e){e[e.LinkTypeView=0]="LinkTypeView",e[e.LinkTypeAnimation=1]="LinkTypeAnimation",e[e.LinkTypeOpenFile=2]="LinkTypeOpenFile",e[e.LinkTypeStory=3]="LinkTypeStory"})(t=e.LinkActionType||(e.LinkActionType={}));var n=function(){function e(e,t,n,r,u,a){this.srcType=e,this.srcPath=t,this.targetType=n,this.targetPath=r;if(n==="view")this.action=new i(Number(this.targetPath));else if(n==="animation"){var f="|",l=this.targetPath.split(f);this.action=new s(l[0],l.length>1?l[1]:"")}else if(n==="story"){var c=a.id,h=a.name,p=a.views;this.action=new o(c,h,p)}if(u!==""){this.condition=u;if(u.length>4&&u.substring(0,4)==="pos="){var d=u.substring(4),v=d.split(" ");v.length===3&&(this.conditionX=Number(v[0]),this.conditionY=Number(v[1]),this.conditionZ=Number(v[2]),this.hasPosCondition=!0)}}}return Object.defineProperty(e.prototype,"srcType",{get:function(){return this._srcType},set:function(e){this._srcType=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"srcPath",{get:function(){return this._srcPath},set:function(e){this._srcPath=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"targetType",{get:function(){return this._targetType},set:function(e){this._targetType=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"targetPath",{get:function(){return this._targetPath},set:function(e){this._targetPath=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"conditionX",{get:function(){return this._conditionX},set:function(e){this._conditionX=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"conditionY",{get:function(){return this._conditionY},set:function(e){this._conditionY=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"conditionZ",{get:function(){return this._conditionZ},set:function(e){this._conditionZ=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"condition",{get:function(){return this._condition},set:function(e){this._condition=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasPosCondition",{get:function(){return this._hasPosCondition},set:function(e){this._hasPosCondition=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"action",{get:function(){return this._action},set:function(e){this._action=e},enumerable:!0,configurable:!0}),e.prototype.onExecute=function(){this.action&&this.action.Execure()},e}();e.Link=n;var r=function(){function e(){}return e.prototype.Execure=function(){},e.prototype.GetActionType=function(){},e}();e.LinkAction=r;var i=function(e){function n(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];var r=e.call(this)||this;return t.length>0&&(r.viewID=Number(t[0])),r}return __extends(n,e),n.prototype.getViewID=function(){return this.viewID},n.prototype.Execure=function(){this.view.view.ShowModelView(Number(this.getViewID()),!0,!0)},n.prototype.GetActionType=function(){return t.LinkTypeView},n}(r);e.LinkOpenViewAction=i;var s=function(e){function n(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];var r=e.call(this)||this;return t.length>0&&(r.processID=t[0],r.stepID=t[1]),r}return __extends(n,e),n.prototype.Execure=function(){this.view.GetAnimationPlayer().playAnimation(Number(this.processID),this.stepID?Number(this.stepID):null)},n.prototype.GetActionType=function(){return t.LinkTypeAnimation},n.prototype.GetStepID=function(){return this.stepID},n.prototype.GetProcessID=function(){return this.processID},n}(r);e.LinkOpenAniAction=s;var o=function(e){function n(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];var r=e.call(this)||this;r.viewsId=[],r.views={};if(t.length>0){r.id=t[0],r.name=t[1];if(t[2]&&t[2].length>0)for(var i=0,s=t[2];i<s.length;i++){var o=s[i];o.time&&(r.views[o.id]=o.time)}}return r}return __extends(n,e),n.prototype.Execure=function(){var e=this;this.view.view.ShowLinkStoryListener=function(){e.ShowLinkStoryListener()},this.viewsId=new Array,this.view.view.StopModelViewAnimation();if(this.views)for(var t in this.views)this.viewsId.push(t);if(this.viewsId.length===0)return;var n=this.viewsId[0];this.viewsId.shift();if(this.views[n]){var r=this.views[n];this.view.view.setCameraAnimationTime(r*1e3),this.view.view.setModelExplosiveAnimationTime(r*1e3),this.view.view.ShowModelView(n,!0,!0)}},n.prototype.ShowLinkStoryListener=function(){if(this.viewsId.length===0)return;var e=this.viewsId[0];this.viewsId.shift();if(this.views[e]){var t=this.views[e];this.view.view.setCameraAnimationTime(t*1e3),this.view.view.setModelExplosiveAnimationTime(t*1e3);var n=this;window.setTimeout(function(){n.view.view.ShowModelView(e,!0,!0)},800)}},n.prototype.GetActionType=function(){return t.LinkTypeStory},n.prototype.GetID=function(){return this.id},n.prototype.GetName=function(){return this.name},n.prototype.GetViews=function(){return this.views},n}(r);e.LinkStoryAction=o})(SView||(SView={}));var SView;(function(e){var t=function(){function e(){this._links=[],this._svlFilePath="",this._version="2.0"}return e.Instance=function(){return e.instance==null&&(e.instance=new e),e.instance},Object.defineProperty(e.prototype,"svlFilePath",{get:function(){return this._svlFilePath},set:function(e){this._svlFilePath=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"version",{get:function(){return this._version},set:function(e){this._version=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"view",{get:function(){return this._view},set:function(e){this._view=e},enumerable:!0,configurable:!0}),e.prototype.GetLinkByPart=function(e){var t=[];if(this.GetAllLinkList().length>0)for(var n=0,r=this.GetAllLinkList();n<r.length;n++){var i=r[n];e==i.srcPath&&t.push(i)}return t},e.prototype.GetAllLinkList=function(){return this._links},e.prototype.ClearData=function(){this._links=[]},e.prototype.AddLink=function(e){this._links.push(e),e.action.view=this.view},e.prototype.DeleteLink=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];if(e.length===1){var n=e[0];this._links.indexOf(n)>-1&&this._links.splice(this._links.indexOf(n),1)}else if(e.length===2){var r=e[0],i=e[1];for(var s=0;s<this._links.length;s++){var n=this._links[s];if(n.srcPath===r&&n.condition===i){this._links.splice(s,1);return}}}},e.prototype.GetLink=function(e,t){for(var n=0;n<this._links.length;n++){var r=this._links[n];if(r.srcPath===e&&r.conditionX===Number(t.x.toFixed(2))&&r.conditionY===Number(t.y.toFixed(2))&&r.conditionZ===Number(t.z.toFixed(2)))return r}return null},e.instance=null,e}();e.LinkManager=t})(SView||(SView={}));var M3D;(function(e){var t=function(){function e(){this.onBeforeSelect=function(e,t){return!0},this.onSelected=function(e,t){return},this.onUnSelected=function(e,t){return},this.onClearSelected=function(e){return},this.onShapesSelected=function(e,t){return}}return e}();e.SelectorListener=t})(M3D||(M3D={}));var SView;(function(e){var t=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t}(M3D.SelectorListener);e.SViewSelctorListener=t;var n=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return __extends(t,e),t}(M3D.ReadListener);e.SViewReadListener=n;var r=function(){function e(){this.onBegin=function(e){},this.onExecute=function(e){},this.onEnd=function(e){}}return e}();e.SViewExecuteListener=r})(SView||(SView={}));var M3D;(function(e){var t=function(){function t(){}return t.ConvertToFloat32Array=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t[0][0]instanceof e.Vector3){var r=new Float32Array(t[0].length*3);for(var i=0;i<t[0].length;++i){var s=t[0][i];r[i*3]=s.x,r[i*3+1]=s.y,r[i*3+2]=s.z}return r}if(typeof t[0][0]=="number"){var r=new Float32Array(t[0].length);for(var i=0;i<t[0].length;++i){var o=t[0][i];r[i]=o}return r}},t.ConvertToInt8Array=function(e){var t=new Int8Array(e.length);for(var n=0;n<e.length;++n){var r=e[n];t[n]=r}return t},t.ConvertToUInt8Array=function(e){var t=new Uint8Array(e.length);for(var n=0;n<e.length;++n){var r=e[n];t[n]=r}return t},t.ConvertToInt16Array=function(e){var t=new Int16Array(e.length);for(var n=0;n<e.length;++n){var r=e[n];t[n]=r}return t},t.RemoveByValue=function(e,t){for(var n=0;n<e.length;n++)if(e[n]===t){e.splice(n,1),t=null;break}},t.ConvertToFloat32ArrayV2=function(e){var t=new Float32Array(e.length*2);for(var n=0;n<e.length;++n){var r=e[n];t[n*2]=r.x,t[n*2+1]=r.y}return t},t}();e.ArrayHelper=t})(M3D||(M3D={}));var M3D;(function(e){e.IsObjectExist=function(e){return e!==null&&e!==undefined},e.IsStringNotEmpty=function(e){return e!==null&&e!==undefined&&e.length===0}})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){}return e.AddCookie=function(e,t,n){var r=e+"="+encodeURI(t);if(n>0){var i=new Date;i.setTime(i.getTime()+n*24*3600*1e3),r=r+"; expires="+i.toUTCString()}document.cookie=r},e.GetCookie=function(e){var t=document.cookie,n=t.split("; ");for(var r=0;r<n.length;r++){var i=n[r].split("=");if(i[0]==e)return decodeURI(i[1])}},e.DeleteCookie=function(e){var t=new Date;t.setTime(t.getTime()-1e4),document.cookie=e+"=v; expires="+t.toUTCString()},e}();e.CookieHelper=t})(M3D||(M3D={}));var M3D;(function(e){e.OUTSIDE=0,e.INTERSECTS=1,e.INSIDE=2;var t=function(){function t(){this.drawLLLimit=0,this.drawLimit=0,this.modelLength=0,this.cullerStyle=0,this.screenLength=200,this.priCameraScale=1,this.cullerbase=0,this.cullerPercent=0}return t.prototype.InViewPort=function(t,n){var r=e.INTERSECTS;if(n){var i=n.GetFrustum();r=i.IsInsideFast(t)}return r},t.prototype.IsLittleModel=function(e,t){var n=0;if(e.Defined()){var r=e.Length();if(!t.IsOrthographic()){var i=t.GetWorldPosition().Sub(e.Center()).Length();r=r*1e3/i}r>0&&(r<this.drawLLLimit?n=2:r<this.drawLimit&&(n=1))}return n},t.prototype.SetModelLength=function(e){this.modelLength=e},t.prototype.SetScreenLength=function(e){},t.prototype.AddCullerRatio=function(e){return},t.prototype.ReduceCullerRatio=function(e){return},t.prototype.UpDate=function(t){var n=t.GetViewPort();this.cullerbase=e.Parameters.Instance().RemoveSize;var r=e.Parameters.Instance().RemoveSize,i=this.cullerbase/4;if(e.Parameters.Instance().RemoveMode===0)this.drawLimit=this.modelLength*r/100;else if(e.Parameters.Instance().RemoveMode===1){var s=n.ScreenToWorldPoint(0,0,.5),o=n.ScreenToWorldPoint(0,r,.5);this.drawLimit=s.Sub(o).Length();var u=n.ScreenToWorldPoint(0,i,.5);this.drawLLLimit=s.Sub(u).Length()}},t.prototype.AllowCuller=function(e,t){this.allowCuller=t,this.UpDate(e)},t}();e.CullerHelper=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){}return e.GetSuffix=function(e){var t="";return e!==undefined&&e!==null&&e.length>0&&(t=e.split(".").pop().toLowerCase()),t},e.GetUnionStylePath=function(e){var t=e;return t.replace("\\","/"),t},e.GetFileNameFromUrl=function(e){var t="";if(e!=null&&e.length>0){var n=e.lastIndexOf("/");n+1<e.length&&(t=e.substring(n+1))}return t},e}();e.FileHelper=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){this.currentTypeIndex=-1,this.IDMap=new e.Map,this.IDMap.Put(t.DEFAULT,1e5),this.currentTypeIndex=this.IDMap.Find(t.DEFAULT)}return t.GetDefaultID=function(){return t.pcreator===null&&(t.pcreator=new t),t.pcreator.GetID(t.DEFAULT)},t.prototype.Initialize=function(e,t){this.currentTypeIndex!==this.IDMap.Size()-1?e===this.IDMap.Element(this.currentTypeIndex).key?this.IDMap.Element(this.currentTypeIndex).value=t:(this.currentTypeIndex=this.IDMap.Find(e),this.currentTypeIndex===this.IDMap.Size()-1&&(this.IDMap.Put(e,t),this.currentTypeIndex=this.IDMap.Find(e)),this.IDMap.Element(this.currentTypeIndex).value=t):(this.currentTypeIndex=this.IDMap.Find(e),this.currentTypeIndex===this.IDMap.Size()-1&&(this.IDMap.Put(e,t),this.currentTypeIndex=this.IDMap.Find(e)),this.IDMap.Element(this.currentTypeIndex).value=t)},t.prototype.GetID=function(e){if(this.currentTypeIndex<this.IDMap.Size()){if(e===this.IDMap.Element(this.currentTypeIndex).key){var t=this.IDMap.Element(this.currentTypeIndex).value;return t+=1,this.IDMap.Element(this.currentTypeIndex).value=t,this.IDMap.Element(this.currentTypeIndex).value}this.currentTypeIndex=this.IDMap.Find(e),this.currentTypeIndex===this.IDMap.Size()-1&&(this.IDMap.Put(e,-1),this.currentTypeIndex=this.IDMap.Find(e));var t=this.IDMap.Element(this.currentTypeIndex).value;return t+=1,this.IDMap.Element(this.currentTypeIndex).value=t,this.IDMap.Element(this.currentTypeIndex).value}this.currentTypeIndex=this.IDMap.Find(e),this.currentTypeIndex===this.IDMap.Size()-1&&(this.IDMap.Put(e,-1),this.currentTypeIndex=this.IDMap.Find(e));var t=this.IDMap.Element(this.currentTypeIndex).value;return t+=1,this.IDMap.Element(this.currentTypeIndex).value=t,this.IDMap.Element(this.currentTypeIndex).value},t.GetIDFromTime=function(){},t.DEFAULT=-1,t.MODEL=0,t.NODE=1,t.SHAPE=2,t.HANDLE=3,t.pcreator=null,t.GetUUID=function(e,t){e===void 0&&(e=32),t===void 0&&(t=16);var n="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),r=[],i;t=t||n.length;if(e)for(i=0;i<e;i++)r[i]=n[0|Math.random()*t];else{var s=void 0;r[8]=r[13]=r[18]=r[23]="-",r[14]="4";for(i=0;i<36;i++)r[i]||(s=0|Math.random()*16,r[i]=n[i==19?s&3|8:s])}return r.join("")},t}();e.IDCreator=t})(M3D||(M3D={}));var M3D;(function(e){e.LOGE=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t]},e.LOGI=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];console.log(e)};var t=function(){function t(){this.level=t.ERROR,this.onError=function(e,t){console.error("Error:"+e+t)},this.onWarning=function(e,t){console.warn("Warning:"+e+t)},this.onDebug=function(e,t){console.debug("Debug:"+e+t)},this.onInfo=function(e,t){console.info("Info:"+e+t)}}return t.prototype.SetLevel=function(e){this.level=e},t.prototype.Debug=function(n,r){this.level<=t.DEBUG&&e.IsObjectExist(this.onDebug)&&this.onDebug(n,r)},t.prototype.Info=function(n,r){this.level<=t.INFO&&e.IsObjectExist(this.onInfo)&&this.onInfo(n,r)},t.prototype.Error=function(t,n){e.IsObjectExist(this.onError)&&this.onError(t,n)},t.prototype.Warning=function(t,n){e.IsObjectExist(this.onWarning)&&this.onWarning(t,n)},t.DEBUG=3,t.ERROR=1,t.INFO=2,t}();e.Logger=t,e.Log=null})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){}return e.RotationSlerp=function(e,t,n,r){var i=e,s=t;for(var o=0;o<n-1;o++){var u=i.Slerp(s,o*1/n);r[o]=u}return r[n-1]=t.Clone(),!0},e.VecSlerp=function(e,t,n,r){for(var i=0;i<n-1;i++)r[i]=e.Add(t.Sub(e).MultiplyED(i*1/n));return r[n-1]=t.Clone(),!0},e.FloatSlerp=function(e,t,n,r){for(var i=0;i<n-1;i++)r[i]=e+(t-e)*i/n;return r[n-1]=t,!0},e.Random=function(e,t){return Math.random()*(t-e)+e},e}();e.M3DTOOLS=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){this.elements=[]}return e.prototype.Size=function(){return this.elements.length},e.prototype.Clear=function(){this.elements.length=0},e.prototype.IsEmperty=function(){return this.elements.length<1},e.prototype.ContainKey=function(e){var t=!1;for(var n=0;n<this.elements.length;n++)this.elements[n].key===e&&(t=!0);return t},e.prototype.ContainValue=function(e){var t=!1;for(var n=0;n<this.elements.length;n++)this.elements[n].value===e&&(t=!0);return t},e.prototype.Find=function(e){var t=!1,n=-1;for(var r=0;r<this.elements.length;r++)this.elements[r].key===e&&(t=!0,n=r);return n},e.prototype.Put=function(e,t){this.ContainKey(e)===!0?this.Get(e)!=t?this.Remove(e)===!0&&this.elements.push({key:e,value:t}):this.elements.push({key:e,value:t}):this.elements.push({key:e,value:t})},e.prototype.Remove=function(e){var t=!1;for(var n=0;n<this.elements.length;n++)if(this.elements[n].key===e)return this.elements.splice(n,1),!0;return t},e.prototype.Get=function(e){for(var t=0;t<this.elements.length;t++)if(this.elements[t].key===e)return this.elements[t].value;return null},e.prototype.Element=function(e){return e<0||e>=this.elements.length?null:this.elements[e]},e.prototype.Keys=function(){var e=new Array;for(var t=0;t<this.elements.length;t++)e.push(this.elements[t].key);return e},e.prototype.Values=function(){var e=new Array;for(var t=0;t<this.elements.length;t++)e.push(this.elements[t].value);return e},e}();e.Map=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){}return t.ReadSingleModel=function(t,n,r){var i=!1,s=null,o=e.FileHelper.GetUnionStylePath(t),u=e.Reader.GetReader(o)[0];o="res/model/"+o.split(".")[0]+".zip";var a=new XMLHttpRequest;a.open("GET",o,!0),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),a.responseType="arraybuffer",a.onreadystatechange=function(){if(a.readyState===4&&a.status===200){var t=a.response,o=new JSZip(t),f=void 0,l="stl";f=new RegExp(".*."+l+"$","i");var c=o.file(f);s=u.ReadFile(c[0].asBinary());var h=new e.ReadListener;u.AddListener(h),h.onReadEnd=function(e){var t=e;s=t.GetModel(),s&&(n=s,i=!0),e&&(e=null),r(i,s)}}},a.onerror=function(e){console.log("error")},a.send(null)},t.GetUVArrayByPositionArrayTest1=function(t,n){var r=new e.Vector3,i=new e.Vector3;for(var s=0;s<t.length;s+=3){var o=new e.Vector3;o.x=t[s],o.y=t[s+1],o.z=t[s+2],r.x>o.x&&(r.x=o.x),r.y>o.y&&(r.y=o.y),i.x<o.x&&(i.x=o.x),i.y<o.y&&(i.y=o.y),r.z>o.z&&(r.z=o.z),i.z<o.z&&(i.z=o.z)}var u=i.x-r.x,a=i.y-r.y,f=i.z-r.z,l=[];for(var s=0;s<t.length;s+=3){var c=new e.Vector3,o=new e.Vector3;o.x=t[s],o.y=t[s+1],o.z=t[s+2],c.x=(o.x-r.x)/u,c.y=(o.y-r.y)/a,c.z=(o.z-r.z)/f;if(n)switch(n){case"x":l.push(c.y),l.push(c.z),l.push(0);break;case"y":l.push(c.x),l.push(c.z),l.push(0);break;default:l.push(c.x),l.push(c.y),l.push(0)}else l.push(c.x),l.push(c.y),l.push(c.z)}return l},t.GetUVArrayByPositionArray=function(t,n,r){var i=new e.Vector3,s=new e.Vector3,o=n.GetXLength(),u=n.GetYLength(),a=n.GetZLength(),f=[];for(var l=0;l<t.length;l+=3){var c=new e.Vector3,h=new e.Vector3,p=new e.Vector3;p.x=r[l],p.y=r[l+1],p.z=r[l+2],p=p.Abs(),p.Normalize(),h.x=t[l],h.y=t[l+1],h.z=t[l+2],p.z>.57735?(c.x=(h.x-n.min.x)/o,c.y=(h.y-n.min.y)/u):p.y>.57735?(c.x=(h.x-n.min.x)/o,c.y=(h.z-n.min.z)/a):p.x>.57735?(c.x=(h.y-n.min.y)/u,c.y=(h.z-n.min.z)/a):(c.x=(h.x-n.min.x)/o,c.y=(h.y-n.min.y)/u),c.z=0,f.push(c.x),f.push(c.y),f.push(0)}return f},t}();e.MeshHelper=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){}return e.GetSVLPath=function(t){return e.M3DPathToSVLPath(e.GetM3DPath(t))},e.GetM3DPath=function(e){return e&&e.GetSceneNode()&&e.GetSceneNode().GetParent()?e.GetSceneNode().GetParent().GetName():""},e.M3DPathToSVLPath=function(t){return t!=null&&t.length>e.M3D_PATH_PRE.length+1?t.substr(e.M3D_PATH_PRE.length,t.length):""},e.SVLPathToM3D=function(t){return t.indexOf(e.M3D_PATH_PRE)>0?t:e.M3D_PATH_PRE+t},e.SVLPathDecToHex=function(e){var t=e.split("|"),n=["PATH"];for(var r=1;r<t.length;r++){var i=Number(t[r]);n.push(i.toString(16))}return n.join("|")},e.SVLPathHexToDec=function(e){var t=e.split("|"),n=["PATH"];for(var r=1;r<t.length;r++)n.push(parseInt(t[r],16).toString());return n.join("|")},e.M3D_PATH_PRE="M3D|MAIN|",e}();e.PathHelper=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){}return t.SelectShape=function(t,n,r,i){var s=null;if(n===e.ShapeType.SHAPE_COORDINATE){var o=new e.Vector3,u=i.GetPickPoint(t,o,!0);u&&(s=this.AddPointHandler(o,1,i))}else if(n===e.ShapeType.SHAPE_FEATURE_COORDINATE){var a=new e.Vector3;e.RayPickAction.PickFeaturePnt(t,i,a)&&(s=this.AddPointHandler
(a,1,i))}else s=i.GetPickShape(t,n,r);return s},t.AddPointHandler=function(e,t,n){var r=null,i=n.GetHandlerGroup();if(i!==null){var s=n.GetSceneBox();r=i.CreatePointHandler(e,t,3,n)}return r},t.GetCommonSize=function(n,r){var i=100,s=100,o=t.getDPI()[0],u=n.GetCamera().GetViewPort().GetRect().Width(),a=n.GetCamera().GetViewPort().GetRect().Height();if(n){var f=n.GetCamera(),l=f.GetAspectRatio();s=f.orthoSize,l>1?(i=s*l,u=a):i=s}return i/=20*(u/(o*2.5)),new e.Vector2(i*r.x,i*r.y)},t.GetShapeWorldMatrix=function(t){var n=new e.Matrix3x4;if(!t)return n;if(t.GetType()==e.ShapeType.SHAPE_EDGE){var r=t;r.GetBody()!=null?n=r.GetBody().GetModel().GetWorldTransform().ToMatrix3x4():r.GetFace()!=null&&(n=r.GetFace().GetBody().GetModel().GetWorldTransform().ToMatrix3x4())}else if(t.GetType()==e.ShapeType.SHAPE_FACE){var i=t;n=i.GetBody().GetModel().GetWorldTransform().ToMatrix3x4()}else if(t.GetType()==e.ShapeType.SHAPE_BODY){var s=t;n=s.GetModel().GetWorldTransform().ToMatrix3x4()}else if(t.GetType()==e.ShapeType.SHAPE_MODEL){var o=t;n=o.GetWorldTransform().ToMatrix3x4()}return n},t.getDPI=function(){var e=new Array;if(window.screen.deviceXDPI)e[0]=window.screen.deviceXDPI,e[1]=window.screen.deviceYDPI;else{var t=document.createElement("DIV");t.style.cssText="width:1in;height:1in;position:absolute;left:0px;top:0px;z-index:99;visibility:hidden",document.body.appendChild(t),e[0]=parseInt(t.offsetWidth+""),e[1]=parseInt(t.offsetHeight+""),t.parentNode.removeChild(t)}return e},t}();e.ShapeHelper=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){}return e.CreateTexture2D=function(e,t){var n=new Image;n.src=t.imagePath;var r=e.createTexture();return e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,t.internalrFromat,t.format,e.UNSIGNED_BYTE,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,t.filterMag),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,t.filterMin),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,t.wrapS),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,t.wrapT),e.bindTexture(e.TEXTURE_2D,null),r},e}();e.TextureCreator=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){this.axis=e.Vector3.UP().Clone(),this.mvMatrix=new e.ControlInfo,this.mvPriMatrix=new e.ControlInfo,this.priPointOne=new e.Vector2,this.priPointOneScale=new e.Vector2,this.priPointOneScaleCenter=new e.Vector2,this.priPointOneMove=new e.Vector2,this.priPointTwo1=new e.Vector2,this.priPointTwo2=new e.Vector2,this.pirDistance=1,this.currDistance=1,this.priRotationCenter=e.Vector3.ZERO().Clone(),this.rotationAxis=e.Vector3.ZERO().Clone(),this.cachePriPoint=e.Vector3.ZERO().Clone(),this.cacheCurPointNear=e.Vector3.ZERO().Clone(),this.cacheCurPointFar=e.Vector3.ZERO().Clone(),this.cacheCentPoint=e.Vector3.ZERO().Clone(),this.startPos=e.Vector3.ZERO().Clone(),this.stopPos=e.Vector3.ZERO().Clone(),this.iWidth=400,this.iHeight=400,this.iCenterX=200,this.iCenterY=200,this.iRadius=200,this.iMouseX=200,this.iMouseY=200,this.start=e.Vector3.ZERO().Clone(),this.stop=e.Vector3.ZERO().Clone(),this.scalerChanged=!0,this.screenDepth=.5,this.rotateSpeed=1.5,this.cp=0,this.cy=0,this.lastQuat=e.Quaternion.IDENTITY().Clone(),this.rolateAngle=e.Vector3.ZERO().Clone()}return t.prototype.Tracking=function(e,t,n){var r;if(Math.abs(e)<1&&Math.abs(t)<1)return 0;this.stop=this.ScreenToVector(this.iWidth/2+e,this.iHeight/2+t),n.copyFrom(this.start.CrossProduct(this.stop)),n.Normalize(),r=this.rotateSpeed*Math.acos(this.start.DotProduct(this.stop))/3.14159*180;var i=.01;return r<i&&(r=i),this.start=this.stop.Clone(),r},t.prototype.ScreenToVector=function(t,n){var r=new e.Vector3(0,0,0);this.iCenterX>=this.iWidth/2?r.x=(t-this.iCenterX)/this.iCenterX:r.x=(t-this.iCenterX)/(this.iWidth-this.iCenterX),this.iCenterY>=this.iHeight/2?r.y=(this.iCenterY-n)/this.iCenterY:r.y=(this.iCenterY-n)/(this.iHeight-this.iCenterY);var i=Math.sqrt(r.x*r.x+r.y*r.y);return r.z=Math.cos(1.570796325*(i<1?i:1)),r.Normalize(),r},t.prototype.TwoPointsDis=function(e,t){t===void 0&&(t=2);var n=e[0]-e[2],r=e[1]-e[3];return Math.sqrt(n*n+r*r)},t.prototype.TwoPointsTrackingAngle=function(e,t){t===void 0&&(t=2);var n=Math.atan2(this.priPointTwo1.y-this.priPointTwo2.y,this.priPointTwo1.x-this.priPointTwo2.x),r=e[0]-e[t],i=e[1]-e[t+1],s=Math.atan2(i,r);return(n-s)/3.14159*360},t.prototype.ScreenToDepthVector=function(t){var n=e.Vector3.ZERO().Clone();if(this.pSceneManager!=null){var r=this.pSceneManager.GetCamera();n=r.GetView().Multiply(r.GetViewPort().ScreenToWorldPoint(t.x,t.y,this.screenDepth))}return n},t.prototype.AdjustScaleToMoveVector=function(t){if(this.pSceneManager!=null){var n=this.pSceneManager.GetCamera(),r=this.mvMatrix.scaleFactor;if(!n.IsOrthographic()&&Math.abs(r-1)>.01){var i=n.GetViewPort().ScreenToWorldPoint(t.x,t.y,this.screenDepth),s=n.GetPosition(),o=n.GetRotateCenter(),u=0,a=1;s.Sub(o).Length()>this.pSceneManager.GetSceneBox().Length()*.01?(u=s.Sub(o).Length()*.1,a=u*r*(r>1?-1:1)):(u=this.pSceneManager.GetSceneBox().Length()*.01,a=u*r*(r>1?-1:1)),this.mvMatrix.moveVector=i.Sub(s).Normalized().Multiply(a),n.SetWorldPosition(s.Add(this.mvMatrix.moveVector)),this.mvMatrix.moveVector=e.Vector3.ZERO().Clone(),this.mvMatrix.scaleFactor=1}}},t.prototype.Reset=function(){this.mvMatrix.ReSet(),this.isMoving=!1,t.ISMOVING=!1,t.ISROTATING=!1,t.MOVESTATE=-1,t.KEEPINGSTATETIMES=t.TIMES,t.drawLimit=0,this.scalerChanged=!0,this.angle=0,this.axis=new e.Vector3(0,0,1)},t.prototype.OnePointUp=function(e,t){this.Reset()},t.prototype.TwoPointsUp=function(e,t){this.Reset()},t.prototype.OnePointStart=function(e,t){t===void 0&&(t=1),this.priPointOne.x=e[0],this.priPointOne.y=e[1],this.priPointOneScale=this.priPointOne.Clone(),this.priPointOneScaleCenter=this.priPointOne.Clone(),this.pSceneManager!==null&&(this.cachePriPoint=this.ScreenToDepthVector(this.priPointOne)),this.priPointOneMove=this.priPointOne.Clone()},t.prototype.TwoPointsStart=function(t,n){n===void 0&&(n=2),this.priPointTwo1.x=t[0],this.priPointTwo1.y=t[1],this.priPointTwo2.x=t[2],this.priPointTwo2.y=t[3];var r=this.priPointTwo1.Add(this.priPointTwo2).MultiplyED(.5);this.pirDistance=this.TwoPointsDis(t);var i=this.pSceneManager.GetCamera();if(!i.IsOrthographic()){var s=new e.Vector3,o=new e.Vector2(r.x,r.y);this.pSceneManager.GetPickPoint(o,s,!1),this.pSceneManager.SetRotationCenter(s)}this.screenDepth=i.GetFitClip(),this.cachePriPoint=this.ScreenToDepthVector(r)},t.prototype.OnePointRotate=function(e,n){n===void 0&&(n=1),this.start=this.ScreenToVector(this.iWidth/2,this.iHeight/2),this.angle=this.Tracking(e[0]-this.priPointOne.x,e[1]-this.priPointOne.y,this.axis),Math.abs(this.angle)>.01&&(t.ISMOVING=!0,t.ISROTATING=!0,t.MOVESTATE=0,t.KEEPINGSTATETIMES=t.TIMES,this.mvMatrix.rotation.FromAngleAxis(this.angle,this.axis)),this.priPointOne.x=e[0],this.priPointOne.y=e[1]},t.prototype.OnePointsMove=function(n,r){r===void 0&&(r=1);var i=new e.Vector2(n[0],n[1]);if(this.priPointOneScale.Sub(i).LengthSquared()>4){if(this.pSceneManager!==null){t.ISMOVING=!0,t.KEEPINGSTATETIMES=t.TIMES,t.MOVESTATE=1;var s=this.pSceneManager.GetCamera();this.cacheCurPointNear=this.ScreenToDepthVector(i),this.cachePriPoint=this.ScreenToDepthVector(this.priPointOneScale),this.mvMatrix.moveVector=this.cacheCurPointNear.Sub(this.cachePriPoint),this.cachePriPoint.copyFrom(this.cacheCurPointNear)}this.priPointOneScale.copyFrom(i)}else this.mvMatrix.moveVector=e.Vector3.ZERO().Clone(),this.mvMatrix.rotation=e.Quaternion.IDENTITY().Clone(),this.mvMatrix.scaleFactor=1},t.prototype.OnePointsScale=function(n,r){r===void 0&&(r=1);if(Math.abs(this.priPointOneScale.y-n[1])>1){if(this.pSceneManager!==null){t.ISMOVING=!0,t.MOVESTATE=2,t.KEEPINGSTATETIMES=t.TIMES;var i=this.pSceneManager.GetCamera(),s=i.GetViewPort().rect;this.cacheCurPointNear==this.ScreenToDepthVector(this.priPointOneScaleCenter),this.mvMatrix.scaleFactor=(s.bottom-this.priPointOneScale.y)/(s.bottom-n[1]),this.mvMatrix.moveVector=this.cacheCurPointNear.Sub(this.cachePriPoint),this.cachePriPoint=this.cacheCurPointNear.Clone()}}else this.mvMatrix.moveVector=e.Vector3.ZERO().Clone(),this.mvMatrix.rotation=e.Quaternion.IDENTITY().Clone(),this.mvMatrix.scaleFactor=1;this.priPointOneScale.x=n[0],this.priPointOneScale.y=n[1]},t.prototype.TwoPointsMove=function(n,r){r===void 0&&(r=2),this.currDistance=this.TwoPointsDis(n),this.mvMatrix.scaleFactor=this.pirDistance/this.currDistance,this.mvMatrix.moveVector=e.Vector3.ZERO().Clone(),this.mvMatrix.rotation=e.Quaternion.IDENTITY().Clone();if(Math.abs(this.priPointTwo1.x-n[0])>.1||Math.abs(this.priPointTwo1.y-n[1])>.1||Math.abs(this.priPointTwo2.x-n[2])>.1||Math.abs(this.priPointTwo2.y-n[3])>.1)if(this.pSceneManager!==null){t.ISMOVING=!0,t.KEEPINGSTATETIMES=t.TIMES;var i=this.pSceneManager.GetCamera(),s=i.GetViewPort().rect,o=new e.Vector2((n[0]+n[2])/2,(n[1]+n[3])/2);this.cacheCurPointNear=this.ScreenToDepthVector(o),this.mvMatrix.moveVector=this.cacheCurPointNear.Sub(this.cachePriPoint),this.AdjustScaleToMoveVector(o),this.cachePriPoint=this.cacheCurPointNear.Clone(),t.ISMOVING=!0,t.ISROTATING=!0}this.pirDistance=this.currDistance,this.priPointTwo1.x=n[0]-.1,this.priPointTwo1.y=n[1]-.1,this.priPointTwo2.x=n[2]-.1,this.priPointTwo2.y=n[3]-.1},t.prototype.SetTrackWindow=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];e.length===2?(this.iWidth=e[0],this.iHeight=e[1],this.iCenterX=this.iWidth/2,this.iCenterY=this.iHeight/2,this.iRadius=this.iWidth>this.iHeight?this.iCenterY:this.iCenterX):(this.iWidth=e[0],this.iHeight=e[1],this.iCenterX=e[2],this.iCenterY=e[3],this.iRadius=this.iWidth>this.iHeight?this.iCenterY:this.iCenterX)},t.prototype.SetSceneManager=function(e){this.pSceneManager=e},t.prototype.SetRotateSpeed=function(e){this.rotateSpeed=e},t.prototype.GetRotateSpeed=function(){return this.rotateSpeed},t.ISROTATING=!1,t.MOVESTATE=-1,t.TIMES=10,t.KEEPINGSTATETIMES=t.TIMES,t.CURRENTMODELSIZE=1e3,t.ISMOVING=!1,t.drawLimit=0,t}();e.Trackball=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function e(){}return e.Supported=function(){return Worker!==undefined},e.BuildBridgedWorker=function(e,t,n,r){function i(e,t,n,r){var i=e.toString().match(/^\s*function\s*\(\s*\)\s*\{(([\s\S](?!\}$))*[\s\S])/)[1],s=[];s.push("var main = {};\n");for(var o=0;o<n.length;o++){var u=n[o];u.charAt(u.length-1)=="*"?(u=u.substr(0,u.length-1),n[o]=u,s.push("main."+u+" = function(/* arguments */){\n var args = Array.prototype.slice.call(arguments); var buffers = args.pop(); \n self.postMessage({foo:'"+u+"', args:args},buffers)\n}; \n")):s.push("main."+u+" = function(/* arguments */){\n var args = Array.prototype.slice.call(arguments); \n self.postMessage({foo:'"+u+"', args:args})\n}; \n")}var a=[];for(var o=0;o<t.length;o++){var u=t[o];u=u.charAt(u.length-1)=="*"?u.substr(0,u.length-1):u,a.push(u+": "+u)}s.push("var foos={"+a.join(",")+"};\n"),s.push("self.onmessage = function(e){\n"),s.push("if(e.data.foo in foos) \n  foos[e.data.foo].apply(null, e.data.args); \n else \n throw(new Error('Main thread requested function ' + e.data.foo + '. But it is not available.'));\n"),s.push("\n};\n");var f=i+"\n\n/*==== STUFF ADDED BY BuildBridgeWorker ==== */\n\n"+s.join(""),l=window.URL.createObjectURL(new Blob([f],{type:"text/javascript"})),c=new Worker(l);c.onmessage=function(e){var t=n.indexOf(e.data.foo);if(t==-1)throw new Error("Worker requested function "+e.data.foo+". But it is not available.");r[t].apply(null,e.data.args)};var h={blobURL:l},p=function(e,t){return t?function(){var t=Array.prototype.slice.call(arguments),n=t.pop();c.postMessage({foo:e,args:t},n)}:function(){var t=Array.prototype.slice.call(arguments);c.postMessage({foo:e,args:t})}};for(var o=0;o<t.length;o++){var u=t[o];u.charAt(u.length-1)=="*"?(u=u.substr(0,u.length-1),h[u]=p(u,!0)):h[u]=p(u,!1)}return h}return i(e,t,n,r)},e}();e.WorkerHelper=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){this.IsConRotate=!1,this.RemoveSize=0,this.RemoveMode=1,this.selectedStyle=1,this.measureUnitStyle=0,this.isFullScreenExpand=!0,this.outlineColor=new e.Color(1,0,0),this.isProgressiveDisplay=!0,this.isMergeFace=!0,this.isIgnoreEdge=!1,this.ignoreRestoreAnimation=!1,this.useBodyObject=!0,this.genetateTexCood=!1,this.m_useSSAO=!1,this.m_useGroundGrid=!1,this.m_shadowMapEnabled=!1,this.m_doubleSided=!1,this.m_gammaFactor=2.2,this.m_shadowMapType=1,this.m_toneMappingExposure=1,this.g_LumInfluence=.7,this.g_SSAOContrast=3,this.g_SSAO_Bias=.1,this.g_Displace=.2,this.g_Aear=4,this.g_aoClamp=.24,this.g_radius=4,this.IBLFactor=[1],this.metellic=.35,this.roughness=.75,this.shadowBias=5e-5,this.refeshUpDirection=!1,this.IsShowTrilateralEdge=!1,this.IsOnlyShowTrilateralEdge=!1,this.IsShowTransparent=!1,this.Alpha=.5,this.IsMulSelect=!1,this.IsShowBox=!1,this.BoxColor=new e.Color(0,0,1,1),this.DefaultNoteColornew=new e.Color(0,0,0,0),this.SelectedColor=new e.Color(1,0,0,1),this.DefaultZoomFactor=2,this.showSection=!1,this.OptimizeBigModel=!1,this.clipPlaneMode=0,this.isShowAniTrochoid=!1,this.useBackGroundImage=!1,this.hotSpotImageSize=1.5,this.IsShowSHotSpot=!1,this.isSpecifiedRotation=!1,this.useSimplePath=!1,this.dynamicSetDraggerPercentage=!1,this.draggerPercentage=.8,this.canRotation=!0,this.onMouseWheel=!0,this.noteHiddenLine=!1,this.canPickModel=!1,this.UseBackImage=!1,this.IsShowAxis=!0,this.IsShowFPS=!1,this.IsNoteFrontDisplay=!1,this.IsUseVBO=!1,this.IsTouchRotation=!1,this.OpenGLESVersion=2,this.IsHighPerformanceView=!1,this.IsUseAnimationCamera=!1,this.IsUseCatiaMode=!1,this.IsUseIndexMode=!0,this.IsUseBoxMoving=!1,this.NeverSeeScreenPixelSize=5,this.camera3dMode=0,this.useCubeMapping=!1,this.simplityMode=!1,this.bufferType=1,this.foucsScalFactor=.5}return t.Instance=function(){return t.instance==null&&(t.instance=new t,t.instance.screenPPI=e.ShapeHelper.getDPI()[0]),t.instance},t.instance=null,t}();e.Parameters=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(e){this.selectorListeners=[],this.selectList=[],this.scene=null,this.scene=e}return t.prototype.Set=function(e){this.Clear(),this.Add(e)},t.prototype.Add=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];if(t[0]instanceof e.Shape){var r=t[0],i=!0;if(this.selectorListeners!==null&&this.selectorListeners!==undefined)for(var s=0,o=this.selectorListeners;s<o.length;s++){var u=o[s],a=u.onBeforeSelect(this,r);i&&!a&&(i=!1)}if(i){r.SetSelected(!0),this.selectList.push(r);if(this.selectorListeners!==null&&this.selectorListeners!==undefined)for(var f=0,l=this.selectorListeners;f<l.length;f++){var u=l[f];u.onSelected(this,r)}this.scene.GetRenderManager().RequestRedraw()}}else if(t[0]instanceof Array){var c=t[0];for(var h=0;h<c.length;h++){var r=c[h];r.SetSelected(!0),this.selectList.push(r)}if(this.selectorListeners!==null&&this.selectorListeners!==undefined)for(var p=0,d=this.selectorListeners;p<d.length;p++){var u=d[p];u.onShapesSelected(this,c)}this.scene.GetRenderManager().RequestRedraw()}},t.prototype.Remove=function(e){e.SetSelected(!1);var t=0;while(t!==this.selectList.length){if(e.GetID()===this.selectList[t].GetID()){this.selectList.splice(t,1);break}t++}if(this.selectorListeners!==null&&this.selectorListeners!==undefined)for(var n=0,r=this.selectorListeners;n<r.length;n++){var i=r[n];i.onUnSelected(this,e)}this.scene.GetRenderManager().RequestRedraw()},t.prototype.Clear=function(){for(var e=0;e<this.selectList.length;e++){var t=this.selectList[e];t.SetSelected(!1)}if(this.selectorListeners!==null&&this.selectorListeners!==undefined)for(var n=0,r=this.selectorListeners;n<r.length;n++){var i=r[n];i.onClearSelected(this)}this.selectList.length=0,this.scene.GetRenderManager().RequestRedraw()},t.prototype.GetAll=function(){return this.selectList},t.prototype.Count=function(){return this.selectList.length},t.prototype.Exist=function(e){var t=0;while(t!==this.selectList.length){if(e.GetID()===this.selectList[t].GetID())return!0;t++}return!1},t.prototype.SetListeners=function(e){this.selectorListeners=e},t.prototype.GetListeners=function(){return this.selectorListeners},t.prototype.AddListener=function(e){return e!==null&&e!==undefined&&this.selectorListeners.indexOf(e)===-1&&this.selectorListeners.push(e),!0},t.prototype.RemoveListener=function(e){return e!==null&&e!==undefined&&this.selectorListeners.indexOf(e)!==-1&&this.selectorListeners.splice(this.selectorListeners.indexOf(e),1),!0},t.prototype.Get=function(){return this.selectList.length===0?null:this.selectList[0]},t}();e.Selector=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){this.interpolatorCount=1e3,this.cameraAnimationTimer=500,this.modelExplosiveAnimationTimer=500,this.timerKeepMsecond=30,this.updateModelMap={},this.isChangeModelView=!1,this.viewIdArray=[],this.renderManager=null,this.sceneManager=null,this.walkthroughHandler=null,this.workTouchHandler=null,this.commonTouchHandler=null,this.draggerHandler=null,this.selector=null,this.usingTouchHandlerType=e.TouchHandlerType.HANDLER_COMMON,this.backgroundNode=null,this.axisNode=null,this.explosiveViewOperator=null,this.pSAManager=null,this.animationPlaySpeed=1,this.animationContinuousPlay=!1,this.isAnimationPlayCamera=!1,this.isAnimationShowPMI=!1,this.isNeedChangeViewAnimation=!1,this.pTDriver=null,this.modleViewsList=[],this.modelManager=null,this.curModelView=null,this.isInitialized=!1}return t.prototype.Initial=function(t){if(!this.isInitialized){this.pWorkNodeGroup=new e.WorkNodes,this.isInitialized=!0,this.commonTouchHandler=new e.CommonTouchHandler,this.draggerHandler=new e.DraggerHandler,this.walkthroughHandler=new e.WalkthroughHandler,this.draggerManager=new e.DraggerManager(this),this.workTouchHandler=this.commonTouchHandler,this.sceneManager=new e.SceneManager,this.sceneManager.GetRenderManager().InitialRender(t),this.SetSceneManager(this.sceneManager),this.selector=new e.Selector(this.sceneManager);var n=new e.Camera;n.SetName(e.MAINCAMERA),this.sceneManager.SetCamera(n),n.SetSceneManager(this.sceneManager);var r=this.sceneManager.GetSceneRoot();r.SetName(e.ROOT);var i=new e.BackgroundNode;i.SetName(e.BACKGROUNDCOLOR),r.AddChild(i),this.backgroundNode=i;var s=new e.AxisNode;s.SetName(e.AXIS),r.AddChild(s),this.axisNode=s;var o=new e.HandlerGroup(this.sceneManager);o.SetName(e.HANDLER_GROUPNODE),r.AddChild(o),this.setCookie();var u=new e.GroupNode;u.SetName(e.MAINGROUP),r.AddChild(u),this.pSAManager===null&&(this.pSAManager=e.SimulationAnimationManager.Instance()),this.pTDriver===null&&(this.pTDriver=new e.Timer,this.pTDriver.SetTimer(this.AnimationTick,this,10))}},t.prototype.setCookie=function(){this.SetCookieBackColor(),this.SetCookieCatia(),this.SetCookieContinueRotate(),this.SetCookieMergeFace(),this.SetCookieHighPerformance(),this.SetCookieMeasureUnit(),this.SetCookieRemoveSmallSize(),this.SetCookieRemoveSmallThing(),this.SetCookieSelectType(),this.SetCookieRoamAutomatic(),this.SetCookieUseLOD(),this.SetCookieUsePMI(),this.SetCookieEdgeSelectorColor()},t.prototype.AnimationTick=function(t){var n=new Date;e.HTManager.GetHTManager().Tick(n.getTime()/1e3)},t.prototype.InitCamera=function(){this.workTouchHandler.Open()},t.prototype.ReSetCamera=function(){this.workTouchHandler.RefreshModelViewCamera()},t.prototype.SetSceneManager=function(e){this.sceneManager=e,this.commonTouchHandler.SetView(this),this.draggerHandler.SetView(this),this.walkthroughHandler.SetView(this)},t.prototype.SetRenderManager=function(e){this.renderManager=e},t.prototype.GetSceneManager=function(){return this.sceneManager},t.prototype.WindowSizeChange=function(e,t){this.sceneManager.GetRenderManager().WindowSizeChanged(e,t)},t.prototype.RestoreView=function(){this.model&&(this.model.SetVisible(!0),this.model.ResetColor()),this.commonTouchHandler.Reset(),this.draggerHandler.Reset(),this.walkthroughHandler.Reset(),this.sceneManager.Reset(),this.selector!==null&&this.selector.Clear(),this.InitCamera()},t.prototype.SetPerspective=function(t){e.PerspectiveOperator.GetInstance().Show(this,t)},t.prototype.CloseFile=function(){this.selector!==null&&this.selector.Clear(),this.commonTouchHandler.Reset(),this.draggerHandler.Reset(),this.walkthroughHandler.Reset(),this.model,this.model=null,this.sceneManager.RemoveModel()},t.prototype.ReadModel=function(t){this.CloseFile(),this.model=t,this.model.SetModleViewList(this.GetModelViewsList());var n=e.M3D_STATUS.Read_NO_DEFINE_Error;return this.sceneManager.SetModel(this.model),this.RestoreView(),this.SetDefaultWorkNodes(),n=e.M3D_STATUS.Read_OK,n},t.prototype.CloseSceneAnimation=function(){return this.commonTouchHandler.CloseKeepState(),this.draggerHandler.CloseKeepState(),!0},t.prototype.SetDefaultWorkNodes=function(){if(this.sceneManager==null)return;this.pWorkNodeGroup.AddNode(e.MAINCAMERA,this.sceneManager.GetCamera()),this.pWorkNodeGroup.AddNode(e.MAINMODELROOT,this.sceneManager.GetSceneRoot().Search(e.MAINMODELROOT)),this.pWorkNodeGroup.AddNode(e.AXIS,this.sceneManager.GetSceneRoot().Search(e.AXIS)),this.pWorkNodeGroup.AddNode(e.FPS_FLAG,this.sceneManager.GetSceneRoot().Search(e.FPS_FLAG))},t.prototype.ReadFile=function(t){var n=e.M3D_STATUS.Read_NO_DEFINE_Error,r=this.GetSceneManager();return this.model=this.reader.ReadFile(this.curFilePath),this.sceneManager.SetModel(this.model),this.sceneManager.OptimizeScene(),this.RestoreView(),n=e.M3D_STATUS.Read_OK,n},t.prototype.SetCameraProjectionType=function(t){var n=this.sceneManager.GetCamera(),r=n.GetFov();if(t==1){if(n.IsOrthographic()){var i=n.GetZoom(),s=this.sceneManager.GetDefaultZoom();n.SetZoom(s);var o=s/i,u=n.GetWorldPosition(),a=e.Vector3.ZERO().Clone(),f=n.GetViewPort().GetRect().Center(),l=f.Clone();this.sceneManager.GetPickPoint(l,a,!1);var c=this.sceneManager.GetDefaultFocusLength(),h=c/90*o/(e.Tan(r*.5/180*e.PI)*2),p=u.Sub(a).Normalized();n.SetWorldPosition(a.Add(p.Multiply(h))),n.SetOrthographic(!1)}}else if(t==0&&!n.IsOrthographic()){var i=n.GetZoom(),s=this.sceneManager.GetDefaultZoom();n.SetZoom(s);var u=n.GetWorldPosition(),a=new e.Vector3,f=n.GetViewPort().GetRect().Center();this.sceneManager.GetPickPoint(f,a,!1);var d=this.sceneManager.GetDefaultFocusLength(),c=this.sceneManager.GetDefaultFocusLength(),o=a.Sub(u).Length()/(c/90)*e.Tan(r*.5/180*e.PI)*2,p=u.Sub(a).Normalized().Multiply(c);n.SetWorldPosition(a.Add(p)),n.ZoomView(1/o),n.SetOrthographic(!0)}},t.prototype.GetCameraProjectionType=function(){var e=0,t=this.sceneManager.GetCamera();return t!=null&&(e=t.IsOrthographic()?0:1),e},t.prototype.GetSelector=function(){return this.selector},t.prototype.GetPickShape=function(e,t,n,r){return this.sceneManager!==null?this.sceneManager.GetPickShape(e,t,n,r):null},t.prototype.SetRotationCenter=function(e,t){if(this.sceneManager!==null){var n=this.sceneManager.SetRotationCenterByScreenPnt(e,t);if(n===!0)return this.sceneManager.GetRenderManager().RequestRedraw(),!0}return!1},t.prototype.TouchDown=function(t,n){this.workTouchHandler.HandleTouchEvent(t,n,e.CommonTouchHandler.TOUCHDOWN)},t.prototype.TouchMove=function(t,n,r){this.workTouchHandler.HandleTouchEvent(n,r,e.CommonTouchHandler.TOUCHMOVE,t)},t.prototype.TouchUp=function(t,n){this.workTouchHandler.HandleTouchEvent(t,n,e.CommonTouchHandler.TOUCHUP)},t.prototype.OnDraw=function(){this.sceneManager.GetRenderManager().OnDraw()},t.prototype.GetWorkNodes=function(){return this.pWorkNodeGroup},t.prototype.SetClipPlane=function(t,n,r,i){e.SectionOperator.Show(this,t,n,r,i)},t.prototype.ClearClipPlane=function(){e.SectionOperator.Clear(this)},t.prototype.SetExplosiveView=function(e,t,n){this.GetExplosiveView().SetPercent(this,e,t,n)},t.prototype.SetExplosiveViewNoRestore=function(e,t,n){this.GetExplosiveView().SetPercentNoRestore(this,e,t,n)},t.prototype.GetExplosiveView=function(){return this.explosiveViewOperator===null&&(this.explosiveViewOperator=new e.ExplosiveViewOperator,this.explosiveViewOperator.SetView(this)),this.explosiveViewOperator},t.prototype.CloseExplosiveView=function(){this.explosiveViewOperator!==null&&this.explosiveViewOperator.Close(this)},t.prototype.SetUsingTouchHandlerType=function(t){if(this.usingTouchHandlerType===t)return;this.usingTouchHandlerType=t,this.usingTouchHandlerType===e.TouchHandlerType.HANDLER_WALKTHROUGH?(this.workTouchHandler.Close(),this.workTouchHandler=this.walkthroughHandler,this.SetCameraProjectionType(1)):this.usingTouchHandlerType===e.TouchHandlerType.HANDLER_COMMON?(this.SetCameraProjectionType(0),this.workTouchHandler=this.commonTouchHandler):this.usingTouchHandlerType===e.TouchHandlerType.HANDLER_DRAGGER&&(this.SetCameraProjectionType(0),this.workTouchHandler=this.draggerHandler)},t.prototype.GetUsingTouchHandlerType=function(){return this.usingTouchHandlerType},t.prototype.GetTouchHandler=function(){return this.workTouchHandler},t.prototype.SetConRotate=function(t){e.Parameters.Instance().IsConRotate=t},t.prototype.SetMergeFace=function(t){e.Parameters.Instance().isMergeFace=t},t.prototype.SetCatia=function(t){e.Parameters.Instance().IsUseCatiaMode=t},t.prototype.SetHighPerformance=function(t){e.Parameters.Instance().IsHighPerformanceView=t},t.prototype.SetUseLOD=function(t){e.Parameters.Instance().IsUseLOD=t},t.prototype.SetUsePMI=function(t){e.Parameters.Instance().IsShowPMIs=t},t.prototype.SetEdgeSelector=function(t){e.Parameters.Instance().outlineColor=t},t.prototype.SetRoamAutomatic=function(t){e.Parameters.Instance().IsUseAnimationCamera=t},t.prototype.SetRemoveSmallThing=function(t){e.Parameters.Instance().RemoveMode=t},t.prototype.SetRemoveSmallSize=function(t){e.Parameters.Instance().RemoveSize=t},t.prototype.SetMeasureUnit=function(t){e.Parameters.Instance().measureUnitStyle=t},t.prototype.SetBackgroundColor=function(t,n){var r=!1,i=e.BACKGROUNDCOLOR,s=this.GetSceneManager().GetSceneRoot().Search(e.BACKGROUNDCOLOR);return s!==null?(s.SetTopColor(t),s.SetBottomColor(n)):r=!1,r},t.prototype.GetBackgroundColor=function(t,n){var r=!1,i=this.GetSceneManager().GetSceneRoot().Search(e.BACKGROUNDCOLOR);return i!==null?(i.GetTopColor(t),i.GetBottomColor(n)):r=!1,r},t.prototype.SetBackgroundImage=function(t){var n=!1,r=this.GetSceneManager().GetSceneRoot().Search(e.BACKGROUNDCOLOR);return r!==null&&(r.SetImage(t),n=!0),n},t.prototype.SetBackgroundUseImage=function(t){var n=this.GetSceneManager().GetSceneRoot().Search(e.BACKGROUNDCOLOR);n!==null&&n.SetUseImage(t)},t.prototype.GetBackgroundUseImage=function(){var t=!1,n=this.GetSceneManager().GetSceneRoot().Search(e.BACKGROUNDCOLOR);return n!==null&&(t=n.IsUseImage()),t},t.prototype.SetBackgroundTexture=function(t){var n=this.GetSceneManager().GetSceneRoot().Search(e.BACKGROUNDCOLOR);n!==null&&n.SetTexture(t)},t.prototype.AddBackgroundSkyBoxTexture=function(t,n){var r=this.GetSceneManager().GetSceneRoot().Search(e.BACKGROUNDCOLOR);r!==null&&r.AddSkyBoxTexture(t,n)},t.prototype.SetBackgroundUseSkyBox=function(t){var n=this.GetSceneManager().GetSceneRoot().Search(e.BACKGROUNDCOLOR);n!==null&&n.SetUseSkyBox(t)},t.prototype.GetBackgroundUseSkyBox=function(){var t=this.GetSceneManager().GetSceneRoot().Search(e.BACKGROUNDCOLOR);t!==null&&t.IsUseSkyBox()},t.prototype.SetBackgroundUseColor=function(t){var n=this.GetSceneManager().GetSceneRoot().Search(e.BACKGROUNDCOLOR);n!==null&&n.SetUseColor(t)},t.prototype.SetCookieBackColor=function(){var t=e.CookieHelper.GetCookie(e.BOTTOCOLOR_KEY),n=e.CookieHelper.GetCookie(e.TOP_COLOR_KEY);if(t&&n){var r=t.split(" "),i=n.split(" "),s=new e.Color(parseFloat(r[0]),parseFloat(r[1]),parseFloat(r[2])),o=new e.Color(parseFloat(i[0]),parseFloat(i[1]),parseFloat(i[2]));this.SetBackgroundColor(o,s)}else this.SetBackgroundColor(new e.Color(.25,.63,1),new e.Color(.88,.96,1))},t.prototype.SetCookieContinueRotate=function(){var t=e.CookieHelper.GetCookie(e.ROTATE);t?this.SetConRotate(Boolean(Number(t))):this.SetConRotate(!1)},t.prototype.SetCookieMergeFace=function(){var t=e.CookieHelper.GetCookie(e.MERGEFACE);t?this.SetMergeFace(Boolean(Number(t))):this.SetMergeFace(!0)},t.prototype.SetCookieCatia=function(){var t=e.CookieHelper.GetCookie(e.CATIA);t?this.SetCatia(Boolean(Number(t))):this.SetCatia(!1)},t.prototype.SetCookieHighPerformance=function(){var t=e.CookieHelper.GetCookie(e.HIGHPERFORMANCE);t?this.SetHighPerformance(Boolean(Number(t))):this.SetHighPerformance(!1)},t.prototype.SetCookieUseLOD=function(){var t=e.CookieHelper.GetCookie(e.USELOD);t?this.SetUseLOD(Boolean(Number(t))):this.SetUseLOD(!1)},t.prototype.SetCookieUsePMI=function(){var t=e.CookieHelper.GetCookie(e.USEPMI);t?this.SetUsePMI(Boolean(Number(t))):this.SetUsePMI(!1)},t.prototype.SetCookieEdgeSelectorColor=function(){var t=e.CookieHelper.GetCookie(e.EDGECOLOR);if(t){var n=t.split(" "),r=new e.Color(parseFloat(n[0]),parseFloat(n[1]),parseFloat(n[2]));this.SetEdgeSelector(r),e.Color.selectColor=r}else{var r=new e.Color(1,0,0);this.SetEdgeSelector(r),e.Color.selectColor=r}},t.prototype.SetCookieRoamAutomatic=function(){var t=e.CookieHelper.GetCookie(e.ROAMAUTOMATIC);t?this.SetRoamAutomatic(Boolean(Number(t))):this.SetRoamAutomatic(Boolean(Number(t)))},t.prototype.SetCookieSelectType=function(){var t=e.CookieHelper.GetCookie(e.SELECTTYPE),n=1;t&&(n=Number(t=="1"?1:t=="2"?2:3)),e.Parameters.Instance().selectedStyle=n},t.prototype.SetCookieRemoveSmallThing=function(){var t=e.CookieHelper.GetCookie(e.REMOVESMALLTHING);t?this.SetRemoveSmallThing(Number(t=="model"?"0":"1")):this.SetRemoveSmallThing(0)},t.prototype.SetCookieRemoveSmallSize=function(){var t=e.CookieHelper.GetCookie(e.REMOVESMALLSIZE);t?this.SetRemoveSmallSize(Number(t)):this.SetRemoveSmallSize(0)},t.prototype.SetCookieMeasureUnit=function(){var t=e.CookieHelper.GetCookie(e.MEASUREUNIT);t?this.SetMeasureUnit(Number(t)):this.SetMeasureUnit(0)},t.prototype.AnimationPlay=function(){if(!this.pSAManager)return;this.pSAManager.SetPlaySpeed(this.animationPlaySpeed),this.pSAManager.SetContinuousPlay(this.animationContinuousPlay);var t=this.pSAManager.GetAnimationStepManager();return this.pSAManager.IsPlaying()?t.Stop():(this.SaveAnimatinState(),t.SetPlayMode(e.AnimationPlayMode.PLAY_MODE_PROCESS),t.Pause(),t.Play(e.AnimationPlayMode.PLAY_MODE_PROCESS)),!0},t.prototype.SaveAnimatinState=function(){},t.prototype.AnimationContinuousPlayState=function(){var e=this.animationContinuousPlay;return this.pSAManager&&(e=this.pSAManager.GetContinuousPlay()),e},t.prototype.AnimationContinuousPlay=function(e){var t=!1;return this.animationContinuousPlay=e,this.pSAManager&&this.pSAManager.SetContinuousPlay(e),t},t.prototype.AnimationRewind=function(){if(this.pSAManager)return!1;var t=this.pSAManager.GetAnimationStepManager();return t===null?!1:(t.Rewind(e.AnimationPlayMode.PLAY_MODE_PROCESS,!1),this.RestoreAnimationState(),!0)},t.prototype.RestoreAnimationState=function(){e.PerspectiveOperator.GetInstance().FinishAnimation(),this.isNeedChangeViewAnimation=!0},t.prototype.AnimationSetTick=function(e){var t=this.pSAManager.GetCurrentSA();return t?(this.pSAManager.IsPlaying()?(this.pSAManager.StopAll(),t.SetCurrentTickByPercentage(e),t.ExecuteAnimations(t.GetCurrentTick(),0),t.Continue()):(t.SetCurrentTickByPercentage(e),t.ExecuteAnimations(t.GetCurrentTick(),0)),!0):!1},t.prototype.AnimationGetTick=function(){var e=0;if(this.pSAManager!==null){var t=this.pSAManager.GetAnimationStepManager();if(t){var n=t.GetCurrentProcess();if(n){var r=n.GetBehaviorManager();r&&(e=r.GetCurrentTickByPercentage())}}}return e},t.prototype.AnimationIsPlaying=function(){return this.pSAManager===null?!1:this.pSAManager.IsPlaying()},t.prototype.AnimationTransitionIsPlaying=function(){return this.pSAManager===null?!1:this.pSAManager.GetAnimationStepManager().GetBehaviorActionChgCam()!==null},t.prototype.AnimationExecute=function(e){var t=this.pSAManager.GetCurrentSA();if(t===null)return!1;t.ScheduleAllAnimations(!0),t.SetCurrentTickByPercentage(e),t.ExecuteAnimations(t.GetCurrentTick(),0)},t.prototype.AnimationPlayCamera=function(e){return this.isAnimationPlayCamera=e,!0},t.prototype.AnimationPlaySpeed=function(e){var t=!0;this.animationPlaySpeed=e;if(e>0&&e<10&&this.pSAManager!==null){var n=this.pSAManager.GetCurrentSA();if(n===null)return!1;if(this.pSAManager.IsPlaying()){n.Stop(),n.GetSimulationAnimationManager().SetPlaySpeed(this.animationPlaySpeed);var r=n.IsReversePlay();n.ScheduleAllAnimations(!0),r?n.ContinueReverse():n.Continue()}else n.GetSimulationAnimationManager().SetPlaySpeed(this.animationPlaySpeed)}else t=!1;return t},t.prototype.AnimationSetActiveStep=function(e,t){var n=!1,r=this.pSAManager.GetAnimationStepManager(),i=r.FindProcessManagerByID(e);return i&&(i.SetCurProcessByID(t),n=!0),n},t.prototype.AnimationGetPlayCamera=function(){return this.isAnimationPlayCamera},t.prototype.OnAnimationTick=function(){this.AnimationTick(null)},t.prototype.GetSimulationMgr=function(){return this.pSAManager},t.prototype.AnimationGetInfo=function(){var t=[];if(!this.pSAManager.HasAnimations())return t;var n=this.GetSimulationMgr
(),r=-1;if(n){var i=n.GetAnimationStepManager();if(i){var s=i.GetProcessManagerList();if(!s)return t;var o=null;for(var u=0;u<s.length;u++){r++,o=s[u];if(!o)return t;var a=o.GetProcessList();if(!a)return t;var f=new e.SAnimationProcess(this);f.SetId(o.GetID()),f.SetName(o.GetName()),t.push(f);var l=null;for(var c=0;c<a.length;c++){r++,l=a[c];var h=new e.SAnimationStep(this);h.SetName(l.GetName()),h.SetId(l.GetID());var p=l.GetDesc();p.replace("\r\n","--;;--"),h.SetStepInfo(p),h.SetProcessId(o.GetID()),f.AddStep(h)}}}}return t},t.prototype.HasAnimations=function(){return this.pSAManager.HasAnimations()},t.prototype.AnimationIit=function(){var e=this.pSAManager.BehaviorManagerList;for(var t=0;t<e.length;t++)e[t].DeleteAllAnimation()},t.prototype.FoucusView=function(t,n,r){var i=this.GetSceneManager(),s=i.GetCamera(),o=null,u=null,a=null,f=!1;if(s!=null&&s.IsOrthographic()){var l=t.Center(),c=s.GetViewPort().WorldToScreenPoint(l),h=n,p=s.GetViewPort().ScreenToWorldPoint(c.x,c.y,.5),d=s.GetViewPort().ScreenToWorldPoint(h.x,h.y,.5),v=p.Sub(d),m=s.GetWorldPosition().Clone();m=m.Add(v),o=m;var g=i.GetRenderManager().GetWindowHeight(),y=i.GetRenderManager().GetWindowWidth();i.GetRenderManager().WindowSizeChanged(y,g);var b=e.Parameters.Instance().DefaultZoomFactor;b=b*g/y,g>y&&(b=b*.5*(y*1/g));var w=i.GetSceneBox(),E=1.3*b*w.Length()/t.Length();a=new e.Vector3(E,E,E),u=s.GetRotation().Clone()}else if(s&&!s.IsOrthographic()){var l=t.Center();i.SetRotationCenter(l);var S=s.GetFitClip(),h=s.GetViewPort().GetRect().Center(),d=s.GetViewPort().ScreenToWorldPoint(h.x,h.y,S),p=l,v=p.Sub(d),m=s.GetWorldPosition().Clone();m=m.Add(v);var w=i.GetSceneBox(),x=t.Length()*.6;v=l.Sub(m).Normalized().Multiply(x);var E=s.GetZoom();a=new e.Vector3(E,E,E),u=s.GetRotation().Clone(),o=l.Sub(v)}return u=u.Inverse(),r?(e.PerspectiveOperator.GetInstance().ExecuteCommonCameraAnimation(this,o,u,a,!0,!1,!0),f=!0):(s.SetRotation(u),s.SetWorldPosition(o),s.SetZoom(a.x),f=!0),f},t.prototype.GetModelManager=function(){return this.modelManager===null&&(this.modelManager=new e.ModelManager(this)),this.modelManager},t.prototype.GetModelBySVLPath=function(t){var n=null,r=e.PathHelper.SVLPathToM3D(t),i=this.GetSceneManager(),s=i.GetNode(r);return s&&s instanceof e.Model&&(n=s),n},t.prototype.addHandler=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];if(e.length===3){var n=e[0],r=e[1],i=e[2];return this.GetSceneManager().AddHandle(n,r,i)}var n=e[0],r=e[1],s=e[2],i=e[3];return this.GetSceneManager().AddHandle(n,r,s,i)},t.prototype.addShape=function(){var e=[];for(var t=0;t<arguments.length;t++)e[t]=arguments[t];if(e.length===4){var n=e[0],r=e[1],i=e[2],s=e[3];return this.GetSceneManager().AddShape(n,r,i,s)}var n=e[0],r=e[1],s=e[2];return this.GetSceneManager().AddShape(n,r,s)},t.prototype.RemoveShape=function(t){e.LOGE("View::RemoveShape"),this.GetSceneManager().RemoveShape(t)},t.prototype.GetShapePos=function(t,n,r){var i=new e.Vector3;this.GetSceneManager().GetShapePos(t,n,i),r[0]=i.x,r[1]=i.y,r[2]=i.z},t.prototype.AddLineLengthNote=function(e,t,n){return-1},t.prototype.AddRadiusLengthNote=function(e,t,n){return-1},t.prototype.moveRadiusLengthNote=function(e,t,n){},t.prototype.GetShapeColor=function(e,t){return this.GetSceneManager().GetShapeColor(e,t)},t.prototype.InterpolatorCamera=function(t){var n=t.GetSceneManager().GetCamera(),r=(new Date).getTime(),i=Math.round(t.interpolatorCount*(r-t.startTime)/t.cameraAnimationTimer);r-t.startTime>t.cameraAnimationTimer&&(i=t.interpolatorCount-1);var s=t.midRotation[i];s&&n.SetRotation(s);var o=t.midScale[i];o&&n.SetZoom(o);var u=t.midTran[i];if(u){n.SetPosition(u);var a=t.sceneManager.GetSceneBox();if(n.IsOrthographic()){var f=n.GetPosition();if(a.IsInside(f)==e.INSIDE){var l=n.GetView().ToMatrix3(),c=new e.Vector3(l.data[6],l.data[7],l.data[8]);c.Normalize();var h=f.Add(c.Multiply(a.Length()));n.SetWorldPosition(h)}}}i>=t.interpolatorCount-1&&(t.StopModelViewAnimation(),n.isAnimation=!1,Object.getOwnPropertyNames(t.updateModelMap).length>0?t.StartAnimation(t.InterPolatorModel,t):(t.isChangeModelView=!1,t.ShowLinkStoryListener&&t.ShowLinkStoryListener()))},t.prototype.InterPolatorModel=function(t){var n=(new Date).getTime(),r=Math.round(t.interpolatorCount*(n-t.startTime)/t.modelExplosiveAnimationTimer);if(n-t.startTime>t.modelExplosiveAnimationTimer||r===t.interpolatorCount)r=t.interpolatorCount-1;for(var i in t.updateModelMap){var s=t.GetShapeBySVLPath(i);if(s){var o=t.updateModelMap[i][0],u=t.updateModelMap[i][1];if(o[r]&&u[r]){var a=new e.Matrix4(o[r],u[r],s.GetPlaceMatrix().Scale());s.SetPlaceMatrix(a)}else console.log("没有获取到该差值数据")}}r>=t.interpolatorCount-1&&(t.StopModelViewAnimation(),t.isChangeModelView=!1,t.updateModelMap={},e.AnimationHelper.RemoveTrochoid("ModelViewTrochoid",t),t.ShowLinkStoryListener&&t.ShowLinkStoryListener())},t.prototype.GetModelViewAnimationTimer=function(){return this.modelViewAnimationTimer||(this.modelViewAnimationTimer=new e.Timer),this.modelViewAnimationTimer},t.prototype.StopModelViewAnimation=function(){this.GetModelViewAnimationTimer().IsStart()&&this.modelViewAnimationTimer.StopTimer(),this.midRotation=[],this.midScale=[],this.midTran=[]},t.prototype.StartAnimation=function(e,t){t.startTime=(new Date).getTime(),t.GetModelViewAnimationTimer().SetTimer(e,t,this.timerKeepMsecond),t.GetModelViewAnimationTimer().StartTimer()},t.prototype.setCameraAnimationTime=function(e){this.cameraAnimationTimer=e},t.prototype.setModelExplosiveAnimationTime=function(e){this.modelExplosiveAnimationTimer=e},t.prototype.ShowModelView=function(t,n,r,i){var s=this.GetModel(),o=s.GetModleView(t);if(o==null){e.LOGE("modleViewId:%d not found!",t);return}this.StopModelViewAnimation(),this.updateModelMap={},e.AnimationHelper.RemoveTrochoid("ModelViewTrochoid",this),this.isChangeModelView=!0;var u=o.GetInstanceAttributeMap(),a="ModelViewTrochoid";for(var f=0;f<u.Keys().length;f++){var l=u.Values()[f],c=this.GetShapeBySVLPath(l.path);if(c&&c.GetType()==e.ShapeType.SHAPE_MODEL){var h=c;h.SetVisible(l.visible);if(!l.placeMatrix.Equals(h.plcMatrix))if(r){var p=new e.Vector3,d=new e.Quaternion,v=new e.Vector3;h.GetPlaceMatrix().Decompose(p,d,v);var m=new e.Vector3,g=new e.Quaternion;l.placeMatrix.Decompose(m,g,v);var y=[],b=[];e.M3DTOOLS.VecSlerp(p,m,this.interpolatorCount,y),e.M3DTOOLS.RotationSlerp(d,g,this.interpolatorCount,b),this.updateModelMap[l.path]=[y,b];var w=h.GetParent().GetWorldTransform(),E=new e.Vector3,S=new e.Vector3;h.GetParent().GetParent()?(E=w.Multiply(m),S=w.Multiply(p)):(E=m,S=p),e.Parameters.Instance().isShowAniTrochoid&&e.AnimationHelper.AddTrochoid([S,E],a,this)}else h.SetPlaceMatrix(l.placeMatrix)}else console.log("didn`t find model")}if(o.GetUpDataCameraState()){var x=o.GetCamera(),T=this.GetSceneManager().GetCamera(),N=x.GetPosition(),C=this.sceneManager.GetSceneBox();n?(this.StopModelViewAnimation(),e.M3DTOOLS.VecSlerp(T.GetPosition(),N,this.interpolatorCount,this.midTran),e.M3DTOOLS.RotationSlerp(T.GetRotation(),x.GetRotation(),this.interpolatorCount,this.midRotation),e.M3DTOOLS.FloatSlerp(T.GetZoom(),x.GetZoom(),this.interpolatorCount,this.midScale),this.startTime=(new Date).getTime(),T.isAnimation=!0,this.StartAnimation(this.InterpolatorCamera,this)):(T.SetPosition(N),T.SetRotation(x.GetRotation()),T.SetZoom(x.GetZoom()),Object.getOwnPropertyNames(this.updateModelMap).length>0&&this.StartAnimation(this.InterPolatorModel,this))}else Object.getOwnPropertyNames(this.updateModelMap).length>0&&this.StartAnimation(this.InterPolatorModel,this);var k=this.GetSceneManager().GetSection(),L=k.GetPlaneList();if(L.length>0)for(var f=0;f<L.length;f++){var A=L[f];A.GetEnable()&&A.SetEnable(!1)}var O=o.GetSectionPlaneIDList();if(O.length>0)for(var f=0;f<L.length;f++){var M=L[f];for(var _=0;_<O.length;_++)if(O[_]==M.GetID()){M.SetEnable(!0);break}}var D=this.GetSceneManager().GetExtendInfoManager(),P=D.GetModelPMIRef(this.GetModel().GetProtoTypeId());if(P!==null&&P.length>0){if(o.GetViewType()===0)for(var H=0;H<P.length;H++){var B=D.pmiMap.Get(P[H]);B&&B.SetVisible(!0)}}else{for(var H=0;H<P.length;H++){var B=D.pmiMap.Get(P[H]);B&&B.SetVisible(!1)}for(var f=0;f<o.GetPMIList().length;f++){var j=o.GetPMIList()[f],B=D.pmiMap.Get(P[f]);B&&B.SetVisible(!0)}}},t.prototype.GetShapeBySVLPath=function(t){var n=e.PathHelper.SVLPathToM3D(t);return this.GetShapeByM3DPath(n)},t.prototype.GetShapeByM3DPath=function(e){var t=null;return t=this.GetSceneManager().GetShape(e),t},t.prototype.SetCurrentModelView=function(e){this.curModelView=e},t.prototype.GetCurrentModelView=function(){return this.curModelView?this.curModelView:this.GetDefaultModelView()},t.prototype.LoadModelViewList=function(e){console.log("LoadMV"+(new Date).toISOString());var t=new SView.ViewManager;return this.modleViewsList=t.GetModleViewList(e,this.modleViewsList),this.modleViewsList},t.prototype.GetModelViewsList=function(){return this.modleViewsList.length>0?this.modleViewsList:this.GetModel().GetModelViewList()},t.prototype.GetModel=function(){return this.model},t.prototype.LoadAllUserViews=function(t){var n=!1,r=[];r=this.LoadModelViewList(t);for(var i=0;i<r.length;i++){var s=r[i];s.SetUpDataCamera(!0),s.SetUpDataModel(!0),this.GetModel().AddModelView(s)}return n=!0,e.LOGI("viewCnt:%d",r.length),e.LOGI("View::LoadAllUserViews end. "),n},t.prototype.AddModelView=function(){var t=(new Date).toISOString(),n=new e.ModleView;n.SetName(t),n.SetViewType(2);var r=this;r.UpdateViewByCurrentScene(n),r.GetModel().AddModelView(n)},t.prototype.RemoveModelView=function(e){var t=this;t.GetModel().RemoveModelView(e)},t.prototype.GetDefaultModelView=function(){var t=null,n=this.GetModel().GetModelViewList();for(var r=0;r<n.length;r++)if(n[r].GetViewType()===e.ViewTypeEnum.DefaultView){t=n[r],e.LOGI("DefaultModelView found!");break}return t==null&&(t=new e.ModleView,t.SetViewType(e.ViewTypeEnum.DefaultView),t.SetName("DefaultView"),this.GetModel().AddModelView(t)),t},t.prototype.UpdateViewByCurrentScene=function(t){var n=!1;if(!t)return n;var r=this.GetSceneManager().GetCamera();t.SetCamera((new e.Camera).Clone(r)),t.SetUpDataCamera(!0),t.SetUpDataModel(!0);var i=new e.Map,s=[],o=this.GetSceneManager().GetModel();console.log("GetSubModelCount"+o.GetSubModelCount()),s.push(o),o.GetAllSubModels(s);for(var u=0;u<s.length;u++){var a=new e.InstanceAttribute,f=s[u];a.id=f.GetID(),a.path=e.PathHelper.M3DPathToSVLPath(f.GetSVLPath()),a.visible=f.IsVisible(),a.hasColor=!0,a.insColor=f.GetDrawColor(),a.placeMatrix=new e.Matrix4(f.plcMatrix),i.Put(a.id,a)}t.setInstanceAttributeMap(i);if(this.GetSceneManager().GetSectionNode()){var l=this.GetSceneManager().GetSection();if(l){var c=this.GetSceneManager().GetModel();t.ClearSectionPlaneId();var h=l.GetPlaneList();if(h)for(var u=0;u<h.length;u++){var p=h[u];if(!p)continue;if(p.GetEnable()){var d=c.GetSectionPlaneList(),v=0;d&&(v=d.length),t.AddSectionPlaneId(p.GetID());if(!c.GetSectionPlane(p.GetID())){var m=new e.SectionPlane;m.Copy(p),c.AddSectionPlane(m)}}}}}return e.LOGI("end update textnote by current scene"),n=!0,n},t.prototype.CreateDefaultView=function(e){this.enableCreateDefaultView=e},t.prototype.GetMVListXMLStr=function(){var e="";for(var t=0;t<this.modleViewsList.length;t++){var n="",r=this.modleViewsList[t].GetInstanceAttributeMap();e+='<View ID="'+this.modleViewsList[t].GetID()+'" Name="'+this.modleViewsList[t].GetName()+'" Type="'+this.modleViewsList[t].GetViewType()+'"> <Camera '+this.modleViewsList[t].GetCamera().toString()+'/> <BackgroundColor/><Notes>< GestureNote ID= "0" Created= "" UserID= "1" Layer= "0" > <ProjectMatrix/> < Polylines /> </GestureNote> < /Notes>  < PMIs />  <SectionPlanes/><Instances>'+n+"</Instances></View><Lights/>"}var i="<SVL><Model><Notes/><Views>"+e+"</Views></Model></SVL>";return i},t.prototype.SetSelectType=function(e){if(this.sceneManager!==null)return this.sceneManager.SetSelectType(e)},t.prototype.PreSelect=function(e,t){var n=this.GetSceneManager().GetShape(e);n!==null&&n!==undefined&&(t?n.SetSelected(!0):n.SetSelected(!1))},t.prototype.SelectTempShape=function(t,n,r,i){var s=0,o=new e.Vector2(t,n),u=e.ShapeHelper.SelectShape(o,r,i,this.GetSceneManager());return u!==null&&u!==undefined&&(s=u.GetID()),s},t.prototype.UpdatePropertyImagePos=function(t,n,r){if(t!=null){var i=new e.Vector2(n,r);e.NoteFactory.UpdatePerpNoteImagePos(t,i,this.GetSceneManager())}},t.prototype.UpdateMeasureImagePos=function(t,n,r){if(t!==null)if(t instanceof e.TextNote||t instanceof e.SequenceNumberNote){var i=new e.Vector2(n,r);e.Parameters.Instance().noteHiddenLine||e.NoteFactory.UpdateNoteImagePos(t,i,this.GetSceneManager())}else{var i=new e.Vector2(n,r);e.MeasureFactory.UpdateMeasureImagePos(t,i,this.GetSceneManager())}},t.prototype.FrameSelectShape=function(e,t,n,r,i){var s=[];return this.sceneManager!==null&&(s=this.sceneManager.GetFramePickShape(e,t,n,r,i)),s},t.prototype.getDrawMode=function(){return this.curDrawMode},t.prototype.setDrawMode=function(t){window,this.curDrawMode=t;var n=this.GetSceneManager().GetRenderManager().GetRenderEffect();if(!n)return;var r,i=n.GetRenderableTypeFilter();switch(t){case 0:this.model!=null&&this.model.ResetAlpha(),i.SetRenderTypes(e.RenderableTypeGroup.RENDERDATA_NORMALEFFCT),i.Close(e.RenderableType.RGT_EDGELINE);break;case 1:case 2:i.SetRenderTypes(e.RenderableTypeGroup.RENDERDATA_NORMALEFFCT),i.Close(e.RenderableType.RGT_SOLID),i.Close(e.RenderableType.RGT_TRANSPARENT);break;case 3:i.SetRenderTypes(e.RenderableTypeGroup.RENDERDATA_NORMALEFFCT),i.Close(e.RenderableType.RGT_SOLID),i.Open(e.RenderableType.RGT_EDGELINE);break;case 4:i.SetRenderTypes(e.RenderableTypeGroup.RENDERDATA_NORMALEFFCT),e.Parameters.Instance().IsShowTrilateralEdge==1&&i.Open(e.RenderableType.RGT_TRILINE);break;case 5:i.SetRenderTypes(e.RenderableTypeGroup.RENDERDATA_NORMALEFFCT);break;case 6:this.model!=null&&this.model.ResetAlpha();break;case 7:e.Parameters.Instance().IsShowBox=!e.Parameters.Instance().IsShowBox,e.Parameters.Instance().IsShowBox==1?i.Open(e.RenderableType.RGT_BOX):e.Parameters.Instance().IsShowBox==0&&i.Close(e.RenderableType.RGT_BOX);break;default:}e.Parameters.Instance().IsShowTrilateralEdge==1?i.Open(e.RenderableType.RGT_TRILINE):e.Parameters.Instance().IsShowTrilateralEdge==0&&i.Close(e.RenderableType.RGT_TRILINE),e.Parameters.Instance().IsShowTransparent==1?this.model!=null&&this.model.SetAlpha(e.Parameters.Instance().Alpha):e.Parameters.Instance().IsShowTransparent==0&&this.model!=null&&this.model.ResetAlpha(),e.Parameters.Instance().IsShowBox==1?i.Open(e.RenderableType.RGT_BOX):e.Parameters.Instance().IsShowBox==0&&i.Close(e.RenderableType.RGT_BOX),e.Parameters.Instance().IsShowPMIs==1?i.Open(e.RenderableType.RGT_PMI):e.Parameters.Instance().IsShowPMIs==0&&i.Close(e.RenderableType.RGT_PMI),this.GetSceneManager().GetRenderManager().RequestRedraw()},t}();e.View=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(){function t(){}return t.createTextNote=function(e,n,r,i){var s=null;return s=this.createPntTextNote(e,n,r,i),s&&t.AddNoteToScene(i,s),s},t.createPropertyTextNote=function(e,n,r,i,s){var o=null;return o=this.createPropTextNote(e,n,r,i,s),o&&t.AddNoteToScene(r,o),o},t.createVoiceNote=function(e,t,n){var r=null;return r=this.createPntVoiceNote(e,t,n),r&&this.AddNoteToScene(n,r),r},t.CreateSequenceNumberNote=function(e,t,n,r){var i=null;return i=this.createPntSequenceNumberNote(e,t,n,r),i&&this.AddNoteToScene(r,i),i},t.createPropTextNote=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];var r=new e.TextNote,i,s,o,u,a,f,l,c=new e.Vector3,h;if(t[1]instanceof e.Vector2){i=t[3],u=t[2],l=t[1],f=i.GetShape(t[0]);if(!f||f.GetType()!==e.ShapeType.SHAPE_POINT_HANDLE)return r;var p=f;o=p.GetPosition();if(!i.GetPickPoint(l,c,!1))return e.LOGE("MeasureFactory::createPntToPntDistance shape is NULL"),r;r.SetTextPos(c)}else o=t[0],u=t[1],i=t[2],a=t[3],h=t[4],r.SetTextPos(o);s=i.GetCamera().WorldToScreenPoint(o),r.SetNotePos(o);var d=i.GetSceneBox().Length()/20,v=new e.Point(o);v.SetDrawType(1),v.SetSize(.8),console.log("point1",o.Tostring());var m=new e.Point(c);m.SetDrawType(1),m.SetSize(.8),console.log("point2",c.Tostring());var g=i.GetCamera().GetViewPort().GetScreenRay(s.x,s.y),y=new e.Plane(g.GetDirection(),o),b;if(t[1]instanceof e.Vector2)b=y.Project(c);else{var w=new e.Vector3;if(h)w=h;else{var E=void 0,S=void 0;E=Math.random()*800+71,S=Math.random()*500+71,i.GetPickPoint(new e.Vector2(E,S),w,!1)}b=w}var x=new e.Line3D(o,b);console.log("pntInPlane",b.Tostring());var T=new e.Color(.03,0,38,.73);x.SetColor(T),x.SetName("TextImageLeader"),r.SetTextPos(b),e.Parameters.Instance().noteHiddenLine||(r.AddLine(x),r.AddPoint(v));if(t[1]instanceof e.Vector2){var O=Object.keys(u).length,M=new e.Shape2DSet,_=0;for(var D in u){var P=16,H=450,B=e.Color.WHITE().Clone(),j=e.Color.WHITE().Clone(),F=e.Color.BLACK().Clone(),I=e.Color.BLACK().Clone(),q=e.Color.GREEN().Clone(),R=e.Color.RED().Clone(),U=e.Color.BLUE().Clone(),z=new e.Vector2(1,1+_*100),W=new e.Vector2(260,100+_*100);e.MeasureDisplayHelper.createRectImage(M,z,W,H,B,j,F,I,D,u[D],P,!0),_++}var X=null;e.MeasureDisplayHelper.addImageToMemory(i,X,M,c,5.5,O+2,r)}else{var N=null;a&&(e.MeasureDisplayHelper.createNoteTextsImageN(i,N,u,b,r),r.AddImage(N));var C=new e.ComText,k=new e.CText,L="";for(var A in u)L+=A+u[A];k.SetText(L),C.AddCText(k),r.ComTexts.push(C)}return r},t.createPntTextNote=function(t,n,r,i){var s=null,o=i.GetShape(t);if(o&&o.GetType()===e.ShapeType.SHAPE_POINT_HANDLE){s=new e.TextNote;var u=o,a=u.GetPosition();s.SetNotePos(a);var f=new e.Vector3;if(i.GetPickPoint(n,f,!1)){s.SetTextPos(f);var l=r,c=i.GetSceneBox().Length()/20,h=new e.Point(a);h.SetDrawType(1),h.SetSize(.8),console.log("point1",a.Tostring());var p=new e.Point(f);p.SetDrawType(1),p.SetSize(.8),console.log("point2",f.Tostring());var d=i.GetCamera().GetViewPort().GetScreenRay(n.x,n.y),v=new e.Plane(d.GetDirection(),a),m=v.Project(f),g=new e.Line3D(a,m);console.log("pntInPlane",m.Tostring());var y=new e.Color(.03,.38,.73);g.SetColor(y),g.SetName("TextImageLeader"),s.SetTextPos(m);var b=new e.Texts2D;b.setSize(14),b.setTexts("内容");var w=new e.Texts2D;w.setSize(14),w.setTexts(l);var E=[b,w],S=null;e.MeasureDisplayHelper.createNoteTextsImageN(i,S,E,m,s),s.AddLine(g),s.AddImage(S),s.AddPoint(h);var x=new e.ComText,T=new e.CText;T.SetText(r),x.AddCText(T),s.ComTexts.push(x)}else e.LOGE("MeasureFactory::createPntToPntDistance shape is NULL");return s}},t.createPntVoiceNote=function(t,n,r){var i=null,s=new e.Vector3;if(r.GetPickPoint(t,s,!1)){var o=new e.Vector2(1,1);i=new e.VoiceNote(s,e.ShapeHelper.GetCommonSize(r,o),r)}return i},t.createPntSequenceNumberNote=function(t,n,r,i){var s=null,o=i.GetShape(t);if(o&&o.GetType()==e.ShapeType.SHAPE_POINT_HANDLE){s=new e.SequenceNumberNote;var u=o,a=u.GetPosition();s.SetNotePos(a);var f=new e.Vector3;if(i.GetPickPoint(n,f,!1)){var l=r,c=i.GetSceneBox().Length()/20,h=new e.Point(a);h.SetDrawType(1),h.SetSize(.8);var p=new e.Point(f);p.SetDrawType(1),p.SetSize(.8);var d=i.GetCamera().GetViewPort().GetScreenRay(n.x,n.y),v=new e.Plane(d.GetDirection(),a),m=v.Project(f),g=new e.Line3D(a,m),y=new e.Color(.03,.38,.73);g.SetColor(y),g.SetName("SequenceNumberImageLeader"),s.SetTextPos(m);var b=new e.Texts2D;b.setSize(14),b.setTexts(l);var w=null;e.MeasureDisplayHelper.CreateSequenceNumberImage(i,w,b,m,s),s.AddLine(g),s.AddImage(w),s.AddPoint(h);var E=new e.ComText,S=new e.CText;S.SetText(r),E.AddCText(S),s.ComTexts.push(E),s.SetFrontShow(!1)}}return s},t.UpdatePerpNoteImagePos=function(t,n,r){var i;if(t!=null&&r!=null){var s=t.GetSceneNode(),o=void 0;s?o=s.GetWorldTransform().Clone():o=e.Matrix3x4.IDENTITY().Clone();var u=t.GetTextPos(),a=t.GetWorldTextPos(),f=r.GetCamera().GetViewPort().GetScreenRay(n.x,n.y),l=new e.Plane(f.GetDirection().Clone(),a),c=l.Project(f.GetOrigin()).Clone();i=u;var h=o.Inverse().Multiply(c);t.SetTextPos(h),r.GetRenderManager().RequestRedraw();var p=t.LineList;for(var d=0;d<p.length;d++){var v=p[d];v&&(v.GetName()=="TextImageLeader"||v.GetName()=="SequenceNumberImageLeader")&&(v.EndPoint=h.Clone())}}},t.UpdateNoteImagePos=function(t,n,r){var i;if(t!=null&&r!=null){var s=t.GetImageBoards();for(var o=0;o<s.length;o++){var u=s[o];if(u){var a=u.GetPosition().Clone(),f=r.GetCamera().GetViewPort().GetScreenRay(n.x,n.y),l=new e.Plane(f.GetDirection().Clone(),a);a=l.Project(f.GetOrigin()).Clone(),u.SetPosition(a),i=a;if(t.GetType()==e.ShapeType.SHAPE_TEXT_NOTE){var c=t;c.SetTextPos(a)}else if(t.GetType()==e.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE){var h=t;h.SetTextPos(a)}}r.GetRenderManager().RequestRedraw()}var p=t.LineList;for(var o=0;o<p.length;o++){var d=p[o];d&&(d.GetName()=="TextImageLeader"||d.GetName()=="SequenceNumberImageLeader")&&(d.EndPoint=i)}}},t.UpdateNoteTextValue=function(){var t=[];for(var n=0;n<arguments.length;n++)t[n]=arguments[n];var r=t[2],i=t[0];if(typeof t[1]=="string"){var s=t[1],o=i.GetImageBoards();for(var u=0;u<o.length;u++){var a=o[u];if(a){var f=a.GetPosition();a=null;var l=new Array,c=new e.Texts2D;c.setSize(14),c.setTexts("内容"),l.push(c);var h=new e.Texts2D;h.setSize(14),h.setTexts(s),l.push(h);var p=null;if(i.GetType()==e.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE){e.MeasureDisplayHelper.CreateSequenceNumberImage(r,p,h,f,o,u);if(i.ComTexts.length<1){var d=new e.ComText,v=new e.CText;v.SetText(s),d.AddCText(v),i.ComTexts.push(d)}else i.ComTexts[0].GetCText(0).SetText(s)}else if(i.GetType()==e.ShapeType.SHAPE_TEXT_NOTE){var m=i;e.MeasureDisplayHelper.createNoteTextsImageN(r,p,l,f,o,u);if(i.ComTexts.length<1){var d=new e.ComText,v=new e.CText;v.SetText(s),d.AddCText(v),i.ComTexts.push(d)}else i.ComTexts[0].GetCText(0).SetText(s)}r.GetRenderManager().RequestRedraw()}}}else{var g=t[1];if(i!=null&&r!=null){var o=i.GetImageBoards(),a=o[0];if(a){var f=a.GetPosition();a=null;var y=Object.keys(g).length,b=new e.Shape2DSet,w=0;for(var E in g){var S=30,x=450,T=e.Color.WHITE().Clone(),N=e.Color.WHITE().Clone(),C=e.Color.BLACK().Clone(),k=e.Color.BLACK().Clone(),L=e.Color.GREEN().Clone(),A=e.Color.RED().Clone(),O=e.Color.BLUE().Clone(),M=new e.Vector2(1,1+w*100),_=new e.Vector2(260,100+w*100);e.MeasureDisplayHelper.createRectImage(b,M,_,x,T,N,C,k,E,g[E],S,!0),w++}e.MeasureDisplayHelper.addImageToMemory(r,a,b,f,5.5,y+2,i)}}}},t.AddNoteToScene=function(t,n){var r=!1;if(t==null||n==null)return r;var i=t.GetNoteGroup(),s=new e.ShapeNode;return s.SetShape(n),s.SetName(i.GetName()+"|"+new String(s.GetID())),i.AddChild(s),t.AddShapeIDToMap(n),t.GetRenderManager().RequestRedraw(),r=!0,r},t.TextNoteToXMLElement=function(e,n){var r="",i=document,s=i.createElement(t.Serializer_XML_Element_TextNote);s.setAttribute(t.Serializer_XML_Attribute_ID,String(n.GetID())),s.setAttribute(t.Serializer_XML_Attribute_IsParallelScreen,String(n.IsParallelScreen())),s.setAttribute(t.Serializer_XML_Attribute_IsFix,String(n.IsFix())),s.setAttribute(t.Serializer_XML_Attribute_Visible,String(n.IsVisible()));var o=i.createElement(t.Serializer_XML_Element_Color);s.appendChild(o);var u=n.GetColor();o.setAttribute(t.Serializer_XML_Attribute_R,String(u.r)),o.setAttribute(t.Serializer_XML_Attribute_G,String(u.g)),o.setAttribute(t.Serializer_XML_Attribute_B,String(u.b));var a=i.createElement(t.Serializer_XML_Element_Leaders);s.appendChild(a);var f=i.createElement(t.Serializer_XML_Element_Leader);f.setAttribute(t.Serializer_XML_Attribute_Type,String(1)),a.appendChild(f);var l=i.createElement(t.Serializer_XML_Element_Terminator);f.appendChild(l),l.setAttribute(t.Serializer_XML_Attribute_Type,String(4)),l.setAttribute(t.Serializer_XML_Attribute_Width,String(3)),l.setAttribute(t.Serializer_XML_Attribute_Height,String(1));var c=i.createElement(t.Serializer_XML_Element_Location);l.appendChild(c),c.setAttribute(t.Serializer_XML_Attribute_X,String(0)),c.setAttribute(t.Serializer_XML_Attribute_Y,String(0)),c.setAttribute(t.Serializer_XML_Attribute_Z,String(0));var h=i.createElement(t.Serializer_XML_Element_Direction);l.appendChild(h),h.setAttribute(t.Serializer_XML_Attribute_X,String(-0.7)),h.setAttribute(t.Serializer_XML_Attribute_Y,String(.7)),h.setAttribute(t.Serializer_XML_Attribute_Z,String(0));var p=i.createElement(t.Serializer_XML_Element_Polyline);f.appendChild(p),p.setAttribute(t.Serializer_XML_Attribute_ID,String(0)),p.setAttribute(t.Serializer_XML_Attribute_Type,String(1)),p.setAttribute(t.Serializer_XML_Attribute_Min,String(0)),p.setAttribute(t.Serializer_XML_Attribute_Max,String(0));var d=i.createElement(t.Serializer_XML_Element_Point);p.appendChild(d),d.setAttribute(t.Serializer_XML_Attribute_X,String(n.GetNotePos().x)),d.setAttribute(t.Serializer_XML_Attribute_Y,String(n.GetNotePos().y)),d.setAttribute(t.Serializer_XML_Attribute_Z,String(n.GetNotePos().z));var d=i.createElement(t.Serializer_XML_Element_Point);p.appendChild(d),d.setAttribute(t.Serializer_XML_Attribute_X,String(n.GetTextPos().x)),d.setAttribute(t.Serializer_XML_Attribute_Y,String(n.GetTextPos().y)),d.setAttribute(t.Serializer_XML_Attribute_Z,String(n.GetTextPos().z));var v=i.createElement(t.Serializer_XML_Element_ExtendLines);s.appendChild(v);var m=i.createElement(t.Serializer_XML_Element_CompositeTexts);s.appendChild(m);if(n.ComTexts.length>0){var g=i.createElement(t.Serializer_XML_Element_CompositeText);m.appendChild(g);var y=i.createElement(t.Serializer_XML_Element_Texts);g.appendChild(y);var b=i.createElement(t.Serializer_XML_Element_Text);y.appendChild(b),b.setAttribute(t.Serializer_XML_Attribute_Value,n.ComTexts[0].GetCText(0).GetText());var w=i.createElement(t.Serializer_XML_Element_TextStyle);b.appendChild(w);var E=i.createElement(t.Serializer_XML_Element_CharHeight);w.appendChild(E);var S=15,x=15,T=n.ComTexts[0].GetCText(0).GetCharWidthHeight(),N=i.createTextNode(String(S));E.appendChild(N);var C=i.createElement(t.Serializer_XML_Element_LineSpacing);w.appendChild(C);var k=1,N=i.createTextNode(String(0));C.appendChild(N);var L=i.createElement(t.Serializer_XML_Element_Font);w.appendChild(L),L.setAttribute(t.Serializer_XML_Attribute_Name,String(e.GetSceneBox().Length()/20));var A=i.createElement(t.Serializer_XML_Element_UsageType);w.appendChild(A),A.setAttribute(t.Serializer_XML_Attribute_Name,String(2));var c=i.createElement(t.Serializer_XML_Element_Location);b.appendChild(c);var O=String(n.GetNotePos().x)+" "+String(n.GetNotePos().y)+" "+String(n.GetNotePos().z),N=i.createTextNode(O);c.appendChild(N);var M=i.createElement(t.Serializer_XML_Element_Rotation);b.appendChild(M);var N=i.createTextNode("1.000000 0.000000 0.000000 0.000000 1.000000 0.000000");M.appendChild(N);var _=i.createElement(t.Serializer_XML_Element_OuterBox);y.appendChild(_);var N=i.createTextNode("1.000000 1.000000 1.000000-1.000000 -1.000000 -1.000000");_.appendChild(N)}var D=i.createElement(t.Serializer_XML_Element_Attributes);return s.appendChild(D),r=s.outerHTML,r},t.CreateTextNoteFromXMLElement=function(n,r){var i=new e.TextNote,s,o,u,a;if(r.length==0)return i;var f=r.firstChild;if(f==null)return null;var l=f.getAttribute(t.Serializer_XML_Attribute_ID),c=Boolean(f.getAttribute(t.Serializer_XML_Attribute_IsParallelScreen));i.SetParallelScreen(c);var h=Boolean(f.getAttribute(t.Serializer_XML_Attribute_IsFix));i.SetFix(h);var p=Boolean(f.getAttribute(t.Serializer_XML_Attribute_Visible));i.SetVisible(p);var d=f.getElementsByTagName(t.Serializer_XML_Element_Leaders)[0];if(d){var v=d.getElementsByTagName(t.Serializer_XML_Element_Leader)[0];if(v){var m=v.getElementsByTagName(t.Serializer_XML_Element_Polyline)[0];if(m){var g=m.getElementsByTagName(t.Serializer_XML_Element_Point),y=new Array;for(var b=0;b<g.length;b++){var w=new e.Vector3;w.x=Number(g[b].getAttribute(t.Serializer_XML_Attribute_X)),w.y=Number(g[b].getAttribute(t.Serializer_XML_Attribute_Y)),w.z=Number(g[b].getAttribute(t.Serializer_XML_Attribute_Z)),y.push(w)}u=y[0],a=y[1],i.SetNotePos(y[0]),i.SetTextPos(y[1])}}}var E=f.getElementsByTagName(t.Serializer_XML_Element_CompositeTexts)[0];if(E){var S=E.getElementsByTagName(t.Serializer_XML_Element_CompositeText)[0];if(S){var x=S.getElementsByTagName(t.Serializer_XML_Element_Texts)[0];if(x){var T=x.getElementsByTagName(t.Serializer_XML_Element_Text)[0],N=T.getAttribute(t.Serializer_XML_Attribute_Value);o=N;if(i.ComTexts.length>0){var C=new e.CText;C.SetText(N),i.ComTexts[0].AddCText(C)}else{var k=new e.ComText,C=new e.CText;C.SetText(N),k.AddCText(C),i.ComTexts.push(k)}if(T){var L=T.getElementsByTagName(t.Serializer_XML_Element_TextStyle)[0];if(L){var A=L.getElementsByTagName(t.Serializer_XML_Element_CharHeight)[0];if(A){var O="1";A.innerHTML==""?O="15":O=A.innerHTML,A.textContent!==""&&A.textContent!==undefined&&(O=A.textContent);var M=Number(O);M<1&&(M=15),s=M}}var _=T.getElementsByTagName(t.Serializer_XML_Element_Location)[0],D="1.222 1.222 1.222";_.innerHTML!==""&&_.innerHTML!==undefined?D=_.innerHTML:_.textContent!==""&&_.textContent!==undefined?D=_.textContent:D="1.222 1.222 1.222";var P=D.split(" ");if(P.length==3)var H=Number(P[0]),B=Number(P[1]),j=Number(P[2]),F=new e.Vector3(H,B,j)}}}}var I=new e.Line3D(u,a);I.SetName("TextImageLeader");var q=new e.Color(.03,.38,.73);I.SetColor(q);var R=new e.Point(u);R.SetDrawType(1),R.SetSize(.8);var U=new e.Point(a);U.SetDrawType(1),U.SetSize(.8);var z=new Array,W=new e.Texts2D;W.setTexts("内容"),W.setSize(s),z.push(W);var X=new e.Texts2D;X.setTexts(o),X.setSize(s),z.push(X);var V=null;return i.AddLine(I),i.AddPoint(R),e.MeasureDisplayHelper.createNoteTextsImageN(n,V,z,a,i),i.SetFrontShow(!1),i&&t.AddNoteToScene(n,i),i},t.Serializer_XML_Element_SVL="svl",t.Serializer_XML_Element_Header="header",t.Serializer_XML_Element_Version="version",t.Serializer_XML_Element_Author="author",t.Serializer_XML_Element_Created="created",t.Serializer_XML_Element_Generator="generator",t.Serializer_XML_Element_Model="model",t.Serializer_XML_Element_Users="users",t.Serializer_XML_Element_User="user",t.Serializer_XML_Element_Notes="notes",t.Serializer_XML_Element_TextNote="textnote",t.Serializer_XML_Element_VoiceNote="voicenote",t.Serializer_XML_Element_SequenceNote="sequencenote",t.Serializer_XML_Element_ThreeDGestureNote="threedgestureNote",t.Serializer_XML_Element_Color="color",t.Serializer_XML_Element_VoiceData="voicedata",t.Serializer_XML_Element_ThreeDGestureNoteLine="threedgestureNoteLine",t.Serializer_XML_Element_Leaders="leaders",t.Serializer_XML_Element_Leader="leader",t.Serializer_XML_Element_Terminator="terminator",t.Serializer_XML_Element_Location="location",t.Serializer_XML_Element_Direction="direction",t.Serializer_XML_Element_Polyline="polyline",t.Serializer_XML_Element_Point="point",t.Serializer_XML_Element_ExtendLines="extendLines",t.Serializer_XML_Element_CompositeTexts="compositetexts",t.Serializer_XML_Element_CompositeText="compositetext",t.Serializer_XML_Element_Texts="texts",t.Serializer_XML_Element_Text="text",t.Serializer_XML_Element_TextStyle="textstyle",t.Serializer_XML_Element_CharHeight="charheight",t.Serializer_XML_Element_LineSpacing="linespacing",t.Serializer_XML_Element_Font="font",t.Serializer_XML_Element_UsageType="usagetype",t.Serializer_XML_Element_Rotation="rotation",t.Serializer_XML_Element_OuterBox="outerbox",t.Serializer_XML_Element_ProjectMatrix="projectmatrix",t.Serializer_XML_Element_Attributes="attributes",t.Serializer_XML_Element_Attribute="attribute",t.Serializer_XML_Attribute_ID="id",t.Serializer_XML_Attribute_UserID="userid",t.Serializer_XML_Attribute_Created="created",t.Serializer_XML_Attribute_IsParallelScreen="isparallelscreen",t.Serializer_XML_Attribute_IsFix="isfix",t.Serializer_XML_Attribute_Visible="visible",t.Serializer_XML_Attribute_R="r",t.Serializer_XML_Attribute_G="g",t.Serializer_XML_Attribute_B="b",t.Serializer_XML_Attribute_Color="color",t.Serializer_XML_Attribute_X="x",t.Serializer_XML_Attribute_Y="y",t.Serializer_XML_Attribute_Z="z",t.Serializer_XML_Attribute_Value="value",t.Serializer_XML_Attribute_Type="type",t.Serializer_XML_Attribute_Key="key",t.Serializer_XML_Attribute_URI="uri",t.Serializer_XML_Attribute_Width="width",t.Serializer_XML_Attribute_Height="height",t.Serializer_XML_Attribute_Name="name",t.Serializer_XML_Attribute_Min="min",t.Serializer_XML_Attribute_Max="max",t.Serializer_XML_Attribute_Format="format",t}();e.NoteFactory=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n.textPos=new e.Vector3,n.notePos=new e.Vector3,n.InitMeasureDistance(),n}return __extends(n,t),n.prototype.InitMeasureDistance=function(){this.SetType(e.ShapeType.SHAPE_TEXT_NOTE)},n.prototype.GetWorldTextPos=function(){var t=this.GetSceneNode(),n;return t?n=t.GetWorldTransform().Clone():n=e.Matrix3x4.IDENTITY().Clone(),n.Multiply(this.textPos)},n.prototype.SetTextPos=function(e){this.textPos=e.Clone()},n.prototype.GetTextPos=function(){return this.textPos},n.prototype.SetNotePos=function(e){this.notePos=e.Clone()},n.prototype
.GetNotePos=function(){return this.notePos},n.prototype.GetWorldNotePos=function(){var t=this.GetSceneNode(),n;return t?n=t.GetWorldTransform().Clone():n=e.Matrix3x4.IDENTITY().Clone(),n.Multiply(this.notePos)},n}(e.Measure);e.TextNote=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=[];for(var r=0;r<arguments.length;r++)n[r]=arguments[r];var i=t.call(this)||this;i.imageBoard=null,i.textImage=null,i.position=new e.Vector3;if(n.length==1)n[0]instanceof e.SceneManager&&i.InitVoice(n[0]);else if(n.length==2){if(n[0]instanceof e.Vector3&&n[1]instanceof e.SceneManager){i.SetType(e.ShapeType.SHAPE_VOICE_NOTE);var s=5;i.imageBoard=new e.ImageBoard(n[0],new e.Vector2(s,s)),i.imageBoard.setTexture(n[1].GetResourceManager().GetDefaultVoiceImage()),i.SetPosition(n[0])}}else n.length==3&&(i.SetType(e.ShapeType.SHAPE_VOICE_NOTE),i.imageBoard=new e.ImageBoard(n[0],n[1]),i.imageBoard.setTexture(n[2].GetResourceManager().GetDefaultVoiceImage()),i.Set(n[0],n[1]),i.SetPosition(n[0]));return i}return __extends(n,t),n.prototype.InitVoice=function(t){var n=5;this.imageBoard=new e.ImageBoard(e.Vector3.ZERO().Clone(),new e.Vector2(n,n)),this.imageBoard.setTexture(t.GetResourceManager().GetDefaultVoiceImage()),this.SetType(e.ShapeType.SHAPE_VOICE_NOTE)},n.prototype.SetPosition=function(e){this.position=e,this.imageBoard&&this.imageBoard.SetPosition(e)},n.prototype.GetPosition=function(){return this.position},n.prototype.GetImageboard=function(){return this.imageBoard},n.prototype.RayPick=function(e){if(!this.IsVisible()||!e.CanPickShape(this.GetType()))return;var t=this.imageBoard.GetIntersects(e);if(t.length>0)for(var n=0,r=t;n<r.length;n++){var i=r[n];e.AddIntersectPnt(i)}e.AddShape(this)},n.prototype.Set=function(e,t){this.imageBoard&&this.imageBoard.Set(e,t)},n.prototype.SetSelected=function(e){this.SetSelected(e),this.imageBoard&&this.imageBoard.SetSelected(e)},n.prototype.ComputeBox=function(){this.BoundingBox=new e.BoundingBox(e.Vector3.MINIMUM().Clone(),e.Vector3.MAXMUN().Clone())},n.prototype.FindVisiableObject=function(e){this.IsVisible()&&(this.SetRenderWorldMatrix(e.GetGLWorldMatrix()),this.imageBoard&&this.imageBoard.UpdateRenderData(e),e.PrepareRenderNote(this))},n.prototype.SetUri=function(e){this.uri=e},n.prototype.GetUri=function(){return this.uri},n.prototype.SetFormat=function(e){this.format=e},n.prototype.GetFormat=function(){return this.format},n.prototype.SetVoiceData=function(e){this.voiceData=e},n.prototype.GetVoiceData=function(){return this.voiceData},n}(e.Measure);e.VoiceNote=t})(M3D||(M3D={}));var M3D;(function(e){var t=function(t){function n(){var n=t.call(this)||this;return n.textPos=new e.Vector3,n.notePos=new e.Vector3,n.InitMeasureDistance(),n}return __extends(n,t),n.prototype.InitMeasureDistance=function(){this.SetType(e.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE)},n.prototype.SetTextPos=function(e){this.textPos=e},n.prototype.GetTextPos=function(){return this.textPos},n.prototype.SetNotePos=function(e){this.notePos=e},n.prototype.GetNotePos=function(){return this.notePos},n}(e.Measure);e.SequenceNumberNote=t})(M3D||(M3D={}));var SView;(function(e){var t=function(t){function n(n){var r=t.call(this,n)||this;return r.inputTextNoteString=function(e,t){return},r.SetCommandType(e.MeasureCommandType.MEASURE_TEXT_NOTE),r.nativaShapeIds=new Array,r}return __extends(n,t),n.prototype.OnTouchHandle=function(t,n){var r=!1,i=this.ProcessEditAndDrag(t,n);if(i==1)return!0;if(i==2)return!1;var s=this.GetMeasure();if(s==null)return!1;var o=s.GetMeasureType();return o==e.SMeasure.MEASURE_TEXT_NOTE&&(this.textNoteStep0(n),r=!0),r},n.prototype.textNoteStep0=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_POINT;if(n==M3D.ShapeType.SHAPE_POINT){var r=0,i=e.getX(),s=e.getY();r=this.SelectedPnt(i,s,this.IsUseFeaturePnt());if(r!=0){t.SetFirstShape(r);var o=function(e,n,r){n?(t.SetTextString(e),r.SetMeasure(t),r.textNoteStep1(i,s)):(r.SetMeasure(t),r.Close(),r.ExecuteNew())};this.sview.isShowTextNoteAlert=!0,this.inputTextNoteString(this,o)}}},n.prototype.textNoteStep1=function(e,t){var n=this.GetMeasure();n.SetAnchorX(e);var r=this.sview.view.sceneManager.GetCamera().GetViewPort().GetRect().Height(),i=t;i<r/2?n.SetAnchorY(i-50*window.devicePixelRatio):n.SetAnchorY(i+100*window.devicePixelRatio),n.Create()?(this.sview.GetNativeShapeManager().AddShape(n.GetID(),n.GetNoteObj()),this.setMeasureStep(0),this.SaveMeasure(n),this.Close(),this.ExecuteNew()):this.ProcessError()},n.prototype.ProcessError=function(){this.Close(),this.ExecuteNew()},n.prototype.Close=function(){t.prototype.Close.call(this),this.ClearTmpSource()},n.prototype.ClearTmpSource=function(){var t=this.GetMeasure();this.setMeasureStep(0);if(t==null)return;var n=t.GetMeasureType();if(n==e.SMeasure.MEASURE_TEXT_NOTE&&t instanceof e.STextNote){var r=t,i=r.GetFirstShape();this.sview.isShowTextNoteAlert=!1;if(this.nativaShapeIds.length>1){for(var s=0,o=this.nativaShapeIds;s<o.length;s++){var u=o[s];this.sview.view.RemoveShape(u)}this.nativaShapeIds.splice(0,this.nativaShapeIds.length)}else i>0&&this.sview.view.RemoveShape(i)}},n}(e.MeasureCommand);e.TextNoteCommand=t})(SView||(SView={}));var SView;(function(e){var t=function(t){function n(n){var r=t.call(this,n)||this;return r.SetCommandType(e.MeasureCommandType.MEASURE_VOICE_NOTE),r}return __extends(n,t),n.prototype.OnTouchHandle=function(t,n){var r=!1,i=this.ProcessEditAndDrag(t,n);if(i==1)return!0;if(i==2)return!1;var s=this.GetMeasure();if(s==null)return!1;var o=s.GetMeasureType();return o==e.SMeasure.MEASURE_VOICE_NOTE&&(this.voiceNoteStep0(n),r=!0),r},n.prototype.voiceNoteStep0=function(e){if(this.getMeasureStep()==0){var t=this.GetMeasure();t.SetAnchorX(e.getX()),t.SetAnchorY(e.getY()),this.voiceNoteStep1(e)}},n.prototype.voiceNoteStep1=function(e){var t=this.GetMeasure();t.Create()?(this.sview.GetNativeShapeManager().AddShape(t.GetID(),t.GetMeasureObj()),this.setMeasureStep(0),this.SaveMeasure(t),this.Close(),this.ExecuteNew()):this.ProcessError()},n.prototype.ProcessError=function(){this.Close(),this.ExecuteNew()},n.prototype.Close=function(){t.prototype.Close.call(this),this.ClearTmpSource()},n.prototype.ClearTmpSource=function(){var t=this.GetMeasure();this.setMeasureStep(0);if(t==null)return;var n=t.GetMeasureType();if(n==e.SMeasure.MEASURE_TYPE_PNT_PNT_DISTANCE&&t instanceof e.SVoiceNote){var r=t,i=r.GetFirstShape();i>0&&this.sview.view.RemoveShape(i)}},n}(e.MeasureCommand);e.VoiceNoteCommand=t})(SView||(SView={}));var SView;(function(e){var t=function(t){function n(n){var r=t.call(this,n)||this;return r.number=0,r.SetCommandType(e.MeasureCommandType.MEASURE_SEQUENCE_NUM),r}return __extends(n,t),n.prototype.OnTouchHandle=function(t,n){var r=!1,i=this.ProcessEditAndDrag(t,n);if(i==1)return!0;if(i==2)return!1;var s=this.GetMeasure();if(s==null)return!1;var o=s.GetMeasureType();return o==e.SMeasure.MEASURE_SEQUENCE_NUMBER_NOTE&&(this.sequenceNumberNoteStep0(n),r=!0),r},n.prototype.sequenceNumberNoteStep0=function(e){var t=this.GetMeasure(),n=M3D.ShapeType.SHAPE_POINT;if(n==M3D.ShapeType.SHAPE_POINT){var r=0,i=e.getX(),s=e.getY();r=this.SelectedPnt(i,s,this.IsUseFeaturePnt()),r!=0&&(t.SetFirstShape(r),this.number++,t.SetTextString(String(this.number)),this.sequenceNumberNoteStep1(i,s))}},n.prototype.sequenceNumberNoteStep1=function(e,t){var n=this.GetMeasure();n.SetAnchorX(e);var r=this.sview.view.sceneManager.GetCamera().GetViewPort().GetRect().Height(),i=t;i<r/2?n.SetAnchorY(i-50*window.devicePixelRatio):n.SetAnchorY(i+100*window.devicePixelRatio),n.Create()?(this.sview.GetNativeShapeManager().AddShape(n.GetID(),n.GetNoteObj()),this.setMeasureStep(0),this.SaveMeasure(n),this.Close(),this.ExecuteNew()):this.ProcessError()},n.prototype.ProcessError=function(){this.Close(),this.ExecuteNew()},n.prototype.Close=function(){t.prototype.Close.call(this),this.ClearTmpSource()},n.prototype.ClearTmpSource=function(){var t=this.GetMeasure();this.setMeasureStep(0);if(t==null)return;var n=t.GetMeasureType();if(n==e.SMeasure.MEASURE_SEQUENCE_NUMBER_NOTE&&t instanceof e.SSequenceNumberNote){var r=t,i=r.GetFirstShape();i>0&&this.sview.view.RemoveShape(i)}},n}(e.MeasureCommand);e.SequenceNumberNoteCommand=t})(SView||(SView={}));var SView;(function(e){var t=function(t){function n(){var e=t.call(this)||this;return e.firstShape=0,e.textString="",e.Init(),e}return __extends(n,t),n.prototype.Create=function(){var t=!1,n=null,r=this.GetMeasureType(),i=this.firstShape,s=this.GetAnchorX(),o=this.GetAnchorY(),u=new M3D.Vector2(s,o);return r==e.SMeasure.MEASURE_TEXT_NOTE&&(n=M3D.NoteFactory.createTextNote(i,u,this.GetTextString(),this.view.GetSceneManager())),n&&(this.nativeNote=n,t=!0),t},n.prototype.Init=function(){this.SetType(M3D.ShapeType.SHAPE_TEXT_NOTE)},n.prototype.GetFirstShape=function(){return this.firstShape},n.prototype.SetFirstShape=function(e){this.firstShape=e},n.prototype.Delete=function(){var e=!1;return this.GetID()>0&&(this.view.RemoveShape(this.GetID()),e=!0),!1},n.prototype.SetTextString=function(e){this.textString=e},n.prototype.GetTextString=function(){return this.textString},n.prototype.Clear=function(){return!1},n.CreateFromXML=function(e,t){var r=null;if(e!=null&&e.length!=0){r=new n;var i=M3D.NoteFactory.CreateTextNoteFromXMLElement(t.view.GetSceneManager(),t.ParseXmlString(e));if(i){r.SetView(t.view),r.SetNativeNoteObj(i);var s=i.GetID()}return r}},n}(e.SMeasure);e.STextNote=t})(SView||(SView={}));var SView;(function(e){var t=function(t){function n(){var e=t.call(this)||this;return e.firstShape=0,e.textString="",e.Init(),e}return __extends(n,t),n.prototype.Create=function(){var t=!1,n=null,r=this.GetMeasureType(),i=this.firstShape,s=this.GetAnchorX(),o=this.GetAnchorY(),u=new M3D.Vector2(s,o);return r==e.SMeasure.MEASURE_TEXT_NOTE&&(n=M3D.NoteFactory.createVoiceNote(u,this.GetTextString(),this.view.GetSceneManager())),n&&(this.nativeMeasure=n,t=!0),t},n.prototype.Init=function(){this.SetType(M3D.ShapeType.SHAPE_TEXT_NOTE)},n.prototype.GetFirstShape=function(){return this.firstShape},n.prototype.SetFirstShape=function(e){this.firstShape=e},n.prototype.Delete=function(){var e=!1;return this.GetID()>0&&(this.view.RemoveShape(this.GetID()),e=!0),!1},n.prototype.SetTextString=function(e){this.textString=e},n.prototype.GetTextString=function(){return this.textString},n.prototype.Clear=function(){return!1},n}(e.SMeasure);e.SVoiceNote=t})(SView||(SView={}));var SView;(function(e){var t=function(t){function n(){var e=t.call(this)||this;return e.firstShape=0,e.textString="",e.Init(),e}return __extends(n,t),n.prototype.Create=function(){var t=!1,n=null,r=this.GetMeasureType(),i=this.firstShape,s=this.GetAnchorX(),o=this.GetAnchorY(),u=new M3D.Vector2(s,o);return r==e.SMeasure.MEASURE_SEQUENCE_NUMBER_NOTE&&(n=M3D.NoteFactory.CreateSequenceNumberNote(i,u,this.GetTextString(),this.view.GetSceneManager())),n&&(this.nativeNote=n,t=!0),t},n.prototype.Init=function(){this.SetType(M3D.ShapeType.SHAPE_SEQUENCE_NUMBER_NOTE)},n.prototype.GetFirstShape=function(){return this.firstShape},n.prototype.SetFirstShape=function(e){this.firstShape=e},n.prototype.Delete=function(){var e=!1;return this.GetID()>0&&(this.view.RemoveShape(this.GetID()),e=!0),!1},n.prototype.SetTextString=function(e){this.textString=e},n.prototype.GetTextString=function(){return this.textString},n.prototype.Clear=function(){return!1},n}(e.SMeasure);e.SSequenceNumberNote=t})(SView||(SView={}));